<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信小程序第四篇：生成图片并保存到手机相册 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信小程序第四篇：生成图片并保存到手机相册" />
<meta property="og:description" content="系列文章传送门：
微信小程序第一篇：自定义组件详解
微信小程序第二篇：七种主流通信方法详解
微信小程序第三篇：获取页面节点信息
目录
一、封装分享组件
二、定义用户授权方法
三、调用流程
首先我们看一下要完成的效果：
这种场景还是非常常见的，点击分享的时候我们可以转发给好友，或者生成当前页的海报图片保存到手机相册中。分享给好友这个功能可以通过 button 的 open-type 方式实现，那自动保存图片到本地该如何实现呢，让我们来看一看吧：
一、封装分享组件 首先我们要封装一个分享的组件，这样方便在其他的页面中复用。这样就大大减少了代码的冗余，
在 components 文件夹中新建一个组件，下面是完整代码
share.wxml：
&lt;!-- 底部自定义分享菜单栏 --&gt; &lt;view class=&#34;share-sheet-mask flex-column&#34; hidden=&#34;{{!showShareSheet}}&#34; catchtap=&#34;closeShareSheet&#34;&gt; &lt;view class=&#34;share-sheet&#34;&gt; &lt;view class=&#34;items flex-row&#34;&gt; &lt;view class=&#34;item flex-column&#34;&gt; &lt;button class=&#34;ico flex-row&#34; open-type=&#34;share&#34;&gt; &lt;image class=&#34;img wx-ico&#34; src=&#34;../../images/ico_wx.svg&#34;&gt;&lt;/image&gt; &lt;/button&gt; &lt;view class=&#34;desc&#34;&gt;微信好友&lt;/view&gt; &lt;/view&gt; &lt;view class=&#34;item flex-column&#34;&gt; &lt;button class=&#34;ico flex-row&#34; catchtap=&#34;genPlayBill&#34;&gt; &lt;image class=&#34;img img-ico&#34; src=&#34;../../images/ico_img.svg&#34;&gt;&lt;/image&gt; &lt;/button&gt; &lt;view class=&#34;desc&#34;&gt;生成海报&lt;/view&gt; &lt;/view&gt; &lt;/view&gt; &lt;view class=&#34;cancel-share-sheet&#34;&gt;取消&lt;/view&gt; &lt;/view&gt; &lt;/view&gt; share.js：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/067a5307a3b4778752943f3a6b613acf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-09T15:15:12+08:00" />
<meta property="article:modified_time" content="2022-12-09T15:15:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信小程序第四篇：生成图片并保存到手机相册</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p>系列文章传送门：</p> 
 <p><a class="link-info" href="https://blog.csdn.net/qq_49900295/article/details/128057312" title="微信小程序第一篇：自定义组件详解">微信小程序第一篇：自定义组件详解</a></p> 
 <p><a class="link-info" href="https://blog.csdn.net/qq_49900295/article/details/128057336" title="微信小程序第二篇：七种主流通信方法详解">微信小程序第二篇：七种主流通信方法详解</a></p> 
 <p><a class="link-info" href="https://blog.csdn.net/qq_49900295/article/details/128057570" title="微信小程序第三篇：获取页面节点信息">微信小程序第三篇：获取页面节点信息</a></p> 
</blockquote> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="%E4%B8%80%E3%80%81%E5%B0%81%E8%A3%85%E5%88%86%E4%BA%AB%E7%BB%84%E4%BB%B6-toc" style="margin-left:40px;"><a href="#%E4%B8%80%E3%80%81%E5%B0%81%E8%A3%85%E5%88%86%E4%BA%AB%E7%BB%84%E4%BB%B6" rel="nofollow">一、封装分享组件</a></p> 
<p id="%E4%BA%8C%E3%80%81%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83%E6%96%B9%E6%B3%95-toc" style="margin-left:40px;"><a href="#%E4%BA%8C%E3%80%81%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83%E6%96%B9%E6%B3%95" rel="nofollow">二、定义用户授权方法</a></p> 
<p id="%E4%B8%89%E3%80%81%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B-toc" style="margin-left:40px;"><a href="#%E4%B8%89%E3%80%81%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B" rel="nofollow">三、调用流程</a></p> 
<hr id="hr-toc"> 
<p>首先我们看一下要完成的效果：</p> 
<p> <img alt="" height="649" src="https://images2.imgbox.com/bc/b4/muDiK7Lc_o.gif" width="300"></p> 
<p>这种场景还是非常常见的，点击分享的时候我们可以转发给好友，或者生成当前页的海报图片保存到手机相册中。分享给好友这个功能可以通过  button 的 open-type 方式实现，那自动保存图片到本地该如何实现呢，让我们来看一看吧：</p> 
<p></p> 
<h3 id="%E4%B8%80%E3%80%81%E5%B0%81%E8%A3%85%E5%88%86%E4%BA%AB%E7%BB%84%E4%BB%B6">一、封装分享组件</h3> 
<p>首先我们要封装一个分享的组件，这样方便在其他的页面中复用。这样就大大减少了代码的冗余，</p> 
<p>在 components 文件夹中新建一个组件，下面是完整代码</p> 
<p><strong><span style="color:#be191c;"><span style="background-color:#fef2f0;">share.wxml：</span></span></strong></p> 
<pre><code class="language-html">&lt;!-- 底部自定义分享菜单栏 --&gt;
&lt;view class="share-sheet-mask flex-column" hidden="{<!-- -->{!showShareSheet}}" catchtap="closeShareSheet"&gt;
  &lt;view class="share-sheet"&gt;
    &lt;view class="items flex-row"&gt;
      &lt;view class="item flex-column"&gt;
        &lt;button class="ico flex-row" open-type="share"&gt;
          &lt;image class="img wx-ico" src="../../images/ico_wx.svg"&gt;&lt;/image&gt;
        &lt;/button&gt;
        &lt;view class="desc"&gt;微信好友&lt;/view&gt;
      &lt;/view&gt;
      &lt;view class="item flex-column"&gt;
        &lt;button class="ico flex-row" catchtap="genPlayBill"&gt;
          &lt;image class="img img-ico" src="../../images/ico_img.svg"&gt;&lt;/image&gt;
        &lt;/button&gt;
        &lt;view class="desc"&gt;生成海报&lt;/view&gt;
      &lt;/view&gt;
    &lt;/view&gt;
    &lt;view class="cancel-share-sheet"&gt;取消&lt;/view&gt;
  &lt;/view&gt;
&lt;/view&gt;</code></pre> 
<p><strong><span style="color:#be191c;"><span style="background-color:#fef2f0;"> share.js：</span></span></strong></p> 
<pre><code class="language-javascript">Component({
  /**
   * 组件的属性列表
   */
  properties: {

  },
  /**
   * 组件的初始数据
   */
  data: {
    showShareSheet: false
  },
  /**
   * 组件的方法列表
   */
  methods: {
    openShareSheet() {
      this.setData({showShareSheet: true})
    },
    closeShareSheet() {
      this.setData({showShareSheet: false});
    },
    genPlayBill() {
      this.triggerEvent('genPlayBill')
    },
  }
})</code></pre> 
<p>在点击生成海报的时候，我们向父组件发送了一个事件来调用 genPlayBill 方法，因为这个方法显然不应该在当前组件内定义，应该根据不同场景来定义我们只需要调用它就可以了。</p> 
<p><strong><span style="color:#be191c;"><span style="background-color:#fef2f0;">share.wxss：</span></span></strong></p> 
<pre><code class="language-css">.flex-column {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
}

.flex-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
}

.share-sheet-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.60);
  z-index: 101;
  justify-content: flex-end;
}

.share-sheet-mask .share-sheet {
  padding:0 24rpx;
  background: #f1f1f1;
  border-radius: 16rpx 16rpx 0px 0px;
  width: 100%;
  box-sizing: border-box;
}
.share-sheet-mask .share-sheet .items {
  padding: 48rpx 0 31rpx 0;
  justify-content: space-around;
  border-bottom: 0.5px solid rgba(39,36,71,0.20);
}
.share-sheet-mask .share-sheet .items .item{
  text-align: center;
}
.share-sheet-mask .share-sheet .items .item .ico {
  width: 80rpx;
  height: 80rpx;
  background: #ffffff;
  border-radius: 50%;
  box-shadow: 0 0 12rpx 0 rgba(204,204,204,0.60);
  padding: 0;
  margin: 0;
  padding: 0;
}
/*去除button的默认黑边框*/
.share-sheet-mask .share-sheet .items .item .ico::after{
  border: none;
}
.share-sheet-mask .share-sheet .items .item .ico .img {
  margin: auto;
}
.share-sheet-mask .share-sheet .items .item .ico .wx-ico {
  width: 52rpx;
  height: 40rpx;
}
.share-sheet-mask .share-sheet .items .item .desc {
  font-size: 24rpx;
  font-family: PingFangSC, PingFangSC-Regular;
  color: #6d6d6d;
  margin-top: 14rpx;
}
.share-sheet-mask .share-sheet .items .item .ico .img-ico {
  width: 44rpx;
  height: 44rpx;
}
.share-sheet-mask .share-sheet .cancel-share-sheet {
  margin: 31rpx auto 80rpx auto;
  font-size: 32rpx;
  font-family: PingFangSC, PingFangSC-Regular;
  color: #272447;
  text-align: center;
}
</code></pre> 
<h3 id="%E4%BA%8C%E3%80%81%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83%E6%96%B9%E6%B3%95">二、定义用户授权方法</h3> 
<p>刚刚我们封装了顶部的分享组件，那现在就要去定义保存图片到相册的方法了，我们写代码的时候一定要考虑清楚这段代码是否是可复用的，是否应该剥离出去。显然保存图片到相册这个方法我们应该写在 utils 目录中，因为有很多其他的场景都可以用这个方法，那我们就封装一个公用方法，参数就是图片的地址，成功的回调函数和失败的回调函数。</p> 
<p><strong><span style="color:#be191c;"><span style="background-color:#fef2f0;">最复杂的就是用户授权了，我们一起看一下代码结构：</span></span></strong></p> 
<pre><code class="language-javascript">const saveImgToPhotos = (imgPath, succCallback, failedCallback) =&gt; {
  
    wx.getSetting ({ // 查询所有授权
        success(res) {
            if (res.authSetting['scope.writePhotosAlbum']) { // 用户已经授权
                save() // 执行保存函数
            }else { // 未授权
                wx.authorize({ scope: 'scope.writePhotosAlbum', 
                  success() {  // 用户同意授权
                    save()  // 执行保存函数
                  },
                  fail(err) {  // 用户拒绝授权
                    if (err &amp;&amp; err.errMsg.endsWith("auth deny")) { 
                      wx.showModal({
                        title: '授权添加到相册',
                        content: '需要获取您的添加相册权限，请确认授权，否则分享功能无法正常使用',
                        success: function (resolve) {  
                          if (resolve.confirm) { // 用户同意设置授权
                            wx.openSetting({
                              success(res) {
                                if (res &amp;&amp; res.authSetting['scope.writePhotosAlbum']) {
                                  save()  // 执行保存函数
                                }
                              },
                              fail(res) {   // 用户拒绝设置授权
                                console.log(res)
                                failedCallback('没有权限，保存失败')
                              }
                            })
                          } else {  // 用户拒绝设置
                            failedCallback('没有权限，保存失败')
                          }
                        }
                      })
                    } else {
                      failedCallback(err &amp;&amp; err.errMsg || '保存失败')
                    }
                  }
                })
            }
        },
    })
  }
  </code></pre> 
<p>通过 <span style="color:#be191c;"><span style="background-color:#fef2f0;">wx.authorize() </span></span>来申请权限的方式是比较繁琐的。因为它的状态比较多，大致可分为：</p> 
<ol><li><span style="background-color:#fefcd8;">用户未接受或拒绝过此权限，会弹窗询问用户，用户点击同意 —— 可调用相应接口。</span></li><li><span style="background-color:#fefcd8;">用户未接受或拒绝过此权限，会弹窗询问用户，用户点击拒绝 —— 打开设置页面。</span></li><li><span style="background-color:#fefcd8;">如果用户已授权 —— 可调用相应接口。</span></li><li><span style="background-color:#fefcd8;">用户已拒绝授权 —— 打开设置页面。</span></li></ol> 
<p>上述情况的2/4是需要小伙伴们结合 <span style="color:#be191c;"><span style="background-color:#fef2f0;">wx.openSetting()</span></span> 来帮助用户进行二次授权的。</p> 
<p>搞定了用户授权这个麻烦事后，下面就是定义我们的 save 保存函数了，这个就很简单了：</p> 
<pre><code class="language-javascript">let save = function () {
      wx.saveImageToPhotosAlbum({
        filePath: imgPath,
        success() {
          succCallback()
        },
        fail(res){
          failedCallback(res)
        }
      })
    }</code></pre> 
<p>把这段代码添加到 saveImgToPhotos 方法中就ok了，调用 wx.saveImageToPhotosAlbum 方法，参数就是我们传进来的图片地址，成功的话就执行成功的回调，失败就执行失败的回调。</p> 
<p>下面是官方的文档说明：</p> 
<p><img alt="" height="799" src="https://images2.imgbox.com/0a/b0/RR4Oh7bC_o.png" width="1200"></p> 
<p> </p> 
<h3 id="%E4%B8%89%E3%80%81%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B">三、调用流程</h3> 
<p>下面我们就把组件，方法这些东西引入到我们的页面中。在页面的 json 文件中引入组件路径。</p> 
<p>把组件引入页面wxml中：</p> 
<pre><code class="language-html">&lt;share-sheet id="share-sheet" catch:genPlayBill="genTimelineImage" /&gt;</code></pre> 
<p>这里的方法就是点击生成海报的时候调用的父组件的方法。</p> 
<p>当点击分享的时候展示分享组件：</p> 
<pre><code class="language-javascript">openShareSheet(e) {
        this.selectComponent("#share-sheet").openShareSheet()
    },</code></pre> 
<p>在这里通过选择器可以直接调用子组件中的方法，来控制分享组件的显示与隐藏。</p> 
<pre><code class="language-javascript">genTimelineImage(e) {
        wx.showLoading({
          title: "海报生成中",
          icon: "loading",
          mask: true,
        })
        const imgSrc = `路径`
        wx.getImageInfo({
          src: imgSrc,
        })
          .then((res) =&gt; {
            wx.hideLoading()
            this.imgTempPath = res.path
            this.saveTimelineImg()
          })
          .catch((err) =&gt; console.log(err))
      },
    
      saveTimelineImg: function () {
        saveImgToPhotos(this.imgTempPath, function(){
          this.selectComponent("#share-sheet").closeShareSheet()
        }.bind(this), function(errMsg) {
          this.selectComponent("#share-sheet").closeShareSheet()
        }.bind(this))
      },</code></pre> 
<p>当我们点击生成海报调用 <strong><span style="color:#be191c;"><span style="background-color:#fef2f0;">genTimelineImage</span></span></strong> 方法的时候，通过 <strong><span style="color:#be191c;"><span style="background-color:#fef2f0;">wx.getImageInfo</span></span></strong> 方法读取想要保存图片的临时下载路径，把他保存到外部定义的一个变量中，这样方便我们在 utils 目录中定义的 <span style="color:#be191c;"><strong>saveImgToPhotos </strong></span>方法调用。这样我们整个的流程就over啦！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/84b4810a55994c5f3b8c7206baecb381/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">compose--修饰符Modifier</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2a1006866f649fc0f2ad93a4f39b8d71/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue2 时间倒计时</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>