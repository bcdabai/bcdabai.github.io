<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>③使用Redis缓存，并增强数据一致性。 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="③使用Redis缓存，并增强数据一致性。" />
<meta property="og:description" content="个人简介：Java领域新星创作者；阿里云技术博主、星级博主、专家博主；正在Java学习的路上摸爬滚打，记录学习的过程~
个人主页：.29.的博客
学习社区：进去逛一逛~
使用Redis缓存，并增强数据一致性。 Redis缓存🚀为什么使用缓存？🚀如何添加Redis缓存？🚀缓存数据一致性问题（双写问题）🚀实现 缓存与数据库双写一致（此方式不能保证绝对一致） Redis缓存 🚀为什么使用缓存？ 缓存数据存储于代码中,而代码运行在内存中,内存的读写性能远高于磁盘,缓存可以大大降低用户访问并发量带来的服务器读写压力。
缓存的作用： 降低后端负载。提高读写效率，降低响应时间。 使用缓存的同时，也会增加代码复杂度和运营的成本。
缓存的成本： 数据一致性成本（双写问题）代码维护成本运维成本 缓存的使用案例：
缓存(Cache),就是数据交换的缓冲区,俗称的缓存就是缓冲区内的数据,一般从数据库中获取,存储于本地代码(例如:
// 例1:本地用于高并发 Static final ConcurrentHashMap&lt;K,V&gt; map = new ConcurrentHashMap&lt;&gt;(); //例2:用于redis等缓存 static final Cache&lt;K,V&gt; USER_CACHE = CacheBuilder.newBuilder().build(); //例3:本地缓存 Static final Map&lt;K,V&gt; map = new HashMap(); 由于其被Static修饰,所以随着类的加载而被加载到内存之中,作为本地缓存,由于其又被final修饰,所以其引用(例3:map)和对象(例3:new HashMap())之间的关系是固定的,不能改变,因此不用担心赋值(=)导致缓存失效;
🚀如何添加Redis缓存？ Redis缓存作用模型：
标准的操作方式就是查询数据库之前先查询缓存，如果缓存数据存在，则直接从缓存中返回，如果缓存数据不存在，再查询数据库，然后将数据存入redis。
为查询的数据添加缓存 业务逻辑：
@Resource private StringRedisTemplate stringRedisTemplate; // 根据id查询商铺信息 @Override public Result queryById(Long id) { // redis缓存的key String key = RedisConstants.CACHE_SHOP_KEY &#43; id; //1. 从redis缓存中获取shop信息 String shopJSON = stringRedisTemplate." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/89e48589f7e6090c28003749ee0858be/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T10:39:37+08:00" />
<meta property="article:modified_time" content="2024-01-08T10:39:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">③使用Redis缓存，并增强数据一致性。</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/47/56/MRDzGpt4_o.gif" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>个人简介：Java领域新星创作者；阿里云技术博主、星级博主、专家博主；正在Java学习的路上摸爬滚打，记录学习的过程~<br> 个人主页：<a href="https://blog.csdn.net/ebb29bbe?spm=1018.2226.3001.5343">.29.的博客</a><br> 学习社区：<a href="https://bbs.csdn.net/forums/185241f773fb401b8ca7994dc3d02333?joinKey=cyru4ex9o7wq-mz6v1koj5x-1-add3ae8dc3827dbbd4360c79af92bbbe">进去逛一逛~</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/d6/27/m0GGE9vQ_o.png" alt="在这里插入图片描述"></p> 
<p></p> 
<div class="toc"> 
 <h4>使用Redis缓存，并增强数据一致性。</h4> 
 <ul><li><a href="#Redis_23" rel="nofollow">Redis缓存</a></li><li><ul><li><a href="#_29" rel="nofollow">🚀为什么使用缓存？</a></li><li><a href="#Redis_79" rel="nofollow">🚀如何添加Redis缓存？</a></li><li><a href="#_140" rel="nofollow">🚀缓存数据一致性问题（双写问题）</a></li><li><a href="#__199" rel="nofollow">🚀实现 缓存与数据库双写一致（此方式不能保证绝对一致）</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="Redis_23"></a>Redis缓存</h2> 
<br> 
<h3><a id="_29"></a>🚀为什么使用缓存？</h3> 
<p>缓存数据存储于代码中,而代码运行在内存中,内存的读写性能远高于磁盘,缓存可以大大降低<strong>用户访问并发量带来的</strong>服务器读写压力。</p> 
<ul><li><strong>缓存的作用：</strong></li><li> 
  <ul><li>降低后端负载。</li><li>提高读写效率，降低响应时间。</li></ul> </li></ul> 
<br> 
<p>使用缓存的同时，也会增加代码复杂度和运营的成本。</p> 
<ul><li><strong>缓存的成本：</strong></li><li> 
  <ul><li>数据一致性成本（双写问题）</li><li>代码维护成本</li><li>运维成本</li></ul> </li></ul> 
<br> 
<ul><li> <p><strong>缓存的使用案例：</strong></p> </li><li> 
  <ul><li> <p><strong>缓存(<strong>Cache),就是数据交换的</strong>缓冲区</strong>,俗称的缓存就是<strong>缓冲区内的数据</strong>,一般从数据库中获取,存储于本地代码(例如:</p> <pre><code class="prism language-java"><span class="token comment">// 例1:本地用于高并发</span>
<span class="token class-name">Static</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//例2:用于redis等缓存</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token constant">USER_CACHE</span> <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//例3:本地缓存</span>
<span class="token class-name">Static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <p>由于其被<strong>Static</strong>修饰,所以随着类的加载而被加载到<strong>内存之中</strong>,作为本地缓存,由于其又被<strong>final</strong>修饰,所以其引用(例3:map)和对象(例3:new HashMap())之间的关系是固定的,不能改变,因此不用担心赋值(=)导致缓存失效;</p> </li></ul> </li></ul> 
<br> 
<hr> 
<br> 
<h3><a id="Redis_79"></a>🚀如何添加Redis缓存？</h3> 
<p><code>Redis缓存作用模型</code>：</p> 
<p>标准的操作方式就是查询数据库之前先查询缓存，如果缓存数据存在，则直接从缓存中返回，如果缓存数据不存在，再查询数据库，然后将数据存入redis。</p> 
<p><img src="https://images2.imgbox.com/d1/f4/6yMpHE1m_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p><code>为查询的数据添加缓存 业务逻辑</code>：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token comment">// 根据id查询商铺信息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// redis缓存的key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token comment">//1. 从redis缓存中获取shop信息</span>
        <span class="token class-name">String</span> shopJSON <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 缓存存在，返回（Hutool工具：StrUtil、JSONUtil）</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJSON<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//3. 缓存未命中，从数据库中获取</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 数据库中不存在，返回错误</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"店铺不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5. 数据库中存在，存入redis缓存（Hutool工具：JSONUtil）</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//6. 返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<hr> 
<br> 
<h3><a id="_140"></a>🚀缓存数据一致性问题（双写问题）</h3> 
<p><code>双写问题</code>：</p> 
<p>双写问题通常出现在以下场景：</p> 
<ol><li><strong>写入数据源：</strong> 应用程序接收到写入请求后，首先将数据写入主要的数据源（例如数据库）。</li><li><strong>写入缓存：</strong> 同时，应用程序尝试将相同的数据写入缓存，以提高后续对该数据的读取性能。</li></ol> 
<p>在这个过程中，如果写入数据源成功而写入缓存失败，或者写入缓存成功而写入数据源失败，就会导致数据不一致的情况。例如：</p> 
<ul><li><strong>写入数据源成功，写入缓存失败：</strong> 在这种情况下，缓存中可能没有最新的数据，而应用程序仍然从缓存中读取旧数据，导致不一致。</li><li><strong>写入缓存成功，写入数据源失败：</strong> 这种情况下，缓存中包含了最新的数据，但是由于数据源没有更新，当应用程序从数据源中读取数据时，可能得到旧的数据，同样导致不一致。</li></ul> 
<p><br><br></p> 
<p><code>解决方案</code>：</p> 
<ul><li> <p><code>Cache Aside Pattern</code>人工编码方式：缓存调用者在更新完数据库后再去更新缓存，也称之为双写方案</p> </li><li> <p><code>Read/Write Through Pattern</code> : 缓存与数据库整合为一个服务，用服务来维护一致性。调用者调用该服务，无需关系缓存一致性问题。即：由系统本身完成，数据库与缓存的问题交由系统本身去处理</p> </li><li> <p><code>Write Behind Caching Pattern</code> ：调用者只操作缓存，其他线程去异步处理数据库，实现最终一致</p> </li></ul> 
<p><br><br></p> 
<p><code>使用Cache Aside Pattern人工编码方式，需要注意的问题</code>：</p> 
<ul><li><strong>删除缓存还是更新缓存？</strong></li><li> 
  <ul><li>更新缓存：每次更新数据库都更新缓存，无效写操作较多（×）</li><li>删除缓存：更新数据库时让缓存失效，查询时再更新缓存（<code>√</code>）</li></ul> </li></ul> 
<br> 
<ul><li><strong>如何保证缓存与数据库操作同时成功或失败？</strong></li><li> 
  <ul><li>单体系统，将缓存与数据库操作放在一个事务</li><li>分布式系统，利用TCC等分布式事务方案</li></ul> </li></ul> 
<br> 
<ul><li><strong>先操作缓存还是先操作数据库？</strong></li><li> 
  <ul><li>选择①：先删除缓存，再操作数据库</li><li>选择②：先操作数据库，再删除缓存（<code>√</code>）</li><li>应该具体操作缓存还是操作数据库？ 我们<strong>应当是先操作数据库，再删除缓存</strong> ，原因在于，如果你选择第一种方案，在两个线程并发来访问时，假设线程1先来，他先把缓存删了，此时线程2过来，他查询缓存数据并不存在，此时他写入缓存，当他写入缓存后，线程1再执行更新动作时，实际上写入的就是旧的数据，新的数据被旧数据覆盖了。</li></ul> </li></ul> 
<br> 
<hr> 
<br> 
<h3><a id="__199"></a>🚀实现 缓存与数据库双写一致（此方式不能保证绝对一致）</h3> 
<p><code>流程</code>：</p> 
<ul><li>查询数据时，若缓存未命中，从数据库中获取，再将结果写入缓存，设置过期时间(TTL)。</li><li>修改数据时，先更新数据库，再删除缓存。</li></ul> 
<p><br><br></p> 
<p><code>查询数据时</code>：</p> 
<pre><code class="prism language-java">    <span class="token comment">// 根据id查询商铺信息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// redis缓存的key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"cache:shop:"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token comment">//1. 从redis缓存中获取shop信息</span>
        <span class="token class-name">String</span> shopJSON <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 缓存存在，返回</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJSON<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//3. 缓存未命中，从数据库中获取</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 数据库中不存在，返回错误</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"店铺不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5. 数据库中存在，存入redis缓存，并设置过期时间ttl</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//6. 返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p><code>查询数据时(解决缓存穿透)：</code></p> 
<pre><code class="prism language-java">    <span class="token comment">// 根据id查询商铺信息（缓存空值，避免缓存穿透问题）</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// redis缓存的key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token comment">//1. 从redis缓存中获取shop信息</span>
        <span class="token class-name">String</span> shopJSON <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>shopJSON <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// 获取值为空，返回错误</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"商铺不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//2. 缓存存在，返回</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJSON<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//3. 缓存未命中，从数据库中获取</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 数据库中不存在，空值写入Redis，返回错误</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 控制写入Redis，设置2分钟有效期</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//返回错误</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"商铺不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//5. 数据库中存在，存入redis缓存</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//6. 返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p><code>修改数据时</code>：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>  <span class="token comment">//开启事务，保证证缓存与数据库操作同时成功或失败</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"商铺ID不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//注意: 先更新数据库再删除缓存</span>
        
        <span class="token comment">//1. 更新数据库</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 删除缓存</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"cache:shop:"</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<hr> 
<p><br><br></p> 
<p><a href="https://blog.csdn.net/ebb29bbe?type=blog"><img src="https://images2.imgbox.com/af/ec/gsa6VhhK_o.png" alt="在这里插入图片描述"></a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1621559487a2a853914d3a3c5e236b34/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android 权限总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cfbd7bb6f742cda04507e811bd3dd01b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Grafana UI 入门使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>