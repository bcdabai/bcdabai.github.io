<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux系统学习——简单的Shell终端实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux系统学习——简单的Shell终端实现" />
<meta property="og:description" content="文章目录 前言一、程序所用到的函数1、fork函数2、pipe函数3、execvp函数4、dup2函数5、waitpid函数6、getcwd函数和chdir函数7、strtok函数7、fgets函数 二、程序所实现的功能三、程序功能的实现四、执行效果五、总结 前言 最近学习了fork、pipe、exec族等的linux系统调用函数，现在将这几天所学的结合起来，做一个简单地shell终端。
一、程序所用到的函数 1、fork函数 定义:pid_t fork(void)
功能:创建一个子进程
使用例程
//包含的头文件 #include &lt;sys/types.h&gt; #include &lt;unistd.h&gt; pid_t pid; pid = fork(void); if(pid&lt;0){}//表示创建失败 else if(pid==0){}//表示子进程 else if(pid&gt;0){}//表示父进程 pid为子进程的PID 2、pipe函数 定义:int pipe(int pipefd[2]);
功能:创建一个管道 pipefd[0]为读端 pipefd[1]为写端，读端写端实质是两个文件描述符
使用例程
//包含头文件 #include &lt;unistd.h&gt; int fd[2],ret; ret = pipe(fd); if(ret==-1){}//表示创建失败 3、execvp函数 定义:int execvp(const char *file, char *const argv[]);
功能:会根据当前系统环境变量，找到file执行，传入参数为 argv[] 指针数组 执行之后，当前进程的所有内容会被替换
使用例程
//包含头文件 #include &lt;unistd.h&gt; char *argv[] = {&#34;ls&#34;, &#34;-al&#34;, NULL};//最后一个参数要为NULL，表示传入的参数到这里就已经结束 execvp(argv[0], argv);//执行ls命令 4、dup2函数 定义:int dup2(int oldfd, int newfd);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cf11d127f6caf827321d4ffd3174e958/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-04T11:19:53+08:00" />
<meta property="article:modified_time" content="2020-09-04T11:19:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux系统学习——简单的Shell终端实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_3" rel="nofollow">一、程序所用到的函数</a></li><li><ul><li><ul><li><a href="#1fork_4" rel="nofollow">1、fork函数</a></li><li><a href="#2pipe_22" rel="nofollow">2、pipe函数</a></li><li><a href="#3execvp_36" rel="nofollow">3、execvp函数</a></li><li><a href="#4dup2_48" rel="nofollow">4、dup2函数</a></li><li><a href="#5waitpid_66" rel="nofollow">5、waitpid函数</a></li><li><a href="#6getcwdchdir_87" rel="nofollow">6、getcwd函数和chdir函数</a></li><li><a href="#7strtok_105" rel="nofollow">7、strtok函数</a></li><li><a href="#7fgets_130" rel="nofollow">7、fgets函数</a></li></ul> 
     </li></ul> 
     </li><li><a href="#_145" rel="nofollow">二、程序所实现的功能</a></li><li><a href="#_151" rel="nofollow">三、程序功能的实现</a></li><li><a href="#_373" rel="nofollow">四、执行效果</a></li><li><a href="#_385" rel="nofollow">五、总结</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h5><a id="_1"></a>前言</h5> 
<p>最近学习了fork、pipe、exec族等的linux系统调用函数，现在将这几天所学的结合起来，做一个简单地shell终端。</p> 
<h5><a id="_3"></a>一、程序所用到的函数</h5> 
<h6><a id="1fork_4"></a>1、fork函数</h6> 
<p>定义:pid_t fork(void)<br> 功能:创建一个子进程<br> 使用例程</p> 
<pre><code class="prism language-c"><span class="token comment">//包含的头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

pid_t pid<span class="token punctuation">;</span>

pid <span class="token operator">=</span>  <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//表示创建失败</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//表示子进程</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//表示父进程 pid为子进程的PID</span>
</code></pre> 
<h6><a id="2pipe_22"></a>2、pipe函数</h6> 
<p>定义:int pipe(int pipefd[2]);<br> 功能:创建一个管道 pipefd[0]为读端 pipefd[1]为写端，读端写端实质是两个文件描述符<br> 使用例程</p> 
<pre><code class="prism language-c"><span class="token comment">//包含头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ret<span class="token punctuation">;</span>

ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//表示创建失败</span>
</code></pre> 
<h6><a id="3execvp_36"></a>3、execvp函数</h6> 
<p>定义:int execvp(const char *file, char *const argv[]);<br> 功能:会根据当前系统环境变量，找到file执行，传入参数为 argv[] 指针数组 执行之后，当前进程的所有内容会被替换<br> 使用例程</p> 
<pre><code class="prism language-c"><span class="token comment">//包含头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"-al"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//最后一个参数要为NULL，表示传入的参数到这里就已经结束</span>
<span class="token function">execvp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行ls命令  </span>
</code></pre> 
<h6><a id="4dup2_48"></a>4、dup2函数</h6> 
<p>定义:int dup2(int oldfd, int newfd);<br> 功能:将newfd文件描述符，指向oldfd所指向的文件<br> 使用dup2之前<br> <img src="https://images2.imgbox.com/5c/a2/fkbxpeIM_o.png" alt="在这里插入图片描述"><br> 使用dup2之后<br> <img src="https://images2.imgbox.com/bf/dc/F9DwrkIT_o.png" alt="在这里插入图片描述"><br> 参考文章：<a href="https://www.jianshu.com/p/eded4a4348fe" rel="nofollow">dup2的理解</a><br> 使用例程</p> 
<pre><code class="prism language-c"><span class="token comment">//使用头文件 </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将标准输出指向文件file 所有的输出都会输出到file中</span>
</code></pre> 
<h6><a id="5waitpid_66"></a>5、waitpid函数</h6> 
<p>定义:pid_t waitpid(pid_t pid, int *wstatus, int options)<br> 功能:等待执行PID的子进程结束，结束状态会存放在wstatus中(结合一些特定的宏一起使用)，options为0时表示阻塞等待，options为WNOHANG(宏定义)时，表示非阻塞等待<br> 使用例程</p> 
<pre><code class="prism language-c"><span class="token comment">//包含的头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span><span class="token comment">//子进程</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻塞等待子进程结束</span>
<span class="token punctuation">}</span><span class="token comment">//父进程</span>
</code></pre> 
<h6><a id="6getcwdchdir_87"></a>6、getcwd函数和chdir函数</h6> 
<p>定义:char *getcwd(char *buf, size_t size)<br> int chdir(char *path);<br> 功能:获取<strong>当前进程</strong>的目录<br> 改变<strong>当前进程</strong>的目录<br> 使用例程</p> 
<pre><code class="prism language-c"><span class="token comment">//所用到的头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">getcwd</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//假设当前目录为 /test/chdir/getcwd </span>
<span class="token comment">//执行程序之后</span>
<span class="token comment">//当前目录为 /test/chdir</span>
</code></pre> 
<h6><a id="7strtok_105"></a>7、strtok函数</h6> 
<p>定义:char *strtok(char *str, const char *delim);<br> 功能:对字符串str,根据delim进行分割<br> 使用例程</p> 
<pre><code class="prism language-c"><span class="token comment">//包含头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"I am SJ,hello world"</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span>cstr<span class="token punctuation">;</span>

cstr <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//以空格进行分割,str只需传入一次 后面传入NULL</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>cstr<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token comment">//当分割到末尾时 返回NULL</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> cstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cstr <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">/*  运行结果
 *   I
 *   am
 *   SJ,hello
 *   world
 */</span>
</code></pre> 
<h6><a id="7fgets_130"></a>7、fgets函数</h6> 
<p>定义:char *fgets(char *s, int size, FILE *stream)<br> 功能:从stream中获取size大小的一行输入，换行符(\n）表示输入结束，将其存放在s中<br> 使用例程</p> 
<pre><code class="prism language-c"><span class="token comment">//使用的头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从标准输入中读取size个字符 遇换行符则结束 </span>
<span class="token comment">// 输入: I am SJ(回车)</span>
<span class="token comment">// s = "I am SJ\n"</span>
</code></pre> 
<h5><a id="_145"></a>二、程序所实现的功能</h5> 
<p>1、基本的命令的使用，如：cd、ls、cat、echo、ps 等的一些基本命令，操作与在linux终端下的没有区别<br> 2、重定向输入和输出，即 cmd &gt; file 和 cmd &lt; file<br> 3、多管道操作 | 如:cat file | cat | cat | cat<br> 基本来讲linux终端下可执行的命令，都可以在这个shell终端下执行</p> 
<h5><a id="_151"></a>三、程序功能的实现</h5> 
<p>1、获取输入的命令，并使用strtok将其分割</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 *   命令获取并处理函数
 */</span>
<span class="token keyword">void</span> <span class="token function">argv_Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> len<span class="token punctuation">;</span>
	length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">//获取一行字符串，将其存放于cmd字符数组中</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">sys_error</span><span class="token punctuation">(</span><span class="token string">"fges fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//将输入cmd命令用strtok函数根据空格进行分割，存放于arg指针数组中</span>
	arg<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">strtok</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		length<span class="token operator">++</span><span class="token punctuation">;</span>
		arg<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">strtok</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//fgets函数获取一行字符串时会将末尾的 \n 一起获取出来 所以这里要将其处理掉</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/*
		 *  判断最后一个被分割出的命令是否只包含一个换行符（\n）
		 *  将其位置设置为NULL（作为一个哨兵） 并将命令总长度减一
		 */</span>
		arg<span class="token punctuation">[</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
		length <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/*
		 *  设置哨兵
		 *  并将最后一个命令的换行符删除
		 */</span>
		arg<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
		len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		arg<span class="token punctuation">[</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2、命令执行函数<br> 支持重定向、管道和普通命令的执行<br> 重定向和管道操作的实质是对进程的标准输入（STDIN_FILENO）和标准输出（STDOUT_FILENO）进行重定向，指向另外一个文件或者其他进程 使用dup2函数即可实现该功能</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 *	命令执行函数
 *  start : 表示在命令的起始位置
 *  fd_in : 输入重定向文件描述符 -1表示此次执行的命令无重定向输入
 *  fd_out: 输出重定向文件描述符 -1表示此次执行的命令无重定向输出
 *  flag  : 管道标志位 1表示此次命令的输出需要使用管道进行重定向
 *  返回值: 若flag为true 则返回创建的管道的读端 作为下一条命令的重定向输入
 */</span>
<span class="token keyword">int</span> <span class="token function">Pipe_handle</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> fd_in<span class="token punctuation">,</span> <span class="token keyword">int</span> fd_out<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ret<span class="token punctuation">;</span>
	pid_t pid<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//flag为true时 创建管道</span>
		ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">sys_error</span><span class="token punctuation">(</span><span class="token string">"pipe error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//创建一个子进程 用于执行命令</span>
	pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//fork出错</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">sys_error</span><span class="token punctuation">(</span><span class="token string">"fork fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//子进程</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//使用创建的管道进行输出重定向</span>
			<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>fd_out<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//使用传入的输出重定向文件描述符进行重定向</span>
			<span class="token function">dup2</span><span class="token punctuation">(</span>fd_out<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>fd_in<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//使用传入的输入重定向文件描述符进行重定向</span>
			<span class="token function">dup2</span><span class="token punctuation">(</span>fd_in<span class="token punctuation">,</span> STDIN_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//执行命令 使用固定参数个数并使用path的函数</span>
		<span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token operator">+</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token comment">//父进程 返回值pid为子进程的PID</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//阻塞等待子进程结束</span>
		<span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd_in<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">close</span><span class="token punctuation">(</span>fd_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd_out<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">close</span><span class="token punctuation">(</span>fd_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">return</span> flag<span class="token operator">?</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3、命令解析函数<br> 功能：遍历全部的命令字符串（fgets获取到一行命令之后使用strtok函数分割出来的命令），对 &lt; 、&gt;、| 和 普通命令进行不同的操作，实现其功能</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 *  命令识别函数
 *  识别命令中的 管道(|) 重定向符(&lt; &gt;)
 */</span>
<span class="token keyword">void</span> <span class="token function">argv_execl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	 *  处理方法详解：
	 *  1、&gt;:重定向输出  格式: cmd &gt; file
	 *     将file打开 获得文件描述符fd
	 *     执行Pipe_handle(start, -1, fd, 0) 表示无重定向输入 有重定向输出 无管道操作
	 *  2、&lt;:重定向输入  格式：cmd &lt; file
	 *     将file打开 获得文件描述符fd
	 *     执行Pipe_handle(start, -1, fd, 0) 表示无重定向输入 有重定向输出 无管道操作
	 *  3、|:管道操作符  格式：cmd | cmd | cmd | .....
	 *     将 | 命令的位置设置为NULL 作为execvp函数执行时的哨兵 
	 *     start位置移动到下一条命令的起始位置 即当前 管道符(|)的位置加一
	 *     执行 fd = Pipe_handle(start, fd, -1, 1); 返回值fd为所创建管道的读端 作为下一条命令的重定向输入
	 *     fd的初始值为 -1 所以首次执行管道命令时，输入不会重定向
	 */</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
			fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDWR<span class="token operator">|</span>O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">sys_error</span><span class="token punctuation">(</span><span class="token string">"&gt; open file fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token function">Pipe_handle</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
			fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"&lt;"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
			fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">sys_error</span><span class="token punctuation">(</span><span class="token string">"&lt; open file fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token function">Pipe_handle</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
			fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"|"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
			fd <span class="token operator">=</span> <span class="token function">Pipe_handle</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			start <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//表示一条普通命令 不具备三种操作符 </span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">Pipe_handle</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">// 表示执行到管道的最后一条命令 </span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">//获取到的管道的读端作为程序的输入</span>
				<span class="token function">Pipe_handle</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9a/21/GCUhUEaK_o.png" alt="在这里插入图片描述"><br> 4、回车和cd改变目录<br> 如果直接执行cd命令，改变的是execvp该子进程的路径，不是主进程的路径。所以要使用chdir改变当前进程的目录</p> 
<pre><code class="prism language-c"><span class="token comment">//cd表示改变目录 要使用chdir改变进程的目录 arg[1]代表路径 cd path,cd 是 arg[0]</span>
<span class="token function">chdir</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>回车操作，即只输入一个换行符，经过命令解析函数解析后，arg[0]=NULL<br> 当该条件成立时，跳出此次循环，开始下一次循环。</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//回车</span>
	<span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_373"></a>四、执行效果</h5> 
<p>1、启动<br> <img src="https://images2.imgbox.com/74/be/j5nDXwd7_o.png" alt="在这里插入图片描述"><br> 2、基本命令，cd、ls 、 pwd 、ps和文件目录操作</p> 
<p><img src="https://images2.imgbox.com/2c/9a/TV2oUHJN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e5/e4/uLWLGeYO_o.png" alt="在这里插入图片描述"><br> 3、重定向操作<br> <img src="https://images2.imgbox.com/a7/f7/J2zYQstT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ad/75/udZjsH9Q_o.png" alt="在这里插入图片描述"><br> 4、退出<br> <img src="https://images2.imgbox.com/62/09/muTfgsZ3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_385"></a>五、总结</h5> 
<p>总体来讲难度不大，基本上是一些系统调用函数的使用。多管道操作要理解其执行过程，再用代码将其表达出来。这个比较适合练手，可以加深对一些系统函数的使用与理解。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/89b3cb56246862b4052d0ad09cebe357/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">class path resource [xxx.class] cannot be opened because  it does not exist</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/69f5ee6da79e948ffeb8f15d93e82153/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IPsec 配置干货,理论&#43;配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>