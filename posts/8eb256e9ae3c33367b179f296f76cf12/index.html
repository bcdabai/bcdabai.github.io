<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>游戏外挂：劫持技术 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="游戏外挂：劫持技术" />
<meta property="og:description" content="1． 安装DetoursExpress30.msi,点击安装，安装后的目录结构如下：
在sample里面有例子，可供查看使用
2.第一步，打开VS2013开发人员命令提示（E:\Installed\MicrosoftVisual Studio 12.0\Common7\Tools\Shortcuts\VS2013 开发人员命令提示），进入Detours安装目录下的src目录，效果图如下：
2．新建项目，暂定项目名称是“劫持”
3．lib知识点
选中解决翻案à添加à新建项目à常规，输入lib名称
创建一个1.c文件
同理，添加一个1.h,内容如下
void msg();
添加一个1.c,内容如下：
#include&lt;Windows.h&gt;
void msg()
{
MessageBoxA(0, &#34;11111&#34;, &#34;2222&#34;, 0);
}
右击项目à属性à常规à配置类型à静态库.lib
然后，生成à生成lib,执行完成后发现资源目录里面的Debug目录下就有lib.lib文件了。
如果想在劫持项目中使用自己写的静态链接库。右击劫持项目à属性à链接器à常规à输入à附加依赖库，在最前面添加 lib.lib; 截图如下：
将lib.lib文件放到源文件同级目录下，截图如下：
在劫持项目里的hello.c文件中添加函数声明
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
voidmsg();
void main()
{
printf(&#34;hello world&#34;);
getchar();
}
这时候运行的时候就可以调用了lib.lib了。
动态库随时加载，随时注入。
静态库只有在编译的时候才可以调用。
4.使用detours做劫持(将项目改成release模式),其中项目结构如下（下面是劫持自己的过程）：
A放文件有：
detours.h (src下)
detours.lib (lib.X86下)
detver.h (src下)
将上面的文件放在源文件目录下即可
B.添加
#include&#34;detours.h&#34; //载入头文件
#pragma comment(lib, &#34;detours.lib&#34;)//表明要使用静态库
C:定义一个新的函数取代旧的函数。
int newsystem(const char *_Command) //新的函数
{
return 0;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8eb256e9ae3c33367b179f296f76cf12/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-07-28T01:14:55+08:00" />
<meta property="article:modified_time" content="2014-07-28T01:14:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">游戏外挂：劫持技术</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>1．  安装DetoursExpress30.msi,点击安装，安装后的目录结构如下：</p> 
<p><img alt="" src="https://images2.imgbox.com/f2/f8/hIScIhlw_o.png"><br> </p> 
<p></p> 
<p>在sample里面有例子，可供查看使用</p> 
<p>2.第一步，打开VS2013开发人员命令提示（E:\Installed\MicrosoftVisual Studio 12.0\Common7\Tools\Shortcuts\VS2013 开发人员命令提示），进入Detours安装目录下的src目录，效果图如下：</p> 
<p><img alt="" src="https://images2.imgbox.com/9d/6f/qYQJnnxb_o.png"><br> </p> 
<p></p> 
<p>2．新建项目，暂定项目名称是“劫持”</p> 
<p>3．lib知识点</p> 
<p>选中解决翻案à添加à新建项目à常规，输入lib名称</p> 
<p><img alt="" src="https://images2.imgbox.com/2f/3e/FeBn66BE_o.png"><br> </p> 
<p></p> 
<p>创建一个1.c文件</p> 
<p><img alt="" src="https://images2.imgbox.com/64/77/mavJZxot_o.png"><br> </p> 
<p></p> 
<p>同理，添加一个1.h,内容如下</p> 
<p><span style="color:blue">void</span> <span style="color:#8800">msg</span>();</p> 
<p>添加一个1.c,内容如下：</p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">&lt;Windows.h&gt;</span></p> 
<p align="left"> </p> 
<p align="left"><span style="color:blue">void</span> <span style="color:#8800">msg</span>()</p> 
<p align="left">{<!-- --></p> 
<p align="left">    <span style="color:#8800">MessageBoxA</span>(0, <span style="color:#a31515"> "11111"</span>, <span style="color:#a31515">"2222"</span>, 0);</p> 
<p>}</p> 
<p>右击项目à属性à常规à配置类型à静态库.lib</p> 
<p> </p> 
<p>然后，生成à生成lib,执行完成后发现资源目录里面的Debug目录下就有lib.lib文件了。</p> 
<p> </p> 
<p>如果想在劫持项目中使用自己写的静态链接库。右击劫持项目à属性à链接器à常规à输入à附加依赖库，在最前面添加   lib.lib;  截图如下：</p> 
<p></p> 
<p> <img alt="" src="https://images2.imgbox.com/a0/e5/yuuI60Ez_o.png"></p> 
<p>将lib.lib文件放到源文件同级目录下，截图如下：</p> 
<p></p> 
<p> <img alt="" src="https://images2.imgbox.com/89/1e/5bvad0Ex_o.png"></p> 
<p>在劫持项目里的hello.c文件中添加函数声明</p> 
<p align="left"><span style="color:blue">#include</span> <span style="color:#a31515"> &lt;stdio.h&gt;</span></p> 
<p align="left"><span style="color:blue">#include</span> <span style="color:#a31515"> &lt;stdlib.h&gt;</span></p> 
<p align="left"><span style="color:red">voidmsg();</span></p> 
<p align="left"> </p> 
<p align="left"><span style="color:blue">void</span> <span style="color:#8800">main</span>()</p> 
<p align="left">{<!-- --></p> 
<p align="left">    <span style="color:#8800">printf</span>(<span style="color:#a31515">"hello world"</span>);</p> 
<p align="left">    <span style="color:#6f08a">getchar</span>();</p> 
<p>}</p> 
<p>这时候运行的时候就可以调用了lib.lib了。</p> 
<p> </p> 
<p>动态库随时加载，随时注入。</p> 
<p>静态库只有在编译的时候才可以调用。</p> 
<p> </p> 
<p>4.使用detours做劫持(将项目改成release模式),其中项目结构如下（下面是劫持自己的过程）：</p> 
<p>A放文件有：</p> 
<p>detours.h   (src下)</p> 
<p>detours.lib  (lib.X86下)</p> 
<p>detver.h    (src下)</p> 
<p>将上面的文件放在源文件目录下即可</p> 
<p>B.添加</p> 
<p>#include"detours.h"  //载入头文件</p> 
<p>#pragma comment(lib, "detours.lib")//表明要使用静态库</p> 
<p> </p> 
<p>C:定义一个新的函数取代旧的函数。</p> 
<p align="left"><span style="color:blue">int</span>  <span style="color:#8800">newsystem</span>(<span style="color:blue">const</span> <span style="color:blue">char</span> *<span style="color:navy">_Command</span>) <span style="color:green"> //</span><span style="color:green">新的函数</span></p> 
<p align="left">{<!-- --></p> 
<p align="left">    <span style="color:blue">return</span> 0;</p> 
<p align="left">}</p> 
<p> </p> 
<p>D：添加Hook()方法和UnHook();</p> 
<p> </p> 
<p>E:设置上detours.lib，方法是：<a target="_blank" name="OLE_LINK3"></a><a target="_blank" name="OLE_LINK2">右击项目</a>à属性à链接器à输入à附加依赖项。截图：</p> 
<p></p> 
<p> <img alt="" src="https://images2.imgbox.com/c3/72/UjvKYm1o_o.png"></p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">&lt;stdio.h&gt;</span></p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">&lt;stdlib.h&gt;</span></p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">&lt;Windows.h&gt;</span></p> 
<p align="left"><span style="color:blue">#include</span> <span style="color:#a31515"> "detours.h"</span> <span style="color:green">//</span><span style="color:green">载入头文件</span></p> 
<p align="left"><span style="color:blue">#pragma</span> <span style="color:blue"> comment</span>(<span style="color:blue">lib</span>,<span style="color:#a31515">"detours.lib"</span>)<span style="color:green">//</span><span style="color:green">表明要使用的静态库</span></p> 
<p align="left"><span style="color:green">//detour</span><span style="color:green">在realse</span>模式生效</p> 
<p align="left"><span style="color:green">//</span><span style="color:green">创建函数指针等于地址,</span>加上静态防止影响其它的源文件</p> 
<p align="left"><span style="color:blue">static</span> <span style="color:blue">int</span>(*<span style="color:#8800">oldsystem</span>)(<span style="color:blue">const</span><span style="color:blue">char</span>* <span style="color:navy">_Command</span>) =<span style="color:#8800">system</span>;</p> 
<p align="left"> </p> 
<p align="left"><a target="_blank" name="OLE_LINK1"><span style="color:blue">int</span></a> <span style="color:#8800">newsystem</span>(<span style="color:blue">const</span><span style="color:blue">char</span> * <span style="color:navy">_Command</span>) <span style="color:green">//</span><span style="color:green">新的函数</span></p> 
<p align="left">{<!-- --></p> 
<p align="left">    <span style="color:blue">return</span> 0;</p> 
<p align="left">}</p> 
<p align="left"> </p> 
<p align="left"><span style="color:green">//</span><span style="color:green">开始拦截</span></p> 
<p align="left"><span style="color:blue">void</span> <span style="color:#8800">Hook</span>()</p> 
<p align="left">{<!-- --></p> 
<p align="left">    DetourRestoreAfterWith();<span style="color:green">//</span><span style="color:green">恢复原来状态,</span></p> 
<p align="left">    DetourTransactionBegin();<span style="color:green">//</span><span style="color:green">拦截开始</span></p> 
<p align="left">    DetourUpdateThread(<span style="color:#8800">GetCurrentThread</span>());<span style="color:green">//</span><span style="color:green">刷新当前线程</span></p> 
<p align="left">    <span style="color:green">//</span><span style="color:green">这里可以连续多次调用DetourAttach</span>，表明HOOK多个函数</p> 
<p align="left"> </p> 
<p align="left">    DetourAttach((<span style="color:blue">void</span> **)&amp;<span style="color:#8800">oldsystem</span>,<span style="color:#8800">newsystem</span>);<span style="color:green">//</span><span style="color:green">实现函数拦截</span></p> 
<p align="left">    DetourTransactionCommit();<span style="color:green">//</span><span style="color:green">拦截生效</span></p> 
<p align="left">}</p> 
<p align="left"> </p> 
<p align="left"><span style="color:green">//</span><span style="color:green">取消拦截</span></p> 
<p align="left"><span style="color:blue">void</span> <span style="color:#8800">UnHook</span>()</p> 
<p align="left">{<!-- --></p> 
<p align="left">    DetourTransactionBegin();<span style="color:green">//</span><span style="color:green">拦截开始</span></p> 
<p align="left">    DetourUpdateThread(<span style="color:#8800">GetCurrentThread</span>());<span style="color:green">//</span><span style="color:green">刷新当前线程</span></p> 
<p align="left">    <span style="color:green">//</span><span style="color:green">这里可以连续多次调用DetourDetach,</span>表明撤销多个函数HOOK</p> 
<p align="left">    DetourDetach((<span style="color:blue">void</span> **)&amp;<span style="color:#8800">oldsystem</span>,<span style="color:#8800">newsystem</span>); <span style="color:green">//</span><span style="color:green">撤销拦截函数</span></p> 
<p align="left">    DetourTransactionCommit();<span style="color:green">//</span><span style="color:green">拦截生效</span></p> 
<p align="left">}</p> 
<p align="left"> </p> 
<p align="left"> </p> 
<p align="left"><span style="color:blue">void</span> <span style="color:#8800">main</span>()</p> 
<p align="left">{<!-- --></p> 
<p align="left">    <span style="color:#8800">system</span>(<span style="color:#a31515">"calc"</span>);</p> 
<p align="left">    <span style="color:#8800">printf</span>(<span style="color:#a31515">"%p,%p,%p"</span>,<span style="color:#8800">system</span>, <span style="color:#8800">newsystem</span>, <span style="color:#8800">oldsystem</span>);</p> 
<p align="left">    <span style="color:#8800">Hook</span>();</p> 
<p align="left">    <span style="color:#8800">printf</span>(<span style="color:#a31515">"\n%p,%p,%p"</span>,<span style="color:#8800">system</span>, <span style="color:#8800">newsystem</span>, <span style="color:#8800">oldsystem</span>);</p> 
<p align="left">    <span style="color:#8800">system</span>(<span style="color:#a31515">"calc"</span>);</p> 
<p align="left">    <span style="color:#6f08a">getchar</span>();</p> 
<p>}</p> 
<p> </p> 
<p>现象是加了Hook()之后只弹出了一次计算机窗口，如果去掉了Hook()方法，则出现两个计算器窗口。</p> 
<p> </p> 
<p>5、劫持应用</p> 
<p>A：创建一个基于窗口的MFC的应用程序-&gt;然后拖一个button-&gt;双击buttonà添加代码，事件代码如下：</p> 
<p align="left"><span style="color:blue">void</span> <span style="color:#216f85"> C</span><span style="color:#216f85">劫持测试2Dlg</span>::<span style="color:#8800">OnBnClickedButton1</span>()</p> 
<p align="left">{<!-- --></p> 
<p align="left">     <span style="color:green">// TODO:  </span><span style="color:green">在此添加控件通知处理程序代码</span></p> 
<p align="left">     <span style="color:blue">#include</span><span style="color:#a31515">&lt;stdlib.h&gt;</span></p> 
<p align="left">     <span style="color:#8800">system</span>(<span style="color:#a31515">"calc"</span>);</p> 
<p align="left">}</p> 
<p>窗口截图如下：</p> 
<p><img alt="" src="https://images2.imgbox.com/3a/7e/hnyMDdr0_o.png"><br> </p> 
<p></p> 
<p>B：选中解决方案，新建一个常规空项目（项目名称：劫持其他程序），这时候要写一个库劫持MFC程序</p> 
<p>将detours中的各种相关文件放到源文件下面。截图如下：</p> 
<p><img alt="" src="https://images2.imgbox.com/01/a2/gB7FpNuC_o.png"><br> </p> 
<p></p> 
<p>C：修改项目的依赖项：右击项目--&gt;属性--&gt;链接器--&gt;输入--&gt;附加依赖项-</p> 
<p><img alt="" src="https://images2.imgbox.com/a4/bd/FC7anNlv_o.png"><br> </p> 
<p></p> 
<p>D：将项目改成dll项目，也就是，修改配置属性里面的常规的目标文件名和配置类型，截图如下：</p> 
<p><img alt="" src="https://images2.imgbox.com/e5/ad/z7ogOUHS_o.png"><br> </p> 
<p></p> 
<p>1、编写dll内容：</p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">&lt;stdio.h&gt;</span></p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">&lt;stdlib.h&gt;</span></p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">&lt;Windows.h&gt;</span></p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">&lt;string.h&gt;</span></p> 
<p align="left"> </p> 
<p align="left"><span style="color:blue">#include</span><span style="color:#a31515">"detours.h"</span></p> 
<p align="left"><span style="color:blue">#pragma</span> <span style="color:blue"> comment</span>(<span style="color:blue">lib</span>, <span style="color:#a31515">"detours.lib"</span>)</p> 
<p align="left"> </p> 
<p align="left"><span style="color:blue">static</span> <span style="color:blue">int</span>(*<span style="color:#8800">poldsystem</span>)(<span style="color:blue">const</span><span style="color:blue">char</span> * <span style="color:navy">_Command</span>) =<span style="color:#8800">system</span>;<span style="color:green">//</span><span style="color:green">存储函数指针地址</span></p> 
<p align="left"> </p> 
<p align="left"><span style="color:blue">int</span>  <span style="color:#8800">newsystem</span>(<span style="color:blue">const</span> <span style="color:blue">char</span> *<span style="color:navy">_Command</span>)</p> 
<p align="left">{<!-- --></p> 
<p align="left">    <span style="color:green">//tasklist</span></p> 
<p align="left">    <span style="color:#8800">printf</span>(<span style="color:#a31515">"%s"</span>,<span style="color:navy">_Command</span>); <span style="color:green">//</span><span style="color:green">禁止你干活</span></p> 
<p align="left">    <span style="color:blue">return</span> 0;</p> 
<p align="left">}</p> 
<p align="left"><span style="color:green">//</span><span style="color:green">开始拦截</span></p> 
<p align="left"><span style="color:blue">void</span> <span style="color:#8800">Hook</span>()</p> 
<p align="left">{<!-- --></p> 
<p align="left">    <span style="color:#8800">DetourRestoreAfterWith</span>();<span style="color:green">//</span><span style="color:green">恢复原来状态</span></p> 
<p align="left">    <span style="color:#8800">DetourTransactionBegin</span>();<span style="color:green">//</span><span style="color:green">拦截开始</span></p> 
<p align="left">    <span style="color:#8800">DetourUpdateThread</span>(<span style="color:#8800">GetCurrentThread</span>());<span style="color:green">//</span><span style="color:green">刷新当前线程</span></p> 
<p align="left">    <span style="color:green">//</span><span style="color:green">这里可以连续多次调用DetourAttach</span>，表明HOOK多个函数</p> 
<p align="left">    <span style="color:#8800">DetourAttach</span>((<span style="color:blue">void</span> **)&amp;<span style="color:#8800">poldsystem</span>,<span style="color:#8800">newsystem</span>);<span style="color:green">//</span><span style="color:green">实现函数拦截</span></p> 
<p align="left">    <span style="color:#8800">DetourTransactionCommit</span>();<span style="color:green">//</span><span style="color:green">拦截生效</span></p> 
<p align="left">}</p> 
<p align="left"> </p> 
<p align="left"><span style="color:green">//</span><span style="color:green">导出函数，可以加载的时候调用</span></p> 
<p align="left"><span style="color:blue">_declspec</span>(<span style="color:blue">dllexport</span>)<span style="color:blue">void</span>  <span style="color:#8800">go</span>()</p> 
<p align="left">{<!-- --></p> 
<p align="left">    <span style="color:#8800">MessageBoxA</span>(0, <span style="color:#a31515"> "1"</span>, <span style="color:#a31515">"2"</span>, 0);</p> 
<p align="left">    <span style="color:#8800">Hook</span>();</p> 
<p>}</p> 
<p>E:生成dll文件，然后使用dllInject工具将它注入到应用里面。</p> 
<p> </p> 
<p>6：劫持系统的原理是劫持CreateProcess()函数。同样也是编写dll文件。</p> 
<p> </p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0391975e9d459a07f87e24a613e99183/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">矩阵的物理意义（二）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d262563863a09b49a141e6e2c3414957/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于QT的折腾</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>