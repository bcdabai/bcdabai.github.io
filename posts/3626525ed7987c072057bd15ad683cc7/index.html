<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【K8S】简明安装教程 - Snippet - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【K8S】简明安装教程 - Snippet" />
<meta property="og:description" content="人狠话不多，直接上命令。
###################################################
### OS Preparation, CentOS v7-2009
###################################################
yum install -y telnet vim net-tools open-vm-tools wget ntpdate yum-utils device-mapper-persistent-data lvm2
ntpdate time.windows.com
systemctl stop firewalld
systemctl disable firewalld
sed -i &#39;s/enforcing/disabled/&#39; /etc/selinux/config
setenforce 0 swapoff -a
sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab
cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
###################################################
### Prepare yum repos from aliyun.com
###################################################
cat &gt;&gt; /etc/yum.repos.d/docker-ce.repo &lt;&lt;EOF
[docker-repo]
name=Docker Repository" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3626525ed7987c072057bd15ad683cc7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-22T20:37:08+08:00" />
<meta property="article:modified_time" content="2022-05-22T20:37:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【K8S】简明安装教程 - Snippet</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>人狠话不多，直接上命令。</p> 
<p>###################################################<br> ### OS Preparation, CentOS v7-2009<br> ###################################################</p> 
<p>yum install -y telnet vim net-tools open-vm-tools wget ntpdate yum-utils device-mapper-persistent-data lvm2<br> ntpdate time.windows.com</p> 
<p>systemctl stop firewalld<br> systemctl disable firewalld<br> sed -i 's/enforcing/disabled/' /etc/selinux/config<br> setenforce 0 <br> swapoff -a<br> sed -ri 's/.*swap.*/#&amp;/' /etc/fstab</p> 
<p>cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF<br> net.bridge.bridge-nf-call-ip6tables = 1<br> net.bridge.bridge-nf-call-iptables = 1<br> EOF<br> sysctl --system</p> 
<p>###################################################<br> ### Prepare yum repos from aliyun.com<br> ###################################################</p> 
<p>cat &gt;&gt; /etc/yum.repos.d/docker-ce.repo &lt;&lt;EOF<br> [docker-repo]<br> name=Docker Repository<br> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/7.9/x86_64/stable/<br> enabled=1<br> gpgcheck=0<br> EOF</p> 
<p>cat &gt;&gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF<br> [kubernetes]<br> name=Kubernetes<br> baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/<br> enabled=1<br> gpgcheck=0<br> EOF</p> 
<p>yum clean all<br> yum makecache</p> 
<p>########################################################################<br> ### Install docker engine<br> ########################################################################<br> yum install -y docker-ce docker-ce-cli containerd.io<br> systemctl enable docker<br> systemctl start docker<br> systemctl enable containerd <br> systemctl start containerd </p> 
<p>tee /etc/docker/daemon.json &lt;&lt;EOF<br> {<!-- --><br>     "insecure-registries":["192.168.1.220:5000"],<br>     "registry-mirrors":["https://zt68n01x.mirror.aliyuncs.com"],<br>     "exec-opts": ["native.cgroupdriver=systemd"]    <br> }<br> EOF<br> systemctl restart docker</p> 
<p>#####################################################################<br> ### Install kubelet, kubeadm, kubectl<br> #####################################################################<br> yum install -y kubelet kubeadm kubectl<br> systemctl enable kubelet &amp;&amp; systemctl start kubelet</p> 
<p>#########################################################################################################</p> 
<p>#####################################################################<br> ### kubeadm init<br> #####################################################################<br> kubeadm init \<br> --image-repository=registry.aliyuncs.com/google_containers \<br> --kubernetes-version=v1.23.5 \<br> --service-cidr=10.1.0.0/16 \<br> --pod-network-cidr=10.244.0.0/16</p> 
<p>cat &gt;&gt; ~/.bash_profile &lt;&lt; EOF<br> export KUBECONFIG=/etc/kubernetes/admin.conf<br> EOF<br> source ~/.bash_profile<br> ######################################################################</p> 
<p>### 安装完成后记录一下命令行回显 ！！！<br> Your Kubernetes control-plane has initialized successfully!</p> 
<p>To start using your cluster, you need to run the following as a regular user:</p> 
<p>  mkdir -p $HOME/.kube<br>   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>   sudo chown $(id -u):$(id -g) $HOME/.kube/config</p> 
<p>Alternatively, if you are the root user, you can run:</p> 
<p>  export KUBECONFIG=/etc/kubernetes/admin.conf</p> 
<p>You should now deploy a pod network to the cluster.<br> Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:<br>   https://kubernetes.io/docs/concepts/cluster-administration/addons/</p> 
<p>Then you can join any number of worker nodes by running the following on each as root:</p> 
<p>kubeadm join 192.168.1.161:6443 --token i82ix2.2z87s31ilrmisfg1 \<br>         --discovery-token-ca-cert-hash sha256:377961908d0efdf16e1dd81b0b916adc3acf02ba54d68bd784c822cd46a4838d<br> #######################################################################################################################</p> 
<p>#####################################################################<br> ### Install flannel network in master machine<br> ### https://github.com/flannel-io/flannel<br> #####################################################################<br> kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</p> 
<p><br> ### Then join the other node into k8s<br> kubeadm join 192.168.1.161:6443 --token i6feiw.fr7xwojmv9frvb5y \<br> --discovery-token-ca-cert-hash sha256:b2bbe11f6a6eb66ab71ee44dc74bdbbdc2c1a63f7281b366fda0661475be1d79</p> 
<p>kubeadm join 192.168.1.161:6443 --token i6feiw.fr7xwojmv9frvb5y \<br> --discovery-token-ca-cert-hash sha256:b2bbe11f6a6eb66ab71ee44dc74bdbbdc2c1a63f7281b366fda0661475be1d79 </p> 
<p><br> #####################################################################<br> ### Deploy kubernetes dashboard in master machine<br> ### will pull image from docker.io, so expect to use mirror<br> ### kubectl get pods --namespace=kubernetes-dashboard<br> ### kubectl get service --namespace=kubernetes-dashboard<br> ### mirror: registry.cn-hangzhou.aliyuncs.com/google_containers/dashboard:v2.5.1<br> #####################################################################<br> kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml</p> 
<p># modify [type: ClusterIP] to NodePort<br> kubectl edit service kubernetes-dashboard --namespace=kubernetes-dashboard</p> 
<p>如下：<br> spec:<br>   clusterIP: 10.107.192.48<br>   externalTrafficPolicy: Cluster<br>   ports:<br>   - nodePort: 30001<br>     port: 443<br>     protocol: TCP<br>     targetPort: 8443<br>   selector:<br>     k8s-app: kubernetes-dashboard<br>   sessionAffinity: None<br>   type: NodePort      #### this line。</p> 
<p><br> #####################################################################<br> ### Create dashboard admin-token on Master machine.<br> ### kubectl create serviceaccount dashboard-admin -n kube-system<br> ### kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin<br> ### kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')<br> #####################################################################<br> cat &gt;&gt; /root/system/admin-token.yaml &lt;&lt;EOF<br> kind: ClusterRoleBinding<br> apiVersion: rbac.authorization.k8s.io/v1<br> metadata:<br>   name: admin<br>   annotations:<br>     rbac.authorization.kubernetes.io/autoupdate: "true"<br> roleRef:<br>   kind: ClusterRole<br>   name: cluster-admin<br>   apiGroup: rbac.authorization.k8s.io<br> subjects:<br>   - kind: ServiceAccount<br>     name: admin<br>     namespace: kube-system<br> ---<br> apiVersion: v1<br> kind: ServiceAccount<br> metadata:<br>   name: admin<br>   namespace: kube-system<br>   labels:<br>     kubernetes.io/cluster-service: "true"<br>     addonmanager.kubernetes.io/mode: Reconcile<br> EOF<br> kubectl create -f admin-token.yaml</p> 
<p>kubectl describe secret/$(kubectl get secret -n kube-system |grep admin|awk '{print $1}') -n kube-system<br> eyJhbGciOiJSUzI1NiIsImtpZCI6IjBJOFVzRkNJbzBQRnpZWkxCTmprd0Z3Zkk3TmNoZGtWZW9SNVctOGczU3MifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi12Yno4aiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjBhNWFiZjJmLTE0ZjUtNDZjZi04OGNmLWU0M2M4ZDg5NjJhNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.A2MIh4CKxxZaDctC35Ttl2N3qd1Kv8BbmPuJWLFn_-wwigJEmtztBELMEwAWqoyGsGYpL8LdM6V6E31pnhobALo7NvKOFhf-0o5v4NhsRf5egzefMdtSR01aEHVZX3fePFEV4kPB0OeYC2uzBONUvL5en08QiWHrGaf4cCG9RJZyOtFjqqWue7kdxgSXQRdCHoT7jBU3dXz0HVuQpynhmNgM3tWt5HjI9LLIUuvmUa1WbMFr-Zq1V47yYW_QRnha3_faLC3sqGZa98TyX0TukwaUAZanCl4amQOgThLmOA_NXTeQNEYQnwM1p3pUwPVkuz9jWVO-i9WoadKLKIYobQ<br> ########################################################################################################</p> 
<p>kubectl scale -n nginx3 deployment nginx3 --replicas=3</p> 
<p>#####################################################################<br> ### Deploy nginx ingress<br> #####################################################################<br> kubectl create deployment nginx1 --image=nginx:1.14.2<br> kubectl expose deployment nginx1 --port=80 --target-port=80  --type=NodePort</p> 
<p>kubectl create namespace nginx3<br> kubectl create deployment nginx3 --namespace=nginx3 --image=nginx:1.14.2<br> kubectl expose deployment nginx3 --namespace=nginx3 --port=80 --target-port=80  --type=NodePort</p> 
<p>kubectl create deployment nginx --image=tomcat<br> kubectl expose deployment tomcat --port=8080 --target-port=8080  --type=NodePort</p> 
<p><br> kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.3/deploy/static/provider/baremetal/deploy.yaml</p> 
<p>有三个地址要更换<br> registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.3<br> registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1</p> 
<p><br> ####################################################################<br> ### ingress rule 中需要补充一个ingressClassName，大概是从1.19开始的<br> ### 后续使用 ingress-controller的nodeport端口进行访问<br> ####################################################################<br> apiVersion: networking.k8s.io/v1<br> kind: Ingress<br> metadata:<br>   name: k8s-ingress<br> spec:<br>   ingressClassName: nginx<br>   rules:<br>   - host: etc.k8s.local<br>     http:<br>       paths:<br>       - path: /<br>         pathType: Prefix<br>         backend:<br>           service:<br>             name: nginx<br>             port:<br>               number: 80<br>   - host: test.k8s.local<br>     http:<br>       paths:<br>       - path: /<br>         pathType: Prefix<br>         backend:<br>           service:<br>             name: nginx2<br>             port:<br>               number: 80<br> ############################################################<br> kubectl create secret tls rankez-secret --cert=rankez.crt --key=rankez.key    </p> 
<p>############################################################################################<br> ### PV, PVC<br> #############<br> apiVersion: v1<br> kind: PersistentVolume<br> metadata:<br>   name: pv0001<br> spec:<br>   capacity:<br>     storage: 5Gi<br>   accessModes:<br>     - ReadWriteMany<br>   persistentVolumeReclaimPolicy: Retain<br>   nfs:<br>     path: "/data/test"<br>     server: 192.168.1.170</p> 
<p>apiVersion: v1<br> kind: PersistentVolumeClaim<br> apiVersion: v1<br> metadata:<br>   name: test-claim<br>   annotations:<br>     volume.beta.kubernetes.io/storage-class: "nfs" #此处必须beta<br> spec:<br>   accessModes:<br>     - ReadWriteMany<br>   resources:<br>     requests:<br>       storage: 1000Mi</p> 
<p><br> apiVersion: v1<br> kind: Pod<br> metadata:<br>   name: nfs-test<br> spec:<br>   containers:<br>     - name: my-busybox<br>       image: 192.168.1.220:5000/busybox<br>       volumeMounts:<br>       - mountPath: "/data"<br>         name: sample-volume<br>       command: ["sleep", "10000000"]<br>       imagePullPolicy: IfNotPresent<br>   volumes:<br>     - name: sample-volume<br>       persistentVolumeClaim:<br>         claimName: test-claim<br> ############################################################################################<br> Retain 之后删除PV中的spec.claimRef段落。可以恢复继续使用。所以不能轻易删除PVC。更不能删除PVC/PV<br> 需要  vi /etc/kubernetes/manifests/kube-apiserver.yaml<br> 添加一行，但是无需重启，apiserver会自动重启。如果不行，则delete pod</p> 
<p>--feature-gates=RemoveSelfLink=false<br> 权限，provisioner，pvc，pod</p> 
<p>############################################################################################<br> ### ConfigMap<br> ################################################################################################</p> 
<p>kubectl create configmap my-config --from-literal=firstname=shengping</p> 
<p>##################################################################################</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f8eaf3a20b87bd2e71aa109aaa1d84a3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">The benefits of using relational database instead of file-based approach (AS).</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3094a2e913eb424a22c33746c72bc586/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">带着问题看源码 —— BeanFactory和FactoryBean</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>