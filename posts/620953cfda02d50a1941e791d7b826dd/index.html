<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tensorflow-image classification - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Tensorflow-image classification" />
<meta property="og:description" content="参考：https://tensorflow.google.cn/tutorials/images/classification
Import packages import tensorflow as tf from tensorflow.keras.models import Sequential from tensorflow.keras.layers import Dense, Conv2D, Flatten, Dropout, MaxPooling2D from tensorflow.keras.preprocessing.image import ImageDataGenerator import os import numpy as np import matplotlib.pyplot as plt 数据下载 下载 _URL = &#39;https://storage.googleapis.com/mledu-datasets/cats_and_dogs_filtered.zip&#39; path_to_zip = tf.keras.utils.get_file(&#39;cats_and_dogs.zip&#39;, origin=_URL, extract=True) PATH = os.path.join(os.path.dirname(path_to_zip), &#39;cats_and_dogs_filtered&#39;) 导入 train_dir = os.path.join(PATH, &#39;train&#39;) validation_dir = os.path.join(PATH, &#39;validation&#39;) train_cats_dir = os.path.join(train_dir, &#39;cats&#39;) # directory with our training cat pictures train_dogs_dir = os." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/620953cfda02d50a1941e791d7b826dd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-07T09:19:18+08:00" />
<meta property="article:modified_time" content="2020-04-07T09:19:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Tensorflow-image classification</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>参考：https://tensorflow.google.cn/tutorials/images/classification</p> 
<h2><a id="Import_packages_1"></a>Import packages</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sequential
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense<span class="token punctuation">,</span> Conv2D<span class="token punctuation">,</span> Flatten<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> MaxPooling2D
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image <span class="token keyword">import</span> ImageDataGenerator

<span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
</code></pre> 
<h2><a id="_13"></a>数据下载</h2> 
<h3><a id="_14"></a>下载</h3> 
<pre><code class="prism language-python">_URL <span class="token operator">=</span> <span class="token string">'https://storage.googleapis.com/mledu-datasets/cats_and_dogs_filtered.zip'</span>

path_to_zip <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>get_file<span class="token punctuation">(</span><span class="token string">'cats_and_dogs.zip'</span><span class="token punctuation">,</span> origin<span class="token operator">=</span>_URL<span class="token punctuation">,</span> extract<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

PATH <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>path_to_zip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'cats_and_dogs_filtered'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_22"></a>导入</h3> 
<pre><code class="prism language-python">train_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>PATH<span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">)</span>
validation_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>PATH<span class="token punctuation">,</span> <span class="token string">'validation'</span><span class="token punctuation">)</span>

train_cats_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>train_dir<span class="token punctuation">,</span> <span class="token string">'cats'</span><span class="token punctuation">)</span>  <span class="token comment"># directory with our training cat pictures</span>
train_dogs_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>train_dir<span class="token punctuation">,</span> <span class="token string">'dogs'</span><span class="token punctuation">)</span>  <span class="token comment"># directory with our training dog pictures</span>
validation_cats_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>validation_dir<span class="token punctuation">,</span> <span class="token string">'cats'</span><span class="token punctuation">)</span>  <span class="token comment"># directory with our validation cat pictures</span>
validation_dogs_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>validation_dir<span class="token punctuation">,</span> <span class="token string">'dogs'</span><span class="token punctuation">)</span>  <span class="token comment"># directory with our validation dog pictures</span>
</code></pre> 
<h3><a id="_32"></a>查看数据</h3> 
<pre><code class="prism language-python">num_cats_tr <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>train_cats_dir<span class="token punctuation">)</span><span class="token punctuation">)</span>
num_dogs_tr <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>train_dogs_dir<span class="token punctuation">)</span><span class="token punctuation">)</span>

num_cats_val <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>validation_cats_dir<span class="token punctuation">)</span><span class="token punctuation">)</span>
num_dogs_val <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>validation_dogs_dir<span class="token punctuation">)</span><span class="token punctuation">)</span>

total_train <span class="token operator">=</span> num_cats_tr <span class="token operator">+</span> num_dogs_tr
total_val <span class="token operator">=</span> num_cats_val <span class="token operator">+</span> num_dogs_val


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'total training cat images:'</span><span class="token punctuation">,</span> num_cats_tr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'total training dog images:'</span><span class="token punctuation">,</span> num_dogs_tr<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'total validation cat images:'</span><span class="token punctuation">,</span> num_cats_val<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'total validation dog images:'</span><span class="token punctuation">,</span> num_dogs_val<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Total training images:"</span><span class="token punctuation">,</span> total_train<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Total validation images:"</span><span class="token punctuation">,</span> total_val<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_53"></a>设置常量</h2> 
<pre><code class="prism language-python">batch_size <span class="token operator">=</span> <span class="token number">128</span>
epochs <span class="token operator">=</span> <span class="token number">15</span>
IMG_HEIGHT <span class="token operator">=</span> <span class="token number">150</span>
IMG_WIDTH <span class="token operator">=</span> <span class="token number">150</span>
</code></pre> 
<h2><a id="_61"></a>数据预处理</h2> 
<h3><a id="ImageDataGenerator_62"></a>定义生成器ImageDataGenerator</h3> 
<pre><code class="prism language-python">train_image_generator <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token comment"># Generator for our training data</span>
validation_image_generator <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token comment"># Generator for our validation data</span>
</code></pre> 
<h3><a id="_67"></a>读取图片到生成器</h3> 
<pre><code class="prism language-python">train_data_gen <span class="token operator">=</span> train_image_generator<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                                           directory<span class="token operator">=</span>train_dir<span class="token punctuation">,</span>
                                                           shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                           target_size<span class="token operator">=</span><span class="token punctuation">(</span>IMG_HEIGHT<span class="token punctuation">,</span> IMG_WIDTH<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                           class_mode<span class="token operator">=</span><span class="token string">'binary'</span><span class="token punctuation">)</span>
<span class="token comment"># train_dir 为已定义的训练集图片存放目录</span>
val_data_gen <span class="token operator">=</span> validation_image_generator<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                                              directory<span class="token operator">=</span>validation_dir<span class="token punctuation">,</span>
                                                              target_size<span class="token operator">=</span><span class="token punctuation">(</span>IMG_HEIGHT<span class="token punctuation">,</span> IMG_WIDTH<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                              class_mode<span class="token operator">=</span><span class="token string">'binary'</span><span class="token punctuation">)</span>                                              
</code></pre> 
<h3><a id="_81"></a>显示读取的图片</h3> 
<pre><code class="prism language-python">sample_training_images<span class="token punctuation">,</span> _ <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>train_data_gen<span class="token punctuation">)</span>
</code></pre> 
<p>调用 <em>next()</em> 带入含有数据的生成器，会返回图片和标签两个值，这里只做图片的显示，所以所以之接收第一个数据。</p> 
<pre><code class="prism language-python"><span class="token comment"># This function will plot images in the form of a grid with 1 row and 5 columns where images are placed in each column.</span>
<span class="token keyword">def</span> <span class="token function">plotImages</span><span class="token punctuation">(</span>images_arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    axes <span class="token operator">=</span> axes<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> img<span class="token punctuation">,</span> ax <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span> images_arr<span class="token punctuation">,</span> axes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        ax<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>定义图片展示的函数</p> 
<pre><code class="prism language-python">plotImages<span class="token punctuation">(</span>sample_training_images<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_102"></a>创建模型</h2> 
<h3><a id="_103"></a>构建模型结构</h3> 
<pre><code class="prism language-python">model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">[</span>
    Conv2D<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span>IMG_HEIGHT<span class="token punctuation">,</span> IMG_WIDTH <span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Conv2D<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Dense<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Dense<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>该模型由三个卷积块组成，每个卷积块中都有一个最大池层。完全连接的层，有512个单元，由relu激活函数激活。</p> 
<h3><a id="_119"></a>模型编译</h3> 
<pre><code class="prism language-python">model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span><span class="token string">'adam'</span><span class="token punctuation">,</span>
              loss<span class="token operator">=</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>BinaryCrossentropy<span class="token punctuation">(</span>from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>选择ADAM优化器和二进制交叉熵损失函数。传入metrics参数，查看训练和验证的准确性。</p> 
<h3><a id="_128"></a>查看模型结构</h3> 
<pre><code class="prism language-python">model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_133"></a>训练模型</h3> 
<pre><code class="prism language-python">history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit_generator<span class="token punctuation">(</span>
    train_data_gen<span class="token punctuation">,</span>
    steps_per_epoch<span class="token operator">=</span>total_train <span class="token operator">//</span> batch_size<span class="token punctuation">,</span>
    epochs<span class="token operator">=</span>epochs<span class="token punctuation">,</span>
    validation_data<span class="token operator">=</span>val_data_gen<span class="token punctuation">,</span>
    validation_steps<span class="token operator">=</span>total_val <span class="token operator">//</span> batch_size
<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_144"></a>训练结果可视化</h3> 
<pre><code class="prism language-python">acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span>
val_acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_accuracy'</span><span class="token punctuation">]</span>

loss<span class="token operator">=</span>history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
val_loss<span class="token operator">=</span>history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span>

epochs_range <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> val_acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'lower right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Accuracy'</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> val_loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'upper right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_170"></a>解决过拟合</h2> 
<h3><a id="_171"></a>图像增强</h3> 
<ol><li>横向翻转</li></ol> 
<pre><code class="prism language-python"><span class="token comment">#定义</span>
image_gen <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> horizontal_flip<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment">#读入数据</span>
train_data_gen <span class="token operator">=</span> image_gen<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                               directory<span class="token operator">=</span>train_dir<span class="token punctuation">,</span>
                                               shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                               target_size<span class="token operator">=</span><span class="token punctuation">(</span>IMG_HEIGHT<span class="token punctuation">,</span> IMG_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>从训练示例中选取一个样本图像，重复五次，以便对同一图像进行五次增强。</p> 
<pre><code class="prism language-python">augmented_images <span class="token operator">=</span> <span class="token punctuation">[</span>train_data_gen<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># Re-use the same custom plotting function defined and used</span>
<span class="token comment"># above to visualize the training images</span>
plotImages<span class="token punctuation">(</span>augmented_images<span class="token punctuation">)</span>
</code></pre> 
<ol start="2"><li>随机旋转图像</li></ol> 
<pre><code class="prism language-python">image_gen <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> rotation_range<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">)</span>

train_data_gen <span class="token operator">=</span> image_gen<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>                            directory<span class="token operator">=</span>train_dir<span class="token punctuation">,</span>                                     shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                       target_size<span class="token operator">=</span><span class="token punctuation">(</span>IMG_HEIGHT<span class="token punctuation">,</span> IMG_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span>

augmented_images <span class="token operator">=</span> <span class="token punctuation">[</span>train_data_gen<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

plotImages<span class="token punctuation">(</span>augmented_images<span class="token punctuation">)</span>
</code></pre> 
<ol start="3"><li>应用放大增强</li></ol> 
<pre><code class="prism language-java"># zoom_range from <span class="token number">0</span> <span class="token operator">-</span> <span class="token number">1</span> where <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">.</span>
image_gen <span class="token operator">=</span> <span class="token function">ImageDataGenerator</span><span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> zoom_range<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span> # 

train_data_gen <span class="token operator">=</span> image_gen<span class="token punctuation">.</span><span class="token function">flow_from_directory</span><span class="token punctuation">(</span>batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>                        directory<span class="token operator">=</span>train_dir<span class="token punctuation">,</span>                                               shuffle<span class="token operator">=</span>True<span class="token punctuation">,</span>                                               target_size<span class="token operator">=</span><span class="token punctuation">(</span>IMG_HEIGHT<span class="token punctuation">,</span> IMG_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span>

augmented_images <span class="token operator">=</span> <span class="token punctuation">[</span>train_data_gen<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token function">plotImages</span><span class="token punctuation">(</span>augmented_images<span class="token punctuation">)</span>
</code></pre> 
<ol start="4"><li>综合应用</li></ol> 
<pre><code class="prism language-python">image_gen_train <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>
                    rescale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span>
                    rotation_range<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">,</span>
                    width_shift_range<span class="token operator">=</span><span class="token number">.15</span><span class="token punctuation">,</span>
                    height_shift_range<span class="token operator">=</span><span class="token number">.15</span><span class="token punctuation">,</span>
                    horizontal_flip<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                    zoom_range<span class="token operator">=</span><span class="token number">0.5</span>
                    <span class="token punctuation">)</span>

train_data_gen <span class="token operator">=</span> image_gen_train<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>                                                     directory<span class="token operator">=</span>train_dir<span class="token punctuation">,</span>                                                     shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                                                     target_size<span class="token operator">=</span><span class="token punctuation">(</span>IMG_HEIGHT<span class="token punctuation">,</span> IMG_WIDTH<span class="token punctuation">)</span><span class="token punctuation">,</span>                                                     class_mode<span class="token operator">=</span><span class="token string">'binary'</span><span class="token punctuation">)</span>
                     
augmented_images <span class="token operator">=</span> <span class="token punctuation">[</span>train_data_gen<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

plotImages<span class="token punctuation">(</span>augmented_images<span class="token punctuation">)</span>
                  
</code></pre> 
<h3><a id="Dropout_235"></a>Dropout</h3> 
<p>属于正则化的一种方法</p> 
<pre><code class="prism language-python">model_new <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">[</span>
    Conv2D<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span> 
           input_shape<span class="token operator">=</span><span class="token punctuation">(</span>IMG_HEIGHT<span class="token punctuation">,</span> IMG_WIDTH <span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Conv2D<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Dense<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Dense<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>应用dropout将随机设置20%的神经元为零。</p> 
<pre><code class="prism language-python"><span class="token comment">#编译</span>
model_new<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span><span class="token string">'adam'</span><span class="token punctuation">,</span>
                  loss<span class="token operator">=</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>BinaryCrossentropy<span class="token punctuation">(</span>from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

model_new<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#训练</span>
history <span class="token operator">=</span> model_new<span class="token punctuation">.</span>fit_generator<span class="token punctuation">(</span>
    train_data_gen<span class="token punctuation">,</span>
    steps_per_epoch<span class="token operator">=</span>total_train <span class="token operator">//</span> batch_size<span class="token punctuation">,</span>
    epochs<span class="token operator">=</span>epochs<span class="token punctuation">,</span>
    validation_data<span class="token operator">=</span>val_data_gen<span class="token punctuation">,</span>
    validation_steps<span class="token operator">=</span>total_val <span class="token operator">//</span> batch_size
<span class="token punctuation">)</span>

<span class="token comment"># 可视</span>
acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span>
val_acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_accuracy'</span><span class="token punctuation">]</span>

loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
val_loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span>

epochs_range <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> val_acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'lower right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Accuracy'</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> val_loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'upper right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c1a94cbb9e7f4fe16034cbd2cb8d8189/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">在vue项目中使用md5加密</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/09c62078be7f56cc3de8d30bb8d41c32/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mycat 添加数据时报错主键已存在(duplicate entry &#39;22&#39; for key &#39;PRIMARY&#39;)问题解决</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>