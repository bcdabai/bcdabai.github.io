<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>黑群晖(XPEnology)无法启动&amp;重建系统并保留数据经验总结 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="黑群晖(XPEnology)无法启动&amp;重建系统并保留数据经验总结" />
<meta property="og:description" content="预备知识 本篇所涉及到的技术主要涉及fdisk磁盘管理、mdadm软阵列管理与lvm逻辑卷管理，不熟悉这方便知识的朋友请先打开鸟叔的Linux私房菜学习下相关知识。 鸟哥Linux私房菜 - 磁盘配额、阵列、逻辑卷管理，点击这里打开；LVM逻辑卷管理相关命令 - 点击这里打开 防爬虫专用，作者的主要博客地址：点击这里, 全路径：blog.csdn.net/littlebrain4solving。
情况说明 由于不知什么情况导致/dev/md0阵列丢失(查看下面异常图片)，而里面的磁盘内容是装着群晖的系统，群晖SHR2原理会在每个物理硬盘上分区创建一个2G的分区组成RAID1(这样每个硬盘中都会存在一份拷贝的系统)，但我没找到更好的恢复方式，查了很多方式只有手动把/dev/md0进行了重建，然后再利用群晖的Synology Assistant进行系统重装，最后恢复了系统并且磁盘其他的数据也没有丢失，虽然系统之前的预设程序和用户设置丢失了，但是总算是恢复了系统并且保留了数据。
提示：我主要查看引导U盘的syslinux.cfg发现/dev/md0作为引导进入系统设备，具体可以打开你们的U盘查看APPEND参数内容，另外引导中有些LABEL可以自定义，并且我Google看有些人好像可以在引导中隐藏U盘设置（进行到系统中后）。
步骤说明 由于我有两块硬盘，所以群晖系统各分区了/dev/sda1与/dev/sdb1进行组RAID1，当然在某种情况下我是推测的(根据所查询的资料)，我就利用以下命令，针对这两块分区进行了RAID1阵列重建,mirror表示RAID1，有多少块硬盘的话也请根据命令调整--raid-devices数量，分区数与此选项一定要一致。
mdadm --create /dev/md0 --level=mirror --raid-devices=2 /dev/sda1 /dev/sdb1 注意：执行上述命令之前，请使用一个空闲的U盘烧一个Ubuntu的live/CD,或任意一个Debian变种的live/CD即可；因为群晖也是Debian的变种之一。
然后，重启电脑利用U盘的引导系统启动，选择第一个菜单，当加载完毕之后，再打开Synology Assistant自动检测到主机，然后右键Install,输入预设密码，顺着安装原来的*.PAT即可。
注意事项 在使用Ubuntu Live/CD的时候不会自动扫描加载已存在的阵列（重要数据设备内容），因为mdadm套件没有安装，所以需要先安装然后再手动扫描已存在的历史阵列信息，参考下面命令；另外注意的是所有最终的挂载设备都是由LVM2进行管理的。
apt-get install -y mdadm mdadm -Asf &amp;&amp; vgchange -ay lvs 为了确保数据没有丢失的话，可以利用LVM2相关的命令把设备挂载到某个目录中进行查看，参考下面挂载。
lvdisplay mkdir /volume1 mount /dev/vg_volume1/volume1 /volume1 ls /volume1 结论 当熟悉了群晖的磁盘管理的方式之后（其实我想就是和群晖的reset重置功能的逻辑类似），我想其实我们可以利用这一知识对系统进行升级处理（保留原始数据盘数据），我这里由于时间的关系就不做这样的测试了。
参考资料 https://www.ibm.com/developerworks/cn/linux/l-cn-raid2/index.html https://www.ibm.com/developerworks/cn/linux/l-cn-raid/index.html http://cn.linux.vbird.org/linux_basic/0420quota.php#raid_what http://www.cnblogs.com/hzl6255/p/3341374.html
SEO synology /sbin/e2fsck exists, checking /dev/md0… 1.42.6-5565: UNEXPECTED INCONSISTENCY; RUN fsck MANUALLY. /sbin/e2fsck returns 4, move into netowrk install… Checking upgrade file Killed" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1a61971703a0849a3503b807e8db644d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-09-24T14:59:07+08:00" />
<meta property="article:modified_time" content="2017-09-24T14:59:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">黑群晖(XPEnology)无法启动&amp;重建系统并保留数据经验总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2 id="预备知识">预备知识</h2> 
<p>本篇所涉及到的技术主要涉及<code>fdisk</code>磁盘管理、<code>mdadm</code>软阵列管理与<code>lvm</code>逻辑卷管理，不熟悉这方便知识的朋友请先打开鸟叔的Linux私房菜学习下相关知识。 </p> 
<ul><li>鸟哥Linux私房菜 - 磁盘配额、阵列、逻辑卷管理，<a href="http://cn.linux.vbird.org/linux_basic/0420quota.php#raid_what" rel="nofollow">点击这里打开</a>；</li><li>LVM逻辑卷管理相关命令 - <a href="http://blog.csdn.net/littlebrain4solving/article/details/75618415">点击这里打开</a></li></ul> 
<p><font size="1"><b>防爬虫专用，作者的主要博客地址：<a href="blog.csdn.net/littlebrain4solving" rel="nofollow">点击这里</a>, 全路径：blog.csdn.net/littlebrain4solving。</b></font></p> 
<h2 id="情况说明">情况说明</h2> 
<p>由于不知什么情况导致<code>/dev/md0</code>阵列丢失(查看下面异常图片)，而里面的磁盘内容是装着群晖的系统，群晖<code>SHR2</code>原理会在每个物理硬盘上分区创建一个<code>2G</code>的分区组成<code>RAID1</code>(这样每个硬盘中都会存在一份拷贝的系统)，但我没找到更好的恢复方式，查了很多方式只有手动把<code>/dev/md0</code>进行了重建，然后再利用群晖的<code>Synology Assistant</code>进行系统重装，最后恢复了系统并且磁盘其他的数据也没有丢失，虽然系统之前的预设程序和用户设置丢失了，但是总算是恢复了系统并且保留了数据。</p> 
<blockquote> 
 <p>提示：我主要查看引导U盘的<code>syslinux.cfg</code>发现<code>/dev/md0</code>作为引导进入系统设备，具体可以打开你们的U盘查看<code>APPEND</code>参数内容，另外引导中有些<code>LABEL</code>可以自定义，并且我Google看有些人好像可以在引导中隐藏U盘设置（进行到系统中后）。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/1c/13/ovOnhyve_o.jpg" alt="images" title=""></p> 
<h2 id="步骤说明">步骤说明</h2> 
<p>由于我有两块硬盘，所以群晖系统各分区了<code>/dev/sda1</code>与<code>/dev/sdb1</code>进行组<code>RAID1</code>，当然在某种情况下我是推测的(根据所查询的资料)，我就利用以下命令，针对这两块分区进行了<code>RAID1</code>阵列重建,<code>mirror</code>表示<code>RAID1</code>，有多少块硬盘的话也请根据命令调整<code>--raid-devices</code>数量，分区数与此选项一定要一致。</p> 
<pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">mdadm</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">create</span> <span class="hljs-comment">/dev/md0</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">level=mirror</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">raid</span><span class="hljs-literal">-</span><span class="hljs-comment">devices=2</span> <span class="hljs-comment">/dev/sda1</span> <span class="hljs-comment">/dev/sdb1</span></code></pre> 
<blockquote> 
 <p>注意：执行上述命令之前，请使用一个空闲的U盘烧一个<code>Ubuntu</code>的<code>live/CD</code>,或任意一个<code>Debian</code>变种的<code>live/CD</code>即可；因为群晖也是<code>Debian</code>的变种之一。</p> 
</blockquote> 
<p>然后，重启电脑利用U盘的引导系统启动，选择第一个菜单，当加载完毕之后，再打开<code>Synology Assistant</code>自动检测到主机，然后右键<code>Install</code>,输入预设密码，顺着安装原来的<code>*.PAT</code>即可。</p> 
<h2 id="注意事项">注意事项</h2> 
<p>在使用<code>Ubuntu Live/CD</code>的时候不会自动扫描加载已存在的阵列（重要数据设备内容），因为<code>mdadm</code>套件没有安装，所以需要先安装然后再手动扫描已存在的历史阵列信息，参考下面命令；另外注意的是所有最终的挂载设备都是由<code>LVM2</code>进行管理的。</p> 
<pre class="prettyprint"><code class=" hljs lasso">apt<span class="hljs-attribute">-get</span> install <span class="hljs-attribute">-y</span> mdadm
mdadm <span class="hljs-attribute">-Asf</span> <span class="hljs-subst">&amp;&amp;</span> vgchange <span class="hljs-attribute">-ay</span>
lvs</code></pre> 
<p>为了确保数据没有丢失的话，可以利用<code>LVM2</code>相关的命令把设备挂载到某个目录中进行查看，参考下面挂载。</p> 
<pre class="prettyprint"><code class=" hljs perl">lvdisplay
<span class="hljs-keyword">mkdir</span> /volume1
mount /dev/vg_volume1/volume1 /volume1
ls /volume1</code></pre> 
<h2 id="结论">结论</h2> 
<p>当熟悉了群晖的磁盘管理的方式之后（其实我想就是和群晖的<code>reset</code>重置功能的逻辑类似），我想其实我们可以利用这一知识对系统进行升级处理（保留原始数据盘数据），我这里由于时间的关系就不做这样的测试了。</p> 
<h2 id="参考资料">参考资料</h2> 
<p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-raid2/index.html" rel="nofollow noopener noreferrer" target="_blank">https://www.ibm.com/developerworks/cn/linux/l-cn-raid2/index.html</a> <br> <a href="https://www.ibm.com/developerworks/cn/linux/l-cn-raid/index.html" rel="nofollow noopener noreferrer" target="_blank">https://www.ibm.com/developerworks/cn/linux/l-cn-raid/index.html</a> <br> <a href="http://cn.linux.vbird.org/linux_basic/0420quota.php#raid_what" rel="nofollow noopener noreferrer" target="_blank">http://cn.linux.vbird.org/linux_basic/0420quota.php#raid_what</a> <br> <a href="http://www.cnblogs.com/hzl6255/p/3341374.html" rel="nofollow noopener noreferrer" target="_blank">http://www.cnblogs.com/hzl6255/p/3341374.html</a></p> 
<h2 id="seo">SEO</h2> 
<p>synology /sbin/e2fsck exists, checking /dev/md0… <br> 1.42.6-5565: UNEXPECTED INCONSISTENCY; RUN fsck MANUALLY. <br> /sbin/e2fsck returns 4, move into netowrk install… <br> Checking upgrade file <br> Killed</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6de14d7e1e2acf4df991510f477422eb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux下权限问题：chmod -R 777 /usr</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/54f00dbe1329840eaf9f1986c1ba8bce/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Thinkpad 各系列简介</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>