<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C&#43;&#43;调用matlab编译的动态链接库dll - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C&#43;&#43;调用matlab编译的动态链接库dll" />
<meta property="og:description" content="Matlab在语法上具有诸多的便利性，可以把matlab的代码（.m文件)为动态链接库dll，之后在c&#43;&#43;中调用。本文讲解如何操作以及一些细节。
测试环境： 操作系统：windows10C&#43;&#43;：visual studio 2017Matlab版本：Matlab R2020b Matlab代码编译dll 第一步：编写matlab代码。这里以计算标量与向量的乘积为例。选用该实例的原因是为了演示C&#43;&#43;调用matlab的函数时如何返回数组。
function [c]=example(a,v) %v为一个向量 %a为double %函数返回标量与向量的乘积 num=length(v); c=zeros(1,num); for i=1:num c(i)=a*v(i); end end 第二步：配置编译环境。在matlab的命令行窗口中输入mbuild -setup，matlab会自动搜索系统安装的vs编译环境。点击其中的Microsoft Visual C&#43;&#43; 2017 (C) 和mex -setup C&#43;&#43; -client MBUILD 配置好环境。
&gt;&gt; mbuild -setup MBUILD 配置为使用 &#39;Microsoft Visual C&#43;&#43; 2017 (C)&#39; 以进行 C 语言编译。 要选择不同的 C 编译器，请从以下选项中选择一种命令: Microsoft Visual C&#43;&#43; 2017 (C) mex -setup:C:\Users\wanyz\AppData\Roaming\MathWorks\MATLAB\R2020b\MBUILD_C_win64.xml C -client MBUILD Microsoft Visual C&#43;&#43; 2019 (C) mex -setup:&#39;C:\Program Files\Polyspace\R2020b\bin\win64\mexopts\msvc2019.xml&#39; C -client MBUILD 要选择不同的语言，请从以下选项中选择一种命令: mex -setup C&#43;&#43; -client MBUILD mex -setup FORTRAN -client MBUILD 第三步: 编译matlab的代码为动态链接库。在matlab的命令行窗口中输入deploytool命令，打开matlab compiler，选择Library Compiler。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c622b5a4a4c006ace00d7c3efb9dc1fd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-16T23:36:57+08:00" />
<meta property="article:modified_time" content="2023-08-16T23:36:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C&#43;&#43;调用matlab编译的动态链接库dll</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>Matlab在语法上具有诸多的便利性，可以把matlab的代码（.m文件)为动态链接库dll，之后在c++中调用。本文讲解如何操作以及一些细节。</p> 
<h2>测试环境：</h2> 
<ul><li>操作系统：windows10</li><li>C++：visual studio 2017</li><li>Matlab版本：Matlab R2020b</li></ul> 
<h2>Matlab代码编译dll</h2> 
<p>第一步：编写matlab代码。这里以计算标量与向量的乘积为例。选用该实例的原因是为了演示C++调用matlab的函数时如何返回数组。</p> 
<pre><code class="language-Matlab">function [c]=example(a,v)
%v为一个向量
%a为double
%函数返回标量与向量的乘积
num=length(v);
c=zeros(1,num);
   for i=1:num
     c(i)=a*v(i);  
   end
end</code></pre> 
<p>第二步：配置编译环境。在matlab的命令行窗口中输入mbuild -setup，matlab会自动搜索系统安装的vs编译环境。点击其中的Microsoft Visual C++ 2017 (C) 和mex -setup C++ -client MBUILD 配置好环境。</p> 
<pre><code class="hljs">&gt;&gt; mbuild -setup
MBUILD 配置为使用 'Microsoft Visual C++ 2017 (C)' 以进行 C 语言编译。

要选择不同的 C 编译器，请从以下选项中选择一种命令:
Microsoft Visual C++ 2017 (C)  mex -setup:C:\Users\wanyz\AppData\Roaming\MathWorks\MATLAB\R2020b\MBUILD_C_win64.xml C -client MBUILD
Microsoft Visual C++ 2019 (C)  mex -setup:'C:\Program Files\Polyspace\R2020b\bin\win64\mexopts\msvc2019.xml' C -client MBUILD

要选择不同的语言，请从以下选项中选择一种命令:
 mex -setup C++ -client MBUILD 
 mex -setup FORTRAN -client MBUILD</code></pre> 
<p>第三步: 编译matlab的代码为动态链接库。在matlab的命令行窗口中输入deploytool命令，打开matlab compiler，选择Library Compiler。</p> 
<p><img alt="" height="426" src="https://images2.imgbox.com/25/14/dXWCNceN_o.png" width="816"></p> 
<p>在弹出的窗口的TYPE中选中C++Shared Library，在EXPORTED FUNCTIONS中选中写好的example.m文件，接着点击Package按钮。注意一定要选中example.m文件。</p> 
<p><img alt="" height="678" src="https://images2.imgbox.com/23/a0/kZOXgI1r_o.png" width="1200"></p> 
<p> </p> 
<p>如果没有错误，将打包成功。硬盘上将生成三个文件夹：for_redistribution、for_redistribution_files_only和for_testing。其中for_redistribution_files_only是需要使用的文件，包含编译好的lib文件、h文件和dll文件，即example.h、example.lib和example.dll。</p> 
<p><img alt="" height="291" src="https://images2.imgbox.com/22/dc/gXX7MQIb_o.png" width="360"><img alt="" height="147" src="https://images2.imgbox.com/29/27/rrq5Z5mp_o.png" width="311"></p> 
<p> </p> 
<h2>C++调用matlab的dll</h2> 
<p>第一步：新建C++的控制台程序，选择64位解决方案，配置好包含文件和库文件的路径。</p> 
<ul><li>包含目录：C:\Program Files\Polyspace\R2020b\extern\include; ../../for_redistribution_files_only</li><li>库目录：C:\Program Files\Polyspace\R2020b\extern\lib\win64\microsoft;../../for_redistribution_files_only</li></ul> 
<p>第二步：链接器-&gt;输入-&gt;附加依赖项，添加如下库文件：example.lib和mclmcrrt.lib</p> 
<p>第三步：编写C++调用代码。我们打开生成的example.h文件看看接口函数：</p> 
<pre><code class="language-cpp">extern LIB_example_CPP_API void MW_CALL_CONV example(int nargout, mwArray&amp; c, const mwArray&amp; a, const mwArray&amp; v);</code></pre> 
<p> 从上述接口函数我们可以看出：</p> 
<ul><li>函数返回的是void，跟我们matlab定义的返回数组不同</li><li>函数的参数比我们原matlab代码多了两个，即第一个int nargout和mwArray&amp; c。此处的mwArray是一个c++的类，可以理解为数组。多了的这两个参数即是定义函数的返回值。其中mwArray&amp; c是引用的方式传递的，即外部传入的值在函数内部会修改。int nargout则表示返回值的个数。注意该个数不是mwArray&amp; c这个数组的大小，而是表示返回多少值。由于matlab的函数可以返回多个值，而C++的函数只能返回一个值，所以经过转换以后，会将所有的返回值都引用参数的方式放在函数中，int nargout即表示原始matlab代码返回多少个值。</li><li>原始matlab代码中的参数全部边为了mwArray类型</li></ul> 
<p>代码运行的顺序：</p> 
<ul><li>第一步：调用mclInitializeApplication进行程序初始化。</li><li>第二步：调用exampleInitialize进行初始化。此处的函数名根据前边命名不同而不同</li><li>第三步：调用dll中的函数进行计算，保存返回的结果</li><li>第四步：调用mclTerminateApplication函数终止程序</li></ul> 
<p>按照上述逻辑，调用代码如下：</p> 
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include "example.h"
int main()
{
	//初始化
	if (!mclInitializeApplication(NULL, 0))//程序初始化
	{
		std::cout &lt;&lt; "failed" &lt;&lt; std::endl;
		return -1;
	}	
	exampleInitialize();//函数初始化

	//创建输入参数
	mwArray a(1, 1, mxDOUBLE_CLASS);//创建1*1的double型数组，作为函数的第三个参数（原matlab代码的第一个参数）
	a(1, 1) = 2;
	mwArray v(1, 2, mxDOUBLE_CLASS);//创建1*2的double型数组，作为函数的第四个参数（原matlab代码的第二个参数）
	double v_c[] = { 1,2 };
	v.SetData(v_c, 1*2);//使用SetData为数组赋值，第二个参数为数组的元素个数，即1*2

	mwArray c(1, 2, mxDOUBLE_CLASS);//创建1*2的double数组，作为函数的第二个参数（原matlab代码的返回值）
	int nargout = 1;//定义返回值的个数，原matlab代码只返回一个值，这里设置为1

	//调用dll中的函数计算
	example(nargout, c, a, v);
	//输出计算结果。计算结果保存在c中，注意数组与matlab一样从1开始
	std::cout &lt;&lt; "Result = (" &lt;&lt; c(1, 1) &lt;&lt; "," &lt;&lt; c(1, 2) &lt;&lt; ")" &lt;&lt; std::endl;

	//终止程序
	mclTerminateApplication();
}
</code></pre> 
<p> 上述代码计算标量2与向量(1,2)的乘积，计算结果如下：</p> 
<p><img alt="" height="72" src="https://images2.imgbox.com/cc/a9/W9tmqIpK_o.png" width="340"></p> 
<p> 以上即是使用c++调用maltab动态库中函数的方法。</p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b860b3d5741dc930a442a92d72e28147/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java内存区域（运行时数据区域）和内存模型（JMM）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/787383781a7178bf027b95c5a67679ea/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CS使用&#43;后渗透</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>