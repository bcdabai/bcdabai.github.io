<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>squid正向代理（传统代理与透明代理）的配置、ACL访问控制与日志分析工具sarg的使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="squid正向代理（传统代理与透明代理）的配置、ACL访问控制与日志分析工具sarg的使用" />
<meta property="og:description" content="squid正向代理（传统代理与透明代理）的配置、ACL访问控制与日志分析工具sarg的使用 一：squid代理服务概述二：传统代理的配置2.1：实验环境介绍2.2：实验步骤2.2.1：在squid服务器上安装squid服务2.2.2：优化执行路径2.2.3：更改权限2.2.4：修改配置文件、添加缓存用户与组2.2.5：检查配置文件的语法2.2.6：初始化缓存目录2.2.7：启动squid服务2.2.8：编写squid的启动脚本2.2.9：配置传统代理服务2.2.10：客户端配置2.2.11：在web服务器上安装http服务2.2.12：客户端访问web站点，查看web服务器的访问日志 三：透明代理的配置3.1：实验环境介绍3.2：实验拓扑3.3：实验步骤3.3.1：squid代理服务上增加一块网卡3.3.2：squid服务器开启路由转发功能3.3.4：透明代理配置3.3.5：设置防火墙规则3.3.6：客户端验证3.3.7：查看web站点的访问日志 四：ACL访问控制4.1：acl访问控制方式4.2：acl访问控制类型4.3：acl规则的优先级 五：日志分析工具sarg5.1：在squid服务器上部署sarg5.2：修改sarg的配置文件5.3：添加不计入站点文件，添加的域名将不被显示在排序中5.4：开启sarg5.5：安装、启动http5.6：查看sarg的统计日志5.7：执行周期性计划任务，每天生成报告 一：squid代理服务概述 Squid是一个高性能的代理缓存服务器，Squid支持FTP、gopher、HTTPS和HTTP协议。和一般的代理缓存软件不同，Squid用一个单独的、非模块化的、I/O驱动的进程来处理所有的客户端请求。
工作机制
Squid是一种用来缓冲Internet数据的软件。它是这样实现其功能的，接受来自人们需要下载的目标（object）的请求并适当地处理这些请求。也就是说，如果一个人想下载一web页面，他请求Squid为他取得这个页面。Squid随之连接到远程服务器（比如：www.163.com）并向这个页面发出请求。然后，Squid显式地聚集数据到客户端机器，而且同时复制一份。当下一次有人需要同一页面时，Squid可以简单地从磁盘中读到它，那样数据迅即就会传输到客户机上。正向代理的基本类型
传统代理：普通的代理服务，适用于Internet，需明确指定服务端
透明代理：客户机不需要指定代理服务器的地址和端口，是通过默认路由，防火墙将web重定向给代理使用代理的好处
提高web访问速度
隐藏客户机的真实IP地址 二：传统代理的配置 2.1：实验环境介绍 VMware软件
一台centos7虚拟机作为squid服务器，IP地址为：192.168.209.145
一台centos7虚拟机作为web服务器，IP地址为：192.168.209.146
一台win10虚拟机作为client测试机，IP地址为：192.168.209.128
2.2：实验步骤 2.2.1：在squid服务器上安装squid服务 [root@squid ~]# yum install gcc gcc-c&#43;&#43; -y [root@squid ~]# ls anaconda-ks.cfg initial-setup-ks.cfg squid-3.4.6.tar.gz 公共 模板 视频 图片 文档 下载 音乐 桌面 [root@squid ~]# tar zxvf squid-3.4.6.tar.gz [root@squid ~]# cd squid-3.4.6/ [root@squid squid-3.4.6]# ./configure \ &gt; --prefix=/usr/local/squid \ //安装路径 &gt; --sysconfdir=/etc \ //配置文件目录 &gt; --enable-arp-acl \ //支持acl访问控制 &gt; --enable-linux-netfilter \ //支持网络筛选 &gt; --enable-linux-tproxy \ //支持透明代理 &gt; --enable-async-io=100 \ //io优化 &gt; --enable-err-language=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a66eb21b75932346a73c9965c986c76c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-10T11:15:59+08:00" />
<meta property="article:modified_time" content="2020-09-10T11:15:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">squid正向代理（传统代理与透明代理）的配置、ACL访问控制与日志分析工具sarg的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>squid正向代理（传统代理与透明代理）的配置、ACL访问控制与日志分析工具sarg的使用</h4> 
 <ul><li><a href="#squid_1" rel="nofollow">一：squid代理服务概述</a></li><li><a href="#_12" rel="nofollow">二：传统代理的配置</a></li><li><ul><li><a href="#21_13" rel="nofollow">2.1：实验环境介绍</a></li><li><a href="#22_18" rel="nofollow">2.2：实验步骤</a></li><li><ul><li><a href="#221squidsquid_19" rel="nofollow">2.2.1：在squid服务器上安装squid服务</a></li><li><a href="#222_40" rel="nofollow">2.2.2：优化执行路径</a></li><li><a href="#223_45" rel="nofollow">2.2.3：更改权限</a></li><li><a href="#224_51" rel="nofollow">2.2.4：修改配置文件、添加缓存用户与组</a></li><li><a href="#225_62" rel="nofollow">2.2.5：检查配置文件的语法</a></li><li><a href="#226_67" rel="nofollow">2.2.6：初始化缓存目录</a></li><li><a href="#227squid_72" rel="nofollow">2.2.7：启动squid服务</a></li><li><a href="#228squid_77" rel="nofollow">2.2.8：编写squid的启动脚本</a></li><li><a href="#229_130" rel="nofollow">2.2.9：配置传统代理服务</a></li><li><a href="#2210_146" rel="nofollow">2.2.10：客户端配置</a></li><li><a href="#2211webhttp_150" rel="nofollow">2.2.11：在web服务器上安装http服务</a></li><li><a href="#2212webweb_158" rel="nofollow">2.2.12：客户端访问web站点，查看web服务器的访问日志</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_171" rel="nofollow">三：透明代理的配置</a></li><li><ul><li><a href="#31_172" rel="nofollow">3.1：实验环境介绍</a></li><li><a href="#32_180" rel="nofollow">3.2：实验拓扑</a></li><li><a href="#33_182" rel="nofollow">3.3：实验步骤</a></li><li><ul><li><a href="#331squid_183" rel="nofollow">3.3.1：squid代理服务上增加一块网卡</a></li><li><a href="#332squid_206" rel="nofollow">3.3.2：squid服务器开启路由转发功能</a></li><li><a href="#334_214" rel="nofollow">3.3.4：透明代理配置</a></li><li><a href="#335_222" rel="nofollow">3.3.5：设置防火墙规则</a></li><li><a href="#336_231" rel="nofollow">3.3.6：客户端验证</a></li><li><a href="#337web_234" rel="nofollow">3.3.7：查看web站点的访问日志</a></li></ul> 
  </li></ul> 
  </li><li><a href="#ACL_243" rel="nofollow">四：ACL访问控制</a></li><li><ul><li><a href="#41acl_244" rel="nofollow">4.1：acl访问控制方式</a></li><li><a href="#42acl_253" rel="nofollow">4.2：acl访问控制类型</a></li><li><a href="#43acl_264" rel="nofollow">4.3：acl规则的优先级</a></li></ul> 
  </li><li><a href="#sarg_268" rel="nofollow">五：日志分析工具sarg</a></li><li><ul><li><a href="#51squidsarg_269" rel="nofollow">5.1：在squid服务器上部署sarg</a></li><li><a href="#52sarg_286" rel="nofollow">5.2：修改sarg的配置文件</a></li><li><a href="#53_306" rel="nofollow">5.3：添加不计入站点文件，添加的域名将不被显示在排序中</a></li><li><a href="#54sarg_311" rel="nofollow">5.4：开启sarg</a></li><li><a href="#55http_317" rel="nofollow">5.5：安装、启动http</a></li><li><a href="#56sarg_323" rel="nofollow">5.6：查看sarg的统计日志</a></li><li><a href="#57_326" rel="nofollow">5.7：执行周期性计划任务，每天生成报告</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="squid_1"></a>一：squid代理服务概述</h2> 
<p>Squid是一个高性能的代理缓存服务器，Squid支持FTP、gopher、HTTPS和HTTP协议。和一般的代理缓存软件不同，Squid用一个单独的、非模块化的、I/O驱动的进程来处理所有的客户端请求。</p> 
<ul><li>工作机制<br> <img src="https://images2.imgbox.com/71/e6/jUG1ov1Q_o.png" alt="在这里插入图片描述"><br> Squid是一种用来缓冲Internet数据的软件。它是这样实现其功能的，接受来自人们需要下载的目标（object）的请求并适当地处理这些请求。也就是说，如果一个人想下载一web页面，他请求Squid为他取得这个页面。Squid随之连接到远程服务器（比如：www.163.com）并向这个页面发出请求。然后，Squid显式地聚集数据到客户端机器，而且同时复制一份。当下一次有人需要同一页面时，Squid可以简单地从磁盘中读到它，那样数据迅即就会传输到客户机上。</li><li>正向代理的基本类型<br> 传统代理：普通的代理服务，适用于Internet，需明确指定服务端<br> 透明代理：客户机不需要指定代理服务器的地址和端口，是通过默认路由，防火墙将web重定向给代理</li><li>使用代理的好处<br> 提高web访问速度<br> 隐藏客户机的真实IP地址</li></ul> 
<h2><a id="_12"></a>二：传统代理的配置</h2> 
<h3><a id="21_13"></a>2.1：实验环境介绍</h3> 
<p>VMware软件<br> 一台centos7虚拟机作为squid服务器，IP地址为：192.168.209.145<br> 一台centos7虚拟机作为web服务器，IP地址为：192.168.209.146<br> 一台win10虚拟机作为client测试机，IP地址为：192.168.209.128</p> 
<h3><a id="22_18"></a>2.2：实验步骤</h3> 
<h4><a id="221squidsquid_19"></a>2.2.1：在squid服务器上安装squid服务</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid ~<span class="token punctuation">]</span><span class="token comment"># yum install gcc gcc-c++ -y</span>
<span class="token punctuation">[</span>root@squid ~<span class="token punctuation">]</span><span class="token comment"># ls</span>
anaconda-ks.cfg  initial-setup-ks.cfg  squid-3.4.6.tar.gz  公共  模板  视频  图片  文档  下载  音乐  桌面
<span class="token punctuation">[</span>root@squid ~<span class="token punctuation">]</span><span class="token comment"># tar zxvf squid-3.4.6.tar.gz </span>
<span class="token punctuation">[</span>root@squid ~<span class="token punctuation">]</span><span class="token comment"># cd squid-3.4.6/</span>
<span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># ./configure \</span>
<span class="token operator">&gt;</span> --prefix<span class="token operator">=</span>/usr/local/squid \  //安装路径
<span class="token operator">&gt;</span> --sysconfdir<span class="token operator">=</span>/etc \    //配置文件目录
<span class="token operator">&gt;</span> --enable-arp-acl \     //支持acl访问控制
<span class="token operator">&gt;</span> --enable-linux-netfilter \    //支持网络筛选
<span class="token operator">&gt;</span> --enable-linux-tproxy \      //支持透明代理
<span class="token operator">&gt;</span> --enable-async-io<span class="token operator">=</span>100 \      //io优化
<span class="token operator">&gt;</span> --enable-err-language<span class="token operator">=</span><span class="token string">"Simplify_Chinese"</span> \  //设置报错语言
<span class="token operator">&gt;</span> --enable-underscore \
<span class="token operator">&gt;</span> --enable-poll \    //IO流事件模型
<span class="token operator">&gt;</span> --enable-gnuregex   //支持正则
<span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
</code></pre> 
<h4><a id="222_40"></a>2.2.2：优化执行路径</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># ln -s /usr/local/squid/sbin/* /usr/local/sbin/</span>
</code></pre> 
<h4><a id="223_45"></a>2.2.3：更改权限</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># useradd -M -s /sbin/nologin squid</span>
<span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># chown -R squid:squid /usr/local/squid/var/</span>
</code></pre> 
<h4><a id="224_51"></a>2.2.4：修改配置文件、添加缓存用户与组</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># vim /etc/squid.conf</span>
<span class="token punctuation">..</span>.
<span class="token comment"># Squid normally listens to port 3128</span>
http_port 3128
cache_effective_user squid   //缓存用户
cache_effective_group squid  //缓存组
<span class="token punctuation">..</span>.
</code></pre> 
<h4><a id="225_62"></a>2.2.5：检查配置文件的语法</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># squid -k parse</span>
</code></pre> 
<h4><a id="226_67"></a>2.2.6：初始化缓存目录</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># squid -z</span>
</code></pre> 
<h4><a id="227squid_72"></a>2.2.7：启动squid服务</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># squid</span>
</code></pre> 
<h4><a id="228squid_77"></a>2.2.8：编写squid的启动脚本</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># vim /etc/init.d/squid</span>
<span class="token comment">#!/bin/bash</span>
<span class="token comment">#chkconfig: 2345 90 25</span>
PID<span class="token operator">=</span><span class="token string">"/usr/local/squid/var/run/squid.pid"</span>
CONF<span class="token operator">=</span><span class="token string">"/etc/squid.conf"</span>
CMD<span class="token operator">=</span><span class="token string">"/usr/local/squid/sbin/squid"</span>

<span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span>
start<span class="token punctuation">)</span>
        <span class="token function">netstat</span> -natp <span class="token operator">|</span> <span class="token function">grep</span> squid <span class="token operator">&amp;</span><span class="token operator">&gt;</span> /dev/null
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span>
        <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">"squid is running"</span>
        <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">"正在启动 squid...."</span>
        <span class="token variable">$CMD</span>
        <span class="token keyword">fi</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
stop<span class="token punctuation">)</span>
         <span class="token variable">$CMD</span> -k <span class="token function">kill</span> <span class="token operator">&amp;</span><span class="token operator">&gt;</span> /dev/null
        <span class="token function">rm</span> -rf <span class="token variable">$PID</span> <span class="token operator">&amp;</span><span class="token operator">&gt;</span> /dev/null
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
status<span class="token punctuation">)</span>
        <span class="token punctuation">[</span> -f <span class="token variable">$PID</span> <span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token operator">&gt;</span> /dev/null
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span>
        <span class="token keyword">then</span>
                <span class="token function">netstat</span> -natp <span class="token operator">|</span> <span class="token function">grep</span> squid
        <span class="token keyword">else</span>
                <span class="token keyword">echo</span> <span class="token string">"squid is not running"</span>
        <span class="token keyword">fi</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
restart<span class="token punctuation">)</span>
        <span class="token variable">$0</span> stop <span class="token operator">&amp;</span><span class="token operator">&gt;</span>  /dev/null
        <span class="token keyword">echo</span> <span class="token string">"正在关闭 squid...."</span>
        <span class="token variable">$0</span> start  <span class="token operator">&amp;</span><span class="token operator">&gt;</span> /dev/null
        <span class="token keyword">echo</span> <span class="token string">"正在启动 squid..."</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
reload<span class="token punctuation">)</span>
        <span class="token variable">$CMD</span> -k reconfigure
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
check<span class="token punctuation">)</span>
        <span class="token variable">$CMD</span> -k parse
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
*<span class="token punctuation">)</span>
        <span class="token keyword">echo</span> <span class="token string">"用法：<span class="token variable">$0</span>{start|stop|status|reload|check|restart}"</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
esac
<span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># chmod +x /etc/init.d/squid</span>
<span class="token punctuation">[</span>root@squid squid-3.4.6<span class="token punctuation">]</span><span class="token comment"># chkconfig --add squid</span>
</code></pre> 
<h4><a id="229_130"></a>2.2.9：配置传统代理服务</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/squid.conf</span>
http_port 3128
cache_effective_user squid
cache_effective_group squid
cache_mem 64 MB	<span class="token string">'//自定义缓存空间大小，容量最好为4的倍数'</span>
reply_body_max_size 10 MB	<span class="token string">'//允许下载最大文件大小，以字节为单位，默认设置0表示不进行限制'</span>
maximum_object_size 4096 KB	<span class="token string">'//允许保存到缓存空间的最大对象的大小，以KB为单位，超过限制不会缓存，直接转到web端'</span>
<span class="token punctuation">[</span>root@squid init.d<span class="token punctuation">]</span><span class="token comment"># iptables -F	'//清空防火墙表内容'</span>
<span class="token punctuation">[</span>root@squid init.d<span class="token punctuation">]</span><span class="token comment"># iptables -L	'//查看防火墙表内容'</span>
<span class="token punctuation">[</span>root@squid init.d<span class="token punctuation">]</span><span class="token comment"># setenforce 0	'//关闭防火墙增强型功能'</span>
<span class="token punctuation">[</span>root@squid init.d<span class="token punctuation">]</span><span class="token comment"># iptables -I INPUT -p tcp --dport 3128 -j ACCEPT	'//新增规则，允许3128端口'</span>
<span class="token punctuation">[</span>root@squid init.d<span class="token punctuation">]</span><span class="token comment"># service squid reload	'//重载服务'</span>
</code></pre> 
<h4><a id="2210_146"></a>2.2.10：客户端配置</h4> 
<p>需开启游览器的代理功能<br> <img src="https://images2.imgbox.com/b2/88/dVGMNmIA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/02/60/muhtJWWO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2211webhttp_150"></a>2.2.11：在web服务器上安装http服务</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@web ~<span class="token punctuation">]</span><span class="token comment"># yum install httpd -y	'//安装httpd服务'</span>
<span class="token punctuation">[</span>root@web ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld.service 	'//关闭防火墙'</span>
<span class="token punctuation">[</span>root@web ~<span class="token punctuation">]</span><span class="token comment"># setenforce 0</span>
<span class="token punctuation">[</span>root@web ~<span class="token punctuation">]</span><span class="token comment"># systemctl start httpd.service 	'//开启httpd服务'</span>
</code></pre> 
<h4><a id="2212webweb_158"></a>2.2.12：客户端访问web站点，查看web服务器的访问日志</h4> 
<p><img src="https://images2.imgbox.com/cf/85/YCHqWHxr_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@web ~<span class="token punctuation">]</span><span class="token comment"># cd /var/log/httpd/</span>
<span class="token punctuation">[</span>root@localhost httpd<span class="token punctuation">]</span><span class="token comment"># ls</span>
access_log  error_log
<span class="token punctuation">[</span>root@localhost httpd<span class="token punctuation">]</span><span class="token comment"># cat access_log </span>
<span class="token punctuation">..</span>.
192.168.209.145 - - <span class="token punctuation">[</span>09/Sep/2020:10:15:46 +0800<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> 403 4897 <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36"</span>
<span class="token punctuation">..</span>.
</code></pre> 
<p>源地址显示的是代理服务器的地址，配置成功！</p> 
<h2><a id="_171"></a>三：透明代理的配置</h2> 
<h3><a id="31_172"></a>3.1：实验环境介绍</h3> 
<p>透明代理提供的服务功能与传统代理是一致的，但是其“透明”的实现依赖于默认路由和防火墙的重定向策略，因此更适用于局域网主机服务，而不适合为Internet中的客户机提供服务。</p> 
<p>在Linux网关上，构建Squid为客户机访问Internet提供代理服务</p> 
<p>在所有的局域网主机上，只需正确设置IP地址、默认网关，不需要手动指定代理服务器的地址、端口等信息</p> 
<p>基于传统代理的基础上，在squid服务器上增加一块网卡，作为网关</p> 
<h3><a id="32_180"></a>3.2：实验拓扑</h3> 
<p><img src="https://images2.imgbox.com/87/2e/Cwm1N1nz_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33_182"></a>3.3：实验步骤</h3> 
<h4><a id="331squid_183"></a>3.3.1：squid代理服务上增加一块网卡</h4> 
<p>添加一块网卡（ens36），选择仅主机模式，IP：192.168.10.1</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># ifconfig</span>
ens33: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu 1500
        inet 192.168.209.145  netmask 255.255.255.0  broadcast 192.168.209.255
        inet6 fe80::a426:25c8:ffe1:7352  prefixlen 64  scopeid 0x20<span class="token operator">&lt;</span>link<span class="token operator">&gt;</span>
        ether 00:0c:29:f4:5d:9b  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets 332726  bytes 468459295 <span class="token punctuation">(</span>446.7 MiB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 177525  bytes 30670285 <span class="token punctuation">(</span>29.2 MiB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens36: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu 1500
        inet 192.168.10.1  netmask 255.255.255.0  broadcast 192.168.10.255
        inet6 fe80::1857:8c72:c551:a9a0  prefixlen 64  scopeid 0x20<span class="token operator">&lt;</span>link<span class="token operator">&gt;</span>
        ether 00:0c:29:f4:5d:a5  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets 0  bytes 0 <span class="token punctuation">(</span>0.0 B<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 70  bytes 11020 <span class="token punctuation">(</span>10.7 KiB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre> 
<h4><a id="332squid_206"></a>3.3.2：squid服务器开启路由转发功能</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># vim /etc/sysctl.conf 	'//开启路由转发功能'</span>
net.ipv4.ip_forward<span class="token operator">=</span>1	<span class="token string">'//末行添加，注意#号'</span>
<span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># sysctl -p	'//加载sysctl.conf'</span>
net.ipv4.ip_forward <span class="token operator">=</span> 1
</code></pre> 
<h4><a id="334_214"></a>3.3.4：透明代理配置</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># vim /etc/squid.conf</span>
http_port 192.168.10.1:3128 transparent	<span class="token string">'//仅修改此行，开启透明代理即可'</span>
cache_effective_user squid
cache_effective_group squid
</code></pre> 
<h4><a id="335_222"></a>3.3.5：设置防火墙规则</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># iptables -F	'//清空表内容'</span>
<span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># iptables -t nat -F	'//清空nat表内容'</span>
<span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># iptables -t nat -I PREROUTING -i ens36 -s 192.168.10.0/24 -p tcp --dport 80 -j REDIRECT --to 3128	'//定义规则入口ens36网卡，http协议80端口重定向到3128端口'</span>
<span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># iptables -t nat -I PREROUTING -i ens36 -s 192.168.10.0/24 -p tcp --dport 443 -j REDIRECT --to 3128	'//定义规则入口ens36网卡，https协议443端口重定向到3128端口'</span>
<span class="token punctuation">[</span>root@squid network-scripts<span class="token punctuation">]</span><span class="token comment"># iptables -I INPUT -p tcp --dport 3128 -j ACCEPT	'//新增规则，允许3128端口'</span>
</code></pre> 
<h4><a id="336_231"></a>3.3.6：客户端验证</h4> 
<p>关闭客户端游览器的代理功能，直接访问web站点<br> <img src="https://images2.imgbox.com/87/ba/r3DCtLtz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="337web_234"></a>3.3.7：查看web站点的访问日志</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@web httpd<span class="token punctuation">]</span><span class="token comment"># cat access_log </span>
<span class="token punctuation">..</span>.
192.168.209.145 - - <span class="token punctuation">[</span>09/Sep/2020:12:19:32 +0800<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> 404 209 <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36 Edge/18.18363"</span>
<span class="token punctuation">..</span>.
</code></pre> 
<p>同样源地址为squid代理服务器的地址！</p> 
<h2><a id="ACL_243"></a>四：ACL访问控制</h2> 
<h3><a id="41acl_244"></a>4.1：acl访问控制方式</h3> 
<p>根据源地址、目标URL、文件类型等定义列表<br> 语法结构：<br> acl 列表名称 列表类型 列表内容</p> 
<p>针对已定义的acl列表进行限制<br> 语法结构：<br> http_access allow或deny 列表名称1 列表名称2 …</p> 
<h3><a id="42acl_253"></a>4.2：acl访问控制类型</h3> 
<p>常用的acl列表类型</p> 
<ul><li>src：源地址</li><li>dst：目标地址</li><li>port：端口</li><li>dstdomain：目标域</li><li>time：访问时间 MTWHFAC代表周一至周日</li><li>maxconn：最大并发连接</li><li>url_regex：目标URL地址</li><li>Urlpath_regex：整个目标URL路径</li></ul> 
<h3><a id="43acl_264"></a>4.3：acl规则的优先级</h3> 
<ul><li>一个用户访问代理服务器时，squid会顺序匹配squid中定义的所有规则列表，一旦匹配成功，立即停止匹配</li><li>所有规则都不匹配时，squid会使用与最后一条相反的规则</li></ul> 
<h2><a id="sarg_268"></a>五：日志分析工具sarg</h2> 
<h3><a id="51squidsarg_269"></a>5.1：在squid服务器上部署sarg</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid ~<span class="token punctuation">]</span><span class="token comment"># yum install gd gd-devel -y</span>
<span class="token punctuation">[</span>root@squid ~<span class="token punctuation">]</span><span class="token comment"># cd /opt</span>
<span class="token punctuation">[</span>root@squid opt<span class="token punctuation">]</span><span class="token comment"># rz -E</span>
rz waiting to receive.
<span class="token punctuation">[</span>root@squid opt<span class="token punctuation">]</span><span class="token comment"># ls</span>
rh  sarg-2.3.7.tar.gz
<span class="token punctuation">[</span>root@squid opt<span class="token punctuation">]</span><span class="token comment"># tar zxvf sarg-2.3.7.tar.gz </span>
<span class="token punctuation">[</span>root@squid opt<span class="token punctuation">]</span><span class="token comment"># cd sarg-2.3.7/</span>
<span class="token punctuation">[</span>root@squid sarg-2.3.7<span class="token punctuation">]</span><span class="token comment"># ./configure \</span>
<span class="token operator">&gt;</span> --prefix<span class="token operator">=</span>/usr/local/sarg \
<span class="token operator">&gt;</span> --enable-extraprotection \
<span class="token operator">&gt;</span> --sysconfdir<span class="token operator">=</span>/etc/sarg
<span class="token punctuation">[</span>root@squid sarg-2.3.7<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
</code></pre> 
<h3><a id="52sarg_286"></a>5.2：修改sarg的配置文件</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid sarg-2.3.7<span class="token punctuation">]</span><span class="token comment"># cd /etc/sarg/</span>
<span class="token punctuation">[</span>root@squid sarg<span class="token punctuation">]</span><span class="token comment"># ls</span>
css.tpl  exclude_codes  sarg.conf  user_limit_block
<span class="token punctuation">[</span>root@squid sarg<span class="token punctuation">]</span><span class="token comment"># vim sarg.conf</span>
7 access_log /usr/local/squid/var/logs/access.log  //指定访问日志文件
25 title <span class="token string">"Squid User Access Reports"</span>    //网页标题
120 output_dir /var/www/html/squid-reports  //报告输出目录
178 user_ip no  //使用用户名显示
206 exclude_hosts /usr/local/sarg/noreport  //不计入排序的站点列表文件，此目录需要自己创建
184 topuser_sort_field connect reverse  //top排序中有连接次数、访问字节（BYTES）、降序排序 升序是normal
257 overwrite_report no   //同名日志是否覆盖
289 mail_utility mailq.postfix   //发送邮件报告命令
434 charset UTF-8  //字符集
518 weekdays 0-6    //top排行的星期周期
525 hours 0-23    //top排行的时间周期
633 www_document_root /var/www/html    //网页根目录
</code></pre> 
<h3><a id="53_306"></a>5.3：添加不计入站点文件，添加的域名将不被显示在排序中</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid sarg<span class="token punctuation">]</span><span class="token comment"># touch /usr/local/sarg/noreport</span>
</code></pre> 
<h3><a id="54sarg_311"></a>5.4：开启sarg</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid sarg<span class="token punctuation">]</span><span class="token comment"># ln -s /usr/local/sarg/bin/sarg /usr/local/bin</span>
<span class="token punctuation">[</span>root@squid sarg<span class="token punctuation">]</span><span class="token comment"># sarg</span>
</code></pre> 
<h3><a id="55http_317"></a>5.5：安装、启动http</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@squid sarg<span class="token punctuation">]</span><span class="token comment"># yum install httpd -y</span>
<span class="token punctuation">[</span>root@squid sarg<span class="token punctuation">]</span><span class="token comment"># systemctl start httpd</span>
</code></pre> 
<h3><a id="56sarg_323"></a>5.6：查看sarg的统计日志</h3> 
<p>客户端输入网址http://192.168.209.145/squid-reports/<br> <img src="https://images2.imgbox.com/0a/19/0F1JkR2R_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="57_326"></a>5.7：执行周期性计划任务，每天生成报告</h3> 
<pre><code class="prism language-bash">sarg -l /usr/local/squid/var/logs/access.log -o /var/www/html/squid-reports/ -z -d <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> -d <span class="token string">"1 day ago"</span> +%d/%m/%Y<span class="token variable">)</span></span>-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%d/%m/%Y<span class="token variable">)</span></span>
</code></pre> 
<p>sarg 命令常用选项：</p> 
<p>-l 指定输入日志来源</p> 
<p>-o 指定输出目录</p> 
<p>-z 处理信息</p> 
<p>-d 指定日期</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1f8b03b8d1ab3d3814288d248332d25b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue  scrollBehavior 切换到新路由时，页面要滚动到顶部或保持原先的滚动位置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d6b3c5651f1d22556b62817ee7787cc9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JS导出带图片的Excel</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>