<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>手把手教你一整套R语言数据分析&#43;建模流程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="手把手教你一整套R语言数据分析&#43;建模流程" />
<meta property="og:description" content="手把手教你一整套R语言数据分析&#43;建模流程 Intro项目背景前期准备数据描述数据清洗预分析及预处理数值型数据类别型数据 特征建模模型对比 Intro 近期在整理数据分析流程，找到了之前写的一篇代码，分享给大家。这是我上学时候做的一个项目，当时由于经验不足产生了一些问题，这些问题会在之后一点一点给大家讨论，避免各位踩坑。本篇分享会带一些讲解，可能有些地方不够清楚，欢迎留言讨论。
本次除了分享之外也是对自己之前项目的一个复盘。还是使用R语言（毕竟是我钟爱的语言）。Python的如果有需求之后会放别的项目。
本篇中包含了数据导入，清洗，可视化，特征工程，建模的代码，大家可以选择需要的去参考。
所有代码&#43;注释&#43;数据在这里 https://download.csdn.net/download/zhaotian151/85035590
付费下载链接，觉得文章有用可以适当支持，当然你也可以从这个文章里面一个个摘代码~
不建议还在上学同学直接抄作业哦，所有的项目都是宝贵的经验，是你上班之后确确实实可以用到的东西，希望大家上学的时候好好学习。
项目背景 数据来自Online Shopper’s Intention 包含12,330 条数据, 10个计数型特征和8个类别型特征。 使用‘Revenue’ 作为标签进行建模。最终目的就是根据拿到的这些数据去建立一个可以预测Revenue的模型。
有些同学说数据被kaggle从网上删掉了，数据的csv上传到资源里了，需要可以连同代码一起购买。
前期准备 首先你要下载一个R语言以及它的舒适版本R studio。
下载方式如下：
安装R以及Rstudio
如果之前有用过R的朋友请忽略这一段。
安装R非常简单，直接官网下载
之后下载Rstudio，这个相当于R语言的开挂版，界面相比于R来说非常友好，辅助功能也很多，下载地址
#注意Rstudio是基于R语言的，需要下载安装R语言后才可以安装使用。
安装好了后运行以下代码来导入package们。
setwd(&#34;~/Desktop/STAT5003/Ass&#34;) #选择项目存放的位置，同样这也是你数据csv存放的位置 # install.packages(&#34;xxx&#34;) 如果之前没有装过以下的包，先用这句话来装包，然后再去load # the following packages are for the EDA part library(GGally) library(ggcorrplot) library(psych) library(ggstatsplot) library(ggplot2) library(grid) # the following packages are for the Model part library(MASS) library(Boruta) # Feature selection with the Boruta algorithm library(caret) library(MLmetrics) library(class) library(neuralnet) library(e1071) library(randomForest) library(keras) 导入的包有些多，keras那个的安装可以参考我之前的文章 （R语言基于Keras的MLP神经网络详解" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/bcd75eac975438389130e0e44d325b19/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-25T15:29:05+08:00" />
<meta property="article:modified_time" content="2022-05-25T15:29:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">手把手教你一整套R语言数据分析&#43;建模流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>手把手教你一整套R语言数据分析+建模流程</h4> 
 <ul><li><ul><li><a href="#Intro_3" rel="nofollow">Intro</a></li><li><a href="#_15" rel="nofollow">项目背景</a></li><li><a href="#_19" rel="nofollow">前期准备</a></li><li><a href="#_57" rel="nofollow">数据描述</a></li><li><a href="#_107" rel="nofollow">数据清洗</a></li><li><a href="#_124" rel="nofollow">预分析及预处理</a></li><li><ul><li><a href="#_125" rel="nofollow">数值型数据</a></li><li><a href="#_153" rel="nofollow">类别型数据</a></li></ul> 
   </li><li><a href="#_274" rel="nofollow">特征</a></li><li><a href="#_327" rel="nofollow">建模</a></li><li><a href="#_542" rel="nofollow">模型对比</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="Intro_3"></a>Intro</h3> 
<p>近期在整理数据分析流程，找到了之前写的一篇代码，分享给大家。这是我上学时候做的一个项目，当时由于经验不足产生了一些问题，这些问题会在之后一点一点给大家讨论，避免各位踩坑。本篇分享会带一些讲解，可能有些地方不够清楚，欢迎留言讨论。</p> 
<p>本次除了分享之外也是对自己之前项目的一个复盘。还是使用R语言（毕竟是我钟爱的语言）。Python的如果有需求之后会放别的项目。</p> 
<p>本篇中包含了数据导入，清洗，可视化，特征工程，建模的代码，大家可以选择需要的去参考。</p> 
<p>所有代码+注释+数据在这里 https://download.csdn.net/download/zhaotian151/85035590<br> 付费下载链接，觉得文章有用可以适当支持，当然你也可以从这个文章里面一个个摘代码~</p> 
<p>不建议还在上学同学直接抄作业哦，所有的项目都是宝贵的经验，是你上班之后确确实实可以用到的东西，希望大家上学的时候好好学习。</p> 
<h3><a id="_15"></a>项目背景</h3> 
<p>数据来自<a href="https://www.kaggle.com/roshansharma/online-shoppers-intention" rel="nofollow">Online Shopper’s Intention</a> 包含12,330 条数据, 10个计数型特征和8个类别型特征。 使用‘Revenue’ 作为标签进行建模。最终目的就是根据拿到的这些数据去建立一个可以预测Revenue的模型。<br> 有些同学说数据被kaggle从网上删掉了，数据的csv上传到资源里了，需要可以连同代码一起购买。</p> 
<h3><a id="_19"></a>前期准备</h3> 
<p>首先你要下载一个R语言以及它的舒适版本R studio。<br> 下载方式如下：</p> 
<p>安装R以及Rstudio<br> 如果之前有用过R的朋友请忽略这一段。<br> 安装R非常简单，直接<a href="https://mirrors.tuna.tsinghua.edu.cn/CRAN/" rel="nofollow">官网下载</a></p> 
<p>之后下载Rstudio，这个相当于R语言的开挂版，界面相比于R来说非常友好，辅助功能也很多，<a href="https://www.rstudio.com/products/rstudio/download/" rel="nofollow">下载地址</a></p> 
<p>#注意Rstudio是基于R语言的，需要下载安装R语言后才可以安装使用。</p> 
<p>安装好了后运行以下代码来导入package们。</p> 
<pre><code class="prism language-r">setwd<span class="token punctuation">(</span><span class="token string">"~/Desktop/STAT5003/Ass"</span><span class="token punctuation">)</span> <span class="token comment">#选择项目存放的位置，同样这也是你数据csv存放的位置</span>
<span class="token comment"># install.packages("xxx") 如果之前没有装过以下的包，先用这句话来装包，然后再去load</span>
<span class="token comment"># the following packages are for the EDA part</span>
library<span class="token punctuation">(</span>GGally<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>ggcorrplot<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>psych<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>ggstatsplot<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>ggplot2<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>grid<span class="token punctuation">)</span>

<span class="token comment"># the following packages are for the Model part</span>
library<span class="token punctuation">(</span>MASS<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>Boruta<span class="token punctuation">)</span>  <span class="token comment"># Feature selection with the Boruta algorithm</span>
library<span class="token punctuation">(</span>caret<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>MLmetrics<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>class<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>neuralnet<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>e1071<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>randomForest<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>keras<span class="token punctuation">)</span>
</code></pre> 
<p>导入的包有些多，keras那个的安装可以参考我之前的文章 （R语言基于Keras的MLP神经网络详解<br> https://blog.csdn.net/zhaotian151/article/details/84305440 ）</p> 
<h3><a id="_57"></a>数据描述</h3> 
<p>首先啊把这个数据下载到你的电脑上，然后用以下代码导入R就可以了。</p> 
<pre><code class="prism language-r">dataset <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"online_shoppers_intention.csv"</span><span class="token punctuation">)</span>
str<span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
</code></pre> 
<p>str（）这个function可以看到你这个数据的属性，输出如下：<img src="https://images2.imgbox.com/08/63/4VXYRILt_o.png" alt="在这里插入图片描述"><br> 此时发现数据格式有int，number，factor等等。为了方便之后做分析和建模，我们先统一数据格式。这一步也是建议大家在每一个项目中都要做的，算是对数据的一个预处理，因为大家从网上下载的数据，尤其是现成的csv格式，很难控制数据源的质量。</p> 
<pre><code class="prism language-r">dataset<span class="token operator">$</span>OperatingSystems <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>dataset<span class="token operator">$</span>OperatingSystems<span class="token punctuation">)</span>
dataset<span class="token operator">$</span>Browser <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Browser<span class="token punctuation">)</span>
dataset<span class="token operator">$</span>Region <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Region<span class="token punctuation">)</span>
dataset<span class="token operator">$</span>TrafficType <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>dataset<span class="token operator">$</span>TrafficType<span class="token punctuation">)</span>
dataset<span class="token operator">$</span>Weekend <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Weekend<span class="token punctuation">)</span>
dataset<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Revenue<span class="token punctuation">)</span>

dataset<span class="token operator">$</span>Administrative <span class="token operator">&lt;-</span> as.numeric<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Administrative<span class="token punctuation">)</span>
dataset<span class="token operator">$</span>Informational <span class="token operator">&lt;-</span> as.numeric<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Informational<span class="token punctuation">)</span>
dataset<span class="token operator">$</span>ProductRelated <span class="token operator">&lt;-</span> as.numeric<span class="token punctuation">(</span>dataset<span class="token operator">$</span>ProductRelated<span class="token punctuation">)</span>

summary<span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
</code></pre> 
<p>现在数据格式就统一了，分为factor和numeric，其中factor大家可以理解为非连续性的数据，比如种类、颜色这些都属于factor。numeric可以理解为连续性的数据，像是身高、体重、价格这些是属于numeric。因为R里面的一些package（尤其是建模的package）对数据的输入格式有要求，所以提前处理好非常重要。这可以帮助你更好的整理数据以及敲出简洁舒爽的代码。</p> 
<p>记得整理好数据格式之后summary（）一下，你可以从这里发现一些数据的小问题。比如下面的这个‘Administrative_Duration ’。<br> <img src="https://images2.imgbox.com/53/00/UhcD2yAl_o.png" alt="在这里插入图片描述"><br> 你看这min=-1就离谱（当然这也是一个小坑），我们知道duration不可能是&lt;0的。但这是我们的主观思维，由于不知道这个数据在采集入数据库的时候是怎么定义的，所以这个-1是为啥我们不会知道原因。这也是为什么我推荐做数据分析的时候要从头开始跟项目，这样你对数据了如指掌，而不是像现在这样只凭主观思想去判断数据对错（虽然大部分时候你的主观思想没啥问题）。</p> 
<p>以下给一些数据解释，就不翻译了，看或不看都可（但你自己做项目的时候一定一定一定要仔细看）<br> Variables are described as follows：<br> Administrative : Administrative Value<br> Administrative_Duration : Duration in Administrative Page<br> Informational : Informational Value<br> Informational_Duration : Duration in Informational Page<br> ProductRelated : Product Related Value<br> ProductRelated_Duration : Duration in Product Related Page<br> BounceRates : Bounce Rates of a web page<br> ExitRates : Exit rate of a web page<br> PageValues : Page values of each web page<br> SpecialDay : Special days like valentine etc<br> Month : Month of the year<br> OperatingSystems : Operating system used<br> Browser : Browser used<br> Region : Region of the user<br> TrafficType : Traffic Type<br> VisitorType : Types of Visitor<br> Weekend : Weekend or not<br> Revenue : Revenue will be generated or not</p> 
<h3><a id="_107"></a>数据清洗</h3> 
<p>我们在上一部分的summary已经发现了duration有小于0的，因此所有小于0的duration相关的，我们把它变成NA，然后算一下NA率，来判断这些数是给它填补上还是直接删。个人认为如果missing rate很小删了就成。但如果你的数据集本身就不大，那建议你使用填值法填进去。因为数据太少的话就没啥分析的必要。具体多少算少，见仁见智吧，感兴趣的话之后可以写一篇做讨论。</p> 
<pre><code class="prism language-r">dataset<span class="token operator">$</span>Administrative_Duration<span class="token punctuation">[</span>dataset<span class="token operator">$</span>Administrative_Duration <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">NA</span>
dataset<span class="token operator">$</span>Informational_Duration<span class="token punctuation">[</span>dataset<span class="token operator">$</span>Informational_Duration <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">NA</span>
dataset<span class="token operator">$</span>ProductRelated_Duration<span class="token punctuation">[</span>dataset<span class="token operator">$</span>ProductRelated_Duration <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">NA</span>
missing.rate <span class="token operator">&lt;-</span> <span class="token number">1</span> <span class="token operator">-</span> nrow<span class="token punctuation">(</span>na.omit<span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>nrow<span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
paste<span class="token punctuation">(</span><span class="token string">"missing rate ="</span><span class="token punctuation">,</span> missing.rate <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token punctuation">)</span>
</code></pre> 
<p>"missing rate = 0.38 %"还挺小的，所以直接删掉有问题的数据。</p> 
<pre><code class="prism language-r">dataset <span class="token operator">&lt;-</span> na.omit<span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
</code></pre> 
<p>然后记得用summary再查一次哦，看看是否删干净了。</p> 
<h3><a id="_124"></a>预分析及预处理</h3> 
<h4><a id="_125"></a>数值型数据</h4> 
<p>下面三种分别是箱形图，ggpairs以及相关性矩阵。 箱形图可以用来观察数据整体的分布情况。ggpairs绘制的相关关系图可以查看数据分布和相关性。相关性矩阵专注于看相关系数、是否有相关性以及是否significant。这几个各有其注重点，根据需要去做就可以。</p> 
<pre><code class="prism language-r">par<span class="token punctuation">(</span>mfrow <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#让图片以2行5列的形式排列在一张图上</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Administrative<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"Administrative"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Administrative_Duration<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"Administrative_Duration"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Informational<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"Informational"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>Informational_Duration<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"Informational_Duration"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>ProductRelated<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"ProductRelated"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>ProductRelated_Duration<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"ProductRelated_Duration"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>BounceRates<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"BounceRates"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>ExitRates<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"ExitRates"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>PageValues<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"PageValues"</span><span class="token punctuation">)</span>
boxplot<span class="token punctuation">(</span>dataset<span class="token operator">$</span>SpecialDay<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"SpecialDay"</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b9/94/g2FD0Scj_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-r">ggpairs<span class="token punctuation">(</span>dataset<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fe/d3/lMwsI8yP_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-r">corr <span class="token operator">=</span> cor<span class="token punctuation">(</span>dataset<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
p.mat <span class="token operator">&lt;-</span> cor_pmat<span class="token punctuation">(</span>dataset<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> use <span class="token operator">=</span> <span class="token string">"complete"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"pearson"</span><span class="token punctuation">)</span>
ggcorrplot<span class="token punctuation">(</span>corr<span class="token punctuation">,</span> hc.order <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"lower"</span><span class="token punctuation">,</span> lab <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span> p.mat <span class="token operator">=</span> p.mat<span class="token punctuation">,</span> 
    insig <span class="token operator">=</span> <span class="token string">"blank"</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4b/09/c8xq6ui1_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_153"></a>类别型数据</h4> 
<p>针对类别型数据我们主要是看他的分布，因此直接画bar plot就成。下面的代码用到了ggplot，是个非常好用的可视化包。grid.newpage()这里主要是为了让这些图片都显示在一张图上，这样把图片导出或是直接在markdown上显示的时候所有图都会显示在一个页面上面，看起来比较美观和舒适。</p> 
<pre><code class="prism language-r">p1 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> SpecialDay<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>
p2 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> Month<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>
p3 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> OperatingSystems<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> 
    colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>
p4 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> Browser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>
p5 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> Region<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>
p6 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> TrafficType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>
p7 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> VisitorType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>
p8 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> Weekend<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>
p9 <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> Revenue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> geom_bar<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token string">"#CF6A1A"</span><span class="token punctuation">,</span> colour <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span>

grid.newpage<span class="token punctuation">(</span><span class="token punctuation">)</span>
pushViewport<span class="token punctuation">(</span>viewport<span class="token punctuation">(</span>layout <span class="token operator">=</span> grid.layout<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> heights <span class="token operator">=</span> unit<span class="token punctuation">(</span>c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token string">"null"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
grid.text<span class="token punctuation">(</span><span class="token string">"Bar Plot of All Categorical Feature"</span><span class="token punctuation">,</span> vp <span class="token operator">=</span> viewport<span class="token punctuation">(</span>layout.pos.row <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> 
    layout.pos.col <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
vplayout <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> viewport<span class="token punctuation">(</span>layout.pos.row <span class="token operator">=</span> x<span class="token punctuation">,</span> layout.pos.col <span class="token operator">=</span> y<span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p2<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p3<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p4<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p5<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p6<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p7<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p8<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>p9<span class="token punctuation">,</span> vp <span class="token operator">=</span> vplayout<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/aa/c7/M2uRpXs4_o.png" alt="在这里插入图片描述"><br> 我们可以看到，数据还是比较偏。我们想要预测的revenue也是非常imbalance（标签中的false与true占比不均衡）。因此在处理数据或是选择模型的时候要注意这一点。这里不作详细讨论。针对imbalance data应该是有很多可以说的东西。之后有空的话可以细聊~</p> 
<p>其实到目前为止，作为一个普通的项目来说，预分析可以结束了，我们查看了所有数据的分布，并且对现有的数据有了一些直观的印象。但我们不能满足于此，因此对每一个类别型变量再做一次更细致的分析。</p> 
<p>首先看一下这个 Special Day 。原数据里给的这个special day给的是0，0.2，0.4这种数值，代表的是距离节日当天的日子，比如1就是节日当天，0.2是节日的前几天（我记得大概是这样）但这种就比较迷惑，我不知道这个具体是咋划分的（这也是为啥希望大家对你所研究的项目有非常深入的了解，你如果对此很了解，那么很多分析的步骤是可以省略的），所以只能让数据告诉我，special day应该如何存在于我们之后的模型中。</p> 
<pre><code class="prism language-r">special_day_check <span class="token operator">&lt;-</span> dataset<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
special_day_check<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>special_day_check<span class="token operator">$</span>Revenue <span class="token operator">==</span> <span class="token string">"FALSE"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    <span class="token number">1</span><span class="token punctuation">)</span>

special_day_check<span class="token operator">$</span>SpecialDay<span class="token punctuation">[</span>special_day_check<span class="token operator">$</span>SpecialDay <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">NA</span>
special_day_check <span class="token operator">&lt;-</span> na.omit<span class="token punctuation">(</span>special_day_check<span class="token punctuation">)</span>

special_day_glm <span class="token operator">&lt;-</span> glm<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> SpecialDay<span class="token punctuation">,</span> data <span class="token operator">=</span> special_day_check<span class="token punctuation">,</span> family <span class="token operator">=</span> binomial<span class="token punctuation">(</span>link <span class="token operator">=</span> <span class="token string">"logit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
summary<span class="token punctuation">(</span>special_day_glm<span class="token punctuation">)</span>

<span class="token comment">## </span>
<span class="token comment">## Call:</span>
<span class="token comment">## glm(formula = Revenue ~ SpecialDay, family = binomial(link = "logit"), </span>
<span class="token comment">##     data = special_day_check)</span>
<span class="token comment">## </span>
<span class="token comment">## Deviance Residuals: </span>
<span class="token comment">##     Min       1Q   Median       3Q      Max  </span>
<span class="token comment">## -0.3961  -0.3756  -0.3560  -0.3374   2.4491  </span>
<span class="token comment">## </span>
<span class="token comment">## Coefficients:</span>
<span class="token comment">##             Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="token comment">## (Intercept)  -2.3954     0.2986  -8.021 1.05e-15 ***</span>
<span class="token comment">## SpecialDay   -0.5524     0.4764  -1.159    0.246    </span>
<span class="token comment">## ---</span>
<span class="token comment">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="token comment">## </span>
<span class="token comment">## (Dispersion parameter for binomial family taken to be 1)</span>
<span class="token comment">## </span>
<span class="token comment">##     Null deviance: 578.11  on 1247  degrees of freedom</span>
<span class="token comment">## Residual deviance: 576.77  on 1246  degrees of freedom</span>
<span class="token comment">## AIC: 580.77</span>
<span class="token comment">## </span>
<span class="token comment">## Number of Fisher Scoring iterations: 5</span>
</code></pre> 
<p>首先，我们要检查的是special day 是否应该是一个数值变量。因此，建立一个glm模型（revenue = a+b*special_day)，发现special day的p值=0.246（&gt;0.05），因此可以认为数值型的“SpecialDay”不对revenue有显著的影响，specialday可以被当作类别型变量。</p> 
<p>现在我们把它当作类别型变量分析一下。用ggbarstats这个function。ggstatsplot是ggplot2包的扩展，主要用于创建美观的图片同时自动输出统计学分析结果，其统计学分析结果包含统计分析的详细信息，该包对于经常需要做统计分析的科研工作者来说非常有用。</p> 
<pre><code class="prism language-r">ggbarstats<span class="token punctuation">(</span>data <span class="token operator">=</span> dataset<span class="token punctuation">,</span> main <span class="token operator">=</span> Revenue<span class="token punctuation">,</span> condition <span class="token operator">=</span> SpecialDay<span class="token punctuation">,</span> sampling.plan <span class="token operator">=</span> <span class="token string">"jointMulti"</span><span class="token punctuation">,</span> 
    title <span class="token operator">=</span> <span class="token string">"Revenue by Special Days"</span><span class="token punctuation">,</span> xlab <span class="token operator">=</span> <span class="token string">"Special Days"</span><span class="token punctuation">,</span> perc.k <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">,</span> 
    x.axis.orientation <span class="token operator">=</span> <span class="token string">"slant"</span><span class="token punctuation">,</span> ggstatsplot.layer <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span> messages <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f0/1a/xycWCRmM_o.png" alt="在这里插入图片描述"><br> 用此函数可以绘制出呈现分类变量的柱状图，图中的上半部分(<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
         
         
           P 
          
         
           e 
          
         
           a 
          
         
           r 
          
         
           s 
          
         
           o 
          
         
           n 
          
         
        
          2 
         
        
       
      
        x^2_{Pearson} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.08944em; vertical-align: -0.275331em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -2.42467em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">P</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">n</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.275331em;"><span class=""></span></span></span></span></span></span></span></span></span></span>, <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
      
        p 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span></span> ,<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           C 
          
         
           r 
          
         
           a 
          
         
           m 
          
         
           e 
          
         
           r 
          
         
        
       
      
        V_{Cramer} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.07153em;">C</span><span class="mord mathdefault mtight" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 等)代表传统的统计学方法（Frequentist）的一些统计值，下面的部分(<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
        
        
          g 
         
        
          e 
         
        
       
         ( 
        
       
         B 
        
        
        
          F 
         
        
          01 
         
        
       
         ) 
        
       
      
        log_e(BF_{01}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>等)代表贝叶斯（Bayesian）的一些统计值。</p> 
<p>在本项目中，我们主要关注p-value，我们发现，p&lt;0.001并且在柱状图上方所有都是***，这代表了非常显著。因此我们可以确定special day在这个项目组应该作为类别型变量使用。</p> 
<p>建议把每一个类别型变量都这样做一下。过程不赘述了，挑一个有代表性的给大家看一下。</p> 
<p>我们看一下operating systems的ggbarstats（）。</p> 
<pre><code class="prism language-r">ggbarstats<span class="token punctuation">(</span>data <span class="token operator">=</span> dataset<span class="token punctuation">,</span> main <span class="token operator">=</span> Revenue<span class="token punctuation">,</span> condition <span class="token operator">=</span> OperatingSystems<span class="token punctuation">,</span> sampling.plan <span class="token operator">=</span> <span class="token string">"jointMulti"</span><span class="token punctuation">,</span> 
    title <span class="token operator">=</span> <span class="token string">"Revenue by Different Operating Systems"</span><span class="token punctuation">,</span> xlab <span class="token operator">=</span> <span class="token string">"Operating Systems"</span><span class="token punctuation">,</span> 
    perc.k <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">,</span> x.axis.orientation <span class="token operator">=</span> <span class="token string">"slant"</span><span class="token punctuation">,</span> ggstatsplot.layer <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span> messages <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b8/fb/dBHe3j4H_o.png" alt="在这里插入图片描述"><br> 我们发现整体的p&lt;0.001，但是因为个别子类别的样本少，所以柱状图上面出现了ns。我们知道，如果数据很少，那么该数据便不具有统计价值。作为“种类”，我们可以把不具有统计价值的种类并在一起，把他们统一称为“其他”，因此我们把这些少样本的子类别合并在一起，再看一次。</p> 
<pre><code class="prism language-r">dataset<span class="token operator">$</span>OperatingSystems <span class="token operator">&lt;-</span> as.integer<span class="token punctuation">(</span>dataset<span class="token operator">$</span>OperatingSystems<span class="token punctuation">)</span>

dataset<span class="token operator">$</span>OperatingSystems<span class="token punctuation">[</span>dataset<span class="token operator">$</span>OperatingSystems <span class="token operator">==</span> <span class="token string">"5"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token string">"other"</span>
dataset<span class="token operator">$</span>OperatingSystems<span class="token punctuation">[</span>dataset<span class="token operator">$</span>OperatingSystems <span class="token operator">==</span> <span class="token string">"6"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token string">"other"</span>
dataset<span class="token operator">$</span>OperatingSystems<span class="token punctuation">[</span>dataset<span class="token operator">$</span>OperatingSystems <span class="token operator">==</span> <span class="token string">"7"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token string">"other"</span>

dataset<span class="token operator">$</span>OperatingSystems <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>dataset<span class="token operator">$</span>OperatingSystems<span class="token punctuation">)</span>

ggbarstats<span class="token punctuation">(</span>data <span class="token operator">=</span> dataset<span class="token punctuation">,</span> main <span class="token operator">=</span> Revenue<span class="token punctuation">,</span> condition <span class="token operator">=</span> OperatingSystems<span class="token punctuation">,</span> sampling.plan <span class="token operator">=</span> <span class="token string">"jointMulti"</span><span class="token punctuation">,</span> 
    title <span class="token operator">=</span> <span class="token string">"Revenue by Different Operating Systems"</span><span class="token punctuation">,</span> xlab <span class="token operator">=</span> <span class="token string">"Operating Systems"</span><span class="token punctuation">,</span> 
    perc.k <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">,</span> x.axis.orientation <span class="token operator">=</span> <span class="token string">"slant"</span><span class="token punctuation">,</span> ggstatsplot.layer <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span> messages <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8a/46/139G8WIx_o.png" alt="在这里插入图片描述"><br> 现在看起来就比较舒适了，都很显著。<br> 预处理和预分析到此结束。</p> 
<h3><a id="_274"></a>特征</h3> 
<p>我们进行特征工程的最终目的就是提升模型的性能，比如你的数据特征很少的话我们需要建立一些二阶、三阶特征来丰富我们的数据。或是特征太多的时候我们需要进行降维处理。这里我没有做太多的特征工程，只是把特征进行了一下基本的筛选，把没有用的特征删掉。这里的逻辑是先用pca看一下可以保留多少特征，再用Boruta算法和stepAIC去选一下。</p> 
<pre><code class="prism language-r"><span class="token comment"># PCA Since pca can only use on numeric data, so we use the os[,c(1:9)]</span>
pcdata <span class="token operator">&lt;-</span> os<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
pclable <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>os<span class="token operator">$</span>Revenue <span class="token operator">==</span> <span class="token string">"TRUE"</span><span class="token punctuation">,</span> <span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"blue"</span><span class="token punctuation">)</span>
pc <span class="token operator">&lt;-</span> princomp<span class="token punctuation">(</span>os<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cor <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span> scores <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>
summary<span class="token punctuation">(</span>pc<span class="token punctuation">)</span>
<span class="token comment">## Importance of components:</span>
<span class="token comment">##                           Comp.1    Comp.2    Comp.3    Comp.4    Comp.5</span>
<span class="token comment">## Standard deviation     1.8387377 1.2923744 1.0134790 1.0020214 0.9697619</span>
<span class="token comment">## Proportion of Variance 0.3756618 0.1855813 0.1141266 0.1115608 0.1044931</span>
<span class="token comment">## Cumulative Proportion  0.3756618 0.5612431 0.6753697 0.7869305 0.8914236</span>
<span class="token comment">##                            Comp.6     Comp.7    Comp.8      Comp.9</span>
<span class="token comment">## Standard deviation     0.65008195 0.59319914 0.3510795 0.281849096</span>
<span class="token comment">## Proportion of Variance 0.04695628 0.03909836 0.0136952 0.008826546</span>
<span class="token comment">## Cumulative Proportion  0.93837989 0.97747825 0.9911735 1.000000000</span>
plot<span class="token punctuation">(</span>pc<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"lines"</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/dc/27/MDd3gqZB_o.png" alt="在这里插入图片描述"><br> 从pca里面我们可以发现，保留7个numeric变量就可以有95%以上的方差。因此之后我们可以按着至少7个numeric variable这个标准去保留。</p> 
<p>Boruta算法</p> 
<pre><code class="prism language-r">set.seed<span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
boruta.train <span class="token operator">&lt;-</span> Boruta<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> .<span class="token punctuation">,</span> data <span class="token operator">=</span> os<span class="token punctuation">,</span> doTrace <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> maxRuns <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>boruta.train<span class="token punctuation">)</span>
<span class="token comment"># Boruta performed 14 iterations in 3.920271 mins.  13 attributes confirmed</span>
<span class="token comment"># important: Administrative, Administrative_Duration, BounceRates, Browser,</span>
<span class="token comment"># ExitRates and 8 more; 1 attributes confirmed unimportant: SpecialDay; 2</span>
<span class="token comment"># tentative attributes left: OperatingSystems, Weekend; so SpecialDay can be</span>
<span class="token comment"># delete when we fit the model. OperatingSystems and Weekend need to check</span>
<span class="token comment"># by other ways.</span>
</code></pre> 
<p>StepAIC</p> 
<pre><code class="prism language-r">full.model <span class="token operator">&lt;-</span> glm<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> . <span class="token operator">-</span> SpecialDay<span class="token punctuation">,</span> data <span class="token operator">=</span> os<span class="token punctuation">,</span> family <span class="token operator">=</span> binomial<span class="token punctuation">(</span>link <span class="token operator">=</span> <span class="token string">"logit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Backward Stepwise AIC</span>
stepback <span class="token operator">&lt;-</span> stepAIC<span class="token punctuation">(</span>full.model<span class="token punctuation">,</span> direction <span class="token operator">=</span> <span class="token string">"backward"</span><span class="token punctuation">,</span> steps <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
summary<span class="token punctuation">(</span>stepback<span class="token punctuation">)</span>

<span class="token comment"># OperatingSystems, Weekend are all above the &lt;none&gt;, combine the previous</span>
<span class="token comment"># result by Boruta algorithm, it can be delete when we fit model.  Browser</span>
<span class="token comment"># has the minimum AIC, it can be delete when we fit model.  PCA shows we</span>
<span class="token comment"># should keep 7 numeric variables in the dataset when fit the model, so two</span>
<span class="token comment"># numeric variables should be remove. Informational_Duration and</span>
<span class="token comment"># Administrative has the minimum AIC in numeric variables, so remove these</span>
<span class="token comment"># two variables.</span>
</code></pre> 
<p>综合上面三个特征选择的方法 SpecialDay, OperatingSystems, Weekend, Browser, Informational_Duration 和 Administrative 应当在建模的时候被移除。有兴趣的可以跑一下上面的代码，由于运行时间有点长，结果就直接码在代码框里了。</p> 
<h3><a id="_327"></a>建模</h3> 
<p>现在把用来建模数据整理好，准备建模。</p> 
<pre><code class="prism language-r">os_modeldata <span class="token operator">&lt;-</span> os<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span>c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment"># summary(os_modeldata)</span>
write.csv<span class="token punctuation">(</span>os_modeldata<span class="token punctuation">,</span> <span class="token string">"os_modeldata.csv"</span><span class="token punctuation">)</span>
</code></pre> 
<p>首先划分训练集和测试集（train 和 test）</p> 
<pre><code class="prism language-r">set.seed<span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
os_modeldata <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"os_modeldata.csv"</span><span class="token punctuation">)</span>
os_modeldata <span class="token operator">&lt;-</span> os_modeldata<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
os_modeldata<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>os_modeldata<span class="token operator">$</span>Revenue<span class="token punctuation">)</span>
inTrain <span class="token operator">&lt;-</span> createDataPartition<span class="token punctuation">(</span>os_modeldata<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> p <span class="token operator">=</span> <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
Train <span class="token operator">&lt;-</span> os_modeldata<span class="token punctuation">[</span>inTrain<span class="token punctuation">,</span> <span class="token punctuation">]</span>
Test <span class="token operator">&lt;-</span> os_modeldata<span class="token punctuation">[</span><span class="token operator">-</span>inTrain<span class="token punctuation">,</span> <span class="token punctuation">]</span>
</code></pre> 
<p>然后把训练集拆成train和val。这里加了个10-cv（交叉检验）。有些模型的package自带cv的功能，但为了避免不同package之间划分cv的差异，建议大家自己提前把数据划分好。建模最好遵循一个原则，也是统计的一个基本原则，一定要保证你的数据统一，控制好对照组，这样才能让最终的结果尽可能的不受其他各种因素的影响。</p> 
<pre><code class="prism language-r">add_cv_cohorts <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>dat<span class="token punctuation">,</span> cv_K<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dat<span class="token punctuation">)</span><span class="token percent-operator operator">%%</span>cv_K <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment"># if perfectly divisible</span>
        dat<span class="token operator">$</span>cv_cohort <span class="token operator">&lt;-</span> sample<span class="token punctuation">(</span>rep<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>cv_K<span class="token punctuation">,</span> each <span class="token operator">=</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dat<span class="token punctuation">)</span><span class="token percent-operator operator">%/%</span>cv_K<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment"># if not perfectly divisible</span>
        dat<span class="token operator">$</span>cv_cohort <span class="token operator">&lt;-</span> sample<span class="token punctuation">(</span>c<span class="token punctuation">(</span>rep<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dat<span class="token punctuation">)</span><span class="token percent-operator operator">%%</span>cv_K<span class="token punctuation">)</span><span class="token punctuation">,</span> each <span class="token operator">=</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dat<span class="token punctuation">)</span><span class="token percent-operator operator">%/%</span>cv_K <span class="token operator">+</span> 
            <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rep<span class="token punctuation">(</span><span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dat<span class="token punctuation">)</span><span class="token percent-operator operator">%%</span>cv_K <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>cv_K<span class="token punctuation">,</span> each <span class="token operator">=</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dat<span class="token punctuation">)</span><span class="token percent-operator operator">%/%</span>cv_K<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    return<span class="token punctuation">(</span>dat<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># add 10-fold CV labels to real estate data</span>
train_cv <span class="token operator">&lt;-</span> add_cv_cohorts<span class="token punctuation">(</span>Train<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># str(train_cv)</span>
</code></pre> 
<p>OK那么现在开始建模，首先建一个基准模型，Logistic regression classifer（benchmark model）。</p> 
<pre><code class="prism language-r">train_cv_glm <span class="token operator">&lt;-</span> train_cv

glm.acc <span class="token operator">&lt;-</span> glm.f1 <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token punctuation">)</span>

train_cv_glm<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>train_cv_glm<span class="token operator">$</span>Revenue <span class="token operator">==</span> <span class="token string">"TRUE"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># str(train_cv_glm)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># Segement my data by fold using the which() function</span>
    indexes <span class="token operator">&lt;-</span> which<span class="token punctuation">(</span>train_cv_glm<span class="token operator">$</span>cv_cohort <span class="token operator">==</span> i<span class="token punctuation">)</span>
    train <span class="token operator">&lt;-</span> train_cv_glm<span class="token punctuation">[</span><span class="token operator">-</span>indexes<span class="token punctuation">,</span> <span class="token punctuation">]</span>
    val <span class="token operator">&lt;-</span> train_cv_glm<span class="token punctuation">[</span>indexes<span class="token punctuation">,</span> <span class="token punctuation">]</span>
    <span class="token comment"># Model</span>
    glm.model <span class="token operator">&lt;-</span> glm<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> . <span class="token operator">-</span> cv_cohort<span class="token punctuation">,</span> data <span class="token operator">=</span> train<span class="token punctuation">,</span> family <span class="token operator">=</span> binomial<span class="token punctuation">(</span>link <span class="token operator">=</span> <span class="token string">"logit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># predict</span>
    glm.pred <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>glm.model<span class="token punctuation">,</span> newdata <span class="token operator">=</span> val<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"response"</span><span class="token punctuation">)</span>
    glm.pred <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>glm.pred <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># evaluate</span>
    glm.f1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>val<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> glm.pred<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span>
    glm.acc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> sum<span class="token punctuation">(</span>glm.pred <span class="token operator">==</span> val<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token operator">/</span>nrow<span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># F1 and ACC</span>
glm.acc.train <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span>mean<span class="token punctuation">(</span>glm.acc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>
glm.f1.train <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span>mean<span class="token punctuation">(</span>glm.f1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>

<span class="token comment"># print(glm.cm &lt;- table(glm.pred, val$Revenue))</span>

paste<span class="token punctuation">(</span><span class="token string">"The accuracy by Logistic regression classifier by 10-fold CV in train data is"</span><span class="token punctuation">,</span> 
    glm.acc.train<span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token punctuation">)</span>
paste<span class="token punctuation">(</span><span class="token string">"The F1-score by Logistic regression classifier by 10-fold CV in train data is"</span><span class="token punctuation">,</span> 
    glm.f1.train<span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token punctuation">)</span>
<span class="token comment"># f1 = 0.50331</span>
</code></pre> 
<p>然后建立我们用来对比的机器学习模型。这里使用网格搜索法调参。</p> 
<p>KNN</p> 
<pre><code class="prism language-r"><span class="token comment"># since knn() function can't use factor as indenpent variable So re-coding</span>
<span class="token comment"># data, factor to dummy variable)</span>
train_cv_knn <span class="token operator">&lt;-</span> as.data.frame<span class="token punctuation">(</span>model.matrix<span class="token punctuation">(</span><span class="token operator">~</span>.<span class="token punctuation">,</span> train_cv<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
train_cv_knn<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> train_cv<span class="token operator">$</span>Revenue
train_cv_knn <span class="token operator">&lt;-</span> train_cv_knn<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment"># head(train_cv_knn)</span>

knn.grid <span class="token operator">&lt;-</span> expand.grid<span class="token punctuation">(</span>k <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
knn.grid<span class="token operator">$</span>acc <span class="token operator">&lt;-</span> knn.grid<span class="token operator">$</span>f1 <span class="token operator">&lt;-</span> <span class="token keyword">NA</span>

knn.f1 <span class="token operator">&lt;-</span> knn.acc <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>knn.grid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment"># Segement my data by fold using the which() function</span>
        indexes <span class="token operator">&lt;-</span> which<span class="token punctuation">(</span>train_cv_knn<span class="token operator">$</span>cv_cohort <span class="token operator">==</span> i<span class="token punctuation">)</span>
        train <span class="token operator">&lt;-</span> train_cv_knn<span class="token punctuation">[</span><span class="token operator">-</span>indexes<span class="token punctuation">,</span> <span class="token punctuation">]</span>
        val <span class="token operator">&lt;-</span> train_cv_knn<span class="token punctuation">[</span>indexes<span class="token punctuation">,</span> <span class="token punctuation">]</span>
        <span class="token comment"># model and predict</span>
        knn.pred <span class="token operator">&lt;-</span> knn<span class="token punctuation">(</span>train<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span>c<span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span>c<span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> train<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> 
            k <span class="token operator">=</span> k<span class="token punctuation">)</span>
        <span class="token comment"># evaluate</span>
        knn.f1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>val<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> knn.pred<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"TRUE"</span><span class="token punctuation">)</span>
        knn.acc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> sum<span class="token punctuation">(</span>knn.pred <span class="token operator">==</span> val<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token operator">/</span>nrow<span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    knn.grid<span class="token operator">$</span>f1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> mean<span class="token punctuation">(</span>knn.f1<span class="token punctuation">)</span>
    knn.grid<span class="token operator">$</span>acc<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> mean<span class="token punctuation">(</span>knn.acc<span class="token punctuation">)</span>
    print<span class="token punctuation">(</span>paste<span class="token punctuation">(</span><span class="token string">"finished with ="</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

print<span class="token punctuation">(</span>knn.cm <span class="token operator">&lt;-</span> table<span class="token punctuation">(</span>knn.pred<span class="token punctuation">,</span> val<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token punctuation">)</span>

knn.grid<span class="token punctuation">[</span>which.max<span class="token punctuation">(</span>knn.grid<span class="token operator">$</span>f1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
<span class="token comment"># k = 7, f1=0.5484112, acc=0.885042</span>
</code></pre> 
<p>SVM</p> 
<pre><code class="prism language-r">svm.grid <span class="token operator">&lt;-</span> expand.grid<span class="token punctuation">(</span>cost <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gamma <span class="token operator">=</span> seq<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
svm.grid<span class="token operator">$</span>acc <span class="token operator">&lt;-</span> svm.grid<span class="token operator">$</span>f1 <span class="token operator">&lt;-</span> <span class="token keyword">NA</span>

svm.f1 <span class="token operator">&lt;-</span> svm.acc <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>svm.grid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment"># Segement my data by fold using the which() function</span>
        indexes <span class="token operator">&lt;-</span> which<span class="token punctuation">(</span>train_cv<span class="token operator">$</span>cv_cohort <span class="token operator">==</span> i<span class="token punctuation">)</span>
        train <span class="token operator">&lt;-</span> train_cv<span class="token punctuation">[</span><span class="token operator">-</span>indexes<span class="token punctuation">,</span> <span class="token punctuation">]</span>
        val <span class="token operator">&lt;-</span> train_cv<span class="token punctuation">[</span>indexes<span class="token punctuation">,</span> <span class="token punctuation">]</span>
        <span class="token comment"># model</span>
        svm.model <span class="token operator">&lt;-</span> svm<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> .<span class="token punctuation">,</span> kernel <span class="token operator">=</span> <span class="token string">"radial"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"C-classification"</span><span class="token punctuation">,</span> 
            gamma <span class="token operator">=</span> svm.grid<span class="token operator">$</span>gamma<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> cost <span class="token operator">=</span> svm.grid<span class="token operator">$</span>cost<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> data <span class="token operator">=</span> train<span class="token punctuation">[</span><span class="token punctuation">,</span> 
                <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        svm.pred <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>svm.model<span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># evaluate</span>
        svm.f1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>val<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> svm.pred<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"TRUE"</span><span class="token punctuation">)</span>
        svm.acc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> sum<span class="token punctuation">(</span>svm.pred <span class="token operator">==</span> val<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token operator">/</span>nrow<span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    svm.grid<span class="token operator">$</span>f1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> mean<span class="token punctuation">(</span>svm.f1<span class="token punctuation">)</span>
    svm.grid<span class="token operator">$</span>acc<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> mean<span class="token punctuation">(</span>svm.acc<span class="token punctuation">)</span>
    print<span class="token punctuation">(</span>paste<span class="token punctuation">(</span><span class="token string">"finished with:"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

print<span class="token punctuation">(</span>svm.cm <span class="token operator">&lt;-</span> table<span class="token punctuation">(</span>svm.pred<span class="token punctuation">,</span> val<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token punctuation">)</span>

svm.grid<span class="token punctuation">[</span>which.max<span class="token punctuation">(</span>svm.grid<span class="token operator">$</span>f1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
<span class="token comment"># cost=1, gamma=0.2,f1= 0.5900601,acc= 0.8948096</span>
</code></pre> 
<p>Random Forest</p> 
<pre><code class="prism language-r">rf.grid <span class="token operator">&lt;-</span> expand.grid<span class="token punctuation">(</span>nt <span class="token operator">=</span> seq<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mrty <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rf.grid<span class="token operator">$</span>acc <span class="token operator">&lt;-</span> rf.grid<span class="token operator">$</span>f1 <span class="token operator">&lt;-</span> <span class="token keyword">NA</span>

rf.f1 <span class="token operator">&lt;-</span> rf.acc <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>rf.grid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment"># Segement my data by fold using the which() function</span>
        indexes <span class="token operator">&lt;-</span> which<span class="token punctuation">(</span>train_cv<span class="token operator">$</span>cv_cohort <span class="token operator">==</span> i<span class="token punctuation">)</span>
        train <span class="token operator">&lt;-</span> train_cv<span class="token punctuation">[</span><span class="token operator">-</span>indexes<span class="token punctuation">,</span> <span class="token punctuation">]</span>
        val <span class="token operator">&lt;-</span> train_cv<span class="token punctuation">[</span>indexes<span class="token punctuation">,</span> <span class="token punctuation">]</span>
        <span class="token comment"># model</span>
        rf.model <span class="token operator">&lt;-</span> randomForest<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> .<span class="token punctuation">,</span> data <span class="token operator">=</span> train<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> n.trees <span class="token operator">=</span> rf.grid<span class="token operator">$</span>nt<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> 
            mtry <span class="token operator">=</span> rf.grid<span class="token operator">$</span>mrty<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
        rf.pred <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>rf.model<span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># evaluate</span>
        rf.f1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>val<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> rf.pred<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"TRUE"</span><span class="token punctuation">)</span>
        rf.acc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> sum<span class="token punctuation">(</span>rf.pred <span class="token operator">==</span> val<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token operator">/</span>nrow<span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    rf.grid<span class="token operator">$</span>f1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> mean<span class="token punctuation">(</span>rf.f1<span class="token punctuation">)</span>
    rf.grid<span class="token operator">$</span>acc<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> mean<span class="token punctuation">(</span>rf.acc<span class="token punctuation">)</span>
    print<span class="token punctuation">(</span>paste<span class="token punctuation">(</span><span class="token string">"finished with:"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

print<span class="token punctuation">(</span>rf.cm <span class="token operator">&lt;-</span> table<span class="token punctuation">(</span>rf.pred<span class="token punctuation">,</span> val<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token punctuation">)</span>
rf.grid<span class="token punctuation">[</span>which.max<span class="token punctuation">(</span>rf.grid<span class="token operator">$</span>f1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
<span class="token comment"># nt=200,mtry=3 ,f1 = 0.6330392, acc=0.8960723</span>
</code></pre> 
<p>Neural Network</p> 
<pre><code class="prism language-r">nndata <span class="token operator">&lt;-</span> Train
nndata<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>nndata<span class="token operator">$</span>Revenue <span class="token operator">==</span> <span class="token string">"TRUE"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

train_x <span class="token operator">&lt;-</span> model.matrix<span class="token punctuation">(</span><span class="token operator">~</span>.<span class="token punctuation">,</span> nndata<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
train_x <span class="token operator">&lt;-</span> train_x<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
train_y <span class="token operator">&lt;-</span> to_categorical<span class="token punctuation">(</span>as.integer<span class="token punctuation">(</span>as.matrix<span class="token punctuation">(</span>array<span class="token punctuation">(</span>nndata<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

model <span class="token operator">&lt;-</span> keras_model_sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># defining model's layers</span>
model <span class="token percent-operator operator">%&gt;%</span> layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> input_shape <span class="token operator">=</span> <span class="token number">33</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"relu"</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"relu"</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> layer_dropout<span class="token punctuation">(</span>rate <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"relu"</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> layer_dropout<span class="token punctuation">(</span>rate <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"relu"</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> layer_dropout<span class="token punctuation">(</span>rate <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"sigmoid"</span><span class="token punctuation">)</span>

<span class="token comment"># defining model's optimizer</span>
model <span class="token percent-operator operator">%&gt;%</span> compile<span class="token punctuation">(</span>loss <span class="token operator">=</span> <span class="token string">"binary_crossentropy"</span><span class="token punctuation">,</span> optimizer <span class="token operator">=</span> <span class="token string">"adam"</span><span class="token punctuation">,</span> metrics <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">"accuracy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Metrics: The performance evaluation module provides a series of functions</span>
<span class="token comment"># for model performance evaluation. We use it to determine when the NN</span>
<span class="token comment"># should stop train. The ultimate measure of performance is F1.</span>

<span class="token comment"># Check which column in train_y is FALSE</span>
table<span class="token punctuation">(</span>train_y<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># the first column is FALSE</span>
table<span class="token punctuation">(</span>train_y<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">/</span>table<span class="token punctuation">(</span>train_y<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment"># Define a dictionary with your labels and their associated weights</span>
weight <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token number">5.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># the proportion of FALSE and TURE is about 5.5:1</span>

<span class="token comment"># fitting the model on the training dataset</span>
model <span class="token percent-operator operator">%&gt;%</span> fit<span class="token punctuation">(</span>train_x<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> epochs <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">,</span> validation_split <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> batch_size <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">,</span> 
    class_weight <span class="token operator">=</span> weight<span class="token punctuation">)</span>
<span class="token comment"># after epoch = 20, val_loss not descrease and val_acc not increase, so NN</span>
<span class="token comment"># should stop at epoch = 20</span>
</code></pre> 
<h3><a id="_542"></a>模型对比</h3> 
<p>GLM</p> 
<pre><code class="prism language-r">glmdata <span class="token operator">&lt;-</span> Train
glmdata<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>glmdata<span class="token operator">$</span>Revenue <span class="token operator">==</span> <span class="token string">"TRUE"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
testglm <span class="token operator">&lt;-</span> Test
testglm<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>testglm<span class="token operator">$</span>Revenue <span class="token operator">==</span> <span class="token string">"TRUE"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

glm.model.f <span class="token operator">&lt;-</span> glm<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> .<span class="token punctuation">,</span> data <span class="token operator">=</span> glmdata<span class="token punctuation">,</span> family <span class="token operator">=</span> binomial<span class="token punctuation">(</span>link <span class="token operator">=</span> <span class="token string">"logit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
glm.pred.f <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>glm.model.f<span class="token punctuation">,</span> newdata <span class="token operator">=</span> Test<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"response"</span><span class="token punctuation">)</span>
glm.pred.f <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>glm.pred.f <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

glm.f1.f <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>testglm<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> glm.pred.f<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span>

paste<span class="token punctuation">(</span><span class="token string">"The F1-score by Logistic regression classifier in test data is"</span><span class="token punctuation">,</span> glm.f1.f<span class="token punctuation">)</span>
</code></pre> 
<p>KNN</p> 
<pre><code class="prism language-r">knndata <span class="token operator">&lt;-</span> as.data.frame<span class="token punctuation">(</span>model.matrix<span class="token punctuation">(</span><span class="token operator">~</span>.<span class="token punctuation">,</span> Train<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
knndata <span class="token operator">&lt;-</span> knndata<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
knntest <span class="token operator">&lt;-</span> as.data.frame<span class="token punctuation">(</span>model.matrix<span class="token punctuation">(</span><span class="token operator">~</span>.<span class="token punctuation">,</span> Test<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
knntest <span class="token operator">&lt;-</span> knntest<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

knn.model.f.pred <span class="token operator">&lt;-</span> knn<span class="token punctuation">(</span>knndata<span class="token punctuation">,</span> knntest<span class="token punctuation">,</span> Train<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">)</span>

knn.f1.f <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>Test<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> knn.model.f.pred<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"TRUE"</span><span class="token punctuation">)</span>

paste<span class="token punctuation">(</span><span class="token string">"The F1-score by KNN classifier in test data is"</span><span class="token punctuation">,</span> knn.f1.f<span class="token punctuation">)</span>
</code></pre> 
<p>SVM</p> 
<pre><code class="prism language-r">svm.model.f <span class="token operator">&lt;-</span> svm<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> .<span class="token punctuation">,</span> kernel <span class="token operator">=</span> <span class="token string">"radial"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"C-classification"</span><span class="token punctuation">,</span> 
    gamma <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> cost <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> data <span class="token operator">=</span> Train<span class="token punctuation">)</span>

svm.pred.f <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>svm.model.f<span class="token punctuation">,</span> Test<span class="token punctuation">)</span>

svm.f1.f <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>Test<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> svm.pred.f<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"TRUE"</span><span class="token punctuation">)</span>

paste<span class="token punctuation">(</span><span class="token string">"The F1-score by SVM classifier in test data is"</span><span class="token punctuation">,</span> svm.f1.f<span class="token punctuation">)</span>
</code></pre> 
<p>Random Forests</p> 
<pre><code class="prism language-r">rf.model.f <span class="token operator">&lt;-</span> randomForest<span class="token punctuation">(</span>Revenue <span class="token operator">~</span> .<span class="token punctuation">,</span> data <span class="token operator">=</span> Train<span class="token punctuation">,</span> n.trees <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> mtry <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>

rf.pred.f <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>rf.model.f<span class="token punctuation">,</span> Test<span class="token punctuation">)</span>

rf.f1.f <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>Test<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> rf.pred.f<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"TRUE"</span><span class="token punctuation">)</span>

paste<span class="token punctuation">(</span><span class="token string">"The F1-score by Random Forests classifier in test data is"</span><span class="token punctuation">,</span> rf.f1.f<span class="token punctuation">)</span>
</code></pre> 
<p>NN</p> 
<pre><code class="prism language-r">nndata <span class="token operator">&lt;-</span> Train
nndata<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>nndata<span class="token operator">$</span>Revenue <span class="token operator">==</span> <span class="token string">"TRUE"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

train_x <span class="token operator">&lt;-</span> model.matrix<span class="token punctuation">(</span><span class="token operator">~</span>.<span class="token punctuation">,</span> nndata<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
train_x <span class="token operator">&lt;-</span> train_x<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
train_y <span class="token operator">&lt;-</span> to_categorical<span class="token punctuation">(</span>as.integer<span class="token punctuation">(</span>as.matrix<span class="token punctuation">(</span>array<span class="token punctuation">(</span>nndata<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

model <span class="token operator">&lt;-</span> keras_model_sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># defining model's layers</span>
model <span class="token percent-operator operator">%&gt;%</span> layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> input_shape <span class="token operator">=</span> <span class="token number">33</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"relu"</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"relu"</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> layer_dropout<span class="token punctuation">(</span>rate <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"relu"</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> layer_dropout<span class="token punctuation">(</span>rate <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"relu"</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> layer_dropout<span class="token punctuation">(</span>rate <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    layer_dense<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"sigmoid"</span><span class="token punctuation">)</span>

<span class="token comment"># defining model's optimizer</span>
model <span class="token percent-operator operator">%&gt;%</span> compile<span class="token punctuation">(</span>loss <span class="token operator">=</span> <span class="token string">"binary_crossentropy"</span><span class="token punctuation">,</span> optimizer <span class="token operator">=</span> <span class="token string">"adam"</span><span class="token punctuation">,</span> metrics <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">"accuracy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

weight <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token number">5.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

model <span class="token percent-operator operator">%&gt;%</span> fit<span class="token punctuation">(</span>train_x<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> epochs <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> batch_size <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">,</span> class_weight <span class="token operator">=</span> weight<span class="token punctuation">)</span>

<span class="token comment"># test data</span>
testnn <span class="token operator">&lt;-</span> Test
testnn<span class="token operator">$</span>Revenue <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>testnn<span class="token operator">$</span>Revenue <span class="token operator">==</span> <span class="token string">"TRUE"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

test_x <span class="token operator">&lt;-</span> model.matrix<span class="token punctuation">(</span><span class="token operator">~</span>.<span class="token punctuation">,</span> testnn<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
test_x <span class="token operator">&lt;-</span> test_x<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

nn.pred <span class="token operator">&lt;-</span> model <span class="token percent-operator operator">%&gt;%</span> predict<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span>

nn.pred <span class="token operator">&lt;-</span> as.data.frame<span class="token punctuation">(</span>nn.pred<span class="token punctuation">)</span>
nn.pred<span class="token operator">$</span>label <span class="token operator">&lt;-</span> <span class="token keyword">NA</span>
nn.pred<span class="token operator">$</span>label <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>nn.pred<span class="token operator">$</span>V2 <span class="token operator">&gt;</span> nn.pred<span class="token operator">$</span>V1<span class="token punctuation">,</span> <span class="token string">"TRUE"</span><span class="token punctuation">,</span> <span class="token string">"FALSE"</span><span class="token punctuation">)</span>
nn.pred<span class="token operator">$</span>label <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>nn.pred<span class="token operator">$</span>label<span class="token punctuation">)</span>

nn.f1 <span class="token operator">&lt;-</span> F1_Score<span class="token punctuation">(</span>Test<span class="token operator">$</span>Revenue<span class="token punctuation">,</span> nn.pred<span class="token operator">$</span>label<span class="token punctuation">,</span> positive <span class="token operator">=</span> <span class="token string">"TRUE"</span><span class="token punctuation">)</span>
paste<span class="token punctuation">(</span><span class="token string">"The F1-score by Neural network in test data is"</span><span class="token punctuation">,</span> nn.f1<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/98/27/aUxRJiCq_o.png" alt="在这里插入图片描述"><br> 看一下结果对比哈，RF和NN的表现较好。最后做个混淆矩阵看一下。</p> 
<pre><code class="prism language-r"><span class="token comment"># RF</span>
print<span class="token punctuation">(</span>rf.cm.f <span class="token operator">&lt;-</span> table<span class="token punctuation">(</span>rf.pred.f<span class="token punctuation">,</span> Test<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">##          </span>
<span class="token comment">## rf.pred.f FALSE TRUE</span>
<span class="token comment">##     FALSE   987   74</span>
<span class="token comment">##     TRUE     50  116</span>


<span class="token comment"># NN</span>
print<span class="token punctuation">(</span>nn.cm.f <span class="token operator">&lt;-</span> table<span class="token punctuation">(</span>nn.pred<span class="token operator">$</span>label<span class="token punctuation">,</span> Test<span class="token operator">$</span>Revenue<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">##        </span>
<span class="token comment">##         FALSE TRUE</span>
<span class="token comment">##   FALSE   980   69</span>
<span class="token comment">##   TRUE     57  121</span>
</code></pre> 
<p>欢迎大家参考、讨论，共同进步。如需转载请联系作者。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e86c10c7eef39c374750294989ead93d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">工厂模式-</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b78af23c991c12937f61d5242c92ea6f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c&#43;&#43;中函数对象</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>