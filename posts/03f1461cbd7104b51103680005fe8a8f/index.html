<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于openssl SHA256WithRSA签名和验签过程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于openssl SHA256WithRSA签名和验签过程" />
<meta property="og:description" content="1、我是小蜜蜂搬运每一天。公钥加密、私钥解密、私钥签名、公钥验签。加密是为了保证数据的私密性，签名是为了保证数据的完整性。下面是签名验签过程。
sha256.h
#ifndef __SHA256_H__ #define __SHA256_H__ #include &lt;openssl/rsa.h&gt; //生成公钥和私钥 void GenerateKeyExx(); //从文件中读取私钥 RSA* GetPrivateKeyExx(const char* szPath); //从文件中读取公钥 RSA* GetPublicKeyExx(const char* szPath); //签名 bool RSASign( RSA* rsa, const unsigned char* Msg, size_t MsgLen, unsigned char** EncMsg, size_t* MsgLenEnc); //验签 bool RSAVerifySignature( RSA* rsa, unsigned char* MsgHash, size_t MsgHashLen, const char* Msg, size_t MsgLen, bool* Authentic); //base64编码 void Base64Encode( const unsigned char* buffer, size_t length, char** base64Text); //base64解码 void Base64Decode(const char* b64message, unsigned char** buffer, size_t* length); //计算base64解码后数据长度 size_t calcDecodeLength(const char* b64input); char* signMessage(std::string privateKey, std::string plainText); bool verifySignature(std::string publicKey, std::string plainText, char* signatureBase64); int test(); #endif sha256." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/03f1461cbd7104b51103680005fe8a8f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-23T13:47:38+08:00" />
<meta property="article:modified_time" content="2023-04-23T13:47:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于openssl SHA256WithRSA签名和验签过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>1、我是小蜜蜂搬运每一天。公钥加密、私钥解密、私钥签名、公钥验签。加密是为了保证数据的私密性，签名是为了保证数据的完整性。下面是签名验签过程。</p> 
<p>sha256.h</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SHA256_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SHA256_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/rsa.h&gt;</span></span>

<span class="token comment">//生成公钥和私钥</span>
<span class="token keyword">void</span> <span class="token function">GenerateKeyExx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//从文件中读取私钥</span>
RSA<span class="token operator">*</span> <span class="token function">GetPrivateKeyExx</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> szPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//从文件中读取公钥</span>
RSA<span class="token operator">*</span> <span class="token function">GetPublicKeyExx</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> szPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//签名</span>
<span class="token keyword">bool</span> <span class="token function">RSASign</span><span class="token punctuation">(</span> RSA<span class="token operator">*</span> rsa<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> Msg<span class="token punctuation">,</span> size_t MsgLen<span class="token punctuation">,</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> EncMsg<span class="token punctuation">,</span> size_t<span class="token operator">*</span> MsgLenEnc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//验签</span>
<span class="token keyword">bool</span> <span class="token function">RSAVerifySignature</span><span class="token punctuation">(</span> RSA<span class="token operator">*</span> rsa<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> MsgHash<span class="token punctuation">,</span> size_t MsgHashLen<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> Msg<span class="token punctuation">,</span> size_t MsgLen<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> Authentic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//base64编码</span>
<span class="token keyword">void</span> <span class="token function">Base64Encode</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t length<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> base64Text<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//base64解码</span>
<span class="token keyword">void</span> <span class="token function">Base64Decode</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> b64message<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t<span class="token operator">*</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//计算base64解码后数据长度</span>
size_t <span class="token function">calcDecodeLength</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> b64input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">signMessage</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string privateKey<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> <span class="token function">verifySignature</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string publicKey<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string plainText<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> signatureBase64<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>sha256.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sha256.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/objects.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/aes.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/evp.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/pem.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/ssl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/bio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/err.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

std<span class="token double-colon punctuation">::</span>string privateKey <span class="token operator">=</span> <span class="token string">"-----BEGIN RSA PRIVATE KEY-----\n"</span>\
<span class="token string">"MIIEogIBAAKCAQEAjdKXiqYHzi++YmEb9X6qvqFWLCz1VEfxom2JhinPSJxxcuZW\n"</span>\
<span class="token string">"Bejk2I5yCL5pDnUaG2xpQlMTkV/7S7JfGGvYJumKO4R5zg0QSA7qdxiEhcwf/ekf\n"</span>\
<span class="token string">"SvzM2EDnLHDCKAQwEWsnJy78uxZTLzu/65VZ7EgEcWUTvCs/GZJLI9s6XmKY2SMm\n"</span>\
<span class="token string">"v9+vfqBqkJNXE0ZB6OfSbyeE325P94iMn+B/yJ4vZwXvXGFqNDJyqG+ww7f77HYu\n"</span>\
<span class="token string">"bQPJjLQPedy2qTcgmSAwkUEJVBjYA6mPf/BeZlL1YJHHM7CIBnb3/bzED0n944wo\n"</span>\
<span class="token string">"io+4+rnMZdfhcCVpm74DZomlEf9KuJtq5u/JRQIDAQABAoIBAG2AzvWE4L346z02\n"</span>\
<span class="token string">"0cmptdhe5hRR2lLrAc1yWh83JQ9hi881vfHuMtRql+3cZ218SV4nRNarIo6612NJ\n"</span>\
<span class="token string">"JFfM3SaeZ9cwoIPSXmHk8nBmg9xzEbiRSVIzA09uPZB4t9EB+sNYQvDkPMuPn0b3\n"</span>\
<span class="token string">"EWaq+LWRnayYaLZ/hccOx+m1mcnJnIs27+EPnufrUKVniCguburQoU3VEXSFCzBk\n"</span>\
<span class="token string">"23rhSu20vUOikLuuU4gcvWfnfUoOwdhb2iBhjgMbsjTTmg3+GQuPtblCSTKjk11F\n"</span>\
<span class="token string">"YX2MJHEDFfwVzSurmbqAZC9rjr7PbflC8GMmPfa1LCb7IG5s9AIM4v9Fea0SyZP+\n"</span>\
<span class="token string">"/pM9mzkCgYEAyjLPU7ieqly9+mgeb2fmWh7pYgO49KuFIqqHnP+LaXXYK/TvCJ8X\n"</span>\
<span class="token string">"zJ3PxBgwVMOT94nXSDNjzNLzp0hl8OWWBH0tN0fiq1OEyySM3Mlji6o8KpGcU1k4\n"</span>\
<span class="token string">"jFkXMK1rVQcW8ckLmzMrQF3SphQi4UiEpLX1Zba4YQ4fNHK8NHHHaEMCgYEAs48m\n"</span>\
<span class="token string">"Oe4iEZcVDnag+Mp0Zjgu4mYJeeeGtVUZFCJOeyLDsQVmnt5mJIgGwrxg4o3qljut\n"</span>\
<span class="token string">"aAUXzf8aYZ0fURAsLcwnQg03THFKeIt94Rw/72n2UWT+AZTU3GQtuwf+osZHUfS3\n"</span>\
<span class="token string">"XTLaQE+A1JBC4XLJ99j/95sxt6xZy5YyfhfY09cCgYAbqyhDxJexqE823NiNViJn\n"</span>\
<span class="token string">"YqN9DhVZJb9qJvu3uCBTphSWr0WmYF7ZWR79LnIupzSwQuR6tM2LUbKVyYpplIEa\n"</span>\
<span class="token string">"zCZL0kJqP1uEkNPVwpkkm37wNEy3+xWJ3wcVWiW91OKG44P7EN1ySWRx5X+AZHQC\n"</span>\
<span class="token string">"NgQGjyJb5ZrPioPGiWtIEQKBgE/0B/N3o9ftTET6cccWbootDkNlaAbOH1+TGu2q\n"</span>\
<span class="token string">"MQQHgNfMLdvD7/uITmpb81AuHSz0Ocy9p9HkK90XV6CC8QkbhMeWlu8E60It6slY\n"</span>\
<span class="token string">"COgUaMfpjmkp2nagbPSBJNNaMtu9egCX6jMEs7ry2bUFpgUkrSWWB1df+UP8B1O6\n"</span>\
<span class="token string">"TqRVAoGAVQoCUPVm6C6h6V5dgPvsJMxJ8EjOCgwkXNucAHWcpBV3/LlxLiCGRuEL\n"</span>\
<span class="token string">"B+epYxqwKLpSQBhldasKmmKB0M6MFTwxXwxCmCi80+DBdP5A7GIK52ZGth63i22t\n"</span>\
<span class="token string">"FI8MeDIzA5HqAI24P7ltozoEYAB7GIdJQXq9oT/DRagTwQUzQ8E=\n"</span>\
<span class="token string">"-----END RSA PRIVATE KEY-----\n"</span><span class="token punctuation">;</span>

<span class="token comment">/*std::string privateKey ="-----BEGIN PRIVATE KEY-----\n"\
"MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCN0peKpgfOL75i\n"\
"YRv1fqq+oVYsLPVUR/GibYmGKc9InHFy5lYF6OTYjnIIvmkOdRobbGlCUxORX/tL\n"\
"sl8Ya9gm6Yo7hHnODRBIDup3GISFzB/96R9K/MzYQOcscMIoBDARaycnLvy7FlMv\n"\
"O7/rlVnsSARxZRO8Kz8Zkksj2zpeYpjZIya/369+oGqQk1cTRkHo59JvJ4Tfbk/3\n"\
"iIyf4H/Ini9nBe9cYWo0MnKob7DDt/vsdi5tA8mMtA953LapNyCZIDCRQQlUGNgD\n"\
"qY9/8F5mUvVgkcczsIgGdvf9vMQPSf3jjCiKj7j6ucxl1+FwJWmbvgNmiaUR/0q4\n"\
"m2rm78lFAgMBAAECggEAbYDO9YTgvfjrPTbRyam12F7mFFHaUusBzXJaHzclD2GL\n"\
"zzW98e4y1GqX7dxnbXxJXidE1qsijrrXY0kkV8zdJp5n1zCgg9JeYeTycGaD3HMR\n"\
"uJFJUjMDT249kHi30QH6w1hC8OQ8y4+fRvcRZqr4tZGdrJhotn+Fxw7H6bWZycmc\n"\
"izbv4Q+e5+tQpWeIKC5u6tChTdURdIULMGTbeuFK7bS9Q6KQu65TiBy9Z+d9Sg7B\n"\
"2FvaIGGOAxuyNNOaDf4ZC4+1uUJJMqOTXUVhfYwkcQMV/BXNK6uZuoBkL2uOvs9t\n"\
"+ULwYyY99rUsJvsgbmz0Agzi/0V5rRLJk/7+kz2bOQKBgQDKMs9TuJ6qXL36aB5v\n"\
"Z+ZaHuliA7j0q4Uiqoec/4tpddgr9O8InxfMnc/EGDBUw5P3iddIM2PM0vOnSGXw\n"\
"5ZYEfS03R+KrU4TLJIzcyWOLqjwqkZxTWTiMWRcwrWtVBxbxyQubMytAXdKmFCLh\n"\
"SISktfVltrhhDh80crw0ccdoQwKBgQCzjyY57iIRlxUOdqD4ynRmOC7iZgl554a1\n"\
"VRkUIk57IsOxBWae3mYkiAbCvGDijeqWO61oBRfN/xphnR9RECwtzCdCDTdMcUp4\n"\
"i33hHD/vafZRZP4BlNTcZC27B/6ixkdR9LddMtpAT4DUkELhcsn32P/3mzG3rFnL\n"\
"ljJ+F9jT1wKBgBurKEPEl7GoTzbc2I1WImdio30OFVklv2om+7e4IFOmFJavRaZg\n"\
"XtlZHv0uci6nNLBC5Hq0zYtRspXJimmUgRrMJkvSQmo/W4SQ09XCmSSbfvA0TLf7\n"\
"FYnfBxVaJb3U4objg/sQ3XJJZHHlf4BkdAI2BAaPIlvlms+Kg8aJa0gRAoGAT/QH\n"\
"83ej1+1MRPpxxxZvKi0OQ2VoBs4fX5Ma7aoxBAeA18wt28Pv+4hOalvzUC4dLPQ5\n"\
"zL2n0eQr3RdXoILxCRuEx5aW7wTrQi3qyVgI6BRox+mOaSnadqBs9IEk01oy2716\n"\
"AJfqMwSzuvLZtQWmBSStJZYHV1/5Q/wHU7pOpFUCgYBVCgJQ9WboLqHpXl2A++wk\n"\
"zEnwSM4KDCRc25wAdZykFXf8uXEuIIZG4QsH56ljGrAoulJAGGV1qwqaYoHQzowV\n"\
"PDFfDEKYKLzT4MF0/kDsYgrnZka2HreLba0Ujwx4MjMDkeoAjbg/uW2jOgRgAHsY\n"\
"h0lBer2hP8NFqBPBBTNDwQ==\n"\
"-----END PRIVATE KEY-----\n";
*/</span>
std<span class="token double-colon punctuation">::</span>string publicKey <span class="token operator">=</span><span class="token string">"-----BEGIN PUBLIC KEY-----\n"</span>\
<span class="token string">"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjdKXiqYHzi++YmEb9X6q\n"</span>\
<span class="token string">"vqFWLCz1VEfxom2JhinPSJxxcuZWBejk2I5yCL5pDnUaG2xpQlMTkV/7S7JfGGvY\n"</span>\
<span class="token string">"JumKO4R5zg0QSA7qdxiEhcwf/ekfSvzM2EDnLHDCKAQwEWsnJy78uxZTLzu/65VZ\n"</span>\
<span class="token string">"7EgEcWUTvCs/GZJLI9s6XmKY2SMmv9+vfqBqkJNXE0ZB6OfSbyeE325P94iMn+B/\n"</span>\
<span class="token string">"yJ4vZwXvXGFqNDJyqG+ww7f77HYubQPJjLQPedy2qTcgmSAwkUEJVBjYA6mPf/Be\n"</span>\
<span class="token string">"ZlL1YJHHM7CIBnb3/bzED0n944woio+4+rnMZdfhcCVpm74DZomlEf9KuJtq5u/J\n"</span>\
<span class="token string">"RQIDAQAB\n"</span>\
<span class="token string">"-----END PUBLIC KEY-----\n"</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PUBLIC_KEY_FILE_EX</span>		<span class="token string">"publicEx.pem"</span>		<span class="token comment">//公钥文件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PRIVATE_KEY_FILE_EX</span>		<span class="token string">"privateEx.pem"</span>		<span class="token comment">//私钥文件</span></span>

<span class="token comment">//***生成公钥和私钥文件***</span>
<span class="token keyword">void</span> <span class="token function">GenerateKeyExx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 生成公钥 */</span>
	RSA<span class="token operator">*</span> rsa <span class="token operator">=</span> <span class="token function">RSA_generate_key</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> RSA_F4<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	BIO <span class="token operator">*</span>bp <span class="token operator">=</span> <span class="token function">BIO_new</span><span class="token punctuation">(</span><span class="token function">BIO_s_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">BIO_write_filename</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>PUBLIC_KEY_FILE_EX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">PEM_write_bio_RSAPublicKey</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> rsa<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">BIO_free_all</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token comment">/* 生成私钥 */</span>
	bp <span class="token operator">=</span> <span class="token function">BIO_new</span><span class="token punctuation">(</span><span class="token function">BIO_s_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">BIO_write_filename</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>PRIVATE_KEY_FILE_EX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">PEM_write_bio_RSAPrivateKey</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> rsa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CRYPTO_cleanup_all_ex_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">BIO_free_all</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RSA_free</span><span class="token punctuation">(</span>rsa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

RSA<span class="token operator">*</span> <span class="token function">createPrivateRSA</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    RSA <span class="token operator">*</span>rsa <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> c_string <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BIO <span class="token operator">*</span> keybio <span class="token operator">=</span> <span class="token function">BIO_new_mem_buf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>c_string<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keybio<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rsa <span class="token operator">=</span> <span class="token function">PEM_read_bio_RSAPrivateKey</span><span class="token punctuation">(</span>keybio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rsa<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rsa<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

RSA<span class="token operator">*</span> <span class="token function">createPublicRSA</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    RSA <span class="token operator">*</span>rsa <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    BIO <span class="token operator">*</span>keybio<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> c_string <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    keybio <span class="token operator">=</span> <span class="token function">BIO_new_mem_buf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>c_string<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keybio<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rsa <span class="token operator">=</span> <span class="token function">PEM_read_bio_RSA_PUBKEY</span><span class="token punctuation">(</span>keybio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rsa<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rsa<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

RSA<span class="token operator">*</span> <span class="token function">GetPublicKeyExx</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> szPath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	RSA <span class="token operator">*</span>pubkey <span class="token operator">=</span> <span class="token function">RSA_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	BIO <span class="token operator">*</span>pubio<span class="token punctuation">;</span>
 
	pubio <span class="token operator">=</span> <span class="token function">BIO_new_file</span><span class="token punctuation">(</span>szPath<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pubkey <span class="token operator">=</span> <span class="token function">PEM_read_bio_RSAPublicKey</span><span class="token punctuation">(</span>pubio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pubkey<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token function">BIO_free</span><span class="token punctuation">(</span>pubio<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token keyword">return</span> pubkey<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
RSA<span class="token operator">*</span> <span class="token function">GetPrivateKeyExx</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> szPath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	RSA <span class="token operator">*</span>prikey <span class="token operator">=</span> <span class="token function">RSA_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	BIO <span class="token operator">*</span>priio<span class="token punctuation">;</span>
 
	priio <span class="token operator">=</span> <span class="token function">BIO_new_file</span><span class="token punctuation">(</span>szPath<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	prikey <span class="token operator">=</span> <span class="token function">PEM_read_bio_RSAPrivateKey</span><span class="token punctuation">(</span>priio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prikey<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token function">BIO_free</span><span class="token punctuation">(</span>priio<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token keyword">return</span> prikey<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">RSASign</span><span class="token punctuation">(</span> RSA<span class="token operator">*</span> rsa<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> Msg<span class="token punctuation">,</span>
              size_t MsgLen<span class="token punctuation">,</span>
              <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> EncMsg<span class="token punctuation">,</span>
              size_t<span class="token operator">*</span> MsgLenEnc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    EVP_MD_CTX<span class="token operator">*</span> m_RSASignCtx <span class="token operator">=</span> <span class="token function">EVP_MD_CTX_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    EVP_PKEY<span class="token operator">*</span> priKey  <span class="token operator">=</span> <span class="token function">EVP_PKEY_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EVP_PKEY_assign_RSA</span><span class="token punctuation">(</span>priKey<span class="token punctuation">,</span> rsa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EVP_DigestSignInit</span><span class="token punctuation">(</span>m_RSASignCtx<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">EVP_sha256</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>priKey<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EVP_DigestSignUpdate</span><span class="token punctuation">(</span>m_RSASignCtx<span class="token punctuation">,</span> Msg<span class="token punctuation">,</span> MsgLen<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EVP_DigestSignFinal</span><span class="token punctuation">(</span>m_RSASignCtx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> MsgLenEnc<span class="token punctuation">)</span> <span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>EncMsg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token operator">*</span>MsgLenEnc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EVP_DigestSignFinal</span><span class="token punctuation">(</span>m_RSASignCtx<span class="token punctuation">,</span> <span class="token operator">*</span>EncMsg<span class="token punctuation">,</span> MsgLenEnc<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">EVP_MD_CTX_destroy</span><span class="token punctuation">(</span>m_RSASignCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EVP_PKEY_free</span><span class="token punctuation">(</span>priKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">RSAVerifySignature</span><span class="token punctuation">(</span> RSA<span class="token operator">*</span> rsa<span class="token punctuation">,</span>
                         <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> MsgHash<span class="token punctuation">,</span>
                         size_t MsgHashLen<span class="token punctuation">,</span>
                         <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> Msg<span class="token punctuation">,</span>
                         size_t MsgLen<span class="token punctuation">,</span>
                         <span class="token keyword">bool</span><span class="token operator">*</span> Authentic<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span>Authentic <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    EVP_PKEY<span class="token operator">*</span> pubKey  <span class="token operator">=</span> <span class="token function">EVP_PKEY_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EVP_PKEY_assign_RSA</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">,</span> rsa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    EVP_MD_CTX<span class="token operator">*</span> m_RSAVerifyCtx <span class="token operator">=</span> <span class="token function">EVP_MD_CTX_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EVP_DigestVerifyInit</span><span class="token punctuation">(</span>m_RSAVerifyCtx<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">EVP_sha256</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pubKey<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EVP_DigestVerifyUpdate</span><span class="token punctuation">(</span>m_RSAVerifyCtx<span class="token punctuation">,</span> Msg<span class="token punctuation">,</span> MsgLen<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> AuthStatus <span class="token operator">=</span> <span class="token function">EVP_DigestVerifyFinal</span><span class="token punctuation">(</span>m_RSAVerifyCtx<span class="token punctuation">,</span> MsgHash<span class="token punctuation">,</span> MsgHashLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>AuthStatus<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>Authentic <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">EVP_MD_CTX_destroy</span><span class="token punctuation">(</span>m_RSAVerifyCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">EVP_PKEY_free</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>AuthStatus<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>Authentic <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">EVP_MD_CTX_destroy</span><span class="token punctuation">(</span>m_RSAVerifyCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">EVP_PKEY_free</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>Authentic <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">EVP_MD_CTX_destroy</span><span class="token punctuation">(</span>m_RSAVerifyCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">EVP_PKEY_free</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Base64Encode</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span>
                   size_t length<span class="token punctuation">,</span>
                   <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> base64Text<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    BIO <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token operator">*</span>b64<span class="token punctuation">;</span>
    BUF_MEM <span class="token operator">*</span>bufferPtr<span class="token punctuation">;</span>

    b64 <span class="token operator">=</span> <span class="token function">BIO_new</span><span class="token punctuation">(</span><span class="token function">BIO_f_base64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bio <span class="token operator">=</span> <span class="token function">BIO_new</span><span class="token punctuation">(</span><span class="token function">BIO_s_mem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bio <span class="token operator">=</span> <span class="token function">BIO_push</span><span class="token punctuation">(</span>b64<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">BIO_write</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">BIO_flush</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">BIO_get_mem_ptr</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufferPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">BIO_set_close</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> BIO_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>base64Text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>bufferPtr<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>base64Text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"calloc base64Text failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">*</span>base64Text<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>bufferPtr<span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>bufferPtr<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">BIO_free_all</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

size_t <span class="token function">calcDecodeLength</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> b64input<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    size_t len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>b64input<span class="token punctuation">)</span><span class="token punctuation">,</span> padding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>b64input<span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'='</span> <span class="token operator">&amp;&amp;</span> b64input<span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'='</span><span class="token punctuation">)</span> <span class="token comment">//last two chars are =</span>
        padding <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b64input<span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'='</span><span class="token punctuation">)</span> <span class="token comment">//last char is =</span>
        padding <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>len<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span> <span class="token operator">-</span> padding<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Base64Decode</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> b64message<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t<span class="token operator">*</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    BIO <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token operator">*</span>b64<span class="token punctuation">;</span>

    <span class="token keyword">int</span> decodeLen <span class="token operator">=</span> <span class="token function">calcDecodeLength</span><span class="token punctuation">(</span>b64message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>decodeLen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>buffer<span class="token punctuation">)</span><span class="token punctuation">[</span>decodeLen<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

    bio <span class="token operator">=</span> <span class="token function">BIO_new_mem_buf</span><span class="token punctuation">(</span>b64message<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b64 <span class="token operator">=</span> <span class="token function">BIO_new</span><span class="token punctuation">(</span><span class="token function">BIO_f_base64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bio <span class="token operator">=</span> <span class="token function">BIO_push</span><span class="token punctuation">(</span>b64<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>length <span class="token operator">=</span> <span class="token function">BIO_read</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>b64message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">BIO_free_all</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">strToHex</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string plainText<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> hexArray<span class="token punctuation">;</span>
    hexArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>plainText<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> plainText<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        hexArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">strtol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>plainText<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> hexArray<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">signMessage</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string privateKey<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string plainText<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//  RSA* privateRSA = createPrivateRSA(privateKey);</span>
    RSA<span class="token operator">*</span> privateRSA <span class="token operator">=</span> <span class="token function">GetPrivateKeyExx</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> encMessage<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> base64Text<span class="token punctuation">;</span>
    size_t encMessageLength<span class="token punctuation">;</span>

    <span class="token function">RSASign</span><span class="token punctuation">(</span>privateRSA<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> plainText<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plainText<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>encMessage<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encMessageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Base64Encode</span><span class="token punctuation">(</span>encMessage<span class="token punctuation">,</span> encMessageLength<span class="token punctuation">,</span> <span class="token operator">&amp;</span>base64Text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>encMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> base64Text<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">verifySignature</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string publicKey<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string plainText<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> signatureBase64<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//    RSA* publicRSA = createPublicRSA(publicKey);</span>
    RSA<span class="token operator">*</span> publicRSA <span class="token operator">=</span> <span class="token function">GetPublicKeyExx</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> encMessage<span class="token punctuation">;</span>
    size_t encMessageLength<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> authentic<span class="token punctuation">;</span>
    <span class="token function">Base64Decode</span><span class="token punctuation">(</span>signatureBase64<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encMessage<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encMessageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> result <span class="token operator">=</span> <span class="token function">RSAVerifySignature</span><span class="token punctuation">(</span>publicRSA<span class="token punctuation">,</span> encMessage<span class="token punctuation">,</span> encMessageLength<span class="token punctuation">,</span> plainText<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plainText<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>authentic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>encMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result <span class="token operator">&amp;</span> authentic<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">GenerateKeyExx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>string plainText <span class="token operator">=</span> <span class="token string">"ET8d1voUkzNcqud7M8W0WQcd3l2Ih1ZtiMxStPeubKg="</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>string strData <span class="token operator">=</span> <span class="token string">"MIICXwIBAAKBgQDNrGwRjt6l6ABjFcsoMU8MM7GjC4akItMjpD9brnZayudxsns8/h0HDzw0XkpCmGUTPGN+NBGBkitpoIcJnWz0z6eM6K9P7rytUeM0cXC+zCrlIxUN"</span><span class="token punctuation">;</span>
	
	<span class="token keyword">char</span><span class="token operator">*</span> signature <span class="token operator">=</span> <span class="token function">signMessage</span><span class="token punctuation">(</span>PRIVATE_KEY_FILE_EX<span class="token punctuation">,</span> strData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">bool</span> authentic <span class="token operator">=</span> <span class="token function">verifySignature</span><span class="token punctuation">(</span>PUBLIC_KEY_FILE_EX<span class="token punctuation">,</span> strData<span class="token punctuation">,</span> signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> authentic <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Authentic"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
	    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> signature <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Not Authentic"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">free</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>参考链接：<br> 这个好像有点问题，但是我没找到😀。<br> https://blog.csdn.net/Best_ZYJ/article/details/101029719</p> 
<p>https://stackoverflow.com/questions/59204804/incorrect-signature-with-rsa-and-sha256</p> 
<p>验证网站：<br> http://www.metools.info/code/c82.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1ac7dd8b67dba9a2d4a49e888372d661/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PostgreSQL基础&#43;部署</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f3e62c5d278928ff8da47d0d5a7d6941/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023 蓝桥杯 A组 蒟蒻代码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>