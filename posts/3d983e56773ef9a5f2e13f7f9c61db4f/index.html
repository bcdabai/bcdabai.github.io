<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mmdetection3d可视化多模态模型推理结果 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mmdetection3d可视化多模态模型推理结果" />
<meta property="og:description" content="本篇博文讲一下mmdetection3d可视化 参考文献:
带你玩转 3D 检测和分割 （三）：有趣的可视化 - 知乎 (zhihu.com)
Welcome to MMDetection3D’s documentation! — MMDetection3D 1.0.0rc4 文档
1、介绍 让我们看一下ChatGPT的回答[手动狗头]:
mmdetection3D是基于PyTorch框架的3D目标检测工具包，它是mmdetection的3D扩展版本。它提供了一个灵活且高效的框架，可以训练和测试各种3D目标检测算法，包括点云、体积数据和混合数据。
mmdetection3D的主要特点包括：
灵活的模块化设计：模块化设计使得用户可以轻松地构建自己的检测算法，并且可以很方便地替换各种组件，如骨干网络、头部网络和损失函数等。
高效的训练和推断：mmdetection3D支持分布式训练，可以在多GPU和多机器上进行训练。此外，它还支持多线程数据加载和多进程测试，从而提高了训练和推断的效率。
多样化的数据格式支持：mmdetection3D支持多种3D数据格式，包括点云、体积数据和混合数据。同时，它还支持多种数据增强方法，从而可以生成更多的训练数据，提高模型的鲁棒性。
容易使用的API：mmdetection3D提供了易于使用的API，用户可以轻松地使用它进行模型训练、测试和部署。
总之，mmdetection3D是一个强大且易于使用的3D目标检测工具包，它可以帮助研究人员和工程师快速地开发和部署各种3D目标检测算法。
mmdetection3d也提供了众多预训练模型，可以让我们很容易的了解一下3D目标检测的整个流程
2、需求 本次需求较为简单，主要是使用预训练模型，完成推理，并将结果绘制到图像中，便于可视化
结合实际，我需要得到的结果精度尽可能高，所以我选择了MVXNet这一多模态融合的检测方案
3、API分析 mmdetection3d提供了大量封装好的API，我们可以直接拿来用。本次使用到的API如下所示：
init_model: 通过配置文件、chekpoint_file（可选）构建一个模型
build_datasets：通过配置文件，构建数据集，得到包含所有数据的列表
show_multi_modality_result：将3D bbox投影到图像，并保存
inference_multi_modality_detector：构建多模态检测器，稍后会详细解释各个参数。如果不选用多模态方案，此处可以选择其他的API，有时间会写一下
4、实战 4.1 inference_multi_modality_detector解读 我们先来看一下最关键的inference_multi_modality_detector，它位于mmdet3d/apis/inference.py中，代码我就不贴了，我们看一下它的参数：
Args: model (nn.Module): The loaded detector. pcd (str): Point cloud files. image (str): Image files. ann_file (str): Annotation files. Returns: tuple: Predicted results and data from pipeline. &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3d983e56773ef9a5f2e13f7f9c61db4f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-26T11:07:09+08:00" />
<meta property="article:modified_time" content="2023-03-26T11:07:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mmdetection3d可视化多模态模型推理结果</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="mmdetection3d_0"></a>本篇博文讲一下mmdetection3d可视化</h2> 
<blockquote> 
 <p>参考文献:</p> 
 <p><a href="https://zhuanlan.zhihu.com/p/504862433" rel="nofollow">带你玩转 3D 检测和分割 （三）：有趣的可视化 - 知乎 (zhihu.com)</a></p> 
 <p><a href="https://mmdetection3d.readthedocs.io/zh_CN/latest/" rel="nofollow">Welcome to MMDetection3D’s documentation! — MMDetection3D 1.0.0rc4 文档</a></p> 
</blockquote> 
<h3><a id="1_8"></a>1、介绍</h3> 
<p>让我们看一下ChatGPT的回答[手动狗头]:</p> 
<blockquote> 
 <p>mmdetection3D是基于PyTorch框架的3D目标检测工具包，它是mmdetection的3D扩展版本。它提供了一个灵活且高效的框架，可以训练和测试各种3D目标检测算法，包括点云、体积数据和混合数据。</p> 
 <p>mmdetection3D的主要特点包括：</p> 
 <ul><li> <p>灵活的模块化设计：模块化设计使得用户可以轻松地构建自己的检测算法，并且可以很方便地替换各种组件，如骨干网络、头部网络和损失函数等。</p> </li><li> <p>高效的训练和推断：mmdetection3D支持分布式训练，可以在多GPU和多机器上进行训练。此外，它还支持多线程数据加载和多进程测试，从而提高了训练和推断的效率。</p> </li><li> <p>多样化的数据格式支持：mmdetection3D支持多种3D数据格式，包括点云、体积数据和混合数据。同时，它还支持多种数据增强方法，从而可以生成更多的训练数据，提高模型的鲁棒性。</p> </li><li> <p>容易使用的API：mmdetection3D提供了易于使用的API，用户可以轻松地使用它进行模型训练、测试和部署。</p> </li><li> <p>总之，mmdetection3D是一个强大且易于使用的3D目标检测工具包，它可以帮助研究人员和工程师快速地开发和部署各种3D目标检测算法。</p> </li></ul> 
</blockquote> 
<p>mmdetection3d也提供了众多预训练模型，可以让我们很容易的了解一下3D目标检测的整个流程</p> 
<h3><a id="2_28"></a>2、需求</h3> 
<p>本次需求较为简单，主要是使用预训练模型，完成推理，并将结果绘制到图像中，便于可视化</p> 
<p>结合实际，我需要得到的结果精度尽可能高，所以我选择了MVXNet这一多模态融合的检测方案</p> 
<h3><a id="3API_34"></a>3、API分析</h3> 
<p>mmdetection3d提供了大量封装好的API，我们可以直接拿来用。本次使用到的API如下所示：</p> 
<ul><li> <p>init_model: 通过配置文件、chekpoint_file（可选）构建一个模型</p> </li><li> <p>build_datasets：通过配置文件，构建数据集，得到包含所有数据的列表</p> </li><li> <p>show_multi_modality_result：将3D bbox投影到图像，并保存</p> </li><li> <p>inference_multi_modality_detector：构建多模态检测器，稍后会详细解释各个参数。如果不选用多模态方案，此处可以选择其他的API，有时间会写一下</p> </li></ul> 
<h3><a id="4_44"></a>4、实战</h3> 
<h4><a id="41_inference_multi_modality_detector_46"></a>4.1 inference_multi_modality_detector解读</h4> 
<p>我们先来看一下最关键的<strong>inference_multi_modality_detector</strong>，它位于mmdet3d/apis/inference.py中，代码我就不贴了，我们看一下它的参数：</p> 
<pre><code class="prism language-python">Args<span class="token punctuation">:</span>
    model <span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span> The loaded detector<span class="token punctuation">.</span>
    pcd <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Point cloud files<span class="token punctuation">.</span>
    image <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Image files<span class="token punctuation">.</span>
    ann_file <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Annotation files<span class="token punctuation">.</span>
Returns<span class="token punctuation">:</span>
    <span class="token builtin">tuple</span><span class="token punctuation">:</span> Predicted results <span class="token keyword">and</span> data <span class="token keyword">from</span> pipeline<span class="token punctuation">.</span>
<span class="token string">""</span>"
</code></pre> 
<p>它接收一个模型、点云文件、图像文件、还有参数文件。模型、点云、图像一眼明白，这个ann_file大家可能会觉得一头雾水，demo/data/kitti下给我们了一个样例注释文件，我们使用下面代码看一下这个参数文件里有什么</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pickle
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'demo/data/kitti/kitti_000008_infos.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre> 
<p>输出如下，是一个长度为1的列表，列表项为字典，里面记录了图像、点云路径，还有一些内参外参，投影矩阵巴拉巴拉巴拉:</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">'image'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">'image_idx'</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string-property property">'image_path'</span><span class="token operator">:</span> <span class="token string">'training/image_2/000008.png'</span><span class="token punctuation">,</span> <span class="token string-property property">'image_shape'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">375</span><span class="token punctuation">,</span> <span class="token number">1242</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">'point_cloud'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">'num_features'</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string-property property">'velodyne_path'</span><span class="token operator">:</span> <span class="token string">'training/velodyne/000008.bin'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">'calib'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">'P0'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">721.5377</span><span class="token punctuation">,</span>   <span class="token number">0.</span>    <span class="token punctuation">,</span> <span class="token number">609.5593</span><span class="token punctuation">,</span>   <span class="token number">0.</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">0.</span>    <span class="token punctuation">,</span> <span class="token number">721.5377</span><span class="token punctuation">,</span> <span class="token number">172.854</span> <span class="token punctuation">,</span>   <span class="token number">0.</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">0.</span>    <span class="token punctuation">,</span>   <span class="token number">0.</span>    <span class="token punctuation">,</span>   <span class="token number">1.</span>    <span class="token punctuation">,</span>   <span class="token number">0.</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">0.</span>    <span class="token punctuation">,</span>   <span class="token number">0.</span>    <span class="token punctuation">,</span>   <span class="token number">0.</span>    <span class="token punctuation">,</span>   <span class="token number">1.</span>    <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'P1'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">721.5377</span><span class="token punctuation">,</span>    <span class="token number">0.</span>    <span class="token punctuation">,</span>  <span class="token number">609.5593</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">387.5744</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>   <span class="token number">0.</span>    <span class="token punctuation">,</span>  <span class="token number">721.5377</span><span class="token punctuation">,</span>  <span class="token number">172.854</span> <span class="token punctuation">,</span>    <span class="token number">0.</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>   <span class="token number">0.</span>    <span class="token punctuation">,</span>    <span class="token number">0.</span>    <span class="token punctuation">,</span>    <span class="token number">1.</span>    <span class="token punctuation">,</span>    <span class="token number">0.</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>   <span class="token number">0.</span>    <span class="token punctuation">,</span>    <span class="token number">0.</span>    <span class="token punctuation">,</span>    <span class="token number">0.</span>    <span class="token punctuation">,</span>    <span class="token number">1.</span>    <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'P2'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">7.215377e+02</span><span class="token punctuation">,</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span> <span class="token number">6.095593e+02</span><span class="token punctuation">,</span> <span class="token number">4.485728e+01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0.000000e+00</span><span class="token punctuation">,</span> <span class="token number">7.215377e+02</span><span class="token punctuation">,</span> <span class="token number">1.728540e+02</span><span class="token punctuation">,</span> <span class="token number">2.163791e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0.000000e+00</span><span class="token punctuation">,</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span> <span class="token number">1.000000e+00</span><span class="token punctuation">,</span> <span class="token number">2.745884e-03</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0.000000e+00</span><span class="token punctuation">,</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span> <span class="token number">1.000000e+00</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'P3'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">7.215377e+02</span><span class="token punctuation">,</span>  <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">6.095593e+02</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.395242e+02</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">7.215377e+02</span><span class="token punctuation">,</span>  <span class="token number">1.728540e+02</span><span class="token punctuation">,</span>  <span class="token number">2.199936e+00</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">1.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">2.729905e-03</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">1.000000e+00</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'R0_rect'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0.9999239</span> <span class="token punctuation">,</span>  <span class="token number">0.00983776</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.00744505</span><span class="token punctuation">,</span>  <span class="token number">0.</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.0098698</span> <span class="token punctuation">,</span>  <span class="token number">0.9999421</span> <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.00427846</span><span class="token punctuation">,</span>  <span class="token number">0.</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.00740253</span><span class="token punctuation">,</span>  <span class="token number">0.00435161</span><span class="token punctuation">,</span>  <span class="token number">0.9999631</span> <span class="token punctuation">,</span>  <span class="token number">0.</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.</span>        <span class="token punctuation">,</span>  <span class="token number">0.</span>        <span class="token punctuation">,</span>  <span class="token number">0.</span>        <span class="token punctuation">,</span>  <span class="token number">1.</span>        <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'Tr_velo_to_cam'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">7.533745e-03</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">9.999714e-01</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6.166020e-04</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.069766e-03</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.480249e-02</span><span class="token punctuation">,</span>  <span class="token number">7.280733e-04</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">9.998902e-01</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7.631618e-02</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">9.998621e-01</span><span class="token punctuation">,</span>  <span class="token number">7.523790e-03</span><span class="token punctuation">,</span>  <span class="token number">1.480755e-02</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.717806e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">1.000000e+00</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'Tr_imu_to_velo'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">9.999976e-01</span><span class="token punctuation">,</span>  <span class="token number">7.553071e-04</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.035826e-03</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8.086759e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">7.854027e-04</span><span class="token punctuation">,</span>  <span class="token number">9.998898e-01</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.482298e-02</span><span class="token punctuation">,</span>  <span class="token number">3.195559e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">2.024406e-03</span><span class="token punctuation">,</span>  <span class="token number">1.482454e-02</span><span class="token punctuation">,</span>  <span class="token number">9.998881e-01</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7.997231e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">0.000000e+00</span><span class="token punctuation">,</span>  <span class="token number">1.000000e+00</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">'annos'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">'name'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Car'</span><span class="token punctuation">,</span> <span class="token string">'Car'</span><span class="token punctuation">,</span> <span class="token string">'Car'</span><span class="token punctuation">,</span> <span class="token string">'Car'</span><span class="token punctuation">,</span> <span class="token string">'Car'</span><span class="token punctuation">,</span> <span class="token string">'Car'</span><span class="token punctuation">,</span> <span class="token string">'DontCare'</span><span class="token punctuation">,</span> <span class="token string">'DontCare'</span><span class="token punctuation">,</span>
       <span class="token string">'DontCare'</span><span class="token punctuation">,</span> <span class="token string">'DontCare'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'&lt;U8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'truncated'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">0.88</span><span class="token punctuation">,</span>  <span class="token number">0.</span>  <span class="token punctuation">,</span>  <span class="token number">0.34</span><span class="token punctuation">,</span>  <span class="token number">0.</span>  <span class="token punctuation">,</span>  <span class="token number">0.</span>  <span class="token punctuation">,</span>  <span class="token number">0.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span>
       <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'occluded'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'alpha'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">0.69</span><span class="token punctuation">,</span>   <span class="token number">2.04</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1.84</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1.33</span><span class="token punctuation">,</span>   <span class="token number">1.74</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1.65</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10.</span>  <span class="token punctuation">,</span>
       <span class="token operator">-</span><span class="token number">10.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10.</span>  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'bbox'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>   <span class="token number">0.</span>  <span class="token punctuation">,</span>  <span class="token number">192.37</span><span class="token punctuation">,</span>  <span class="token number">402.31</span><span class="token punctuation">,</span>  <span class="token number">374.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">334.85</span><span class="token punctuation">,</span>  <span class="token number">178.94</span><span class="token punctuation">,</span>  <span class="token number">624.5</span> <span class="token punctuation">,</span>  <span class="token number">372.04</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">937.29</span><span class="token punctuation">,</span>  <span class="token number">197.39</span><span class="token punctuation">,</span> <span class="token number">1241.</span>  <span class="token punctuation">,</span>  <span class="token number">374.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">597.59</span><span class="token punctuation">,</span>  <span class="token number">176.18</span><span class="token punctuation">,</span>  <span class="token number">720.9</span> <span class="token punctuation">,</span>  <span class="token number">261.14</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">741.18</span><span class="token punctuation">,</span>  <span class="token number">168.83</span><span class="token punctuation">,</span>  <span class="token number">792.25</span><span class="token punctuation">,</span>  <span class="token number">208.43</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">884.52</span><span class="token punctuation">,</span>  <span class="token number">178.31</span><span class="token punctuation">,</span>  <span class="token number">956.41</span><span class="token punctuation">,</span>  <span class="token number">240.18</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">800.38</span><span class="token punctuation">,</span>  <span class="token number">163.67</span><span class="token punctuation">,</span>  <span class="token number">825.45</span><span class="token punctuation">,</span>  <span class="token number">184.07</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">859.58</span><span class="token punctuation">,</span>  <span class="token number">172.34</span><span class="token punctuation">,</span>  <span class="token number">886.26</span><span class="token punctuation">,</span>  <span class="token number">194.51</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">801.81</span><span class="token punctuation">,</span>  <span class="token number">163.96</span><span class="token punctuation">,</span>  <span class="token number">825.2</span> <span class="token punctuation">,</span>  <span class="token number">183.59</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">826.87</span><span class="token punctuation">,</span>  <span class="token number">162.28</span><span class="token punctuation">,</span>  <span class="token number">845.84</span><span class="token punctuation">,</span>  <span class="token number">178.86</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'dimensions'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">3.23</span><span class="token punctuation">,</span>  <span class="token number">1.6</span> <span class="token punctuation">,</span>  <span class="token number">1.57</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">3.68</span><span class="token punctuation">,</span>  <span class="token number">1.57</span><span class="token punctuation">,</span>  <span class="token number">1.5</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">3.08</span><span class="token punctuation">,</span>  <span class="token number">1.39</span><span class="token punctuation">,</span>  <span class="token number">1.44</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">3.66</span><span class="token punctuation">,</span>  <span class="token number">1.47</span><span class="token punctuation">,</span>  <span class="token number">1.6</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">4.08</span><span class="token punctuation">,</span>  <span class="token number">1.7</span> <span class="token punctuation">,</span>  <span class="token number">1.63</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">2.47</span><span class="token punctuation">,</span>  <span class="token number">1.59</span><span class="token punctuation">,</span>  <span class="token number">1.59</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'location'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>   <span class="token operator">-</span><span class="token number">2.7</span> <span class="token punctuation">,</span>     <span class="token number">1.74</span><span class="token punctuation">,</span>     <span class="token number">3.68</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>   <span class="token operator">-</span><span class="token number">1.17</span><span class="token punctuation">,</span>     <span class="token number">1.65</span><span class="token punctuation">,</span>     <span class="token number">7.86</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>    <span class="token number">3.81</span><span class="token punctuation">,</span>     <span class="token number">1.64</span><span class="token punctuation">,</span>     <span class="token number">6.15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>    <span class="token number">1.07</span><span class="token punctuation">,</span>     <span class="token number">1.55</span><span class="token punctuation">,</span>    <span class="token number">14.44</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>    <span class="token number">7.24</span><span class="token punctuation">,</span>     <span class="token number">1.55</span><span class="token punctuation">,</span>    <span class="token number">33.2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>    <span class="token number">8.48</span><span class="token punctuation">,</span>     <span class="token number">1.75</span><span class="token punctuation">,</span>    <span class="token number">19.96</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000.</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'rotation_y'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">1.29</span><span class="token punctuation">,</span>   <span class="token number">1.9</span> <span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1.31</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1.25</span><span class="token punctuation">,</span>   <span class="token number">1.95</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1.25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10.</span>  <span class="token punctuation">,</span>
       <span class="token operator">-</span><span class="token number">10.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10.</span>  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'score'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'index'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'group_ids'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'difficulty'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">'num_points_in_gt'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1325</span><span class="token punctuation">,</span> <span class="token number">1900</span><span class="token punctuation">,</span>  <span class="token number">881</span><span class="token punctuation">,</span>  <span class="token number">659</span><span class="token punctuation">,</span>   <span class="token number">55</span><span class="token punctuation">,</span>  <span class="token number">162</span><span class="token punctuation">,</span>   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> 
<h4><a id="42_ann_file_128"></a>4.2 获取ann_file</h4> 
<p>要想使用inference_multi_modality_detector进行推理，就必须获取这个关键的ann_file，我们使用mmdetection3d中搭建完环境后，就必须使用其提供的tools组织数据集，最后会生成若干pkl文件（适用于点云）和json（适用于图像）。我们基于KITTI数据集，获取组织好的pkl文件，这里使用训练集kitti_infos_train.pkl，用上面查看pkl文件的代码看一下，大同小异，只不过是列表的长度变长了，为了便于inference_multi_modality_detector使用，我们把列表拆分，逐个存储，下面代码说明如何获取每个点云/图像对应的ann_file：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pickle

<span class="token comment"># 读取KITTI数据集训练组织文件</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'pkl/kitti_infos_train.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"训练集长度:"</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

use_num <span class="token operator">=</span> <span class="token number">50</span>  <span class="token comment"># 取训练集的前50条数据（根据自己需求定）</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image_path'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 拆分出文件名来</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> use_num<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token builtin">list</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    cur_data <span class="token operator">=</span> <span class="token builtin">list</span> <span class="token comment"># 将当前注释存储到列表</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>cur_data<span class="token punctuation">)</span>
    file_name <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image_path'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    save_path <span class="token operator">=</span> <span class="token string">'kitti_pkl_output/'</span>
    <span class="token comment"># 保存文件</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'kitti_'</span> <span class="token operator">+</span> file_name <span class="token operator">+</span> <span class="token string">'_infos.pkl'</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>cur_data<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
</code></pre> 
<p>最终得到一系列pkl文件：</p> 
<p><img src="https://images2.imgbox.com/ee/10/Krxav55o_o.png" alt="image-20230326104816912"></p> 
<h4><a id="43__159"></a>4.3 构建模型并完成推理</h4> 
<ol><li> <p>构建模型</p> <pre><code class="prism language-python"><span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>apis <span class="token keyword">import</span> init_model
<span class="token comment"># 构建预训练模型</span>
config_file <span class="token operator">=</span> <span class="token string">'/home/wistful/work/mmdetection3d/configs/my_config/my_dv_mvx-fpn_second_secfpn_adamw_2x8_80e_kitti-3d-3class.py'</span>
chekpoint_file <span class="token operator">=</span> <span class="token string">'/home/wistful/ResultDir/my_pth/mxvnet/dv_mvx-fpn_second_secfpn_adamw_2x8_80e_kitti-3d-3class_20210831_060805-83442923.pth'</span>
model <span class="token operator">=</span> init_model<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> chekpoint_file<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">)</span>
</code></pre> </li><li> <p>构建数据集</p> <pre><code class="prism language-python"><span class="token comment"># 构建数据集，此处选用KITTI多模态数据，便于可视化</span>
<span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> build_dataset
<span class="token keyword">from</span> mmcv <span class="token keyword">import</span> Config
<span class="token keyword">import</span> os

os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span><span class="token string">'/home/wistful/work/mmdetection3d/'</span><span class="token punctuation">)</span>
config_file <span class="token operator">=</span> <span class="token string">'configs/_base_/datasets/kitti-3d-3class-multi.py'</span>
cfg <span class="token operator">=</span> Config<span class="token punctuation">.</span>fromfile<span class="token punctuation">(</span>config_file<span class="token punctuation">)</span>

datasets <span class="token operator">=</span> <span class="token punctuation">[</span>build_dataset<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>train<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <p>为什么要使用配置文件这样构建数据集，因为4.1中也提到了，inference_multi_modality_detector需要同时接收点云和图像文件作为输入，使用上述方案构建数据集，可以很方便的获取，每一项数据都包含了图像信息、点云、图像、地面真相等信息，我们只需要遍历就可以了</p> <p><img src="https://images2.imgbox.com/37/8d/aVQ776iZ_o.png" alt="image-20230326105050776"></p> </li><li> <p>推理并保存可视化图像</p> <pre><code class="prism language-python"><span class="token comment"># 遍历n条数据用于可视化</span>
<span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>core<span class="token punctuation">.</span>visualizer <span class="token keyword">import</span> show_multi_modality_result
<span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>apis <span class="token keyword">import</span> inference_multi_modality_detector

out_dir <span class="token operator">=</span> <span class="token string">"/home/wistful/work/mmdetection3d/visual_img/kitti/"</span>
pkl_dir <span class="token operator">=</span> <span class="token string">'/home/wistful/work/mmdetection3d/data/kitti/kitti_pkl_output/'</span>

num <span class="token operator">=</span> <span class="token number">50</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cur_data <span class="token operator">=</span> datasets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment"># 遍历数据集</span>
    img_metas <span class="token operator">=</span> cur_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'img_metas'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data  <span class="token comment"># 获取图像原始信息</span>
    pts_file <span class="token operator">=</span> img_metas<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'pts_filename'</span><span class="token punctuation">)</span>  <span class="token comment"># 获取点云</span>
    img <span class="token operator">=</span> cur_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data <span class="token comment"># 获取图像</span>
    img_file_path <span class="token operator">=</span> img_metas<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">)</span> <span class="token comment"># 获取图像文件名</span>
    name <span class="token operator">=</span> img_file_path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># 分离名称</span>
    ann_file <span class="token operator">=</span> pkl_dir <span class="token operator">+</span> <span class="token string">'kitti_'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'_infos.pkl'</span> <span class="token comment"># 得到对应ann_file</span>
    project_mat <span class="token operator">=</span> img_metas<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'lidar2img'</span><span class="token punctuation">)</span> <span class="token comment"># 获取投影矩阵</span>
    result<span class="token punctuation">,</span> data <span class="token operator">=</span> inference_multi_modality_detector<span class="token punctuation">(</span>model<span class="token punctuation">,</span> pts_file<span class="token punctuation">,</span> img_file_path<span class="token punctuation">,</span> ann_file<span class="token punctuation">)</span>  <span class="token comment"># 推理</span>
    bboxes_data <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'pts_bbox'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'boxes_3d'</span><span class="token punctuation">]</span> <span class="token comment"># 提取结果中的3D bbox</span>
    <span class="token comment"># 保存可视化图像</span>
    show_multi_modality_result<span class="token punctuation">(</span>img<span class="token operator">=</span>image<span class="token punctuation">,</span>
                               box_mode<span class="token operator">=</span><span class="token string">'lidar'</span><span class="token punctuation">,</span>
                               gt_bboxes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                               img_metas<span class="token operator">=</span>img_metas<span class="token punctuation">,</span>
                               pred_bboxes<span class="token operator">=</span>bboxes_data<span class="token punctuation">,</span>
                               proj_mat<span class="token operator">=</span>project_mat<span class="token punctuation">,</span>
                               out_dir<span class="token operator">=</span><span class="token string">"/home/wistful/work/mmdetection3d/visual_img/kitti/"</span><span class="token punctuation">,</span>
                               filename<span class="token operator">=</span>name<span class="token punctuation">,</span>
                               show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <p>我还对show_multi_modality_result做了下修改，只产生预测，并将结果保存在同一个文件夹中，这个很简单，就不展开了</p> </li></ol> 
<h3><a id="5_226"></a>5、结果</h3> 
<p><img src="https://images2.imgbox.com/2c/ab/ra3H4tDc_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/85/47/p0OApT3j_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1b/d5/Eb323stJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1e/1f/3yFMWDd7_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/54/52/Rz7UcRHH_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e1f3a181e48f69bfd0a54e9b91e4b9d2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Invoke-WebRequest : 找不到与参数名称“X”匹配的参数。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/77db16d6f2b4551cb053bfc9e40f0dd3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">网易云音乐在线解析API接口</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>