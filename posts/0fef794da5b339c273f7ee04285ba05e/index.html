<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android广播发送流程(广播3) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android广播发送流程(广播3)" />
<meta property="og:description" content="Android广播发送流程 1. 广播发送流程2. 广播发送3. 系统处理广播发送3.1 AMS接收广播的请求3.2 修改增加默认flag解析可选广播参数BroadcastOptions3.4 保护广播isProtectedBroadcast、特定action的处理3.5 发送粘性广播的处理3.6 筛选出静态广播接受者3.7 筛选出动态广播接受者3.8 非oder的平行广播的入队与分发3.8 order广播接收者的过滤 4. 广播队列的处理4.1 新建广播队列4.2 广播接收者入队列4.3 广播队列的分发4.4 处理分发下一个广播4.4.1 mParallelBroadcasts平行广播的分发4.4.2 mPendingBroadcast挂起广播的处理4.4.3 取出下一个有序队列中的广播4.4.4 处理下一个接收者nextReceiver4.4.5 发送给动态注册的order注册者4.4.6 静态注册者跳过的逻辑4.4.7 发送给已经启动了的静态注册者4.4.8 启动静态注册接收者的进程 4.5 广播接收者处理完成4.5.1 广播完成，开始下一个广播的调度4.5.2 广播完成finishReceiverLocked 5. 广播的拓展使用 1. 广播发送流程 这次我们讲一下广播发送的流程，老规矩先上大概的流程图
2. 广播发送 常见的通过ContextImpl.java发送广播的方法有下面几种
=&gt; sendBroadcast/sendBroadcastAsUser ：普通的广播发送，默认是当前userId，带有“AsUser”的是发送给特定的user
=&gt; sendBroadcastMultiplePermissions/sendBroadcastAsUserMultiplePermissions ：带有多个权限的广播发送
=&gt; sendOrderedBroadcast/sendOrderedBroadcastAsUser ：发送order有序的广播(order广播是一个接收完成下一个才能接收，接收者一个个按顺序接收)
=&gt; sendStickyBroadcast/sendStickyBroadcastAsUser ：发送粘性广播，粘性广播的意思是注册者注册了就马上能收到该类型(之前已经发送的粘性广播)的广播，
接收者的注册不需要在发送者的前面
=&gt; sendStickyOrderedBroadcast/sendStickyOrderedBroadcastAsUser ：发送粘性而且是顺序order的广播 它们都是调用AMS的broadcastIntentWithFeature来发送广播
如下面是最简单的只有一个Intent的广播发送
//ContextImpl.java @Override public void sendBroadcast(Intent intent) { warnIfCallingFromSystemProcess(); String resolvedType = intent.resolveTypeIfNeeded(getContentResolver()); try { intent." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0fef794da5b339c273f7ee04285ba05e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-10T20:26:45+08:00" />
<meta property="article:modified_time" content="2023-06-10T20:26:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android广播发送流程(广播3)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Android广播发送流程</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1. 广播发送流程</a></li><li><a href="#2__11" rel="nofollow">2. 广播发送</a></li><li><a href="#3__140" rel="nofollow">3. 系统处理广播发送</a></li><li><ul><li><a href="#31_AMS_142" rel="nofollow">3.1 AMS接收广播的请求</a></li><li><a href="#32_flagBroadcastOptions_197" rel="nofollow">3.2 修改增加默认flag解析可选广播参数BroadcastOptions</a></li><li><a href="#34_isProtectedBroadcastaction_353" rel="nofollow">3.4 保护广播isProtectedBroadcast、特定action的处理</a></li><li><a href="#35__731" rel="nofollow">3.5 发送粘性广播的处理</a></li><li><a href="#36__832" rel="nofollow">3.6 筛选出静态广播接受者</a></li><li><a href="#37__1167" rel="nofollow">3.7 筛选出动态广播接受者</a></li><li><a href="#38_oder_1443" rel="nofollow">3.8 非oder的平行广播的入队与分发</a></li><li><a href="#38_order_1514" rel="nofollow">3.8 order广播接收者的过滤</a></li></ul> 
  </li><li><a href="#4__1695" rel="nofollow">4. 广播队列的处理</a></li><li><ul><li><a href="#41__1701" rel="nofollow">4.1 新建广播队列</a></li><li><a href="#42__1759" rel="nofollow">4.2 广播接收者入队列</a></li><li><a href="#43__1791" rel="nofollow">4.3 广播队列的分发</a></li><li><a href="#44__1852" rel="nofollow">4.4 处理分发下一个广播</a></li><li><ul><li><a href="#441_mParallelBroadcasts_1858" rel="nofollow">4.4.1 mParallelBroadcasts平行广播的分发</a></li><li><a href="#442_mPendingBroadcast_2311" rel="nofollow">4.4.2 mPendingBroadcast挂起广播的处理</a></li><li><a href="#443__2382" rel="nofollow">4.4.3 取出下一个有序队列中的广播</a></li><li><a href="#444_nextReceiver_2739" rel="nofollow">4.4.4 处理下一个接收者nextReceiver</a></li><li><a href="#445_order_2796" rel="nofollow">4.4.5 发送给动态注册的order注册者</a></li><li><a href="#446__2845" rel="nofollow">4.4.6 静态注册者跳过的逻辑</a></li><li><a href="#447__3186" rel="nofollow">4.4.7 发送给已经启动了的静态注册者</a></li><li><a href="#448__3435" rel="nofollow">4.4.8 启动静态注册接收者的进程</a></li></ul> 
   </li><li><a href="#45__3754" rel="nofollow">4.5 广播接收者处理完成</a></li><li><ul><li><a href="#451__3758" rel="nofollow">4.5.1 广播完成，开始下一个广播的调度</a></li><li><a href="#452_finishReceiverLocked_3811" rel="nofollow">4.5.2 广播完成finishReceiverLocked</a></li></ul> 
  </li></ul> 
  </li><li><a href="#5__3945" rel="nofollow">5. 广播的拓展使用</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__4"></a>1. 广播发送流程</h2> 
<p>这次我们讲一下广播发送的流程，老规矩先上大概的流程图<br> <img src="https://images2.imgbox.com/7c/b4/ZncWFRLe_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2__11"></a>2. 广播发送</h2> 
<ol><li>常见的通过ContextImpl.java发送广播的方法有下面几种<br> =&gt; sendBroadcast/sendBroadcastAsUser ：普通的广播发送，默认是当前userId，带有“AsUser”的是发送给特定的user<br> =&gt; sendBroadcastMultiplePermissions/sendBroadcastAsUserMultiplePermissions ：带有多个权限的广播发送<br> =&gt; sendOrderedBroadcast/sendOrderedBroadcastAsUser ：发送order有序的广播(order广播是一个接收完成下一个才能接收，接收者一个个按顺序接收)<br> =&gt; sendStickyBroadcast/sendStickyBroadcastAsUser ：发送粘性广播，粘性广播的意思是注册者注册了就马上能收到该类型(之前已经发送的粘性广播)的广播，<br> 接收者的注册不需要在发送者的前面<br> =&gt; sendStickyOrderedBroadcast/sendStickyOrderedBroadcastAsUser ：发送粘性而且是顺序order的广播</li></ol> 
<p>它们都是调用AMS的broadcastIntentWithFeature来发送广播</p> 
<p>如下面是最简单的只有一个Intent的广播发送</p> 
<pre><code class="prism language-java"><span class="token comment">//ContextImpl.java</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBroadcast</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">warnIfCallingFromSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String resolvedType <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//调用的是AMS的broadcastIntentWithFeature来发送广播</span>
            ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcastIntentWithFeature</span><span class="token punctuation">(</span>
                    mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getAttributionTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    null<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_OK<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null <span class="token comment">/*excludedPermissions=*/</span><span class="token punctuation">,</span>
                    AppOpsManager<span class="token punctuation">.</span>OP_NONE<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>还是以亮屏SCREEN_ON的广播继续讲解其发送流程<br> 其调用方法是sendOrderedBroadcastAsUser(ContextImpl.java)-&gt;broadcastIntentWithFeature(ActivityManagerService.java)</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//Notifier.java</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Intent mScreenOnIntent<span class="token punctuation">;</span>
	<span class="token comment">//新建一个Intent，它的action是ACTION_SCREEN_ON，</span>
	<span class="token comment">//注意此处增加了</span>
	<span class="token comment">//FLAG_RECEIVER_REGISTERED_ONLY: 只允许动态注册的接收者接受</span>
	<span class="token comment">//FLAG_RECEIVER_FOREGROUND: 前台接收，也就是前台广播(10s超时)的队列</span>
	<span class="token comment">//FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS: 可以被即时app接收</span>
	mScreenOnIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_SCREEN_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mScreenOnIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>
			Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_FOREGROUND
			<span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//亮屏广播发送完成后才调用的</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> BroadcastReceiver mWakeUpBroadcastDone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//开始发送广播之前会打印类似“power_screen_broadcast_send: 1”的日志</span>
            <span class="token comment">//这里会在event log中打印类似“power_screen_broadcast_done: [1,125,1]“的日志</span>
			<span class="token comment">//里面包含了发送亮屏广播的时间，此处是“125 ms”</span>
            EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>EventLogTags<span class="token punctuation">.</span>POWER_SCREEN_BROADCAST_DONE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> mBroadcastStartTime<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sendNextBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendWakeUpBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Sending wake up broadcast."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityManagerInternal<span class="token punctuation">.</span><span class="token function">isSystemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//调用的是ContextImpl的sendOrderedBroadcastAsUser去发送广播</span>
			<span class="token comment">//mScreenOnIntent是发送的亮屏广播</span>
			<span class="token comment">//mHandler是PowerManagerService.java的主线程，用来运行mWakeUpBroadcastDone</span>
			<span class="token comment">//mWakeUpBroadcastDone是亮屏广播发送完成后</span>
            mContext<span class="token punctuation">.</span><span class="token function">sendOrderedBroadcastAsUser</span><span class="token punctuation">(</span>mScreenOnIntent<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                    mWakeUpBroadcastDone<span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>EventLogTags<span class="token punctuation">.</span>POWER_SCREEN_BROADCAST_STOP<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sendNextBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token comment">//ContextImpl.java</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendOrderedBroadcastAsUser</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">,</span>
            String receiverPermission<span class="token punctuation">,</span> BroadcastReceiver resultReceiver<span class="token punctuation">,</span> Handler scheduler<span class="token punctuation">,</span>
            <span class="token keyword">int</span> initialCode<span class="token punctuation">,</span> String initialData<span class="token punctuation">,</span> Bundle initialExtras<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//多带了appOp=OP_NONE、options=null的参数</span>
        <span class="token function">sendOrderedBroadcastAsUser</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> user<span class="token punctuation">,</span> receiverPermission<span class="token punctuation">,</span> AppOpsManager<span class="token punctuation">.</span>OP_NONE<span class="token punctuation">,</span>
                null<span class="token punctuation">,</span> resultReceiver<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> initialCode<span class="token punctuation">,</span> initialData<span class="token punctuation">,</span> initialExtras<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendOrderedBroadcastAsUser</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">,</span>
            String receiverPermission<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> Bundle options<span class="token punctuation">,</span> BroadcastReceiver resultReceiver<span class="token punctuation">,</span>
            Handler scheduler<span class="token punctuation">,</span> <span class="token keyword">int</span> initialCode<span class="token punctuation">,</span> String initialData<span class="token punctuation">,</span> Bundle initialExtras<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        IIntentReceiver rd <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultReceiver <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//由于传入了scheduler(mHandler)，所以这里是不会进来的</span>
                    scheduler <span class="token operator">=</span> mMainThread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				<span class="token comment">//进入的是这里获取IIntentReceiver rd(通过mPackageInfo、resultReceiver、scheduler构建)</span>
                rd <span class="token operator">=</span> mPackageInfo<span class="token punctuation">.</span><span class="token function">getReceiverDispatcher</span><span class="token punctuation">(</span>
                    resultReceiver<span class="token punctuation">,</span> <span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span>
                    mMainThread<span class="token punctuation">.</span><span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scheduler <span class="token operator">=</span> mMainThread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">(</span>resultReceiver<span class="token punctuation">,</span> <span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        scheduler<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        String resolvedType <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> receiverPermissions <span class="token operator">=</span> receiverPermission <span class="token operator">==</span> null <span class="token operator">?</span> null
                <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>receiverPermission<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//实际是调用的AMS的broadcastIntentWithFeature方法</span>
            ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcastIntentWithFeature</span><span class="token punctuation">(</span>
                    mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getAttributionTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    rd<span class="token punctuation">,</span> initialCode<span class="token punctuation">,</span> initialData<span class="token punctuation">,</span> initialExtras<span class="token punctuation">,</span> receiverPermissions<span class="token punctuation">,</span>
                    null <span class="token comment">/*excludedPermissions=*/</span><span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<h2><a id="3__140"></a>3. 系统处理广播发送</h2> 
<h3><a id="31_AMS_142"></a>3.1 AMS接收广播的请求</h3> 
<p>系统AMS通过broadcastIntentWithFeature接收广播的请求</p> 
<pre><code class="prism language-java"><span class="token comment">//ActivityManagerService.java</span>
    <span class="token comment">//从context过来的都走的这个broadcastIntentWithFeature方法，带特性的发送广播</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntentWithFeature</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> String callingFeatureId<span class="token punctuation">,</span>
            Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> IIntentReceiver resultTo<span class="token punctuation">,</span>
            <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span> Bundle resultExtras<span class="token punctuation">,</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> requiredPermissions<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> excludedPermissions<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> Bundle bOptions<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> serialized<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"broadcastIntent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            intent <span class="token operator">=</span> <span class="token function">verifyBroadcastLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//通过IApplicationThread获取调用者ProcessRecord callerApp</span>
            <span class="token keyword">final</span> ProcessRecord callerApp <span class="token operator">=</span> <span class="token function">getRecordForAppLOSP</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//获取callerApp、callingPid、callingUid用于广播发送参数传入</span>
                <span class="token keyword">return</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span>
                        callerApp <span class="token operator">!=</span> null <span class="token operator">?</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName <span class="token operator">:</span> null<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span>
                        intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span>
                        requiredPermissions<span class="token punctuation">,</span> excludedPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span> serialized<span class="token punctuation">,</span>
                        sticky<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span>ProcessRecord callerApp<span class="token punctuation">,</span>
            String callerPackage<span class="token punctuation">,</span> String callerFeatureId<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
            IIntentReceiver resultTo<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span>
            Bundle resultExtras<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> requiredPermissions<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> excludedPermissions<span class="token punctuation">,</span>
            <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> Bundle bOptions<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span>
            <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> realCallingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> realCallingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//这里再次增加了3个参数allowBackgroundActivityStarts=false，tokenNeededForBackgroundActivityStarts=false</span>
		<span class="token comment">//broadcastAllowList=null</span>
        <span class="token keyword">return</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callerFeatureId<span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> requiredPermissions<span class="token punctuation">,</span>
                excludedPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                realCallingUid<span class="token punctuation">,</span> realCallingPid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* allowBackgroundActivityStarts */</span><span class="token punctuation">,</span>
                null <span class="token comment">/* tokenNeededForBackgroundActivityStarts */</span><span class="token punctuation">,</span> null <span class="token comment">/* broadcastAllowList */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="32_flagBroadcastOptions_197"></a>3.2 修改增加默认flag解析可选广播参数BroadcastOptions</h3> 
<ol><li>如默认会增加 FLAG_EXCLUDE_STOPPED_PACKAGES ，不让stop(如通过forcestop会设置)的三方app接收静态广播</li><li>根据是否粘性广播输出类似的日志：Broadcast (sticky) intent ordered=(true/false) userid=(userId)</li><li>解析BroadcastOptions brOptions广播可选参数</li></ol> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"this"</span><span class="token punctuation">)</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span>ProcessRecord callerApp<span class="token punctuation">,</span> String callerPackage<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@Nullable</span> String callerFeatureId<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
                                    IIntentReceiver resultTo<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span>
                                    Bundle resultExtras<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> requiredPermissions<span class="token punctuation">,</span>
                                    String<span class="token punctuation">[</span><span class="token punctuation">]</span> excludedPermissions<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> Bundle bOptions<span class="token punctuation">,</span>
                                    <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span>
                                    <span class="token keyword">int</span> realCallingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> realCallingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
                                    <span class="token keyword">boolean</span> allowBackgroundActivityStarts<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@Nullable</span> IBinder backgroundActivityStartsToken<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> broadcastAllowList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用者是否即时app</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> callerInstantApp <span class="token operator">=</span> <span class="token function">isInstantApp</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Instant Apps cannot use FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span>
        <span class="token comment">//如果调用者是即时app，不能添加FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS，可以让即时app接收的flag</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callerInstantApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            intent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// broadcastAllowList: 允许接收该广播uid的列表；一般包信息改变的时候才会传入，通过ContextImpl发送广播是不带这个参数的</span>
        <span class="token comment">// broadcastAllowList目前只在PMS的doSendBroadcast发送package相关广播的时候才可能使用到</span>
        <span class="token comment">// PackageManagerService.sendPackageBroadcast/sendMyPackageSuspendedOrUnsuspended-&gt;doSendBroadcast-&gt;</span>
        <span class="token comment">// ActivityManagerService.LocalService.broadcastIntent</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> UserHandle<span class="token punctuation">.</span>USER_ALL <span class="token operator">&amp;&amp;</span> broadcastAllowList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"broadcastAllowList only applies when sending to individual users. "</span>
                    <span class="token operator">+</span> <span class="token string">"Assuming restrictive whitelist."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            broadcastAllowList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// By default broadcasts do not go to stopped apps.</span>
        <span class="token comment">//默认广播是不发送给stop的应用的，类似于安装后进程从未启动过，或者给强行停止的应用，</span>
        <span class="token comment">//是无法通过接收静态注册的广播来启动的(具体在IntentResolver.java的buildResolveList会使用)</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_EXCLUDE_STOPPED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If we have not finished booting, don't allow this to launch new processes.</span>
        <span class="token comment">//mProcessesReady在systemReady的时候会设置为true</span>
        <span class="token comment">//在系统没有启动完成的时候，而且广播发送没有带FLAG_RECEIVER_BOOT_UPGRADE的flag</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProcessesReady <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//则默认只能发送到动态注册的接收者中，静态注册的全部无法接收</span>
            intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//DEBUG_BROADCAST_LIGHT这个是调试日志的开关，这里输出是否order有序广播</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_LIGHT<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>sticky <span class="token operator">?</span> <span class="token string">"Broadcast sticky: "</span><span class="token operator">:</span> <span class="token string">"Broadcast: "</span><span class="token punctuation">)</span> <span class="token operator">+</span> intent
                        <span class="token operator">+</span> <span class="token string">" ordered="</span> <span class="token operator">+</span> ordered <span class="token operator">+</span> <span class="token string">" userid="</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//如果是非ordered的广播，而且有resultTo则输出warning的信息</span>
        <span class="token comment">//一般情况下orderd的广播才会设置resultTo(发送完成后返回完成的结果到发送者)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Broadcast "</span> <span class="token operator">+</span> intent <span class="token operator">+</span> <span class="token string">" not ordered but result callback requested!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//多用户判断，如果是callingUid、userId同一个用户组，则直接返回userId</span>
        userId <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">handleIncomingUser</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                ALLOW_NON_FULL<span class="token punctuation">,</span> <span class="token string">"broadcast"</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Make sure that the user who is receiving this broadcast or its parent is running.</span>
        <span class="token comment">// If not, we will just skip it. Make an exception for shutdown broadcasts, upgrade steps.</span>
        <span class="token comment">//如果userId不是发送到所有用户USER_ALL(-1)，而且当前userId和它的父亲userId都没有在运行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> UserHandle<span class="token punctuation">.</span>USER_ALL <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mUserController<span class="token punctuation">.</span><span class="token function">isUserOrItsParentRunning</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果调用者不是系统或者没有设置FLAG_RECEIVER_BOOT_UPGRADE，而且不是关机广播，</span>
            <span class="token comment">//则跳过本次广播发送，不允许stop的userId发送广播，原因是user已经stop了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>callingUid <span class="token operator">!=</span> SYSTEM_UID
                    <span class="token operator">||</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Intent<span class="token punctuation">.</span>ACTION_SHUTDOWN<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Skipping broadcast of "</span> <span class="token operator">+</span> intent
                        <span class="token operator">+</span> <span class="token string">": user "</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">" and its parent (if any) are stopped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>BROADCAST_FAILED_USER_STOPPED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//获取其意图的action</span>
        <span class="token keyword">final</span> String action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BroadcastOptions brOptions <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment">//是否有传入BroadcastOptions的Bundle，开机广播有传入bOptions，亮屏幕广播没有bOptions</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bOptions <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//将Bundle转换成BroadcastOptions brOptions</span>
            brOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastOptions</span><span class="token punctuation">(</span>bOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果mTemporaryAppAllowlistDuration的值大于0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brOptions<span class="token punctuation">.</span><span class="token function">getTemporaryAppAllowlistDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// See if the caller is allowed to do this.  Note we are checking against</span>
                <span class="token comment">// the actual real caller (not whoever provided the operation as say a</span>
                <span class="token comment">// PendingIntent), because that who is actually supplied the arguments.</span>
                <span class="token comment">// 检查一下realCallingPid/realCallingUid是否拥有CHANGE_DEVICE_IDLE_TEMP_WHITELIST(修改临时白名单)、</span>
                <span class="token comment">// START_ACTIVITIES_FROM_BACKGROUND(后台启动activity)、</span>
                <span class="token comment">// START_FOREGROUND_SERVICES_FROM_BACKGROUND(后台启动前台服务)的权限，</span>
                <span class="token comment">// 如果一个都没有，则不允许发送该广播，并抛出安全异常</span>
                <span class="token comment">// (在部分情况下callingPid/callingUid调用该发送广播的调用者，</span>
                <span class="token comment">// 于realCallingPid/realCallingUid真实调用者不是一样的)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkComponentPermission</span><span class="token punctuation">(</span>CHANGE_DEVICE_IDLE_TEMP_WHITELIST<span class="token punctuation">,</span>
                        realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
                        <span class="token operator">&amp;&amp;</span> <span class="token function">checkComponentPermission</span><span class="token punctuation">(</span>START_ACTIVITIES_FROM_BACKGROUND<span class="token punctuation">,</span>
                        realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
                        <span class="token operator">&amp;&amp;</span> <span class="token function">checkComponentPermission</span><span class="token punctuation">(</span>START_FOREGROUND_SERVICES_FROM_BACKGROUND<span class="token punctuation">,</span>
                        realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    String msg <span class="token operator">=</span> <span class="token string">"Permission Denial: "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" broadcast from "</span> <span class="token operator">+</span> callerPackage <span class="token operator">+</span> <span class="token string">" (pid="</span> <span class="token operator">+</span> callingPid
                            <span class="token operator">+</span> <span class="token string">", uid="</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">")"</span>
                            <span class="token operator">+</span> <span class="token string">" requires "</span>
                            <span class="token operator">+</span> CHANGE_DEVICE_IDLE_TEMP_WHITELIST <span class="token operator">+</span> <span class="token string">" or "</span>
                            <span class="token operator">+</span> START_ACTIVITIES_FROM_BACKGROUND <span class="token operator">+</span> <span class="token string">" or "</span>
                            <span class="token operator">+</span> START_FOREGROUND_SERVICES_FROM_BACKGROUND<span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//如果带有mDontSendToRestrictedApps不发送给受限制的app</span>
            <span class="token comment">// callingUid不在mActiveUids中，而且callingUid/callerPackage后台限制操作</span>
            <span class="token comment">// 则由于“background restrictions”不允许发送广播</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brOptions<span class="token punctuation">.</span><span class="token function">isDontSendToRestrictedApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isUidActiveLOSP</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token function">isBackgroundRestrictedNoCheck</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Not sending broadcast "</span> <span class="token operator">+</span> action <span class="token operator">+</span> <span class="token string">" - app "</span> <span class="token operator">+</span> callerPackage
                        <span class="token operator">+</span> <span class="token string">" has background restrictions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>START_CANCELED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//是否允许mAllowBackgroundActivityStarts后台启动activity</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brOptions<span class="token punctuation">.</span><span class="token function">allowsBackgroundActivityStarts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// See if the caller is allowed to do this.  Note we are checking against</span>
                <span class="token comment">// the actual real caller (not whoever provided the operation as say a</span>
                <span class="token comment">// PendingIntent), because that who is actually supplied the arguments.</span>
                <span class="token comment">//如果没有START_ACTIVITIES_FROM_BACKGROUND则抛出权限异常</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkComponentPermission</span><span class="token punctuation">(</span>
                        android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>START_ACTIVITIES_FROM_BACKGROUND<span class="token punctuation">,</span>
                        realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    String msg <span class="token operator">=</span> <span class="token string">"Permission Denial: "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" broadcast from "</span> <span class="token operator">+</span> callerPackage <span class="token operator">+</span> <span class="token string">" (pid="</span> <span class="token operator">+</span> callingPid
                            <span class="token operator">+</span> <span class="token string">", uid="</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">")"</span>
                            <span class="token operator">+</span> <span class="token string">" requires "</span>
                            <span class="token operator">+</span> android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>START_ACTIVITIES_FROM_BACKGROUND<span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//否者将allowBackgroundActivityStarts设置成true，允许后台启动activity</span>
                    allowBackgroundActivityStarts <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment">// We set the token to null since if it wasn't for it we'd allow anyway here</span>
                    backgroundActivityStartsToken <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="34_isProtectedBroadcastaction_353"></a>3.4 保护广播isProtectedBroadcast、特定action的处理</h3> 
<ol><li>识别是否保护广播，这类广播不能给系统之外的app调用；而系统尽量发送保护广播，不然也会发出警告</li><li>后台是否可以接收广播的识别(如果在system/etc、/product/etc等地方加入“allow-implicit-broadcast”的广播则可以让后台接收，<br> 会加上FLAG_RECEIVER_INCLUDE_BACKGROUND的flag)</li><li>特定action如包状态改变等的广播的处理</li></ol> 
<pre><code class="prism language-java">        <span class="token comment">// Verify that protected broadcasts are only being sent by system code,</span>
        <span class="token comment">// and that system code is only sending protected broadcasts.</span>
        <span class="token comment">//保护广播的判断逻辑isProtectedBroadcast，这类广播只有系统才能发送</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isProtectedBroadcast<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//查询该广播是否包含在mProtectedBroadcasts，在isProtectedBroadcast也可以增加字符串过滤条件</span>
            <span class="token comment">//例如在frameworks/base/core/res/AndroidManifest.xml等定义的带有“protected-broadcast”的广播</span>
            <span class="token comment">// &lt;protected-broadcast android:name="android.intent.action.SCREEN_ON" /&gt;</span>
            isProtectedBroadcast <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isProtectedBroadcast</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Remote exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isCallerSystem<span class="token punctuation">;</span>
        <span class="token comment">//判断是否系统调用</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> ROOT_UID<span class="token operator">:</span>
            <span class="token keyword">case</span> SYSTEM_UID<span class="token operator">:</span>
            <span class="token keyword">case</span> PHONE_UID<span class="token operator">:</span>
            <span class="token keyword">case</span> BLUETOOTH_UID<span class="token operator">:</span>
            <span class="token keyword">case</span> NFC_UID<span class="token operator">:</span>
            <span class="token keyword">case</span> SE_UID<span class="token operator">:</span>
            <span class="token keyword">case</span> NETWORK_STACK_UID<span class="token operator">:</span>
                <span class="token comment">//root用户、系统、phone、蓝牙、nfc、安全、网络等相关调用则被认为是系统</span>
                isCallerSystem <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">//其它就看是否常驻内存，如果是常驻内存调用，也被认为是系统</span>
                isCallerSystem <span class="token operator">=</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> callerApp<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// First line security check before anything else: stop non-system apps from</span>
        <span class="token comment">// sending protected broadcasts.</span>
        <span class="token comment">//如果不是系统调用，会进行安全检查</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCallerSystem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果是保护的广播，则不是系统进程，不允许发送，抛出权限异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isProtectedBroadcast<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String msg <span class="token operator">=</span> <span class="token string">"Permission Denial: not allowed to send broadcast "</span>
                        <span class="token operator">+</span> action <span class="token operator">+</span> <span class="token string">" from pid="</span>
                        <span class="token operator">+</span> callingPid <span class="token operator">+</span> <span class="token string">", uid="</span> <span class="token operator">+</span> callingUid<span class="token punctuation">;</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>AppWidgetManager<span class="token punctuation">.</span>ACTION_APPWIDGET_CONFIGURE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
                    <span class="token operator">||</span> AppWidgetManager<span class="token punctuation">.</span>ACTION_APPWIDGET_UPDATE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Special case for compatibility: we don't want apps to send this,</span>
                <span class="token comment">// but historically it has not been protected and apps may be using it</span>
                <span class="token comment">// to poke their own app widget.  So, instead of making it protected,</span>
                <span class="token comment">// just limit it to the caller.</span>
                <span class="token comment">//如果是widget配置(ACTION_APPWIDGET_CONFIGURE)和更新(ACTION_APPWIDGET_UPDATE)</span>
                <span class="token comment">//则调用callerPackage不能是空</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callerPackage <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    String msg <span class="token operator">=</span> <span class="token string">"Permission Denial: not allowed to send broadcast "</span>
                            <span class="token operator">+</span> action <span class="token operator">+</span> <span class="token string">" from unknown caller."</span><span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果调用组件不等于null</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// They are good enough to send to an explicit component...  verify</span>
                    <span class="token comment">// it is being sent to the calling app.</span>
                    <span class="token comment">//这种情况只能自己发送给自己，不然抛出权限异常</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                            callerPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        String msg <span class="token operator">=</span> <span class="token string">"Permission Denial: not allowed to send broadcast "</span>
                                <span class="token operator">+</span> action <span class="token operator">+</span> <span class="token string">" to "</span>
                                <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" from "</span>
                                <span class="token operator">+</span> callerPackage<span class="token punctuation">;</span>
                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Limit broadcast to their own package.</span>
                    <span class="token comment">//这类广播只能发给它自己，用于自身widget的更新</span>
                    intent<span class="token punctuation">.</span><span class="token function">setPackage</span><span class="token punctuation">(</span>callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//这个是广播超时豁免只有ACTION_PRE_BOOT_COMPLETED才会设置</span>
        <span class="token comment">//设置了之后这个广播不会超时，谨慎使用</span>
        <span class="token keyword">boolean</span> timeoutExempt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//查看是否background的进程也可以接收该广播，具体列表在SystemConfig.java的mAllowImplicitBroadcasts</span>
            <span class="token comment">//这个列表是扫描**/etc(如system/etc/sysconfig/framework-sysconfig.xml、</span>
            <span class="token comment">// /product/etc/sysconfig/google.xml)带有“&lt;allow-implicit-broadcast”的广播</span>
            <span class="token comment">// 如：google的云推送”com.google.android.c2dm.intent.RECEIVE“、simcard状态改变</span>
            <span class="token comment">// android.intent.action.SIM_STATE_CHANGED就是这类广播</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getBackgroundLaunchBroadcasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BACKGROUND_CHECK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Broadcast action "</span> <span class="token operator">+</span> action <span class="token operator">+</span> <span class="token string">" forcing include-background"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//直接增加可以被后台进程接收的flag FLAG_RECEIVER_INCLUDE_BACKGROUND</span>
                <span class="token comment">// (如何使用在讲解BroadcastQueue的processNextBroadcastLocked时会说明)</span>
                intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_INCLUDE_BACKGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_UID_REMOVED<span class="token operator">:</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_REMOVED<span class="token operator">:</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_CHANGED<span class="token operator">:</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE<span class="token operator">:</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_EXTERNAL_APPLICATIONS_AVAILABLE<span class="token operator">:</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGES_SUSPENDED<span class="token operator">:</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGES_UNSUSPENDED<span class="token operator">:</span>
                    <span class="token comment">// Handle special intents: if this broadcast is from the package</span>
                    <span class="token comment">// manager about a package being removed, we need to remove all of</span>
                    <span class="token comment">// its activities from the history stack.</span>
                    <span class="token comment">// 如果是ACTION_UID_REMOVED/ACTION_PACKAGE_REMOVED/ACTION_PACKAGE_CHANGED/</span>
                    <span class="token comment">// ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE/ACTION_EXTERNAL_APPLICATIONS_AVAILABLE/</span>
                    <span class="token comment">// ACTION_PACKAGES_SUSPENDED/ACTION_PACKAGES_UNSUSPENDED这类广播，</span>
                    <span class="token comment">// 则发送广播需要BROADCAST_PACKAGE_REMOVED的权限，不然是没法发送的</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkComponentPermission</span><span class="token punctuation">(</span>
                            android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>BROADCAST_PACKAGE_REMOVED<span class="token punctuation">,</span>
                            callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                            <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        String msg <span class="token operator">=</span> <span class="token string">"Permission Denial: "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">" broadcast from "</span> <span class="token operator">+</span> callerPackage <span class="token operator">+</span> <span class="token string">" (pid="</span> <span class="token operator">+</span> callingPid
                                <span class="token operator">+</span> <span class="token string">", uid="</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">")"</span>
                                <span class="token operator">+</span> <span class="token string">" requires "</span>
                                <span class="token operator">+</span> android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>BROADCAST_PACKAGE_REMOVED<span class="token punctuation">;</span>
                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_UID_REMOVED<span class="token operator">:</span>
                            <span class="token keyword">final</span> <span class="token keyword">int</span> uid <span class="token operator">=</span> <span class="token function">getUidFromIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//如果发送的是ACTION_UID_REMOVED的广播</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//电池状态服务的removeUid</span>
                                mBatteryStatsService<span class="token punctuation">.</span><span class="token function">removeUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//mAppOpsService app操作相关管理的处理</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REPLACING<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    mAppOpsService<span class="token punctuation">.</span><span class="token function">resetAllModes</span><span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_PACKAGE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    mAppOpsService<span class="token punctuation">.</span><span class="token function">uidRemoved</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE<span class="token operator">:</span>
                            <span class="token comment">// If resources are unavailable just force stop all those packages</span>
                            <span class="token comment">// and flush the attribute cache as well.</span>
                            String list<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
                                    intent<span class="token punctuation">.</span><span class="token function">getStringArrayExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_CHANGED_PACKAGE_LIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token function">forceStopPackageLocked</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                            <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"storage unmount"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                mAtmInternal<span class="token punctuation">.</span><span class="token function">cleanupRecentTasksForUser</span><span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">sendPackageBroadcastLocked</span><span class="token punctuation">(</span>
                                        ApplicationThreadConstants<span class="token punctuation">.</span>EXTERNAL_STORAGE_UNAVAILABLE<span class="token punctuation">,</span>
                                        list<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_EXTERNAL_APPLICATIONS_AVAILABLE<span class="token operator">:</span>
                            mAtmInternal<span class="token punctuation">.</span><span class="token function">cleanupRecentTasksForUser</span><span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_REMOVED<span class="token operator">:</span>
                        <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_CHANGED<span class="token operator">:</span>
                            <span class="token comment">//应用移除或者改变</span>
                            Uri data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            String ssp<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ssp<span class="token operator">=</span>data<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">boolean</span> removed <span class="token operator">=</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_REMOVED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">final</span> <span class="token keyword">boolean</span> replacing <span class="token operator">=</span>
                                        intent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REPLACING<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">final</span> <span class="token keyword">boolean</span> killProcess <span class="token operator">=</span>
                                        <span class="token operator">!</span>intent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_DONT_KILL_APP<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">final</span> <span class="token keyword">boolean</span> fullUninstall <span class="token operator">=</span> removed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>replacing<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>killProcess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token function">forceStopPackageLocked</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>
                                                intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_UID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fullUninstall<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                                                removed <span class="token operator">?</span> <span class="token string">"pkg removed"</span> <span class="token operator">:</span> <span class="token string">"pkg changed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token comment">// Kill any app zygotes always, since they can't fork new</span>
                                        <span class="token comment">// processes with references to the old code</span>
                                        <span class="token function">forceStopAppZygoteLocked</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>
                                                intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_UID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                    <span class="token keyword">final</span> <span class="token keyword">int</span> cmd <span class="token operator">=</span> killProcess
                                            <span class="token operator">?</span> ApplicationThreadConstants<span class="token punctuation">.</span>PACKAGE_REMOVED
                                            <span class="token operator">:</span> ApplicationThreadConstants<span class="token punctuation">.</span>PACKAGE_REMOVED_DONT_KILL<span class="token punctuation">;</span>
                                    <span class="token function">sendPackageBroadcastLocked</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span>
                                            <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>ssp<span class="token punctuation">}</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fullUninstall<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        mAppOpsService<span class="token punctuation">.</span><span class="token function">packageRemoved</span><span class="token punctuation">(</span>
                                                intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_UID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ssp<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                        <span class="token comment">// Remove all permissions granted from/to this package</span>
                                        mUgmInternal<span class="token punctuation">.</span><span class="token function">removeUriPermissionsForPackage</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                                                <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                                        mAtmInternal<span class="token punctuation">.</span><span class="token function">removeRecentTasksByPackageName</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                        mServices<span class="token punctuation">.</span><span class="token function">forceStopPackageLocked</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        mAtmInternal<span class="token punctuation">.</span><span class="token function">onPackageUninstalled</span><span class="token punctuation">(</span>ssp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        mBatteryStatsService<span class="token punctuation">.</span><span class="token function">notePackageUninstalled</span><span class="token punctuation">(</span>ssp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>killProcess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token keyword">final</span> <span class="token keyword">int</span> extraUid <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_UID<span class="token punctuation">,</span>
                                                <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mProcLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                            mProcessList<span class="token punctuation">.</span><span class="token function">killPackageProcessesLSP</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span>
                                                    UserHandle<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>extraUid<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    userId<span class="token punctuation">,</span> ProcessList<span class="token punctuation">.</span>INVALID_ADJ<span class="token punctuation">,</span>
                                                    ApplicationExitInfo<span class="token punctuation">.</span>REASON_USER_REQUESTED<span class="token punctuation">,</span>
                                                    ApplicationExitInfo<span class="token punctuation">.</span>SUBREASON_UNKNOWN<span class="token punctuation">,</span>
                                                    <span class="token string">"change "</span> <span class="token operator">+</span> ssp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
                                    <span class="token punctuation">}</span>
                                    <span class="token function">cleanupDisabledPackageComponentsLocked</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                                            intent<span class="token punctuation">.</span><span class="token function">getStringArrayExtra</span><span class="token punctuation">(</span>
                                                    Intent<span class="token punctuation">.</span>EXTRA_CHANGED_COMPONENT_NAME_LIST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    mServices<span class="token punctuation">.</span><span class="token function">schedulePendingServiceStartLocked</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>                            <span class="token punctuation">}</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGES_SUSPENDED<span class="token operator">:</span>
                        <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGES_UNSUSPENDED<span class="token operator">:</span>
                            <span class="token keyword">final</span> <span class="token keyword">boolean</span> suspended <span class="token operator">=</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGES_SUSPENDED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                                    intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> packageNames <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringArrayExtra</span><span class="token punctuation">(</span>
                                    Intent<span class="token punctuation">.</span>EXTRA_CHANGED_PACKAGE_LIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">final</span> <span class="token keyword">int</span> userIdExtra <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>
                                    Intent<span class="token punctuation">.</span>EXTRA_USER_HANDLE<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            mAtmInternal<span class="token punctuation">.</span><span class="token function">onPackagesSuspendedChanged</span><span class="token punctuation">(</span>packageNames<span class="token punctuation">,</span> suspended<span class="token punctuation">,</span>
                                    userIdExtra<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_REPLACED<span class="token operator">:</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> Uri data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> String ssp<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ssp <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        ApplicationInfo aInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            aInfo <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> STOCK_PM_FLAGS<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Dropping ACTION_PACKAGE_REPLACED for non-existent pkg:"</span>
                                    <span class="token operator">+</span> <span class="token string">" ssp="</span> <span class="token operator">+</span> ssp <span class="token operator">+</span> <span class="token string">" data="</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token function">updateAssociationForApp</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mAtmInternal<span class="token punctuation">.</span><span class="token function">onPackageReplaced</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mServices<span class="token punctuation">.</span><span class="token function">updateServiceApplicationInfoLocked</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">sendPackageBroadcastLocked</span><span class="token punctuation">(</span>ApplicationThreadConstants<span class="token punctuation">.</span>PACKAGE_REPLACED<span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>ssp<span class="token punctuation">}</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_ADDED<span class="token operator">:</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//应用安装</span>
                    <span class="token comment">// Special case for adding a package: by default turn on compatibility mode.</span>
                    Uri data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String ssp<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ssp <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">final</span> <span class="token keyword">boolean</span> replacing <span class="token operator">=</span>
                                intent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REPLACING<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mAtmInternal<span class="token punctuation">.</span><span class="token function">onPackageAdded</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> replacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            ApplicationInfo ai <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                                    <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span> STOCK_PM_FLAGS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            mBatteryStatsService<span class="token punctuation">.</span><span class="token function">notePackageInstalled</span><span class="token punctuation">(</span>ssp<span class="token punctuation">,</span>
                                    ai <span class="token operator">!=</span> null <span class="token operator">?</span> ai<span class="token punctuation">.</span>longVersionCode <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_DATA_CLEARED<span class="token operator">:</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//应用数据清除</span>
                    Uri data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String ssp<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ssp <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        mAtmInternal<span class="token punctuation">.</span><span class="token function">onPackageDataCleared</span><span class="token punctuation">(</span>ssp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_TIMEZONE_CHANGED<span class="token operator">:</span>
                    <span class="token comment">// If this is the time zone changed action, queue up a message that will reset</span>
                    <span class="token comment">// the timezone of all currently running processes. This message will get</span>
                    <span class="token comment">// queued up before the broadcast happens.</span>
                    <span class="token comment">//时区改变</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>UPDATE_TIME_ZONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_TIME_CHANGED<span class="token operator">:</span>
                    <span class="token comment">// EXTRA_TIME_PREF_24_HOUR_FORMAT is optional so we must distinguish between</span>
                    <span class="token comment">// the tri-state value it may contain and "unknown".</span>
                    <span class="token comment">// For convenience we re-use the Intent extra values.</span>
                    <span class="token comment">//系统时间改变</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> NO_EXTRA_VALUE_FOUND <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> timeFormatPreferenceMsgValue <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>
                            Intent<span class="token punctuation">.</span>EXTRA_TIME_PREF_24_HOUR_FORMAT<span class="token punctuation">,</span>
                            NO_EXTRA_VALUE_FOUND <span class="token comment">/* defaultValue */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Only send a message if the time preference is available.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeFormatPreferenceMsgValue <span class="token operator">!=</span> NO_EXTRA_VALUE_FOUND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Message updateTimePreferenceMsg <span class="token operator">=</span>
                                mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>UPDATE_TIME_PREFERENCE_MSG<span class="token punctuation">,</span>
                                        timeFormatPreferenceMsgValue<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>updateTimePreferenceMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mBatteryStatsService<span class="token punctuation">.</span><span class="token function">noteCurrentTimeChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> ConnectivityManager<span class="token punctuation">.</span>ACTION_CLEAR_DNS_CACHE<span class="token operator">:</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>CLEAR_DNS_CACHE_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> Proxy<span class="token punctuation">.</span>PROXY_CHANGE_ACTION<span class="token operator">:</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>UPDATE_HTTP_PROXY_MSG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span>Camera<span class="token punctuation">.</span>ACTION_NEW_PICTURE<span class="token operator">:</span>
                <span class="token keyword">case</span> android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span>Camera<span class="token punctuation">.</span>ACTION_NEW_VIDEO<span class="token operator">:</span>
                    <span class="token comment">// In N we just turned these off; in O we are turing them back on partly,</span>
                    <span class="token comment">// only for registered receivers.  This will still address the main problem</span>
                    <span class="token comment">// (a spam of apps waking up when a picture is taken putting significant</span>
                    <span class="token comment">// memory pressure on the system at a bad point), while still allowing apps</span>
                    <span class="token comment">// that are already actively running to know about this happening.</span>
                    intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> android<span class="token punctuation">.</span>security<span class="token punctuation">.</span>KeyChain<span class="token punctuation">.</span>ACTION_TRUST_STORE_CHANGED<span class="token operator">:</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>HANDLE_TRUST_STORAGE_UPDATE_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token string">"com.android.launcher.action.INSTALL_SHORTCUT"</span><span class="token operator">:</span>
                    <span class="token comment">// As of O, we no longer support this broadcasts, even for pre-O apps.</span>
                    <span class="token comment">// Apps should now be using ShortcutManager.pinRequestShortcut().</span>
                    Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Broadcast "</span> <span class="token operator">+</span> action
                            <span class="token operator">+</span> <span class="token string">" no longer supported. It will not be delivered."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_PRE_BOOT_COMPLETED<span class="token operator">:</span>
                    <span class="token comment">//如果是ACTION_PRE_BOOT_COMPLETED广播则设置超时豁免timeoutExempt = true</span>
                    timeoutExempt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> Intent<span class="token punctuation">.</span>ACTION_CLOSE_SYSTEM_DIALOGS<span class="token operator">:</span>
                    <span class="token comment">//需要有BROADCAST_CLOSE_SYSTEM_DIALOGS的权限，不然直接返回</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAtmInternal<span class="token punctuation">.</span><span class="token function">checkCanCloseSystemDialogs</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                            callerPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Returning success seems to be the pattern here</span>
                        <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_PACKAGE_ADDED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token operator">||</span>
                    Intent<span class="token punctuation">.</span>ACTION_PACKAGE_REMOVED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token operator">||</span>
                    Intent<span class="token punctuation">.</span>ACTION_PACKAGE_REPLACED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> uid <span class="token operator">=</span> <span class="token function">getUidFromIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> UidRecord uidRec <span class="token operator">=</span> mProcessList<span class="token punctuation">.</span><span class="token function">getUidRecordLOSP</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>uidRec <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        uidRec<span class="token punctuation">.</span><span class="token function">updateHasInternetPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="35__731"></a>3.5 发送粘性广播的处理</h3> 
<p>将粘性广播添加到AMS的mStickyBroadcasts(key是用户组，value是粘性广播列表stickies)中，<br> 单个用户组的粘性广播列表stickies(key是action，value是intent)</p> 
<p><code>已经发送的粘性广播会放入AMS的mStickyBroadcasts中，后面动态注册的接收者就可以在注册的时候就接收这类粘性广播， 因为系统有保存这类广播</code></p> 
<pre><code class="prism language-java">        <span class="token comment">// Add to the sticky list if requested.</span>
        <span class="token comment">// 是否粘性广播，可以通过ContextImpl.java的sendStickyBroadcast/sendStickyBroadcastAsUser/</span>
        <span class="token comment">// sendStickyOrderedBroadcast/sendStickyOrderedBroadcastAsUser来进行发送</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sticky<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//粘性广播需要拥有"android.permission.BROADCAST_STICKY"的权限</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPermission</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>BROADCAST_STICKY<span class="token punctuation">,</span>
                    callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span>
                    <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String msg <span class="token operator">=</span> <span class="token string">"Permission Denial: broadcastIntent() requesting a sticky broadcast from pid="</span>
                        <span class="token operator">+</span> callingPid <span class="token operator">+</span> <span class="token string">", uid="</span> <span class="token operator">+</span> callingUid
                        <span class="token operator">+</span> <span class="token string">" requires "</span> <span class="token operator">+</span> android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>BROADCAST_STICKY<span class="token punctuation">;</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//这类广播不能带有requiredPermissions，否则直接返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredPermissions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> requiredPermissions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Can't broadcast sticky intent "</span> <span class="token operator">+</span> intent
                        <span class="token operator">+</span> <span class="token string">" and enforce permissions "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>requiredPermissions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>BROADCAST_STICKY_CANT_HAVE_PERMISSION<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//粘性广播不能指定发送到相关组件，否则发出安全异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>
                        <span class="token string">"Sticky broadcasts can't target a specific component"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// We use userId directly here, since the "all" target is maintained</span>
            <span class="token comment">// as a separate set of sticky broadcasts.</span>
            <span class="token comment">//如果userId不是发送给所有用户USER_ALL(-1)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// But first, if this is not a broadcast to all users, then</span>
                <span class="token comment">// make sure it doesn't conflict with an existing broadcast to</span>
                <span class="token comment">// all users.</span>
                <span class="token comment">//则取出保存粘性广播的列表mStickyBroadcasts里面相同action的Intent</span>
                ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> stickies <span class="token operator">=</span> mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                        UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stickies <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stickies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">int</span> N <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//粘性广播2个Intent不能完全相同，相同的话会抛出非法参数异常</span>
                            <span class="token comment">//mAction/mData/mType/mIdentifier/mPackage/mComponent/mCategories都一致filterEquals才会返回true</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">filterEquals</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                                        <span class="token string">"Sticky broadcast "</span> <span class="token operator">+</span> intent <span class="token operator">+</span> <span class="token string">" for user "</span>
                                                <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">" conflicts with existing global broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//获取该用户组的粘性广播列表stickies</span>
            ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> stickies <span class="token operator">=</span> mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stickies <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果stickies是null，则新建一个</span>
                stickies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//并添加到mStickyBroadcasts中key为userId中去</span>
                mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> stickies<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//通过粘性广播列表stickies(key是action，value是intent)</span>
            ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stickies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果list为空，则新建一个ArrayList，并放入stickies</span>
                list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stickies<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> stickiesCount <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stickiesCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//mAction/mData/mType/mIdentifier/mPackage/mComponent/mCategories都一致filterEquals才会返回true</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">filterEquals</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// This sticky already exists, replace it.</span>
                    <span class="token comment">//如果之前存在一样的intent，则直接替换掉旧的，并且退出循环</span>
                    list<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果上面中途替换过list的intent，则i &lt; stickiesCount</span>
            <span class="token comment">//而i &gt;= stickiesCount则代表没有替换过</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> stickiesCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//没有替换过则加入list中去</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="36__832"></a>3.6 筛选出静态广播接受者</h3> 
<ol><li>这里主要是通过collectReceiverComponents来筛选出静态广播接受者</li></ol> 
<pre><code class="prism language-java">        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>
        <span class="token comment">//通过userId，获取多用户的users</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Caller wants broadcast to go to all started users.</span>
            users <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">getStartedUserArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Caller wants broadcast to go to one specific user.</span>
            users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>userId<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Figure out who all will receive this broadcast.</span>
		<span class="token comment">// 静态广播接受者或者order的动态广播接受者的列表</span>
        List receivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
		<span class="token comment">// 动态广播接受者列表</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>BroadcastFilter<span class="token punctuation">&gt;</span></span> registeredReceivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment">// Need to resolve the intent to interested receivers...</span>
        <span class="token comment">//静态广播的接收，只要没有设置FLAG_RECEIVER_REGISTERED_ONLY，都会查询发送到静态广播中，</span>
        <span class="token comment">//不过如常见的Intent.ACTION_SCREEN_ON则发送时则有设置这个flag，于是Intent.ACTION_SCREEN_ON不会发送给静态广播</span>
        <span class="token comment">//不要注册Intent.ACTION_SCREEN_ON的静态广播，这个注册了你也收不到</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span>
                <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//这里就是查询静态广播的地方，通过PMS的mComponentResolver查询得到该intent静态注册的广播接受者</span>
            <span class="token comment">//同时传入broadcastAllowList过滤是否允许接受者接收</span>
            receivers <span class="token operator">=</span> <span class="token function">collectReceiverComponents</span><span class="token punctuation">(</span>
                    intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> users<span class="token punctuation">,</span> broadcastAllowList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>collectReceiverComponents函数</li></ol> 
<p>collectReceiverComponents：收集静态接收者的函数，其调用的是PMS的queryIntentReceivers进行查询，然后进行相应过滤。<br> =&gt; 调用的是PMS的queryIntentReceivers进行查询<br> =&gt; 判断是否只发送到单个用户FLAG_SYSTEM_USER_ONLY(多用户场景使用)，如果是则进行过滤，只发送给单个用户<br> =&gt; 如果带有broadcastAllowList(允许接收该广播uid的列表),则只让特定uid列表的静态接收者接收</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>ResolveInfo<span class="token punctuation">&gt;</span></span> <span class="token function">collectReceiverComponents</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
                                                        <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> broadcastAllowList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO: come back and remove this assumption to triage all broadcasts</span>
        <span class="token keyword">int</span> pmFlags <span class="token operator">=</span> STOCK_PM_FLAGS <span class="token operator">|</span> MATCH_DEBUG_TRIAGED_MISSING<span class="token punctuation">;</span>

        List<span class="token generics function"><span class="token punctuation">&lt;</span>ResolveInfo<span class="token punctuation">&gt;</span></span> receivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            HashSet<span class="token generics function"><span class="token punctuation">&lt;</span>ComponentName<span class="token punctuation">&gt;</span></span> singleUserReceivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> scannedFirstReceivers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> user <span class="token operator">:</span> users<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Skip users that have Shell restrictions</span>
                <span class="token comment">//如果调用者是shell，而且该user不允许shell调试，则跳过</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callingUid <span class="token operator">==</span> SHELL_UID
                        <span class="token operator">&amp;&amp;</span> mUserController<span class="token punctuation">.</span><span class="token function">hasUserRestriction</span><span class="token punctuation">(</span>
                        UserManager<span class="token punctuation">.</span>DISALLOW_DEBUGGING_FEATURES<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//静态广播通过PMS去查询接收者</span>
                List<span class="token generics function"><span class="token punctuation">&lt;</span>ResolveInfo<span class="token punctuation">&gt;</span></span> newReceivers <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">queryIntentReceivers</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> pmFlags<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> UserHandle<span class="token punctuation">.</span>USER_SYSTEM <span class="token operator">&amp;&amp;</span> newReceivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If this is not the system user, we need to check for</span>
                    <span class="token comment">// any receivers that should be filtered out.</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>newReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        ResolveInfo ri <span class="token operator">=</span> newReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//如果取出来的ResolveInfo包含了只允许系统接收的flag(FLAG_SYSTEM_USER_ONLY)，</span>
                        <span class="token comment">//则从筛选出来的列表中移除这个接收者</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_SYSTEM_USER_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            newReceivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            i<span class="token operator">--</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//如果到目前为止newReceivers(ResolveInfo列表)为null或者空的</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newReceivers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> newReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    newReceivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//如果receivers(最后返回的结果)为null，则先将newReceivers赋值给receivers</span>
                    receivers <span class="token operator">=</span> newReceivers<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newReceivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// We need to concatenate the additional receivers</span>
                    <span class="token comment">// found with what we have do far.  This would be easy,</span>
                    <span class="token comment">// but we also need to de-dup any receivers that are</span>
                    <span class="token comment">// singleUser.</span>
                    <span class="token comment">//scannedFirstReceivers默认是fasle，也就是第一次跑到这段代码会进来，只进来一次</span>
                    <span class="token comment">//receivers此时已经赋值过一次，这里是users第二次和以上循环才可能会进来</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scannedFirstReceivers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Collect any single user receivers we had already retrieved.</span>
                        scannedFirstReceivers <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token comment">// 遍历之前的receivers(这里receivers没有判空逻辑，只看这段逻辑不太严谨，</span>
                        <span class="token comment">// 没有出错是由于newReceivers有判空)</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            ResolveInfo ri <span class="token operator">=</span> receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//如果接收者包含FLAG_SINGLE_USER的flag</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_SINGLE_USER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                ComponentName cn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                                        ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleUserReceivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    singleUserReceivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics function"><span class="token punctuation">&lt;</span>ComponentName<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">//则把这类组件add到singleUserReceivers中</span>
                                singleUserReceivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// Add the new results to the existing results, tracking</span>
                    <span class="token comment">// and de-dupping single user receivers.</span>
                    <span class="token comment">// 遍历新的users中获取的newReceivers</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>newReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        ResolveInfo ri <span class="token operator">=</span> newReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//如果也是带有FLAG_SINGLE_USER的flag，只发送给单个user</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_SINGLE_USER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            ComponentName cn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                                    ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>singleUserReceivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                singleUserReceivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics function"><span class="token punctuation">&lt;</span>ComponentName<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//如果之前还没有添加过，才进行receivers添加</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>singleUserReceivers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//而且将单个用户接受者ComponentName cn添加到ComponentName中</span>
                                singleUserReceivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//其它情况则直接加入该接收者到receivers</span>
                            receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// pm is in same process, this will never happen.</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果带有broadcastAllowList，允许接收该广播uid的列表</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> broadcastAllowList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> receiverAppId <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>
                        receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//接受者的uid如果是app进程，而且不在允许接收该广播uid的列表，则移除查询到的接收者</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>receiverAppId <span class="token operator">&gt;=</span> Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID
                        <span class="token operator">&amp;&amp;</span> Arrays<span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span>broadcastAllowList<span class="token punctuation">,</span> receiverAppId<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    receivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//返回接受者</span>
        <span class="token keyword">return</span> receivers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>PMS通过包安装信息获得静态接收者</li></ol> 
<p>=&gt; 如果包发送给特定组件，则通过mComponentResolver的mReceivers.mActivities获取ParsedActivity，并最终得到对应的ActivityInfo<br> =&gt; 如果没有指定特定组件和特定包，则通过mComponentResolver查询recevier，<br> 调用的是IntentResolver的queryIntent，根据各类Filter去查询，如mActionToFilter，<br> 查询到结果后在通过buildResolveList构建返回的结果List result<br> =&gt; 如果是发送给特定包，则通过mPackages(安装的时候保存的，key是包名，<br> value是AndroidPackage/ParsingPackageImpl/PackageImpl)获取AndroidPackage(ParsingPackageImpl)，<br> 通过ParsingPackageImpl得到这个包的receivers(pkg.getReceivers())，<br> 然后通过mComponentResolver的queryReceivers(ComponentResolver.java)-&gt;mReceivers.queryIntentForPackage<br> queryIntentFromList(IntentResolver.java)-&gt;buildResolveList<br> 此处queryIntentFromList只查询这个包的receivers(构建Pair&lt;ParsedActivity, ParsedIntentInfo&gt;来查询)</p> 
<p><code>在这里可以看到之前“Android S静态广播注册流程”中提到的用来保存静态注册广播组件的mComponentResolver、mReceivers.mActivities、receivers</code></p> 
<pre><code class="prism language-java"><span class="token comment">//PackageManagerService.java</span>
    <span class="token keyword">public</span> <span class="token annotation punctuation">@NonNull</span> ParceledListSlice<span class="token generics function"><span class="token punctuation">&lt;</span>ResolveInfo<span class="token punctuation">&gt;</span></span> <span class="token function">queryIntentReceivers</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span>
            String resolvedType<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//内部方法查询该intent的接受者queryIntentReceiversInternal</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ParceledListSlice</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                <span class="token function">queryIntentReceiversInternal</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                        <span class="token boolean">false</span> <span class="token comment">/*allowDynamicSplits*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token annotation punctuation">@NonNull</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>ResolveInfo<span class="token punctuation">&gt;</span></span> <span class="token function">queryIntentReceiversInternal</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span>
            String resolvedType<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowDynamicSplits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//userId不存在则返回空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mUserManager<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//callingUid是否拥有INTERACT_ACROSS_USERS_FULL或者INTERACT_ACROSS_USERS的权限</span>
        <span class="token function">enforceCrossUserPermission</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*requireFullPermission*/</span><span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment">/*checkShell*/</span><span class="token punctuation">,</span> <span class="token string">"query intent receivers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//看一下callingUid是否即时app，如果是则返回包名，如果不是则返回null</span>
        <span class="token keyword">final</span> String instantAppPkgName <span class="token operator">=</span> <span class="token function">getInstantAppPackageName</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新一下flags</span>
        flags <span class="token operator">=</span> <span class="token function">updateFlagsForResolve</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*includeInstantApps*/</span><span class="token punctuation">,</span>
                <span class="token function">isImplicitImageCaptureIntentAndNotSetByDpcLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                        flags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取intent意图的ComponentName</span>
        ComponentName comp <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果为空，再从intent的selector中查询组件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                intent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                comp <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果ComponentName组件不为null，则代表发送给特定的组件</span>
            <span class="token keyword">final</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>ResolveInfo<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//通过组件获取ActivityInfo</span>
            <span class="token keyword">final</span> ActivityInfo ai <span class="token operator">=</span> <span class="token function">getReceiverInfo</span><span class="token punctuation">(</span>comp<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ai <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// When specifying an explicit component, we prevent the activity from being</span>
                <span class="token comment">// used when either 1) the calling package is normal and the activity is within</span>
                <span class="token comment">// an instant application or 2) the calling package is ephemeral and the</span>
                <span class="token comment">// activity is not visible to instant applications.</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> matchInstantApp <span class="token operator">=</span>
                        <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>MATCH_INSTANT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> matchVisibleToInstantAppOnly <span class="token operator">=</span>
                        <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>MATCH_VISIBLE_TO_INSTANT_APP_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> matchExplicitlyVisibleOnly <span class="token operator">=</span>
                        <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>MATCH_EXPLICITLY_VISIBLE_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isCallerInstantApp <span class="token operator">=</span>
                        instantAppPkgName <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetSameInstantApp <span class="token operator">=</span>
                        comp<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>instantAppPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetInstantApp <span class="token operator">=</span>
                        <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags
                                <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_INSTANT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetVisibleToInstantApp <span class="token operator">=</span>
                        <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ActivityInfo<span class="token punctuation">.</span>FLAG_VISIBLE_TO_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetExplicitlyVisibleToInstantApp <span class="token operator">=</span>
                        isTargetVisibleToInstantApp
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ActivityInfo<span class="token punctuation">.</span>FLAG_IMPLICITLY_VISIBLE_TO_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetHiddenFromInstantApp <span class="token operator">=</span>
                        <span class="token operator">!</span>isTargetVisibleToInstantApp
                        <span class="token operator">||</span> <span class="token punctuation">(</span>matchExplicitlyVisibleOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isTargetExplicitlyVisibleToInstantApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> blockResolution <span class="token operator">=</span>
                        <span class="token operator">!</span>isTargetSameInstantApp
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>matchInstantApp <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isCallerInstantApp <span class="token operator">&amp;&amp;</span> isTargetInstantApp<span class="token punctuation">)</span>
                                <span class="token operator">||</span> <span class="token punctuation">(</span>matchVisibleToInstantAppOnly <span class="token operator">&amp;&amp;</span> isCallerInstantApp
                                        <span class="token operator">&amp;&amp;</span> isTargetHiddenFromInstantApp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果blockResolution为fasle(一般情况除了InstantApp，其它为fasle)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blockResolution<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ResolveInfo ri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResolveInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ri<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> ai<span class="token punctuation">;</span>
                    <span class="token comment">//添加到List&lt;ResolveInfo&gt; list中</span>
                    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//将查询到的List&lt;ResolveInfo&gt; list再次做一些判断，看是否需要移除</span>
            <span class="token keyword">return</span> <span class="token function">applyPostResolutionFilter</span><span class="token punctuation">(</span>
                    list<span class="token punctuation">,</span> instantAppPkgName<span class="token punctuation">,</span> allowDynamicSplits<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                    intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// reader</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//看一下是否有发送给特定的包</span>
            String pkgName <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果pkgName为空，则通过mComponentResolver查询recevier</span>
                <span class="token comment">//调用的是IntentResolver的queryIntent，根据各类Filter去查询，如mActionToFilter</span>
                <span class="token comment">//查询到结果后在通过buildResolveList构建返回的结果List&lt;ResolveInfo&gt; result</span>
                <span class="token keyword">final</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>ResolveInfo<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span>
                        mComponentResolver<span class="token punctuation">.</span><span class="token function">queryReceivers</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//过滤后返回结果</span>
                <span class="token keyword">return</span> <span class="token function">applyPostResolutionFilter</span><span class="token punctuation">(</span>
                        result<span class="token punctuation">,</span> instantAppPkgName<span class="token punctuation">,</span> allowDynamicSplits<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                        intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果有发送给特定的包</span>
            <span class="token keyword">final</span> AndroidPackage pkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 则queryReceivers(ComponentResolver.java)-&gt;mReceivers.queryIntentForPackage</span>
                <span class="token comment">// queryIntentFromList(IntentResolver.java)-&gt;buildResolveList</span>
                <span class="token comment">// 只查询这个包的receivers(构建Pair&lt;ParsedActivity, ParsedIntentInfo&gt;来查询)</span>
                <span class="token keyword">final</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>ResolveInfo<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> mComponentResolver<span class="token punctuation">.</span><span class="token function">queryReceivers</span><span class="token punctuation">(</span>
                        intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span><span class="token function">getReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//过滤后返回结果</span>
                <span class="token keyword">return</span> <span class="token function">applyPostResolutionFilter</span><span class="token punctuation">(</span>
                        result<span class="token punctuation">,</span> instantAppPkgName<span class="token punctuation">,</span> allowDynamicSplits<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                        intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//查询单个组件的ActivityInfo：通过组件名，可以获得相应的ParsedActivity，最终返回的是ActivityInfo信息</span>
    <span class="token keyword">public</span> ActivityInfo <span class="token function">getReceiverInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mUserManager<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flags <span class="token operator">=</span> <span class="token function">updateFlagsForComponent</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enforceCrossUserPermission</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* requireFullPermission */</span><span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment">/* checkShell */</span><span class="token punctuation">,</span> <span class="token string">"get receiver info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//通过mComponentResolver(mReceivers.mActivities取)查询该组件的ParsedActivity</span>
            ParsedActivity a <span class="token operator">=</span> mComponentResolver<span class="token punctuation">.</span><span class="token function">getReceiver</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_PACKAGE_INFO<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
                TAG<span class="token punctuation">,</span> <span class="token string">"getReceiverInfo "</span> <span class="token operator">+</span> component <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果没有取出来，则返回null</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//mPackages变量是保存了所有安装的应用，查看一下这个package是否能从安装应用中查出来</span>
            AndroidPackage pkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 是否包enable(这个是ParsingPackageImpl的ENABLED，不是PackageSettingBase的enabledComponents/disabledComponents)</span>
            <span class="token comment">// 和匹配</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSettings<span class="token punctuation">.</span><span class="token function">isEnabledAndMatchLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> a<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//从mSettings中获取包信息PackageSetting ps</span>
                PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token comment">//查看一下是否需要根据callingUid过滤是否可见其它目标的package</span>
                <span class="token comment">//系统调用的话返回false</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldFilterApplicationLocked</span><span class="token punctuation">(</span>
                        ps<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> component<span class="token punctuation">,</span> TYPE_RECEIVER<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//根据pkg和ParsedActivity生成相应的ActivityInfo信息</span>
                <span class="token keyword">return</span> PackageInfoUtils<span class="token punctuation">.</span><span class="token function">generateActivityInfo</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span>
                        a<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> ps<span class="token punctuation">.</span><span class="token function">readUserState</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="37__1167"></a>3.7 筛选出动态广播接受者</h3> 
<p>“Android S动态广播注册流程”中有讲到：动态广播注册其实最终构建的是BroadcastFilter bf，并放入mReceiverResolver中去<br> 而放入mReceiverResolver使用的方法是IntentResolver的addFilter在“Android S静态广播注册流程”也有提到。</p> 
<ol><li>动态广播接受者主要是通过mReceiverResolver的queryIntent来查询得到</li></ol> 
<pre><code class="prism language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果intent不是单独发给某个组件的话</span>
            <span class="token comment">//如果userId == UserHandle.USER_ALL(发给所有用户)而且callingUid == SHELL_UID(从shell过来)</span>
            <span class="token comment">//一般app或者系统发送不是用过这个场景来发送的</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> UserHandle<span class="token punctuation">.</span>USER_ALL <span class="token operator">&amp;&amp;</span> callingUid <span class="token operator">==</span> SHELL_UID<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Query one target user at a time, excluding shell-restricted users</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> users<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mUserController<span class="token punctuation">.</span><span class="token function">hasUserRestriction</span><span class="token punctuation">(</span>
                            UserManager<span class="token punctuation">.</span>DISALLOW_DEBUGGING_FEATURES<span class="token punctuation">,</span> users<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//通过动态注册广播的解析器mReceiverResolver，查询动态注册的接受者</span>
                    <span class="token comment">//也是通过IntentResolver.java的queryIntent来查询的</span>
                    List<span class="token generics function"><span class="token punctuation">&lt;</span>BroadcastFilter<span class="token punctuation">&gt;</span></span> registeredReceiversForUser <span class="token operator">=</span>
                            mReceiverResolver<span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span>
                                    resolvedType<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*defaultOnly*/</span><span class="token punctuation">,</span> users<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//将查询到的接受者添加到registeredReceivers中去</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>registeredReceivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        registeredReceivers <span class="token operator">=</span> registeredReceiversForUser<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>registeredReceiversForUser <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        registeredReceivers<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>registeredReceiversForUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//一般情况我们走的这里，直接从mReceiverResolver查询动态接受者赋值给registeredReceivers</span>
                registeredReceivers <span class="token operator">=</span> mReceiverResolver<span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span>
                        resolvedType<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*defaultOnly*/</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>IntentResolver的queryIntent函数<br> (动态接收者查询的使用mReceiverResolver的queryIntent来查询得到，<br> 而静态注册查询的使用也是通过mComponentResolver.mReceivers.queryIntent，都是使用一个方法)</li></ol> 
<p>=&gt; 通过***Filter(如mActionToFilter)找出匹配的fliter<br> =&gt; 通过buildResolveList构建可以被接收的结果<br> =&gt; 通过优先级排序返回查询结果</p> 
<pre><code class="prism language-java"><span class="token comment">//IntentResolver.java</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> <span class="token function">queryIntent</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> <span class="token keyword">boolean</span> defaultOnly<span class="token punctuation">,</span>
                               <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String scheme <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> finalList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> debug <span class="token operator">=</span> localLOGV <span class="token operator">||</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_DEBUG_LOG_RESOLUTION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
                TAG<span class="token punctuation">,</span> <span class="token string">"Resolving type="</span> <span class="token operator">+</span> resolvedType <span class="token operator">+</span> <span class="token string">" scheme="</span> <span class="token operator">+</span> scheme
                        <span class="token operator">+</span> <span class="token string">" defaultOnly="</span> <span class="token operator">+</span> defaultOnly <span class="token operator">+</span> <span class="token string">" userId="</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">" of "</span> <span class="token operator">+</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        F<span class="token punctuation">[</span><span class="token punctuation">]</span> firstTypeCut <span class="token operator">=</span> null<span class="token punctuation">;</span>
        F<span class="token punctuation">[</span><span class="token punctuation">]</span> secondTypeCut <span class="token operator">=</span> null<span class="token punctuation">;</span>
        F<span class="token punctuation">[</span><span class="token punctuation">]</span> thirdTypeCut <span class="token operator">=</span> null<span class="token punctuation">;</span>
        F<span class="token punctuation">[</span><span class="token punctuation">]</span> schemeCut <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment">// If the intent includes a MIME type, then we want to collect all of</span>
        <span class="token comment">// the filters that match that MIME type.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedType <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> slashpos <span class="token operator">=</span> resolvedType<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slashpos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> String baseType <span class="token operator">=</span> resolvedType<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> slashpos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedType<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> slashpos<span class="token operator">+</span><span class="token number">2</span>
                            <span class="token operator">||</span> resolvedType<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>slashpos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Not a wild card, so we can just look for all filters that</span>
                        <span class="token comment">// completely match or wildcards whose base type matches.</span>
                        firstTypeCut <span class="token operator">=</span> mTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"First type cut: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>firstTypeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        secondTypeCut <span class="token operator">=</span> mWildTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>baseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Second type cut: "</span>
                                <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>secondTypeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// We can match anything with our base type.</span>
                        firstTypeCut <span class="token operator">=</span> mBaseTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>baseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"First type cut: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>firstTypeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        secondTypeCut <span class="token operator">=</span> mWildTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>baseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Second type cut: "</span>
                                <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>secondTypeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// Any */* types always apply, but we only need to do this</span>
                    <span class="token comment">// if the intent type was not already */*.</span>
                    thirdTypeCut <span class="token operator">=</span> mWildTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Third type cut: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>thirdTypeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// The intent specified any type ({@literal *}/*).  This</span>
                    <span class="token comment">// can be a whole heck of a lot of things, so as a first</span>
                    <span class="token comment">// cut let's use the action instead.</span>
                    firstTypeCut <span class="token operator">=</span> mTypedActionToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Typed Action list: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>firstTypeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If the intent includes a data URI, then we want to collect all of</span>
        <span class="token comment">// the filters that match its scheme (we will further refine matches</span>
        <span class="token comment">// on the authority and path by directly matching each resulting filter).</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            schemeCut <span class="token operator">=</span> mSchemeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Scheme list: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>schemeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If the intent does not specify any data -- either a MIME type or</span>
        <span class="token comment">// a URI -- then we will only be looking for matches against empty</span>
        <span class="token comment">// data.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedType <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> scheme <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//这里就把所有的ParsedIntentInfo从mActionToFilter取出来了, key是action, value是Pair(ParsedActivity, ParsedIntentInfo)</span>
            <span class="token comment">//如我们之前动态注册的亮屏广播mDynamicReceiver，静态注册的开机广播MyReceiver</span>

<span class="token operator">/</span><span class="token operator">*</span>
<span class="token comment">//动态注册的亮屏广播mReceiverResolver.queryIntent时</span>
firstTypeCut <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>BroadcastFilter<span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token annotation punctuation">@39131</span><span class="token punctuation">}</span> 
<span class="token number">40</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>BroadcastFilter<span class="token annotation punctuation">@39150</span><span class="token punctuation">}</span> <span class="token string">"BroadcastFilter{8f17ce8 10214/u0 ReceiverList{50ee60b 9948 com.example.myapplication/10214/u0 remote:7781da}}"</span>

<span class="token comment">//静态注册的开机广播mComponentResolver.mReceivers.queryIntent时</span>
firstTypeCut <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>Pair<span class="token punctuation">[</span><span class="token number">316</span><span class="token punctuation">]</span><span class="token annotation punctuation">@38034</span><span class="token punctuation">}</span>
<span class="token number">107</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>Pair<span class="token annotation punctuation">@38369</span><span class="token punctuation">}</span> <span class="token string">"Pair{Activity{7d26902 com.example.myapplication/.MyReceiver2} ParsedIntentInfo{a218213}}"</span>
<span class="token number">108</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>Pair<span class="token annotation punctuation">@38370</span><span class="token punctuation">}</span> <span class="token string">"Pair{Activity{3985c50 com.example.myapplication/.MyReceiver} ParsedIntentInfo{9dfde49}}"</span>
<span class="token operator">*</span><span class="token operator">/</span>
            firstTypeCut <span class="token operator">=</span> mActionToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Action list: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>firstTypeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        FastImmutableArraySet<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> categories <span class="token operator">=</span> <span class="token function">getFastIntentCategories</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTypeCut <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    scheme<span class="token punctuation">,</span> firstTypeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>secondTypeCut <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    scheme<span class="token punctuation">,</span> secondTypeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thirdTypeCut <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    scheme<span class="token punctuation">,</span> thirdTypeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schemeCut <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    scheme<span class="token punctuation">,</span> schemeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//这里对于即时应用才有过滤效果，普通的是直接返回</span>
        <span class="token function">filterResults</span><span class="token punctuation">(</span>finalList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过getPriority优先级排序</span>
        <span class="token function">sortResults</span><span class="token punctuation">(</span>finalList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Final result list:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>finalList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"  "</span> <span class="token operator">+</span> finalList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> finalList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildResolveList</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> FastImmutableArraySet<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> categories<span class="token punctuation">,</span>
                                  <span class="token keyword">boolean</span> debug<span class="token punctuation">,</span> <span class="token keyword">boolean</span> defaultOnly<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> String scheme<span class="token punctuation">,</span>
                                  F<span class="token punctuation">[</span><span class="token punctuation">]</span> src<span class="token punctuation">,</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> dest<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取action</span>
        <span class="token keyword">final</span> String action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取data</span>
        <span class="token keyword">final</span> Uri data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取包名</span>
        <span class="token keyword">final</span> String packageName <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//是否flag包含了FLAG_INCLUDE_STOPPED_PACKAGES(发送给停止的包)</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> excludingStopped <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">isExcludingStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> Printer logPrinter<span class="token punctuation">;</span>
        <span class="token keyword">final</span> PrintWriter logPrintWriter<span class="token punctuation">;</span>
        <span class="token comment">//调试使用的debug开关,localLOGV或者设置了FLAG_DEBUG_LOG_RESOLUTION时debug会是true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logPrinter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>LOG_ID_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logPrintWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastPrintWriter</span><span class="token punctuation">(</span>logPrinter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            logPrinter <span class="token operator">=</span> null<span class="token punctuation">;</span>
            logPrintWriter <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> src <span class="token operator">!=</span> null <span class="token operator">?</span> src<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> hasNonDefaults <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        F filter<span class="token punctuation">;</span>
        <span class="token comment">//遍历需要筛选的src，动态广播是BroadcastFilter，静态广播是Pair</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>filter<span class="token operator">=</span>src<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> match<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Matching against filter "</span> <span class="token operator">+</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>excludingStopped<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//1. 静态广播的mComponentResolver.mReceivers是继承于ActivityIntentResolver的</span>
                <span class="token comment">// 其调用ComponentResolver.isFilterStopped会针对非系统应用判断是否stop停止的应用</span>
                <span class="token comment">// 主要代码是!ps.isSystem() &amp;&amp; ps.getStopped(userId);，这里就不扩展讲了</span>
                <span class="token comment">//2. 非静态广播mReceiverResolver是new IntentResolver，直接返回false</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFilterStopped</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"  Filter's target is stopped; skipping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Is delivery being limited to filters owned by a particular package?</span>
            <span class="token comment">//这里是当intent发送给特定包的时候，判断是否当前filter</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>packageName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isPackageForFilter</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"  Filter is not from package "</span> <span class="token operator">+</span> packageName <span class="token operator">+</span> <span class="token string">"; skipping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Are we verified ?</span>
            <span class="token comment">//获取filter，动态的是BroadcastFilter，静态的是ParsedIntentInfo</span>
            IntentFilter intentFilter <span class="token operator">=</span> <span class="token function">getIntentFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//查看是否带有STATE_VERIFY_AUTO，这里只是打印日志</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intentFilter<span class="token punctuation">.</span><span class="token function">getAutoVerify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localVerificationLOGV <span class="token operator">||</span> debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"  Filter verified: "</span> <span class="token operator">+</span> <span class="token function">isFilterVerified</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> authorities <span class="token operator">=</span> intentFilter<span class="token punctuation">.</span><span class="token function">countDataAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> z <span class="token operator">&lt;</span> authorities<span class="token punctuation">;</span> z<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"   "</span> <span class="token operator">+</span> intentFilter<span class="token punctuation">.</span><span class="token function">getDataAuthority</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Do we already have this one?</span>
            <span class="token comment">//如果在dest中添加过一样的，则不在添加，跳过</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">allowFilterResult</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"  Filter's target already added"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//判断过滤器是否匹配</span>
            match <span class="token operator">=</span> intentFilter<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> scheme<span class="token punctuation">,</span> data<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> TAG<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"  Filter matched!  match=0x"</span> <span class="token operator">+</span>
                        Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" hasDefault="</span>
                        <span class="token operator">+</span> intentFilter<span class="token punctuation">.</span><span class="token function">hasCategory</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>CATEGORY_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 对于接收者receiver来说：</span>
                <span class="token comment">// 动态注册者mReceiverResolver.queryIntent的时候传入的defaultOnly=false</span>
                <span class="token comment">// 静态注册者查询时需要设置了MATCH_DEFAULT_ONLY才会将defaultOnly设置成true，</span>
                <span class="token comment">// 默认AMS收集静态注册者的时候是没有设置这个flag的，于是defaultOnly都是false</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>defaultOnly <span class="token operator">||</span> intentFilter<span class="token punctuation">.</span><span class="token function">hasCategory</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>CATEGORY_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> R oneResult <span class="token operator">=</span> <span class="token function">newResult</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> match<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"    Created result: "</span> <span class="token operator">+</span> oneResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>oneResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//将匹配的filter生成的结果放入dest中</span>
                        dest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>oneResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">dumpFilter</span><span class="token punctuation">(</span>logPrintWriter<span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            logPrintWriter<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            intentFilter<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>logPrinter<span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    hasNonDefaults <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="38_oder_1443"></a>3.8 非oder的平行广播的入队与分发</h3> 
<p>如果没有设置ordered(也称之为serialized)按顺序，则针对动态注册类型的广播会一次性全部发送出去，<br> 于是我们可以看到类似这样的日志：“Enqueueing parallel broadcas ***”，<br> 这种无需等待APP的执行，很快系统就处理完了</p> 
<pre><code class="prism language-java">        <span class="token comment">//是否拥FLAG_RECEIVER_REPLACE_PENDING，这类广播会将旧的广播给覆盖替换掉</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> replacePending <span class="token operator">=</span>
                <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REPLACE_PENDING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">//replacePending也在调试开关下输出一下日志</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Enqueueing broadcast: "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">" replacePending="</span> <span class="token operator">+</span> replacePending<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//动态注册查询的时候没有传入broadcastAllowList(允许接收的uid列表)</span>
        <span class="token comment">//此处会根据broadcastAllowList(不为null才会过滤)来进行动态注册接收者的过滤</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>registeredReceivers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> broadcastAllowList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// if a uid whitelist was provided, remove anything in the application space that wasn't</span>
            <span class="token comment">// in it.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> registeredReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> owningAppId <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>registeredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>owningUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>owningAppId <span class="token operator">&gt;=</span> Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID
                        <span class="token operator">&amp;&amp;</span> Arrays<span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span>broadcastAllowList<span class="token punctuation">,</span> owningAppId<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    registeredReceivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> NR <span class="token operator">=</span> registeredReceivers <span class="token operator">!=</span> null <span class="token operator">?</span> registeredReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//先处理动态注册接收者的逻辑，如果该广播是非ordered(也就是无序广播)，则进入里面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ordered <span class="token operator">&amp;&amp;</span> NR <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If we are not serializing this broadcast, then send the</span>
            <span class="token comment">// registered receivers separately so they don't wait for the</span>
            <span class="token comment">// components to be launched.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isCallerSystem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">checkBroadcastFromSystem</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                        isProtectedBroadcast<span class="token punctuation">,</span> registeredReceivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//根据意图的flag是否有FLAG_RECEIVER_FOREGROUND来选择前台还是后台广播</span>
            <span class="token keyword">final</span> BroadcastQueue queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//只有ACTION_PRE_BOOT_COMPLETED timeoutExempt才会为true</span>
            <span class="token comment">//这里新建的BroadcastRecord r是动态广播注册者的广播记录对象</span>
            <span class="token comment">//这里将registeredReceivers动态接受者全部传入</span>
            BroadcastRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span>
                    callerFeatureId<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callerInstantApp<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    requiredPermissions<span class="token punctuation">,</span> excludedPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> brOptions<span class="token punctuation">,</span> registeredReceivers<span class="token punctuation">,</span>
                    resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                    allowBackgroundActivityStarts<span class="token punctuation">,</span> backgroundActivityStartsToken<span class="token punctuation">,</span>
                    timeoutExempt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 由于是非order的，将这个广播的平行接收者放入队列中(动态注册的广播registeredReceivers)</span>
            <span class="token comment">// 这就是所谓的平行广播的发送，发送后无需等待，一次性全部发完</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Enqueueing parallel broadcast "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置了flag FLAG_RECEIVER_REPLACE_PENDING的广播，会替换掉BroadcastQueue旧的广播</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> replaced <span class="token operator">=</span> replacePending
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">replaceParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Note: We assume resultTo is null for non-ordered broadcasts.</span>
            <span class="token comment">//如果是普通的广播，非替换的的情况</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replaced<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//则将该BroadcastRecord放入BroadcastQueue的mParallelBroadcasts平行广播列表中</span>
                queue<span class="token punctuation">.</span><span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//BroadcastQueue进行广播的正常分发</span>
                queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//清空动态接收者，已经处理过了</span>
            registeredReceivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
            NR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="38_order_1514"></a>3.8 order广播接收者的过滤</h3> 
<p>=&gt; 如果设置ordered(也称之为serialized)按顺序，不管是动态还是静态的注册者都是放入order的广播里面发送<br> =&gt; 如果没有设置ordered，则只放入静态接收者。（普通的广播会有2个队列发送，一个是parallel broadcast，一个是ordered broadcast）<br> =&gt; 最终不管是静态还是动态注册的广播，只要是需要order发送的都会合并到receivers中，排序是按照优先级(android:order/IntentFilter.setPriority设置的优先级)</p> 
<p>广播发送时看到类似这样的日志：“Enqueueing ordered broadcast ***”，<br> 需要按顺序执行，前面一个接收者执行完成后才能让后面的继续执行，同时前面的可以中断后面接收者的执行</p> 
<pre><code class="prism language-java">        <span class="token comment">// Merge into one list.</span>
        <span class="token keyword">int</span> ir <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//处理静态接收者</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// A special case for PACKAGE_ADDED: do not allow the package</span>
            <span class="token comment">// being added to see this broadcast.  This prevents them from</span>
            <span class="token comment">// using this as a back door to get run as soon as they are</span>
            <span class="token comment">// installed.  Maybe in the future we want to have a special install</span>
            <span class="token comment">// broadcast or such for apps, but we'd like to deliberately make</span>
            <span class="token comment">// this decision.</span>
            String skipPackages<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment">//针对ACTION_PACKAGE_ADDED/ACTION_PACKAGE_RESTARTED/ACTION_PACKAGE_DATA_CLEARED</span>
            <span class="token comment">//这类广播不允许被安装的package接收(自己接收自己安装的广播不允许)，防止自启</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_PACKAGE_ADDED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_RESTARTED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_DATA_CLEARED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Uri data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    String pkgName <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        skipPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> pkgName <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_EXTERNAL_APPLICATIONS_AVAILABLE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                skipPackages <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringArrayExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_CHANGED_PACKAGE_LIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//将跳过的packageName从receivers中移除</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>skipPackages <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>skipPackages<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String skipPackage <span class="token operator">:</span> skipPackages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>skipPackage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">int</span> NT <span class="token operator">=</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> it<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> it<span class="token operator">&lt;</span>NT<span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            ResolveInfo curt <span class="token operator">=</span> <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>curt<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>skipPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                receivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                it<span class="token operator">--</span><span class="token punctuation">;</span>
                                NT<span class="token operator">--</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//NT是静态接收者的个数，NR是动态接收者的个数</span>
            <span class="token keyword">int</span> NT <span class="token operator">=</span> receivers <span class="token operator">!=</span> null <span class="token operator">?</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> it <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            ResolveInfo curt <span class="token operator">=</span> null<span class="token punctuation">;</span>
            BroadcastFilter curr <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment">// 遍历静态接收者receivers和动态接收者registeredReceivers</span>
            <span class="token comment">// ir &lt; NR代表还是存在动态接收者，由于非order的动态接收者上面已经发送完成，</span>
            <span class="token comment">// 那么这里只会是order的广播的动态接收者</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">&lt;</span> NT <span class="token operator">&amp;&amp;</span> ir <span class="token operator">&lt;</span> NR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//取出第it个静态接收者curt</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curt <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    curt <span class="token operator">=</span> <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//取出ir个动态接收者curr</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curr <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    curr <span class="token operator">=</span> registeredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//动态接收者的优先级是存放在IntentFilter的mPriority, 通过IntentFilter的setPriority设置</span>
                <span class="token comment">//静态接收者的优先级是存放在ResolveInfo的priority，通过android:priority设置</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curr<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> curt<span class="token punctuation">.</span>priority<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Insert this broadcast record into the final list.</span>
                    <span class="token comment">// 如果动态接收者curr的优先级大于静态接收者curt的优先级，</span>
                    <span class="token comment">// 则将动态接收者curr放入原来静态接收者(curt)it的位置，</span>
                    <span class="token comment">// 在这之前静态接收者(curt)it已经取出来了，这里只是用动态接收者curr来填充it的位置</span>
                    receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//动态接收者用过了则ir++, 而且将curr = null置为空，再次取下一个动态接收者</span>
                    <span class="token comment">//当前receivers it的位置存放动态接收者curr</span>
                    ir<span class="token operator">++</span><span class="token punctuation">;</span>
                    curr <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token comment">//同时这里使用了list add的特性，当一个元素增加到it时，其从it到NT的元素自动+1</span>
                    <span class="token comment">//于是下一个元素就是it++</span>
                    it<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment">//receivers新增了一个元素，于是总大小NT++</span>
                    NT<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Skip to the next ResolveInfo in the final list.</span>
                    <span class="token comment">//否则静态接收者curt的it++，同时curt = null，再次取下一个静态接收者</span>
                    <span class="token comment">//当前receivers it的位置存放静态接收者curt</span>
                    it<span class="token operator">++</span><span class="token punctuation">;</span>
                    curt <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果动态接收者还没有遍历完，说明最新的ir动态接收者curr的</span>
        <span class="token comment">// 优先级小于receivers最后一个静态接收者curt的优先级，</span>
        <span class="token comment">// 则将剩下的registeredReceivers全部加入到receivers的尾部</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ir <span class="token operator">&lt;</span> NR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                receivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registeredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ir<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//isCallerSystem(前面有解释)是否系统调用发送广播</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCallerSystem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//查看一下发送的是否保护的广播</span>
            <span class="token function">checkBroadcastFromSystem</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                    isProtectedBroadcast<span class="token punctuation">,</span> receivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>receivers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//根据意图的flag是否有FLAG_RECEIVER_FOREGROUND来选择前台还是后台广播</span>
            BroadcastQueue queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 构建有序的BroadcastRecord，如果ordered = true则包含静态和动态接收者，</span>
            <span class="token comment">// 如果ordered = false则只包含静态接收者，由于静态接收者都是有序发送的，</span>
            <span class="token comment">// 故其实这个receivers全部都是有序接收的接收者</span>
            BroadcastRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span>
                    callerFeatureId<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callerInstantApp<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    requiredPermissions<span class="token punctuation">,</span> excludedPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> brOptions<span class="token punctuation">,</span>
                    receivers<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span>
                    ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> allowBackgroundActivityStarts<span class="token punctuation">,</span>
                    backgroundActivityStartsToken<span class="token punctuation">,</span> timeoutExempt<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//静态注册的广播在receivers中，发送ordered 按顺序接收广播</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Enqueueing ordered broadcast "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//设置了flag FLAG_RECEIVER_REPLACE_PENDING的广播，会替换掉BroadcastQueue旧的广播</span>
            <span class="token keyword">final</span> BroadcastRecord oldRecord <span class="token operator">=</span>
                    replacePending <span class="token operator">?</span> queue<span class="token punctuation">.</span><span class="token function">replaceOrderedBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Replaced, fire the result-to receiver.</span>
                <span class="token comment">//存在旧的oldRecord(有序的)，而且resultTo不为null</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> BroadcastQueue oldQueue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//则告诉原来的调用者oldRecord.callerApp,这个广播已经给cancel掉了</span>
                        oldQueue<span class="token punctuation">.</span><span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>callerApp<span class="token punctuation">,</span> oldRecord<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                                oldRecord<span class="token punctuation">.</span>intent<span class="token punctuation">,</span>
                                Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                                <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> oldRecord<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failure ["</span>
                                <span class="token operator">+</span> queue<span class="token punctuation">.</span>mQueueName <span class="token operator">+</span> <span class="token string">"] sending broadcast result of "</span>
                                <span class="token operator">+</span> intent<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//将order的广播放入mDispatcher的mOrderedBroadcasts中去</span>
                queue<span class="token punctuation">.</span><span class="token function">enqueueOrderedBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// There was nobody interested in the broadcast, but we still want to record</span>
            <span class="token comment">// that it happened.</span>
            <span class="token comment">// 如果接收者receivers为null，而且resultTo也是null，则到这里已经没有人关注</span>
            <span class="token comment">// 如果不是发送给特定的包或者组件，而且不是只发送给动态注册的广播</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This was an implicit broadcast... let's record it for posterity.</span>
                <span class="token comment">// 则记录一下这个广播的信息</span>
                <span class="token function">addBroadcastStatLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//返回成功发送</span>
        <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="4__1695"></a>4. 广播队列的处理</h2> 
<p>前面讲的是过滤接收者，然后将信息放入广播队列中，那么广播队列是如何处理这类信息的呢？</p> 
<p>这一节我们接下去讲解广播队列处理流程</p> 
<h3><a id="41__1701"></a>4.1 新建广播队列</h3> 
<p>目前有3个广播队列，一个是前台、一个是后台、一个是Offload的广播队列<br> 其中前台广播超时时间是10s，后台是60s，Offload的广播也是60s</p> 
<pre><code class="prism language-java"><span class="token comment">//ActivityManagerService.java</span>
    <span class="token comment">//前台广播队列</span>
    <span class="token keyword">final</span> BroadcastQueue mFgBroadcastQueue<span class="token punctuation">;</span>
    <span class="token comment">//后台广播队列</span>
    <span class="token keyword">final</span> BroadcastQueue mBgBroadcastQueue<span class="token punctuation">;</span>
    <span class="token comment">//Offload的广播队列(默认这个没有使用)</span>
    <span class="token keyword">final</span> BroadcastQueue mOffloadBroadcastQueue<span class="token punctuation">;</span>
    <span class="token comment">// Convenient for easy iteration over the queues. Foreground is first</span>
    <span class="token comment">// so that dispatch of foreground broadcasts gets precedence.</span>
	<span class="token comment">//总的广播队列</span>
    <span class="token keyword">final</span> BroadcastQueue<span class="token punctuation">[</span><span class="token punctuation">]</span> mBroadcastQueues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastQueue</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token function">ActivityManagerService</span><span class="token punctuation">(</span>Context systemContext<span class="token punctuation">,</span> ActivityTaskManagerService atm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
        <span class="token comment">// Broadcast policy parameters</span>
        <span class="token keyword">final</span> BroadcastConstants foreConstants <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastConstants</span><span class="token punctuation">(</span>
                Settings<span class="token punctuation">.</span>Global<span class="token punctuation">.</span>BROADCAST_FG_CONSTANTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//前台广播超时时间是10s</span>
        foreConstants<span class="token punctuation">.</span>TIMEOUT <span class="token operator">=</span> BROADCAST_FG_TIMEOUT<span class="token punctuation">;</span>

        <span class="token keyword">final</span> BroadcastConstants backConstants <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastConstants</span><span class="token punctuation">(</span>
                Settings<span class="token punctuation">.</span>Global<span class="token punctuation">.</span>BROADCAST_BG_CONSTANTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//后台广播超时时间是60s</span>
        backConstants<span class="token punctuation">.</span>TIMEOUT <span class="token operator">=</span> BROADCAST_BG_TIMEOUT<span class="token punctuation">;</span>

        <span class="token keyword">final</span> BroadcastConstants offloadConstants <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastConstants</span><span class="token punctuation">(</span>
                Settings<span class="token punctuation">.</span>Global<span class="token punctuation">.</span>BROADCAST_OFFLOAD_CONSTANTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        offloadConstants<span class="token punctuation">.</span>TIMEOUT <span class="token operator">=</span> BROADCAST_BG_TIMEOUT<span class="token punctuation">;</span>
        <span class="token comment">// by default, no "slow" policy in this queue</span>
		<span class="token comment">//没有SLOW_TIME，不使用延迟策略广播</span>
        offloadConstants<span class="token punctuation">.</span>SLOW_TIME <span class="token operator">=</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>

		<span class="token comment">//默认是没有使用Offload的广播的</span>
        mEnableOffloadQueue <span class="token operator">=</span> SystemProperties<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                <span class="token string">"persist.device_config.activity_manager_native_boot.offload_queue_enabled"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//这里的mHandler是AMS的MainHandler，优先级是THREAD_PRIORITY_FOREGROUND前台</span>
        mFgBroadcastQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span>
                <span class="token string">"foreground"</span><span class="token punctuation">,</span> foreConstants<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBgBroadcastQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span>
                <span class="token string">"background"</span><span class="token punctuation">,</span> backConstants<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mOffloadBroadcastQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span>
                <span class="token string">"offload"</span><span class="token punctuation">,</span> offloadConstants<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBroadcastQueues<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> mFgBroadcastQueue<span class="token punctuation">;</span>
        mBroadcastQueues<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> mBgBroadcastQueue<span class="token punctuation">;</span>
        mBroadcastQueues<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> mOffloadBroadcastQueue<span class="token punctuation">;</span>

		<span class="token comment">//...</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="42__1759"></a>4.2 广播接收者入队列</h3> 
<ol><li>平行广播接收者enqueueParallelBroadcastLocked入队列</li></ol> 
<p>这里入队列就是全部丢入广播队列BroadcastQueue的mParallelBroadcasts中</p> 
<pre><code class="prism language-java"><span class="token comment">//BroadcastQueue.java</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enqueueBroadcastHelper</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>order广播接收者enqueueOrderedBroadcastLocked入队列</li></ol> 
<p>这里多了一个中转mDispatcher(BroadcastDispatcher)，放入的其实是BroadcastDispatcher的mOrderedBroadcasts中</p> 
<pre><code class="prism language-java"><span class="token comment">//BroadcastQueue.java</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueueOrderedBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mDispatcher<span class="token punctuation">.</span><span class="token function">enqueueOrderedBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enqueueBroadcastHelper</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">//BroadcastDispatcher.java</span>
    <span class="token keyword">void</span> <span class="token function">enqueueOrderedBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="43__1791"></a>4.3 广播队列的分发</h3> 
<p>一般外部调用(非BroadcastQueue中)分发有2种<br> 1、scheduleBroadcastsLocked 让广播队列开始调度分发广播。如：发送广播的时候，平行广播分发、order广播分发使用的方式；注册的时候发送粘性广播也是使用这个方式<br> 2、processNextBroadcastLocked 直接处理下一个广播。如：order广播中上一个广播处理完成后(这个比较常见，一会也会讲)、unregister的时候</p> 
<ol><li>scheduleBroadcastsLocked让广播队列开始调度分发广播<br> 调用这个函数需要加入AMS的锁，也就是Thread.holdsLock(mService)需要返回true(原生调用都是包含这个锁的，注意新增的调用)</li></ol> 
<p>scheduleBroadcastsLocked通过mHandler发送BROADCAST_INTENT_MSG -&gt; processNextBroadcast(true)开始处理下一个广播分发</p> 
<pre><code class="prism language-java"><span class="token comment">//BroadcastQueue.java</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Schedule broadcasts ["</span>
                <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"]: current="</span>
                <span class="token operator">+</span> mBroadcastsScheduled<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//是否mBroadcastsScheduled正在调度中，调度中则先返回，如果出现广播堆积优先查看这个值是否一直等于true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBroadcastsScheduled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//通过mHandler(其looper和AMS的MainHandler是一个looper)发送BROADCAST_INTENT_MSG</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_INTENT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token function">BroadcastHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> BROADCAST_INTENT_MSG<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
                            TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Received BROADCAST_INTENT_MSG ["</span>
                                    <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//开始下一个广播的处理，传入的fromMsg是true</span>
                    <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> BROADCAST_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//广播超时的处理</span>
                        <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//注意从handler的持有mService的锁</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//此处skipOomAdj是false，也就是需要调整OomAdj</span>
            <span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span>fromMsg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="44__1852"></a>4.4 处理分发下一个广播</h3> 
<p>processNextBroadcastLocked下一个广播分发</p> 
<h4><a id="441_mParallelBroadcasts_1858"></a>4.4.1 mParallelBroadcasts平行广播的分发</h4> 
<ol><li>mParallelBroadcasts平行广播是一次性全部丢出去的，通过deliverToRegisteredReceiverLocked来分发到动态接收者</li></ol> 
<pre><code class="prism language-java">    <span class="token comment">//分发下一个广播</span>
    <span class="token comment">//fromMsg：是否从handleMessage(BROADCAST_INTENT_MSG)而来</span>
    <span class="token comment">//skipOomAdj：是否需要跳过adj调整，AMS的unregisterReceiver、finishReceiver过来是true，</span>
    <span class="token comment">//BroadcastQueue过来是false</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> skipOomAdj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//BroadcastRecord广播的记录者，需要分发的广播</span>
        BroadcastRecord r<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"processNextBroadcast ["</span>
                <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"]: "</span>
                <span class="token operator">+</span> mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" parallel broadcasts; "</span>
                <span class="token operator">+</span> mDispatcher<span class="token punctuation">.</span><span class="token function">describeStateLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//更新mProcessCpuMutexFree，可以继续执行updateCpuStatsNow</span>
        mService<span class="token punctuation">.</span><span class="token function">updateCpuStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//如果fromMsg == ture，则设置mBroadcastsScheduled为true，允许scheduleBroadcastsLocked下一个BROADCAST_INTENT_MSG</span>
        <span class="token comment">//注意原生逻辑scheduleBroadcastsLocked和processNextBroadcastLocked都持有AMS的锁，不然mBroadcastsScheduled会出现线程冲突导致广播堆积</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// First, deliver any non-serialized broadcasts right away.</span>
        <span class="token comment">//第一步：先分发mParallelBroadcasts平行的广播队列</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//取出平行广播队列里面的第一个BroadcastRecord</span>
            r <span class="token operator">=</span> mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置BroadcastRecord r广播分发时间dispatchTime</span>
            r<span class="token punctuation">.</span>dispatchTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//System.currentTimeMillis()获取的是系统时钟的时间，修改系统时间这个时间会变化</span>
            r<span class="token punctuation">.</span>dispatchClockTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果打开了"am"的tag会记录trace的日志</span>
            <span class="token comment">//"am",         "Activity Manager",         ATRACE_TAG_ACTIVITY_MANAGER,</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Trace<span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//结束DELIVERY_PENDING的trace</span>
                Trace<span class="token punctuation">.</span><span class="token function">asyncTraceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span>
                        <span class="token function">createBroadcastTraceTitle</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_PENDING<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//开始DELIVERY_DELIVERED的trace</span>
                Trace<span class="token punctuation">.</span><span class="token function">asyncTraceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span>
                        <span class="token function">createBroadcastTraceTitle</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_DELIVERED<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_LIGHT<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Processing parallel broadcast ["</span>
                    <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//遍历构建 BroadcastRecord 的所有receivers</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Object target <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span>  Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                        <span class="token string">"Delivering non-ordered on ["</span> <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] to registered "</span>
                                <span class="token operator">+</span> target <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span> target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_LIGHT<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Done with parallel broadcast ["</span>
                    <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
```java

<span class="token number">2</span><span class="token punctuation">)</span> deliverToRegisteredReceiverLocked分发到动态接收者

deliverToRegisteredReceiverLocked <span class="token operator">-</span><span class="token operator">&gt;</span> performReceiveLocked


```java
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span>
                                                   BroadcastFilter filter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
		<span class="token comment">//前面是各类跳过skip的场景</span>

        r<span class="token punctuation">.</span>delivery<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_DELIVERED<span class="token punctuation">;</span>

        <span class="token comment">// If this is not being sent as an ordered broadcast, then we</span>
        <span class="token comment">// don't want to touch the fields that keep track of the current</span>
        <span class="token comment">// state of ordered broadcasts.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//order分发的时候，会有r.receiver的设置</span>
            r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>curFilter <span class="token operator">=</span> filter<span class="token punctuation">;</span>
            filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>curBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>CALL_IN_RECEIVE<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Bump hosting application to no longer be in background</span>
                <span class="token comment">// scheduling class.  Note that we can't do that if there</span>
                <span class="token comment">// isn't an app...  but we can only be in that case for</span>
                <span class="token comment">// things that directly call the IActivityManager API, which</span>
                <span class="token comment">// are already core system stuff so don't matter for this.</span>
                r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">;</span>
                filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span>mReceivers<span class="token punctuation">.</span><span class="token function">addCurReceiver</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span><span class="token function">enqueueOomAdjTargetLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span><span class="token function">updateOomAdjPendingTargetsLocked</span><span class="token punctuation">(</span>
                        OomAdjuster<span class="token punctuation">.</span>OOM_ADJ_REASON_START_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span>mOomAdjuster<span class="token punctuation">.</span>mCachedAppOptimizer<span class="token punctuation">.</span><span class="token function">unfreezeTemporarily</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_LIGHT<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                    <span class="token string">"Delivering to "</span> <span class="token operator">+</span> filter <span class="token operator">+</span> <span class="token string">" : "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">isInFullBackup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Skip delivery if full backup in progress</span>
                <span class="token comment">// If it's an ordered broadcast, we need to continue to the next receiver.</span>
                <span class="token comment">//全备份的app接收这才会到这里</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">skipReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//一般跑的这里</span>
                r<span class="token punctuation">.</span>receiverTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">maybeAddAllowBackgroundActivityStartsToken</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">maybeScheduleTempAllowlistLocked</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>owningUid<span class="token punctuation">,</span> r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//接下去运行的是performReceiveLocked</span>
                <span class="token comment">//filter.receiverList.app是动态注册的callerApp, filter.receiverList.receiver是动态注册是传入的IIntentReceiver</span>
                <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">,</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>receiver<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>initialSticky<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// parallel broadcasts are fire-and-forget, not bookended by a call to</span>
                <span class="token comment">// finishReceiverLocked(), so we manage their activity-start token here</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> null
                        <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>allowBackgroundActivityStarts <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">postActivityStartTokenRemoval</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>CALL_DONE_RECEIVE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failure sending broadcast "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Clean up ProcessRecord state related to this broadcast attempt</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">removeAllowBackgroundActivityStartsToken</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span>mReceivers<span class="token punctuation">.</span><span class="token function">removeCurReceiver</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Something wrong, its oom adj could be downgraded, but not in a hurry.</span>
                    mService<span class="token punctuation">.</span><span class="token function">enqueueOomAdjTargetLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// And BroadcastRecord state related to ordered delivery, if appropriate</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//异常还原</span>
                r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>curFilter <span class="token operator">=</span> null<span class="token punctuation">;</span>
                filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>curBroadcast <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li>performReceiveLocked返回结果给动态接收者</li></ol> 
<p>performReceiveLocked返回结果给动态接收者(该函数还在广播发送时用于结果返回)</p> 
<pre><code class="prism language-java">
    <span class="token keyword">void</span> <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> IIntentReceiver receiver<span class="token punctuation">,</span>
                              Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String data<span class="token punctuation">,</span> Bundle extras<span class="token punctuation">,</span>
                              <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Send the intent to the receiver asynchronously using one-way binder calls.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> IApplicationThread thread <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// If we have an app thread, do the call through that so it is</span>
                <span class="token comment">// correctly ordered with other one-way calls.</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//调用app进程的scheduleRegisteredReceiver,分发到app进程</span>
                    <span class="token comment">//scheduleRegisteredReceiver包括: updateProcessState进程状态更新/receiver.performReceive执行</span>
                    <span class="token comment">//receiver调用的是LoadedApk.ReceiverDispatcher的performReceive -&gt; mActivityThread.post一般是主线成去分发广播</span>
                    thread<span class="token punctuation">.</span><span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                            data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">,</span>
                            app<span class="token punctuation">.</span>mState<span class="token punctuation">.</span><span class="token function">getReportedProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// TODO: Uncomment this when (b/28322359) is fixed and we aren't getting</span>
                    <span class="token comment">// DeadObjectException when the process isn't actually dead.</span>
                    <span class="token comment">//} catch (DeadObjectException ex) {<!-- --></span>
                    <span class="token comment">// Failed to call into the process.  It's dying so just let it die and move on.</span>
                    <span class="token comment">//    throw ex;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Failed to call into the process. It's either dying or wedged. Kill it gently.</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Can't deliver broadcast to "</span> <span class="token operator">+</span> app<span class="token punctuation">.</span>processName
                                <span class="token operator">+</span> <span class="token string">" (pid "</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"). Crashing it."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        app<span class="token punctuation">.</span><span class="token function">scheduleCrashLocked</span><span class="token punctuation">(</span><span class="token string">"can't deliver broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Application has died. Receiver doesn't exist.</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token string">"app.thread must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//否者直接给到receiver的performReceive</span>
            receiver<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                    sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>ActivityThread.java的scheduleRegisteredReceiver(这里已经是app线程了)</li></ol> 
<p>IIntentReceiver在之前的文章“Android S动态广播注册流程”里面已经提到是：LoadedApk.ReceiverDispatcher得到mIIntentReceiver</p> 
<pre><code class="prism language-java"><span class="token comment">//ActivityThread.java</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span>IIntentReceiver receiver<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span>
                <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String dataStr<span class="token punctuation">,</span> Bundle extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//更新app的进程状态processState</span>
            <span class="token function">updateProcessState</span><span class="token punctuation">(</span>processState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//调用IIntentReceiver的performReceive发送广播</span>
            receiver<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> dataStr<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                    sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token comment">//LoadedApk.java</span>
<span class="token comment">//LoadedApk.ReceiverDispatcher.InnerReceiver.performReceive</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String data<span class="token punctuation">,</span>
                    Bundle extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher rd<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Null intent received"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    rd <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//mDispatcher是ReceiverDispatcher</span>
                    rd <span class="token operator">=</span> mDispatcher<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> seq <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span><span class="token string">"seq"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span> <span class="token string">"Receiving broadcast "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" seq="</span> <span class="token operator">+</span> seq <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rd <span class="token operator">!=</span> null <span class="token operator">?</span> rd<span class="token punctuation">.</span>mReceiver <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//一般执行的是这里LoadedApk.ReceiverDispatcher的performReceive</span>
                    rd<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span>
                            ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// The activity manager dispatched a broadcast to a registered</span>
                    <span class="token comment">// receiver in this process, but before it could be delivered the</span>
                    <span class="token comment">// receiver was unregistered.  Acknowledge the broadcast on its</span>
                    <span class="token comment">// behalf so that the system's broadcast sequence can continue.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>
                            <span class="token string">"Finishing broadcast to unregistered receiver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>extras <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            extras<span class="token punctuation">.</span><span class="token function">setAllowFds</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mgr<span class="token punctuation">.</span><span class="token function">finishReceiver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

		<span class="token comment">//ReceiverDispatcher.performReceive</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String data<span class="token punctuation">,</span>
                Bundle extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> Args args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                    sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Null intent received"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> seq <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span><span class="token string">"seq"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span> <span class="token string">"Enqueueing broadcast "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" seq="</span> <span class="token operator">+</span> seq <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> mReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
			
			<span class="token comment">//这里是通过mActivityThread线程(一般是app主线程，也可以自己传入Handler scheduler当做调度线程)</span>
			<span class="token comment">//实际是在调度线程中运行new Args的run方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>mActivityThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">getRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>
                            <span class="token string">"Finishing sync broadcast to "</span> <span class="token operator">+</span> mReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    args<span class="token punctuation">.</span><span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>app动态注册的BroadcastReceiver接收与返回结果</li></ol> 
<p>=&gt; BroadcastReceiver的onReceive执行<br> =&gt; 处理完成后，调用AMS的finishReceiver，告诉系统该接受者已经处理完了</p> 
<pre><code class="prism language-java"><span class="token comment">//LoadedApk.java</span>
        <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver<span class="token punctuation">.</span>PendingResult</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">private</span> Intent mCurIntent<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> mOrdered<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token keyword">boolean</span> mDispatched<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token keyword">boolean</span> mRunCalled<span class="token punctuation">;</span>

            <span class="token keyword">public</span> <span class="token function">Args</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span> Bundle resultExtras<span class="token punctuation">,</span>
                    <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span>
                        mRegistered <span class="token operator">?</span> TYPE_REGISTERED <span class="token operator">:</span> TYPE_UNREGISTERED<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                        sticky<span class="token punctuation">,</span> mIIntentReceiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendingUser<span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mCurIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
                mOrdered <span class="token operator">=</span> ordered<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">final</span> Runnable <span class="token function">getRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> BroadcastReceiver receiver <span class="token operator">=</span> mReceiver<span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered <span class="token operator">=</span> mOrdered<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">int</span> seq <span class="token operator">=</span> mCurIntent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span><span class="token string">"seq"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span> <span class="token string">"Dispatching broadcast "</span> <span class="token operator">+</span> mCurIntent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">" seq="</span> <span class="token operator">+</span> seq <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> mReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span> <span class="token string">"  mRegistered="</span> <span class="token operator">+</span> mRegistered
                                <span class="token operator">+</span> <span class="token string">" mOrderedHint="</span> <span class="token operator">+</span> ordered<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> mCurIntent<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Null intent being dispatched, mDispatched="</span> <span class="token operator">+</span> mDispatched
                                <span class="token operator">+</span> <span class="token punctuation">(</span>mRunCalled <span class="token operator">?</span> <span class="token string">", run() has already been called"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    mCurIntent <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mDispatched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    mRunCalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> null <span class="token operator">||</span> intent <span class="token operator">==</span> null <span class="token operator">||</span> mForgotten<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>
                                    <span class="token string">"Finishing null broadcast to "</span> <span class="token operator">+</span> mReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span> <span class="token string">"broadcastReceiveReg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        ClassLoader cl <span class="token operator">=</span> mReceiver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// TODO: determine at registration time if caller is</span>
                        <span class="token comment">// protecting themselves with signature permission</span>
                        intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span><span class="token function">isProtectedBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                mContext<span class="token punctuation">.</span><span class="token function">getAttributionSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">//这里就是调用BroadcastReceiver的onReceive方法了</span>
						<span class="token comment">//如之前例子中，此时会输出"MyReceiver dynamic intent = android.intent.action.SCREEN_ON"</span>
                        receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>
                                    <span class="token string">"Finishing failed broadcast to "</span> <span class="token operator">+</span> mReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstrumentation <span class="token operator">==</span> null <span class="token operator">||</span>
                                <span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>mReceiver<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                                    <span class="token string">"Error receiving broadcast "</span> <span class="token operator">+</span> intent
                                            <span class="token operator">+</span> <span class="token string">" in "</span> <span class="token operator">+</span> mReceiver<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getPendingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//结束这个接收者的广播分发，finish(BroadcastReceiver.java)-&gt;</span>
                        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token comment">//BroadcastReceiver.java</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mType <span class="token operator">==</span> TYPE_COMPONENT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>QueuedWork<span class="token punctuation">.</span><span class="token function">hasPendingWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If this is a broadcast component, we need to make sure any</span>
                    <span class="token comment">// queued work is complete before telling AM we are done, so</span>
                    <span class="token comment">// we don't have our process killed before that.  We now know</span>
                    <span class="token comment">// there is pending work; put another piece of work at the end</span>
                    <span class="token comment">// of the list to finish the broadcast, so we don't block this</span>
                    <span class="token comment">// thread (which may be the main thread) to have it finished.</span>
                    <span class="token comment">//</span>
                    <span class="token comment">// Note that we don't need to use QueuedWork.addFinisher() with the</span>
                    <span class="token comment">// runnable, since we know the AM is waiting for us until the</span>
                    <span class="token comment">// executor gets to it.</span>
                    QueuedWork<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>
                                    <span class="token string">"Finishing broadcast after work to component "</span> <span class="token operator">+</span> mToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>
                            <span class="token string">"Finishing broadcast to component "</span> <span class="token operator">+</span> mToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//发送给静态组件后返回AMS的情况</span>
                    <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrderedHint <span class="token operator">&amp;&amp;</span> mType <span class="token operator">!=</span> TYPE_UNREGISTERED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>
                        <span class="token string">"Finishing broadcast to "</span> <span class="token operator">+</span> mToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//发送给动态接收者后返回AMS的情况，非order的是没有结果返回的</span>
                <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

       <span class="token comment">//完成接收处理后app返回AMS</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendFinished</span><span class="token punctuation">(</span>IActivityManager am<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Broadcast already finished"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mFinished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mResultExtras <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        mResultExtras<span class="token punctuation">.</span><span class="token function">setAllowFds</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrderedHint<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//order的调用的多了mResultCode、mResultData、mResultExtras、</span>
						<span class="token comment">//mAbortBroadcast(是否中断后续接收者，app使用abortBroadcast设置)</span>
						<span class="token comment">//包含静态和动态接收者</span>
                        am<span class="token punctuation">.</span><span class="token function">finishReceiver</span><span class="token punctuation">(</span>mToken<span class="token punctuation">,</span> mResultCode<span class="token punctuation">,</span> mResultData<span class="token punctuation">,</span> mResultExtras<span class="token punctuation">,</span>
                                mAbortBroadcast<span class="token punctuation">,</span> mFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// This broadcast was sent to a component; it is not ordered,</span>
                        <span class="token comment">// but we still need to tell the activity manager we are done.</span>
						<span class="token comment">//非order的情况，这里只会是组件接收的时候返回</span>
                        am<span class="token punctuation">.</span><span class="token function">finishReceiver</span><span class="token punctuation">(</span>mToken<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="442_mPendingBroadcast_2311"></a>4.4.2 mPendingBroadcast挂起广播的处理</h4> 
<p>mPendingBroadcast是正在处理的有序队列中的广播，由于进程没有启动，先挂起了。<br> Need to start app 的时候会设置mPendingBroadcast = r</p> 
<p>需要先把mPendingBroadcast处理完成才能处理下一个有序队列中的广播</p> 
<pre><code class="prism language-java">        <span class="token comment">// Now take care of the next serialized one...</span>

        <span class="token comment">// If we are waiting for a process to come up to handle the next</span>
        <span class="token comment">// broadcast, then do nothing at this point.  Just in case, we</span>
        <span class="token comment">// check that the process we're waiting for still exists.</span>
        <span class="token comment">// 分析是建议打开日志 DEBUG_BROADCAST DEBUG_BROADCAST_BACKGROUND DEBUG_BROADCAST_DEFERRAL DEBUG_BROADCAST_LIGHT</span>
        <span class="token comment">// 至于DEBUG_ALL也可以考虑打开</span>
        <span class="token comment">// Need to start app 的时候会设置mPendingBroadcast = r;</span>
        <span class="token comment">// 1. 如果进程没有启动，则首先启动进程startProcessLocked(am_proc_start)</span>
        <span class="token comment">// 2. 并将这个广播放入mPendingBroadcast中去,同时mPendingBroadcast.curApp = 下一个处理广播的进程</span>
        <span class="token comment">// 3. 当进程启动而且进行attachApplicationLocked(AMS)(am_proc_bound)/bindApplication的时候</span>
        <span class="token comment">// 调用attachApplicationLocked(AMS)-&gt;sendPendingBroadcastsLocked-&gt;processCurBroadcastLocked将该广播传递给curApp-&gt; scheduleReceiver(ActivityThread)</span>
        <span class="token comment">// 此时也会清除mPendingBroadcast = null,代表已经处理过了</span>
        <span class="token comment">// 4. 当广播处理完成后会从app回传AMS</span>
        <span class="token comment">// 动态注册完成广播LoadedApk.ReceiverDispatcher.Args -&gt; mActivityThread.post(args.getRunnable()) -&gt; finish(BroadcastReceiver.java)</span>
        <span class="token comment">// deliverToRegisteredReceiverLocked/performReceiveLocked -&gt; app.thread.scheduleRegisteredReceiver -&gt; receiver.performReceive</span>
        <span class="token comment">// -&gt; mActivityThread.post(args.getRunnable()) -&gt; finish(BroadcastReceiver.java)</span>
        <span class="token comment">// 静态注册完成广播 scheduleReceiver(ActivityThread) -&gt; RECEIVER</span>
        <span class="token comment">// -&gt; handleReceiver(ActivityThread.java) -&gt; finish(BroadcastReceiver.java)</span>
        <span class="token comment">// =&gt; finish/sendFinished(BroadcastReceiver.java) -&gt; am.finishReceiver</span>
        <span class="token comment">// 5. ams收到curApp将广播处理完成，则调用r.queue.processNextBroadcastLocked继续处理下一个广播</span>
        <span class="token comment">// finishReceiver(AMS) -&gt; r.queue.processNextBroadcastLocked(BroadcastQueue)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_LIGHT<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                    <span class="token string">"processNextBroadcast ["</span> <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"]: waiting for "</span>
                            <span class="token operator">+</span> mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> isDead<span class="token punctuation">;</span>
            <span class="token comment">//是否存在这个进程的pid</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//如果存在pid，则从mPidsSelfLocked中获取这个进程的ProcessRecord proc</span>
                    ProcessRecord proc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                            mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//如果proc存在，而且没有发生crash，则isDead = false</span>
                    isDead <span class="token operator">=</span> proc <span class="token operator">==</span> null <span class="token operator">||</span> proc<span class="token punctuation">.</span>mErrorState<span class="token punctuation">.</span><span class="token function">isCrashing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//否则从mProcessList通过名字获取该进程的ProcessRecord proc</span>
                <span class="token keyword">final</span> ProcessRecord proc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProcessList<span class="token punctuation">.</span><span class="token function">getProcessNamesLOSP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                        mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果proc存在，而且该进程正在启动中isPendingStart，则isDead = false</span>
                isDead <span class="token operator">=</span> proc <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>proc<span class="token punctuation">.</span><span class="token function">isPendingStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// It's still alive, so keep waiting</span>
                <span class="token comment">//如果mPendingBroadcast还存在，则直接返回，等待其先处理</span>
                <span class="token comment">//注意，这里等待mPendingBroadcast处理了才会有下一个广播的处理，不然一直再此等待</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果app死掉了</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"pending app  ["</span>
                        <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"]"</span> <span class="token operator">+</span> mPendingBroadcast<span class="token punctuation">.</span>curApp
                        <span class="token operator">+</span> <span class="token string">" died before responding to broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mPendingBroadcast<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token comment">//下一次处理这个BroadcastRecord的nextReceiver还是这个recIdx</span>
                mPendingBroadcast<span class="token punctuation">.</span>nextReceiver <span class="token operator">=</span> mPendingBroadcastRecvIndex<span class="token punctuation">;</span>
                <span class="token comment">//app死掉了清除mPendingBroadcast = null, 跳过这个mPendingBroadcast</span>
                mPendingBroadcast <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="443__2382"></a>4.4.3 取出下一个有序队列中的广播</h4> 
<ol><li> <p>主要是通过mDispatcher的getNextBroadcastLocked来取出有序广播队列的广播(这里就只讲解其中的mOrderedBroadcasts，如我们上面有序广播放入的地方)</p> </li><li> <p>总的分发时间大于2<em>10s/60s</em>numReceivers的时间，则发出总得广播超时，并且将这个广播给finish掉</p> </li><li> <p>如果已经完成了广播发送，而且发送时有设置IIntentReceiver resultTo(结果返回的地方)，则调用performReceiveLocked，返回结果给到resultTo</p> </li><li> <p>如果已经完成了广播发送，则取消该order的超时设定，输出“Finished with ordered broadcast”类似日志</p> </li></ol> 
<pre><code class="prism language-java">        <span class="token keyword">boolean</span> looped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//取得mAlarmBroadcasts(alarm挂起的广播)、mDeferredBroadcasts(如果存在order的广播在处理，这类延迟广播会按照deferUntil进行延迟)、</span>
            <span class="token comment">// mOrderedBroadcasts 有序广播队列，依次取出来</span>
            r <span class="token operator">=</span> mDispatcher<span class="token punctuation">.</span><span class="token function">getNextBroadcastLocked</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// No more broadcasts are deliverable right now, so all done!</span>
                <span class="token comment">//如果存在延迟的广播mDeferredBroadcasts，则重新下一次调度scheduleBroadcastsLocked</span>
                <span class="token comment">//不过一般上面BroadcastRecord r都取得出来(存在延迟的广播mDeferredBroadcasts, getNextBroadcastLocked得出来)，</span>
                <span class="token comment">// 也就是这里相当于没啥作用</span>
                mDispatcher<span class="token punctuation">.</span><span class="token function">scheduleDeferralCheckLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mAppProfiler<span class="token punctuation">.</span>mProfilerLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//将AMS所有挂起的gc进程mProcessesToGc进行按顺序的gc</span>
                    mService<span class="token punctuation">.</span>mAppProfiler<span class="token punctuation">.</span><span class="token function">scheduleAppGcsLPf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>looped <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skipOomAdj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If we had finished the last ordered broadcast, then</span>
                    <span class="token comment">// make sure all processes have correct oom and sched</span>
                    <span class="token comment">// adjustments.</span>
                    <span class="token comment">//adj调整，原因是启动了receiver</span>
                    mService<span class="token punctuation">.</span><span class="token function">updateOomAdjPendingTargetsLocked</span><span class="token punctuation">(</span>
                            OomAdjuster<span class="token punctuation">.</span>OOM_ADJ_REASON_START_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// when we have no more ordered broadcast on this queue, stop logging</span>
                <span class="token comment">//现在已经没有mOrderedBroadcasts 有序广播队列, 则停止log的输出mLogLatencyMetrics = false</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mUserController<span class="token punctuation">.</span>mBootCompleted <span class="token operator">&amp;&amp;</span> mLogLatencyMetrics<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mLogLatencyMetrics <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//结束本次processNextBroadcastLocked</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//是否需要强制结束recevie</span>
            <span class="token keyword">boolean</span> forceReceive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token comment">// Ensure that even if something goes awry with the timeout</span>
            <span class="token comment">// detection, we catch "hung" broadcasts here, discard them,</span>
            <span class="token comment">// and continue to make progress.</span>
            <span class="token comment">//</span>
            <span class="token comment">// This is only done if the system is ready so that early-stage receivers</span>
            <span class="token comment">// don't get executed with timeouts; and of course other timeout-</span>
            <span class="token comment">// exempt broadcasts are ignored.</span>
            <span class="token comment">//numReceivers接收者的个数</span>
            <span class="token keyword">int</span> numReceivers <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">//systemReady之后mService.mProcessesReady = true</span>
            <span class="token comment">//timeoutExempt只有ACTION_PRE_BOOT_COMPLETED才会设置为true</span>
            <span class="token comment">//r.dispatchTime是开始分发该BroadcastRecord r的时间</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessesReady <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>timeoutExempt <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果当前时间now &gt; r.dispatchTime + (2 * mConstants.TIMEOUT(10s/60s) * numReceivers)</span>
                <span class="token comment">//也就是总的分发时间大于2*10s/60s*numReceivers的时间,则告知这个广播出现anr</span>
                <span class="token comment">//isAnrDeferrable是mtk加入的是否需要跳过anr的逻辑</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numReceivers <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>now <span class="token operator">&gt;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> mConstants<span class="token punctuation">.</span>TIMEOUT <span class="token operator">*</span> numReceivers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token comment">/// M: ANR Debug Mechanism</span>
                        <span class="token operator">!</span>mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">isAnrDeferrable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Hung broadcast ["</span>
                            <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] discarded after timeout failure:"</span>
                            <span class="token operator">+</span> <span class="token string">" now="</span> <span class="token operator">+</span> now
                            <span class="token operator">+</span> <span class="token string">" dispatchTime="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>dispatchTime
                            <span class="token operator">+</span> <span class="token string">" startTime="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>receiverTime
                            <span class="token operator">+</span> <span class="token string">" intent="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent
                            <span class="token operator">+</span> <span class="token string">" numReceivers="</span> <span class="token operator">+</span> numReceivers
                            <span class="token operator">+</span> <span class="token string">" nextReceiver="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>nextReceiver
                            <span class="token operator">+</span> <span class="token string">" state="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// forcibly finish this broadcast</span>
                    <span class="token comment">//设置强制结束recevie (forceReceive = true)</span>
                    forceReceive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                        <span class="token string">"processNextBroadcast("</span>
                                <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">") called when not idle (state="</span>
                                <span class="token operator">+</span> r<span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Is the current broadcast is done for any reason?</span>
            <span class="token comment">// 如果没有r.receivers 或者 r.nextReceiver已经遍历完成最后一个了</span>
            <span class="token comment">// 或者强制结束forceReceive，</span>
            <span class="token comment">// 或者resultAbort为true(bortBroadcast(应用进程) -&gt; finishReceiver(AMS)-&gt; r.queue.finishReceiverLocked(BroadcastQueue))</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">==</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>nextReceiver <span class="token operator">&gt;=</span> numReceivers
                    <span class="token operator">||</span> r<span class="token punctuation">.</span>resultAbort <span class="token operator">||</span> forceReceive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Send the final result if requested</span>
                <span class="token comment">//是否有resultTo，如果有将结果回传resultTo</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">boolean</span> sendResult <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                    <span class="token comment">// if this was part of a split/deferral complex, update the refcount and only</span>
                    <span class="token comment">// send the completion when we clear all of them</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>splitToken <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">int</span> newCount <span class="token operator">=</span> mSplitRefcounts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>splitToken<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>newCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// done!  clear out this record's bookkeeping and deliver</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                                        <span class="token string">"Sending broadcast completion for split token "</span>
                                                <span class="token operator">+</span> r<span class="token punctuation">.</span>splitToken <span class="token operator">+</span> <span class="token string">" : "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            mSplitRefcounts<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>splitToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// still have some split broadcast records in flight; update refcount</span>
                            <span class="token comment">// and hold off on the callback</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                                        <span class="token string">"Result refcount now "</span> <span class="token operator">+</span> newCount <span class="token operator">+</span> <span class="token string">" for split token "</span>
                                                <span class="token operator">+</span> r<span class="token punctuation">.</span>splitToken <span class="token operator">+</span> <span class="token string">" : "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                <span class="token operator">+</span> <span class="token string">" - not sending completion yet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            sendResult <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            mSplitRefcounts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>splitToken<span class="token punctuation">,</span> newCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>callerApp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            mService<span class="token punctuation">.</span>mOomAdjuster<span class="token punctuation">.</span>mCachedAppOptimizer<span class="token punctuation">.</span><span class="token function">unfreezeTemporarily</span><span class="token punctuation">(</span>
                                    r<span class="token punctuation">.</span>callerApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Finishing broadcast ["</span> <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] "</span>
                                        <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" app="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>callerApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//将结果返回给app</span>
                            <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callerApp<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                                    <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span>
                                    r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// Set this to null so that the reference</span>
                            <span class="token comment">// (local and remote) isn't kept in the mBroadcastHistory.</span>
                            r<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            r<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> null<span class="token punctuation">;</span>
                            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failure ["</span>
                                    <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] sending broadcast result of "</span>
                                    <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Cancelling BROADCAST_TIMEOUT_MSG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//取消广播超时</span>
                <span class="token function">cancelBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_LIGHT<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                        <span class="token string">"Finished with ordered broadcast "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ... and on to the next...</span>
                <span class="token comment">//添加到广播历史中去，代表完成了</span>
                <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// This was an implicit broadcast... let's record it for posterity.</span>
                    mService<span class="token punctuation">.</span><span class="token function">addBroadcastStatLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>callerPackage<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>manifestCount<span class="token punctuation">,</span> r<span class="token punctuation">.</span>manifestSkipCount<span class="token punctuation">,</span> r<span class="token punctuation">.</span>finishTime<span class="token operator">-</span>r<span class="token punctuation">.</span>dispatchTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//完成odered的广播后，在retireBroadcastLocked中设置mCurrentBroadcast = null(一般在r == mCurrentBroadcast时)</span>
                mDispatcher<span class="token punctuation">.</span><span class="token function">retireBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//r == null继续while循环，取出下一个广播</span>
                r <span class="token operator">=</span> null<span class="token punctuation">;</span>
                looped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Check whether the next receiver is under deferral policy, and handle that</span>
            <span class="token comment">// accordingly.  If the current broadcast was already part of deferred-delivery</span>
            <span class="token comment">// tracking, we know that it must now be deliverable as-is without re-deferral.</span>
            <span class="token comment">// addDeferredBroadcast的时候会将deferred设置成ture，</span>
            <span class="token comment">// 如果这个广播没有进行延迟，则判断一下是否需要延迟</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>deferred<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//获取下一个nextReceiver的uid</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> receiverUid <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getReceiverUid</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextReceiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mDispatcher<span class="token punctuation">.</span><span class="token function">isDeferringLocked</span><span class="token punctuation">(</span>receiverUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Next receiver in "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" uid "</span> <span class="token operator">+</span> receiverUid
                                <span class="token operator">+</span> <span class="token string">" at "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>nextReceiver <span class="token operator">+</span> <span class="token string">" is under deferral"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// If this is the only (remaining) receiver in the broadcast, "splitting"</span>
                    <span class="token comment">// doesn't make sense -- just defer it as-is and retire it as the</span>
                    <span class="token comment">// currently active outgoing broadcast.</span>
                    BroadcastRecord defer<span class="token punctuation">;</span>
                    <span class="token comment">// 下一个Receiver将延迟，再下一个Receiver已经没有了</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextReceiver <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> numReceivers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Sole receiver of "</span> <span class="token operator">+</span> r
                                    <span class="token operator">+</span> <span class="token string">" is under deferral; setting aside and proceeding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        defer <span class="token operator">=</span> r<span class="token punctuation">;</span>
                        <span class="token comment">// 下一个Receiver将延迟，再下一个Receiver已经没有了，</span>
                        <span class="token comment">// 则在retireBroadcastLocked中设置mCurrentBroadcast = null(一般在r == mCurrentBroadcast时)</span>
                        mDispatcher<span class="token punctuation">.</span><span class="token function">retireBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Nontrivial case; split out 'uid's receivers to a new broadcast record</span>
                        <span class="token comment">// and defer that, then loop and pick up continuing delivery of the current</span>
                        <span class="token comment">// record (now absent those receivers).</span>

                        <span class="token comment">// The split operation is guaranteed to match at least at 'nextReceiver'</span>
                        defer <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">splitRecipientsLocked</span><span class="token punctuation">(</span>receiverUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>nextReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Post split:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Original broadcast receivers:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"  "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Split receivers:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> defer<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"  "</span> <span class="token operator">+</span> defer<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// Track completion refcount as well if relevant</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">int</span> token <span class="token operator">=</span> r<span class="token punctuation">.</span>splitToken<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// first split of this record; refcount for 'r' and 'deferred'</span>
                                r<span class="token punctuation">.</span>splitToken <span class="token operator">=</span> defer<span class="token punctuation">.</span>splitToken <span class="token operator">=</span> <span class="token function">nextSplitTokenLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                mSplitRefcounts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>splitToken<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                                            <span class="token string">"Broadcast needs split refcount; using new token "</span>
                                                    <span class="token operator">+</span> r<span class="token punctuation">.</span>splitToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// new split from an already-refcounted situation; increment count</span>
                                <span class="token keyword">final</span> <span class="token keyword">int</span> curCount <span class="token operator">=</span> mSplitRefcounts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                                                <span class="token string">"Split refcount is zero with token for "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                                mSplitRefcounts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> curCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"New split count for token "</span> <span class="token operator">+</span> token
                                            <span class="token operator">+</span> <span class="token string">" is "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>curCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//将defer添加到延迟广播中，按照uid放入</span>
                    mDispatcher<span class="token punctuation">.</span><span class="token function">addDeferredBroadcast</span><span class="token punctuation">(</span>receiverUid<span class="token punctuation">,</span> defer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//r == null会继续while循环</span>
                    r <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    looped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//BroadcastDispatcher.java</span>
    <span class="token comment">//获取下一个处理的广播BroadcastRecord next，上面mDispatcher.getNextBroadcastLocked调用</span>
	<span class="token comment">//这里除了mOrderedBroadcasts有序广播队列，还多了mAlarmBroadcasts(alarm设置的)、mDeferredBroadcasts(延迟广播)的概念</span>
    <span class="token keyword">public</span> BroadcastRecord <span class="token function">getNextBroadcastLocked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//如果当前mCurrentBroadcast还在处理，则直接返回mCurrentBroadcast</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentBroadcast <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mCurrentBroadcast<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//是否有oder的广播，如果有，则someQueued = true</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> someQueued <span class="token operator">=</span> <span class="token operator">!</span>mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        BroadcastRecord next <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment">//mAlarmBroadcasts不为空的时候</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAlarmBroadcasts<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 首先取出的就是mAlarmBroadcasts中的Deferrals d</span>
            <span class="token comment">// 然后取出BroadcastRecord next = d.broadcasts.remove(0)</span>
            next <span class="token operator">=</span> <span class="token function">popLocked</span><span class="token punctuation">(</span>mAlarmBroadcasts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL <span class="token operator">&amp;&amp;</span> next <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Next broadcast from alarm targets: "</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//如果next为null，而且mDeferredBroadcasts还有内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mDeferredBroadcasts<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// We're going to deliver either:</span>
            <span class="token comment">// 1. the next "overdue" deferral; or</span>
            <span class="token comment">// 2. the next ordinary ordered broadcast; *or*</span>
            <span class="token comment">// 3. the next not-yet-overdue deferral.</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mDeferredBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Deferrals d <span class="token operator">=</span> mDeferredBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//查看一下当前now是否小于d.deferUntil(延迟分发时间,默认是延迟5s)</span>
                <span class="token comment">//而且someQueued为true，就是有order的时候才break？(跳过这个延迟广播)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> d<span class="token punctuation">.</span>deferUntil <span class="token operator">&amp;&amp;</span> someQueued<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// stop looking when we haven't hit the next time-out boundary</span>
                    <span class="token comment">// but only if we have un-deferred broadcasts waiting,</span>
                    <span class="token comment">// otherwise we can deliver whatever deferred broadcast</span>
                    <span class="token comment">// is next available.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>broadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//取出next</span>
                    next <span class="token operator">=</span> d<span class="token punctuation">.</span>broadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// apply deferral-interval decay policy and move this uid's</span>
                    <span class="token comment">// deferred broadcasts down in the delivery queue accordingly</span>
                    <span class="token comment">//将这个Deferrals d从mDeferredBroadcasts移除，代表已经处理了</span>
                    mDeferredBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// already 'd'</span>

                    <span class="token comment">//deferredBy*0.75在赋值给deferredBy(第一次deferredBy是5s)</span>
                    d<span class="token punctuation">.</span>deferredBy <span class="token operator">=</span> <span class="token function">calculateDeferral</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>deferredBy<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//延迟时间deferUntil + deferredBy*0.75，再给新的Deferrals d</span>
                    d<span class="token punctuation">.</span>deferUntil <span class="token operator">+=</span> d<span class="token punctuation">.</span>deferredBy<span class="token punctuation">;</span>
                    <span class="token comment">//重新根据deferUntil排序放入mDeferredBroadcasts</span>

                    <span class="token comment">//貌似d.broadcasts如果此时为null，不需要再次将d加入mDeferredBroadcasts了吧？</span>
                    <span class="token function">insertLocked</span><span class="token punctuation">(</span>mDeferredBroadcasts<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Next broadcast from deferrals "</span> <span class="token operator">+</span> next
                                <span class="token operator">+</span> <span class="token string">", deferUntil now "</span> <span class="token operator">+</span> d<span class="token punctuation">.</span>deferUntil<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//如果next还是null，而且someQueued=true(有oder的广播)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> someQueued<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//则取出order的广播</span>
            next <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Next broadcast from main queue: "</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//当前正在处理的广播</span>
        mCurrentBroadcast <span class="token operator">=</span> next<span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="444_nextReceiver_2739"></a>4.4.4 处理下一个接收者nextReceiver</h4> 
<ol><li>第一个接收者会设置r.dispatchTime广播分发时间(SystemClock.uptimeMillis当前时间，不受系统时间修改影响)、<br> r.dispatchClockTime分发的系统时间(System.currentTimeMillis，该时间会随系统时间变化而变化)</li><li>设置超时时间setBroadcastTimeoutLocked(前台是10s超时，后台是60s超时，针对是单个注册者的时间)，<br> 每个有序的接受者，都是从取出开始算时间r.receiverTime = SystemClock.uptimeMillis();</li><li>开始处理时输出如："Processing ordered broadcast"类似的日志</li></ol> 
<pre><code class="prism language-java">        <span class="token comment">// Get the next receiver...</span>
        <span class="token comment">// 正常取出一个广播r != null</span>
        <span class="token comment">//先将nextReceiver赋值给recIdx，然后nextReceiver++，下一次进来nextReceiver就不会时当前这个了</span>
        <span class="token keyword">int</span> recIdx <span class="token operator">=</span> r<span class="token punctuation">.</span>nextReceiver<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">// Keep track of when this receiver started, and make sure there</span>
        <span class="token comment">// is a timeout message pending to kill it if need be.</span>
        <span class="token comment">//设置receiver接受时间receiverTime</span>
        r<span class="token punctuation">.</span>receiverTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>recIdx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果recIdx是第一个，这将receiverTime设置给dispatchTime(这个广播的分发时间)</span>
            r<span class="token punctuation">.</span>dispatchTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime<span class="token punctuation">;</span>
            <span class="token comment">//设置分发的系统时间(修改系统时间这个时间会变化)</span>
            r<span class="token punctuation">.</span>dispatchClockTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogLatencyMetrics<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//输出日志到FrameworkStatsLog中</span>
                FrameworkStatsLog<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
                        FrameworkStatsLog<span class="token punctuation">.</span>BROADCAST_DISPATCH_LATENCY_REPORTED<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>dispatchClockTime <span class="token operator">-</span> r<span class="token punctuation">.</span>enqueueClockTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//trace相关</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Trace<span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Trace<span class="token punctuation">.</span><span class="token function">asyncTraceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span>
                        <span class="token function">createBroadcastTraceTitle</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_PENDING<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Trace<span class="token punctuation">.</span><span class="token function">asyncTraceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span>
                        <span class="token function">createBroadcastTraceTitle</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_DELIVERED<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//输出开始发送order的广播</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_LIGHT<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Processing ordered broadcast ["</span>
                    <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//如果还没有设置超时时间，此处设置超时时间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//单个广播超时时间是10s(前台)或者60s(后台广播)</span>
            <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mConstants<span class="token punctuation">.</span>TIMEOUT<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                    <span class="token string">"Submitting BROADCAST_TIMEOUT_MSG ["</span>
                            <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] for "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" at "</span> <span class="token operator">+</span> timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="445_order_2796"></a>4.4.5 发送给动态注册的order注册者</h4> 
<ol><li>使用的方法是deliverToRegisteredReceiverLocked，和平行广播类似，都是处理动态注册的接受者，<br> 只是这里是按顺序，一个个处理</li><li>输出日志如：“Delivering ordered [foreground/background] to registered ***”</li></ol> 
<pre><code class="prism language-java">        <span class="token keyword">final</span> BroadcastOptions brOptions <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">;</span>

        <span class="token comment">//获取下一个接受者</span>
        <span class="token keyword">final</span> Object nextReceiver <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//如果这个nextReceiver为BroadcastFilter类型(动态注册广播接收者)</span>
        <span class="token comment">// BroadcastRecord的receivers还有另一种类型ResolveInfo，是从PMS中查询得到的静态注册广播类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextReceiver <span class="token keyword">instanceof</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Simple case: this is a registered receiver who gets</span>
            <span class="token comment">// a direct call.</span>
            BroadcastFilter filter <span class="token operator">=</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span>  Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                    <span class="token string">"Delivering ordered ["</span>
                            <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] to registered "</span>
                            <span class="token operator">+</span> filter <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//发送给动态注册的广播</span>
            <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果r.receiver == null(没有正在执行的广播)</span>
            <span class="token comment">//而且该广播是非order的</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receiver <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// The receiver has already finished, so schedule to</span>
                <span class="token comment">// process the next one.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Quick finishing ["</span>
                        <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"]: ordered="</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>ordered <span class="token operator">+</span> <span class="token string">" receiver="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token comment">//已经发出去执行了，无需等待，直接处理下一个</span>
                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">maybeAddAllowBackgroundActivityStartsToken</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// r is guaranteed ordered at this point, so we know finishReceiverLocked()</span>
                    <span class="token comment">// will get a callback and handle the activity start token lifecycle.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//直接返回，代表本次完成，一次处理一个广播中的nextReceiver</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

</code></pre> 
<h4><a id="446__2845"></a>4.4.6 静态注册者跳过的逻辑</h4> 
<p>跳过的逻辑较多，<br> 这里注意一下“Background execution not allowed”，如果flag设置了FLAG_RECEIVER_EXCLUDE_BACKGROUND则无法让后台接收，<br> 或者getComponent/getPackage都为null，而且没有设置FLAG_RECEIVER_INCLUDE_BACKGROUND，而且没有requiredPermissions，<br> 则无法发送给后台的进程(进程状态procState&gt;=PROCESS_STATE_TRANSIENT_BACKGROUND(8)属于广播的后台进程)</p> 
<pre><code class="prism language-java">        <span class="token comment">// Hard case: need to instantiate the receiver, possibly</span>
        <span class="token comment">// starting its application process to host it.</span>

        <span class="token comment">//静态广播的处理</span>
        ResolveInfo info <span class="token operator">=</span>
                <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>
        ComponentName component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//注意这里是静态广播接收跳过的逻辑，动态注册跳过的逻辑是在deliverToRegisteredReceiverLocked中</span>
        <span class="token keyword">boolean</span> skip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否需要跳过</span>
		<span class="token comment">//sdk的一些判断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>brOptions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                        <span class="token operator">&lt;</span> brOptions<span class="token punctuation">.</span><span class="token function">getMinManifestReceiverApiLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                        info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                                <span class="token operator">&gt;</span> brOptions<span class="token punctuation">.</span><span class="token function">getMaxManifestReceiverApiLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Target SDK mismatch: receiver "</span> <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo
                    <span class="token operator">+</span> <span class="token string">" targets "</span> <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                    <span class="token operator">+</span> <span class="token string">" but delivery restricted to ["</span>
                    <span class="token operator">+</span> brOptions<span class="token punctuation">.</span><span class="token function">getMinManifestReceiverApiLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span>
                    <span class="token operator">+</span> brOptions<span class="token punctuation">.</span><span class="token function">getMaxManifestReceiverApiLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">"] broadcasting "</span> <span class="token operator">+</span> <span class="token function">broadcastDescription</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		
		<span class="token comment">//查看发送者的uid和接受者的uid是否一样，或者是否系统uid，确定一些是否两者有设定关联关系association</span>
		<span class="token comment">//默认返回是true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">validateAssociationAllowedLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callerPackage<span class="token punctuation">,</span> r<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span>
                component<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Association not allowed: broadcasting "</span>
                    <span class="token operator">+</span> <span class="token function">broadcastDescription</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//看一下意图防火墙mIntentFirewall是否有block该发送行为</span>
            skip <span class="token operator">=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mIntentFirewall<span class="token punctuation">.</span><span class="token function">checkBroadcast</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>callingPid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resolvedType<span class="token punctuation">,</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Firewall blocked: broadcasting "</span>
                        <span class="token operator">+</span> <span class="token function">broadcastDescription</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		
		<span class="token comment">//权限相关的的检查</span>
        <span class="token keyword">int</span> perm <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">checkComponentPermission</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>permission<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>callingPid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>exported<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> perm <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>exported<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permission Denial: broadcasting "</span>
                        <span class="token operator">+</span> <span class="token function">broadcastDescription</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> component<span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">" is not exported from uid "</span> <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permission Denial: broadcasting "</span>
                        <span class="token operator">+</span> <span class="token function">broadcastDescription</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> component<span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">" requires "</span> <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>permission<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>permission <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> opCode <span class="token operator">=</span> AppOpsManager<span class="token punctuation">.</span><span class="token function">permissionToOpCode</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>permission<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>opCode <span class="token operator">!=</span> AppOpsManager<span class="token punctuation">.</span>OP_NONE <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span><span class="token function">getAppOpsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noteOpNoThrow</span><span class="token punctuation">(</span>opCode<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>callerPackage<span class="token punctuation">,</span> r<span class="token punctuation">.</span>callerFeatureId<span class="token punctuation">,</span>
                    <span class="token string">"Broadcast delivered to "</span> <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                    <span class="token operator">!=</span> AppOpsManager<span class="token punctuation">.</span>MODE_ALLOWED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Appop Denial: broadcasting "</span>
                        <span class="token operator">+</span> <span class="token function">broadcastDescription</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> component<span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">" requires appop "</span> <span class="token operator">+</span> AppOpsManager<span class="token punctuation">.</span><span class="token function">permissionToOp</span><span class="token punctuation">(</span>
                        info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>permission<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> isSingleton <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            isSingleton <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_SINGLE_USER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span><span class="token function">checkUidPermission</span><span class="token punctuation">(</span>
                    android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>INTERACT_ACROSS_USERS<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span>
                    <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permission Denial: Receiver "</span> <span class="token operator">+</span> component<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">" requests FLAG_SINGLE_USER, but app does not hold "</span>
                        <span class="token operator">+</span> android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>INTERACT_ACROSS_USERS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isInstantApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>callingUid <span class="token operator">!=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Instant App Denial: receiving "</span>
                    <span class="token operator">+</span> r<span class="token punctuation">.</span>intent
                    <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> component<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">" due to sender "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>callerPackage
                    <span class="token operator">+</span> <span class="token string">" (uid "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>callingUid <span class="token operator">+</span> <span class="token string">")"</span>
                    <span class="token operator">+</span> <span class="token string">" Instant Apps do not support manifest receivers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>callerInstantApp
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ActivityInfo<span class="token punctuation">.</span>FLAG_VISIBLE_TO_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>callingUid <span class="token operator">!=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Instant App Denial: receiving "</span>
                    <span class="token operator">+</span> r<span class="token punctuation">.</span>intent
                    <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> component<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">" requires receiver have visibleToInstantApps set"</span>
                    <span class="token operator">+</span> <span class="token string">" due to sender "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>callerPackage
                    <span class="token operator">+</span> <span class="token string">" (uid "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>callingUid <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		
		<span class="token comment">//crash的app则直接跳过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>mErrorState<span class="token punctuation">.</span><span class="token function">isCrashing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If the target process is crashing, just skip it.</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Skipping deliver ordered ["</span> <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] "</span> <span class="token operator">+</span> r
                    <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>curApp <span class="token operator">+</span> <span class="token string">": process crashing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> isAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                isAvailable <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPackageAvailable</span><span class="token punctuation">(</span>
                        info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                        UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// all such failures mean we skip this receiver</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception getting recipient info for "</span>
                        <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">//确定是否可用</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAvailable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                        <span class="token string">"Skipping delivery to "</span> <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">" / "</span>
                                <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
                                <span class="token operator">+</span> <span class="token string">" : package no longer available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If permissions need a review before any of the app components can run, we drop</span>
        <span class="token comment">// the broadcast and if the calling app is in the foreground and the broadcast is</span>
        <span class="token comment">// explicit we launch the review UI passing it a pending intent to send the skipped</span>
        <span class="token comment">// broadcast.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//判断是否需要权限来启动，如果需要则跳过(如果调用者是前台，而且发送到特定组件，则启动权限申请的ui界面)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">requestStartTargetPermissionsReviewIfNeededLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>
                            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                        <span class="token string">"Skipping delivery: permission review required for "</span>
                                <span class="token operator">+</span> <span class="token function">broadcastDescription</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// This is safe to do even if we are skipping the broadcast, and we need</span>
        <span class="token comment">// this information now to evaluate whether it is going to be allowed to run.</span>
        <span class="token comment">//接收者的uid</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> receiverUid <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
        <span class="token comment">// If it's a singleton, it needs to be the same app or a special app</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>callingUid <span class="token operator">!=</span> Process<span class="token punctuation">.</span>SYSTEM_UID <span class="token operator">&amp;&amp;</span> isSingleton
                <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span><span class="token function">isValidSingletonCall</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span> receiverUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            info<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getActivityInfoForUser</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//接受者的进程名字</span>
        String targetProcess <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>

        <span class="token comment">//接受者的进程ProcessRecord app，这个可能为null，也就是进程未启动</span>
        ProcessRecord app <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> allowed <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getAppStartModeLOSP</span><span class="token punctuation">(</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
//进程状态，只有小于8才会被认为可以接收广播(不带getComponent、getPackage)
    public static final boolean isProcStateBackground(int procState) {
        return procState &gt;= PROCESS_STATE_TRANSIENT_BACKGROUND;
    }
    //PROCESS_STATE_TRANSIENT_BACKGROUND后台临时的一个状态（一般的含义，如toasts）
    //1.如果设置了getForcingToImportant不为null（调用AMS的setProcessImportant设置），会设置该状态，
    //而且adj是用户可感知的PERCEPTIBLE_APP_ADJ，例如toasts是这种情况(NotificationManagerService中调用setProcessImportant)
    //2.AMS的mBackupTargets是该app，且其adj大于BACKUP_APP_ADJ，会设置该值
    //3.service服务依赖：如果设置了BIND_NOT_FOREGROUND(非前台绑定)而且没有设置BIND_IMPORTANT_BACKGROUND(绑定重要后台)的时候，
    //且客户端状态优先级小于该值时，会设置该值
    TRANSIENT_BACKGROUND = 8,
*/</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>allowed <span class="token operator">!=</span> ActivityManager<span class="token punctuation">.</span>APP_START_MODE_NORMAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// We won't allow this receiver to be launched if the app has been</span>
                <span class="token comment">// completely disabled from launches, or it was not explicitly sent</span>
                <span class="token comment">// to it and the app is in a state that should not receive it</span>
                <span class="token comment">// (depending on how getAppStartModeLOSP has determined that).</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>allowed <span class="token operator">==</span> ActivityManager<span class="token punctuation">.</span>APP_START_MODE_DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Background execution disabled: receiving "</span>
                            <span class="token operator">+</span> r<span class="token punctuation">.</span>intent <span class="token operator">+</span> <span class="token string">" to "</span>
                            <span class="token operator">+</span> component<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment">//如果flag设置了FLAG_RECEIVER_EXCLUDE_BACKGROUND则无法让后台接收</span>
                    <span class="token comment">//或者getComponent/getPackage都为null，而且没有设置FLAG_RECEIVER_INCLUDE_BACKGROUND，而且没有requiredPermissions</span>
                    <span class="token comment">//如ACTION_BOOT_COMPLETED是有设置FLAG_RECEIVER_INCLUDE_BACKGROUND，所以静态广播无需权限就可以直接接收</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_EXCLUDE_BACKGROUND<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token operator">||</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                        <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_INCLUDE_BACKGROUND<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSignaturePerm</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>requiredPermissions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mService<span class="token punctuation">.</span><span class="token function">addBackgroundCheckViolationLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            component<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Background execution not allowed: receiving "</span>
                            <span class="token operator">+</span> r<span class="token punctuation">.</span>intent <span class="token operator">+</span> <span class="token string">" to "</span>
                            <span class="token operator">+</span> component<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Intent<span class="token punctuation">.</span>ACTION_SHUTDOWN<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mUserController
                <span class="token punctuation">.</span><span class="token function">isUserRunning</span><span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token number">0</span> <span class="token comment">/* flags */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
                    <span class="token string">"Skipping delivery to "</span> <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">" / "</span>
                            <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">+</span> <span class="token string">" : user is not running"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//处理不包含的权限excludedPermissions</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>excludedPermissions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>excludedPermissions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>excludedPermissions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String excludedPermission <span class="token operator">=</span> r<span class="token punctuation">.</span>excludedPermissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    perm <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span>excludedPermission<span class="token punctuation">,</span>
                                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                    UserHandle
                                            <span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    perm <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_DENIED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">int</span> appOp <span class="token operator">=</span> AppOpsManager<span class="token punctuation">.</span><span class="token function">permissionToOpCode</span><span class="token punctuation">(</span>excludedPermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>appOp <span class="token operator">!=</span> AppOpsManager<span class="token punctuation">.</span>OP_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// When there is an app op associated with the permission,</span>
                    <span class="token comment">// skip when both the permission and the app op are</span>
                    <span class="token comment">// granted.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>perm <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
                            mService<span class="token punctuation">.</span><span class="token function">getAppOpsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkOpNoThrow</span><span class="token punctuation">(</span>appOp<span class="token punctuation">,</span>
                                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
                                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span>
                                    <span class="token operator">==</span> AppOpsManager<span class="token punctuation">.</span>MODE_ALLOWED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// When there is no app op associated with the permission,</span>
                    <span class="token comment">// skip when permission is granted.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>perm <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//处理需要包含的权限requiredPermission</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> Process<span class="token punctuation">.</span>SYSTEM_UID <span class="token operator">&amp;&amp;</span>
                r<span class="token punctuation">.</span>requiredPermissions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>requiredPermissions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>requiredPermissions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String requiredPermission <span class="token operator">=</span> r<span class="token punctuation">.</span>requiredPermissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    perm <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                            <span class="token function">checkPermission</span><span class="token punctuation">(</span>requiredPermission<span class="token punctuation">,</span>
                                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                    UserHandle
                                            <span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    perm <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_DENIED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>perm <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permission Denial: receiving "</span>
                            <span class="token operator">+</span> r<span class="token punctuation">.</span>intent <span class="token operator">+</span> <span class="token string">" to "</span>
                            <span class="token operator">+</span> component<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" requires "</span> <span class="token operator">+</span> requiredPermission
                            <span class="token operator">+</span> <span class="token string">" due to sender "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>callerPackage
                            <span class="token operator">+</span> <span class="token string">" (uid "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>callingUid <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> appOp <span class="token operator">=</span> AppOpsManager<span class="token punctuation">.</span><span class="token function">permissionToOpCode</span><span class="token punctuation">(</span>requiredPermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>appOp <span class="token operator">!=</span> AppOpsManager<span class="token punctuation">.</span>OP_NONE <span class="token operator">&amp;&amp;</span> appOp <span class="token operator">!=</span> r<span class="token punctuation">.</span>appOp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">noteOpForManifestReceiver</span><span class="token punctuation">(</span>appOp<span class="token punctuation">,</span> r<span class="token punctuation">,</span> info<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>appOp <span class="token operator">!=</span> AppOpsManager<span class="token punctuation">.</span>OP_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//AppOps相关判断</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">noteOpForManifestReceiver</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appOp<span class="token punctuation">,</span> r<span class="token punctuation">,</span> info<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//上面都是各类判断是否需要跳过的逻辑skip</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span>  Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                    <span class="token string">"Skipping delivery of ordered ["</span> <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] "</span>
                            <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" for reason described above"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果需要跳过，标定当前r.delivery[recIdx]为skipped</span>
            r<span class="token punctuation">.</span>delivery<span class="token punctuation">[</span>recIdx<span class="token punctuation">]</span> <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_SKIPPED<span class="token punctuation">;</span>
            <span class="token comment">//跳过的时候清空r.receiver = null</span>
            r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>curFilter <span class="token operator">=</span> null<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
            <span class="token comment">//静态广播跳过++</span>
            r<span class="token punctuation">.</span>manifestSkipCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">//继续下一个分发</span>
            <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="447__3186"></a>4.4.7 发送给已经启动了的静态注册者</h4> 
<ol><li>对于已经启动了的静态注册者，则直接调用processCurBroadcastLocked去发送给静态注册者</li><li>静态接收者都是在APP主线程中分发</li><li>APP线程handleReceiver会新建BroadcastReceiver实例，执行onReceive方法，然后调用AMS的finishReceiver方法</li></ol> 
<p>ps: 注意一下，此处广播记录的状态设置成app接收“r.state = BroadcastRecord.APP_RECEIVE”，<br> 设置当前接收的组件r.curComponent = component</p> 
<pre><code class="prism language-java">        <span class="token comment">//静态广播Count执行++</span>
        r<span class="token punctuation">.</span>manifestCount<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">//标定当前r.delivery[recIdx]为分发DELIVERED</span>
        r<span class="token punctuation">.</span>delivery<span class="token punctuation">[</span>recIdx<span class="token punctuation">]</span> <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_DELIVERED<span class="token punctuation">;</span>
        <span class="token comment">//状态修改成app接收APP_RECEIVE，后面该receive finishReceiver返回的时候APP_RECEIVE或BroadcastRecord.CALL_DONE_RECEIVE才会继续处理下一个</span>
        r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>APP_RECEIVE<span class="token punctuation">;</span>
        <span class="token comment">//当前接收组件curComponent</span>
        r<span class="token punctuation">.</span>curComponent <span class="token operator">=</span> component<span class="token punctuation">;</span>
        <span class="token comment">//当前的receiver</span>
        r<span class="token punctuation">.</span>curReceiver <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_MU <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>callingUid <span class="token operator">&gt;</span> UserHandle<span class="token punctuation">.</span>PER_USER_RANGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_MU<span class="token punctuation">,</span> <span class="token string">"Updated broadcast record activity info for secondary user, "</span>
                    <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo <span class="token operator">+</span> <span class="token string">", callingUid = "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>callingUid <span class="token operator">+</span> <span class="token string">", uid = "</span>
                    <span class="token operator">+</span> receiverUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isActivityCapable <span class="token operator">=</span>
                <span class="token punctuation">(</span>brOptions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> brOptions<span class="token punctuation">.</span><span class="token function">getTemporaryAppAllowlistDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">maybeScheduleTempAllowlistLocked</span><span class="token punctuation">(</span>receiverUid<span class="token punctuation">,</span> r<span class="token punctuation">,</span> brOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Report that a component is used for explicit broadcasts.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>curComponent <span class="token operator">!=</span> null
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curComponent<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>callerPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span>mUsageStatsService<span class="token punctuation">.</span><span class="token function">reportEvent</span><span class="token punctuation">(</span>
                    r<span class="token punctuation">.</span>curComponent<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> Event<span class="token punctuation">.</span>APP_COMPONENT_USED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Broadcast is being executed, its package can't be stopped.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//设置包的stop状态是false(需要启动改应用了，包不再是stop了)</span>
            AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPackageStoppedState</span><span class="token punctuation">(</span>
                    r<span class="token punctuation">.</span>curComponent<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed trying to unstop package "</span>
                    <span class="token operator">+</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Is this receiver's application already running?</span>
        <span class="token comment">//如果app之前已经启动</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span><span class="token function">isKilled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                        info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>longVersionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">maybeAddAllowBackgroundActivityStartsToken</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//则直接发送该广播到app中</span>
                <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception when sending broadcast to "</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed sending broadcast to "</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>curComponent <span class="token operator">+</span> <span class="token string">" with "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// If some unexpected exception happened, just skip</span>
                <span class="token comment">// this broadcast.  At this point we are not in the call</span>
                <span class="token comment">// from a client, so throwing an exception out from here</span>
                <span class="token comment">// will crash the entire system instead of just whoever</span>
                <span class="token comment">// sent the broadcast.</span>
                <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// We need to reset the state if we failed to start the receiver.</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If a dead object exception was thrown -- fall through to</span>
            <span class="token comment">// restart the application.</span>
        <span class="token punctuation">}</span>

<span class="token comment">//发送给静态注册者的函数processCurBroadcastLocked</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span>
                                                 ProcessRecord app<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span>  Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                <span class="token string">"Process cur broadcast "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" for app "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> IApplicationThread thread <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">isInFullBackup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">skipReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//processCurBroadcastLocked的时候，会有r.receiver的设置</span>
        r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> app<span class="token punctuation">;</span>
        <span class="token keyword">final</span> ProcessReceiverRecord prr <span class="token operator">=</span> app<span class="token punctuation">.</span>mReceivers<span class="token punctuation">;</span>
        prr<span class="token punctuation">.</span><span class="token function">addCurReceiver</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>mState<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span>PROCESS_STATE_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Make sure the oom adj score is updated before delivering the broadcast.</span>
        <span class="token comment">// Force an update, even if there are other pending requests, overall it still saves time,</span>
        <span class="token comment">// because time(updateOomAdj(N apps)) &lt;= N * time(updateOomAdj(1 app)).</span>
        mService<span class="token punctuation">.</span><span class="token function">enqueueOomAdjTargetLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span><span class="token function">updateOomAdjPendingTargetsLocked</span><span class="token punctuation">(</span>OomAdjuster<span class="token punctuation">.</span>OOM_ADJ_REASON_START_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Tell the application to launch this receiver.</span>
		<span class="token comment">//r.curComponent是发送给静态接收者的时候设置的组件名字</span>
        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_LIGHT<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                    <span class="token string">"Delivering to component "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>curComponent
                            <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_BROADCAST_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//发送给app主线程的scheduleReceiver</span>
            thread<span class="token punctuation">.</span><span class="token function">scheduleReceiver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">,</span>
                    mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackage</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>mState<span class="token punctuation">.</span><span class="token function">getReportedProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span>  Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                    <span class="token string">"Process cur broadcast "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" DELIVERED for app "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>started<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span>  Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                        <span class="token string">"Process cur broadcast "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">": NOT STARTED!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//没有启动成功，还原状态</span>
                r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> null<span class="token punctuation">;</span>
                prr<span class="token punctuation">.</span><span class="token function">removeCurReceiver</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token comment">//ActivityThread.java</span>
        <span class="token comment">//APP的接受者，在主线程中运行</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scheduleReceiver</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> ActivityInfo info<span class="token punctuation">,</span>
                CompatibilityInfo compatInfo<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String data<span class="token punctuation">,</span> Bundle extras<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> sync<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">updateProcessState</span><span class="token punctuation">(</span>processState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ReceiverData r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverData</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span>
                    sync<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mAppThread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
            <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>RECEIVER<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_MESSAGES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"&gt;&gt;&gt; handling: "</span> <span class="token operator">+</span> <span class="token function">codeToString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//...</span>
                <span class="token keyword">case</span> RECEIVER<span class="token operator">:</span>
                    Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span> <span class="token string">"broadcastReceiveComp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//处理广播接收者</span>
                    <span class="token function">handleReceiver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ReceiverData<span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token comment">//...</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleReceiver</span><span class="token punctuation">(</span>ReceiverData data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If we are getting ready to gc after going to the background, well</span>
        <span class="token comment">// we are back active so skip it.</span>
        <span class="token function">unscheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//获取相关组件</span>
        String component <span class="token operator">=</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        LoadedApk packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>
                data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Application app<span class="token punctuation">;</span>
        BroadcastReceiver receiver<span class="token punctuation">;</span>
        ContextImpl context<span class="token punctuation">;</span>
		<span class="token comment">//新建一个静态接收者的实例BroadcastReceiver</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            app <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context <span class="token operator">=</span> <span class="token punctuation">(</span>ContextImpl<span class="token punctuation">)</span> app<span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                context <span class="token operator">=</span> <span class="token punctuation">(</span>ContextImpl<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">createContextForSplit</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>attributionTags <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>attributionTags<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> String attributionTag <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>attributionTags<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                context <span class="token operator">=</span> <span class="token punctuation">(</span>ContextImpl<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">createAttributionContext</span><span class="token punctuation">(</span>attributionTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span>
                    <span class="token function">isProtectedComponent</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isProtectedBroadcast</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    context<span class="token punctuation">.</span><span class="token function">getAttributionSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//通过class loader，新建一个接收者的实例，(BroadcastReceiver) cl.loadClass(className).newInstance()</span>
			<span class="token comment">//如实例化MyReceiver</span>
            receiver <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getAppFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">instantiateReceiver</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
                    <span class="token string">"Finishing failed broadcast to "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"Unable to instantiate receiver "</span> <span class="token operator">+</span> component
                <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
                TAG<span class="token punctuation">,</span> <span class="token string">"Performing receive of "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>intent
                <span class="token operator">+</span> <span class="token string">": app="</span> <span class="token operator">+</span> app
                <span class="token operator">+</span> <span class="token string">", appName="</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">", pkg="</span> <span class="token operator">+</span> packageInfo<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">", comp="</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">", dir="</span> <span class="token operator">+</span> packageInfo<span class="token punctuation">.</span><span class="token function">getAppDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            sCurrentBroadcastIntent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//执行app定义的onReceive方法，如执行MyReceiver的onReceive方法</span>
            receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getReceiverRestrictedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
                    <span class="token string">"Finishing failed broadcast to "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Unable to start receiver "</span> <span class="token operator">+</span> component
                    <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            sCurrentBroadcastIntent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getPendingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//BroadcastReceiver.PendingResul(ReceiverData继承PendingResul)的finish</span>
			<span class="token comment">//具体过程和“4.4.1 mParallelBroadcasts平行广播的分发”是类似的</span>
            data<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<h4><a id="448__3435"></a>4.4.8 启动静态注册接收者的进程</h4> 
<ol><li>如果静态注册的接受者进程没有启动，则需要启动，并且挂起该广播mPendingBroadcast分发</li></ol> 
<pre><code class="prism language-java">        <span class="token comment">// Not running -- get it started, to be executed when the app comes up.</span>
        <span class="token comment">//否则第一步，我们需要先启动该进程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span>  Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span>
                <span class="token string">"Need to start app ["</span>
                        <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] "</span> <span class="token operator">+</span> targetProcess <span class="token operator">+</span> <span class="token string">" for broadcast "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动进程ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE(延迟敏感的)标签用于确定fork进程时是否需要使用usap</span>
        r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_FROM_BACKGROUND<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">(</span><span class="token string">"broadcast"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">)</span><span class="token punctuation">,</span> isActivityCapable
                        <span class="token operator">?</span> ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE <span class="token operator">:</span> ZYGOTE_POLICY_FLAG_EMPTY<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Ah, this recipient is unavailable.  Finish it if necessary,</span>
            <span class="token comment">// and mark the broadcast record as ready for the next.</span>
            <span class="token comment">//当无法启动app的时候，完成这个广播BroadcastRecord r的分发finishReceiverLocked</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unable to launch app "</span>
                    <span class="token operator">+</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">"/"</span>
                    <span class="token operator">+</span> receiverUid <span class="token operator">+</span> <span class="token string">" for broadcast "</span>
                    <span class="token operator">+</span> r<span class="token punctuation">.</span>intent <span class="token operator">+</span> <span class="token string">": process is bad"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">maybeAddAllowBackgroundActivityStartsToken</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Need to start app 需要先启动该进程会设置mPendingBroadcast = r;</span>
        <span class="token comment">//启动进程后会调用attachApplicationLocked(AMS)、bindApplication(IApplicationThread)</span>
        <span class="token comment">//attachApplicationLocked(AMS)-&gt; sendPendingBroadcastsLocked 会处理mPendingBroadcast</span>
        mPendingBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>
        <span class="token comment">//mPendingBroadcastRecvIndex是当前需要处理recevie的recIdx</span>
        mPendingBroadcastRecvIndex <span class="token operator">=</span> recIdx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>从APP进程启动到回传AMS</li></ol> 
<p>=&gt; mService.startProcessLocked启动进程后，<br> 会调用ActivityThread的main方法：创建main loop，调用thread.attach，Looper.loop开始消息队列的循环</p> 
<pre><code class="prism language-java"><span class="token comment">//ActivityThread.java</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span> <span class="token string">"ActivityThreadMain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Install selective syscall interception</span>
        AndroidOs<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// CloseGuard defaults to true and can be quite spammy.  We</span>
        <span class="token comment">// disable it here, but selectively enable it later (via</span>
        <span class="token comment">// StrictMode) on debug builds, but using DropBox, not logs.</span>
        CloseGuard<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Environment<span class="token punctuation">.</span><span class="token function">initForCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span>
        <span class="token keyword">final</span> File configDir <span class="token operator">=</span> Environment<span class="token punctuation">.</span><span class="token function">getUserConfigDirectory</span><span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TrustedCertificateStore<span class="token punctuation">.</span><span class="token function">setDefaultUserDirectory</span><span class="token punctuation">(</span>configDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Call per-process mainline module initialization.</span>
		<span class="token comment">//google main line的模块初始化</span>
        <span class="token function">initializeMainlineModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//设置该进程刚刚创建，名字是"&lt;pre-initialized&gt;"</span>
		<span class="token comment">//在handleBindApplication之后app才会设置成对应的进程名字processName</span>
        Process<span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span><span class="token string">"&lt;pre-initialized&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//准备主线程，此处H mH = new H();才能从Looper.myLooper()获取主线程的sMainLooper</span>
        Looper<span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Find the value for {@link #PROC_START_SEQ_IDENT} if provided on the command line.</span>
        <span class="token comment">// It will be in the format "seq=114"</span>
        <span class="token keyword">long</span> startSeq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>PROC_START_SEQ_IDENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    startSeq <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>
                            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>PROC_START_SEQ_IDENT<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		
		<span class="token comment">//这里是接下去的流程</span>
        ActivityThread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token keyword">new</span>
                    <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// End of event ActivityThreadMain.</span>
        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//开始loop的循环，此时ActivityThread主线程mH的消息队列才开始分发</span>
        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//附着方法attach</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sCurrentActivityThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        mConfigurationController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationController</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSystemThread <span class="token operator">=</span> system<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//app进程的逻辑</span>
            android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span>DdmHandleAppName<span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"&lt;pre-initialized&gt;"</span><span class="token punctuation">,</span>
                                                    UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            RuntimeInit<span class="token punctuation">.</span><span class="token function">setApplicationObject</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//调用的是AMS的attachApplication</span>
                mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Don't set application object here -- if the system crashes,</span>
            <span class="token comment">// we can't display an alert, we just want to die die die.</span>
			<span class="token comment">//系统进程的逻辑</span>
            android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span>DdmHandleAppName<span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"system_process"</span><span class="token punctuation">,</span>
                    UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ContextImpl context <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInitialApplication <span class="token operator">=</span> context<span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInitialApplication<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                        <span class="token string">"Unable to instantiate Application():"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>AMS开始处理挂起的广播</li></ol> 
<p>=&gt; AMS收到app的attachApplication，查看是否有挂起的广播isPendingBroadcastProcessLocked，<br> 如果有则让广播队列处理该app挂起的广播sendPendingBroadcastsLocked</p> 
<pre><code class="prism language-java"><span class="token comment">//ActivityManagerService.java</span>
    <span class="token comment">//从app调用的attachApplication(附着在应用)方法</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span>IApplicationThread thread<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token string">"Invalid application interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//attachApplicationLocked，加个Locked，这类方法代表需要上锁才能调用</span>
            <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> IApplicationThread thread<span class="token punctuation">,</span>
            <span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
		<span class="token comment">//绑定pid到ProcessRecord，用于死亡回调AppDeathRecipient</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
                TAG<span class="token punctuation">,</span> <span class="token string">"Binding process pid "</span> <span class="token operator">+</span> pid <span class="token operator">+</span> <span class="token string">" to record "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> String processName <span class="token operator">=</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            AppDeathRecipient adr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppDeathRecipient</span><span class="token punctuation">(</span>
                    app<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>adr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">setDeathRecipient</span><span class="token punctuation">(</span>adr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            app<span class="token punctuation">.</span><span class="token function">resetPackageList</span><span class="token punctuation">(</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProcessList<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">(</span><span class="token string">"link fail"</span><span class="token punctuation">,</span> processName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    ZYGOTE_POLICY_FLAG_EMPTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//这个就是event log中经常出现的"am_proc_bound"，代表进程创建后，app进程回调AMS绑定了该app进程</span>
        EventLogTags<span class="token punctuation">.</span><span class="token function">writeAmProcBound</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//进程信息记录ProcessRecord app的初始化</span>
        
            <span class="token comment">//...</span>
			<span class="token comment">//同时这里还会从system_server回传APP进程，去绑定应用bindApplication</span>
                thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> providerList<span class="token punctuation">,</span> null<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span>
                        null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> testMode<span class="token punctuation">,</span>
                        mBinderTransactionTrackingEnabled<span class="token punctuation">,</span> enableTrackAllocation<span class="token punctuation">,</span>
                        isRestrictedBackupMode <span class="token operator">||</span> <span class="token operator">!</span>normalMode<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        app<span class="token punctuation">.</span><span class="token function">getCompat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCommonServicesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mCoreSettingsObserver<span class="token punctuation">.</span><span class="token function">getCoreSettingsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        buildSerial<span class="token punctuation">,</span> autofillOptions<span class="token punctuation">,</span> contentCaptureOptions<span class="token punctuation">,</span>
                        app<span class="token punctuation">.</span><span class="token function">getDisabledCompatChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedSystemFontMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//...</span>

        <span class="token comment">// 调用ActivityTaskManagerService的attachApplication(activity是否需要运行)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                didSomething <span class="token operator">=</span> mAtmInternal<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception thrown launching activities in "</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 调用ActiveServices的attachApplication(services是否需要运行)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                didSomething <span class="token operator">|=</span> mServices<span class="token punctuation">.</span><span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"attachApplicationLocked: after mServices.attachApplicationLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception thrown starting services in "</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 看一下是否有挂起的广播需要运行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp <span class="token operator">&amp;&amp;</span> <span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//向广播队列告知，有挂起的进程启动</span>
                didSomething <span class="token operator">|=</span> <span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"attachApplicationLocked: after sendPendingBroadcastsLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// If the app died trying to launch the receiver we declare it 'bad'</span>
                Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception thrown dispatching broadcasts in "</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//...</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">//BroadcastQueue.java</span>
    <span class="token comment">//遍历所有的广播队列，看一下是否有挂起的广播</span>
    <span class="token keyword">boolean</span> <span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mFgBroadcastQueue<span class="token punctuation">.</span><span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
                <span class="token operator">||</span> mBgBroadcastQueue<span class="token punctuation">.</span><span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
                <span class="token operator">||</span> mOffloadBroadcastQueue<span class="token punctuation">.</span><span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//查看该pid是否有挂起的广播</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mPendingBroadcast <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> pid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
	<span class="token comment">//向广播队列告知，有挂起的进程启动</span>
    <span class="token comment">// The app just attached; send any pending broadcasts that it should receive</span>
    <span class="token keyword">boolean</span> <span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>BroadcastQueue queue <span class="token operator">:</span> mBroadcastQueues<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            didSomething <span class="token operator">|=</span> queue<span class="token punctuation">.</span><span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>广播队列处理挂起的进程</li></ol> 
<p>=&gt; 广播队列处理挂起的进程sendPendingBroadcastsLocked -&gt; processCurBroadcastLocked，<br> 并清除mPendingBroadcast = null，广播分发可以继续下去<br> =&gt; processCurBroadcastLocked将广播发送给该app的curComponent<br> =&gt; processCurBroadcastLocked(系统进程BroadcastQueue.java)将该广播传递给curApp-&gt; scheduleReceiver(app进程ActivityThread)<br> -&gt; RECEIVER -&gt; handleReceiver(ActivityThread.java) -&gt; finish(BroadcastReceiver.java) -&gt; finish/sendFinished(BroadcastReceiver.java)<br> -&gt; am.finishReceiver(再次回到系统进程AMS)</p> 
<pre><code class="prism language-java"><span class="token comment">//BroadcastQueue.java</span>
   <span class="token comment">// attachApplicationLocked(AMS) -&gt; sendPendingBroadcastsLocked(AMS/BroadcastQueue)</span>
    <span class="token comment">// 进程启动的时候会清除 mPendingBroadcast</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> BroadcastRecord br <span class="token operator">=</span> mPendingBroadcast<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>br <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> br<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> br<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> app<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>br<span class="token punctuation">.</span>curApp <span class="token operator">!=</span> app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"App mismatch when sending pending broadcast to "</span>
                        <span class="token operator">+</span> app<span class="token punctuation">.</span>processName <span class="token operator">+</span> <span class="token string">", intended target is "</span> <span class="token operator">+</span> br<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//发送给pending的广播时候会清除 mPendingBroadcast = nul</span>
                mPendingBroadcast <span class="token operator">=</span> null<span class="token punctuation">;</span>
				<span class="token comment">//"章节4.4.7"中已经讲过这个函数，就是发送给该app的curComponent(静态接收者组件名字)</span>
                <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>br<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception in new application when starting receiver "</span>
                        <span class="token operator">+</span> br<span class="token punctuation">.</span>curComponent<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>br<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>br<span class="token punctuation">,</span> br<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> br<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                        br<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> br<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// We need to reset the state if we failed to start the receiver.</span>
                br<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="45__3754"></a>4.5 广播接收者处理完成</h3> 
<p>我们接着讲AMS的finishReceiver，这个是广播接受者接收完成后，回传AMS的方法</p> 
<h4><a id="451__3758"></a>4.5.1 广播完成，开始下一个广播的调度</h4> 
<ol><li>该广播接收者已经完成了BroadcastRecord.finishReceiverLocked</li><li>开始下一个广播接受者的调度(这里就是order的按顺序的核心)processNextBroadcastLocked(调用这个函数，相当于下一个重复的逻辑，直到全部广播发送完成)</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//ActivityManagerService.java</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">finishReceiver</span><span class="token punctuation">(</span>IBinder who<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span>
                               Bundle resultExtras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resultAbort<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//打印该广播接受者完成处理的日志</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Finish receiver: "</span> <span class="token operator">+</span> who<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//...</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> doNext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            BroadcastQueue queue<span class="token punctuation">;</span>

            <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//查看广播队列属于前台还是后台</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOnOffloadQueue</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    queue <span class="token operator">=</span> mOffloadBroadcastQueue<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    queue <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_FOREGROUND<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                            <span class="token operator">?</span> mFgBroadcastQueue <span class="token operator">:</span> mBgBroadcastQueue<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

				<span class="token comment">//看一下对应的BroadcastRecord是谁</span>
                r <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">getMatchingOrderedReceiver</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//如果BroadcastRecord r存在，则告知广播队列BroadcastQueue，该广播接收者已经完成了finishReceiverLocked</span>
                    doNext <span class="token operator">=</span> r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                            resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> resultAbort<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				
				<span class="token comment">//如果doNext正常返回true(上一个正常处理完成返回的就是true)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>doNext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//开始下一个广播接受者的调度，这里就是order的按顺序的核心</span>
                    r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span><span class="token comment">/*fromMsg=*/</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">/*skipOomAdj=*/</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// updateOomAdjLocked() will be done here</span>
                <span class="token function">trimApplicationsLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> OomAdjuster<span class="token punctuation">.</span>OOM_ADJ_REASON_FINISH_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="452_finishReceiverLocked_3811"></a>4.5.2 广播完成finishReceiverLocked</h4> 
<p>finishReceiverLocked是广播完成时调用，到这里广播的流程基本上就讲完了</p> 
<pre><code class="prism language-java"><span class="token comment">//BroadcastQueue.java</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span>
                                        String resultData<span class="token punctuation">,</span> Bundle resultExtras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resultAbort<span class="token punctuation">,</span> <span class="token keyword">boolean</span> waitForServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> state <span class="token operator">=</span> r<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityInfo receiver <span class="token operator">=</span> r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> finishTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> elapsed <span class="token operator">=</span> finishTime <span class="token operator">-</span> r<span class="token punctuation">.</span>receiverTime<span class="token punctuation">;</span>
		<span class="token comment">//app状态变成IDLE</span>
        r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
		<span class="token comment">//如果是执行静态注册广播接收的逻辑，这里一般情况是BroadcastRecord.APP_RECEIVE(无超时/无异常情况时)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"finishReceiver ["</span> <span class="token operator">+</span> mQueueName <span class="token operator">+</span> <span class="token string">"] called but state is IDLE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>allowBackgroundActivityStarts <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>curApp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>elapsed <span class="token operator">&gt;</span> mConstants<span class="token punctuation">.</span>ALLOW_BG_ACTIVITY_START_TIMEOUT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// if the receiver has run for more than allowed bg activity start timeout,</span>
                <span class="token comment">// just remove the token for this process now and we're done</span>
                r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span><span class="token function">removeAllowBackgroundActivityStartsToken</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// It gets more time; post the removal to happen at the appropriate moment</span>
                <span class="token function">postActivityStartTokenRemoval</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// If we're abandoning this broadcast before any receivers were actually spun up,</span>
        <span class="token comment">// nextReceiver is zero; in which case time-to-process bookkeeping doesn't apply.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextReceiver <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>duration<span class="token punctuation">[</span>r<span class="token punctuation">.</span>nextReceiver <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> elapsed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// if this receiver was slow, impose deferral policy on the app.  This will kick in</span>
        <span class="token comment">// when processNextBroadcastLocked() next finds this uid as a receiver identity.</span>
		<span class="token comment">//timeoutExempt只有ACTION_PRE_BOOT_COMPLETED才会设置为true，也就是一般会进来</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>timeoutExempt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// r.curApp can be null if finish has raced with process death - benign</span>
            <span class="token comment">// edge case, and we just ignore it because we're already cleaning up</span>
            <span class="token comment">// as expected.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> mConstants<span class="token punctuation">.</span>SLOW_TIME <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> elapsed <span class="token operator">&gt;</span> mConstants<span class="token punctuation">.</span>SLOW_TIME<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Core system packages are exempt from deferral policy</span>
				<span class="token comment">//看一下是否需要加入延迟广播里面</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>UserHandle<span class="token punctuation">.</span><span class="token function">isCore</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Broadcast receiver "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextReceiver <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">" was slow: "</span> <span class="token operator">+</span> receiver <span class="token operator">+</span> <span class="token string">" br="</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mDispatcher<span class="token punctuation">.</span><span class="token function">startDeferring</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Core uid "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>uid
                                <span class="token operator">+</span> <span class="token string">" receiver was slow but not deferring: "</span>
                                <span class="token operator">+</span> receiver <span class="token operator">+</span> <span class="token string">" br="</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST_DEFERRAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Finished broadcast "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">" is exempt from deferral policy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//结束的时候r.receiver = null</span>
        r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>mReceivers<span class="token punctuation">.</span><span class="token function">hasCurReceiver</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>mReceivers<span class="token punctuation">.</span><span class="token function">removeCurReceiver</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">enqueueOomAdjTargetLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curFilter <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>curFilter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>curBroadcast <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>curFilter <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>curReceiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment">//正常的完成广播接收的时候会清除mPendingBroadcast = nul</span>
        mPendingBroadcast <span class="token operator">=</span> null<span class="token punctuation">;</span>

        r<span class="token punctuation">.</span>resultCode <span class="token operator">=</span> resultCode<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>resultData <span class="token operator">=</span> resultData<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>resultExtras <span class="token operator">=</span> resultExtras<span class="token punctuation">;</span>

        <span class="token comment">// bortBroadcast(应用进程) -&gt; finishReceiver(AMS)-&gt; r.queue.finishReceiverLocked(BroadcastQueue)</span>
        <span class="token comment">// 只要这个广播没有设置不能中断，则order的广播，优先级在前面的可以中断后续的广播接收</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultAbort <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_NO_ABORT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>resultAbort <span class="token operator">=</span> resultAbort<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>resultAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If we want to wait behind services *AND* we're finishing the head/</span>
        <span class="token comment">// active broadcast on its queue</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitForServices <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>curComponent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>mDelayBehindServices
                <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>mDispatcher<span class="token punctuation">.</span><span class="token function">getActiveBroadcastLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ActivityInfo nextReceiver<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextReceiver <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Object obj <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                nextReceiver <span class="token operator">=</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>ActivityInfo<span class="token punctuation">)</span>obj <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                nextReceiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Don't do this if the next receive is in the same process as the current one.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> null <span class="token operator">||</span> nextReceiver <span class="token operator">==</span> null
                    <span class="token operator">||</span> receiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> nextReceiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
                    <span class="token operator">||</span> <span class="token operator">!</span>receiver<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>nextReceiver<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// In this case, we are ready to process the next receiver for the current broadcast,</span>
                <span class="token comment">//?but are on a queue that would like to wait for services to finish before moving</span>
                <span class="token comment">// on.  If there are background services currently starting, then we will go into a</span>
                <span class="token comment">// special state where we hold off on continuing this broadcast until they are done.</span>
                <span class="token comment">//如果该uid的进程有正在启动的后台服务mStartingBackground，则等待后台服务启动完成再继续</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mServices<span class="token punctuation">.</span><span class="token function">hasBackgroundServicesLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Delay finish: "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>WAITING_SERVICES<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>curComponent <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment">// We will process the next receiver right now if this is finishing</span>
        <span class="token comment">// an app receiver (which is always asynchronous) or after we have</span>
        <span class="token comment">// come back from calling a receiver.</span>
		<span class="token comment">//发送给静态注册者的时候一般是APP_RECEIVE，发送给动态注册者的时候一般是CALL_DONE_RECEIVE</span>
        <span class="token keyword">return</span> state <span class="token operator">==</span> BroadcastRecord<span class="token punctuation">.</span>APP_RECEIVE
                <span class="token operator">||</span> state <span class="token operator">==</span> BroadcastRecord<span class="token punctuation">.</span>CALL_DONE_RECEIVE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="5__3945"></a>5. 广播的拓展使用</h2> 
<p>从上面的文章基本上可以知道广播是干什么的，广播的流程是怎么样的。<br> 一般广播的应用有3类：<br> 1、针对高配置的设备：VIP广播，给一些关键的进程，关键的广播，放入特定的队列，不会由于本身广播队列阻塞了其广播分发，<br> 达到比较高效的分发<br> 2、针对低配置的设备：<br> =&gt; 延迟广播，间隔分发广播等。主要是广播如平行广播一次性发给所有进程，会导致系统负担；<br> 或者是发送给静态注册者需要启动应用，启动多个应用的时候会导致系统负载过重，可以将类似广播延迟分发。<br> (这个总负载还是一样的，只是分散开来，降低持续卡顿情况，至于偶发的峰值卡顿还是存在，需要别的方法配合)<br> 场景如开机、切换语言等<br> =&gt; 限制广播：如在特定场景限制启动，限制接收等行为，降低系统负载。<br> (这类方法效果立竿见影，不过场景需要非常慎重，不然导致功能使用可能出现异常)<br> =&gt; 其它应用：特定场景修改超时时间，让用户感知的anr减少；针对用户不可见的anr，看一下是否需要用户感知等；接受者优先级调整等。<br> 3、各类广播无法接收问题的解决等(可以考虑动态打开一些基本的调试广播开关DEBUG_BROADCAST DEBUG_BROADCAST_BACKGROUND DEBUG_BROADCAST_DEFERRAL DEBUG_BROADCAST_LIGHT DEBUG_BACKGROUND_CHECK)</p> 
<p>了解广播的流程，实现上述内容一般都大概心里有底，会比较快速的做出相应的方案。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5004009e04f624707cf9b4d6b42e87bc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android进程的adj值</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dc85a8ed6c70f31f7177de1d6dce5834/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JavaScript 静态方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>