<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【架构】docker实现集群主从缩容【案例4/4】 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【架构】docker实现集群主从缩容【案例4/4】" />
<meta property="og:description" content="实现集群主从缩容【4/4】 接上一节，在当前机器为4主4从的架构上，减缩容量为3主3从架构。即实现删除6387和6388.
示意图如下：
第一步：查看集群情况（第一次）
redis-cli --cluster check 127.0.0.1:6387 root@localhost:/data# redis-cli --cluster check 127.0.0.1:6387 127.0.0.1:6387 (bf73145e...) -&gt; 1 keys | 4096 slots | 1 slaves. 122.114.161.116:6381 (6e961a47...) -&gt; 1 keys | 4096 slots | 1 slaves. 122.114.161.116:6383 (78ac7be1...) -&gt; 1 keys | 4096 slots | 1 slaves. 122.114.161.116:6382 (f097fec9...) -&gt; 1 keys | 4096 slots | 1 slaves. [OK] 4 keys in 4 masters. 0.00 keys per slot on average. &gt;&gt;&gt; Performing Cluster Check (using node 127." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a98ad8648e53db25261ce63aef7c75c9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-28T17:16:27+08:00" />
<meta property="article:modified_time" content="2024-01-28T17:16:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【架构】docker实现集群主从缩容【案例4/4】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="44_0"></a>实现集群主从缩容【4/4】</h2> 
<p>接上一节，在当前机器为4主4从的架构上，减缩容量为3主3从架构。即实现删除6387和6388.<br> 示意图如下：<br> <img src="https://images2.imgbox.com/57/81/EdFKhcQn_o.png" alt="在这里插入图片描述"><br> <strong>第一步：查看集群情况（第一次）</strong></p> 
<pre><code class="prism language-python">redis<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token operator">-</span>cluster check <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6387</span>
</code></pre> 
<pre><code>root@localhost:/data# redis-cli --cluster check 127.0.0.1:6387
127.0.0.1:6387 (bf73145e...) -&gt; 1 keys | 4096 slots | 1 slaves.
122.114.161.116:6381 (6e961a47...) -&gt; 1 keys | 4096 slots | 1 slaves.
122.114.161.116:6383 (78ac7be1...) -&gt; 1 keys | 4096 slots | 1 slaves.
122.114.161.116:6382 (f097fec9...) -&gt; 1 keys | 4096 slots | 1 slaves.
[OK] 4 keys in 4 masters.
0.00 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6387)
M: bf73145e2eaaaa08084c9c2dad0d8c757faa48e1 127.0.0.1:6387
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
   1 additional replica(s)
S: 4ed46e0368698cd9d5af2ee84631c878b8ebc4d0 12.114.161.16:6386
   slots: (0 slots) slave
   replicates 6e961a4765b555189708bebb69badf7dfad25cd5
S: 664e456ae7d5cf27ea6583ba2f437dac11d4e767 12.114.161.16:6388
   slots: (0 slots) slave
   replicates bf73145e2eaaaa08084c9c2dad0d8c757faa48e1
S: 9bc2417a9cd6545ef2445eb4aa0610d586acd73b 12.114.161.16:6385
   slots: (0 slots) slave
   replicates 78ac7be13522bd4ffd6fcf900c6c149c6938ecc2
M: 6e961a4765b555189708bebb69badf7dfad25cd5 12.114.161.16:6381
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: 0e34147ce2544cd90f5cce78d5493ae9e8625dfe 12.114.161.16:6384
   slots: (0 slots) slave
   replicates f097fec937f54d147d316c1c62e26cb67c9fd059
M: 78ac7be13522bd4ffd6fcf900c6c149c6938ecc2 12.114.161.16:6383
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
M: f097fec937f54d147d316c1c62e26cb67c9fd059 12.114.161.16:6382
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</code></pre> 
<p><strong>第二步：删除从主机（6388）,删除参数【<code>--cluster del-node</code>】</strong></p> 
<pre><code class="prism language-python">redis<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token operator">-</span>cluster <span class="token keyword">del</span><span class="token operator">-</span>node <span class="token number">12.114</span><span class="token number">.161</span><span class="token number">.16</span><span class="token punctuation">:</span><span class="token number">6388</span> <span class="token number">664e456ae7d5cf27ea6583ba2f437dac11d4e767</span>
</code></pre> 
<pre><code>root@localhost:/data# redis-cli --cluster del-node 12.114.161.16:6388 664e456ae7d5cf27ea6583ba2f437dac11d4e767
&gt;&gt;&gt; Removing node 664e456ae7d5cf27ea6583ba2f437dac11d4e767 from cluster 12.114.161.16:6388
&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.
</code></pre> 
<p><strong>第三步：查看集群情况（第二次）</strong></p> 
<pre><code class="prism language-python">redis<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token operator">-</span>cluster check <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6387</span>
</code></pre> 
<pre><code>略。。。
</code></pre> 
<p><strong>第四步：将该主机的槽位分给6381主机【<code>--cluster reshard</code>】</strong></p> 
<pre><code class="prism language-python">redis<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token operator">-</span>cluster reshard <span class="token number">12.114</span><span class="token number">.161</span><span class="token number">.16</span><span class="token punctuation">:</span><span class="token number">6381</span>
</code></pre> 
<pre><code>root@localhost:/data# redis-cli --cluster reshard 12.114.161.16:6381
&gt;&gt;&gt; Performing Cluster Check (using node 12.114.161.16:6381)
M: 6e961a4765b555189708bebb69badf7dfad25cd5 12.114.161.16:6381
   slots:[0-6826],[10923-12287] (8192 slots) master
   1 additional replica(s)
S: 4ed46e0368698cd9d5af2ee84631c878b8ebc4d0 12.114.161.16:6386
   slots: (0 slots) slave
   replicates 6e961a4765b555189708bebb69badf7dfad25cd5
M: bf73145e2eaaaa08084c9c2dad0d8c757faa48e1 12.114.161.16:6387
   slots: (0 slots) master
S: 9bc2417a9cd6545ef2445eb4aa0610d586acd73b 12.114.161.16:6385
   slots: (0 slots) slave
   replicates 78ac7be13522bd4ffd6fcf900c6c149c6938ecc2
S: 0e34147ce2544cd90f5cce78d5493ae9e8625dfe 12.114.161.16:6384
   slots: (0 slots) slave
   replicates f097fec937f54d147d316c1c62e26cb67c9fd059
M: f097fec937f54d147d316c1c62e26cb67c9fd059 12.114.161.16:6382
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: 78ac7be13522bd4ffd6fcf900c6c149c6938ecc2 12.114.161.16:6383
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
How many slots do you want to move (from 1 to 16384)? 4096                  # 移除多少槽位数？
What is the receiving node ID? 6e961a4765b555189708bebb69badf7dfad25cd5     # 分给哪一台master 主机ID
Please enter all the source node IDs.
  Type 'all' to use all the nodes as source nodes for the hash slots.
  Type 'done' once you entered all the source nodes IDs.
Source node #1: bf73145e2eaaaa08084c9c2dad0d8c757faa48e1             # 从哪一台主机移除的槽位 主机ID
Source node #2: done             # 输入done即可 ，后面提示 直接输入‘yes’即可
...
....
</code></pre> 
<p><strong>第五步：查看集群情况（第三次），确定需要移除主机的槽位数为0</strong></p> 
<pre><code class="prism language-python">redis<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token operator">-</span>cluster check <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6387</span>
</code></pre> 
<pre><code>root@localhost:/data# redis-cli --cluster check 122.114.161.116:6381  
122.114.161.116:6381 (6e961a47...) -&gt; 2 keys | 8192 slots | 1 slaves.      # 此处显示加上移除来的4096个槽位，总共有8192个槽位。转移成功！
122.114.161.116:6387 (bf73145e...) -&gt; 0 keys | 0 slots | 0 slaves.         # 此次显示原来4096个槽位已经移除，显示为 0
122.114.161.116:6382 (f097fec9...) -&gt; 1 keys | 4096 slots | 1 slaves.
122.114.161.116:6383 (78ac7be1...) -&gt; 1 keys | 4096 slots | 1 slaves.
[OK] 4 keys in 4 masters.                                                  # 显示总共4台master主机
0.00 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 122.114.161.116:6381)
M: 6e961a4765b555189708bebb69badf7dfad25cd5 122.114.161.116:6381
   slots:[0-6826],[10923-12287] (8192 slots) master
   1 additional replica(s)
S: 4ed46e0368698cd9d5af2ee84631c878b8ebc4d0 122.114.161.116:6386
   slots: (0 slots) slave
   replicates 6e961a4765b555189708bebb69badf7dfad25cd5
M: bf73145e2eaaaa08084c9c2dad0d8c757faa48e1 122.114.161.116:6387
   slots: (0 slots) master                                                 # 此次显示原来Master主机的 4096个槽位已经移除，显示为 0              
S: 9bc2417a9cd6545ef2445eb4aa0610d586acd73b 122.114.161.116:6385
   slots: (0 slots) slave
   replicates 78ac7be13522bd4ffd6fcf900c6c149c6938ecc2
S: 0e34147ce2544cd90f5cce78d5493ae9e8625dfe 122.114.161.116:6384
   slots: (0 slots) slave
   replicates f097fec937f54d147d316c1c62e26cb67c9fd059
M: f097fec937f54d147d316c1c62e26cb67c9fd059 122.114.161.116:6382
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: 78ac7be13522bd4ffd6fcf900c6c149c6938ecc2 122.114.161.116:6383
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</code></pre> 
<p>根据上面的数据显示，槽位已经转移成功！<br> 【<code>注意：如果想将4096个槽位平均分给另外三台master主机，那么需要重复该操作三次，分别输入不同的目标ID即可！</code>】</p> 
<p><strong>第六步：删除master主机（6387）,删除参数【<code>--cluster del-node</code>】</strong></p> 
<pre><code class="prism language-python">redis<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token operator">-</span>cluster <span class="token keyword">del</span><span class="token operator">-</span>node <span class="token number">12.114</span><span class="token number">.161</span><span class="token number">.16</span><span class="token punctuation">:</span><span class="token number">6387</span> bf73145e2eaaaa08084c9c2dad0d8c757faa48e1
</code></pre> 
<pre><code>root@localhost:/data# redis-cli --cluster del-node 122.114.161.116:6381 bf73145e2eaaaa08084c9c2dad0d8c757faa48e1
&gt;&gt;&gt; Removing node bf73145e2eaaaa08084c9c2dad0d8c757faa48e1 from cluster 122.114.161.116:6381
&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.
</code></pre> 
<p><strong>第七步：查看最终的集群情况（第四次）</strong></p> 
<pre><code class="prism language-python">redis<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token operator">-</span>cluster check <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6387</span>
</code></pre> 
<pre><code>root@localhost:/data# 
root@localhost:/data# 
root@localhost:/data# redis-cli --cluster check 122.114.161.116:6381                                            
122.114.161.116:6381 (6e961a47...) -&gt; 2 keys | 8192 slots | 1 slaves.       # 该列表不在显示6387端口的master主机了
122.114.161.116:6382 (f097fec9...) -&gt; 1 keys | 4096 slots | 1 slaves.
122.114.161.116:6383 (78ac7be1...) -&gt; 1 keys | 4096 slots | 1 slaves.
[OK] 4 keys in 3 masters.                                                   # 此次仅仅剩下3台Master主机
0.00 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 122.114.161.116:6381)
M: 6e961a4765b555189708bebb69badf7dfad25cd5 122.114.161.116:6381
   slots:[0-6826],[10923-12287] (8192 slots) master
   1 additional replica(s)
S: 4ed46e0368698cd9d5af2ee84631c878b8ebc4d0 122.114.161.116:6386
   slots: (0 slots) slave
   replicates 6e961a4765b555189708bebb69badf7dfad25cd5
S: 9bc2417a9cd6545ef2445eb4aa0610d586acd73b 122.114.161.116:6385
   slots: (0 slots) slave
   replicates 78ac7be13522bd4ffd6fcf900c6c149c6938ecc2
S: 0e34147ce2544cd90f5cce78d5493ae9e8625dfe 122.114.161.116:6384
   slots: (0 slots) slave
   replicates f097fec937f54d147d316c1c62e26cb67c9fd059
M: f097fec937f54d147d316c1c62e26cb67c9fd059 122.114.161.116:6382
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: 78ac7be13522bd4ffd6fcf900c6c149c6938ecc2 122.114.161.116:6383
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</code></pre> 
<p>至此，成功将原来的“4主4从架构”，缩容成“3主3从架构”！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e40d05e2ab740e6c85183b205111ab94/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CSS transition（过渡效果）详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/35c93a023f2beae47414e502632de5c3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ElasticSearch 学习笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>