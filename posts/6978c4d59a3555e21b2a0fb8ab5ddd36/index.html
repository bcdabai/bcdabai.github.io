<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>flutter Android编译打包全过程解析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="flutter Android编译打包全过程解析" />
<meta property="og:description" content="文章目录 settings.gradle根目录build.gradleapp/build.gradleFlutterPlugin 本篇主要讲解一个flutter工程是如何编译打包成一个apk的。
注意：这里我们是一个空的flutter项目，然后引入了一个webview-flutter的plugin来模拟一个plugin是如何一起打进去的。
flutter版本：2.4.0-5.0.pre.145
settings.gradle 因为最终产物是apk，所以其实总体上走的还是安卓编译，所以我们先来看settings.gradle文件：
这里我们可以看到，先读取了本地local.properties文件，里面包含了flutter sdk安装目录和android sdk安装目录等。根据flutter sdk安装目录，来到目录下的app_plugin_loader.gradle文件。
这里我们可以看到针对flutter-plugins-dependencies文件进行json解析，我们可以看下flutter-plugins-dependencies文件里的内容，包括了项目中各个平台引入的包的情况，我们项目中只引入了webview_flutter plugin。
ok，读取到了以后进行json解析，然后进行include和project对应处理，经过这一步以后settings.gradle就变成了
include &#34;:webview_flutter&#34; project(&#34;:webview_flutter&#34;).projectDir = new File(&#34;xxxxxxx&#34;)//上面对应的path 没错，这么看的话其实变成了普通的一个android项目的settings.gradle结构了。
根目录build.gradle ok打包的话接下来我们来看build.gradle文件，先来看根目录下的build.gradle文件。
这里我们可以看到指定build产物目录为flutter项目目录的build文件下，以及build下的app目录下。以及首先我们会运行app依赖。ok接下去我们再来看app下的build.gradle文件。
app/build.gradle 首先读取了loacl.properties文件，读取了flutter sdk相关的参数以后，加载了flutter.gradle文件。我们来看看这个flutter sdk里的flutter.gradle文件具体做了些啥。
这里我们看到又apply了一个自定义的plugin FlutterPlugin，ok我就来看这个FlutterPlugin都做了些啥。
FlutterPlugin class FlutterPlugin implements Plugin&lt;Project&gt; { //省略部分代码，主要是声明了一些变量和环境参数。 //具体实现 @Override void apply(Project project) { this.project = project def rootProject = project.rootProject rootProject.tasks.register(&#39;generateLockfiles&#39;) { rootProject.subprojects.each { subproject -&gt; def gradlew = (OperatingSystem.current().isWindows()) ? &#34;${rootProject.projectDir}/gradlew.bat&#34; : &#34;${rootProject.projectDir}/gradlew&#34; rootProject.exec { workingDir rootProject.projectDir executable gradlew args &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6978c4d59a3555e21b2a0fb8ab5ddd36/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-16T11:15:48+08:00" />
<meta property="article:modified_time" content="2022-03-16T11:15:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">flutter Android编译打包全过程解析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#settingsgradle_8" rel="nofollow">settings.gradle</a></li><li><a href="#buildgradle_23" rel="nofollow">根目录build.gradle</a></li><li><a href="#appbuildgradle_29" rel="nofollow">app/build.gradle</a></li><li><a href="#FlutterPlugin_35" rel="nofollow">FlutterPlugin</a></li></ul> 
</div> 
<p></p> 
<p>本篇主要讲解一个flutter工程是如何编译打包成一个apk的。</p> 
<p>注意：这里我们是一个空的flutter项目，然后引入了一个webview-flutter的plugin来模拟一个plugin是如何一起打进去的。<br> flutter版本：2.4.0-5.0.pre.145</p> 
<h2><a id="settingsgradle_8"></a>settings.gradle</h2> 
<p>因为最终产物是apk，所以其实总体上走的还是安卓编译，所以我们先来看settings.gradle文件：<br> <img src="https://images2.imgbox.com/57/fa/96bYmcEs_o.png" alt="在这里插入图片描述"><br> 这里我们可以看到，先读取了本地local.properties文件，里面包含了flutter sdk安装目录和android sdk安装目录等。根据flutter sdk安装目录，来到目录下的app_plugin_loader.gradle文件。<br> <img src="https://images2.imgbox.com/39/89/kcsdOwEN_o.png" alt="在这里插入图片描述"><br> 这里我们可以看到针对flutter-plugins-dependencies文件进行json解析，我们可以看下flutter-plugins-dependencies文件里的内容，包括了项目中各个平台引入的包的情况，我们项目中只引入了webview_flutter plugin。<br> <img src="https://images2.imgbox.com/62/3f/7eljHWaj_o.png" alt="在这里插入图片描述"><br> ok，读取到了以后进行json解析，然后进行include和project对应处理，经过这一步以后settings.gradle就变成了</p> 
<pre><code class="prism language-groovy"> include <span class="token string">":webview_flutter"</span>
 <span class="token function">project</span><span class="token punctuation">(</span><span class="token string">":webview_flutter"</span><span class="token punctuation">)</span><span class="token operator">.</span>projectDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"xxxxxxx"</span><span class="token punctuation">)</span><span class="token comment">//上面对应的path</span>
</code></pre> 
<p>没错，这么看的话其实变成了普通的一个android项目的settings.gradle结构了。</p> 
<h2><a id="buildgradle_23"></a>根目录build.gradle</h2> 
<p>ok打包的话接下来我们来看build.gradle文件，先来看根目录下的build.gradle文件。<br> <img src="https://images2.imgbox.com/0e/c8/E5sqGyBK_o.png" alt="在这里插入图片描述"><br> 这里我们可以看到指定build产物目录为flutter项目目录的build文件下，以及build下的app目录下。以及首先我们会运行app依赖。ok接下去我们再来看app下的build.gradle文件。</p> 
<h2><a id="appbuildgradle_29"></a>app/build.gradle</h2> 
<p><img src="https://images2.imgbox.com/ca/0d/w5mmKZvJ_o.png" alt="在这里插入图片描述"><br> 首先读取了loacl.properties文件，读取了flutter sdk相关的参数以后，加载了flutter.gradle文件。我们来看看这个flutter sdk里的flutter.gradle文件具体做了些啥。<br> <img src="https://images2.imgbox.com/d8/86/JDUjpebz_o.png" alt="在这里插入图片描述"><br> 这里我们看到又apply了一个自定义的plugin FlutterPlugin，ok我就来看这个FlutterPlugin都做了些啥。</p> 
<h2><a id="FlutterPlugin_35"></a>FlutterPlugin</h2> 
<pre><code class="prism language-groovy"><span class="token keyword">class</span> <span class="token class-name">FlutterPlugin</span> <span class="token keyword">implements</span> <span class="token class-name">Plugin</span><span class="token operator">&lt;</span>Project<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//省略部分代码，主要是声明了一些变量和环境参数。</span>

	<span class="token comment">//具体实现</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>Project project<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token operator">.</span>project <span class="token operator">=</span> project

        <span class="token keyword">def</span> rootProject <span class="token operator">=</span> project<span class="token operator">.</span>rootProject
        rootProject<span class="token operator">.</span>tasks<span class="token operator">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'generateLockfiles'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            rootProject<span class="token operator">.</span>subprojects<span class="token operator">.</span>each <span class="token punctuation">{<!-- --></span> subproject <span class="token operator">-&gt;</span>
                <span class="token keyword">def</span> gradlew <span class="token operator">=</span> <span class="token punctuation">(</span>OperatingSystem<span class="token operator">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">isWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                    <span class="token string">"${rootProject.projectDir}/gradlew.bat"</span> <span class="token punctuation">:</span> <span class="token string">"${rootProject.projectDir}/gradlew"</span>
                rootProject<span class="token operator">.</span>exec <span class="token punctuation">{<!-- --></span>
                    workingDir rootProject<span class="token operator">.</span>projectDir
                    executable gradlew
                    args <span class="token string">":${subproject.name}:dependencies"</span><span class="token punctuation">,</span> <span class="token string">"--write-locks"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//1.配置maven地址，如果环境变量里有FLUTTER_STORAGE_BASE_URL就用，没有的话直接用默认的</span>
        String hostedRepository <span class="token operator">=</span> System<span class="token operator">.</span>env<span class="token operator">.</span>FLUTTER_STORAGE_BASE_URL <span class="token operator">?:</span> DEFAULT_MAVEN_HOST
        String repository <span class="token operator">=</span> <span class="token function">useLocalEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'local-engine-repo'</span><span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token string">"$hostedRepository/download.flutter.io"</span>
        rootProject<span class="token operator">.</span>allprojects <span class="token punctuation">{<!-- --></span>
            repositories <span class="token punctuation">{<!-- --></span>
                maven <span class="token punctuation">{<!-- --></span>
                    url repository
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//2.FlutterExtension类包含了source和target属性，创建扩展配置项</span>
        project<span class="token operator">.</span>extensions<span class="token operator">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">,</span> FlutterExtension<span class="token punctuation">)</span>
        <span class="token comment">//3.添加各种task，之后会详解</span>
        <span class="token keyword">this</span><span class="token operator">.</span><span class="token function">addFlutterTasks</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span>

        <span class="token comment">//4.如果构建的时候配置了多个abi参数，那就为每个abi都构建一个自己的apk</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSplitPerAbi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            project<span class="token operator">.</span>android <span class="token punctuation">{<!-- --></span>
                splits <span class="token punctuation">{<!-- --></span>
                    abi <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Enables building multiple APKs per ABI.</span>
                        enable <span class="token boolean">true</span>
                        <span class="token comment">// Resets the list of ABIs that Gradle should create APKs for to none.</span>
                        <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token comment">// Specifies that we do not want to also generate a universal APK that includes all ABIs.</span>
                        universalApk <span class="token boolean">false</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//5.编译命令如果有deferred-component-names参数，那就配置到dynamiceFeatures 属性里</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'deferred-component-names'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> componentNames <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'deferred-component-names'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token operator">.</span>collect <span class="token punctuation">{<!-- --></span><span class="token string">":${it}"</span><span class="token punctuation">}</span>
            project<span class="token operator">.</span>android <span class="token punctuation">{<!-- --></span>
                dynamicFeatures <span class="token operator">=</span> componentNames
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//6.循环添加 d--target-platform参数并添加</span>
        <span class="token function">getTargetPlatforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>each <span class="token punctuation">{<!-- --></span> targetArch <span class="token operator">-&gt;</span>
            String abiValue <span class="token operator">=</span> PLATFORM_ARCH_MAP<span class="token punctuation">[</span>targetArch<span class="token punctuation">]</span>
            project<span class="token operator">.</span>android <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSplitPerAbi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    splits <span class="token punctuation">{<!-- --></span>
                        abi <span class="token punctuation">{<!-- --></span>
                            include abiValue
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//7.获取flutter sdk，没有就报错</span>
        String flutterRootPath <span class="token operator">=</span> <span class="token function">resolveProperty</span><span class="token punctuation">(</span><span class="token string">"flutter.sdk"</span><span class="token punctuation">,</span> System<span class="token operator">.</span>env<span class="token operator">.</span>FLUTTER_ROOT<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flutterRootPath <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GradleException</span><span class="token punctuation">(</span><span class="token string">"Flutter SDK not found. Define location with flutter.sdk in the local.properties file or with a FLUTTER_ROOT environment variable."</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        flutterRoot <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">file</span><span class="token punctuation">(</span>flutterRootPath<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flutterRoot<span class="token operator">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GradleException</span><span class="token punctuation">(</span><span class="token string">"flutter.sdk must point to the Flutter SDK directory"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//8.获取flutter engine版本号，注意，这里如果我们使用的是我们自己本地编译的flutter engine的话，直接取+。flutter engine自己编译之后几篇内容里我们会详解，挺有意思的</span>
        engineVersion <span class="token operator">=</span> <span class="token function">useLocalEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token string">"+"</span> <span class="token comment">// Match any version since there's only one.</span>
            <span class="token punctuation">:</span> <span class="token string">"1.0.0-"</span> <span class="token operator">+</span> Paths<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span>flutterRoot<span class="token operator">.</span>absolutePath<span class="token punctuation">,</span> <span class="token string">"bin"</span><span class="token punctuation">,</span> <span class="token string">"internal"</span><span class="token punctuation">,</span> <span class="token string">"engine.version"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>text<span class="token operator">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token comment">//9.获取flutter.bat命令脚本</span>
        String flutterExecutableName <span class="token operator">=</span> Os<span class="token operator">.</span><span class="token function">isFamily</span><span class="token punctuation">(</span>Os<span class="token operator">.</span>FAMILY_WINDOWS<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"flutter.bat"</span> <span class="token punctuation">:</span> <span class="token string">"flutter"</span>
        flutterExecutable <span class="token operator">=</span> Paths<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span>flutterRoot<span class="token operator">.</span>absolutePath<span class="token punctuation">,</span> <span class="token string">"bin"</span><span class="token punctuation">,</span> flutterExecutableName<span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//10..huoqu flutter混淆脚本</span>
        String flutterProguardRules <span class="token operator">=</span> Paths<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span>flutterRoot<span class="token operator">.</span>absolutePath<span class="token punctuation">,</span> <span class="token string">"packages"</span><span class="token punctuation">,</span> <span class="token string">"flutter_tools"</span><span class="token punctuation">,</span>
                <span class="token string">"gradle"</span><span class="token punctuation">,</span> <span class="token string">"flutter_proguard_rules.pro"</span><span class="token punctuation">)</span>
        <span class="token comment">//11.新增profile构建类型，也就是我们分析性能的时候用到的profile类型</span>
        project<span class="token operator">.</span>android<span class="token operator">.</span>buildTypes <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Add profile build type.</span>
            profile <span class="token punctuation">{<!-- --></span>
                initWith debug
                <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"matchingFallbacks"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    matchingFallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"debug"</span><span class="token punctuation">,</span> <span class="token string">"release"</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//12.目前只有在aot构建多apk的时候才会为false，，主要用添加了一个release构建类型。 </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldShrinkResources</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                release <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Enables code shrinking, obfuscation, and optimization for only</span>
                    <span class="token comment">// your project's release build type.</span>
                    minifyEnabled <span class="token boolean">true</span>
                    <span class="token comment">// Enables resource shrinking, which is performed by the</span>
                    <span class="token comment">// Android Gradle plugin.</span>
                    <span class="token comment">// NOTE: The resource shrinker can't be used for libraries.</span>
                    shrinkResources <span class="token function">isBuiltAsApp</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span>
                    <span class="token comment">// Fallback to `android/app/proguard-rules.pro`.</span>
                    <span class="token comment">// This way, custom Proguard rules can be configured as needed.</span>
                    proguardFiles project<span class="token operator">.</span>android<span class="token operator">.</span><span class="token function">getDefaultProguardFile</span><span class="token punctuation">(</span><span class="token string">"proguard-android.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flutterProguardRules<span class="token punctuation">,</span> <span class="token string">"proguard-rules.pro"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//13.如果使用的是本地编译的flutter engine的话，就要用本地的engine来build</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useLocalEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// This is required to pass the local engine to flutter build aot.</span>
            String engineOutPath <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'local-engine-out'</span><span class="token punctuation">)</span>
            File engineOut <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">file</span><span class="token punctuation">(</span>engineOutPath<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>engineOut<span class="token operator">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GradleException</span><span class="token punctuation">(</span><span class="token string">'local-engine-out must point to a local engine build'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            localEngine <span class="token operator">=</span> engineOut<span class="token operator">.</span>name
            localEngineSrcPath <span class="token operator">=</span> engineOut<span class="token operator">.</span>parentFile<span class="token operator">.</span>parent
        <span class="token punctuation">}</span>
        <span class="token comment">//14.给所有buildtypes添加依赖</span>
        project<span class="token operator">.</span>android<span class="token operator">.</span>buildTypes<span class="token operator">.</span>all <span class="token keyword">this</span><span class="token operator">.&amp;</span>addFlutterDependencies
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> Boolean <span class="token function">shouldShrinkResources</span><span class="token punctuation">(</span>Project project<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"shrink"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">"shrink"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 15.给各个buildtypes添加依赖，主要是embedding和libflutter.so
     * 查看addApiDependencies方法我们可以看到其实就是根据buildtypes，用api或者compile取添加依赖，这和我们平时android开发
     * 添加第三方依赖一样。
     */</span>
    <span class="token keyword">void</span> <span class="token function">addFlutterDependencies</span><span class="token punctuation">(</span>buildType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String flutterBuildMode <span class="token operator">=</span> <span class="token function">buildModeFor</span><span class="token punctuation">(</span>buildType<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">supportsBuildMode</span><span class="token punctuation">(</span>flutterBuildMode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// The embedding is set as an API dependency in a Flutter plugin.</span>
        <span class="token comment">// Therefore, don't make the app project depend on the embedding if there are Flutter</span>
        <span class="token comment">// plugins.</span>
        <span class="token comment">// This prevents duplicated classes when using custom build types. That is, a custom build</span>
        <span class="token comment">// type like profile is used, and the plugin and app projects have API dependencies on the</span>
        <span class="token comment">// embedding.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFlutterAppProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getPluginList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">addApiDependencies</span><span class="token punctuation">(</span>project<span class="token punctuation">,</span> buildType<span class="token operator">.</span>name<span class="token punctuation">,</span>
                    <span class="token string">"io.flutter:flutter_embedding_$flutterBuildMode:$engineVersion"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> platforms <span class="token operator">=</span> <span class="token function">getTargetPlatforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// Debug mode includes x86 and x64, which are commonly used in emulators.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flutterBuildMode <span class="token operator">==</span> <span class="token string">"debug"</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">useLocalEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            platforms<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"android-x86"</span><span class="token punctuation">)</span>
            platforms<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"android-x64"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        platforms<span class="token operator">.</span>each <span class="token punctuation">{<!-- --></span> platform <span class="token operator">-&gt;</span>
            String arch <span class="token operator">=</span> PLATFORM_ARCH_MAP<span class="token punctuation">[</span>platform<span class="token punctuation">]</span><span class="token operator">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span>
            <span class="token comment">// Add the `libflutter.so` dependency.</span>
            <span class="token function">addApiDependencies</span><span class="token punctuation">(</span>project<span class="token punctuation">,</span> buildType<span class="token operator">.</span>name<span class="token punctuation">,</span>
                    <span class="token string">"io.flutter:${arch}_$flutterBuildMode:$engineVersion"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token comment">//。。。省略</span>

</code></pre> 
<p>ok整体过了一遍，我们接下来主要来看addFlutterTasks方法，这里才是整个编译过程最重要的一个地方。</p> 
<pre><code class="prism language-groovy"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addFlutterTasks</span><span class="token punctuation">(</span>Project project<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span>state<span class="token operator">.</span>failure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//1.读取各个配置项，如果有，就赋值</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> fileSystemRootsValue <span class="token operator">=</span> null
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'filesystem-roots'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            fileSystemRootsValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'filesystem-roots'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\|'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        String fileSystemSchemeValue <span class="token operator">=</span> null
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'filesystem-scheme'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            fileSystemSchemeValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'filesystem-scheme'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Boolean trackWidgetCreationValue <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'track-widget-creation'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            trackWidgetCreationValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'track-widget-creation'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        String extraFrontEndOptionsValue <span class="token operator">=</span> null
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'extra-front-end-options'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            extraFrontEndOptionsValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'extra-front-end-options'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        String extraGenSnapshotOptionsValue <span class="token operator">=</span> null
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'extra-gen-snapshot-options'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            extraGenSnapshotOptionsValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'extra-gen-snapshot-options'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        String splitDebugInfoValue <span class="token operator">=</span> null
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'split-debug-info'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            splitDebugInfoValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'split-debug-info'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Boolean dartObfuscationValue <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'dart-obfuscation'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dartObfuscationValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'dart-obfuscation'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Boolean treeShakeIconsOptionsValue <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'tree-shake-icons'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            treeShakeIconsOptionsValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'tree-shake-icons'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        String dartDefinesValue <span class="token operator">=</span> null
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'dart-defines'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dartDefinesValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'dart-defines'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        String bundleSkSLPathValue<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'bundle-sksl-path'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            bundleSkSLPathValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'bundle-sksl-path'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        String performanceMeasurementFileValue<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'performance-measurement-file'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            performanceMeasurementFileValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'performance-measurement-file'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        String codeSizeDirectoryValue<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'code-size-directory'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            codeSizeDirectoryValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'code-size-directory'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Boolean deferredComponentsValue <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'deferred-components'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            deferredComponentsValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'deferred-components'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Boolean validateDeferredComponentsValue <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'validate-deferred-components'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            validateDeferredComponentsValue <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'validate-deferred-components'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//2.默认返回DEFAULT_PLATFORMS</span>
        <span class="token keyword">def</span> targetPlatforms <span class="token operator">=</span> <span class="token function">getTargetPlatforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">def</span> addFlutterDeps <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> variant <span class="token operator">-&gt;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSplitPerAbi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//3.一个apk多个abi变体不允许具有相同的versioncode，所以这一步就是给每个apk赋值唯一的versioncode。</span>
            	<span class="token comment">//更多信息可以看https://developer.android.com/studio/build/configure-apk-splits</span>
                variant<span class="token operator">.</span>outputs<span class="token operator">.</span>each <span class="token punctuation">{<!-- --></span> output <span class="token operator">-&gt;</span>
                    <span class="token keyword">def</span> abiVersionCode <span class="token operator">=</span> ABI_VERSION<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span>output<span class="token operator">.</span><span class="token function">getFilter</span><span class="token punctuation">(</span>OutputFile<span class="token operator">.</span>ABI<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>abiVersionCode <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        output<span class="token operator">.</span>versionCodeOverride <span class="token operator">=</span>
                            abiVersionCode <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span> variant<span class="token operator">.</span>versionCode
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
			<span class="token comment">//4.获取编译类型，debug，release，profile</span>
            String variantBuildMode <span class="token operator">=</span> <span class="token function">buildModeFor</span><span class="token punctuation">(</span>variant<span class="token operator">.</span>buildType<span class="token punctuation">)</span>
            <span class="token comment">//5.拼接字符串，生成各自编译类型对应的task名字</span>
            String taskName <span class="token operator">=</span> <span class="token function">toCammelCase</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compile"</span><span class="token punctuation">,</span> FLUTTER_BUILD_PREFIX<span class="token punctuation">,</span> variant<span class="token operator">.</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">//6.给task各种赋值，这里FlutterTask就是一个基础的gradle task，后面会详细描述</span>
            FlutterTask compileTask <span class="token operator">=</span> project<span class="token operator">.</span>tasks<span class="token operator">.</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> taskName<span class="token punctuation">,</span> type<span class="token punctuation">:</span> FlutterTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                flutterRoot <span class="token keyword">this</span><span class="token operator">.</span>flutterRoot
                flutterExecutable <span class="token keyword">this</span><span class="token operator">.</span>flutterExecutable
                buildMode variantBuildMode
                localEngine <span class="token keyword">this</span><span class="token operator">.</span>localEngine
                localEngineSrcPath <span class="token keyword">this</span><span class="token operator">.</span>localEngineSrcPath
                targetPath <span class="token function">getFlutterTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                verbose <span class="token function">isVerbose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                fastStart <span class="token function">isFastStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                fileSystemRoots fileSystemRootsValue
                fileSystemScheme fileSystemSchemeValue
                trackWidgetCreation trackWidgetCreationValue
                targetPlatformValues <span class="token operator">=</span> targetPlatforms
                sourceDir <span class="token function">getFlutterSourceDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                intermediateDir project<span class="token operator">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string">"${project.buildDir}/${AndroidProject.FD_INTERMEDIATES}/flutter/${variant.name}/"</span><span class="token punctuation">)</span>
                extraFrontEndOptions extraFrontEndOptionsValue
                extraGenSnapshotOptions extraGenSnapshotOptionsValue
                splitDebugInfo splitDebugInfoValue
                treeShakeIcons treeShakeIconsOptionsValue
                dartObfuscation dartObfuscationValue
                dartDefines dartDefinesValue
                bundleSkSLPath bundleSkSLPathValue
                performanceMeasurementFile performanceMeasurementFileValue
                codeSizeDirectory codeSizeDirectoryValue
                deferredComponents deferredComponentsValue
                validateDeferredComponents validateDeferredComponentsValue
                doLast <span class="token punctuation">{<!-- --></span>
                    project<span class="token operator">.</span>exec <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>Os<span class="token operator">.</span><span class="token function">isFamily</span><span class="token punctuation">(</span>Os<span class="token operator">.</span>FAMILY_WINDOWS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">commandLine</span><span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">,</span> <span class="token string">'/c'</span><span class="token punctuation">,</span> <span class="token string">"attrib -r ${assetsDirectory}/* /s"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">commandLine</span><span class="token punctuation">(</span><span class="token string">'chmod'</span><span class="token punctuation">,</span> <span class="token string">'-R'</span><span class="token punctuation">,</span> <span class="token string">'u+w'</span><span class="token punctuation">,</span> assetsDirectory<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//7.项目构建中间产物</span>
            File libJar <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string">"${project.buildDir}/${AndroidProject.FD_INTERMEDIATES}/flutter/${variant.name}/libs.jar"</span><span class="token punctuation">)</span>
            
            <span class="token string">//</span><span class="token number">8</span><span class="token operator">.</span>创建packLibsFlutterBuildDebug<span class="token punctuation">,</span>packLibsFlutterBuildRelease<span class="token punctuation">,</span>packLibsFlutterProfile指令，主要用于把build<span class="token string">/intermediates/</span>flutter<span class="token string">/debug/</span>目录下根据abi生成的app<span class="token operator">.</span>so转换成libs<span class="token operator">.</span>jar
            Task packFlutterAppAotTask <span class="token operator">=</span> project<span class="token operator">.</span>tasks<span class="token operator">.</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">"packLibs${FLUTTER_BUILD_PREFIX}${variant.name.capitalize()}"</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> Jar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                destinationDir libJar<span class="token operator">.</span>parentFile
                archiveName libJar<span class="token operator">.</span>name
                dependsOn compileTask
                targetPlatforms<span class="token operator">.</span>each <span class="token punctuation">{<!-- --></span> targetPlatform <span class="token operator">-&gt;</span>
                    String abi <span class="token operator">=</span> PLATFORM_ARCH_MAP<span class="token punctuation">[</span>targetPlatform<span class="token punctuation">]</span>
                    <span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"${compileTask.intermediateDir}/${abi}"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        include <span class="token string">"*.so"</span>
                        <span class="token string">//</span> <span class="token number">9</span><span class="token operator">.</span>把app<span class="token operator">.</span>so转变成lib<span class="token string">/&lt;abi&gt;/</span>libapp<span class="token operator">.</span>so
                        rename <span class="token punctuation">{<!-- --></span> String filename <span class="token operator">-&gt;</span>
                            <span class="token keyword">return</span> <span class="token string">"lib/${abi}/lib${filename}"</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token string">//</span><span class="token number">10</span><span class="token operator">.</span>把packFlutterAppAotTask生成的产物添加到依赖里去
            <span class="token function">addApiDependencies</span><span class="token punctuation">(</span>project<span class="token punctuation">,</span> variant<span class="token operator">.</span>name<span class="token punctuation">,</span> project<span class="token operator">.</span>files <span class="token punctuation">{<!-- --></span>
                packFlutterAppAotTask
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token string">//</span> <span class="token number">11</span><span class="token operator">.</span>如果有is<span class="token operator">-</span>plugin属性的话，我们就编译aar
            <span class="token keyword">boolean</span> isBuildingAar <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'is-plugin'</span><span class="token punctuation">)</span>
            <span class="token string">//</span> In add to app scenarios<span class="token punctuation">,</span> a Gradle project contains a `<span class="token punctuation">:</span>flutter` and `<span class="token punctuation">:</span>app` project<span class="token operator">.</span>
            <span class="token string">//</span> We know that `<span class="token punctuation">:</span>flutter` is used <span class="token keyword">as</span> a subproject when these tasks exists and we aren't building an AAR<span class="token operator">.</span>
            Task packageAssets <span class="token operator">=</span> project<span class="token operator">.</span>tasks<span class="token operator">.</span><span class="token function">findByPath</span><span class="token punctuation">(</span><span class="token string">":flutter:package${variant.name.capitalize()}Assets"</span><span class="token punctuation">)</span>
            Task cleanPackageAssets <span class="token operator">=</span> project<span class="token operator">.</span>tasks<span class="token operator">.</span><span class="token function">findByPath</span><span class="token punctuation">(</span><span class="token string">":flutter:cleanPackage${variant.name.capitalize()}Assets"</span><span class="token punctuation">)</span>
            <span class="token string">//</span><span class="token number">12</span><span class="token operator">.</span>判断是否是FlutterModule依赖
            <span class="token keyword">boolean</span> isUsedAsSubproject <span class="token operator">=</span> packageAssets <span class="token operator">&amp;&amp;</span> cleanPackageAssets <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isBuildingAar
            Task copyFlutterAssetsTask <span class="token operator">=</span> project<span class="token operator">.</span>tasks<span class="token operator">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                name<span class="token punctuation">:</span> <span class="token string">"copyFlutterAssets${variant.name.capitalize()}"</span><span class="token punctuation">,</span>
                type<span class="token punctuation">:</span> Copy<span class="token punctuation">,</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dependsOn compileTask
                with compileTask<span class="token operator">.</span>assets
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isUsedAsSubproject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    dependsOn packageAssets
                    dependsOn cleanPackageAssets
                    into packageAssets<span class="token operator">.</span>outputDir
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                <span class="token string">//</span> `variant<span class="token operator">.</span>mergeAssets` will be removed at the end of <span class="token number">2019</span><span class="token operator">.</span>
                <span class="token keyword">def</span> mergeAssets <span class="token operator">=</span> variant<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"mergeAssetsProvider"</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                    variant<span class="token operator">.</span>mergeAssetsProvider<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> variant<span class="token operator">.</span>mergeAssets
                dependsOn mergeAssets
                dependsOn <span class="token string">"clean${mergeAssets.name.capitalize()}"</span>
                mergeAssets<span class="token operator">.</span><span class="token function">mustRunAfter</span><span class="token punctuation">(</span><span class="token string">"clean${mergeAssets.name.capitalize()}"</span><span class="token punctuation">)</span>
                into mergeAssets<span class="token operator">.</span>outputDir
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isUsedAsSubproject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">def</span> variantOutput <span class="token operator">=</span> variant<span class="token operator">.</span>outputs<span class="token operator">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">def</span> processResources <span class="token operator">=</span> variantOutput<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"processResourcesProvider"</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                    variantOutput<span class="token operator">.</span>processResourcesProvider<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> variantOutput<span class="token operator">.</span>processResources
                processResources<span class="token operator">.</span><span class="token function">dependsOn</span><span class="token punctuation">(</span>copyFlutterAssetsTask<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> copyFlutterAssetsTask
        <span class="token punctuation">}</span> <span class="token string">//</span> end <span class="token keyword">def</span> addFlutterDeps

		<span class="token string">//</span><span class="token number">13</span><span class="token operator">.</span>如果是flutter app module的话
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFlutterAppProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            project<span class="token operator">.</span>android<span class="token operator">.</span>applicationVariants<span class="token operator">.</span>all <span class="token punctuation">{<!-- --></span> variant <span class="token operator">-&gt;</span>
                Task assembleTask <span class="token operator">=</span> <span class="token function">getAssembleTask</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldConfigureFlutterTask</span><span class="token punctuation">(</span>assembleTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                Task copyFlutterAssetsTask <span class="token operator">=</span> <span class="token function">addFlutterDeps</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
                <span class="token keyword">def</span> variantOutput <span class="token operator">=</span> variant<span class="token operator">.</span>outputs<span class="token operator">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">def</span> processResources <span class="token operator">=</span> variantOutput<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"processResourcesProvider"</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                    variantOutput<span class="token operator">.</span>processResourcesProvider<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> variantOutput<span class="token operator">.</span>processResources
                processResources<span class="token operator">.</span><span class="token function">dependsOn</span><span class="token punctuation">(</span>copyFlutterAssetsTask<span class="token punctuation">)</span>

                <span class="token string">//</span><span class="token number">14</span><span class="token operator">.</span>将apk复制到已知位置，一遍遍运行flutter run，或者flutter build apk命令，一般默认位置是<span class="token operator">&lt;</span>app<span class="token operator">-</span>dir<span class="token operator">&gt;</span><span class="token string">/build/</span>app<span class="token string">/outputs/</span>flutter<span class="token operator">-</span>apk<span class="token operator">/</span><span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span><span class="token operator">.</span>apk
                <span class="token string">//</span>
                <span class="token string">//</span> The filename consists of `app<span class="token operator">&lt;</span><span class="token operator">-</span>abi<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token operator">&lt;</span><span class="token operator">-</span>flavor<span class="token operator">-</span>name<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token operator">-</span><span class="token operator">&lt;</span>build<span class="token operator">-</span>mode<span class="token operator">&gt;</span><span class="token operator">.</span>apk`<span class="token operator">.</span>
                <span class="token string">//</span> Where<span class="token punctuation">:</span>
                <span class="token string">//</span>   <span class="token operator">*</span> `abi` can be `armeabi<span class="token operator">-</span>v7a<span class="token operator">|</span>arm64<span class="token operator">-</span>v8a<span class="token operator">|</span>x86<span class="token operator">|</span>x86_64` only <span class="token keyword">if</span> the flag `split<span class="token operator">-</span>per<span class="token operator">-</span>abi` is set<span class="token operator">.</span>
                <span class="token string">//</span>   <span class="token operator">*</span> `flavor<span class="token operator">-</span>name` is the flavor used to build the app <span class="token keyword">in</span> lower <span class="token keyword">case</span> <span class="token keyword">if</span> the assemble task is called<span class="token operator">.</span>
                <span class="token string">//</span>   <span class="token operator">*</span> `build<span class="token operator">-</span>mode` can be `release<span class="token operator">|</span>debug<span class="token operator">|</span>profile`<span class="token operator">.</span>
                variant<span class="token operator">.</span>outputs<span class="token operator">.</span>all <span class="token punctuation">{<!-- --></span> output <span class="token operator">-&gt;</span>
                    assembleTask<span class="token operator">.</span>doLast <span class="token punctuation">{<!-- --></span>
                        <span class="token string">//</span> `packageApplication` became `packageApplicationProvider` <span class="token keyword">in</span> AGP <span class="token number">3.3</span><span class="token operator">.</span><span class="token number">0</span><span class="token operator">.</span>
                        <span class="token keyword">def</span> outputDirectory <span class="token operator">=</span> variant<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"packageApplicationProvider"</span><span class="token punctuation">)</span>
                            <span class="token operator">?</span> variant<span class="token operator">.</span>packageApplicationProvider<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>outputDirectory
                            <span class="token punctuation">:</span> variant<span class="token operator">.</span>packageApplication<span class="token operator">.</span>outputDirectory
                        <span class="token string">//</span>  `outputDirectory` is a `DirectoryProperty` <span class="token keyword">in</span> AGP <span class="token number">4.1</span><span class="token operator">.</span>
                        String outputDirectoryStr <span class="token operator">=</span> outputDirectory<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">respondsTo</span><span class="token punctuation">(</span>outputDirectory<span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">)</span>
                            <span class="token operator">?</span> outputDirectory<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">:</span> outputDirectory
                        String filename <span class="token operator">=</span> <span class="token string">"app"</span>
                        String abi <span class="token operator">=</span> output<span class="token operator">.</span><span class="token function">getFilter</span><span class="token punctuation">(</span>OutputFile<span class="token operator">.</span>ABI<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>abi <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>abi<span class="token operator">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            filename <span class="token operator">+=</span> <span class="token string">"-${abi}"</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>variant<span class="token operator">.</span>flavorName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>variant<span class="token operator">.</span>flavorName<span class="token operator">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            filename <span class="token operator">+=</span> <span class="token string">"-${variant.flavorName.toLowerCase()}"</span>
                        <span class="token punctuation">}</span>
                        filename <span class="token operator">+=</span> <span class="token string">"-${buildModeFor(variant.buildType)}"</span>
                        project<span class="token operator">.</span>copy <span class="token punctuation">{<!-- --></span>
                            from <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"$outputDirectoryStr/${output.outputFileName}"</span><span class="token punctuation">)</span>
                            into <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"${project.buildDir}/outputs/flutter-apk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            rename <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">return</span> <span class="token string">"${filename}.apk"</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token string">//</span><span class="token number">14</span><span class="token operator">.</span>这里主要是去执行flutter pub get去获取flutter对应的依赖，并添加
            <span class="token function">configurePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token string">//</span><span class="token number">15</span><span class="token operator">.</span>如果是模块依赖的方式集成到现在项目中的话，对模块做上述相应重复操作。
        String hostAppProjectName <span class="token operator">=</span> project<span class="token operator">.</span>rootProject<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">'flutter.hostAppProjectName'</span><span class="token punctuation">)</span> <span class="token operator">?</span> project<span class="token operator">.</span>rootProject<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'flutter.hostAppProjectName'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">"app"</span>
        Project appProject <span class="token operator">=</span> project<span class="token operator">.</span>rootProject<span class="token operator">.</span><span class="token function">findProject</span><span class="token punctuation">(</span><span class="token string">":${hostAppProjectName}"</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> appProject <span class="token operator">!=</span> null <span class="token punctuation">:</span> <span class="token string">"Project :${hostAppProjectName} doesn't exist. To custom the host app project name, set `org.gradle.project.flutter.hostAppProjectName=&lt;project-name&gt;` in gradle.properties."</span>
        <span class="token string">//</span> Wait <span class="token keyword">for</span> the host app project configuration<span class="token operator">.</span>
        appProject<span class="token operator">.</span>afterEvaluate <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">assert</span> appProject<span class="token operator">.</span>android <span class="token operator">!=</span> null
            project<span class="token operator">.</span>android<span class="token operator">.</span>libraryVariants<span class="token operator">.</span>all <span class="token punctuation">{<!-- --></span> libraryVariant <span class="token operator">-&gt;</span>
                Task copyFlutterAssetsTask
                appProject<span class="token operator">.</span>android<span class="token operator">.</span>applicationVariants<span class="token operator">.</span>all <span class="token punctuation">{<!-- --></span> appProjectVariant <span class="token operator">-&gt;</span>
                    Task appAssembleTask <span class="token operator">=</span> <span class="token function">getAssembleTask</span><span class="token punctuation">(</span>appProjectVariant<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldConfigureFlutterTask</span><span class="token punctuation">(</span>appAssembleTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span>
                    <span class="token punctuation">}</span>
                    <span class="token string">//</span> Find a compatible application variant <span class="token keyword">in</span> the host app<span class="token operator">.</span>
                    <span class="token string">//</span>
                    <span class="token string">//</span> For example<span class="token punctuation">,</span> consider a host app that defines the following variants<span class="token punctuation">:</span>
                    <span class="token string">//</span> <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">|</span>
                    <span class="token string">//</span> <span class="token operator">|</span>   Build Variant   <span class="token operator">|</span>   Flutter Equivalent Variant  <span class="token operator">|</span>
                    <span class="token string">//</span> <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">|</span>
                    <span class="token string">//</span> <span class="token operator">|</span>   freeRelease     <span class="token operator">|</span>   release                      <span class="token operator">|</span>
                    <span class="token string">//</span> <span class="token operator">|</span>   freeDebug       <span class="token operator">|</span>   debug                       <span class="token operator">|</span>
                    <span class="token string">//</span> <span class="token operator">|</span>   freeDevelop     <span class="token operator">|</span>   debug                       <span class="token operator">|</span>
                    <span class="token string">//</span> <span class="token operator">|</span>   profile         <span class="token operator">|</span>   profile                     <span class="token operator">|</span>
                    <span class="token string">//</span> <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">|</span>
                    <span class="token string">//</span>
                    <span class="token string">//</span> This mapping is based on the following rules<span class="token punctuation">:</span>
                    <span class="token string">//</span> <span class="token number">1</span><span class="token operator">.</span> If the host app build variant name is `profile` then the equivalent
                    <span class="token string">//</span>    Flutter variant is `profile`<span class="token operator">.</span>
                    <span class="token string">//</span> <span class="token number">2</span><span class="token operator">.</span> If the host app build variant is debuggable
                    <span class="token string">//</span>    <span class="token punctuation">(</span>e<span class="token operator">.</span>g<span class="token operator">.</span> `buildType<span class="token operator">.</span>debuggable <span class="token operator">=</span> <span class="token boolean">true</span>`<span class="token punctuation">)</span><span class="token punctuation">,</span> then the equivalent Flutter
                    <span class="token string">//</span>    variant is `debug`<span class="token operator">.</span>
                    <span class="token string">//</span> <span class="token number">3</span><span class="token operator">.</span> Otherwise<span class="token punctuation">,</span> the equivalent Flutter variant is `release`<span class="token operator">.</span>
                    String variantBuildMode <span class="token operator">=</span> <span class="token function">buildModeFor</span><span class="token punctuation">(</span>libraryVariant<span class="token operator">.</span>buildType<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">buildModeFor</span><span class="token punctuation">(</span>appProjectVariant<span class="token operator">.</span>buildType<span class="token punctuation">)</span> <span class="token operator">!=</span> variantBuildMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>copyFlutterAssetsTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        copyFlutterAssetsTask <span class="token operator">=</span> <span class="token function">addFlutterDeps</span><span class="token punctuation">(</span>libraryVariant<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    Task mergeAssets <span class="token operator">=</span> project
                        <span class="token operator">.</span>tasks
                        <span class="token operator">.</span><span class="token function">findByPath</span><span class="token punctuation">(</span><span class="token string">":${hostAppProjectName}:merge${appProjectVariant.name.capitalize()}Assets"</span><span class="token punctuation">)</span>
                    <span class="token keyword">assert</span> mergeAssets
                    mergeAssets<span class="token operator">.</span><span class="token function">dependsOn</span><span class="token punctuation">(</span>copyFlutterAssetsTask<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">configurePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>packFlutterAppAotTask和copyFlutterAssetsTask两个task完成了以后相当于生成了flutter_assets目录下的这些flutter产物，最终将会编译打包进apk里，也就是apk里相对应的flutter_assets下。<br> <img src="https://images2.imgbox.com/70/c7/xg7vUfqS_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b2/1e/datgFTOI_o.png" alt="在这里插入图片描述"></p> 
<p>至此，flutter打包的大框架上的流程就走完了，但你是不是发现其实还没到点上。。没错我们回到上面的第6条，我们来着重看下这个FlutterTask任务。</p> 
<pre><code class="prism language-groovy"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseFlutterTask</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultTask</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Internal</span>
    File flutterRoot
    <span class="token annotation punctuation">@Internal</span>
    File flutterExecutable
    <span class="token annotation punctuation">@Input</span>
    String buildMode
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String localEngine
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String localEngineSrcPath
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    Boolean fastStart
    <span class="token annotation punctuation">@Input</span>
    String targetPath
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Internal</span>
    Boolean verbose
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String<span class="token punctuation">[</span><span class="token punctuation">]</span> fileSystemRoots
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String fileSystemScheme
    <span class="token annotation punctuation">@Input</span>
    Boolean trackWidgetCreation
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> targetPlatformValues
    <span class="token annotation punctuation">@Internal</span>
    File sourceDir
    <span class="token annotation punctuation">@Internal</span>
    File intermediateDir
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String extraFrontEndOptions
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String extraGenSnapshotOptions
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String splitDebugInfo
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    Boolean treeShakeIcons
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    Boolean dartObfuscation
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String dartDefines
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String bundleSkSLPath
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String codeSizeDirectory<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    String performanceMeasurementFile<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    Boolean deferredComponents
    <span class="token annotation punctuation">@Optional</span> <span class="token annotation punctuation">@Input</span>
    Boolean validateDeferredComponents

    <span class="token annotation punctuation">@OutputFiles</span>
    FileCollection <span class="token function">getDependenciesFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FileCollection depfiles <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// Includes all sources used in the flutter compilation.</span>
        depfiles <span class="token operator">+=</span> project<span class="token operator">.</span><span class="token function">files</span><span class="token punctuation">(</span><span class="token string">"${intermediateDir}/flutter_build.d"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> depfiles
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">buildBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sourceDir<span class="token operator">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GradleException</span><span class="token punctuation">(</span><span class="token string">"Invalid Flutter source directory: ${sourceDir}"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        intermediateDir<span class="token operator">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// Compute the rule name for flutter assemble. To speed up builds that contain</span>
        <span class="token comment">// multiple ABIs, the target name is used to communicate which ones are required</span>
        <span class="token comment">// rather than the TargetPlatform. This allows multiple builds to share the same</span>
        <span class="token comment">// cache.</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> ruleNames<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buildMode <span class="token operator">==</span> <span class="token string">"debug"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ruleNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"debug_android_application"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>deferredComponents<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ruleNames <span class="token operator">=</span> targetPlatformValues<span class="token operator">.</span>collect <span class="token punctuation">{<!-- --></span> <span class="token string">"android_aot_deferred_components_bundle_${buildMode}_$it"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            ruleNames <span class="token operator">=</span> targetPlatformValues<span class="token operator">.</span>collect <span class="token punctuation">{<!-- --></span> <span class="token string">"android_aot_bundle_${buildMode}_$it"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        project<span class="token operator">.</span>exec <span class="token punctuation">{<!-- --></span>
            logging<span class="token operator">.</span>captureStandardError LogLevel<span class="token operator">.</span>ERROR
            executable flutterExecutable<span class="token operator">.</span>absolutePath
            workingDir sourceDir
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localEngine <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"--local-engine"</span><span class="token punctuation">,</span> localEngine
                args <span class="token string">"--local-engine-src-path"</span><span class="token punctuation">,</span> localEngineSrcPath
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>verbose<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"--verbose"</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"--quiet"</span>
            <span class="token punctuation">}</span>
            args <span class="token string">"assemble"</span>
            args <span class="token string">"--no-version-check"</span>
            args <span class="token string">"--depfile"</span><span class="token punctuation">,</span> <span class="token string">"${intermediateDir}/flutter_build.d"</span>
            args <span class="token string">"--output"</span><span class="token punctuation">,</span> <span class="token string">"${intermediateDir}"</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>performanceMeasurementFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"--performance-measurement-file=${performanceMeasurementFile}"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fastStart <span class="token operator">||</span> buildMode <span class="token operator">!=</span> <span class="token string">"debug"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"-dTargetFile=${targetPath}"</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"-dTargetFile=${Paths.get(flutterRoot.absolutePath, "</span>examples<span class="token string">", "</span>splash<span class="token string">", "</span>lib<span class="token string">", "</span>main<span class="token operator">.</span>dart<span class="token string">")}"</span>
            <span class="token punctuation">}</span>
            args <span class="token string">"-dTargetPlatform=android"</span>
            args <span class="token string">"-dBuildMode=${buildMode}"</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>trackWidgetCreation <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"-dTrackWidgetCreation=${trackWidgetCreation}"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>splitDebugInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"-dSplitDebugInfo=${splitDebugInfo}"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>treeShakeIcons <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"-dTreeShakeIcons=true"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dartObfuscation <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"-dDartObfuscation=true"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dartDefines <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"--DartDefines=${dartDefines}"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bundleSkSLPath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"-dBundleSkSLPath=${bundleSkSLPath}"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>codeSizeDirectory <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"-dCodeSizeDirectory=${codeSizeDirectory}"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>extraGenSnapshotOptions <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"--ExtraGenSnapshotOptions=${extraGenSnapshotOptions}"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>extraFrontEndOptions <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                args <span class="token string">"--ExtraFrontEndOptions=${extraFrontEndOptions}"</span>
            <span class="token punctuation">}</span>
            args ruleNames
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FlutterTask</span> <span class="token keyword">extends</span> <span class="token class-name">BaseFlutterTask</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@OutputDirectory</span>
    File <span class="token function">getOutputDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> intermediateDir
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Internal</span>
    String <span class="token function">getAssetsDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"${outputDirectory}/flutter_assets"</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Internal</span>
    CopySpec <span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> project<span class="token operator">.</span>copySpec <span class="token punctuation">{<!-- --></span>
            from <span class="token string">"${intermediateDir}"</span>
            include <span class="token string">"flutter_assets/**"</span> <span class="token comment">// the working dir and its files</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Internal</span>
    CopySpec <span class="token function">getSnapshots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> project<span class="token operator">.</span>copySpec <span class="token punctuation">{<!-- --></span>
            from <span class="token string">"${intermediateDir}"</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>buildMode <span class="token operator">==</span> <span class="token string">'release'</span> <span class="token operator">||</span> buildMode <span class="token operator">==</span> <span class="token string">'profile'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                targetPlatformValues<span class="token operator">.</span>each <span class="token punctuation">{<!-- --></span>
                    include <span class="token string">"${PLATFORM_ARCH_MAP[targetArch]}/app.so"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    FileCollection <span class="token function">readDependencies</span><span class="token punctuation">(</span>File dependenciesFile<span class="token punctuation">,</span> Boolean inputs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dependenciesFile<span class="token operator">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">//</span> Dependencies file has Makefile syntax<span class="token punctuation">:</span>
        <span class="token string">//</span>   <span class="token operator">&lt;</span>target<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>files<span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>source<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>files<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>separated<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>by<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>non<span class="token operator">-</span>escaped space<span class="token operator">&gt;</span>
        String depText <span class="token operator">=</span> dependenciesFile<span class="token operator">.</span>text
        <span class="token string">//</span> So we split list of files by non<span class="token operator">-</span><span class="token function">escaped</span><span class="token punctuation">(</span>by backslash<span class="token punctuation">)</span> space<span class="token punctuation">,</span>
        <span class="token keyword">def</span> matcher <span class="token operator">=</span> depText<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span><span class="token punctuation">[</span>inputs <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=~</span> <span class="token string">/(\\ |[^\s])+/</span>
        <span class="token string">//</span> then we replace all escaped spaces with regular spaces
        <span class="token keyword">def</span> depList <span class="token operator">=</span> matcher<span class="token operator">.</span>collect<span class="token punctuation">{<!-- --></span>it<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\\\\ "</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> project<span class="token operator">.</span><span class="token function">files</span><span class="token punctuation">(</span>depList<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> project<span class="token operator">.</span><span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@InputFiles</span>
    FileCollection <span class="token function">getSourceFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FileCollection sources <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>File depfile <span class="token keyword">in</span> <span class="token function">getDependenciesFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          sources <span class="token operator">+=</span> <span class="token function">readDependencies</span><span class="token punctuation">(</span>depfile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sources <span class="token operator">+</span> project<span class="token operator">.</span><span class="token function">files</span><span class="token punctuation">(</span><span class="token string">'pubspec.yaml'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OutputFiles</span>
    FileCollection <span class="token function">getOutputFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FileCollection sources <span class="token operator">=</span> project<span class="token operator">.</span><span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>File depfile <span class="token keyword">in</span> <span class="token function">getDependenciesFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          sources <span class="token operator">+=</span> <span class="token function">readDependencies</span><span class="token punctuation">(</span>depfile<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sources
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@TaskAction</span>
    <span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">buildBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>按照task基础，我们直接来看@TaskAction，里面调用了buildBundle方法，我们来这个方法，里面重点执行了flutter编译命令脚本，饼配置了各种脚本参数，主要调用了flutter sdk下面的bin/flutter 编译命令。至此应用层面打包apk的流程就过完了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8f7d7406aa9ad3ccae09c091b30fab24/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AD绘制原理图库时报错</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7dc9732ffe9ed470bd524e8f673adab0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">How do vision transformer work?【论文解读】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>