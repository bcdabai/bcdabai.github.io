<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Impala配置与错误解决方案 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Impala配置与错误解决方案" />
<meta property="og:description" content="安装环境 版本 2.1.0 对应CDH5.3.0 impala是CDH的组件，hadoop其他环境(hdfs、yarn、hive)已经准备的情况下，直接通过yum进行安装，这里提供下载地址impala下载
安装内容: 安装的用户为：root hdname （hive 元数据节点所在） impala impala-server impala-state-store impala-catalog impala-shell 其他节点 impala-server impala-shell
权限配置（所有机器都应当进行） impala 安装过程中会创建名为 impala 的用户和组，不要删除该用户和组。 如果想要 impala 和 YARN 合作，需要把 impala 用户加入 hdfs 组，相关的可以了解的是Llama项目。 impala 在执行 DROP TABLE 操作时，需要把文件移到到 hdfs 的回收站，所以你需要创建一个 hdfs 的目录 /user/impala，并将其设置为impala 用户可写。同样的，impala 需要读取 hive 数据仓库下的数据，故需要把 impala 用户加入 hive 组。
添加附属组命令 usermod -G hive,hdfs,hadoop impala 结果如图 创建impala在hdfs上的目录并设置权限 sudo -u hdfs hadoop fs -mkdir /user/impala sudo -u hdfs hadoop fs -chown impala /user/impala 设置scoket path 在每个节点上创建/var/run/hadoop-hdfs kdir -p /var/run/hadoop-hdfs 注意：该文件夹可能已经存在，应当确认用impala是否有权限进行读写 如果已经存在，将用户impala加入该文件所属的组，并修改该文件组的权限即：chmod 775 /var/run/hadoop-hdfs" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6803d745f07e7f82afb8415e92eb2c66/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-05-07T17:01:11+08:00" />
<meta property="article:modified_time" content="2015-05-07T17:01:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Impala配置与错误解决方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2 id="安装环境">安装环境</h2> 
<p>版本 2.1.0 对应CDH5.3.0 <br>        impala是CDH的组件，hadoop其他环境(hdfs、yarn、hive)已经准备的情况下，直接通过yum进行安装，这里提供下载地址<a href="http://archive.cloudera.com/impala/redhat/6/x86_64/impala" rel="nofollow">impala下载</a></p> 
<p>安装内容: <br> 安装的用户为：root <br>        hdname （hive 元数据节点所在） <br>                impala impala-server impala-state-store impala-catalog impala-shell <br>        其他节点 <br>        impala-server impala-shell</p> 
<h2 id="权限配置所有机器都应当进行">权限配置（所有机器都应当进行）</h2> 
<p>　　　impala 安装过程中会创建名为 impala 的用户和组，不要删除该用户和组。 <br> 如果想要 impala 和 YARN 合作，需要把 impala 用户加入 hdfs 组，相关的可以了解的是Llama项目。 <br> 　　impala 在执行 DROP TABLE 操作时，需要把文件移到到 hdfs 的回收站，所以你需要创建一个 hdfs 的目录 /user/impala，并将其设置为impala 用户可写。同样的，impala 需要读取 hive 数据仓库下的数据，故需要把 impala 用户加入 hive 组。</p> 
<h3 id="添加附属组命令">添加附属组命令</h3> 
<pre class="prettyprint"><code class=" hljs lasso">    usermod <span class="hljs-attribute">-G</span> hive,hdfs,hadoop impala</code></pre> 
<p>结果如图 <br> <img src="https://images2.imgbox.com/5f/36/ZkvEurME_o.jpg" alt="这里写图片描述" title=""></p> 
<h3 id="创建impala在hdfs上的目录并设置权限">创建impala在hdfs上的目录并设置权限</h3> 
<pre class="prettyprint"><code class=" hljs lasso">sudo <span class="hljs-attribute">-u</span> hdfs hadoop fs <span class="hljs-attribute">-mkdir</span> /user/impala
sudo <span class="hljs-attribute">-u</span> hdfs hadoop fs <span class="hljs-attribute">-chown</span> impala /user/impala</code></pre> 
<h3 id="设置scoket-path">设置scoket path</h3> 
<p>在每个节点上创建/var/run/hadoop-hdfs <br> <code>kdir -p /var/run/hadoop-hdfs</code> <br> 　　注意：该文件夹可能已经存在，应当确认用impala是否有权限进行读写 <br> 　　如果已经存在，将用户impala加入该文件所属的组，并修改该文件组的权限即：<code>chmod 775 /var/run/hadoop-hdfs</code></p> 
<h3 id="mysql驱动">mysql驱动</h3> 
<p>驱动下载地址<a href="http://cdn.mysql.com/archives/mysql-connector-java-5.1/mysql-connector-java-5.1.30.tar.gz" rel="nofollow">mysql-connector-java-5.1.30.tar.gz</a> <br> 将下载的文件复制到<code>/usr/share/java/</code>并修改名为mysql-connector-java.jar <br> 选择这个文件路径是因为impala的默认路径是这个，可以查看/etc/default/impala中的参数<code>MYSQL_CONNECTOR_JAR</code></p> 
<p>#配置文件设置 <br> 配置文件存在两个地方 <br> ##/etc/default/impala <br> 该文件为impala的默认配置，包含了机器信息和相关路径配置，包括JDBC、impala的所有配置文件，这里需要修改的是metastore和catalog两个服务安装所在的主机信息，最终结果如下,高亮部分为修改地方，其中hdname为impala的catalog和state-store组件安装所在机器的host名，也即元数据mysql所在机器</p> 
<pre class="prettyprint"><code class="language-shell hljs vala">==IMPALA_CATALOG_SERVICE_HOST=hdname==
==IMPALA_STATE_STORE_HOST=hdname==
IMPALA_STATE_STORE_PORT=<span class="hljs-number">24000</span>
IMPALA_BACKEND_PORT=<span class="hljs-number">22000</span>
IMPALA_LOG_DIR=/<span class="hljs-keyword">var</span>/log/impala

IMPALA_CATALOG_ARGS=<span class="hljs-string">" -log_dir=${IMPALA_LOG_DIR} ==-state_store_host=${IMPALA_STATE_STORE_HOST}== "</span>
IMPALA_STATE_STORE_ARGS=<span class="hljs-string">" -log_dir=${IMPALA_LOG_DIR} -state_store_port=${IMPALA_STATE_STORE_PORT}"</span>
IMPALA_SERVER_ARGS=<span class="hljs-string">" \
    -log_dir=${IMPALA_LOG_DIR} \
    -catalog_service_host=${IMPALA_CATALOG_SERVICE_HOST} \
    -state_store_port=${IMPALA_STATE_STORE_PORT} \
    -use_statestore \
    -state_store_host=${IMPALA_STATE_STORE_HOST} \
    -be_port=${IMPALA_BACKEND_PORT}"</span>

ENABLE_CORE_DUMPS=<span class="hljs-literal">true</span>

<span class="hljs-preprocessor"># LIBHDFS_OPTS=-Djava.library.path=/usr/lib/impala/lib</span>
<span class="hljs-preprocessor"># MYSQL_CONNECTOR_JAR=/usr/share/java/mysql-connector-java.jar</span>
<span class="hljs-preprocessor"># IMPALA_BIN=/usr/lib/impala/sbin</span>
<span class="hljs-preprocessor"># IMPALA_HOME=/usr/lib/impala</span>
<span class="hljs-preprocessor"># HIVE_HOME=/usr/lib/hive</span>
<span class="hljs-preprocessor"># HBASE_HOME=/usr/lib/hbase</span>
<span class="hljs-preprocessor"># IMPALA_CONF_DIR=/etc/impala/conf</span>
<span class="hljs-preprocessor"># HADOOP_CONF_DIR=/etc/impala/conf</span>
<span class="hljs-preprocessor"># HIVE_CONF_DIR=/etc/impala/conf</span>
<span class="hljs-preprocessor"># HBASE_CONF_DIR=/etc/impala/conf</span></code></pre> 
<p>##/etc/impala/conf <br> 　　实际上这个文件所在的位置是由/etc/default/impala中所决定的，有的版本可能是在/usr/lib/impala/conf下 <br> 　　hive、hdfs、core三个核心配置文件分别从hdfs和hive的配置文件中复制过来,如果有hbase-site.xml,也一起复制过来 <br> 　　结果如下： <br> <img src="https://images2.imgbox.com/9d/aa/WsXAkme5_o.jpg" alt="这里写图片描述" title=""> <br> 　　修改文件hdfs-site.xml，在文件中增加下列内容</p> 
<pre class="prettyprint"><code class=" hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-title">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">name</span>&gt;</span>dfs.client.read.shortcircuit<span class="hljs-tag">&lt;/<span class="hljs-title">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-title">value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">name</span>&gt;</span>dfs.domain.socket.path<span class="hljs-tag">&lt;/<span class="hljs-title">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">value</span>&gt;</span>/var/run/hadoop-hdfs/dn._PORT<span class="hljs-tag">&lt;/<span class="hljs-title">value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">name</span>&gt;</span>dfs.datanode.hdfs-blocks-metadata.enabled<span class="hljs-tag">&lt;/<span class="hljs-title">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-title">value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">name</span>&gt;</span>dfs.client.file-block-storage-locations.timeout<span class="hljs-tag">&lt;/<span class="hljs-title">name</span>&gt;</span>  
  <span class="hljs-tag">&lt;<span class="hljs-title">value</span>&gt;</span>10000<span class="hljs-tag">&lt;/<span class="hljs-title">value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span></code></pre> 
<h3 id="配置文件同步">配置文件同步</h3> 
<p>　　将impala文件和conf文件夹同步到所有的impala-server节点</p> 
<h2 id="启动impala">启动impala</h2> 
<p>确认所有的服务已经启动，包括hive、impala，查看impala启动服务可以使用命令</p> 
<pre class="prettyprint"><code class=" hljs 1c">ps -ef <span class="hljs-string">|grep impala</span></code></pre> 
<p>如果正常的话，在hdname中有以下三个服务，如图 <br> <img src="https://images2.imgbox.com/b3/47/s3kZMRF6_o.jpg" alt="这里写图片描述" title=""> <br> 有可以通过url访问也可以通过浏览器访问相关的服务</p> 
<pre class="prettyprint"><code class=" hljs axapta">            主机名：<span class="hljs-number">25010</span>  默认的元数据所在节点信息，
            主机名:<span class="hljs-number">25000</span>    <span class="hljs-keyword">server</span>信息,任何有装<span class="hljs-keyword">server</span>的节点都可以访问
            主机名：<span class="hljs-number">25020</span>  catalog信息</code></pre> 
<p>在任意一节点使用命令<code>impala-shell</code>登录impala终端，连接到store中<code>connect hdname;</code> <br> 　　执行命令<code>invalidate metadata</code>更新元数据 <br> 　　结果如图 <br> <img src="https://images2.imgbox.com/6c/f2/DNunX1pA_o.jpg" alt="这里写图片描述" title=""></p> 
<h2 id="错误解决参考">错误解决参考</h2> 
<h3 id="错误1">错误1</h3> 
<p>路径权限问题 <br> <code>Error connecting: TTransportException, Could not connect to master:21000</code> <br> 在日志文件/var/log/impala中查看impalad.ERROR,错误如下</p> 
<pre class="prettyprint"><code class=" hljs vbnet"><span class="hljs-keyword">ERROR</span>: <span class="hljs-built_in">short</span>-circuit local reads <span class="hljs-keyword">is</span> disabled because
  - dfs.domain.socket.path <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> configured.
  - dfs.client.read.shortcircuit <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> enabled.</code></pre> 
<p><img src="https://images2.imgbox.com/63/ba/S2BIHXG7_o.png" alt="这里写图片描述" title=""> <br> 解决方法 <br> 　　 找到对应参数的下的值，查看该路径是否存在，impala用户是否有权限进行读写</p> 
<h3 id="错误2">错误2</h3> 
<p>invalidate metadata 更新元数据出错 <br> 错误代码</p> 
<pre class="prettyprint"><code class=" hljs http"><span class="hljs-attribute">Query</span>: <span class="hljs-string">invalidate metadata</span>
<span class="hljs-attribute">ERROR</span>: <span class="hljs-string">Couldn't open transport for hdname:26000 (connect() failed: Connection refused)</span></code></pre> 
<p>查看日志信息,有如下错误，无法读取datanode上的数据块信息</p> 
<pre class="prettyprint"><code class="language-log hljs avrasm">I0507 <span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">36.218281</span> <span class="hljs-number">21562</span> BlockStorageLocationUtil<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">177</span>] Failed to query block locations on datanode <span class="hljs-number">192.168</span><span class="hljs-number">.73</span><span class="hljs-number">.16</span>:<span class="hljs-number">50020</span>: org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.hadoop</span><span class="hljs-preprocessor">.ipc</span><span class="hljs-preprocessor">.RemoteException</span>(java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.UnsupportedOperationException</span>): Datanode<span class="hljs-preprocessor">#getHdfsBlocksMetadata  is not enabled in datanode config</span>
        at org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.hadoop</span><span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.datanode</span><span class="hljs-preprocessor">.DataNode</span><span class="hljs-preprocessor">.getHdfsBlocksMetadata</span>(DataNode<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">1547</span>)</code></pre> 
<p>解决方法 <br> 注意：这里使用的端口说是26000，事实上在整个配置过程中没有任何的端口设置为26000，同时出现这种错误是在登录终端并且成功连接之后出现，也就是说这跟元数据相关 <br> 解决方法： <br> /etc/default/impala 中的配置项IMPALA_CATALOG_ARGS，需要增加参数 <code>-state_store_host=${IMPALA_STATE_STORE_HOST}</code> <br> 结果如下 <br> <img src="https://images2.imgbox.com/21/4b/4RsF4hxV_o.png" alt="这里写图片描述" title=""> <br> 该参数告诉了catalog去哪个host找元数据，事实上在state-store的配置中也有重新设置state_store_host参数 <br> <img src="https://images2.imgbox.com/3e/92/q4WSLGXK_o.png" alt="这里写图片描述" title=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/56d32ba25fdae01adae984622c99334e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">选择solidedge的10大理由（1）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/71e27a63f65d445addb34f8aa2e2bc2c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Skia深入分析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>