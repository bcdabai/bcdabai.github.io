<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>轮子六：QSerialPort 串口数据 收发 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="轮子六：QSerialPort 串口数据 收发" />
<meta property="og:description" content="// .h #ifndef TIMINGSYSWORKER_H #define TIMINGSYSWORKER_H #include &lt;QObject&gt; #include &lt;QSerialPort&gt; #include &lt;QSerialPortInfo&gt; #include &#34;setting/setting.h&#34; #include&lt;qthread.h&gt; class TimingSysWorker : public QObject { Q_OBJECT public: explicit TimingSysWorker(QObject *parent = nullptr); ~TimingSysWorker(); void setPortName(const QString&amp; strName); void setBaudrate(int nBaudrate); signals: void sig_recv(QByteArray ba); void serialOpenRes(int deviceId,bool);//串口打开结果 public slots: //初始化并打开串口 void slot_initSerial(int deviceId); void slot_readReady(); void slot_sendcmd(QByteArray); private: QSerialPort* m_pQSerialPort; //串口名 QString m_strPortName; //波特率 int m_nBaudrate; bool m_isOpen = false; QByteArray m_baBuff; }; #endif // TIMINGSYSWORKER_H // ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2b6bfad311d8ec1b9bb92b4ba2e60a28/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-25T09:35:40+08:00" />
<meta property="article:modified_time" content="2022-07-25T09:35:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">轮子六：QSerialPort 串口数据 收发</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <pre><code class="language-cpp">// .h
#ifndef TIMINGSYSWORKER_H
#define TIMINGSYSWORKER_H

#include &lt;QObject&gt;
#include &lt;QSerialPort&gt;
#include &lt;QSerialPortInfo&gt;
#include "setting/setting.h"
#include&lt;qthread.h&gt;
class TimingSysWorker : public QObject
{
    Q_OBJECT
public:
    explicit TimingSysWorker(QObject *parent = nullptr);
    ~TimingSysWorker();
    void setPortName(const QString&amp; strName);
    void setBaudrate(int nBaudrate);
signals:
    void sig_recv(QByteArray ba);
    void serialOpenRes(int deviceId,bool);//串口打开结果
public slots:
    //初始化并打开串口
    void slot_initSerial(int deviceId);
    void slot_readReady();
    void slot_sendcmd(QByteArray);

private:
    QSerialPort* m_pQSerialPort;
    //串口名
    QString m_strPortName;
    //波特率
    int m_nBaudrate;
    bool m_isOpen = false;
    QByteArray m_baBuff;
};

#endif // TIMINGSYSWORKER_H



</code></pre> 
<pre><code class="language-cpp">// .cpp
#include "TimingSysWorker.h"
#include &lt;QDebug&gt;

TimingSysWorker::TimingSysWorker(QObject *parent) : QObject(parent)
{
    m_pQSerialPort = nullptr;
}

TimingSysWorker::~TimingSysWorker()
{
    if(m_pQSerialPort)
    {
        if(m_pQSerialPort-&gt;isOpen()){
            m_pQSerialPort-&gt;close();
            delete m_pQSerialPort;
            m_pQSerialPort=nullptr;
        }
    }
}

void TimingSysWorker::setBaudrate(int nBaudrate)
{
    m_nBaudrate = nBaudrate;
}

void TimingSysWorker::setPortName(const QString &amp;strName)
{
    m_strPortName = strName;
}

void TimingSysWorker::slot_initSerial(int deviceId)
{
    if(nullptr==m_pQSerialPort)
    {
        m_pQSerialPort = new QSerialPort;
    }
    bool bExist=false;
    foreach (const QSerialPortInfo&amp;info, QSerialPortInfo::availablePorts())
    {
        if(info.portName()==m_strPortName)
        {
            m_pQSerialPort-&gt;setPortName(info.systemLocation());
            bExist=true;
        }
    }
    if(!bExist)
    {
        qDebug()&lt;&lt;QStringLiteral("串口%1不存在").arg(m_strPortName);
    }
    if(m_pQSerialPort)
    {
        //m_pQSerialPort-&gt;setRequestToSend(true);//设置422串口全双工通信，这个串口默认不是全双工，导致只能收，不能发
        connect(m_pQSerialPort,&amp;QSerialPort::readyRead,this,&amp;TimingSysWorker::slot_readReady);

        //设置波特率
        m_pQSerialPort-&gt;setBaudRate(m_nBaudrate,QSerialPort::AllDirections);
        //设置数据位
        m_pQSerialPort-&gt;setDataBits(QSerialPort::Data8);
        //设置校验位
        m_pQSerialPort-&gt;setParity(QSerialPort::NoParity);
        //设置停止位
        m_pQSerialPort-&gt;setStopBits(QSerialPort::OneStop);
        //流量控制
        m_pQSerialPort-&gt;setFlowControl(QSerialPort::NoFlowControl);
        bool bRet = m_pQSerialPort-&gt;open(QIODevice::ReadWrite);//打开串口并选择读写模式
        if(bRet)
        {
            m_isOpen = true;
            m_pQSerialPort-&gt;setRequestToSend(true);//设置串口全双工通信，这个串口默认不是全双工，导致只能收，不能发。
            //qDebug()&lt;&lt;"Open serial "&lt;&lt;m_strPortName &lt;&lt; "successfully";
        }
        else {
            //qDebug()&lt;&lt;"Open serial "&lt;&lt;m_strPortName &lt;&lt; "failed";
            //serialOpenRes(deviceId,false);//打开失败，则重新绑定
        }
    }
}

void TimingSysWorker::slot_readReady()
{

    //先缓存
    m_baBuff.append(ba);
    //判断缓存中第一个字符是不是$,最后一个字符是不是换行符，如果二者皆成立表示收到了一个完整帧
    if('$' == m_baBuff.at(0) &amp;&amp; '\n' == m_baBuff.at(m_baBuff.size()-1))
   {
        emit sig_timingData(m_baBuff);
        m_baBuff.clear();
   }
}

void TimingSysWorker::slot_sendcmd(QByteArray ba)
{
    m_pQSerialPort-&gt;write(ba);
    m_pQSerialPort-&gt;flush();
}

</code></pre> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/db52b4ee659489ecc0f16d7d9eb8b72c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PLSQL查询结果中文显示乱码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/32d8bc268f259552dc873b056fec8677/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux的ifconfig命令找不到</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>