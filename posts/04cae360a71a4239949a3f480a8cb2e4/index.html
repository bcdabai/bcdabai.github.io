<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>『ORACLE』日志挖掘（11g） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="『ORACLE』日志挖掘（11g）" />
<meta property="og:description" content="1、启动最小补充日志，和无条件主键补充日志，
alter database add supplemental log data;
alter database add supplemental log data (primary key) columns;
2、字典来源：源库日志字典，源库在线数据字典。
（1)源库日志字典：调用dbms_logmnr_d.build存储过程把LogMiner字典提取到源库的重做日志。
begin dbms_logmnr_d.build(options=&gt;dbms_logmnr_d.store_in_redo_logs);
End;
/
下面查询日志日志字典存储位置
Select sequence#,name,dictionary_begin,dictionary_end from v$archived_log where dictionary_begin=&#39;YES&#39; or dictionary_end=&#39;YES&#39;;
（2）源库在线数据字典作为LogMiner字典时，直接在启动日志挖掘时通过start_logmnr过程的options参数指定。
如
begin dbms_logmnr.start_logmnr(options=&gt;dbms_logmnr.dict_from_online_catalog);
end;
/
做破坏，然后使用日志挖掘修复。
select ename,sal from scott.emp where deptno=30;
update scott.emp set sal=sal/2 where deptno=30;
commit;
select ename,sal from scott.emp where deptno=30;
3 注册重做日志。
(1)手动注册。
begin
dbms_logmnr.add_logfile(
logfilename=&gt;’/u01/app/oracle/o1_mf_1_138_3f3303_.arc’,
options=&gt;dbms_logmnr.addfile);
end;
/
反复执行可以增加多个归档日志，如果采用日志字典，则需要注册日志字典所在日志。
（2）自动注册。
使用dbms_logmnr.start_logmnr启动挖掘会话时，使用options参数说明即可，比手动注册方便多了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/04cae360a71a4239949a3f480a8cb2e4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-06-12T20:10:27+08:00" />
<meta property="article:modified_time" content="2017-06-12T20:10:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">『ORACLE』日志挖掘（11g）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <span style="font-size:18px">1、启动最小补充日志，和无条件主键补充日志，<br> alter database add supplemental log data;<br> alter database add supplemental log data (primary key) columns;<br> 2、字典来源：源库日志字典，源库在线数据字典。<br>    （1)源库日志字典：调用dbms_logmnr_d.build存储过程把LogMiner字典提取到源库的重做日志。<br>    begin <br>     dbms_logmnr_d.build(options=&gt;dbms_logmnr_d.store_in_redo_logs);<br>    End;<br> /<br> <br> <br> 下面查询日志日志字典存储位置<br>  Select sequence#,name,dictionary_begin,dictionary_end from v$archived_log where dictionary_begin='YES' or dictionary_end='YES';<br>     （2）源库在线数据字典作为LogMiner字典时，直接在启动日志挖掘时通过start_logmnr过程的options参数指定。<br>       如<br>      begin <br>       dbms_logmnr.start_logmnr(options=&gt;dbms_logmnr.dict_from_online_catalog);<br>      end;<br>  /<br> </span> 
<p><span style="font-size:18px"><br> </span></p> 
<p><span style="font-size:18px">做破坏，然后使用日志挖掘修复。</span></p> 
<p><span style="font-size:18px">select ename,sal from scott.emp where deptno=30;<br> update scott.emp set  sal=sal/2 where deptno=30;<br> commit;<br> select ename,sal from scott.emp where deptno=30;<br> </span></p> 
<p><span style="font-size:18px"><br> </span></p> 
<p><span style="font-size:18px"><br> </span></p> 
<span style="font-size:18px">3 注册重做日志。<br>   (1)手动注册。<br>     begin<br>      dbms_logmnr.add_logfile(<br>      logfilename=&gt;’/u01/app/oracle/o1_mf_1_138_3f3303_.arc’,<br>      options=&gt;dbms_logmnr.addfile);<br>     end;<br>  /<br> <br> <br> 反复执行可以增加多个归档日志，如果采用日志字典，则需要注册日志字典所在日志。<br>   （2）自动注册。<br>     使用dbms_logmnr.start_logmnr启动挖掘会话时，使用options参数说明即可，比手动注册方便多了。<br>    如<br>   a.以时间戳计算时间窗口<br> begin<br>   dbms_logmnr.start_logmnr(<br>    starttime=&gt;to_date(’20170609 09:00:00’,’yyyymmdd hh24:mi:ss’),<br>    endtime=&gt;to_date(’20170609 09:10:00’,’yyyymmdd hh24:mi:ss’),<br>    options=&gt; dbms_logmnr.dict_from_online_catalog+dbms_logmnr.continuous_mine);<br> end;<br> /<br>  b.利用以SCN计算时间窗口  <br> begin<br>   dbms_logmnr.start_logmnr(<br>    startscn=&gt;。。。,<br>    endscn=&gt;。。。,<br>    options=&gt; dbms_logmnr.dict_from_online_catalog+dbms_logmnr.continuous_mine);<br> end;<br> /<br>  自动注册的限制：挖掘库与源库必须是同一个库。必须指定时间窗口，控制文件内必须具有所需日志记录—可以搜索v$archived_log和v$logfile显示的范围。<br> <br> <br> 4 启动挖掘：此时需要调用dbms_logmnr.start_logmnr，它需要预先知道两件事：如何提供LogMiner字典（源库在线数据字典or日志字典）和是否注册了日志（手动自动）。<br>   示例1:源库在线数据字典，之前已经手工注册了日志。<br>  begin<br>      dbms_logmnr.start_logmnr(options=&gt;dbms_logmnr.dict_from_online_catalog);<br>  end;<br> /<br> <br> <br>  示例2 源库在线数据字典  ，日志自动注册。<br> begin<br>   dbms_logmnr.start_logmnr(<br>    startscn=&gt;。。。,<br>    endscn=&gt;。。。,<br>    options=&gt; dbms_logmnr.dict_from_online_catalog+dbms_logmnr.continuous_mine);<br> end;<br> /<br> <br> <br> begin<br>   dbms_logmnr.start_logmnr(<br>    starttime=&gt;to_date(’20170609 09:00:00’,’yyyymmdd hh24:mi:ss’),<br>    endtime=&gt;to_date(’20170609 09:10:00’,’yyyymmdd hh24:mi:ss’),<br>    options=&gt; dbms_logmnr.dict_from_online_catalog+dbms_logmnr.continuous_mine);<br> end;<br> /<br> <br> <br> 示例3 日志字典作为LogMiner字典启动挖掘会话，之前已经注册了包含日志字典的日志和需要挖掘的日志。<br> <br> <br> begin<br>   dbms_logmnr.start_logmnr(options=&gt;dbms_logmnr.dict_from_redo_logs);<br> end;<br> /<br> <br> <br> 示例4 日志字典作为LogMiner字典启动挖掘会话 自动注册。<br> begin<br>   dbms_logmnr.start_logmnr(<br>    startscn=&gt;2121813,<br>    endscn=&gt;2126140,<br>    options=&gt; dbms_logmnr.dict_from_redo_logs+dbms_logmnr.continuous_mine);<br> end;<br> /<br> <br> <br> <br> <br> 完整示例：<br> #### manually register redo logfile,maybe need scn related to archived log;<br>  select name,sequence#,first_change#,last_change# from v$archived_log;<br> SQL&gt; select group#,first_change#,next_change# ,status from v$log ;<br> <br> <br>     GROUP# FIRST_CHANGE# NEXT_CHANGE# STATUS<br> ---------- ------------- ------------ ----------------<br> <span style="white-space:pre"></span> 1<span style="white-space:pre"> </span> 2245104      2261729 INACTIVE<br> <span style="white-space:pre"></span> 2<span style="white-space:pre"> </span> 2261729      2272294 INACTIVE<br> <span style="white-space:pre"></span> 3<span style="white-space:pre"> </span> 2272294   2.8147E+14 CURRENT<br> <br> <br> <br> <br> ###find redo record in controlfile through v$archived_log,v$logfile;<br> <br> <br> begin<br>   dbms_logmnr.start_logmnr(<br>    startscn=&gt;。。。,<br>    endscn=&gt;。。。,<br>    options=&gt;dbms_logmnr.dict_from_online_catalog+dbms_logmnr.continuous_mine);<br> end;<br> /<br> </span> 
<p><span style="font-size:18px"><br> </span></p> 
<p><span style="font-size:18px"><br> </span></p> 
<span style="font-size:18px">### miner redolog<br> select '('||rownum||')' as sql#,sql_redo from v$logmnr_contents where seg_owner='SCOTT' and seg_name='EMP' and  sql_redo like 'update%';<br> <br> <br> ###find redo_sql and undo_sql <br> begin<br> for rec in<br> (select sql_undo from v$logmnr_contents where seg_owner='SCOTT' and seg_name='EMP' and  sql_redo like 'update%')<br> loop <br> if rec.sql_undo is not null then<br> execute immediate substr(rec.sql_undo,1,length(rec.sql_undo)-1);<br> end if;<br> end loop;<br> commit;<br> end;<br> /</span>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4852a733258b8c4e4f61e0daaecac925/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">移动硬盘提示磁盘结构损坏且无法读取怎么办</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5dba352e709657c9b86928066081e864/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">漫步数理统计三十——依概率收敛</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>