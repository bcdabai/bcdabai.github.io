<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>利用libwebsockets写ws、wss服务端和客户端 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="利用libwebsockets写ws、wss服务端和客户端" />
<meta property="og:description" content="利用libwebsockets写ws、wss服务端和客户端 文章目录 利用libwebsockets写ws、wss服务端和客户端服务端：客户端官网例子坑点 服务端： server.c
#include &#34;libwebsockets.h&#34; #include &lt;signal.h&gt; #include &lt;string.h&gt; static volatile int exit_sig = 0; #define MAX_PAYLOAD_SIZE 10 * 1024 void sighdl( int sig ) { lwsl_notice( &#34;%d traped&#34;, sig ); exit_sig = 1; } /** * 会话上下文对象，结构根据需要自定义 */ struct session_data { int msg_count; unsigned char buf[LWS_PRE &#43; MAX_PAYLOAD_SIZE]; int len; bool bin; bool fin; }; static int protocol_my_callback( struct lws *wsi, enum lws_callback_reasons reason, void *user, void *in, size_t len ) { struct session_data *data = (struct session_data *) user; switch ( reason ) { case LWS_CALLBACK_ESTABLISHED: // 当服务器和客户端完成握手后 printf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3171a580b73d58e509b0e4b4ac7aec4b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-01-31T23:28:52+08:00" />
<meta property="article:modified_time" content="2019-01-31T23:28:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">利用libwebsockets写ws、wss服务端和客户端</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="libwebsocketswswss_0"></a>利用libwebsockets写ws、wss服务端和客户端</h2> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#libwebsocketswswss_0" rel="nofollow">利用libwebsockets写ws、wss服务端和客户端</a></li><li><ul><li><a href="#_4" rel="nofollow">服务端：</a></li><li><a href="#_121" rel="nofollow">客户端</a></li><li><a href="#_262" rel="nofollow">官网例子</a></li><li><a href="#_736" rel="nofollow">坑点</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_4"></a>服务端：</h3> 
<p>server.c</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"libwebsockets.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> exit_sig <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_PAYLOAD_SIZE  10 * 1024</span>

<span class="token keyword">void</span> <span class="token function">sighdl</span><span class="token punctuation">(</span> <span class="token keyword">int</span> sig <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">lwsl_notice</span><span class="token punctuation">(</span> <span class="token string">"%d traped"</span><span class="token punctuation">,</span> sig <span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit_sig <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 会话上下文对象，结构根据需要自定义
 */</span>
<span class="token keyword">struct</span> session_data <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> msg_count<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span>LWS_PRE <span class="token operator">+</span> MAX_PAYLOAD_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    bool bin<span class="token punctuation">;</span>
    bool fin<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">protocol_my_callback</span><span class="token punctuation">(</span> <span class="token keyword">struct</span> lws <span class="token operator">*</span>wsi<span class="token punctuation">,</span> <span class="token keyword">enum</span> lws_callback_reasons reason<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>user<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> size_t len <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> session_data <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> session_data <span class="token operator">*</span><span class="token punctuation">)</span> user<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> reason <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> LWS_CALLBACK_ESTABLISHED<span class="token punctuation">:</span>       <span class="token comment">// 当服务器和客户端完成握手后</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Client connect!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LWS_CALLBACK_RECEIVE<span class="token punctuation">:</span>           <span class="token comment">// 当接收到客户端发来的帧以后</span>
            <span class="token comment">// 判断是否最后一帧</span>
            data<span class="token operator">-&gt;</span>fin <span class="token operator">=</span> <span class="token function">lws_is_final_fragment</span><span class="token punctuation">(</span> wsi <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 判断是否二进制消息</span>
            data<span class="token operator">-&gt;</span>bin <span class="token operator">=</span> <span class="token function">lws_frame_is_binary</span><span class="token punctuation">(</span> wsi <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 对服务器的接收端进行流量控制，如果来不及处理，可以控制之</span>
            <span class="token comment">// 下面的调用禁止在此连接上接收数据</span>
            <span class="token function">lws_rx_flow_control</span><span class="token punctuation">(</span> wsi<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token comment">// 业务处理部分，为了实现Echo服务器，把客户端数据保存起来</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span> LWS_PRE <span class="token punctuation">]</span><span class="token punctuation">,</span> in<span class="token punctuation">,</span> len <span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token operator">-&gt;</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recvied message:%s\n"</span><span class="token punctuation">,</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token comment">// 需要给客户端应答时，触发一次写回调</span>
            <span class="token function">lws_callback_on_writable</span><span class="token punctuation">(</span> wsi <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LWS_CALLBACK_SERVER_WRITEABLE<span class="token punctuation">:</span>   <span class="token comment">// 当此连接可写时</span>
            <span class="token function">lws_write</span><span class="token punctuation">(</span> wsi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span> LWS_PRE <span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token operator">-&gt;</span>len<span class="token punctuation">,</span> LWS_WRITE_TEXT <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 下面的调用允许在此连接上接收数据</span>
            <span class="token function">lws_rx_flow_control</span><span class="token punctuation">(</span> wsi<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 回调函数最终要返回0，否则无法创建服务器</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 支持的WebSocket子协议数组
 * 子协议即JavaScript客户端WebSocket(url, protocols)第2参数数组的元素
 * 你需要为每种协议提供回调函数
 */</span>
<span class="token keyword">struct</span> lws_protocols protocols<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//协议名称，协议回调，接收缓冲区大小</span>
        <span class="token string">"ws"</span><span class="token punctuation">,</span> protocol_my_callback<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> <span class="token keyword">struct</span> session_data <span class="token punctuation">)</span><span class="token punctuation">,</span> MAX_PAYLOAD_SIZE<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>   <span class="token number">0</span> <span class="token comment">// 最后一个元素固定为此格式</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 信号处理函数</span>
    <span class="token function">signal</span><span class="token punctuation">(</span> SIGTERM<span class="token punctuation">,</span> sighdl <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">struct</span> lws_context_creation_info ctx_info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>iface <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 在所有网络接口上监听</span>
    ctx_info<span class="token punctuation">.</span>protocols <span class="token operator">=</span> protocols<span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>gid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>options <span class="token operator">=</span> LWS_SERVER_OPTION_VALIDATE_UTF8<span class="token punctuation">;</span>

    ctx_info<span class="token punctuation">.</span>ssl_ca_filepath <span class="token operator">=</span> <span class="token string">"../ca/ca-cert.pem"</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>ssl_cert_filepath <span class="token operator">=</span> <span class="token string">"./server-cert.pem"</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>ssl_private_key_filepath <span class="token operator">=</span> <span class="token string">"./server-key.pem"</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>options <span class="token operator">|</span><span class="token operator">=</span> LWS_SERVER_OPTION_DO_SSL_GLOBAL_INIT<span class="token punctuation">;</span>
    <span class="token comment">//ctx_info.options |= LWS_SERVER_OPTION_REQUIRE_VALID_OPENSSL_CLIENT_CERT;</span>
    
    <span class="token keyword">struct</span> lws_context <span class="token operator">*</span>context <span class="token operator">=</span> <span class="token function">lws_create_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>exit_sig <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">lws_service</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">lws_context_destroy</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译脚本，compile.sh</p> 
<pre><code class="prism language-shell"><span class="token comment">#########################################################################</span>
<span class="token comment"># File Name: compile.sh</span>
<span class="token comment"># Author: loon</span>
<span class="token comment"># mail: 2453419889@qq.com</span>
<span class="token comment"># Created Time: 2018年09月07日 星期五 10时08分52秒</span>
<span class="token comment">#########################################################################</span>
<span class="token comment">#!/bin/bash</span>

libdir<span class="token operator">=</span>libwebsockets

g++ -g -o server server.c -I<span class="token variable">$libdir</span>/include -L<span class="token variable">$libdir</span>/lib -lwebsockets
</code></pre> 
<h3><a id="_121"></a>客户端</h3> 
<p>client.c</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"libwebsockets.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
 
<span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> exit_sig <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_PAYLOAD_SIZE  10 * 1024</span>
 
<span class="token keyword">void</span> <span class="token function">sighdl</span><span class="token punctuation">(</span> <span class="token keyword">int</span> sig <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">lwsl_notice</span><span class="token punctuation">(</span> <span class="token string">"%d traped"</span><span class="token punctuation">,</span> sig <span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit_sig <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 会话上下文对象，结构根据需要自定义
 */</span>
<span class="token keyword">struct</span> session_data <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> msg_count<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span>LWS_PRE <span class="token operator">+</span> MAX_PAYLOAD_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">/**
 * 某个协议下的连接发生事件时，执行的回调函数
 *
 * wsi：指向WebSocket实例的指针
 * reason：导致回调的事件
 * user 库为每个WebSocket会话分配的内存空间
 * in 某些事件使用此参数，作为传入数据的指针
 * len 某些事件使用此参数，说明传入数据的长度
 */</span>
<span class="token keyword">int</span> <span class="token function">callback</span><span class="token punctuation">(</span> <span class="token keyword">struct</span> lws <span class="token operator">*</span>wsi<span class="token punctuation">,</span> <span class="token keyword">enum</span> lws_callback_reasons reason<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>user<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> size_t len <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> session_data <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> session_data <span class="token operator">*</span><span class="token punctuation">)</span> user<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> reason <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> LWS_CALLBACK_CLIENT_ESTABLISHED<span class="token punctuation">:</span>   <span class="token comment">// 连接到服务器后的回调</span>
            <span class="token function">lwsl_notice</span><span class="token punctuation">(</span> <span class="token string">"Connected to server ok!\n"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
 
        <span class="token keyword">case</span> LWS_CALLBACK_CLIENT_RECEIVE<span class="token punctuation">:</span>       <span class="token comment">// 接收到服务器数据后的回调，数据为in，其长度为len</span>
            <span class="token function">lwsl_notice</span><span class="token punctuation">(</span> <span class="token string">"Rx: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> in <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LWS_CALLBACK_CLIENT_WRITEABLE<span class="token punctuation">:</span>     <span class="token comment">// 当此客户端可以发送数据时的回调</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> data<span class="token operator">-&gt;</span>msg_count <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 前面LWS_PRE个字节必须留给LWS</span>
                <span class="token function">memset</span><span class="token punctuation">(</span> data<span class="token operator">-&gt;</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> data<span class="token operator">-&gt;</span>buf <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">char</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span> LWS_PRE <span class="token punctuation">]</span><span class="token punctuation">;</span>
                data<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span> msg<span class="token punctuation">,</span> <span class="token string">"你好 %d"</span><span class="token punctuation">,</span> <span class="token operator">++</span>data<span class="token operator">-&gt;</span>msg_count <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">lwsl_notice</span><span class="token punctuation">(</span> <span class="token string">"Tx: %s\n"</span><span class="token punctuation">,</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 通过WebSocket发送文本消息</span>
                <span class="token function">lws_write</span><span class="token punctuation">(</span> wsi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span> LWS_PRE <span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token operator">-&gt;</span>len<span class="token punctuation">,</span> LWS_WRITE_TEXT <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/**
 * 支持的WebSocket子协议数组
 * 子协议即JavaScript客户端WebSocket(url, protocols)第2参数数组的元素
 * 你需要为每种协议提供回调函数
 */</span>
<span class="token keyword">struct</span> lws_protocols protocols<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//协议名称，协议回调，接收缓冲区大小</span>
        <span class="token string">"ws"</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> <span class="token keyword">struct</span> session_data <span class="token punctuation">)</span><span class="token punctuation">,</span> MAX_PAYLOAD_SIZE<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>   <span class="token number">0</span> <span class="token comment">// 最后一个元素固定为此格式</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 信号处理函数</span>
    <span class="token function">signal</span><span class="token punctuation">(</span> SIGTERM<span class="token punctuation">,</span> sighdl <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 用于创建vhost或者context的参数</span>
    <span class="token keyword">struct</span> lws_context_creation_info ctx_info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>port <span class="token operator">=</span> CONTEXT_PORT_NO_LISTEN<span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>iface <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>protocols <span class="token operator">=</span> protocols<span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>gid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">//ssl支持（指定CA证书、客户端证书及私钥路径，打开ssl支持）</span>
    ctx_info<span class="token punctuation">.</span>ssl_ca_filepath <span class="token operator">=</span> <span class="token string">"../ca/ca-cert.pem"</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>ssl_cert_filepath <span class="token operator">=</span> <span class="token string">"./client-cert.pem"</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>ssl_private_key_filepath <span class="token operator">=</span> <span class="token string">"./client-key.pem"</span><span class="token punctuation">;</span>
    ctx_info<span class="token punctuation">.</span>options <span class="token operator">|</span><span class="token operator">=</span> LWS_SERVER_OPTION_DO_SSL_GLOBAL_INIT<span class="token punctuation">;</span>
 
    <span class="token comment">// 创建一个WebSocket处理器</span>
    <span class="token keyword">struct</span> lws_context <span class="token operator">*</span>context <span class="token operator">=</span> <span class="token function">lws_create_context</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>ctx_info <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">char</span> address<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> addr_port<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>addr_port<span class="token punctuation">,</span> <span class="token string">"%s:%u"</span><span class="token punctuation">,</span> address<span class="token punctuation">,</span> port <span class="token operator">&amp;</span> <span class="token number">65535</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 客户端连接参数</span>
    <span class="token keyword">struct</span> lws_client_connect_info conn_info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    conn_info<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    conn_info<span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    conn_info<span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    conn_info<span class="token punctuation">.</span>ssl_connection <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    conn_info<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">"./"</span><span class="token punctuation">;</span>
    conn_info<span class="token punctuation">.</span>host <span class="token operator">=</span> addr_port<span class="token punctuation">;</span>
    conn_info<span class="token punctuation">.</span>origin <span class="token operator">=</span> addr_port<span class="token punctuation">;</span>
    conn_info<span class="token punctuation">.</span>protocol <span class="token operator">=</span> protocols<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
 
    <span class="token comment">// 下面的调用触发LWS_CALLBACK_PROTOCOL_INIT事件</span>
    <span class="token comment">// 创建一个客户端连接</span>
    <span class="token keyword">struct</span> lws <span class="token operator">*</span>wsi <span class="token operator">=</span> <span class="token function">lws_client_connect_via_info</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>conn_info <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>exit_sig <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 执行一次事件循环（Poll），最长等待1000毫秒</span>
        <span class="token function">lws_service</span><span class="token punctuation">(</span> context<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 下面的调用的意义是：当连接可以接受新数据时，触发一次WRITEABLE事件回调
         * 当连接正在后台发送数据时，它不能接受新的数据写入请求，所有WRITEABLE事件回调不会执行
         */</span>
        <span class="token function">lws_callback_on_writable</span><span class="token punctuation">(</span> wsi <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 销毁上下文对象</span>
    <span class="token function">lws_context_destroy</span><span class="token punctuation">(</span> context <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译脚本：</p> 
<pre><code class="prism language-shell"><span class="token comment">#########################################################################</span>
<span class="token comment"># File Name: compile.sh</span>
<span class="token comment"># Author: loon</span>
<span class="token comment"># mail: 2453419889@qq.com</span>
<span class="token comment"># Created Time: 2018年09月07日 星期五 10时22分58秒</span>
<span class="token comment">#########################################################################</span>
<span class="token comment">#!/bin/bash</span>

libdir<span class="token operator">=</span>libwebsockets
 
g++ -g -o client client.c -I<span class="token variable">$libdir</span>/include -L<span class="token variable">$libdir</span>/build/lib -lwebsockets
</code></pre> 
<h3><a id="_262"></a>官网例子</h3> 
<p>其实下载了官网源码后minimal-examples下面有很多的例子，里面已经写好了cmake的文件，看一下对应的README后直接可以在对应位置编译，我这里复制minimal-ws-client和一个minimal-ws-server的例子，我基本只改了服务地址和端口，然后增加了打印（还有tx和rx客户端分别代表发送和接收，都可以看一下）：<br> 客户端：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * lws-minimal-ws-client-tx
 *
 * Written in 2010-2019 by Andy Green &lt;andy@warmcat.com&gt;
 *
 * This file is made available under the Creative Commons CC0 1.0
 * Universal Public Domain Dedication.
 *
 * This demonstrates a ws "publisher" to go with the minimal-ws-broker
 * example.
 *
 * Two threads are spawned that produce messages to be sent to the broker,
 * via a local ringbuffer.  Locking is provided to make ringbuffer access
 * threadsafe.
 *
 * When a nailed-up client connection to the broker is established, the
 * ringbuffer is sent to the broker, which distributes the events to all
 * connected clients.
 */</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libwebsockets.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">static</span> <span class="token keyword">int</span> interrupted<span class="token punctuation">;</span>

<span class="token comment">/* one of these created for each message */</span>

<span class="token keyword">struct</span> msg <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span> <span class="token operator">*</span>payload<span class="token punctuation">;</span> <span class="token comment">/* is malloc'd */</span>
	size_t len<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> per_vhost_data__minimal <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> lws_context <span class="token operator">*</span>context<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> lws_vhost <span class="token operator">*</span>vhost<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> lws_protocols <span class="token operator">*</span>protocol<span class="token punctuation">;</span>
	pthread_t pthread_spam<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	pthread_mutex_t lock_ring<span class="token punctuation">;</span> <span class="token comment">/* serialize access to the ring buffer */</span>
	<span class="token keyword">struct</span> lws_ring <span class="token operator">*</span>ring<span class="token punctuation">;</span> <span class="token comment">/* ringbuffer holding unsent messages */</span>
	uint32_t tail<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> lws_client_connect_info i<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> lws <span class="token operator">*</span>client_wsi<span class="token punctuation">;</span>

	<span class="token keyword">int</span> counter<span class="token punctuation">;</span>
	<span class="token keyword">char</span> finished<span class="token punctuation">;</span>
	<span class="token keyword">char</span> established<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> defined(WIN32)</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">Sleep</span><span class="token punctuation">(</span>l <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">__minimal_destroy_message</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>_msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> msg <span class="token operator">*</span>msg <span class="token operator">=</span> _msg<span class="token punctuation">;</span>

	<span class="token function">free</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
	msg<span class="token operator">-&gt;</span>payload <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	msg<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">thread_spam</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> per_vhost_data__minimal <span class="token operator">*</span>vhd <span class="token operator">=</span>
			<span class="token punctuation">(</span><span class="token keyword">struct</span> per_vhost_data__minimal <span class="token operator">*</span><span class="token punctuation">)</span>d<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> msg amsg<span class="token punctuation">;</span>
	<span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">,</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">;</span>

	<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* don't generate output if client not connected */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vhd<span class="token operator">-&gt;</span>established<span class="token punctuation">)</span>
			<span class="token keyword">goto</span> wait<span class="token punctuation">;</span>

		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>lock_ring<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* --------- ring lock { */</span>

		<span class="token comment">/* only create if space in ringbuffer */</span>
		n <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">lws_ring_get_count_free_elements</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>ring<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"dropping!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> wait_unlock<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		amsg<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>LWS_PRE <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>amsg<span class="token punctuation">.</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"OOM: dropping\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> wait_unlock<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		n <span class="token operator">=</span> <span class="token function">lws_snprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>amsg<span class="token punctuation">.</span>payload <span class="token operator">+</span> LWS_PRE<span class="token punctuation">,</span> len<span class="token punctuation">,</span>
			         <span class="token string">"tid: %p, msg: %d"</span><span class="token punctuation">,</span>
			         <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		amsg<span class="token punctuation">.</span>len <span class="token operator">=</span> n<span class="token punctuation">;</span>
		n <span class="token operator">=</span> <span class="token function">lws_ring_insert</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>ring<span class="token punctuation">,</span> <span class="token operator">&amp;</span>amsg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">__minimal_destroy_message</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"dropping!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span>
			<span class="token comment">/*
			 * This will cause a LWS_CALLBACK_EVENT_WAIT_CANCELLED
			 * in the lws service thread context.
			 */</span>
			<span class="token function">lws_cancel_service</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

wait_unlock<span class="token punctuation">:</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>lock_ring<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* } ring lock ------- */</span>

wait<span class="token punctuation">:</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>vhd<span class="token operator">-&gt;</span>finished<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lwsl_notice</span><span class="token punctuation">(</span><span class="token string">"thread_spam %p exiting\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">connect_client</span><span class="token punctuation">(</span><span class="token keyword">struct</span> per_vhost_data__minimal <span class="token operator">*</span>vhd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>context <span class="token operator">=</span> vhd<span class="token operator">-&gt;</span>context<span class="token punctuation">;</span>
	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token number">7681</span><span class="token punctuation">;</span>
	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token string">"localhost"</span><span class="token punctuation">;</span>
	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">"/publisher"</span><span class="token punctuation">;</span>
	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>host <span class="token operator">=</span> vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>address<span class="token punctuation">;</span>
	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>origin <span class="token operator">=</span> vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>address<span class="token punctuation">;</span>
	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>ssl_connection <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>protocol <span class="token operator">=</span> <span class="token string">"lws-minimal-broker"</span><span class="token punctuation">;</span>
	vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">.</span>pwsi <span class="token operator">=</span> <span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>client_wsi<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">lws_client_connect_via_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">callback_minimal_broker</span><span class="token punctuation">(</span><span class="token keyword">struct</span> lws <span class="token operator">*</span>wsi<span class="token punctuation">,</span> <span class="token keyword">enum</span> lws_callback_reasons reason<span class="token punctuation">,</span>
			<span class="token keyword">void</span> <span class="token operator">*</span>user<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> per_vhost_data__minimal <span class="token operator">*</span>vhd <span class="token operator">=</span>
			<span class="token punctuation">(</span><span class="token keyword">struct</span> per_vhost_data__minimal <span class="token operator">*</span><span class="token punctuation">)</span>
			<span class="token function">lws_protocol_vh_priv_get</span><span class="token punctuation">(</span><span class="token function">lws_get_vhost</span><span class="token punctuation">(</span>wsi<span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token function">lws_get_protocol</span><span class="token punctuation">(</span>wsi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> msg <span class="token operator">*</span>pmsg<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>retval<span class="token punctuation">;</span>
	<span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">,</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/* --- protocol lifecycle callbacks --- */</span>

	<span class="token keyword">case</span> LWS_CALLBACK_PROTOCOL_INIT<span class="token punctuation">:</span>
		vhd <span class="token operator">=</span> <span class="token function">lws_protocol_vh_priv_zalloc</span><span class="token punctuation">(</span><span class="token function">lws_get_vhost</span><span class="token punctuation">(</span>wsi<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token function">lws_get_protocol</span><span class="token punctuation">(</span>wsi<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> per_vhost_data__minimal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		vhd<span class="token operator">-&gt;</span>context <span class="token operator">=</span> <span class="token function">lws_get_context</span><span class="token punctuation">(</span>wsi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		vhd<span class="token operator">-&gt;</span>protocol <span class="token operator">=</span> <span class="token function">lws_get_protocol</span><span class="token punctuation">(</span>wsi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		vhd<span class="token operator">-&gt;</span>vhost <span class="token operator">=</span> <span class="token function">lws_get_vhost</span><span class="token punctuation">(</span>wsi<span class="token punctuation">)</span><span class="token punctuation">;</span>

		vhd<span class="token operator">-&gt;</span>ring <span class="token operator">=</span> <span class="token function">lws_ring_create</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>
					    __minimal_destroy_message<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vhd<span class="token operator">-&gt;</span>ring<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

		<span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>lock_ring<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* start the content-creating threads */</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">LWS_ARRAY_SIZE</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>pthread_spam<span class="token punctuation">)</span><span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>pthread_spam<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
					   thread_spam<span class="token punctuation">,</span> vhd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">lwsl_err</span><span class="token punctuation">(</span><span class="token string">"thread creation failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> init_fail<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect_client</span><span class="token punctuation">(</span>vhd<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">lws_timed_callback_vh_protocol</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>vhost<span class="token punctuation">,</span>
					vhd<span class="token operator">-&gt;</span>protocol<span class="token punctuation">,</span> LWS_CALLBACK_USER<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> LWS_CALLBACK_PROTOCOL_DESTROY<span class="token punctuation">:</span>
init_fail<span class="token punctuation">:</span>
		vhd<span class="token operator">-&gt;</span>finished <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">LWS_ARRAY_SIZE</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>pthread_spam<span class="token punctuation">)</span><span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>pthread_spam<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token function">pthread_join</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>pthread_spam<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>ring<span class="token punctuation">)</span>
			<span class="token function">lws_ring_destroy</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>ring<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>lock_ring<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> r<span class="token punctuation">;</span>

	<span class="token keyword">case</span> LWS_CALLBACK_CLIENT_CONNECTION_ERROR<span class="token punctuation">:</span>
		<span class="token function">lwsl_err</span><span class="token punctuation">(</span><span class="token string">"CLIENT_CONNECTION_ERROR: %s\n"</span><span class="token punctuation">,</span>
			 in <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>in <span class="token punctuation">:</span> <span class="token string">"(null)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		vhd<span class="token operator">-&gt;</span>client_wsi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token function">lws_timed_callback_vh_protocol</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>vhost<span class="token punctuation">,</span>
				vhd<span class="token operator">-&gt;</span>protocol<span class="token punctuation">,</span> LWS_CALLBACK_USER<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token comment">/* --- client callbacks --- */</span>

	<span class="token keyword">case</span> LWS_CALLBACK_CLIENT_ESTABLISHED<span class="token punctuation">:</span>
		<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"%s: established\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		vhd<span class="token operator">-&gt;</span>established <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> LWS_CALLBACK_CLIENT_WRITEABLE<span class="token punctuation">:</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>lock_ring<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* --------- ring lock { */</span>
		pmsg <span class="token operator">=</span> <span class="token function">lws_ring_get_element</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>ring<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pmsg<span class="token punctuation">)</span>
			<span class="token keyword">goto</span> skip<span class="token punctuation">;</span>

		<span class="token comment">/* notice we allowed for LWS_PRE in the payload already */</span>
		m <span class="token operator">=</span> <span class="token function">lws_write</span><span class="token punctuation">(</span>wsi<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pmsg<span class="token operator">-&gt;</span>payload<span class="token punctuation">)</span> <span class="token operator">+</span> LWS_PRE<span class="token punctuation">,</span>
			      pmsg<span class="token operator">-&gt;</span>len<span class="token punctuation">,</span> LWS_WRITE_TEXT<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pmsg<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>lock_ring<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* } ring lock */</span>
			<span class="token function">lwsl_err</span><span class="token punctuation">(</span><span class="token string">"ERROR %d writing to ws socket\n"</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">lws_ring_consume_single_tail</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>ring<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>tail<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* more to do for us? */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lws_ring_get_element</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>ring<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">/* come back as soon as we can write more */</span>
			<span class="token function">lws_callback_on_writable</span><span class="token punctuation">(</span>wsi<span class="token punctuation">)</span><span class="token punctuation">;</span>

skip<span class="token punctuation">:</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vhd<span class="token operator">-&gt;</span>lock_ring<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* } ring lock ------- */</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> LWS_CALLBACK_CLIENT_CLOSED<span class="token punctuation">:</span>
		vhd<span class="token operator">-&gt;</span>client_wsi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		vhd<span class="token operator">-&gt;</span>established <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">lws_timed_callback_vh_protocol</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>vhost<span class="token punctuation">,</span> vhd<span class="token operator">-&gt;</span>protocol<span class="token punctuation">,</span>
					       LWS_CALLBACK_USER<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> LWS_CALLBACK_EVENT_WAIT_CANCELLED<span class="token punctuation">:</span>
		<span class="token comment">/*
		 * When the "spam" threads add a message to the ringbuffer,
		 * they create this event in the lws service thread context
		 * using lws_cancel_service().
		 *
		 * We respond by scheduling a writable callback for the
		 * connected client, if any.
		 */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>vhd <span class="token operator">&amp;&amp;</span> vhd<span class="token operator">-&gt;</span>client_wsi <span class="token operator">&amp;&amp;</span> vhd<span class="token operator">-&gt;</span>established<span class="token punctuation">)</span>
			<span class="token function">lws_callback_on_writable</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>client_wsi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token comment">/* rate-limited client connect retries */</span>

	<span class="token keyword">case</span> LWS_CALLBACK_USER<span class="token punctuation">:</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"用户回调...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">lwsl_notice</span><span class="token punctuation">(</span><span class="token string">"%s: LWS_CALLBACK_USER\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect_client</span><span class="token punctuation">(</span>vhd<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">lws_timed_callback_vh_protocol</span><span class="token punctuation">(</span>vhd<span class="token operator">-&gt;</span>vhost<span class="token punctuation">,</span>
						vhd<span class="token operator">-&gt;</span>protocol<span class="token punctuation">,</span>
						LWS_CALLBACK_USER<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token function">lws_callback_http_dummy</span><span class="token punctuation">(</span>wsi<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> user<span class="token punctuation">,</span> in<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> lws_protocols protocols<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token string">"lws-minimal-broker"</span><span class="token punctuation">,</span>
		callback_minimal_broker<span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	interrupted <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> lws_context_creation_info info<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> lws_context <span class="token operator">*</span>context<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	<span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> logs <span class="token operator">=</span> LLL_USER <span class="token operator">|</span> LLL_ERR <span class="token operator">|</span> LLL_WARN <span class="token operator">|</span> LLL_NOTICE
			<span class="token comment">/* for LLL_ verbosity above NOTICE to be built into lws,
			 * lws must have been configured and built with
			 * -DCMAKE_BUILD_TYPE=DEBUG instead of =RELEASE */</span>
			<span class="token comment">/* | LLL_INFO */</span> <span class="token comment">/* | LLL_PARSER */</span> <span class="token comment">/* | LLL_HEADER */</span>
			<span class="token comment">/* | LLL_EXT */</span> <span class="token comment">/* | LLL_CLIENT */</span> <span class="token comment">/* | LLL_LATENCY */</span>
			<span class="token comment">/* | LLL_DEBUG */</span><span class="token punctuation">;</span>

	<span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> sigint_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">lws_cmdline_option</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"-d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		logs <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lws_set_log_level</span><span class="token punctuation">(</span>logs<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"LWS minimal ws client tx\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"  Run minimal-ws-broker and browse to that\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* otherwise uninitialized garbage */</span>
	info<span class="token punctuation">.</span>port <span class="token operator">=</span> CONTEXT_PORT_NO_LISTEN<span class="token punctuation">;</span> <span class="token comment">/* we do not run any server */</span>
	info<span class="token punctuation">.</span>protocols <span class="token operator">=</span> protocols<span class="token punctuation">;</span>
	<span class="token comment">/*
	 * since we know this lws context is only ever going to be used with
	 * one client wsis / fds / sockets at a time, let lws know it doesn't
	 * have to use the default allocations for fd tables up to ulimit -n.
	 * It will just allocate for 1 internal and 1 (+ 1 http2 nwsi) that we
	 * will use.
	 */</span>
	info<span class="token punctuation">.</span>fd_limit_per_thread <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

	context <span class="token operator">=</span> <span class="token function">lws_create_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">lwsl_err</span><span class="token punctuation">(</span><span class="token string">"lws init failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>interrupted<span class="token punctuation">)</span>
		n <span class="token operator">=</span> <span class="token function">lws_service</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lws_context_destroy</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"Completed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>服务端：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * lws-minimal-ws-server
 *
 * Written in 2010-2019 by Andy Green &lt;andy@warmcat.com&gt;
 *
 * This file is made available under the Creative Commons CC0 1.0
 * Universal Public Domain Dedication.
 *
 * This demonstrates the most minimal http server you can make with lws,
 * with an added websocket chat server.
 *
 * To keep it simple, it serves stuff in the subdirectory "./mount-origin" of
 * the directory it was started in.
 * You can change that by changing mount.origin.
 */</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libwebsockets.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> LWS_PLUGIN_STATIC</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"protocol_lws_minimal.c"</span></span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> lws_protocols protocols<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span> <span class="token string">"http"</span><span class="token punctuation">,</span> lws_callback_http_dummy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	LWS_PLUGIN_PROTOCOL_MINIMAL<span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token comment">/* terminator */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> lws_retry_bo_t retry <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>secs_since_valid_ping <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>secs_since_valid_hangup <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> interrupted<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> lws_http_mount mount <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* .mount_next */</span>		<span class="token constant">NULL</span><span class="token punctuation">,</span>		<span class="token comment">/* linked-list "next" */</span>
	<span class="token comment">/* .mountpoint */</span>		<span class="token string">"/"</span><span class="token punctuation">,</span>		<span class="token comment">/* mountpoint URL */</span>
	<span class="token comment">/* .origin */</span>			<span class="token string">"./mount-origin"</span><span class="token punctuation">,</span>  <span class="token comment">/* serve from dir */</span>
	<span class="token comment">/* .def */</span>			<span class="token string">"index.html"</span><span class="token punctuation">,</span>	<span class="token comment">/* default filename */</span>
	<span class="token comment">/* .protocol */</span>			<span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token comment">/* .cgienv */</span>			<span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token comment">/* .extra_mimetypes */</span>		<span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token comment">/* .interpret */</span>		<span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token comment">/* .cgi_timeout */</span>		<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token comment">/* .cache_max_age */</span>		<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token comment">/* .auth_mask */</span>		<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token comment">/* .cache_reusable */</span>		<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token comment">/* .cache_revalidate */</span>		<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token comment">/* .cache_intermediaries */</span>	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token comment">/* .origin_protocol */</span>		LWSMPRO_FILE<span class="token punctuation">,</span>	<span class="token comment">/* files in a dir */</span>
	<span class="token comment">/* .mountpoint_len */</span>		<span class="token number">1</span><span class="token punctuation">,</span>		<span class="token comment">/* char count */</span>
	<span class="token comment">/* .basic_auth_login_file */</span>	<span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	interrupted <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> lws_context_creation_info info<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> lws_context <span class="token operator">*</span>context<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	<span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> logs <span class="token operator">=</span> LLL_USER <span class="token operator">|</span> LLL_ERR <span class="token operator">|</span> LLL_WARN <span class="token operator">|</span> LLL_NOTICE
			<span class="token comment">/* for LLL_ verbosity above NOTICE to be built into lws,
			 * lws must have been configured and built with
			 * -DCMAKE_BUILD_TYPE=DEBUG instead of =RELEASE */</span>
			<span class="token comment">/* | LLL_INFO */</span> <span class="token comment">/* | LLL_PARSER */</span> <span class="token comment">/* | LLL_HEADER */</span>
			<span class="token comment">/* | LLL_EXT */</span> <span class="token comment">/* | LLL_CLIENT */</span> <span class="token comment">/* | LLL_LATENCY */</span>
			<span class="token comment">/* | LLL_DEBUG */</span><span class="token punctuation">;</span>

	<span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> sigint_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">lws_cmdline_option</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"-d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		logs <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lws_set_log_level</span><span class="token punctuation">(</span>logs<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"LWS minimal ws server | visit http://localhost:7681 (-s = use TLS / https)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* otherwise uninitialized garbage */</span>
	info<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token number">7681</span><span class="token punctuation">;</span>
	info<span class="token punctuation">.</span>mounts <span class="token operator">=</span> <span class="token operator">&amp;</span>mount<span class="token punctuation">;</span>
	info<span class="token punctuation">.</span>protocols <span class="token operator">=</span> protocols<span class="token punctuation">;</span>
	info<span class="token punctuation">.</span>vhost_name <span class="token operator">=</span> <span class="token string">"localhost"</span><span class="token punctuation">;</span>
	info<span class="token punctuation">.</span>ws_ping_pong_interval <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	info<span class="token punctuation">.</span>options <span class="token operator">=</span>
		LWS_SERVER_OPTION_HTTP_HEADERS_SECURITY_BEST_PRACTICES_ENFORCE<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lws_cmdline_option</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">lwsl_user</span><span class="token punctuation">(</span><span class="token string">"Server using TLS\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		info<span class="token punctuation">.</span>options <span class="token operator">|</span><span class="token operator">=</span> LWS_SERVER_OPTION_DO_SSL_GLOBAL_INIT<span class="token punctuation">;</span>
		info<span class="token punctuation">.</span>ssl_cert_filepath <span class="token operator">=</span> <span class="token string">"localhost-100y.cert"</span><span class="token punctuation">;</span>
		info<span class="token punctuation">.</span>ssl_private_key_filepath <span class="token operator">=</span> <span class="token string">"localhost-100y.key"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lws_cmdline_option</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		info<span class="token punctuation">.</span>options <span class="token operator">|</span><span class="token operator">=</span> LWS_SERVER_OPTION_VHOST_UPG_STRICT_HOST_CHECK<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lws_cmdline_option</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"-v"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		info<span class="token punctuation">.</span>retry_and_idle_policy <span class="token operator">=</span> <span class="token operator">&amp;</span>retry<span class="token punctuation">;</span>

	context <span class="token operator">=</span> <span class="token function">lws_create_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">lwsl_err</span><span class="token punctuation">(</span><span class="token string">"lws init failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>interrupted<span class="token punctuation">)</span>
		n <span class="token operator">=</span> <span class="token function">lws_service</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lws_context_destroy</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于服务端和客户端支持的回调协议名不一样，所以服务器这里一直打印，不影响使用：<br> <img src="https://images2.imgbox.com/bb/65/4mbj35og_o.png" alt="在这里插入图片描述"><br> <strong>下面有很多人问lws_getaddrinfo46 failed的问题，我怀疑是dns解析的问题，建议先使用ip和端口的形式试下，域名的问题我再看看源码，暂时没分析出原因，客户端似乎没办法自动根据域名解析出对应的ip和端口，目前从源码看是“ipv6 lws_getaddrinfo46 failed”。</strong></p> 
<p><strong>还有客户端一般可以用官网给的不加密客户端，需要加密的话则需要证书，对于自签名的证书options配置参数需要改一下，是支持自签名证书的。</strong></p> 
<h3><a id="_736"></a>坑点</h3> 
<p>有个大家一直踩的坑点就是连接域名的时候一直报错，最后发现使用域名时是不用加wss://前缀的，大家注意一下，比如使用minimal-ws-client测试wss服务连接：</p> 
<pre><code class="prism language-shell"> ./lws-minimal-ws-client -s openhw.work.weixin.qq.com
</code></pre> 
<p><img src="https://images2.imgbox.com/97/7d/jot3qYE9_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5c49835d09a5e335a699f82a495e1aa6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Kali下用wifite破解WIFI</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/63a8ae23d3c0731122a60df614a82da2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">javaweb重定向——登录页面跳转到首页</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>