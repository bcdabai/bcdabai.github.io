<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>GoLong的学习之路，进阶，Viper（yaml等配置文件的管理） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="GoLong的学习之路，进阶，Viper（yaml等配置文件的管理）" />
<meta property="og:description" content="本来有今天是继续接着上一章写微服务的。但是这几天有朋友说，再写Web框架的时候，遇到一个问题，就是很多的中间件（redis，微信，mysql，mq）的配置信息写的太杂了，很不好管理。希望我能写一篇有管理配置文件的。所以这篇就放到今天写吧。微服务就放到下一篇来说吧。今天介绍的主角：Viper
文章目录 Viper概念安装 使用VIper默认值使用-&gt;配置文件读取配置文件：写入配置文件监控并重新读取配置文件(运行时读取配置文件)从`io.Reader`读取配置注册和使用别名 环境变量命令行参数（flag）`key/value`存储(远程`Key/Value`存储支持)（微服务）etcdConsulFirestore 从Viper获取值访问嵌套的键提取子树 反序列化序列化成字符串使用多个viper实例 使用Viper示例直接使用viper管理配置使用结构体变量保存配置信息 Viper概念 Viper是适用于Go应用程序（包括Twelve-Factor App）的完整配置解决方案。它被设计用于在应用程序中工作，并且可以处理所有类型的配置需求和格式。
它支持以下特性：
设置默认值从JSON、TOML、YAML、HCL、envfile和Java properties格式的配置文件读取配置信息实时监控和重新读取配置文件（可选）从环境变量中读取从远程配置系统（etcd或Consul）读取并监控配置变化从命令行参数读取配置从buffer(缓冲)读取配置显式配置值 在构建现代应用程序时，你无需担心配置文件格式。
Viper能够为你执行下列操作：
查找，加载，和反序列化JSON、TOML、YAML、HCL、INI、envfile和Java properties格式的配置文件。提供一种机制，为不同配置选项设置默认值。提供一种机制来通过命令行参数覆盖指定选项的值。提供别名系统，以便在不破坏现有代码的情况下轻松重命名参数。当用户提供了，与默认值相同的命令行或者配置文件时，可以很容易分辨出他们之间的不通。 Viper会按照下面的优先级，每个项目的优先级都高于它下面的项目:
显示调用Set设置值命令行参数（flag）环境变量配置文件key/value存储默认值 目前Viper配置的键（Key）是大小写不敏感的。目前正在讨论是否将这一选项设为可选。
Viper让需要重启服务器才能使配置生效的日子一去不复返！！！
这才是VIper最大的魅力。
Viper没有默认的基础配置，所以在使用的过程中我们初始化Viper实例的时候需要告诉Viper你的配置路径、配置格式、配置名称等等信息。
Viper虽然支持多配置同时使用，但是一个Viper实例只能寻一个配置路径。
安装 go get github.com/spf13/viper 使用VIper 默认值 Viper 支持使用 viper.SetDefault(key, value) 为 key 设置默认值 value
Viper配置的键（Key）是大小写不敏感的
viper.SetDefault(&#34;ContentDir&#34;, &#34;content&#34;) viper.SetDefault(&#34;LayoutDir&#34;, &#34;layouts&#34;) viper.SetDefault(&#34;Taxonomies&#34;, map[string]string{&#34;tag&#34;: &#34;tags&#34;, &#34;category&#34;: &#34;categories&#34;}) 键不需要默认值，但如果没有通过配置文件、环境变量、远程配置或命令行标志（flag）设置键，则默认值非常有用。
package main import ( &#34;fmt&#34; &#34;github.com/spf13/viper&#34; ) func main() { // 设置默认配置 viper.SetDefault(&#34;username&#34;, &#34;李四&#34;) viper.SetDefault(&#34;server&#34;, map[string]string{&#34;ip&#34;: &#34;127.0.0.1&#34;, &#34;port&#34;: &#34;8080&#34;}) // 读取配置值 fmt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5f2c5516b12887f2bdef5cc745e82289/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-08T14:03:48+08:00" />
<meta property="article:modified_time" content="2023-12-08T14:03:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">GoLong的学习之路，进阶，Viper（yaml等配置文件的管理）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本来有今天是继续接着上一章写微服务的。但是这几天有朋友说，再写Web框架的时候，遇到一个问题，就是很多的中间件（redis，微信，mysql，mq）的配置信息写的太杂了，很不好管理。希望我能写一篇有管理配置文件的。所以这篇就放到今天写吧。微服务就放到下一篇来说吧。今天介绍的主角：Viper</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Viper_4" rel="nofollow">Viper概念</a></li><li><ul><li><a href="#_46" rel="nofollow">安装</a></li></ul> 
  </li><li><a href="#VIper_52" rel="nofollow">使用VIper</a></li><li><ul><li><a href="#_54" rel="nofollow">默认值</a></li><li><a href="#_88" rel="nofollow">使用-&gt;配置文件</a></li><li><ul><li><a href="#_90" rel="nofollow">读取配置文件：</a></li><li><a href="#_178" rel="nofollow">写入配置文件</a></li><li><a href="#_198" rel="nofollow">监控并重新读取配置文件(运行时读取配置文件)</a></li><li><a href="#ioReader_241" rel="nofollow">从`io.Reader`读取配置</a></li><li><a href="#_268" rel="nofollow">注册和使用别名</a></li></ul> 
   </li><li><a href="#_278" rel="nofollow">环境变量</a></li><li><a href="#flag_320" rel="nofollow">命令行参数（flag）</a></li><li><a href="#keyvalueKeyValue_421" rel="nofollow">`key/value`存储(远程`Key/Value`存储支持)（微服务）</a></li><li><ul><li><a href="#etcd_454" rel="nofollow">etcd</a></li><li><a href="#Consul_463" rel="nofollow">Consul</a></li><li><a href="#Firestore_479" rel="nofollow">Firestore</a></li></ul> 
   </li><li><a href="#Viper_489" rel="nofollow">从Viper获取值</a></li><li><ul><li><a href="#_510" rel="nofollow">访问嵌套的键</a></li><li><a href="#_545" rel="nofollow">提取子树</a></li></ul> 
   </li><li><a href="#_575" rel="nofollow">反序列化</a></li><li><ul><li><a href="#_621" rel="nofollow">序列化成字符串</a></li><li><a href="#viper_641" rel="nofollow">使用多个viper实例</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Viper_665" rel="nofollow">使用Viper示例</a></li><li><ul><li><a href="#viper_672" rel="nofollow">直接使用viper管理配置</a></li><li><a href="#_708" rel="nofollow">使用结构体变量保存配置信息</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Viper_4"></a>Viper概念</h2> 
<p><code>Viper</code>是适用于<code>Go</code>应用程序（包括<code>Twelve-Factor App</code>）的完整配置解决方案。它被设计用于在应用程序中工作，并且可以处理所有类型的配置需求和格式。</p> 
<p>它支持以下特性：</p> 
<ul><li>设置默认值</li><li>从<code>JSON</code>、<code>TOML</code>、<code>YAML</code>、<code>HCL</code>、<code>envfile</code>和<code>Java properties</code>格式的配置文件读取配置信息</li><li>实时监控和重新读取配置文件（可选）</li><li>从环境变量中读取</li><li>从远程配置系统（<code>etcd</code>或<code>Consul</code>）读取并监控配置变化</li><li>从命令行参数读取配置</li><li>从<code>buffer</code>(缓冲)读取配置</li><li>显式配置值</li></ul> 
<p>在构建现代应用程序时，你无需担心配置文件格式。</p> 
<p>Viper能够为你执行下列操作：</p> 
<ol><li>查找，加载，和反序列化<code>JSON</code>、<code>TOML</code>、<code>YAML</code>、<code>HCL</code>、<code>INI</code>、<code>envfile</code>和<code>Java properties</code>格式的配置文件。</li><li>提供一种机制，为不同配置选项设置默认值。</li><li>提供一种机制来通过命令行参数覆盖指定选项的值。</li><li>提供别名系统，以便在不破坏现有代码的情况下轻松重命名参数。</li><li>当用户提供了，与默认值相同的命令行或者配置文件时，可以很容易分辨出他们之间的不通。</li></ol> 
<p>Viper会按照下面的优先级，每个项目的优先级都高于它下面的项目:</p> 
<ul><li>显示调用<code>Set</code>设置值</li><li>命令行参数（flag）</li><li>环境变量</li><li>配置文件</li><li>key/value存储</li><li>默认值</li></ul> 
<p>目前Viper配置的键（<code>Key</code>）是大小写不敏感的。目前正在讨论是否将这一选项设为可选。</p> 
<p><code>Viper</code>让需要重启服务器才能使配置生效的日子一去不复返！！！</p> 
<p>这才是VIper最大的魅力。</p> 
<p>Viper没有默认的基础配置，所以在使用的过程中我们初始化<code>Viper</code>实例的时候需要告诉<code>Viper</code>你的<code>配置路径</code>、<code>配置格式</code>、<code>配置名称</code>等等信息。</p> 
<p><strong><code>Viper</code>虽然支持多配置同时使用，但是一个<code>Viper</code>实例只能寻一个配置路径。</strong></p> 
<h3><a id="_46"></a>安装</h3> 
<pre><code class="prism language-go"><span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>spf13<span class="token operator">/</span>viper
</code></pre> 
<hr> 
<h2><a id="VIper_52"></a>使用VIper</h2> 
<h3><a id="_54"></a>默认值</h3> 
<p>Viper 支持使用 viper.SetDefault(key, value) 为 key 设置默认值 value</p> 
<p>Viper配置的键（<code>Key</code>）是大小写不敏感的</p> 
<pre><code class="prism language-go">
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"ContentDir"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"LayoutDir"</span><span class="token punctuation">,</span> <span class="token string">"layouts"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"Taxonomies"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"tag"</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>键不需要默认值，但如果没有通过配置文件、环境变量、远程配置或命令行标志（flag）设置键，则默认值非常有用。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 设置默认配置</span>
	viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"李四"</span><span class="token punctuation">)</span>
	viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"server"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"ip"</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"port"</span><span class="token punctuation">:</span> <span class="token string">"8080"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// 读取配置值</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"username: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// key 不区分大小写</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"server: %+v\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"server"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-go">username<span class="token punctuation">:</span> jianghushinian
server<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span>ip<span class="token punctuation">:</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> port<span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_88"></a>使用-&gt;配置文件</h3> 
<h4><a id="_90"></a>读取配置文件：</h4> 
<ul><li> <p><code>Viper</code>需要最少知道在哪里查找配置文件的配置。</p> </li><li> <p><code>Viper</code>可以搜索多个路径，但目前单个<code>Viper</code>实例只支持单个配置文件。</p> </li><li> <p><code>Viper</code>不默认任何配置搜索路径，将默认决策留给应用程序。</p> </li></ul> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"./config.yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 指定配置文件路径</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span> <span class="token comment">// 配置文件名称(无扩展名)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 如果配置文件的名称中没有扩展名，则需要配置此项</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"/etc/appname/"</span><span class="token punctuation">)</span>   <span class="token comment">// 查找配置文件所在的路径</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"$HOME/.appname"</span><span class="token punctuation">)</span>  <span class="token comment">// 多次调用以添加多个搜索路径</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>               <span class="token comment">// 还可以在工作目录中查找配置</span>
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 查找并读取配置文件</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 处理读取配置文件的错误</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在加载配置文件出错时，可以像下面这样处理找不到配置文件的特定情况：</p> 
<pre><code class="prism language-go"><span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span>ConfigFileNotFoundError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 配置文件未找到错误；如果需要可以忽略</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 配置文件被找到，但产生了另外的错误</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 配置文件找到并成功解析</span>
</code></pre> 
<ul><li>通过 <code>viper.SetConfigFile()</code> 指定配置文件，如果配置文件名中没有扩展名，则需要使用 <code>viper.SetConfigType()</code> 显式指定配置文件的格式。</li><li>通过 <code>viper.AddConfigPath() </code>指定配置文件的搜索路径中，可以通过多次调用，来设置多个配置文件搜索路径。 
  <ul><li>然后通过 <code>viper.SetConfigName() </code>指定不带扩展名的配置文件，<code>Viper</code> 会根据所添加的路径顺序查找配置文件，如果找到就停止查找。</li></ul> </li></ul> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"errors"</span>
	<span class="token string">"flag"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
	cfg <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"config file."</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">*</span>cfg <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token operator">*</span>cfg<span class="token punctuation">)</span>   <span class="token comment">// 指定配置文件（路径 + 配置文件名）</span>
		viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 如果配置文件名中没有扩展名，则需要显式指定配置文件的格式</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>             <span class="token comment">// 把当前目录加入到配置文件的搜索路径中</span>
		viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"$HOME/.config"</span><span class="token punctuation">)</span> <span class="token comment">// 可以多次调用 AddConfigPath 来设置多个配置文件搜索路径</span>
		viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"cfg"</span><span class="token punctuation">)</span>           <span class="token comment">// 指定配置文件名（没有扩展名）</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 读取配置文件</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span>ConfigFileNotFoundError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"config file not found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"config file was found but another error was produced"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"using config file: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">ConfigFileUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 读取配置值</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"username: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果有多个名称为config的配置文件，viper怎么搜索呢？它会按照如下顺序搜索</p> 
<ul><li><code>config.json</code></li><li><code>config.toml</code></li><li><code>config.yaml</code></li><li><code>config.yml</code></li><li><code>config.properties</code> (这种一般是java中的配置文件名)</li><li><code>config.props</code> (这种一般是java中的配置文件名)</li></ul> 
<h4><a id="_178"></a>写入配置文件</h4> 
<p>从配置文件中读取配置文件是有用的，但是有时你想要存储在<code>运行时</code>所做的所有修改。</p> 
<p>所以这个，就是Viper的最大的作用。</p> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">WriteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将当前配置写入“viper.AddConfigPath()”和“viper.SetConfigName”设置的预定义路径</span>
viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">WriteConfigAs</span><span class="token punctuation">(</span><span class="token string">"/path/to/my/.config"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfigAs</span><span class="token punctuation">(</span><span class="token string">"/path/to/my/.config"</span><span class="token punctuation">)</span> <span class="token comment">// 因为该配置文件写入过，所以会报错</span>
viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfigAs</span><span class="token punctuation">(</span><span class="token string">"/path/to/my/.other_config"</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>WriteConfig</code> - 将当前的<code>viper</code>配置写入预定义的路径并覆盖（如果存在的话）。如果没有预定义的路径，则报错。</li><li><code>SafeWriteConfig</code> - 将当前的<code>viper</code>配置写入预定义的路径。如果没有预定义的路径，则报错。如果存在，将不会覆盖当前的配置文件。</li><li><code>WriteConfigAs</code> - 将当前的<code>viper</code>配置写入给定的文件路径。将覆盖给定的文件(如果它存在的话)。</li><li><code>SafeWriteConfigAs</code> - 将当前的<code>viper</code>配置写入给定的文件路径。不会覆盖给定的文件(如果它存在的话)。</li></ul> 
<h4><a id="_198"></a>监控并重新读取配置文件(运行时读取配置文件)</h4> 
<p><code>Viper</code> 支持在应用程序运行过程中实时读取配置文件，即热加载配置。</p> 
<p>只需要调用 <code>viper.WatchConfig() </code>即可开启此功能。</p> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>e fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 配置文件发生变更之后会调用的回调函数</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Config file changed:"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>viper</code>驱动的应用程序可以在运行时读取配置文件的更新，而不会错过任何消息。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
	<span class="token string">"github.com/fsnotify/fsnotify"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"./config.yaml"</span><span class="token punctuation">)</span>
	viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 注册每次配置文件发生变更后都会调用的回调函数</span>
	viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>e fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"config file changed: %s\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// 监控并重新读取配置文件，需要确保在调用前添加了所有的配置路径</span>
	viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 阻塞程序，这个过程中可以手动去修改配置文件内容，观察程序输出变化</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token comment">// 读取配置值</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"username: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>调用了<code>set</code>方法，用了<code>Viper</code>中的最高优先级，对原来的配置文件做覆盖。但是要让这个配置文件在运行中启动，就需要调用：<code>viper.WatchConfig()</code></p> 
<p>也就是说：在调用<code>viper.WatchConfig()</code>监控并重新读取配置文件之前，需要确保添加了所有的配置路径。</p> 
<h4><a id="ioReader_241"></a>从<code>io.Reader</code>读取配置</h4> 
<p><code>Viper</code> 支持从任何实现了<code>io.Reader</code>接口的配置源中读取配置</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 或者使用 viper.SetConfigType("YAML")</span>
	<span class="token keyword">var</span> yamlExample <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`
		username: jianghushinian
		password: 123456
		server:
		ip: 127.0.0.1
		port: 8080`</span>
		<span class="token punctuation">)</span>
	viper<span class="token punctuation">.</span><span class="token function">ReadConfig</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>yamlExample<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 读取配置值</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"username: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里我们通过 <code>bytes.NewBuffer()</code> 构造了一个 <code>bytes.Buffer </code>对象，它实现了 <code>io.Reader </code>接口，所以可以直接传递给 <code>viper.ReadConfig()</code>来从中读取配置。</p> 
<h4><a id="_268"></a>注册和使用别名</h4> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">RegisterAlias</span><span class="token punctuation">(</span><span class="token string">"loud"</span><span class="token punctuation">,</span> <span class="token string">"Verbose"</span><span class="token punctuation">)</span>  <span class="token comment">// 注册别名（此处loud和Verbose建立了别名）</span>
viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"verbose"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 结果与下一行相同</span>
viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"loud"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>   <span class="token comment">// 结果与前一行相同</span>
viper<span class="token punctuation">.</span><span class="token function">GetBool</span><span class="token punctuation">(</span><span class="token string">"loud"</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
viper<span class="token punctuation">.</span><span class="token function">GetBool</span><span class="token punctuation">(</span><span class="token string">"verbose"</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre> 
<h3><a id="_278"></a>环境变量</h3> 
<p>Viper 还支持从环境变量读取配置，有 5 个方法可以帮助我们使用环境变量：</p> 
<ul><li><code>AutomaticEnv()</code>：可以绑定全部环境变量（用法上类似 <code>flag </code>包的 <code>flag.Parse()</code>）。调用后，<code>Viper</code> 会自动检测和加载所有环境变量。</li><li><code>BindEnv(string...) : error</code>：绑定一个环境变量。需要一个或两个参数，第一个参数是配置项的键名，第二个参数是环境变量的名称。 
  <ul><li>如果未提供第二个参数，则 Viper 将假定环境变量名为：环境变量前缀_键名，且为全大写形式。 
    <ul><li>例如环境变量前缀为 <code>ENV</code>，键名为 <code>username</code>，则环境变量名为 <code>ENV_USERNAME</code>。</li></ul> </li><li>当显式提供第二个参数时，它不会自动添加前缀，也不会自动将其转换为大写。 
    <ul><li>例如，使用<code>viper.BindEnv("username", "username")</code>绑定键名为<code> username</code> 的环境变量，应该使用 <code>viper.Get("username") </code>读取环境变量的值。</li></ul> </li></ul> </li></ul> 
<p>在使用环境变量时，需要注意，每次访问它的值时都会去环境变量中读取。当调用 <code>BindEnv</code> 时，<code>Viper</code> 不会固定它的值。</p> 
<ul><li><code>SetEnvPrefix(string)</code>：可以告诉 <code>Viper</code> 在读取环境变量时使用的前缀。<code>BindEnv</code> 和 <code>AutomaticEnv</code> 都将使用此前缀。 
  <ul><li>例如，使用 <code>viper.SetEnvPrefix("ENV") </code>设置了前缀为 <code>ENV</code>，并且使用 <code>viper.BindEnv("username") </code>绑定了环境变量，在使用 <code>viper.Get("username")</code> 读取环境变量时，实际读取的 <code>key</code> 是 <code>ENV_USERNAME</code>。</li></ul> </li><li><code>SetEnvKeyReplacer(string...) *strings.Replacer</code>：允许使用 <code>strings.Replacer</code> 对象在一定程度上重写环境变量的键名。 
  <ul><li>例如，存在 <code>SERVER_IP="127.0.0.1" </code>环境变量，使用 <code>viper.SetEnvKeyReplacer(strings.NewReplacer(".", "_", "-", "_")) </code>将键名中的<code>.</code> 或 <code>-</code> 替换成<code> _</code>，则通过 <code>viper.Get("server_ip")</code>、<code>viper.Get("server.ip")</code>、<code>viper.Get("server-ip") </code>三种方式都可以读取环境变量对应的值。</li></ul> </li><li><code>AllowEmptyEnv(bool)</code>：当环境变量为空时（有键名而没有值的情况），默认会被认为是未设置的，并且程序将回退到下一个配置来源。要将空环境变量视为已设置，可以使用此方法。</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"strings"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	viper<span class="token punctuation">.</span><span class="token function">SetEnvPrefix</span><span class="token punctuation">(</span><span class="token string">"env"</span><span class="token punctuation">)</span> <span class="token comment">// 设置读取环境变量前缀，会自动转为大写 ENV</span>
	viper<span class="token punctuation">.</span><span class="token function">AllowEmptyEnv</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 将空环境变量视为已设置</span>
	viper<span class="token punctuation">.</span><span class="token function">AutomaticEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment">// 可以绑定全部环境变量</span>
	viper<span class="token punctuation">.</span><span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token comment">// 也可以单独绑定某一个环境变量</span>
	viper<span class="token punctuation">.</span><span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
	<span class="token comment">// 将键名中的 . 或 - 替换成 _</span>
	viper<span class="token punctuation">.</span><span class="token function">SetEnvKeyReplacer</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">NewReplacer</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 读取配置</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"username: %v\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"password: %v\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"server.ip: %v\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"server.ip"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 读取全部配置，只能获取到通过 BindEnv 绑定的环境变量，无法获取到通过 AutomaticEnv 绑定的环境变量</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">AllSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="flag_320"></a>命令行参数（flag）</h3> 
<p>安装pflag</p> 
<pre><code class="prism language-go"><span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>spf13<span class="token operator">/</span>pflag
</code></pre> 
<p><code>Viper</code> 支持 <code>pflag</code> 包（它们其实都在 <code>spf13</code> 仓库下），能够绑定命令行标志，从而读取命令行参数。</p> 
<p>同 <code>BindEnv</code> 类似，在调用绑定方法时，不会设置值，而是在每次访问时设置。</p> 
<p><strong>这意味着我们可以随时绑定它，例如可以在 <code>init() </code>函数中。</strong></p> 
<ul><li><code>BindPFlag</code>：对于单个标志，可以调用此方法进行绑定。</li><li><code>BindPFlags</code>：可以绑定一组现有的标志集 <code>pflag.FlagSet</code>。</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/spf13/pflag"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
	username <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"help message for username"</span><span class="token punctuation">)</span>
	password <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"help message for password"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 绑定单个标志</span>
	viper<span class="token punctuation">.</span><span class="token function">BindPFlags</span><span class="token punctuation">(</span>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>                   <span class="token comment">// 绑定标志集</span>
	<span class="token comment">// 读取配置值</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"username: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"password: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>因为 <code>pflag</code> 能够兼容标准库的 <code>flag </code>包，所以我们也可以变相的让 <code>Viper</code> 支持<code> flag</code></strong></p> 
<p>在 Viper 中使用 <code>pflag </code>并不阻碍其他包中使用标准库中的 <code>flag</code> 包。<code>pflag </code>包可以通过导入这些 <code>flags </code>来处理<code>flag</code>包定义的<code>flags</code>。这是通过调用<code>pflag</code>包提供的便利函数<code>AddGoFlagSet()</code>来实现的。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"flag"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/spf13/pflag"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"help message for username"</span><span class="token punctuation">)</span>
	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">AddGoFlagSet</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span> <span class="token comment">// 将 flag 命令行参数注册到 pflag</span>
	pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	viper<span class="token punctuation">.</span><span class="token function">BindPFlags</span><span class="token punctuation">(</span>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>
	<span class="token comment">// 读取配置值</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"username: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>使用<code>Flags</code></strong></p> 
<pre><code class="prism language-go">serverCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token number">1138</span><span class="token punctuation">,</span> <span class="token string">"Port to run Application server on"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> serverCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果你不使用<code>Pflag</code>，<code>Viper </code>提供了两个Go接口来绑定其他<code> flag</code> 系统。</p> 
<p><code>FlagValue</code>表示单个<code>flag</code>。</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> myFlag <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlag<span class="token punctuation">)</span> <span class="token function">HasChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlag<span class="token punctuation">)</span> <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token string">"my-flag-name"</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlag<span class="token punctuation">)</span> <span class="token function">ValueString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token string">"my-flag-value"</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlag<span class="token punctuation">)</span> <span class="token function">ValueType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token string">"string"</span> <span class="token punctuation">}</span>
</code></pre> 
<p>flag 实现了这个接口，Viper绑定。</p> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">BindFlagValue</span><span class="token punctuation">(</span><span class="token string">"my-flag-name"</span><span class="token punctuation">,</span> myFlag<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>FlagValueSet</code>代表一组 <code>flags </code></p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> myFlagSet <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	flags <span class="token punctuation">[</span><span class="token punctuation">]</span>myFlag
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlagSet<span class="token punctuation">)</span> <span class="token function">VisitAll</span><span class="token punctuation">(</span>fn <span class="token keyword">func</span><span class="token punctuation">(</span>FlagValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> flag <span class="token operator">:=</span> <span class="token keyword">range</span> flags <span class="token punctuation">{<!-- --></span>
		<span class="token function">fn</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>flag set</code>实现了这个接口，就可以很方便地告诉<code>Viper</code>绑定它</p> 
<pre><code class="prism language-go">fSet <span class="token operator">:=</span> myFlagSet<span class="token punctuation">{<!-- --></span>
	flags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>myFlag<span class="token punctuation">{<!-- --></span>myFlag<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> myFlag<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
viper<span class="token punctuation">.</span><span class="token function">BindFlagValues</span><span class="token punctuation">(</span><span class="token string">"my-flags"</span><span class="token punctuation">,</span> fSet<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="keyvalueKeyValue_421"></a><code>key/value</code>存储(远程<code>Key/Value</code>存储支持)（微服务）</h3> 
<p>在<code>Viper</code>中启用远程支持，需要在代码中匿名导入<code>viper/remote</code>这个包。</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">"github.com/spf13/viper/remote"</span>
</code></pre> 
<p>Viper 支持 etcd、Consul 等远程 key/value 存储，这里以 Consul 为例进行讲解。</p> 
<p>而具体什么是Consul 这个会在微服务中体现，也就是说，这个处于微服务使用。</p> 
<p>首先需要准备 Consul 环境：文章</p> 
<p><code>Consul</code> <code>Key/Value</code>存储中设置一个<code>Key</code>保存包含所需配置的<code>JSON</code>值。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/spf13/viper"</span>
	<span class="token boolean">_</span> <span class="token string">"github.com/spf13/viper/remote"</span> <span class="token comment">// 必须导入，才能加载远程 key/value 配置</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">"consul"</span><span class="token punctuation">,</span> <span class="token string">"localhost:8500"</span><span class="token punctuation">,</span> <span class="token string">"user/config"</span><span class="token punctuation">)</span> <span class="token comment">// 连接远程 consul 服务</span>
	viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"YAML"</span><span class="token punctuation">)</span>                                        <span class="token comment">// 显式设置文件格式文 YAML</span>
	viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 读取配置值</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"username: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"server.ip: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"server.ip"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>官方文档中有还提供这几点：etcd，Consul，Firestore：</p> 
<h4><a id="etcd_454"></a>etcd</h4> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">"etcd"</span><span class="token punctuation">,</span> <span class="token string">"http://127.0.0.1:4001"</span><span class="token punctuation">,</span><span class="token string">"/config/hugo.json"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span> <span class="token comment">// 因为在字节流中没有文件扩展名，所以这里需要设置下类型。</span>
<span class="token comment">//支持的扩展名有 "json", "toml", "yaml", "yml", "properties", "props", "prop", "env", "dotenv"</span>
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="Consul_463"></a>Consul</h4> 
<p>创建一个<code>keyMY_CONSUL_KEY</code>将下面的值存入<code>Consul key/value </code>存储</p> 
<pre><code class="prism language-go"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"port"</span><span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
    <span class="token string">"hostname"</span><span class="token punctuation">:</span> <span class="token string">"liwenzhou.com"</span>
<span class="token punctuation">}</span>

viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">"consul"</span><span class="token punctuation">,</span> <span class="token string">"localhost:8500"</span><span class="token punctuation">,</span> <span class="token string">"MY_CONSUL_KEY"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span> <span class="token comment">// 需要显示设置成json</span>
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8080</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"hostname"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// liwenzhou.com</span>
</code></pre> 
<h4><a id="Firestore_479"></a>Firestore</h4> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">"firestore"</span><span class="token punctuation">,</span> <span class="token string">"google-cloud-project-id"</span><span class="token punctuation">,</span> <span class="token string">"collection/document"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span> <span class="token comment">// 配置的格式: "json", "toml", "yaml", "yml"</span>
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里其实还涉及到一个监控加密的问题，这里建议看<a href="https://geekdaxue.co/read/go-packages-docs-awesome/docs-viper-README.md#g7xs7o" rel="nofollow">官方文档</a></p> 
<h3><a id="Viper_489"></a>从Viper获取值</h3> 
<pre><code class="prism language-go">在Viper中，有几种方法可以根据值的类型获取值。存在以下功能和方法<span class="token punctuation">:</span>

<span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token function">GetBool</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token builtin">bool</span>
<span class="token function">GetFloat64</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token builtin">float64</span>
<span class="token function">GetInt</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token builtin">int</span>
<span class="token function">GetIntSlice</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token function">GetString</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token builtin">string</span>
<span class="token function">GetStringMap</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token function">GetStringMapString</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token function">GetStringSlice</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token function">GetTime</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> time<span class="token punctuation">.</span>Time
<span class="token function">GetDuration</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> time<span class="token punctuation">.</span>Duration
<span class="token function">IsSet</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token builtin">bool</span>
<span class="token function">AllSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>每一个<code>Get</code>方法在找不到值的时候都会返回零值。为了检查给定的键是否存在，提供了<code>IsSet()</code>方法。</p> 
<h4><a id="_510"></a>访问嵌套的键</h4> 
<p>加载下面的JSON文件</p> 
<pre><code class="prism language-go"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"address"</span><span class="token punctuation">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
        <span class="token string">"port"</span><span class="token punctuation">:</span> <span class="token number">5799</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"datastore"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"metric"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
            <span class="token string">"port"</span><span class="token punctuation">:</span> <span class="token number">3099</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"warehouse"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"198.0.0.1"</span><span class="token punctuation">,</span>
            <span class="token string">"port"</span><span class="token punctuation">:</span> <span class="token number">2112</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"datastore.metric.host"</span><span class="token punctuation">)</span> <span class="token comment">// (返回 "127.0.0.1")</span>
</code></pre> 
<p>搜索路径将遍历其余配置注册表，直到找到为止。</p> 
<p>译注：因为Viper支持从多种配置来源，例如磁盘上的<code>配置文件</code>&gt;<code>命令行标志位</code>&gt;<code>环境变量</code>&gt;<code>远程Key/Value存储</code>&gt;<code>默认值</code>，我们在查找一个配置的时候如果在当前配置源中没找到，就会继续从后续的配置源查找，直到找到为止。</p> 
<p>如果<code>datastore.metric</code>被直接赋值覆盖（被<code>flag</code>，<code>环境变量</code>，<code>set()方法</code>等等…），那么<code>datastore.metric</code>的所有子键都将变为<code>未定义</code>状态，它们被<code>高优先级配置级别</code>“遮蔽”（shadowed）了。</p> 
<h4><a id="_545"></a>提取子树</h4> 
<pre><code class="prism language-go">app<span class="token punctuation">:</span>
  cache1<span class="token punctuation">:</span>
    max<span class="token operator">-</span>items<span class="token punctuation">:</span> <span class="token number">100</span>
    item<span class="token operator">-</span>size<span class="token punctuation">:</span> <span class="token number">64</span>
  cache2<span class="token punctuation">:</span>
    max<span class="token operator">-</span>items<span class="token punctuation">:</span> <span class="token number">200</span>
    item<span class="token operator">-</span>size<span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> 
<pre><code class="prism language-go">subv <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"app.cache1"</span><span class="token punctuation">)</span>
</code></pre> 
<p>假设我们现在有这么一个函数：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token operator">*</span>Cache <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre> 
<p>它基于subv格式的配置信息创建缓存。现在，可以轻松地分别创建这两个缓存。</p> 
<pre><code class="prism language-go">cfg1 <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"app.cache1"</span><span class="token punctuation">)</span>
cache1 <span class="token operator">:=</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg1<span class="token punctuation">)</span>

cfg2 <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"app.cache2"</span><span class="token punctuation">)</span>
cache2 <span class="token operator">:=</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg2<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_575"></a>反序列化</h3> 
<p>这个也是其中最重要的特点。</p> 
<p>可以选择将所有或特定的值解析到结构体、map等：</p> 
<ul><li><code>Unmarshal(rawVal interface{}) : error</code></li><li><code>UnmarshalKey(key string, rawVal interface{}) : error</code></li></ul> 
<pre><code class="prism language-go"><span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Port <span class="token builtin">int</span>
	Name <span class="token builtin">string</span>
	PathMap <span class="token builtin">string</span> <span class="token string">`mapstructure:"path_map"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> C config

err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>C<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
	t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unable to decode into struct, %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>想要解析那些键本身就包含.(默认的键分隔符）的配置，你需要修改分隔符：</p> 
<pre><code class="prism language-go">v <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">NewWithOptions</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">KeyDelimiter</span><span class="token punctuation">(</span><span class="token string">"::"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

v<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"chart::values"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"ingress"</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"annotations"</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"traefik.frontend.rule.type"</span><span class="token punctuation">:</span>                 <span class="token string">"PathPrefix"</span><span class="token punctuation">,</span>
            <span class="token string">"traefik.ingress.kubernetes.io/ssl-redirect"</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Chart <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
        Values <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> C config

v<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>C<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_621"></a>序列化成字符串</h4> 
<p>可能需要将<code>viper</code>中保存的所有设置序列化到一个字符串中，而不是将它们写入到一个文件中。</p> 
<p>你可以将自己喜欢的格式的序列化器与<code>AllSettings()</code>返回的配置一起使用。</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    yaml <span class="token string">"gopkg.in/yaml.v2"</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">yamlStringSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    c <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">AllSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    bs<span class="token punctuation">,</span> err <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unable to marshal config to YAML: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="viper_641"></a>使用多个viper实例</h4> 
<p>可以在应用程序中创建许多不同的<code>viper实例</code>。</p> 
<ul><li> <p>每个都有自己独特的一组配置和值。</p> </li><li> <p>每个人都可以从不同的配置文件，<code>key value</code>存储区等读取数据。</p> </li><li> <p>每个都可以从不同的配置文件、键值存储等中读取。</p> </li></ul> 
<p>viper包支持的所有功能都被镜像为viper实例的方法。</p> 
<pre><code class="prism language-go">x <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
y <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

x<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"ContentDir"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">)</span>
y<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"ContentDir"</span><span class="token punctuation">,</span> <span class="token string">"foobar"</span><span class="token punctuation">)</span>

<span class="token comment">//...</span>
</code></pre> 
<p><strong>当使用多个viper实例时，由用户来管理不同的viper实例。</strong></p> 
<h2><a id="Viper_665"></a>使用Viper示例</h2> 
<p>现在有一个<code>./conf/config.yaml</code>配置文件</p> 
<pre><code class="prism language-go">port<span class="token punctuation">:</span> <span class="token number">8123</span>
version<span class="token punctuation">:</span> <span class="token string">"v1.2.3"</span>
</code></pre> 
<h3><a id="viper_672"></a>直接使用viper管理配置</h3> 
<p>在<code>gin框架</code>搭建的<code>web项目</code>中使用<code>viper</code>，使用<code>viper</code>加载配置文件中的信息，并在代码中直接使用<code>viper.GetXXX()</code>方法获取对应的配置值。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net/http"</span>

	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"./conf/config.yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 指定配置文件路径</span>
	err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">// 读取配置信息</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>                    <span class="token comment">// 读取配置信息失败</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 监控配置文件变化</span>
	viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 访问/version的返回值会随配置文件的变化而变化</span>
	r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/version"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>
		fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">":%d"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_708"></a>使用结构体变量保存配置信息</h3> 
<p>可以在项目中定义与配置文件对应的结构体，<code>viper</code>加载完配置信息后使用结构体变量保存配置信息。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net/http"</span>

	<span class="token string">"github.com/fsnotify/fsnotify"</span>

	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Port    <span class="token builtin">int</span>    <span class="token string">`mapstructure:"port"`</span>
	Version <span class="token builtin">string</span> <span class="token string">`mapstructure:"version"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> Conf <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"./conf/config.yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 指定配置文件路径</span>
	err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment">// 读取配置信息</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>                           <span class="token comment">// 读取配置信息失败</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 将读取的配置信息保存至全局变量Conf</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>Conf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unmarshal conf failed, err:%s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 监控配置文件变化</span>
	viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 注意！！！配置文件发生变化后要同步到全局变量Conf</span>
	viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>in fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"夭寿啦~配置文件被人修改啦..."</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>Conf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unmarshal conf failed, err:%s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 访问/version的返回值会随配置文件的变化而变化</span>
	r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/version"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> Conf<span class="token punctuation">.</span>Version<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">":%d"</span><span class="token punctuation">,</span> Conf<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>这里献上<a href="https://github.com/spf13/viper/blob/master/README.md">官方文档</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5f6cfa4276f28bff3cbe9c7907e76de9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">探索异步交互：JavaScript AJAX 的全面指南</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7261e0db174eb575eebaffc9b7e20e4d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023 年四川省职业院校技能大赛 移动应用设计与开发赛项规程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>