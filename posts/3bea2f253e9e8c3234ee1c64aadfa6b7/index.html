<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>redis源码分析之二 —整体架构和流程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="redis源码分析之二 —整体架构和流程" />
<meta property="og:description" content="一、整体架构 Redis作为一种KV型数据库，其主要的应用方式有几种：
1、单机结构
这种情况适用于小规模的应用，安全性也相对来说比较低。处理能力有限，其数据容量也不会太大。
2、主从结构
这种方式其实就是一主多备，既可以降低Master的读压力，又可以增强安全性。但是存在主从复制的安全性问题。仍然没有解决写压力。
3、哨兵结构
通过哨兵的监控，实现了主从结构的增强即主服务器的自动灾难转移处理。这样就保证了整个系统的高可用性和安全性。增加了对系统的监控能力。但是仍然存在Master节点的写压力的问题。
4、集群结构-Proxy型
一些公司在上述的基础上增加了代理集群管理，开源了一些框架，比如Twemproxy，其实就是通过透明分片来实现多Master和多Salve。不过增加高可用的代价是，代理需要维护Failover需要自己实现。鱼和熊掌没有得兼。
5、集群结构-直连型
从Redis3.0之后支持了redis-cluster模式。其采用的是无中心结构，有点类似于P2P网络。可以自动扩展，无代理，按照哈希槽分布存储。高可用，自动实现Failover。通过Raft实现M/S的角色处理。
代码的整体架构以及代码分析，以单机及主从为主，在遇到重点流程及后期时增加其它结构类型的相关源码分析。抓住重点，理清脉络，用古人的话来说“直击肯綮”。先是整体分析，然后再根据重点的数据结构和模块进行逐一分析。
在前文提到过，Redis是一个单线程的基于多事件多路利用的C/S结构。其客户端既有官方提供的redis-cli，也有大量的第三方提供的基于其它语言的客户端。国内的各大公司几乎都封装了自己的客户端。所以，架构就说明了其流程，它一定是服务端启动监听，客户端连接并传送相关命令，然后服务端监听到数据后进行解析，丢给相关的事件处理器，然后再展开到Redis的相关处理逻辑。下面就分析其流程。
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-00AGSEf9-1576393984889)(img/redis_frame.png)]
说明：上述的图是从https://mp.weixin.qq.com/s/XJzu8yyVYZYmcOui_xXnvw中截取，如有侵权，请告知删除。
二、流程 1、客户端
老样子，先看代码：
int main(int argc, char **argv) { int firstarg; //相关的配置文件省略 config.hostip = sdsnew(&#34;127.0.0.1&#34;); config.hostport = 6379; ...... config.cluster_manager_command.timeout = CLUSTER_MANAGER_MIGRATE_TIMEOUT; config.cluster_manager_command.pipeline = CLUSTER_MANAGER_MIGRATE_PIPELINE; config.cluster_manager_command.threshold = CLUSTER_MANAGER_REBALANCE_THRESHOLD; config.cluster_manager_command.backup_dir = NULL; pref.hints = 1; spectrum_palette = spectrum_palette_color; spectrum_palette_size = spectrum_palette_color_size; if (!isatty(fileno(stdout)) &amp;&amp; (getenv(&#34;FAKETTY&#34;) == NULL)) config.output = OUTPUT_RAW; else config.output = OUTPUT_STANDARD; config." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3bea2f253e9e8c3234ee1c64aadfa6b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-12-15T15:17:19+08:00" />
<meta property="article:modified_time" content="2019-12-15T15:17:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">redis源码分析之二 —整体架构和流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_1"></a>一、整体架构</h3> 
<p>Redis作为一种KV型数据库，其主要的应用方式有几种：<br> 1、单机结构<br> <br> <img src="https://images2.imgbox.com/bc/65/xJVm3kQC_o.png" alt="在这里插入图片描述"><br> <br> 这种情况适用于小规模的应用，安全性也相对来说比较低。处理能力有限，其数据容量也不会太大。<br> <br> 2、主从结构<br> <br> <img src="https://images2.imgbox.com/0e/5a/QH0dAIo6_o.png" alt="在这里插入图片描述"><br> <br> 这种方式其实就是一主多备，既可以降低Master的读压力，又可以增强安全性。但是存在主从复制的安全性问题。仍然没有解决写压力。<br> <br> 3、哨兵结构<br> <br> <img src="https://images2.imgbox.com/d9/ad/DUUvuRhX_o.png" alt="在这里插入图片描述"><br> <br> 通过哨兵的监控，实现了主从结构的增强即主服务器的自动灾难转移处理。这样就保证了整个系统的高可用性和安全性。增加了对系统的监控能力。但是仍然存在Master节点的写压力的问题。<br> </p> 
<p>4、集群结构-Proxy型<br> <br> <img src="https://images2.imgbox.com/14/6c/G2JRxDUb_o.png" alt="在这里插入图片描述"><br> <br> 一些公司在上述的基础上增加了代理集群管理，开源了一些框架，比如Twemproxy，其实就是通过透明分片来实现多Master和多Salve。不过增加高可用的代价是，代理需要维护Failover需要自己实现。鱼和熊掌没有得兼。<br> </p> 
<p>5、集群结构-直连型<br> <br> <img src="https://images2.imgbox.com/ff/b4/NRa15KZz_o.png" alt="在这里插入图片描述"><br> <br> 从Redis3.0之后支持了redis-cluster模式。其采用的是无中心结构，有点类似于P2P网络。可以自动扩展，无代理，按照哈希槽分布存储。高可用，自动实现Failover。通过Raft实现M/S的角色处理。<br> <br> 代码的整体架构以及代码分析，以单机及主从为主，在遇到重点流程及后期时增加其它结构类型的相关源码分析。抓住重点，理清脉络，用古人的话来说“直击肯綮”。先是整体分析，然后再根据重点的数据结构和模块进行逐一分析。<br> 在前文提到过，Redis是一个单线程的基于多事件多路利用的C/S结构。其客户端既有官方提供的redis-cli，也有大量的第三方提供的基于其它语言的客户端。国内的各大公司几乎都封装了自己的客户端。所以，架构就说明了其流程，它一定是服务端启动监听，客户端连接并传送相关命令，然后服务端监听到数据后进行解析，丢给相关的事件处理器，然后再展开到Redis的相关处理逻辑。下面就分析其流程。</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-00AGSEf9-1576393984889)(img/redis_frame.png)]<br> </p> 
<p>说明：上述的图是从https://mp.weixin.qq.com/s/XJzu8yyVYZYmcOui_xXnvw中截取，如有侵权，请告知删除。</p> 
<h3><a id="_45"></a>二、流程</h3> 
<p>1、客户端<br> 老样子，先看代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> firstarg<span class="token punctuation">;</span>

    <span class="token comment">//相关的配置文件省略</span>
    config<span class="token punctuation">.</span>hostip <span class="token operator">=</span> <span class="token function">sdsnew</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>hostport <span class="token operator">=</span> <span class="token number">6379</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    config<span class="token punctuation">.</span>cluster_manager_command<span class="token punctuation">.</span>timeout <span class="token operator">=</span> CLUSTER_MANAGER_MIGRATE_TIMEOUT<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>cluster_manager_command<span class="token punctuation">.</span>pipeline <span class="token operator">=</span> CLUSTER_MANAGER_MIGRATE_PIPELINE<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>cluster_manager_command<span class="token punctuation">.</span>threshold <span class="token operator">=</span>
        CLUSTER_MANAGER_REBALANCE_THRESHOLD<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>cluster_manager_command<span class="token punctuation">.</span>backup_dir <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    pref<span class="token punctuation">.</span>hints <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    spectrum_palette <span class="token operator">=</span> spectrum_palette_color<span class="token punctuation">;</span>
    spectrum_palette_size <span class="token operator">=</span> spectrum_palette_color_size<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"FAKETTY"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>output <span class="token operator">=</span> OUTPUT_RAW<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        config<span class="token punctuation">.</span>output <span class="token operator">=</span> OUTPUT_STANDARD<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>mb_delim <span class="token operator">=</span> <span class="token function">sdsnew</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    firstarg <span class="token operator">=</span> <span class="token function">parseOptions</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    argc <span class="token operator">-</span><span class="token operator">=</span> firstarg<span class="token punctuation">;</span>
    argv <span class="token operator">+</span><span class="token operator">=</span> firstarg<span class="token punctuation">;</span>

    <span class="token function">parseEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Cluster Manager mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CLUSTER_MANAGER_MODE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        clusterManagerCommandProc \<span class="token operator">*</span>proc <span class="token operator">=</span> <span class="token function">validateClusterManagerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>proc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">sdsfree</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sdsfree</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>mb_delim<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">clusterManagerMode</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Latency mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>latency_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Latency distribution mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>latency_dist_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyDistMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Slave mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>slave_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendCapa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">slaveMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Get RDB mode.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>getrdb_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendCapa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getRDB</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Pipe mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>pipe_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pipeMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Find big keys</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>bigkeys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">findBigKeys</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Find large keys</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>memkeys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">findBigKeys</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>memkeys_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Find hot keys</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>hotkeys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">findHotKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Stat mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>stat_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> config<span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
        <span class="token function">statMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Scan mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>scan_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scanMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// LRU test mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>lru_test_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LRUTestMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Intrinsic latency mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>intrinsic_latency_mode<span class="token punctuation">)</span> <span class="token function">intrinsicLatencyMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Start interactive mode when no command is provided</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>eval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Ignore SIGPIPE in interactive mode to force a reconnect</span>
        <span class="token function">signal</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Note that in repl mode we don't abort on connection error.</span>
         <span class="token comment">// A new attempt will be performed for every command send.</span>
        <span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">repl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//传输命令</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Otherwise, we have some arguments to execute</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> REDIS_OK<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>eval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">evalMode</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">noninteractive</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span><span class="token function">convertToSds</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>因为是c程序，所以一定会是在main函数里启动。在这个函数里，其实只有三大部分，配置参数的设定，参数命令解析和模式选择。在模式选择中进行网络连接和模式设置以及需要发送相关的信号。先看一下参数解析的函数parseOptions：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">parseOptions</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> lastarg <span class="token operator">=</span> i<span class="token operator">==</span>argc<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lastarg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">sdsfree</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            config<span class="token punctuation">.</span>hostip <span class="token operator">=</span> <span class="token function">sdsnew</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token operator">++</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lastarg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"-v"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sds version <span class="token operator">=</span> <span class="token function">cliVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"redis-cli %s\n"</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sdsfree</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"-3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            config<span class="token punctuation">.</span>resp3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CLUSTER_MANAGER_MODE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cluster_manager_command<span class="token punctuation">.</span>argc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> argc <span class="token operator">&amp;&amp;</span> argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'-'</span><span class="token punctuation">)</span> j<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> cmd_argc <span class="token operator">=</span> j <span class="token operator">-</span> i<span class="token punctuation">;</span>
                config<span class="token punctuation">.</span>cluster_manager_command<span class="token punctuation">.</span>argc <span class="token operator">=</span> cmd_argc<span class="token punctuation">;</span>
                config<span class="token punctuation">.</span>cluster_manager_command<span class="token punctuation">.</span>argv <span class="token operator">=</span> argv <span class="token operator">+</span> i<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd_argc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> i <span class="token operator">=</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
                    <span class="token string">"Unrecognized option or bad number of args for: '%s'\n"</span><span class="token punctuation">,</span>
                    argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Likely the command name, stop here.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// --ldb requires --eval.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>eval_ldb <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>eval <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Options --ldb and --ldb-sync-mode require --eval.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Try %s --help for more information.\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">.</span>no_auth_warning <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>auth <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"Warning: Using a password with '-a' or '-u' option on the command"</span>
              <span class="token string">" line interface may not be safe.\n"</span><span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//其中一个调用的函数，可以看到命令的参数形式</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    sds version <span class="token operator">=</span> <span class="token function">cliVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
<span class="token string">"redis-cli %s\n"</span>
<span class="token string">"\n"</span>
<span class="token string">"Usage: redis-cli [OPTIONS] [cmd [arg [arg ...]]]\n"</span>
<span class="token string">"  -h &lt;hostname&gt;      Server hostname (default: 127.0.0.1).\n"</span>
<span class="token string">"  -p &lt;port&gt;          Server port (default: 6379).\n"</span>
<span class="token string">"  -s &lt;socket&gt;        Server socket (overrides hostname and port).\n"</span>
<span class="token string">"  -a &lt;password&gt;      Password to use when connecting to the server.\n"</span>
<span class="token string">"                     You can also use the "</span> REDIS_CLI_AUTH_ENV <span class="token string">" environment\n"</span>
<span class="token string">"                     variable to pass this password more safely\n"</span>
<span class="token string">"                     (if both are used, this argument takes predecence).\n"</span>
<span class="token string">"  -user &lt;username&gt;   Used to send ACL style 'AUTH username pass'. Needs -a.\n"</span>
<span class="token string">"  -pass &lt;password&gt;   Alias of -a for consistency with the new --user option.\n"</span>
<span class="token string">"  -u &lt;uri&gt;           Server URI.\n"</span>
<span class="token string">"  -r &lt;repeat&gt;        Execute specified command N times.\n"</span>
<span class="token string">"  -i &lt;interval&gt;      When -r is used, waits &lt;interval&gt; seconds per command.\n"</span>
<span class="token string">"                     It is possible to specify sub-second times like -i 0.1.\n"</span>
<span class="token string">"  -n &lt;db&gt;            Database number.\n"</span>
<span class="token string">"  -3                 Start session in RESP3 protocol mode.\n"</span>
<span class="token string">"  -x                 Read last argument from STDIN.\n"</span>
<span class="token string">"  -d &lt;delimiter&gt;     Multi-bulk delimiter in for raw formatting (default: \\n).\n"</span>
<span class="token string">"  -c                 Enable cluster mode (follow -ASK and -MOVED redirections).\n"</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> USE_OPENSSL</span>
<span class="token string">"  --tls              Establish a secure TLS connection.\n"</span>
<span class="token string">"  --cacert           CA Certificate file to verify with.\n"</span>
<span class="token string">"  --cacertdir        Directory where trusted CA certificates are stored.\n"</span>
<span class="token string">"                     If neither cacert nor cacertdir are specified, the default\n"</span>
<span class="token string">"                     system-wide trusted root certs configuration will apply.\n"</span>
<span class="token string">"  --cert             Client certificate to authenticate with.\n"</span>
<span class="token string">"  --key              Private key file to authenticate with.\n"</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token string">"  --raw              Use raw formatting for replies (default when STDOUT is\n"</span>
<span class="token string">"                     not a tty).\n"</span>
<span class="token string">"  --no-raw           Force formatted output even when STDOUT is not a tty.\n"</span>
<span class="token string">"  --csv              Output in CSV format.\n"</span>
<span class="token string">"  --stat             Print rolling stats about server: mem, clients, ...\n"</span>
<span class="token string">"  --latency          Enter a special mode continuously sampling latency.\n"</span>
<span class="token string">"                     If you use this mode in an interactive session it runs\n"</span>
<span class="token string">"                     forever displaying real-time stats. Otherwise if --raw or\n"</span>
<span class="token string">"                     --csv is specified, or if you redirect the output to a non\n"</span>
<span class="token string">"                     TTY, it samples the latency for 1 second (you can use\n"</span>
<span class="token string">"                     -i to change the interval), then produces a single output\n"</span>
<span class="token string">"                     and exits.\n"</span><span class="token punctuation">,</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
<span class="token string">"  --latency-history  Like --latency but tracking latency changes over time.\n"</span>
<span class="token string">"                     Default time interval is 15 sec. Change it using -i.\n"</span>
<span class="token string">"  --latency-dist     Shows latency as a spectrum, requires xterm 256 colors.\n"</span>
<span class="token string">"                     Default time interval is 1 sec. Change it using -i.\n"</span>
<span class="token string">"  --lru-test &lt;keys&gt;  Simulate a cache workload with an 80-20 distribution.\n"</span>
<span class="token string">"  --replica          Simulate a replica showing commands received from the master.\n"</span>
<span class="token string">"  --rdb &lt;filename&gt;   Transfer an RDB dump from remote server to local file.\n"</span>
<span class="token string">"  --pipe             Transfer raw Redis protocol from stdin to server.\n"</span>
<span class="token string">"  --pipe-timeout &lt;n&gt; In --pipe mode, abort with error if after sending all data.\n"</span>
<span class="token string">"                     no reply is received within &lt;n&gt; seconds.\n"</span>
<span class="token string">"                     Default timeout: %d. Use 0 to wait forever.\n"</span><span class="token punctuation">,</span>
    REDIS_CLI_DEFAULT_PIPE_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
<span class="token string">"  --bigkeys          Sample Redis keys looking for keys with many elements (complexity).\n"</span>
<span class="token string">"  --memkeys          Sample Redis keys looking for keys consuming a lot of memory.\n"</span>
<span class="token string">"  --memkeys-samples &lt;n&gt; Sample Redis keys looking for keys consuming a lot of memory.\n"</span>
<span class="token string">"                     And define number of key elements to sample\n"</span>
<span class="token string">"  --hotkeys          Sample Redis keys looking for hot keys.\n"</span>
<span class="token string">"                     only works when maxmemory-policy is \*lfu.\n"</span>
<span class="token string">"  --scan             List all keys using the SCAN command.\n"</span>
<span class="token string">"  --pattern &lt;pat&gt;    Useful with --scan to specify a SCAN pattern.\n"</span>
<span class="token string">"  --intrinsic-latency &lt;sec&gt; Run a test to measure intrinsic system latency.\n"</span>
<span class="token string">"                     The test will run for the specified amount of seconds.\n"</span>
<span class="token string">"  --eval &lt;file&gt;      Send an EVAL command using the Lua script at &lt;file&gt;.\n"</span>
<span class="token string">"  --ldb              Used with --eval enable the Redis Lua debugger.\n"</span>
<span class="token string">"  --ldb-sync-mode    Like --ldb but uses the synchronous Lua debugger, in\n"</span>
<span class="token string">"                     this mode the server is blocked and script changes are\n"</span>
<span class="token string">"                     not rolled back from the server memory.\n"</span>
<span class="token string">"  --cluster &lt;command&gt; [args...] [opts...]\n"</span>
<span class="token string">"                     Cluster Manager command and arguments (see below).\n"</span>
<span class="token string">"  --verbose          Verbose mode.\n"</span>
<span class="token string">"  --no-auth-warning  Don't show warning message when using password on command\n"</span>
<span class="token string">"                     line interface.\n"</span>
<span class="token string">"  --help             Output this help and exit.\n"</span>
<span class="token string">"  --version          Output version and exit.\n"</span>
<span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Using another fprintf call to avoid -Woverlength-strings compile warning</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
<span class="token string">"Cluster Manager Commands:\n"</span>
<span class="token string">"  Use --cluster help to list all available cluster manager commands.\n"</span>
<span class="token string">"\n"</span>
<span class="token string">"Examples:\n"</span>
<span class="token string">"  cat /etc/passwd | redis-cli -x set mypasswd\n"</span>
<span class="token string">"  redis-cli get mypasswd\n"</span>
<span class="token string">"  redis-cli -r 100 lpush mylist x\n"</span>
<span class="token string">"  redis-cli -r 100 -i 1 info | grep used_memory_human:\n"</span>
<span class="token string">"  redis-cli --eval myscript.lua key1 key2 , arg1 arg2 arg3\n"</span>
<span class="token string">"  redis-cli --scan --pattern '*:12345*'\n"</span>
<span class="token string">"\n"</span>
<span class="token string">"  (Note: when using --eval the comma separates KEYS[] from ARGV[] items)\n"</span>
<span class="token string">"\n"</span>
<span class="token string">"When no command is given, redis-cli starts in interactive mode.\n"</span>
<span class="token string">"Type \"help\" in interactive mode for information on available commands\n"</span>
<span class="token string">"and settings.\n"</span>
<span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sdsfree</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再看一个网络连接的函数cliConnect：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">cliConnect</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> flags <span class="token operator">&amp;</span> CC_FORCE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">redisFree</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostsocket <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            context <span class="token operator">=</span> <span class="token function">redisConnect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostip<span class="token punctuation">,</span>config<span class="token punctuation">.</span>hostport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            context <span class="token operator">=</span> <span class="token function">redisConnectUnix</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostsocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token operator">-&gt;</span>err <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>tls<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> \<span class="token operator">*</span>err <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliSecureConnection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">)</span> <span class="token operator">==</span> REDIS_ERR <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not negotiate a TLS connection: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                context <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token function">redisFree</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> REDIS_ERR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token operator">-&gt;</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> CC_QUIET<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Could not connect to Redis at "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostsocket <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"%s:%d: %s\n"</span><span class="token punctuation">,</span>
                        config<span class="token punctuation">.</span>hostip<span class="token punctuation">,</span>config<span class="token punctuation">.</span>hostport<span class="token punctuation">,</span>context<span class="token operator">-&gt;</span>errstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"%s: %s\n"</span><span class="token punctuation">,</span>
                        config<span class="token punctuation">.</span>hostsocket<span class="token punctuation">,</span>context<span class="token operator">-&gt;</span>errstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">redisFree</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> REDIS_ERR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// Set aggressive KEEP_ALIVE socket option in the Redis context socket</span>
        <span class="token comment">// in order to prevent timeouts caused by the execution of long</span>
        <span class="token comment">// commands. At the same time this improves the detection of real</span>
        <span class="token comment">// errors.</span>
        <span class="token function">anetKeepAlive</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> context<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> REDIS_CLI_KEEPALIVE_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Do AUTH, select the right DB, switch to RESP3 if needed.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> REDIS_OK<span class="token punctuation">)</span>
            <span class="token keyword">return</span> REDIS_ERR<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> REDIS_OK<span class="token punctuation">)</span>
            <span class="token keyword">return</span> REDIS_ERR<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cliSwitchProto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> REDIS_OK<span class="token punctuation">)</span>
            <span class="token keyword">return</span> REDIS_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> REDIS_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这段代码开始首先判断使用的上下文是否存在，如果存在就释放掉。然后根据hostsocket的类型来判断生成基于TCP还是UNIX来生成。它们最终都会调用redisConnectWithOptions函数来连接服务器：</p> 
<pre><code class="prism language-C">redisContext \*redisConnectWithOptions(const redisOptions *options) {
    redisContext \*c = redisContextInit(options);
    if (c == NULL) {
        return NULL;
    }
    if (!(options-&gt;options &amp; REDIS_OPT_NONBLOCK)) {
        c-&gt;flags |= REDIS_BLOCK;
    }
    if (options-&gt;options &amp; REDIS_OPT_REUSEADDR) {
        c-&gt;flags |= REDIS_REUSEADDR;
    }
    if (options-&gt;options &amp; REDIS_OPT_NOAUTOFREE) {
      c-&gt;flags |= REDIS_NO_AUTO_FREE;
    }

    if (options-&gt;type == REDIS_CONN_TCP) {
        redisContextConnectBindTcp(c, options-&gt;endpoint.tcp.ip,
                                   options-&gt;endpoint.tcp.port, options-&gt;timeout,
                                   options-&gt;endpoint.tcp.source_addr);
    } else if (options-&gt;type == REDIS_CONN_UNIX) {
        redisContextConnectUnix(c, options-&gt;endpoint.unix_socket,
                                options-&gt;timeout);
    } else if (options-&gt;type == REDIS_CONN_USERFD) {
        c-&gt;fd = options-&gt;endpoint.fd;
        c-&gt;flags |= REDIS_CONNECTED;
    } else {
        // Unknown type - FIXME - FREE
        return NULL;
    }
    if (options-&gt;timeout != NULL &amp;&amp; (c-&gt;flags &amp; REDIS_BLOCK) &amp;&amp; c-&gt;fd != REDIS_INVALID_FD) {
        redisContextSetTimeout(c, *options-&gt;timeout);
    }
    return c;
}
</code></pre> 
<p>最终在_redisContextConnectTcp这个函数中绑定相关的服务，并调用常见的网络连接函数：</p> 
<pre><code class="prism language-C">if (connect(s,p-&gt;ai_addr,p-&gt;ai_addrlen) == -1) {
......
}
</code></pre> 
<p>看一下Repl，这个函数会具体的把相关的命令和数据传输到报备端。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">repl</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    sds historyfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> history <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> \<span class="token operator">*</span>line<span class="token punctuation">;</span>
    <span class="token keyword">int</span> argc<span class="token punctuation">;</span>
    sds \<span class="token operator">*</span>argv<span class="token punctuation">;</span>

    <span class="token comment">// Initialize the help and, if possible, use the COMMAND command in order</span>
    <span class="token comment">// to retrieve missing entries.</span>
    <span class="token function">cliInitHelp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cliIntegrateHelp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    config<span class="token punctuation">.</span>interactive <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">linenoiseSetMultiLine</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">linenoiseSetCompletionCallback</span><span class="token punctuation">(</span>completionCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">linenoiseSetHintsCallback</span><span class="token punctuation">(</span>hintsCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">linenoiseSetFreeHintsCallback</span><span class="token punctuation">(</span>freeHintsCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Only use history and load the rc file when stdin is a tty.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        historyfile <span class="token operator">=</span> <span class="token function">getDotfilePath</span><span class="token punctuation">(</span>REDIS_CLI_HISTFILE_ENV<span class="token punctuation">,</span>REDIS_CLI_HISTFILE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//keep in-memory history always regardless if history file can be determined</span>
        history <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>historyfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">linenoiseHistoryLoad</span><span class="token punctuation">(</span>historyfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">cliLoadPreferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">cliRefreshPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> <span class="token function">linenoise</span><span class="token punctuation">(</span>context <span class="token operator">?</span> config<span class="token punctuation">.</span>prompt <span class="token punctuation">:</span> <span class="token string">"not connected&gt; "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> repeat <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> skipargs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> \<span class="token operator">*</span>endptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

            argv <span class="token operator">=</span> <span class="token function">cliSplitArgs</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token operator">&amp;</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// check if we have a repeat command option and</span>
             <span class="token comment">//need to skip the first arg</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>argv <span class="token operator">&amp;&amp;</span> argc <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                repeat <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>endptr<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>endptr <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ERANGE <span class="token operator">||</span> errno <span class="token operator">==</span> EINVAL <span class="token operator">||</span> repeat <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"Invalid redis-cli repeat command option value.\n"</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">sdsfreesplitres</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">linenoiseFree</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    skipargs <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    repeat <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Won't save auth command in history file</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>argv <span class="token operator">&amp;&amp;</span> argc <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">+</span>skipargs<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"auth"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>history<span class="token punctuation">)</span> <span class="token function">linenoiseHistoryAdd</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>historyfile<span class="token punctuation">)</span> <span class="token function">linenoiseHistorySave</span><span class="token punctuation">(</span>historyfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>argv <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Invalid argument(s)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">linenoiseFree</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"quit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                    <span class="token function">strcasecmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">':'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">cliSetPreferences</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span>argc<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">sdsfreesplitres</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">linenoiseFree</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"restart"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>eval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        config<span class="token punctuation">.</span>eval_ldb <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        config<span class="token punctuation">.</span>output <span class="token operator">=</span> OUTPUT_RAW<span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//Return to evalMode to restart the session.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Use 'restart' only in Lua debugging mode."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">sdsfree</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostip<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    config<span class="token punctuation">.</span>hostip <span class="token operator">=</span> <span class="token function">sdsnew</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    config<span class="token punctuation">.</span>hostport <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">cliRefreshPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">cliConnect</span><span class="token punctuation">(</span>CC_FORCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"clear"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">linenoiseClearScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">long</span> <span class="token keyword">long</span> start_time <span class="token operator">=</span> <span class="token function">mstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> elapsed<span class="token punctuation">;</span>

                    <span class="token function">issueCommandRepeat</span><span class="token punctuation">(</span>argc<span class="token operator">-</span>skipargs<span class="token punctuation">,</span> argv<span class="token operator">+</span>skipargs<span class="token punctuation">,</span> repeat<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// If our debugging session ended, show the EVAL final</span>
                     <span class="token comment">//reply</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>eval_ldb_end<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        config<span class="token punctuation">.</span>eval_ldb_end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token function">cliReadReply</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n(Lua debugging session ended%s)\n\n"</span><span class="token punctuation">,</span>
                            config<span class="token punctuation">.</span>eval_ldb_sync <span class="token operator">?</span> <span class="token string">""</span> <span class="token punctuation">:</span>
                            <span class="token string">" -- dataset changes rolled back"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    elapsed <span class="token operator">=</span> <span class="token function">mstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start_time<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>elapsed <span class="token operator">&gt;=</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span>
                        config<span class="token punctuation">.</span>output <span class="token operator">==</span> OUTPUT_STANDARD<span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(%.2fs)\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>elapsed<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Free the argument vector</span>
            <span class="token function">sdsfreesplitres</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// linenoise() returns malloc-ed lines like readline()</span>
        <span class="token function">linenoiseFree</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从代码中可以看到。其使用linenoise 这款优秀的命令行编辑库来接收输入。然后经issueCommandRepeat传送至cliSendCommand进行特殊命令的解析。</p> 
<pre><code class="prism language-C">static int cliSendCommand(int argc, char **argv, long repeat) {
    char \*command = argv[0];
    size_t \*argvlen;
    int j, output_raw;

    if (!config.eval_ldb &amp;&amp; // In debugging mode, let's pass "help" to Redis.
        (!strcasecmp(command,"help") || !strcasecmp(command,"?"))) {
        cliOutputHelp(--argc, ++argv);
        return REDIS_OK;
    }

    if (context == NULL) return REDIS_ERR;

    output_raw = 0;
    if (!strcasecmp(command,"info") ||
        !strcasecmp(command,"lolwut") ||
        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,"debug") &amp;&amp;
                       !strcasecmp(argv[1],"htstats")) ||
        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,"debug") &amp;&amp;
                       !strcasecmp(argv[1],"htstats-key")) ||
        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,"memory") &amp;&amp;
                      (!strcasecmp(argv[1],"malloc-stats") ||
                       !strcasecmp(argv[1],"doctor"))) ||
        (argc == 2 &amp;&amp; !strcasecmp(command,"cluster") &amp;&amp;
                      (!strcasecmp(argv[1],"nodes") ||
                       !strcasecmp(argv[1],"info"))) ||
        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,"client") &amp;&amp;
                       !strcasecmp(argv[1],"list")) ||
        (argc == 3 &amp;&amp; !strcasecmp(command,"latency") &amp;&amp;
                       !strcasecmp(argv[1],"graph")) ||
        (argc == 2 &amp;&amp; !strcasecmp(command,"latency") &amp;&amp;
                       !strcasecmp(argv[1],"doctor")))
    {
        output_raw = 1;
    }

......

    // Negative repeat is allowed and causes infinite loop,
       works well with the interval option.
    while(repeat &lt; 0 || repeat-- &gt; 0) {
        redisAppendCommandArgv(context,argc,(const char**)argv,argvlen);
        while (config.monitor_mode) {
            if (cliReadReply(output_raw) != REDIS_OK) exit(1);
            fflush(stdout);
        }

......
        if (config.slave_mode) {
            printf("Entering replica output mode...  (press Ctrl-C to quit)\n");
            slaveMode();
            config.slave_mode = 0;
            zfree(argvlen);
            return REDIS_ERR;  // Error = slaveMode lost connection to master
        }

        if (cliReadReply(output_raw) != REDIS_OK) {
            zfree(argvlen);
            return REDIS_ERR;
        } else {
......
    }

    zfree(argvlen);
    return REDIS_OK;
}
</code></pre> 
<p>这样基本的客户端的流程就运行起来了。</p> 
<p>2、服务端<br> 服务端也要从主函数开始：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> timeval tv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> INIT_SETPROCTITLE_REPLACEMENT</span>
    <span class="token function">spt_init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token function">setlocale</span><span class="token punctuation">(</span>LC_COLLATE<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tzset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zmalloc_set_oom_handler</span><span class="token punctuation">(</span>redisOutOfMemoryHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    uint8_t hashseed<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">getRandomBytes</span><span class="token punctuation">(</span>hashseed<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>hashseed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dictSetHashFunctionSeed</span><span class="token punctuation">(</span>hashseed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>sentinel_mode <span class="token operator">=</span> <span class="token function">checkForSentinelMode</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ACLInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">moduleInitModulesSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tlsInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    server<span class="token punctuation">.</span>executable <span class="token operator">=</span> <span class="token function">getAbsolutePath</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>exec_argv <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>argc<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>exec_argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> server<span class="token punctuation">.</span>exec_argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">zstrdup</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>sentinel_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">initSentinelConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initSentinel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"redis-check-rdb"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">redis_check_rdb_main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"redis-check-aof"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">redis_check_aof_main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        sds options <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> \<span class="token operator">*</span>configfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-v"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--version"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--help"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--test-memory"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">memtest</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Please specify the amount of memory to test in megabytes.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Example: ./redis-server --test-memory 4096\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'-'</span> <span class="token operator">||</span> argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            configfile <span class="token operator">=</span> argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>configfile <span class="token operator">=</span> <span class="token function">getAbsolutePath</span><span class="token punctuation">(</span>configfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">zfree</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>exec_argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>exec_argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">zstrdup</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>configfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            j<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">!=</span> argc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'-'</span> <span class="token operator">&amp;&amp;</span> argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--check-rdb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    j<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sdslen</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token function">sdscat</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                options <span class="token operator">=</span> <span class="token function">sdscat</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                options <span class="token operator">=</span> <span class="token function">sdscat</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

                options <span class="token operator">=</span> <span class="token function">sdscatrepr</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                options <span class="token operator">=</span> <span class="token function">sdscat</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            j<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>sentinel_mode <span class="token operator">&amp;&amp;</span> configfile <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>configfile <span class="token operator">==</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
                <span class="token string">"Sentinel config from STDIN not allowed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
                <span class="token string">"Sentinel needs config file on disk to save state.  Exiting..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">resetServerSaveParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">loadServerConfig</span><span class="token punctuation">(</span>configfile<span class="token punctuation">,</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
        <span class="token string">"Redis version=%s, bits=%d, commit=%s, modified=%d, pid=%d, just started"</span><span class="token punctuation">,</span>
            REDIS_VERSION<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">64</span> <span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
            <span class="token function">redisGitSHA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">strtol</span><span class="token punctuation">(</span><span class="token function">redisGitDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>sentinel_mode <span class="token operator">?</span> <span class="token string">"sentinel"</span> <span class="token punctuation">:</span> <span class="token string">"redis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Configuration loaded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    server<span class="token punctuation">.</span>supervised <span class="token operator">=</span> <span class="token function">redisIsSupervised</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>supervised_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> background <span class="token operator">=</span> server<span class="token punctuation">.</span>daemonize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>supervised<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>background<span class="token punctuation">)</span> <span class="token function">daemonize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">initServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>background <span class="token operator">||</span> server<span class="token punctuation">.</span>pidfile<span class="token punctuation">)</span> <span class="token function">createPidFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">redisSetProcTitle</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">redisAsciiArt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkTcpBacklogSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>sentinel_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Server initialized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __linux__</span>
        <span class="token function">linuxMemoryWarnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token function">moduleLoadFromQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ACLLoadUsersAtStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">InitServerLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">loadDataFromDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>cluster_enabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">verifyClusterConfigWithData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
                    <span class="token string">"You can't have keys in a DB different than DB 0 when in "</span>
                    <span class="token string">"Cluster mode. Exiting."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>ipfd_count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> server<span class="token punctuation">.</span>tlsfd_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"Ready to accept connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>sofd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"The server is now ready to accept connections at %s"</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>unixsocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">InitServerLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sentinelIsRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>maxmemory <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?"</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">aeSetBeforeSleepProc</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>beforeSleep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">aeSetAfterSleepProc</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>afterSleep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">aeMain</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">aeDeleteEventLoop</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>服务端的代码相对来说要启动的多一些，要把各种情况下的参数都要进行判断然后分别进行初始化，配置相关的处理句柄，比如哨兵和Panic的相关处理配置。然后同样是参数的处理，服务端是有日志管理 的，所以如果有什么异常都要写入日志中。如果设置为后台运行就启动为守护进程。它创建子进程的方法就两行代码：</p> 
<pre><code class="prism language-C">void daemonize(void) {
    int fd;

    if (fork() != 0) exit(0);
    setsid();

......
}
</code></pre> 
<p>然后看一下initServer：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">initServer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>

    <span class="token function">signal</span><span class="token punctuation">(</span>SIGHUP<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setupSignalHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>syslog_enabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">openlog</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>syslog_ident<span class="token punctuation">,</span> LOG_PID <span class="token operator">|</span> LOG_NDELAY <span class="token operator">|</span> LOG_NOWAIT<span class="token punctuation">,</span>
            server<span class="token punctuation">.</span>syslog_facility<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    server<span class="token punctuation">.</span>hz <span class="token operator">=</span> server<span class="token punctuation">.</span>config_hz<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>current_client <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>fixed_time_expire <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>clients <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>clients_index <span class="token operator">=</span> <span class="token function">raxNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>clients_to_close <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>slaves <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>monitors <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>clients_pending_write <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>clients_pending_read <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>slaveseldb <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>unblocked_clients <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>ready_keys <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>clients_waiting_acks <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>get_ack_from_slaves <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>clients_paused <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>system_memory_size <span class="token operator">=</span> <span class="token function">zmalloc_get_memory_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>tls_port <span class="token operator">&amp;&amp;</span> <span class="token function">tlsConfigure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">.</span>tls_ctx_config<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Failed to configure TLS. Check logs for more info."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">createSharedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adjustOpenFilesLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">aeCreateEventLoop</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxclients<span class="token operator">+</span>CONFIG_FDSET_INCR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>el <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
            <span class="token string">"Failed creating the event loop. Error message: '%s'"</span><span class="token punctuation">,</span>
            <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    server<span class="token punctuation">.</span>db <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>redisDb<span class="token punctuation">)</span><span class="token operator">*</span>server<span class="token punctuation">.</span>dbnum<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>port <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">listenToPort</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>port<span class="token punctuation">,</span>server<span class="token punctuation">.</span>ipfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>server<span class="token punctuation">.</span>ipfd_count<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>tls_port <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">listenToPort</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>tls_port<span class="token punctuation">,</span>server<span class="token punctuation">.</span>tlsfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>server<span class="token punctuation">.</span>tlsfd_count<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>unixsocket <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">unlink</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>unixsocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>sofd <span class="token operator">=</span> <span class="token function">anetUnixServer</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>neterr<span class="token punctuation">,</span>server<span class="token punctuation">.</span>unixsocket<span class="token punctuation">,</span>
            server<span class="token punctuation">.</span>unixsocketperm<span class="token punctuation">,</span> server<span class="token punctuation">.</span>tcp_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>sofd <span class="token operator">==</span> ANET_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Opening Unix socket: %s"</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>neterr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">anetNonBlock</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>server<span class="token punctuation">.</span>sofd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>ipfd_count <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>tlsfd_count <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>sofd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Configured to not listen anywhere, exiting."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>dict <span class="token operator">=</span> <span class="token function">dictCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dbDictType<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>expires <span class="token operator">=</span> <span class="token function">dictCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keyptrDictType<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>expires_cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>blocking_keys <span class="token operator">=</span> <span class="token function">dictCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keylistDictType<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>ready_keys <span class="token operator">=</span> <span class="token function">dictCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>objectKeyPointerValueDictType<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>watched_keys <span class="token operator">=</span> <span class="token function">dictCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keylistDictType<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">=</span> j<span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>avg_ttl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>defrag_later <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">listSetFreeMethod</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>defrag_later<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sdsfree<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">evictionPoolAlloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>pubsub_channels <span class="token operator">=</span> <span class="token function">dictCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keylistDictType<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>pubsub_patterns <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">listSetFreeMethod</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>pubsub_patterns<span class="token punctuation">,</span>freePubsubPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">listSetMatchMethod</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>pubsub_patterns<span class="token punctuation">,</span>listMatchPubsubPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>cronloops <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>module_child_pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_child_type <span class="token operator">=</span> RDB_CHILD_TYPE_NONE<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_pipe_conns <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_pipe_numconns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_pipe_numconns_writing <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_pipe_buff <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_pipe_bufflen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_bgsave_scheduled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>child_info_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>child_info_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>child_info_data<span class="token punctuation">.</span>magic <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">aofRewriteBufferReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>aof_buf <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>lastsave <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>lastbgsave_try <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   
    server<span class="token punctuation">.</span>rdb_save_time_last <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>rdb_save_time_start <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">resetServerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    server<span class="token punctuation">.</span>stat_starttime <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>stat_peak_memory <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>stat_rdb_cow_bytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>stat_aof_cow_bytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>stat_module_cow_bytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>cron_malloc_stats<span class="token punctuation">.</span>zmalloc_used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>cron_malloc_stats<span class="token punctuation">.</span>process_rss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>cron_malloc_stats<span class="token punctuation">.</span>allocator_allocated <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>cron_malloc_stats<span class="token punctuation">.</span>allocator_active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>cron_malloc_stats<span class="token punctuation">.</span>allocator_resident <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>lastbgsave_status <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>aof_last_write_status <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>aof_last_write_errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>repl_good_slaves_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateTimeEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> serverCron<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Can't create event loop timers."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>ipfd_count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> server<span class="token punctuation">.</span>ipfd<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> AE_READABLE<span class="token punctuation">,</span>
            acceptTcpHandler<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">serverPanic</span><span class="token punctuation">(</span>
                    <span class="token string">"Unrecoverable error creating server.ipfd file event."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>tlsfd_count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> server<span class="token punctuation">.</span>tlsfd<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> AE_READABLE<span class="token punctuation">,</span>
            acceptTLSHandler<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">serverPanic</span><span class="token punctuation">(</span>
                    <span class="token string">"Unrecoverable error creating server.tlsfd file event."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>sofd <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>server<span class="token punctuation">.</span>sofd<span class="token punctuation">,</span>AE_READABLE<span class="token punctuation">,</span>
        acceptUnixHandler<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span> <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Unrecoverable error creating server.sofd file event."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> server<span class="token punctuation">.</span>module_blocked_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AE_READABLE<span class="token punctuation">,</span>
        moduleBlockedClientPipeReadable<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">serverPanic</span><span class="token punctuation">(</span>
                <span class="token string">"Error registering the readable event for the module "</span>
                <span class="token string">"blocked clients subsystem."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_state <span class="token operator">==</span> AOF_ON<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        server<span class="token punctuation">.</span>aof_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_filename<span class="token punctuation">,</span>
                               O_WRONLY<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_CREAT<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Can't open the append-only file: %s"</span><span class="token punctuation">,</span>
                <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>arch_bits <span class="token operator">==</span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>maxmemory <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with 'noeviction' policy now."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>maxmemory <span class="token operator">=</span> <span class="token number">3072LL</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">=</span> MAXMEMORY_NO_EVICTION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>cluster_enabled<span class="token punctuation">)</span> <span class="token function">clusterInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">replicationScriptCacheInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scriptingInit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">slowlogInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyMonitorInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同样是配置一大批的参数，然后创建共享对象（后面会分析），调整文件限制。然后网络监听：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">listenToPort</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>bindaddr_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> server<span class="token punctuation">.</span>bindaddr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>bindaddr_count <span class="token operator">||</span> j <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>bindaddr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> unsupported <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            fds<span class="token punctuation">[</span>\<span class="token operator">*</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">anetTcp6Server</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>neterr<span class="token punctuation">,</span>port<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>
                server<span class="token punctuation">.</span>tcp_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token operator">*</span>count<span class="token punctuation">]</span> <span class="token operator">!=</span> ANET_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">anetNonBlock</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>fds<span class="token punctuation">[</span><span class="token operator">*</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>\<span class="token operator">*</span>count<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAFNOSUPPORT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                unsupported<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Not listening to IPv6: unsupported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>count <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> unsupported<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                fds<span class="token punctuation">[</span>\<span class="token operator">*</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">anetTcpServer</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>neterr<span class="token punctuation">,</span>port<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>
                    server<span class="token punctuation">.</span>tcp_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token operator">*</span>count<span class="token punctuation">]</span> <span class="token operator">!=</span> ANET_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">anetNonBlock</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>fds<span class="token punctuation">[</span><span class="token operator">*</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">(</span>\<span class="token operator">*</span>count<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAFNOSUPPORT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    unsupported<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Not listening to IPv4: unsupported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>count <span class="token operator">+</span> unsupported <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strchr</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>bindaddr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            fds<span class="token punctuation">[</span>\<span class="token operator">*</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">anetTcp6Server</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>neterr<span class="token punctuation">,</span>port<span class="token punctuation">,</span>server<span class="token punctuation">.</span>bindaddr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>
                server<span class="token punctuation">.</span>tcp_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

            fds<span class="token punctuation">[</span>\<span class="token operator">*</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">anetTcpServer</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>neterr<span class="token punctuation">,</span>port<span class="token punctuation">,</span>server<span class="token punctuation">.</span>bindaddr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>
                server<span class="token punctuation">.</span>tcp_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token operator">*</span>count<span class="token punctuation">]</span> <span class="token operator">==</span> ANET_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
                <span class="token string">"Could not create server TCP listening socket %s:%d: %s"</span><span class="token punctuation">,</span>
                server<span class="token punctuation">.</span>bindaddr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">?</span> server<span class="token punctuation">.</span>bindaddr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
                port<span class="token punctuation">,</span> server<span class="token punctuation">.</span>neterr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ENOPROTOOPT     <span class="token operator">||</span> errno <span class="token operator">==</span> EPROTONOSUPPORT <span class="token operator">||</span>
                    errno <span class="token operator">==</span> ESOCKTNOSUPPORT <span class="token operator">||</span> errno <span class="token operator">==</span> EPFNOSUPPORT <span class="token operator">||</span>
                    errno <span class="token operator">==</span> EAFNOSUPPORT    <span class="token operator">||</span> errno <span class="token operator">==</span> EADDRNOTAVAIL<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">anetNonBlock</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>fds<span class="token punctuation">[</span><span class="token operator">*</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>\<span class="token operator">*</span>count<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这个函数里分别创建基于IPV4和IPV6的连接。处理各种异常，设置默认的非阻塞参数。这种方式根据实际的配置不同会产生几种不同的设置的方法，比如TCP或是UNIX，有没有TLS等。其后开始创建数据库并初始化相关状态。然后创建事件处理的句柄：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">,</span>
        aeFileProc <span class="token operator">*</span>proc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> eventLoop<span class="token operator">-&gt;</span>setsize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        errno <span class="token operator">=</span> ERANGE<span class="token punctuation">;</span>
        <span class="token keyword">return</span> AE_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    aeFileEvent \<span class="token operator">*</span>fe <span class="token operator">=</span> <span class="token operator">&amp;</span>eventLoop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeApiAddEvent</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> mask<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> AE_ERR<span class="token punctuation">;</span>
    fe<span class="token operator">-&gt;</span>mask <span class="token operator">|</span><span class="token operator">=</span> mask<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mask <span class="token operator">&amp;</span> AE_READABLE<span class="token punctuation">)</span> fe<span class="token operator">-&gt;</span>rfileProc <span class="token operator">=</span> proc<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mask <span class="token operator">&amp;</span> AE_WRITABLE<span class="token punctuation">)</span> fe<span class="token operator">-&gt;</span>wfileProc <span class="token operator">=</span> proc<span class="token punctuation">;</span>
    fe<span class="token operator">-&gt;</span>clientData <span class="token operator">=</span> clientData<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;</span> eventLoop<span class="token operator">-&gt;</span>maxfd<span class="token punctuation">)</span>
        eventLoop<span class="token operator">-&gt;</span>maxfd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">return</span> AE_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">acceptTcpHandler</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>el<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> cport<span class="token punctuation">,</span> cfd<span class="token punctuation">,</span> max <span class="token operator">=</span> MAX_ACCEPTS_PER_CALL<span class="token punctuation">;</span>
    <span class="token keyword">char</span> cip<span class="token punctuation">[</span>NET_IP_STR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>privdata<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>max<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cfd <span class="token operator">=</span> <span class="token function">anetTcpAccept</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>neterr<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> cip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cfd <span class="token operator">==</span> ANET_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EWOULDBLOCK<span class="token punctuation">)</span>
                <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
                    <span class="token string">"Accepting client connection: %s"</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>neterr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_VERBOSE<span class="token punctuation">,</span><span class="token string">"Accepted %s:%d"</span><span class="token punctuation">,</span> cip<span class="token punctuation">,</span> cport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">acceptCommonHandler</span><span class="token punctuation">(</span><span class="token function">connCreateAcceptedSocket</span><span class="token punctuation">(</span>cfd<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>cip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">anetTcpAccept</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>err<span class="token punctuation">,</span> <span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">,</span> size_t ip_len<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>port<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_storage sa<span class="token punctuation">;</span>
    socklen_t salen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">anetGenericAccept</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>s<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span><span class="token operator">&amp;</span>salen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ANET_ERR<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span>ss_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> sockaddr_in \<span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sa<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>ip<span class="token punctuation">,</span>ip_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>port<span class="token punctuation">)</span> \<span class="token operator">*</span>port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> sockaddr_in6 \<span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in6 \<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sa<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>ip<span class="token punctuation">,</span>ip_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>port<span class="token punctuation">)</span> \<span class="token operator">*</span>port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>sin6_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">acceptCommonHandler</span><span class="token punctuation">(</span>connection <span class="token operator">*</span>conn<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    client \<span class="token operator">*</span>c<span class="token punctuation">;</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> server<span class="token punctuation">.</span>maxclients<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> \<span class="token operator">*</span>err <span class="token operator">=</span> <span class="token string">"-ERR max number of clients reached\r\n"</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connWrite</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span>err<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span>
        server<span class="token punctuation">.</span>stat_rejected_conn<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">connClose</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> conninfo<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
            <span class="token string">"Error registering fd event for the new client: %s (conn: %s)"</span><span class="token punctuation">,</span>
            <span class="token function">connGetLastError</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">connGetInfo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> conninfo<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>conninfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">connClose</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    c<span class="token operator">-&gt;</span>flags <span class="token operator">|</span><span class="token operator">=</span> flags<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connAccept</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> clientAcceptHandler<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> conninfo<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>
                <span class="token string">"Error accepting a client connection: %s (conn: %s)"</span><span class="token punctuation">,</span>
                <span class="token function">connGetLastError</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">connGetInfo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> conninfo<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>conninfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">freeClient</span><span class="token punctuation">(</span><span class="token function">connGetPrivateData</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>需要注意的使用aeCreateFileEvent可以注册相关的事件处理方式，比如TLS，PIPE等。在initServer函数最后，初始化相关的日志和监视器等。<br> 回到主函数，接下来就是相关的一系列的检查和相关用户的加载，数据的加载loadDataFromDisk()，在InitServerLast中创建相关的IO线程并处理内存大小。如果是哨兵模式则启动它。最后是最关键的几个函数启动：</p> 
<pre><code class="prism language-c"><span class="token function">aeSetBeforeSleepProc</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>beforeSleep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">aeSetAfterSleepProc</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>afterSleep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">aeMain</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">aeDeleteEventLoop</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>也就是说，又启动了一个网络的Main函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">aeMain</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    eventLoop<span class="token operator">-&gt;</span>stop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventLoop<span class="token operator">-&gt;</span>stop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token operator">-&gt;</span>beforesleep <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            eventLoop<span class="token operator">-&gt;</span><span class="token function">beforesleep</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">aeProcessEvents</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> AE_ALL_EVENTS<span class="token operator">|</span>AE_CALL_AFTER_SLEEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">aeProcessEvents</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> processed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> numevents<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_TIME_EVENTS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_FILE_EVENTS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token operator">-&gt;</span>maxfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_TIME_EVENTS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_DONT_WAIT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> j<span class="token punctuation">;</span>
        aeTimeEvent \<span class="token operator">*</span>shortest <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> timeval tv<span class="token punctuation">,</span> \<span class="token operator">*</span>tvp<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_TIME_EVENTS <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_DONT_WAIT<span class="token punctuation">)</span><span class="token punctuation">)</span>
            shortest <span class="token operator">=</span> <span class="token function">aeSearchNearestTimer</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shortest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> now_sec<span class="token punctuation">,</span> now_ms<span class="token punctuation">;</span>

            <span class="token function">aeGetTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now_sec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>now_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tvp <span class="token operator">=</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">;</span>

            <span class="token keyword">long</span> <span class="token keyword">long</span> ms <span class="token operator">=</span>
                <span class="token punctuation">(</span>shortest<span class="token operator">-&gt;</span>when_sec <span class="token operator">-</span> now_sec<span class="token punctuation">)</span>\<span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">+</span>
                shortest<span class="token operator">-&gt;</span>when_ms <span class="token operator">-</span> now_ms<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ms <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                tvp<span class="token operator">-&gt;</span>tv_sec <span class="token operator">=</span> ms<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
                tvp<span class="token operator">-&gt;</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span>ms <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span>\<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                tvp<span class="token operator">-&gt;</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                tvp<span class="token operator">-&gt;</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_DONT_WAIT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                tvp <span class="token operator">=</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

                tvp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AE_DONT_WAIT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            tvp <span class="token operator">=</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        numevents <span class="token operator">=</span> <span class="token function">aeApiPoll</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> tvp<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token operator">-&gt;</span>aftersleep <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> flags <span class="token operator">&amp;</span> AE_CALL_AFTER_SLEEP<span class="token punctuation">)</span>
            eventLoop<span class="token operator">-&gt;</span><span class="token function">aftersleep</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> numevents<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            aeFileEvent \<span class="token operator">*</span>fe <span class="token operator">=</span> <span class="token operator">&amp;</span>eventLoop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>eventLoop<span class="token operator">-&gt;</span>fired<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> mask <span class="token operator">=</span> eventLoop<span class="token operator">-&gt;</span>fired<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>mask<span class="token punctuation">;</span>
            <span class="token keyword">int</span> fd <span class="token operator">=</span> eventLoop<span class="token operator">-&gt;</span>fired<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
            <span class="token keyword">int</span> fired <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


            <span class="token keyword">int</span> invert <span class="token operator">=</span> fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> AE_BARRIER<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>invert <span class="token operator">&amp;&amp;</span> fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> mask <span class="token operator">&amp;</span> AE_READABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                fe<span class="token operator">-&gt;</span><span class="token function">rfileProc</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span>fd<span class="token punctuation">,</span>fe<span class="token operator">-&gt;</span>clientData<span class="token punctuation">,</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fired<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> mask <span class="token operator">&amp;</span> AE_WRITABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fired <span class="token operator">||</span> fe<span class="token operator">-&gt;</span>wfileProc <span class="token operator">!=</span> fe<span class="token operator">-&gt;</span>rfileProc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fe<span class="token operator">-&gt;</span><span class="token function">wfileProc</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span>fd<span class="token punctuation">,</span>fe<span class="token operator">-&gt;</span>clientData<span class="token punctuation">,</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fired<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>invert <span class="token operator">&amp;&amp;</span> fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> mask <span class="token operator">&amp;</span> AE_READABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fired <span class="token operator">||</span> fe<span class="token operator">-&gt;</span>wfileProc <span class="token operator">!=</span> fe<span class="token operator">-&gt;</span>rfileProc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fe<span class="token operator">-&gt;</span><span class="token function">rfileProc</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span>fd<span class="token punctuation">,</span>fe<span class="token operator">-&gt;</span>clientData<span class="token punctuation">,</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fired<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            processed<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_TIME_EVENTS<span class="token punctuation">)</span>
        processed <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">processTimeEvents</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> processed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这玩意儿是不是像Windows窗口里的消息循环的代码。在下面的事件处理函数中，分别处理不同的事件。处理事件的是一个函数指针，在外面初始化好。再看一下beforeSleep和afterSleep两个函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">beforeSleep</span><span class="token punctuation">(</span><span class="token keyword">struct</span> aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Handle TLS pending data. (must be done before flushAppendOnlyFile)</span>
    <span class="token function">tlsProcessPendingData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If tls still has pending unread data don't sleep at all.</span>
    <span class="token function">aeSetDontWait</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> <span class="token function">tlsHasPendingData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>cluster_enabled<span class="token punctuation">)</span> <span class="token function">clusterBeforeSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>active_expire_enabled <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>masterhost <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">activeExpireCycle</span><span class="token punctuation">(</span>ACTIVE_EXPIRE_CYCLE_FAST<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>get_ack_from_slaves<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        robj <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span><span class="token string">"REPLCONF"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span><span class="token string">"GETACK"</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Not used argument.</span>
        <span class="token function">replicationFeedSlaves</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">,</span> server<span class="token punctuation">.</span>slaveseldb<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">decrRefCount</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">decrRefCount</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">decrRefCount</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>get_ack_from_slaves <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_waiting_acks<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">processClientsWaitingReplicas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">moduleCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">moduleHandleBlockedClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Try to process pending commands for clients that were just unblocked.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>unblocked_clients<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">processUnblockedClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write the AOF buffer on disk</span>
    <span class="token function">flushAppendOnlyFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Handle writes with pending output buffers.</span>
    <span class="token function">handleClientsWithPendingWritesUsingThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Close clients that need to be closed asynchronous</span>
    <span class="token function">freeClientsInAsyncFreeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">moduleCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">moduleReleaseGIL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">afterSleep</span><span class="token punctuation">(</span><span class="token keyword">struct</span> aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">moduleCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">moduleAcquireGIL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleClientsWithPendingReadsUsingThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> 
<p>beforeSleep用来处理非集群模式下的故障处理，处理过期KEY，处理阻塞的客户端并AOF缓冲区到硬盘。而后者在多路复用调用后被立刻调用。在前文的InitServerLast中，会调用initThreadedIO，这个函数会创建相关的读写线程IOThreadMain：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">IOThreadMain</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>myid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            client \<span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>io_threads_op <span class="token operator">==</span> IO_THREADS_OP_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">writeToClient</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>io_threads_op <span class="token operator">==</span> IO_THREADS_OP_READ<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">readQueryFromClient</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"io_threads_op value is unknown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">listEmpty</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        io_threads_pending<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tio_debug<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%ld] Done\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">readQueryFromClient</span><span class="token punctuation">(</span>connection <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    client \<span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">connGetPrivateData</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> nread<span class="token punctuation">,</span> readlen<span class="token punctuation">;</span>
    size_t qblen<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">postponeClientRead</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    readlen <span class="token operator">=</span> PROTO_IOBUF_LEN<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>reqtype <span class="token operator">==</span> PROTO_REQ_MULTIBULK <span class="token operator">&amp;&amp;</span> c<span class="token operator">-&gt;</span>multibulklen <span class="token operator">&amp;&amp;</span> c<span class="token operator">-&gt;</span>bulklen <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token operator">&amp;&amp;</span> c<span class="token operator">-&gt;</span>bulklen <span class="token operator">&gt;=</span> PROTO_MBULK_BIG_ARG<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ssize_t remaining <span class="token operator">=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>bulklen<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">sdslen</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>querybuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> remaining <span class="token operator">&lt;</span> readlen<span class="token punctuation">)</span> readlen <span class="token operator">=</span> remaining<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    qblen <span class="token operator">=</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>querybuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>querybuf_peak <span class="token operator">&lt;</span> qblen<span class="token punctuation">)</span> c<span class="token operator">-&gt;</span>querybuf_peak <span class="token operator">=</span> qblen<span class="token punctuation">;</span>
    c<span class="token operator">-&gt;</span>querybuf <span class="token operator">=</span> <span class="token function">sdsMakeRoomFor</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>querybuf<span class="token punctuation">,</span> readlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nread <span class="token operator">=</span> <span class="token function">connRead</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>conn<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>querybuf<span class="token operator">+</span>qblen<span class="token punctuation">,</span> readlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connGetState</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">==</span> CONN_STATE_CONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_VERBOSE<span class="token punctuation">,</span> <span class="token string">"Reading from client: %s"</span><span class="token punctuation">,</span><span class="token function">connGetLastError</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">freeClientAsync</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_VERBOSE<span class="token punctuation">,</span> <span class="token string">"Client closed connection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">freeClientAsync</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> CLIENT_MASTER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token operator">-&gt;</span>pending_querybuf <span class="token operator">=</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>pending_querybuf<span class="token punctuation">,</span>
                                        c<span class="token operator">-&gt;</span>querybuf<span class="token operator">+</span>qblen<span class="token punctuation">,</span>nread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">sdsIncrLen</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>querybuf<span class="token punctuation">,</span>nread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    c<span class="token operator">-&gt;</span>lastinteraction <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> CLIENT_MASTER<span class="token punctuation">)</span> c<span class="token operator">-&gt;</span>read_reploff <span class="token operator">+</span><span class="token operator">=</span> nread<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>stat_net_input_bytes <span class="token operator">+</span><span class="token operator">=</span> nread<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sdslen</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>querybuf<span class="token punctuation">)</span> <span class="token operator">&gt;</span> server<span class="token punctuation">.</span>client_max_querybuf_len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sds ci <span class="token operator">=</span> <span class="token function">catClientInfoString</span><span class="token punctuation">(</span><span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> bytes <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        bytes <span class="token operator">=</span> <span class="token function">sdscatrepr</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>querybuf<span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Closing client that reached max query buffer length: %s (qbuf initial bytes: %s)"</span><span class="token punctuation">,</span> ci<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>ci<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">freeClientAsync</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

     <span class="token function">processInputBufferAndReplicate</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果熟悉SOCKET编程的应该就明白了，在readQueryFromClient开启了数据通信的流程。更具体的解析分析部分，此处不再展开，在后面的部分中会逐一分析。回复亦是如此，在Event事件中调用handleClientsWithPendingWrites：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">sendReplyToClient</span><span class="token punctuation">(</span>connection <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    client \<span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">connGetPrivateData</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeToClient</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过上述客户端和服务端的连接和通信，一个完整的通信链路就建立了起来。整体的redis的流程也跑了起来。</p> 
<h3><a id="_1431"></a>三、技术优势</h3> 
<p>在开源的技术框架里，redis的源码算是相当清爽的。简单明了，这就是redis的优势。这在其内部也是如此，数据结构，通信方式等等。简单意味着易维护和应用，明了意味着易于学习和二次开发。实际上，redis的应用也证明了这些。几乎国内所有的大公司的缓存都可以找到redis的身影。<br> <img src="https://images2.imgbox.com/d2/0e/A6tc7CiK_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ae86948ca882ea791d35ed1b5c11e4ff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">博客搬家声明</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6e1bed9a0db9cedcf043e1fab7a41569/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">spring 源码分析 平台事务管理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>