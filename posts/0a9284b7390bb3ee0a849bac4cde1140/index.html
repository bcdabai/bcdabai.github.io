<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2.Echarts和RabbiMq - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2.Echarts和RabbiMq" />
<meta property="og:description" content="文章目录 一.Echarts入门二.使用Echarts1.创建模块2. 前台页面访问3. 根据 官网可进行样式的更换 三.邮件发送1.编写工具类2.在注册的时候给用户发送一封邮件3.发送邮件存在问题 四.消息中间件1.了解消息中间件2.MQ的两种模式 五.安装RabbitMq1.第一步：下载并安装erlang2.下载并安装RabbitMQ3.安装过程中遇到的问题 六.RabbitMQ后台操作1.添加一个用户2.添加一个虚拟主机3.MQ端口号 七.RabbitMQ队列模式1.队列模式--普通队列（手工回执）2.队列模式--Work模式队列2.1两个一模一样的消费者2.2一个消费者处理慢一个消费者处理快2.3每次取消息只取一条 八.RabbitMQ订阅模式1.订阅模式--fanout2.订阅模式--direct3.订阅模式--topic 九.通过RabbitMQ发送邮件（重点）1.消息的生产者1.1 引入依赖1.2 applicationContext-mq.xml1.3 改写userController 2.消息的消费者2.1 引入依赖2.2 applicationContext.xml 2.3建一个监听类2.4 建一个启动类 一.Echarts入门 链接: 五分钟上手Echarts入门 案例
二.使用Echarts 1.创建模块 使用dobbo框架 需要创建stat_service 和stat_interfacestat_service是一个web工程，在这里面需要配置web.xml &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;web-app xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xmlns=&#34;http://java.sun.com/xml/ns/javaee&#34; xsi:schemaLocation=&#34;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&#34; version=&#34;2.5&#34;&gt; &lt;!-- 监听器监听其他的spring配置文件 --&gt; &lt;context-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;classpath*:spring/applicationContext-*.xml&lt;/param-value&gt; &lt;/context-param&gt; &lt;listener&gt; &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt; &lt;/listener&gt; &lt;/web-app&gt; 配置 applicationContext-dubbo.xml &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;beans xmlns=&#34;http://www.springframework.org/schema/beans&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xmlns:aop=&#34;http://www.springframework.org/schema/aop&#34; xmlns:dubbo=&#34;http://code.alibabatech.com/schema/dubbo&#34; xmlns:context=&#34;http://www.springframework.org/schema/context&#34; xmlns:mvc=&#34;http://www.springframework.org/schema/mvc&#34; xsi:schemaLocation=&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd http://www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0a9284b7390bb3ee0a849bac4cde1140/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-25T10:08:11+08:00" />
<meta property="article:modified_time" content="2020-03-25T10:08:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2.Echarts和RabbiMq</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Echarts_1" rel="nofollow">一.Echarts入门</a></li><li><a href="#Echarts_4" rel="nofollow">二.使用Echarts</a></li><li><ul><li><a href="#1_6" rel="nofollow">1.创建模块</a></li><li><a href="#2__188" rel="nofollow">2. 前台页面访问</a></li><li><a href="#3___190" rel="nofollow">3. 根据 官网可进行样式的更换</a></li></ul> 
  </li><li><a href="#_226" rel="nofollow">三.邮件发送</a></li><li><ul><li><a href="#1_227" rel="nofollow">1.编写工具类</a></li><li><a href="#2_282" rel="nofollow">2.在注册的时候给用户发送一封邮件</a></li><li><a href="#3_315" rel="nofollow">3.发送邮件存在问题</a></li></ul> 
  </li><li><a href="#_319" rel="nofollow">四.消息中间件</a></li><li><ul><li><a href="#1_320" rel="nofollow">1.了解消息中间件</a></li><li><a href="#2MQ_322" rel="nofollow">2.MQ的两种模式</a></li></ul> 
  </li><li><a href="#RabbitMq_335" rel="nofollow">五.安装RabbitMq</a></li><li><ul><li><a href="#1erlang_336" rel="nofollow">1.第一步：下载并安装erlang</a></li><li><a href="#2RabbitMQ_346" rel="nofollow">2.下载并安装RabbitMQ</a></li><li><a href="#3_354" rel="nofollow">3.安装过程中遇到的问题</a></li></ul> 
  </li><li><a href="#RabbitMQ_358" rel="nofollow">六.RabbitMQ后台操作</a></li><li><ul><li><a href="#1_359" rel="nofollow">1.添加一个用户</a></li><li><a href="#2_361" rel="nofollow">2.添加一个虚拟主机</a></li><li><a href="#3MQ_364" rel="nofollow">3.MQ端口号</a></li></ul> 
  </li><li><a href="#RabbitMQ_366" rel="nofollow">七.RabbitMQ队列模式</a></li><li><ul><li><a href="#1_367" rel="nofollow">1.队列模式--普通队列（手工回执）</a></li><li><a href="#2Work_388" rel="nofollow">2.队列模式--Work模式队列</a></li><li><ul><li><a href="#21_395" rel="nofollow">2.1两个一模一样的消费者</a></li><li><a href="#22_398" rel="nofollow">2.2一个消费者处理慢一个消费者处理快</a></li><li><a href="#23_403" rel="nofollow">2.3每次取消息只取一条</a></li></ul> 
  </li></ul> 
  </li><li><a href="#RabbitMQ_411" rel="nofollow">八.RabbitMQ订阅模式</a></li><li><ul><li><a href="#1fanout_412" rel="nofollow">1.订阅模式--fanout</a></li><li><a href="#2direct_430" rel="nofollow">2.订阅模式--direct</a></li><li><a href="#3topic_449" rel="nofollow">3.订阅模式--topic</a></li></ul> 
  </li><li><a href="#RabbitMQ_460" rel="nofollow">九.通过RabbitMQ发送邮件（重点）</a></li><li><ul><li><a href="#1_461" rel="nofollow">1.消息的生产者</a></li><li><ul><li><a href="#11__462" rel="nofollow">1.1 引入依赖</a></li><li><a href="#12_applicationContextmqxml_481" rel="nofollow">1.2 applicationContext-mq.xml</a></li><li><a href="#13__userController_533" rel="nofollow">1.3 改写userController</a></li></ul> 
   </li><li><a href="#2_553" rel="nofollow">2.消息的消费者</a></li><li><ul><li><a href="#21__554" rel="nofollow">2.1 引入依赖</a></li><li><a href="#22_applicationContextxml_567" rel="nofollow">2.2 applicationContext.xml</a></li></ul> 
   </li><li><a href="#23_609" rel="nofollow">2.3建一个监听类</a></li><li><a href="#24__652" rel="nofollow">2.4 建一个启动类</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Echarts_1"></a>一.Echarts入门</h2> 
<p>链接: <a href="https://www.echartsjs.com/zh/tutorial.html#5%20%E5%88%86%E9%92%9F%E4%B8%8A%E6%89%8B%20ECharts" rel="nofollow">五分钟上手Echarts入门 案例</a></p> 
<h2><a id="Echarts_4"></a>二.使用Echarts</h2> 
<h3><a id="1_6"></a>1.创建模块</h3> 
<ol><li>使用dobbo框架 需要创建stat_service 和stat_interface</li><li>stat_service是一个web工程，在这里面需要配置web.xml</li></ol> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
	<span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://java.sun.com/xml/ns/javaee<span class="token punctuation">"</span></span>
	<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd<span class="token punctuation">"</span></span>
	<span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.5<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- 监听器监听其他的spring配置文件 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>context-param</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>contextConfigLocation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>classpath*:spring/applicationContext-*.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>context-param</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.context.ContextLoaderListener<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener-class</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="3"><li>配置 applicationContext-dubbo.xml</li></ol> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>aop</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/aop<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>dubbo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://code.alibabatech.com/schema/dubbo<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>mvc</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/mvc<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
        http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>


    <span class="token comment">&lt;!--dubbo的应用名称，一般我们都使用项目名称--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>application</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>export_stat_service<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--运维相关--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>parameter</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qos.enable<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>parameter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>application</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--注册中心，本机的2181端口--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>registry</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zookeeper://127.0.0.1:2181<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>registry</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--非常重要，dubbo提供的访问端口号，8080tomcat容器仅仅是启动项目，真正的访问是这个端口20881--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>protocol</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dubbo<span class="token punctuation">"</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20883<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>protocol</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--注解支持，dubbo的包扫描--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>annotation</span> <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.itcast.service<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>annotation</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="4"><li>编写接口和实现类</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>service<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StatService</span> <span class="token punctuation">{<!-- --></span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>Map<span class="token punctuation">&gt;</span></span> <span class="token function">getFactoryData</span><span class="token punctuation">(</span>String companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>Map<span class="token punctuation">&gt;</span></span> <span class="token function">getOnlineData</span><span class="token punctuation">(</span>String companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>Map<span class="token punctuation">&gt;</span></span> <span class="token function">getSellData</span><span class="token punctuation">(</span>String companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>编写dao和xml</li></ol> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="token doctype">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.itcast.dao.stat.StatDao<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>getFactoryData<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>String<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        SELECT
            factory_name as name ,
            SUM(amount) as value
        FROM
            co_contract_product
        WHERE
            company_id = #{companyId}
        GROUP BY
            factory_name
        ORDER BY SUM(amount) DESC
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>getOnlineData<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        SELECT
            product_no as name ,
            SUM(amount) as value
        FROM
            co_contract_product
        WHERE
            company_id =  #{companyId}
        GROUP BY
            product_no
        ORDER BY SUM(amount) DESC
        LIMIT 15
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>getSellData<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        SELECT
            st_online_info.A1 as name,
            a.value as value
        FROM
            st_online_info
        LEFT JOIN (
            SELECT
                DATE_FORMAT(TIME, '%H') AS name,
                COUNT(*) AS value
            FROM
                st_sys_log
            WHERE
                st_sys_log.company_id =  #{companyId}
            GROUP BY
                DATE_FORMAT(TIME, '%H')
        ) a ON a.name=st_online_info.A1
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="7"><li>编写controller</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>web<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>stat<span class="token punctuation">;</span>

<span class="token keyword">import</span> cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>service<span class="token punctuation">.</span>StatService<span class="token punctuation">;</span>
<span class="token keyword">import</span> cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>web<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>BaseController<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Reference<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ResponseBody<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author cyy
 * @date 2020/3/22 18:43
 */</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/stat"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Reference</span>
    <span class="token keyword">private</span> StatService statService<span class="token punctuation">;</span>

<span class="token comment">//    跳转到统计分析页面</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/toCharts"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">toCharts</span><span class="token punctuation">(</span>String chartsType<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token keyword">return</span> <span class="token string">"stat/stat-"</span><span class="token operator">+</span>chartsType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getFactoryData"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>Map<span class="token punctuation">&gt;</span></span> <span class="token function">getFactoryData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token keyword">return</span>  statService<span class="token punctuation">.</span><span class="token function">getFactoryData</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getOnlineData"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span>  List<span class="token generics function"><span class="token punctuation">&lt;</span>Map<span class="token punctuation">&gt;</span></span> <span class="token function">getOnlineData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token keyword">return</span> statService<span class="token punctuation">.</span><span class="token function">getOnlineData</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getSellData"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>Map<span class="token punctuation">&gt;</span></span> <span class="token function">getSellData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> statService<span class="token punctuation">.</span><span class="token function">getSellData</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="2__188"></a>2. 前台页面访问</h3> 
<h3><a id="3___190"></a>3. 根据 官网可进行样式的更换</h3> 
<p><img src="https://images2.imgbox.com/40/72/Uok0EFpN_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">        <span class="token comment">// 指定图表的配置项和数据</span>
        option <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            xAxis<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                type<span class="token operator">:</span> <span class="token string">'category'</span><span class="token punctuation">,</span>
                data<span class="token operator">:</span> titles
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            yAxis<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                type<span class="token operator">:</span> <span class="token string">'value'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            series<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
                data<span class="token operator">:</span> values<span class="token punctuation">,</span>
                type<span class="token operator">:</span> <span class="token string">'line'</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/10/5d/0O48kx4k_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"> option <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          xAxis<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              type<span class="token operator">:</span> <span class="token string">'category'</span><span class="token punctuation">,</span>
              data<span class="token operator">:</span> titles
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          yAxis<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              type<span class="token operator">:</span> <span class="token string">'value'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          series<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
              data<span class="token operator">:</span>values<span class="token punctuation">,</span>
              type<span class="token operator">:</span> <span class="token string">'line'</span><span class="token punctuation">,</span>
              smooth<span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_226"></a>三.邮件发送</h2> 
<h3><a id="1_227"></a>1.编写工具类</h3> 
<pre><code class="prism language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">;</span>


<span class="token keyword">import</span> javax<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>Address<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>Session<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>Transport<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>internet<span class="token punctuation">.</span>InternetAddress<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>internet<span class="token punctuation">.</span>MimeMessage<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailUtil</span> <span class="token punctuation">{<!-- --></span>

   <span class="token comment">//实现邮件发送的方法</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span>String to <span class="token punctuation">,</span>String subject <span class="token punctuation">,</span>String content<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
   	<span class="token comment">//1. 邮件服务设置</span>
   	Properties props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"mail.smtp.host"</span><span class="token punctuation">,</span> <span class="token string">"smtp.163.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置主机地址   smtp.qq.com    smtp.sina.com</span>

   	props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"mail.smtp.auth"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//认证</span>

   	<span class="token comment">//2.产生一个用于邮件发送的Session对象</span>
   	Session session <span class="token operator">=</span> Session<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

   	<span class="token comment">//3.产生一个邮件的消息对象</span>
   	MimeMessage message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessage</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

   	<span class="token comment">//4.设置消息的发送者</span>
   	Address fromAddr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span><span class="token string">"邮箱"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	message<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span>fromAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

   	<span class="token comment">//5.设置消息的接收者</span>
   	Address toAddr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token comment">//TO 直接发送  CC抄送    BCC密送</span>
   	message<span class="token punctuation">.</span><span class="token function">setRecipient</span><span class="token punctuation">(</span>MimeMessage<span class="token punctuation">.</span>RecipientType<span class="token punctuation">.</span>TO<span class="token punctuation">,</span> toAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

   	<span class="token comment">//6.设置主题</span>
   	message<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token comment">//7.设置正文</span>
   	message<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

   	<span class="token comment">//8.准备发送，得到火箭</span>
   	Transport transport <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getTransport</span><span class="token punctuation">(</span><span class="token string">"smtp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token comment">//9.设置火箭的发射目标</span>
   	transport<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"smtp.sina.com"</span><span class="token punctuation">,</span> <span class="token string">"邮箱"</span><span class="token punctuation">,</span> <span class="token string">"授权码"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token comment">//10.发送</span>
   	transport<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getAllRecipients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   	<span class="token comment">//11.关闭</span>
   	transport<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_282"></a>2.在注册的时候给用户发送一封邮件</h3> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/edit"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"保存用户信息"</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> String <span class="token function">edit</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

       <span class="token comment">//在实体类中设置企业信息</span>
       user<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
       user<span class="token punctuation">.</span><span class="token function">setCompanyName</span><span class="token punctuation">(</span>companyName<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//1、判断user.getId，是新建还是编辑</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtil<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           <span class="token comment">//2、调用userService新建</span>
           user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//  ！！**new 新增用户时，获取用户的密码**</span>
           String password<span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>Encrypt<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      		   userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

   	<span class="token comment">//  ！！  **new 新增用户时，需要给用户发送一封邮件**</span>
   		 String to <span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               String subject<span class="token operator">=</span><span class="token string">"主题  "</span><span class="token punctuation">;</span>
               String content <span class="token operator">=</span><span class="token string">"用户名"</span><span class="token operator">+</span>to<span class="token operator">+</span><span class="token string">"密码为"</span><span class="token operator">+</span>password<span class="token punctuation">;</span>
               MailUtil<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
       <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">//3、调用userService编辑</span>
           userService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token comment">//4、重定向到list.do</span>
       <span class="token keyword">return</span> <span class="token string">"redirect: /system/user/list.do"</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_315"></a>3.发送邮件存在问题</h3> 
<ul><li>邮件发送过慢</li><li>解决：异步拆分为两个程序，采用队列的方式进行监听</li></ul> 
<h2><a id="_319"></a>四.消息中间件</h2> 
<h3><a id="1_320"></a>1.了解消息中间件</h3> 
<ul><li>消息中间件是分布式系统中最重要的组件，主要解决<mark>应用解耦，异步消息，流量削峰</mark></li></ul> 
<h3><a id="2MQ_322"></a>2.MQ的两种模式</h3> 
<ol><li>队列模式</li></ol> 
<ul><li>普通队列:一个提供者发送每条消息，都有一个消费者进行接收<br> <img src="https://images2.imgbox.com/76/43/hTXpn4iX_o.png" alt="在这里插入图片描述"></li><li>work模式:一个提供者发送多条消息，有多个消费者进行接收，但是每个消费者只能接收到一条消息，消费者之间消息不能重复（轮询机制发送）<br> <img src="https://images2.imgbox.com/ed/75/ievW3apr_o.png" alt="在这里插入图片描述"></li></ul> 
<ol start="2"><li>订阅模式</li></ol> 
<ul><li>fanout模式:一个提供者发送多条消息，同时有多个消费者收到同样的消息<br> <img src="https://images2.imgbox.com/1f/d5/kCxPSctQ_o.png" alt="在这里插入图片描述"></li><li>direct模式：增加一个关键字，一个提供者发送多条消息时，里面包含关键字，多个消费者根据关键字进行过滤，匹配成功的接收到消息<br> <img src="https://images2.imgbox.com/c6/c4/giP8QkZN_o.png" alt="在这里插入图片描述"></li><li>topic模式：增加一个通配符，一个提供者发送多条消息时，里面包含关键字，多个消费者根据通配符进行过滤，匹配成功的接收到消息<br> <img src="https://images2.imgbox.com/19/5f/kmOmLkcw_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="RabbitMq_335"></a>五.安装RabbitMq</h2> 
<h3><a id="1erlang_336"></a>1.第一步：下载并安装erlang</h3> 
<ol><li>需要配置环境变量</li></ol> 
<pre><code class="prism language-java">变量名：ERLANG_HOME
变量值就是刚才erlang的安装地址，点击确定。
</code></pre> 
<pre><code class="prism language-java">点击“新建”，将<span class="token operator">%</span>ERLANG_HOME<span class="token operator">%</span>\bin加入到path中。
</code></pre> 
<ol start="2"><li>cmd 输入erl，看到版本号就说明erlang安装成功了。</li></ol> 
<h3><a id="2RabbitMQ_346"></a>2.下载并安装RabbitMQ</h3> 
<ol><li>安装rabbitMQ-server</li><li>RabbitMQ安装好后接下来安装RabbitMQ-Plugins。打开命令行cd，输入RabbitMQ的sbin目录。<br> 然后在后面输入rabbitmq-plugins enable rabbitmq_management命令进行安装<br> <img src="https://images2.imgbox.com/f5/f4/1tByCNdW_o.png" alt="在这里插入图片描述"></li><li>在cmd 运行 倒数第二个<br> <img src="https://images2.imgbox.com/85/38/8ksjImTv_o.png" alt="在这里插入图片描述"></li><li>访问http://localhost:15672 <mark>默认用户名和密码都是guest</mark></li></ol> 
<h3><a id="3_354"></a>3.安装过程中遇到的问题</h3> 
<ul><li>无法访问15672 提示节点已经在本机存在</li><li>解决：在服务中关掉进程，重启计算机，然后在cmd重新执行rabbitmq-server.bat 登陆成功</li></ul> 
<h2><a id="RabbitMQ_358"></a>六.RabbitMQ后台操作</h2> 
<h3><a id="1_359"></a>1.添加一个用户</h3> 
<p><img src="https://images2.imgbox.com/d9/a3/JKK5UDsG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_361"></a>2.添加一个虚拟主机</h3> 
<p><img src="https://images2.imgbox.com/bd/c1/mHB31ZQa_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6c/c7/ZQ8pwpjG_o.png" alt="给虚拟主机增加用户"></p> 
<h3><a id="3MQ_364"></a>3.MQ端口号</h3> 
<p><img src="https://images2.imgbox.com/d5/cd/ETdyNGV8_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="RabbitMQ_366"></a>七.RabbitMQ队列模式</h2> 
<h3><a id="1_367"></a>1.队列模式–普通队列（手工回执）</h3> 
<p><strong>应用场景</strong>：并发量不是很大，比如：新增用户发邮件</p> 
<pre><code class="prism language-java"><span class="token comment">//6、消费队列</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token string">"heima123_queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>第二个参数代表自动回执，拿到这条消息之后，不管是否消费成功，都进行回执。</p> 
<p>回执指的是告诉RabbitMQ，消息已经被消费了，所以消息在RabbitMQ服务里物理删除了。</p> 
<p><mark>问题：如果消费者拿到消息之后，处理业务时失败了，发生异常，这条消息就永久消失了。</mark></p> 
<p>所以一般第二个参数会设置成false，需要手工进行回执。</p> 
<p><mark>用到的场景</mark>：消费者在处理完业务时，成功之后才手工回执，如果失败则不用回执。</p> 
<pre><code class="prism language-java"> <span class="token comment">//确认收到一个或多个消息</span>
   channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h3><a id="2Work_388"></a>2.队列模式–Work模式队列</h3> 
<p><strong>应用场景</strong>：并发量也不是很大，消息消费者需要大量的时间去运行。</p> 
<p>消息提供者提供一条消息只需要2秒，消息消费者需要1小时运行。效率就非常低，需要有多个消息消息者进行处理。</p> 
<p><mark>举例</mark>：前台页面（查询去年双11到今年双11整年的销量）：【准备数据】【查询数据】<br> 。</p> 
<h4><a id="21_395"></a>2.1两个一模一样的消费者</h4> 
<p>两个一模一样的消费者，每个消费者轮流获取消息，消息并不重复。<br> <img src="https://images2.imgbox.com/67/8c/uKheCyHB_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="22_398"></a>2.2一个消费者处理慢一个消费者处理快</h4> 
<p><strong>应用场景</strong>：多个消费者放在多台电脑上，有的电脑快，有的电脑慢。</p> 
<p>生产者生产100条消息，消费者1和消费者2还是轮流获取消息，快的会先处理完，慢的处理的非常慢，获取的消息和两个一模一样的消费者获取的消息是一样的，<mark>差异在于处理的速度不同</mark>。<br> <img src="https://images2.imgbox.com/47/b4/xU4Bl8r7_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="23_403"></a>2.3每次取消息只取一条</h4> 
<p>在两个消费者上面设置每次只获取一条消息</p> 
<pre><code class="prism language-java">     <span class="token comment">//设置每次取的数量</span>
        channel<span class="token punctuation">.</span><span class="token function">basicQos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c0/f6/OrCYSATp_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="RabbitMQ_411"></a>八.RabbitMQ订阅模式</h2> 
<h3><a id="1fanout_412"></a>1.订阅模式–fanout</h3> 
<p><strong>应用场景</strong>：会员提交订单之后，需要处理几件事：<br> 1、付款；2、保存订单，写入订单表；3、减少库存，写入库存表；4、通知物流，写入物流表；5、通知客服，写入客服表；6、通知营销，写入促销表；7、通知售后，写入安装表；8、通知厂家，厂家发货表</p> 
<p><mark>消息生产者声明交换机</mark></p> 
<pre><code class="prism language-java"><span class="token comment">// 声明exchange</span>
<span class="token comment">//参数1: 交换机名称</span>
<span class="token comment">//参数2: 交换机类型</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"fanout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><mark>消息消费者绑定交换机</mark></p> 
<pre><code class="prism language-java"><span class="token comment">// 绑定队列到交换机</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/79/c9/cXGKJEPA_o.png" alt=""></p> 
<h3><a id="2direct_430"></a>2.订阅模式–direct</h3> 
<pre><code class="prism language-java"><span class="token comment">// 声明exchange</span>
<span class="token comment">//参数1: 交换机名称</span>
<span class="token comment">//参数2: 交换机类型</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"direct"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>消息生产者指定关键字</p> 
<pre><code class="prism language-java">channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"back"</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>消息消费者指定关键字</p> 
<pre><code class="prism language-java">   <span class="token comment">// 绑定队列到交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"buy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"back"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"ask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="3topic_449"></a>3.订阅模式–topic</h3> 
<p>生产者发送消息</p> 
<pre><code class="prism language-java">channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"ask.phone"</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>消费者绑定交换机</p> 
<pre><code class="prism language-java">channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"ask.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">"*.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="RabbitMQ_460"></a>九.通过RabbitMQ发送邮件（重点）</h2> 
<h3><a id="1_461"></a>1.消息的生产者</h3> 
<h4><a id="11__462"></a>1.1 引入依赖</h4> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>rabbit整合spring<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>rabbitmq<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>amqp<span class="token operator">-</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">5.7</span><span class="token number">.3</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>rabbit<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.1</span><span class="token number">.7</span><span class="token punctuation">.</span>RELEASE<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jackson<span class="token operator">-</span>databind<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.9</span><span class="token number">.5</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="12_applicationContextmqxml_481"></a>1.2 applicationContext-mq.xml</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>rabbit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/rabbit<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>contact</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/rabbit
	http://www.springframework.org/schema/rabbit/spring-rabbit-2.1.xsd
	http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
	http://www.springframework.org/schema/context
	https://www.springframework.org/schema/context/spring-context-4.1.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--包扫描--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.itcast.web<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 公共部分 --&gt;</span>
    <span class="token comment">&lt;!-- 创建连接类 连接安装好的 rabbitmq --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span>  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.amqp.rabbit.connection.CachingConnectionFactory<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>virtualHost<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>heima111<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- username,访问RabbitMQ服务器的账户,默认是guest --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- username,访问RabbitMQ服务器的密码,默认是guest --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- host,RabbitMQ服务器地址，默认值"localhost" --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>127.0.0.1<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- port，RabbitMQ服务端口，默认值为5672 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>port<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5672<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>admin</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--解析json ， MQ会自动将数据转换成json字符串--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jackson2JsonMessageConverter<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.amqp.support.converter.Jackson2JsonMessageConverter<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--模版对象 用于发送消息--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>amqpTemplate<span class="token punctuation">"</span></span>  <span class="token attr-name">exchange</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test-mq-exchange<span class="token punctuation">"</span></span>  <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span>  <span class="token attr-name">message-converter</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jackson2JsonMessageConverter<span class="token punctuation">"</span></span>  <span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--配置队列  durable="true" 表示消息需要持久化 即服务器崩溃会数据不会丢失 auto-delete="false" 表示服务器停止后数据是否自动删除  exclusive:表示该消息队列是否只在当前connection生效。默认false。 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test_queue_key2<span class="token punctuation">"</span></span>  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mail.send<span class="token punctuation">"</span></span> <span class="token attr-name">durable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">auto-delete</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">exclusive</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--交换机
        定义消息队列,durable:是否持久化，如果想在RabbitMQ退出或崩溃的时候，不会失去所有的queue和消息，需要同时标志队列(queue)和交换机(exchange)是持久化的，即rabbit:queue标签和rabbit:direct-exchange中的durable=true,而消息(message)默认是持久化的可以看类org.springframework.amqp.core.MessageProperties中的属性public static final MessageDeliveryMode DEFAULT_DELIVERY_MODE = MessageDeliveryMode.PERSISTENT;exclusive: 仅创建者可以使用的私有队列，断开后自动删除；auto_delete: 当所有消费客户端连接断开后，是否自动删除队列
        绑定队列,rabbitmq的exchangeType常用的三种模式：direct，fanout，topic三种,我们用direct模式，即rabbit:direct-exchange标签，Direct交换器很简单，如果是Direct类型，就会将消息中的RoutingKey与该Exchange关联的所有Binding中的BindingKey进行比较，如果相等，则发送到该Binding对应的Queue中。有一个需要注意的地方：如果找不到指定的exchange，就会报错。但routing key找不到的话，不会报错，这条消息会直接丢失，所以此处要小心,auto-delete:自动删除，如果为Yes，则该交换机所有队列queue删除后，自动删除交换机，默认为false
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>direct-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test-mq-exchange<span class="token punctuation">"</span></span> <span class="token attr-name">durable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">auto-delete</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test-mq-exchange<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--绑定队列 队列名称为mail.send--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test_queue_key2<span class="token punctuation">"</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mail.send<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>direct-exchange</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="13__userController_533"></a>1.3 改写userController</h4> 
<pre><code class="prism language-java">
    <span class="token comment">//  1、注入一个AmqpTemplate在方法上面注入</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> AmqpTemplate amqpTemplate<span class="token punctuation">;</span>
    
    <span class="token comment">//  2、调用amqpTemplate.convertAndSend</span>
            Map map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"to"</span><span class="token punctuation">,</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"subject"</span><span class="token punctuation">,</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//将邮件的内容发送消息</span>
            <span class="token comment">//两个参数：</span>
            <span class="token comment">//1、队列名称</span>
            <span class="token comment">//2、消息内容</span>
            amqpTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"mail.send"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="2_553"></a>2.消息的消费者</h3> 
<h4><a id="21__554"></a>2.1 引入依赖</h4> 
<p>解析发送的内容</p> 
<pre><code class="prism language-xml">
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.41<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

 
</code></pre> 
<h4><a id="22_applicationContextxml_567"></a>2.2 applicationContext.xml</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>rabbit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/rabbit<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>contact</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/rabbit
	http://www.springframework.org/schema/rabbit/spring-rabbit-2.1.xsd
	http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
	http://www.springframework.org/schema/context
	https://www.springframework.org/schema/context/spring-context-4.1.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--连接工厂--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span>  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.amqp.rabbit.connection.CachingConnectionFactory<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--&lt;constructor-arg value="${mq.vhost}" /&gt;--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>virtualHost<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>heima123<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- username,访问RabbitMQ服务器的账户,默认是guest --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- username,访问RabbitMQ服务器的密码,默认是guest --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- host,RabbitMQ服务器地址，默认值"localhost" --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>127.0.0.1<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- port，RabbitMQ服务端口，默认值为5672 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>port<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5672<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>admin</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mail.send<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">durable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 消费者部分 --&gt;</span>
    <span class="token comment">&lt;!-- 自定义接口类 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>myListener<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.itcast.mail.MyListener<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--解析json--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jackson2JsonMessageConverter<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.amqp.support.converter.Jackson2JsonMessageConverter<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 配置监听acknowledeg="manual"设置手动应答，它能够保证即使在一个worker处理消息的时候用CTRL+C来杀掉这个worker，或者一个consumer挂了(channel关闭了、connection关闭了或者TCP连接断了)，也不会丢失消息。因为RabbitMQ知道没发送ack确认消息导致这个消息没有被完全处理，将会对这条消息做re-queue处理。如果此时有另一个consumer连接，消息会被重新发送至另一个consumer会一直重发,直到消息处理成功,监听容器acknowledge="auto" concurrency="30"设置发送次数,最多发送30次 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener-container</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">acknowledge</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>auto<span class="token punctuation">"</span></span> <span class="token attr-name">concurrency</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">queues</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mail.send<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>myListener<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>listener-container</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="23_609"></a>2.3建一个监听类</h3> 
<p><code>cn.itcast.mail.MyListener</code></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>mail<span class="token punctuation">;</span>

<span class="token keyword">import</span> cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>MailUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSONObject<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span>JsonObject<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>AcknowledgeMode<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>MessageListener<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author cyy
 * @date 2020/3/26 10:38
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyListener</span> <span class="token keyword">implements</span> <span class="token class-name">MessageListener</span> <span class="token punctuation">{<!-- --></span>

<span class="token comment">//    监听消息</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span>Message message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">/* System.out.println("msg = " + msg);*/</span>

        Map map <span class="token operator">=</span> JSONObject<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String to <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"to"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String subject<span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"subject"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String content <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>to<span class="token operator">+</span><span class="token string">"====="</span><span class="token operator">+</span>subject<span class="token operator">+</span><span class="token string">"====="</span><span class="token operator">+</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            MailUtil<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="24__652"></a>2.4 建一个启动类</h3> 
<pre><code class="prism language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>run<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ClassPathXmlApplicationContext<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author cyy
 * @date 2020/3/26 10:43
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ClassPathXmlApplicationContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"spring/applicationContext.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/34301c413d60160aae0daa33575fb180/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">oracle常用操作</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ae841afcde8170694b78afbc63695d26/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">哪些数据可以放进缓存？记录生产环境一次缓存评估的过程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>