<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ISO7816协议深度解析-简单易懂协议详解（一）-- 复位，字符帧，及ATR - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ISO7816协议深度解析-简单易懂协议详解（一）-- 复位，字符帧，及ATR" />
<meta property="og:description" content="1. 摘要
IC卡必须支持T=0或T=1的协议，但不是同时支持这两种协议，而终端则必须同时支持T=0和T=1的协议。
• T=0通讯协议是异步半双工字符传输协议；
• T=1通讯协议是异步半双工块传输协议；
在ISO7816-3标准中，具体规定了这两种协议：T0和T1。
IC卡所用的协议在TD1中指定，如果在复位应答信息中没有TD1，则表示用T=0的协议进行通讯。在复位应答后，IC卡和终端之间即用IC卡指定的协议进行通讯。
2. 硬件接口
1）VCC：电源输入（A类：5V， B类：3V）
2）GND：地
3）RST：复位
4）I/O：输入输出
5）CLK：时钟（A类：1~5MHz， B类：1~4MHz）
注：不同型号的卡引脚数可能不一样。
3. 读头与卡的操作
3.1 ETU（基本时间单元）介绍
7816-3定义的通讯协议，基本上可以说是RS232的翻版并在此基础上进行的改进。在RS232中我们有9600波特率、起始位、奇偶校验位、停止位这些概念，而在7816-3中都完整地保留了下来，只不过7816-3中引入了etu，没有使用bps。etu的定义可以更加精确地描述每个数据位在传输过程中收发双方的职责和角色转换。
根据定义在智能卡上电复位的时候 1 etu = 372 / f ，其中f = 读写设备通过CLK管脚提供给智能卡的时钟频率，通常在1-5 MHz之间。
etu的单位是时间单位秒（毫秒、微秒），等同于传输每个数据位所需的时间。对其取倒数得出来的就是每秒传输的数据位，也就是bps。我们取f = 3.579545 MHz，用3579545除以372结果等于9622.4约为9600 bps。
通用的etu计算公式： 1 etu = (F / D) * (1 / f) ，F和D的值根据7816-3规范中的约定来进行设置。对于上电复位时的取值 F = 372，D = 1即作为默认值Fd和Dd。如果智能卡支持其他速率则需要在ATR中的TA1来指出其他的F和D的值，比如设定F=372，可以把D分别设定为2/4，那么智能卡能支持的通讯速率可以分别为19200/38400。
那么为什么要选择时钟频率为3.579545 MHz？为什么默认的F值选择为372呢？首先3.579545 MHz 是常用石英晶振的标称值，9600 * 372 = 3.5712 MHz，与之最为接近。再说为什么是372，372 = 12 * 31。标准的8051单片机每个指令周期为12个时钟周期，而且定时/计数器也按照1/12 进行分频后再计数的，这样设定对于智能卡芯片来说可以比较容易实现对IO数据通讯的控制，也可以更好地和PC机串口9600速率配合（当然这是指上个世纪80年代的时候，对于现在的智能卡芯片设计技术而言实现任意分频的控制都不是问题了）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/235fc95b80b7e3b0c29d53308e282701/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-14T11:18:58+08:00" />
<meta property="article:modified_time" content="2021-01-14T11:18:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ISO7816协议深度解析-简单易懂协议详解（一）-- 复位，字符帧，及ATR</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>1. 摘要</strong><br> IC卡必须支持T=0或T=1的协议，但不是同时支持这两种协议，而终端则必须同时支持T=0和T=1的协议。<br> • T=0通讯协议是异步半双工字符传输协议；<br> • T=1通讯协议是异步半双工块传输协议；<br> 在ISO7816-3标准中，具体规定了这两种协议：T0和T1。<br> IC卡所用的协议在TD1中指定，如果在复位应答信息中没有TD1，则表示用T=0的协议进行通讯。在复位应答后，IC卡和终端之间即用IC卡指定的协议进行通讯。</p> 
<p><strong>2. 硬件接口</strong><br> 1）VCC：电源输入（A类：5V， B类：3V）<br> 2）GND：地<br> 3）RST：复位<br> 4）I/O：输入输出<br> 5）CLK：时钟（A类：1~5MHz， B类：1~4MHz）<br> 注：不同型号的卡引脚数可能不一样。</p> 
<p><strong>3. 读头与卡的操作<br> 3.1 ETU（基本时间单元）介绍</strong><br> 7816-3定义的通讯协议，基本上可以说是RS232的翻版并在此基础上进行的改进。在RS232中我们有9600波特率、起始位、奇偶校验位、停止位这些概念，而在7816-3中都完整地保留了下来，只不过7816-3中引入了etu，没有使用bps。etu的定义可以更加精确地描述每个数据位在传输过程中收发双方的职责和角色转换。<br> 根据定义在智能卡上电复位的时候 <strong>1 etu = 372 / f</strong> ，其中f = 读写设备通过CLK管脚提供给智能卡的时钟频率，通常在1-5 MHz之间。<br> etu的单位是时间单位秒（毫秒、微秒），等同于传输每个数据位所需的时间。对其取倒数得出来的就是每秒传输的数据位，也就是bps。我们取f = 3.579545 MHz，用3579545除以372结果等于9622.4约为9600 bps。<br> 通用的etu计算公式： <strong>1 etu = (F / D) * (1 / f)</strong> ，F和D的值根据7816-3规范中的约定来进行设置。对于上电复位时的取值 F = 372，D = 1即作为默认值Fd和Dd。如果智能卡支持其他速率则需要在ATR中的TA1来指出其他的F和D的值，比如设定F=372，可以把D分别设定为2/4，那么智能卡能支持的通讯速率可以分别为19200/38400。<br> <img src="https://images2.imgbox.com/b8/3e/pvL0teTa_o.png" alt="在这里插入图片描述"></p> 
<p>那么为什么要选择时钟频率为3.579545 MHz？为什么默认的F值选择为372呢？首先3.579545 MHz 是常用石英晶振的标称值，9600 * 372 = 3.5712 MHz，与之最为接近。再说为什么是372，372 = 12 * 31。标准的8051单片机每个指令周期为12个时钟周期，而且定时/计数器也按照1/12 进行分频后再计数的，这样设定对于智能卡芯片来说可以比较容易实现对IO数据通讯的控制，也可以更好地和PC机串口9600速率配合（当然这是指上个世纪80年代的时候，对于现在的智能卡芯片设计技术而言实现任意分频的控制都不是问题了）。<br> 由此可见，这些参数的选择都是为了能够更好地利用当时既有的标准和技术，要知道7816-3在1989年的时候就已经制定了，按照当时的主流PC机配置把串口速率设为9600，用一个232接口芯片（比如Max232）再加上3.579545MHz的晶振，再配合几片74系列的门电路外加5伏的直流电源和几个阻容器件，这就是最基本的RS232串口读卡器了。<br> PS:<br> • Fi Di ：TA1 (高4位, 低4位), 详见4.3.1。<br> • Fn Dn：PPS1 (高4位, 低4位), 详见4.3.1。<br> • Fd Dd：默认值(Fd = 372, Dd = 1)。</p> 
<p><strong>3.2 字符帧</strong><br> 在字符之前，I/O端应处于状态Z。如下图，一个字符应由10个连续的时间段组成，每一时间段不 是处于状态 Z,就是处于状态 A,<br> — 第一个时间段ml应处于状态A；这个时间段是“起始位”。<br> — m2-m9八个时间段运送1个字节。<br> — 最后一个时间段m10应确保字符奇偶校验位， 运送“奇偶校验位”。<br> <img src="https://images2.imgbox.com/cf/7d/pLZ8vpi8_o.png" alt="在这里插入图片描述"></p> 
<p>在每个字符中，如果在时间段mn结束时状态改变，则从字符前沿到mn后沿的延迟应是 tn = (n 士 0. 2) * etu。<br> •发送方的时间起点是字符的起始沿。当搜索一个字符时，接收方定期地对 I/O取样，取样时间应少于0.2etu。接收方的时间起点是对Z状态的最后一个观察点和 A状态的第一个观察点中间。<br> • 接收方应在0.7etu(接收方时间)之前确认ml，然后应在(1.5士0.2)etu收到m2，在(2.5士0.2) etu 收到m3,···，在(8.5士0.2) etu收到m9，在(9.5士0.2) etu收到m10。字符奇偶校验在字符帧运送结束之后进行。<br> 注:这样的允许偏差确保完全区分信号测量区和信号跃变区。<br> 两个连续字符的起始沿之间的延迟应至少是12etu，即某个字符的持续时间(10士0.2) etu加上保护时间。在保护时间，接口设备和卡都应保持接收状态，因此 I/O状态为Z。<br> 在复位应答期间，卡发出的两个连续字符的起始沿之间的延迟应不超过 9600 etu。这个最大值被称为“初始等待时间”。</p> 
<p><strong>4 通信流程</strong><br> ①激活电路。<br> ②冷复位启动卡应答，卡与读头进行通信。<br> ③释放电路。<br> 随着IC卡的触点的实际接通，终端必须启动一个冷复位。<br> 如果IC卡的冷复位的应答所回送的字节不符合前面小节中的规定，或IC卡的复位应答未在19，200初始etu之内完成，终端不必立刻取消用卡过程，而是发出一个热复位信号。<br> 如果应答符合要求，而且是在19，200初始etu之内回送，则终端必须使用回送的参数进行卡片操作过程。<br> 如果终端启动了一个上述的热复位，而IC卡对热复位的应答所回送的字节仍不符合上述小节中的规定，或IC卡的复位应答未能在19，200初始etu之内完成，则终端将执行释放IC卡的触点序列，从而取消用卡过程。<br> 如果对热复位的应答符合这些规定，而且是在19，200初始之内回送，则终端必须使用回送的参数处理卡片操作过程。<br> 不论是对冷复位或热复位，如果在应答时由IC卡回送的相邻二字节的起始位的上升沿之间的时间超过了9600初始etu，终端就必须执行释放触点序列，从而取消用卡过程。</p> 
<p><strong>4.1 激活流程</strong><br> ①RST置位状态L。<br> ②VCC加电5V（A类）或3V（B类）。<br> ③I/O置为接收状态。<br> ④CLK提供1<sub>5MHz（A类）或1</sub>4MHz（B类）。<br> <img src="https://images2.imgbox.com/e7/06/uEwg1FTk_o.png" alt="在这里插入图片描述"></p> 
<p><strong>4.2 冷复位</strong><br> 1.VCC供电，RST状态处于L，IO状态处于L情况下。<br> 2.当提供稳定的CLK开始，在200个时钟周期内IO将转变状态到H。<br> 3.当提供稳定的CLK开始，RST至少保持L状态400个时钟周期。<br> 4.当RST进入状态H之后，从RST的H状态上升沿开始的400到40000个时钟周期内，复位应答开始。<br> 5.如果RST状态H的上升沿以后，超过40000个时钟周期，卡片的复位应答没开始，则复位失败，RST上的信号将返回到状态L，设备按照释放时序。<br> <img src="https://images2.imgbox.com/1c/22/5rLq7ofc_o.png" alt="在这里插入图片描述"><br> 图4 激活与冷复位</p> 
<p><strong>4.3 热复位</strong><br> 1)VCC保持供电并且CLK提供合适且稳定的时钟信号的情况下。<br> 2)RST置于状态L至少400个时钟周期，启动热复位。<br> 3)IO接口在RST状态L之后的200个时钟周期内，将IO设置为状态H。<br> 4)在RST置位H状态之后的400~40000个时钟周期内，I/O将收到复位应答。<br> 5)若在RST置位H状态之后超过40000个时钟周期，，I/O复位应答没开始，则热复位失败，接口释放电路。<br> <img src="https://images2.imgbox.com/d7/c5/ktZrBsfk_o.png" alt="在这里插入图片描述"></p> 
<p><em><strong>冷复位和热复位不同在于</strong></em>，冷复位是重新上电并加稳定的时钟信号之后发起，而热复位是在电源和时钟信号保持的情况下，通过RST信号发起。</p> 
<p><strong>4.4 时钟停止</strong><br> 1)I/O保持在状态Z至少1860个时钟周期（tg）；<br> 2)当时钟被停止（从Te到Tf），CLK应保持在状态H或状态L，这个状态由参数X指明。<br> 3)Tf之后，接口设备重启时钟，I/O上的信息交换需在至少700个时钟周期之后（th）。</p> 
<p><strong>4.5 释放</strong><br> 1)RST置为状态L<br> 2)CLK置为状态L<br> 3)VPP释放（如果已经激活）<br> 4)I/O置为状态A<br> 5)VCC释放</p> 
<p><strong>5 ATR</strong><br> ATR是answer to reset（复位应答）。是读头复位卡之后，卡回复读头的第一条指令。复位答复格式如下：</p> 
<table><thead><tr><th>TS</th><th>T0</th><th>TA1,TB1,TC1,TD1,…,TAi,TBi,TCi,TDi</th><th>T1,T2,…,TK</th><th>TCK</th></tr></thead><tbody></tbody></table> 
<p><strong>5.1 初始字符TS</strong><br> • TS：初始字符,定义了所有后继字符中数据字节的编码协议，其后面最多跟32个字符。<br> • 3B：正向约定；3F：反向约定。</p> 
<p><strong>5.2 格式字符T0</strong><br> <img src="https://images2.imgbox.com/92/a3/VO8HO56O_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f0/17/76kYRMrd_o.png" alt="在这里插入图片描述"><br> • Y1(m7~m4)：标记TA1、TB1、TC1、TD1是否存在；<br> • K (m3~m0)：为历史字符的数据长度，常用T=0（异步半双工字符传输协议）, T=1（异步半双工块传输协议）。<br> <strong>• 基本响应：</strong> 如果只使用了T=0，IC卡将回送T0=“6X”，指明字符TB1和TC1的存在。如果只使用了T=1，则IC卡回送T0=“EX“，指明字符TB1至TD1的存在。“X”之值表明传送的历史字符的数量。<br> <strong>• 终端反应：</strong> 若IC卡回送的T0为任意值，只要它正确地指明并和接口字符TA1至TD1及实际回送的历史字节一致，终端不得拒绝。<br> <em><strong>表1 T=0的复位应答回送的字符</strong></em></p> 
<table><thead><tr><th>字符</th><th>值</th><th>备注</th></tr></thead><tbody><tr><td>TS</td><td>“3B”或”3F”</td><td>表示正向或反向约定</td></tr><tr><td>T0</td><td>“6X”</td><td>TB1和TC1出现，X表示历史字节的存在个数</td></tr><tr><td>TB1</td><td>“00”</td><td>不适用VPP</td></tr><tr><td>TC1</td><td>“00”到”FF”</td><td>表示需要额外保护时间，数据”FF”有特殊含义</td></tr></tbody></table> 
<p><em><strong>表2 T=1的复位应答回送的字符</strong></em></p> 
<table><thead><tr><th>字符</th><th>值</th><th>备注</th></tr></thead><tbody><tr><td>TS</td><td>“3B”或”3F”</td><td>表示正向或反向约定</td></tr><tr><td>T0</td><td>“EX”</td><td>TB1和TD1出现，X表示历史字节的存在的个数</td></tr><tr><td>TB1</td><td>“00”</td><td>不适用VPP</td></tr><tr><td>TC1</td><td>“00”到”FF”</td><td>表示需要额外保护时间，数据”FF”有特殊含义</td></tr><tr><td>TD1</td><td>“81”</td><td>使用T=1协议，TA2至TC2不存在，TD2存在</td></tr><tr><td>TD2</td><td>“31”</td><td>使用T=1协议，TA3至TB3存在，TC3和TD3不存在</td></tr><tr><td>TA3</td><td>“10”至”FE”</td><td>回送IFSI，表示IC卡信息域大小的初始值，16~254字节</td></tr><tr><td>TB3</td><td>高4位组”0”至”4”; 低4位组”0”至”5”</td><td>BWI = 0~4; CWI = 0~5</td></tr><tr><td>TCK</td><td></td><td>校验字符</td></tr></tbody></table> 
<p><strong>注：T=0和T=1的比较：</strong><br> T=0是以字符为最小的传输单位。在此协议中，读卡器向卡发送APDU指令，就是由5个字符组成，这5个字符每一个意义都很明确固定。而T=1协议中，除了定义了块的结构外，其他信息都存储在INF中，也就是说读卡器对卡发送的指令和数据都存在这个INF域中，而并没有对这些指令和数据作严格的规定，在这方面T=1较T=0更为灵活。</p> 
<p><strong>5.3 接口字符TAi、TBi、TCi、TDi（i=1、2、3等等）</strong><br> TAi：高4bit为FI（时钟率转换因子），低4bit为DI（波特率校正因子）；<br> TBi：bit1<sub>bit5：最大编程电压，bit6</sub>bit7：最大编程电流，bit8不使用。<br> TCi：计算八位额外保护时间的引用。<br> TA2：存在则是专用模式，不存在则是协商模式，需通过PPS命令去确认协议。<br> 当TA2的bit5=0时使用Fi和Di，若bit5=1时，使用默认值。<br> TDi： 指明协议类型和是否存在后续接口字符，TDi包括Yi+1和T两部分，Yi+1为高四位组，分别表示后续接口字符TAi+1、TBi+1、TCi+1、TDi+1是否存在，T为低四位组，表示后续发送的协议类型。<br> <img src="https://images2.imgbox.com/f7/62/jygLkl8Y_o.png" alt="在这里插入图片描述"></p> 
<p><strong>5.3.1 TA1</strong><br> TA1传达FI和DI的数值，其中：FI(高4位)用来确定F的数值，F为时钟频率转换因子，用于修改继复位应答之后由终端所提供的时钟频率。DI(低4位)用来确定D的数值，称为比特率调节因子，用于调整复位应答之后所使用的位持续时间。<br> <img src="https://images2.imgbox.com/ed/7b/zJ1w8TdZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e7/8a/98FFO2qj_o.png" alt="在这里插入图片描述"></p> 
<p>• 复位应答时的位持续时间称为初始etu,并由正式算出：<br> 初始etu = 372/f 秒，式中 f 的单位为Hz，表示复位响应时的初始频率。<br> • 复位应答（以及全局参数F与D的设立）之后的持续时间，称为当前etu，其计算公式为：<br> 当前etu=F/Df 秒，式中f 的单位为Hz，表示后续传送时的当前工作频率。<br> 复位应答期间使用的缺省值为：FI=1和DI=1，表示：F=372和D=1<br> <strong>• 基本响应：</strong> IC卡不回送TA1，则在整个后续信息交换过程中继续使用缺省值F=372和D=1。<br> <strong>• 终端反应：</strong> 终端不得拒绝一个回送TA1=“11”的IC卡（如果T0的b5位被置为1），并在所有后继交易中，继续使用F=372，D=1。</p> 
<p><strong>5.3.2 TB1</strong><br> TB1传送PI1和I1之值，其中：<br> – 在b1~b5位中定义，用于确定IC卡所需的最大编程电压P值。b1=0表示IC卡不使用Vpp。<br> – 在b6~b7位中定义，用于确定IC卡所需的最大编程电流I值。b1=0表示不使用此参数。<br> – b8位不使用，并设置为逻辑“0”。<br> <strong>• 基本响应：</strong> IC卡将回送TB1=“00”，表示IC卡不使用VPP。<br> <strong>• 终端响应：</strong> 若T0的b6被置“1”，IC卡回送的TB1为任意值时，或T0的b6被置为“0”，IC卡回送TB1时，终端不得拒绝此卡，但也不产生VPP，并继续用卡过程，就象回送了TB1=“00”一样。</p> 
<p><strong>5.3.3 TC1</strong><br> TC1传送N值，N为额外保护时间。N为TC1的b8<sub>b1位的二进制码，其值表示了额外保护时间所增加的etu数,其值为0</sub>255之间。N=255（TC1=“FF”）有特别的含义，它表明两相邻字符的起始位前沿之间的最短间隔时间： T=0为12etu；T=1为 11etu。<br> 注意，TC1仅用于从终端送到IC卡的两相邻字符间的定时，它既不用于从IC卡送到终端的两相邻字符间的定时，也不用于反向传送的二字符间的定时（请参看传输协议一节中关于T=0或T=1的时序的叙述）。<br> <strong>• 基本响应:</strong> IC卡回送的TC1之值应在“00”至“FF”的范围内。<br> <strong>• 终端响应:</strong> 当IC卡不回送TC1（假定T0的b7位被置为“0”）时，终端不得拒绝，并<br> 续用卡过程的处理，就像回送了TC1=“00”一样。<br> 建议在设计IC卡时，应把TC1置成IC卡可接受的最小值，较大的TC1值会导致终端和IC卡间的通信过慢，从而延长了交易时间。</p> 
<p><strong>5.3.4 TD1</strong><br> TD1表示有无更多的接口字节传送，以及关于传输协议类型的信息，其中<br> – 高半字节用来表示字符TA2至TD2是否存在，b5~b8各位中被置为逻辑“1”的，就表示相应的TA2至TD2中该字符的存在。<br> – 低半字节提供了关于后继交换所用传输协议类型的信息。<br> <strong>基本响应:</strong> 当选用T=0协议时，则IC卡将不回送TD1，后继传送协议缺省为T=0。当选用T=1协议时，则IC卡必须回送TD1=“81”，以表明TD2的存在，并后继传送传输协议为T=1。<br> <strong>终端反应:</strong> 当IC卡回送的TD1的高四位组有任意值（假设回送之值正确地表示并与实际回送的接口字符TA2至TD2一致），且低四位组之值为“0“或“1”，则终端不得拒绝。终端必须拒绝回送其它TD1之值的IC卡。</p> 
<p><strong>5.3.5 TA2</strong><br> 字符TA2的存在与否相应地表示IC卡是以特定模式或是交互模式工作。<br> <strong>基本响应:</strong> IC卡UQF 不回送TA2，TA2不存在表示以交互模式工作。<br> <strong>终端响应:</strong> 如果终端在复位应答期间能够支持由IC卡通过TA2所指明的额外条件，它不拒绝这样的IC卡，并应能立即使用这些条件。</p> 
<p><strong>5.3.6 TB2</strong><br> TB2传送PI2，PI2用于确定IC卡所需编程电压P的值。当它存在时，它就取代由TB1中回送的PI1的值。<br> <strong>基本响应:</strong> IC卡不应回送TB2。<br> <strong>终端反应:</strong> 终端不应拒绝IC卡回送TB2，但不论是否回送、回送了何值，终端均不产生VPP。</p> 
<p><strong>5.3.7 TC2</strong><br> TC2是T=0型协议所特有的，它传达了用来决定由IC卡发送的任意一个字符起始位上升沿与由IC卡或终端传送的前一字符的起始位上升沿之间的最大间隔的工作等待时间（WI）。工作等待时间为：960×D×WI。<br> <strong>基本响应:</strong> IC卡不得回送TC2，且后续通讯中使用缺省值WI=10。<br> <strong>终端反应:</strong> 终端不得拒绝回送TC2=10的IC卡。</p> 
<p><strong>5.3.8 TD2</strong><br> TD2表示是否还要发送更多的接口字节，以及关于后继传输所用的协议类型，其中<br> – 高半字节用来表示字符TA3至TD3是否存在，b5~b8各位中被置为逻辑“1”的，就表示相应的TA3至TD3的存在。<br> – 低半字节表示用于后继传送的协议类型，如果使用T=1，低半字节值为“1”。<br> <strong>基本响应：</strong> 如果使用的是T=0，则IC卡不回送TD2，后续传输协议缺省的T=0。如果使用的是T=1，而IC卡必须回送TD2=“31”，以表示TA3和TB3的存在，而后续传输协议为T=1。<br> <strong>终端反应：</strong> 当IC卡回送的TD2的高半字节有任意值（假设回送之值正确且与实际回送的接口字符TA3至TD3一致），而低半字节的值为“1”或“E”，则终端不得拒绝，终端必须拒绝回送其它TD2之值的IC卡。</p> 
<p><strong>5.3.9 TA3</strong><br> TA3回送信息域长度整数（IFSI），它决定了IC卡信息字段长度（IFSC），并规定了IC卡能够接收的字组的最大长度。它以字节形式表示IFSC的长度，取值范围为“01”至“FE”之间的任何值，“00”和“FF”二值留作备用。<br> <strong>基本响应：</strong> 如果使用了T=1，则IC卡必须以TA3为“10”至“FE”间之值予以回送，以表示初始的IFSC在16至254字节的范围内。<br> <strong>终端反应：</strong> 终端不得拒绝未回送TA3（假设TD2的b5位被置为“0”）的IC卡，但如果接受了这样的IC卡，它必须以“20”作为TA3之值继续用卡过程。终端必须拒绝回送的TA3之值在“00”至“0F”间或为“FF”的IC卡。</p> 
<p><strong>5.3.10 TB3</strong><br> TB3表明了用来计算CWT和BWT的CWI和BWI之值， TB3由两部分组成，低半字节（b1<sub>b4）用来表示CWI之值，而高半字节(b5</sub>b8)用来表示BWI之值。<br> <strong>基本响应：</strong> 如果使用了T=1，则IC卡应回送这样的TB3：高半字节取值为‘0’<sub>‘5’，低半字节取值为‘0’</sub>‘4’。即CWI之值为0至5之间，而BWI之值为0—4之间。</p> 
<p><strong>5.3.11 TC3</strong><br> TC3指明了所用的块错误检测代码的类型，类型由b1位表示，而b2至b8未用。<br> <strong>基本响应：</strong> 使用纵向冗余校验（LRC）作为错误检测码时，IC卡不必回送TC3。</p> 
<p><strong>5.4 历史字符T1、T2、Tk</strong><br> 指明了一些通用信息，如卡的制造商，卡中被嵌入的芯片、卡的文件状态等。</p> 
<p><strong>5.5 校验字符Tck</strong><br> TCK具有一个检验复位应答期间所发送数据完整性的值，TCK的值应使从T0至TCK（包括TCK）的所有字节的异或操作结果为0。<br> <strong>基本响应：</strong> 如使用T=0协议，将不发送TCK，而在其他情况下，都发送TCK。<br> <strong>终端反应：</strong> 在使用T=0协议时，终端应拒绝回送TCK的IC卡。如果IC卡回送了TCK，终端应能对TCK进行赋值。</p> 
<p><strong>6 ISO7816通信数据实例</strong><br> 本实例使用金思特电子的Kingst LA5016 usb 逻辑分析仪检测IOS7816数据通讯。以下几图是一个完整的数据包分析截图。从图中可以看到，IOS7816协议可以将ATR解析为初始字符TS，格式字符T0/T1，接口字符TAi~TDi，历史字符T1，T2，…，Tk, 及校验字符Tck等 。</p> 
<p>协议解析参数设置：<br> <img src="https://images2.imgbox.com/57/5e/4zWSW9XE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/98/ae/0SuacilP_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e1/60/vq2QvKpL_o.png" alt="在这里插入图片描述"><br> 参考资料：<a href="https://download.csdn.net/download/u013606261/14156177">ISO7816-1234.pdf</a><br> 下一章链接：<a href="https://blog.csdn.net/u013606261/article/details/112602983">ISO7816协议深度解析-简单易懂协议详解（二）</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3822a73a1a0fee6e1be2a80e2f5f4c4f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python练习——输入某年月日，判断是一年中第几天？（条件循环、输入、求和）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/234f185050b6ab8237073c086de633fe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring map 注入同类型bean</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>