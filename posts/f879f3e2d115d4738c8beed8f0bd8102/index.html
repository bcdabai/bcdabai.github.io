<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>openwrt源码框架解析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="openwrt源码框架解析" />
<meta property="og:description" content="转载自https://blog.csdn.net/clirus/article/details/50496958 本篇的主要目的是想通过分析Makefile，了解openwrt编译过程。着重关注以下几点：
openwrt目录结构
主Makefile的解析过程，各子目录的目标生成。
kernel编译过程
firmware的生成过程
软件包的编译过程 openwrt目录结构 官方源下载速度太度，我从github上clone了openwrt的代码仓库。
git clone https://github.com/openwrt-mirror/openwrt.git 上图是openwrt目录结构，其中第一行是原始目录，第二行是编译过程中生成的目录。各目录的作用是：
tools - 编译时需要一些工具， tools里包含了获取和编译这些工具的命令。里面是一些Makefile，有的可能还有patch。每个Makefile里都有一句 (eval ( e v a l (call HostBuild))，表示编译这个工具是为了在主机上使用的。
toolchain - 包含一些命令去获取kernel headers, C library, bin-utils, compiler, debugger
target - 各平台在这个目录里定义了firmware和kernel的编译过程。
package - 包含针对各个软件包的Makefile。openwrt定义了一套Makefile模板，各软件参照这个模板定义了自己的信息，如软件包的版本、下载地址、编译方式、安装地址等。
include - openwrt的Makefile都存放在这里。
scripts - 一些perl脚本，用于软件包管理。
dl - 软件包下载后都放到这个目录里
build_dir - 软件包都解压到build_dir/里，然后在此编译
staging_dir - 最终安装目录。tools, toolchain被安装到这里，rootfs也会放到这里。
feeds - OpenWrt环境所需要的软件包套件 bin - 编译完成之后，firmware和各ipk会放到此目录下。
feeds说明： 最重要的feeds有：
‘packages’一些额外的基础路由器特性软件
‘LuCI’OpenWrt默认的GUI
‘Xwrt’另一种可选的GUI界面
需要能够连接互联网。
在下载之前可以通过查看’feeds.conf.default’文件，来检查哪些文件需要包含在环境中。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f879f3e2d115d4738c8beed8f0bd8102/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-08-30T13:50:36+08:00" />
<meta property="article:modified_time" content="2018-08-30T13:50:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">openwrt源码框架解析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>转载自<a href="https://blog.csdn.net/clirus/article/details/50496958">https://blog.csdn.net/clirus/article/details/50496958</a> <br> <br> </p> 
<div class="htmledit_views"></div> 
<p></p> 
<p></p> 
<div class="Blog_wz1"> 
 <p> 本篇的主要目的是想通过分析Makefile，了解openwrt编译过程。着重关注以下几点：</p> 
 <ol><li> openwrt目录结构<br></li><li> 主Makefile的解析过程，各子目录的目标生成。<br></li><li> kernel编译过程<br></li><li> firmware的生成过程<br></li><li> 软件包的编译过程</li></ol> 
 <h3 id="openwrt"> openwrt目录结构</h3> 
 <p> 官方源下载速度太度，我从github上clone了openwrt的代码仓库。</p> 
 <pre>git clone http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/openwrt-mirror/openwrt.git</pre> 
 <p> <img src="https://images2.imgbox.com/3f/f6/9BNe42Es_o.png" alt="openwrt目录结构"></p> 
 <p> 上图是openwrt目录结构，其中第一行是原始目录，第二行是编译过程中生成的目录。各目录的作用是：</p> 
 <ul><li> tools - 编译时需要一些工具， tools里包含了获取和编译这些工具的命令。里面是一些Makefile，有的可能还有patch。每个Makefile里都有一句 <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-7-Frame" tabindex="0" style="position: relative;"> 
     
     <span class="math" id="MathJax-Span-43" style="width: 2.767em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.222em; height: 0px; font-size: 123%;"><span style="position: absolute; clip: rect(1.31em, 1002.19em, 2.635em, -1000em); top: -2.222em; left: 0em;"><span class="mrow" id="MathJax-Span-44"><span class="mo" id="MathJax-Span-45" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-46" style="font-family: MathJax_Math; font-style: italic;">e</span><span class="mi" id="MathJax-Span-47" style="font-family: MathJax_Math; font-style: italic;">v</span><span class="mi" id="MathJax-Span-48" style="font-family: MathJax_Math; font-style: italic;">a</span><span class="mi" id="MathJax-Span-49" style="font-family: MathJax_Math; font-style: italic;">l</span></span><span style="display: inline-block; width: 0px; height: 2.222em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.374em; border-left: 0px solid; width: 0px; height: 1.363em;"></span></span> 
    <span class="MJX_Assistive_MathML"> 
      
      
        ( 
       
      
        e 
       
      
        v 
       
      
        a 
       
      
        l 
       
     </span></span><script type="math/tex" id="MathJax-Element-7">(eval </script>(call HostBuild))，表示编译这个工具是为了在主机上使用的。<br></li><li> toolchain - 包含一些命令去获取kernel headers, C library, bin-utils, compiler, debugger<br></li><li> target - 各平台在这个目录里定义了firmware和kernel的编译过程。<br></li><li> package - 包含针对各个软件包的Makefile。openwrt定义了一套Makefile模板，各软件参照这个模板定义了自己的信息，如软件包的版本、下载地址、编译方式、安装地址等。<br></li><li> include - openwrt的Makefile都存放在这里。<br></li><li> <p> scripts - 一些perl脚本，用于软件包管理。</p> </li><li> dl - 软件包下载后都放到这个目录里<br></li><li> build_dir - 软件包都解压到build_dir/里，然后在此编译<br></li><li> staging_dir - 最终安装目录。tools, toolchain被安装到这里，rootfs也会放到这里。<br></li><li> feeds - OpenWrt环境所需要的软件包套件</li><li> <p> bin - 编译完成之后，firmware和各ipk会放到此目录下。</p> </li></ul> 
 <div> 
   
 </div> 
 <div> 
  feeds说明： 
 </div> 
 <p></p> 
 <div> 
   
 </div> 
 <p></p> 
 <p> </p> 
 <p> 最重要的feeds有：</p> 
 <p> ‘packages’一些额外的基础路由器特性软件</p> 
 <p> ‘LuCI’OpenWrt默认的GUI</p> 
 <p> ‘Xwrt’另一种可选的GUI界面</p> 
 <p> 需要能够连接互联网。</p> 
 <p> 在下载之前可以通过查看’feeds.conf.default’文件，来检查哪些文件需要包含在环境中。</p> 
 <p> 开始下载，使用：</p> 
 <p> [openwrt@localhost trunk]$ ./scripts/feeds update -a</p> 
 <p> 安装feeds包，只有安装之后，在后面的make menuconfig时，才可以对相关配置进行勾选。</p> 
 <p> [openwrt@localhost trunk]$ ./scripts/feeds install -a</p> 
 <p> 如果更新了feeds的配置文件，需要添加新的软件包用于生成系统。只需进行重复操作：</p> 
 <p> [openwrt@localhost trunk]$ ./scripts/feeds update -a</p> 
 <p> [openwrt@localhost trunk]$ ./scripts/feeds install -a</p> 
 <p> <br></p> 
 <p> 可使用的feeds列表配置在feeds.conf目录下或者feeds.conf.default。这个文件包含了feeds列表，每一行又三部分组成，feed方法，feed 名字和feed源</p> 
 <p> 下面是一个feeds.conf.default的例子：</p> 
 <p></p> 
 <pre>src-git packages <a href="https://github.com/openwrt/packages.git">https://github.com/openwrt/packages.git</a> <br>
src-git luci <a href="http://git.openwrt.org/project/luci.git" rel="nofollow">http://git.openwrt.org/project/luci.git</a> <br>
src-git routing <a href="https://github.com/openwrt-routing/packages.git">https://github.com/openwrt-routing/packages.git</a> <br>
src-git telephony <a href="http://git.openwrt.org/feed/telephony.git" rel="nofollow">http://git.openwrt.org/feed/telephony.git</a> <br>
src-git management <a href="https://github.com/openwrt-management/packages.git">https://github.com/openwrt-management/packages.git</a> <br>
src-git oldpackages <a href="http://git.openwrt.org/packages.git" rel="nofollow">http://git.openwrt.org/packages.git</a></pre> 
 <p></p> 
</div> #src-svn xwrt http://x-wrt.googlecode.com/svn/trunk/package #src-svn phone svn://svn.openwrt.org/openwrt/feeds/phone #src-svn efl svn://svn.openwrt.org/openwrt/feeds/efl #src-svn xorg svn://svn.openwrt.org/openwrt/feeds/xorg #src-svn desktop svn://svn.openwrt.org/openwrt/feeds/desktop #src-svn xfce svn://svn.openwrt.org/openwrt/feeds/xfce #src-svn lxde svn://svn.openwrt.org/openwrt/feeds/lxde #src-link custom /usr/src/openwrt/custom-feed 
<p> 下面是feed支持的方法类型：</p> 
<p> src-bzr    通过使用bzr从数据源的path/URL下载数据</p> 
<p> src-cpy   通过从数据源path拷贝数据</p> 
<p> src-darcs  通过使用darcs从数据源path/URL下载数据</p> 
<p> src-git     通过使用git从数据源path/URL下载数据</p> 
<p> src-hg     通过使用hg从数据源path/URL 下载数据</p> 
<p> src-link   创建一个数据源path的symlink</p> 
<p> src-svn    通过使用svn从数据源path/URL下载数据</p> 
<div> 
 <br> 
</div> 
<p> <a href="http://www.ccs.neu.edu/home/noubir/Courses/CS6710/S12/material/OpenWrt_Dev_Tutorial.pdf" rel="nofollow noopener noreferrer" target="_blank">OpenWrt Development Guide</a></p> 
<h3 id="main-makefile"> main Makefile</h3> 
<p> openwrt根目录下的Makefile是执行make命令时的入口。从这里开始分析。</p> 
<pre>world:

ifndef ($(OPENWRT_BUILD),<span class="hljs-number">1</span>) <span class="hljs-comment"># 第一个逻辑</span> <span class="hljs-keyword">...</span> <span class="hljs-keyword">else</span> <span class="hljs-comment"># 第二个逻辑</span> <span class="hljs-keyword">...</span> endif</pre> 
<p> 上面这段是主Makefile的结构，可以得知：</p> 
<ol><li> 执行make时，若无任何目标指定，则默认目标是world<br></li><li> 执行make时，无参数指定，则会进入第一个逻辑。如果执行命令make OPENWRT_BUILD=1，则直接进入第二个逻辑。</li></ol> 
<p> 编译时一般直接使用make V=s -j5这样的命令，不会指定OPENWRT_BUILD变量</p> 
<h4 id="第一个逻辑"> 第一个逻辑</h4> 
<pre> <span class="hljs-keyword">override</span> OPENWRT_BUILD=<span class="hljs-number">1</span> <span class="hljs-keyword">export</span> OPENWRT_BUILD</pre> 
<p> 更改了OPENWRT_BUILD变量的值。这里起到的作用是下次执行make时，会进入到第二逻辑中。</p> 
<p> toplevel.mk中的 %:: 解释world目标的规则。</p> 
<pre>prereq:: prepare-tmpinfo .config <span class="hljs-variable">@+</span><span class="hljs-variable">$(&lt;/span&gt;MAKE) -r -s tmp/.prereq-build &lt;span class="hljs-variable"&gt;$(</span>PREP_MK) <span class="hljs-variable">@+</span><span class="hljs-variable">$(&lt;/span&gt;NO_TRACE_MAKE) -r -s &lt;span class="hljs-variable"&gt;$@</span> <span class="hljs-variable">%:</span>: <span class="hljs-variable">@+</span><span class="hljs-variable">$(&lt;/span&gt;PREP_MK) &lt;span class="hljs-variable"&gt;$(</span>NO_TRACE_MAKE) -r -s prereq <span class="hljs-variable">@(</span> \
        cp .config tmp/.config; \
        ./scripts/config/conf --defconfig=tmp/.config -w tmp/.config Config.<span class="hljs-keyword">in</span> &gt; /dev/null <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>; \ <span class="hljs-keyword">if</span> ./scripts/kconfig.pl <span class="hljs-string">'&gt;'</span> .config tmp/.config | grep -q CONFIG; then \
            printf <span class="hljs-string">"$(_R)WARNING: your configuration is out of sync. Please run make menuconfig, oldconfig or defconfig!$(_N)\n"</span> &gt;&amp;<span class="hljs-number">2</span>; \
        fi \
    ) <span class="hljs-variable">@+</span><span class="hljs-variable">$(&lt;/span&gt;ULIMIT_FIX) &lt;span class="hljs-variable"&gt;$(</span>SUBMAKE) -r <span class="hljs-variable">$@</span></pre> 
<p> 执行 make V=s 时，上面这段规则简化为：</p> 
<pre>prereq:: prepare-tmpinfo .config <span class="hljs-variable">@make</span> -r -s tmp/.prereq-build <span class="hljs-variable">@make</span> V=ss -r -s prereq <span class="hljs-variable">%:</span>: <span class="hljs-variable">@make</span> V=s -r -s prereq <span class="hljs-variable">@make</span> -w -r world</pre> 
<p> 可见其中最终又执行了prereq和world目标，这两个目标都会进入到第二逻辑中。</p> 
<h4 id="第二逻辑"> 第二逻辑</h4> 
<p> 首先就引入了target, package, tools, toolchain这四个关键目录里的Makefile文件</p> 
<pre> <span class="hljs-keyword">include</span> target/<span class="hljs-constant">Makefile</span> <span class="hljs-keyword">include</span> package/<span class="hljs-constant">Makefile</span> <span class="hljs-keyword">include</span> tools/<span class="hljs-constant">Makefile</span> <span class="hljs-keyword">include</span> toolchain/<span class="hljs-constant">Makefile</span></pre> 
<p> 这些子目录里的Makefile使用include/subdir.mk里定义的两个函数来动态生成规则，这两个函数是subdir和stampfile</p> 
<h5 id="stampfile"> stampfile</h5> 
<p> 拿target/Makefile举例：</p> 
<p> <span class="MathJax_Preview"></span>(eval(call stampfile,$(curdir),target,prereq,.config))</p> 
<p> 会生成规则：</p> 
<pre> target/stamp-prereq:=<span class="hljs-variable">$(&lt;/span&gt;STAGING_DIR)/stamp/.target_prereq &lt;span class="hljs-variable"&gt;$$&lt;/span&gt;(target/stamp-prereq): &lt;span class="hljs-variable"&gt;$(</span>TMP_DIR)/.build .config <span class="hljs-variable">@+</span><span class="hljs-variable">$(</span>SCRIPT_DIR)/timestamp.pl -n <span class="hljs-variable">$$</span>(target/stamp-prereq) target .config || \
        make <span class="hljs-variable">$$&lt;/span&gt;(target/flags-prereq) target/prereq &lt;span class="hljs-variable"&gt;@mkdir&lt;/span&gt; -p &lt;span class="hljs-variable"&gt;$$</span><span class="hljs-variable">$$&lt;/span&gt;(&lt;span class="hljs-keyword" style="color:rgb(0,0,255);"&gt;dirname&lt;/span&gt; &lt;span class="hljs-variable"&gt;$$</span>(target/stamp-prereq)) <span class="hljs-variable">@touch</span> <span class="hljs-variable">$$&lt;/span&gt;(target/stamp-prereq) &lt;span class="hljs-variable"&gt;$$</span>(<span class="hljs-keyword">if</span> <span class="hljs-variable">$(</span>call debug,target,v),,.SILENT: <span class="hljs-variable">$$</span>(target/stamp-prereq))

  .PRECIOUS: <span class="hljs-variable">$$</span>(target/stamp-prereq) # work around a make bug

  target<span class="hljs-comment">//clean:=target/stamp-prereq/clean</span> target/stamp-prereq/clean: FORCE <span class="hljs-variable">@rm</span> -f <span class="hljs-variable">$$&lt;/span&gt;(target/stamp-prereq) &lt;/pre&gt;
&lt;p style="font-size:12px;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;
所以可以简单的看作：&amp;nbsp;&lt;span class="MathJax_Preview" style="color:rgb(136,136,136);"&gt;&lt;/span&gt;(eval(call stampfile,&lt;span class="MathJax_Preview" style="color:rgb(136,136,136);"&gt;&lt;/span&gt;(curdir),target,prereq,.config))生成了目标(target/stamp-prereq)&lt;/p&gt;
&lt;ul style="font-size:12px;list-style:none;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;&lt;li style="list-style: !important;"&gt;
对于target分别生成了：&lt;span class="MathJax_Preview" style="color:rgb(136,136,136);"&gt;&lt;/span&gt;(target/stamp?preq)，(target/stamp-copile)， $(target/stamp-install)&lt;br&gt;&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
toolchain : $(toolchain/stamp-install)&lt;br&gt;&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
package :&amp;nbsp;&lt;span class="MathJax_Preview" style="color:rgb(136,136,136);"&gt;&lt;/span&gt;(package/stamp?preq),(package/stamp-cleanup),&amp;nbsp;&lt;span class="MathJax_Preview" style="color:rgb(136,136,136);"&gt;&lt;/span&gt;(package/stamp?compile),(package/stamp-install)&lt;br&gt;&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
tools : $(tools/stamp-install)&lt;/li&gt;&lt;/ul&gt;&lt;p style="font-size:12px;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;
&lt;a href="http://www.right.com.cn/forum/thread-73443-1-3.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);" target="_blank"&gt;OpenWrt的主Makefile工作过程&lt;/a&gt;&lt;/p&gt;
&lt;h4 id="subdir" style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;"&gt;
subdir&lt;/h4&gt;
&lt;p style="font-size:12px;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;
subdir这个函数写了一大堆东西，看起来很复杂 。&lt;/p&gt;
&lt;p style="font-size:12px;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;
$(call subdir, target) 会遍历下的子目录，执行 make -C 操作。这样就切入子目录中去了。&lt;/p&gt;
&lt;h3 style="font-size:16px;font-family:Verdana, Arial, Helvetica, sans-serif;"&gt;&lt;a name="t4"&gt;&lt;/a&gt;
目录变量&lt;/h3&gt;
&lt;p style="font-size:12px;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;
几个重要的目录路径：&lt;/p&gt;
&lt;ul style="font-size:12px;list-style:none;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;&lt;li style="list-style: !important;"&gt;
&lt;p&gt;
KERNEL_BUILD_DIR&lt;/p&gt;
&lt;blockquote style="border:2px solid rgb(239,239,239);color:rgb(51,51,51);min-height:35px;line-height:1.6em;"&gt;
&lt;p&gt;
build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/linux-3.14.18&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
&lt;p&gt;
LINUX_DIR&lt;/p&gt;
&lt;blockquote style="border:2px solid rgb(239,239,239);color:rgb(51,51,51);min-height:35px;line-height:1.6em;"&gt;
&lt;p&gt;
build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/linux-3.14.18&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
&lt;p&gt;
KDIR&lt;/p&gt;
&lt;blockquote style="border:2px solid rgb(239,239,239);color:rgb(51,51,51);min-height:35px;line-height:1.6em;"&gt;
&lt;p&gt;
build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
&lt;p&gt;
BIN_DIR&lt;/p&gt;
&lt;blockquote style="border:2px solid rgb(239,239,239);color:rgb(51,51,51);min-height:35px;line-height:1.6em;"&gt;
&lt;p&gt;
bin/ramips&lt;br&gt;
Makefile中包含了rules.mk, target.mk等.mk文件，这些文件中定义了许多变量，有些是路径相关的，有些是软件相关的。这些变量在整个Makefile工程中经常被用到，&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
&lt;p&gt;
TARGET_ROOTFS_DIR&lt;/p&gt;
&lt;blockquote style="border:2px solid rgb(239,239,239);color:rgb(51,51,51);min-height:35px;line-height:1.6em;"&gt;
&lt;p&gt;
build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
&lt;p&gt;
BUILD_DIR&lt;/p&gt;
&lt;blockquote style="border:2px solid rgb(239,239,239);color:rgb(51,51,51);min-height:35px;line-height:1.6em;"&gt;
&lt;p&gt;
build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
&lt;p&gt;
STAGING_DIR_HOST&lt;/p&gt;
&lt;blockquote style="border:2px solid rgb(239,239,239);color:rgb(51,51,51);min-height:35px;line-height:1.6em;"&gt;
&lt;p&gt;
staging_dir/toolchain-mipsel_24kec+dsp_gcc-4.8-linaro_uClibc-0.9.33.2&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;&lt;li style="list-style: !important;"&gt;
&lt;p&gt;
TARGET_DIR&lt;/p&gt;
&lt;blockquote style="border:2px solid rgb(239,239,239);color:rgb(51,51,51);min-height:35px;line-height:1.6em;"&gt;
&lt;p&gt;
build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/root-ramips&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;&lt;/ul&gt;&lt;h2 id="kernel-" style="font-size:21px;font-family:Verdana, Arial, Helvetica, sans-serif;"&gt;&lt;a name="t5"&gt;&lt;/a&gt;
kernel 编译：&lt;/h2&gt;
&lt;p style="font-size:12px;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;
target/linux/ramips/Makefile:&amp;nbsp;$(eval $(call BuildTarget))&lt;br&gt;
target/linux/Makefile :&amp;nbsp;export TARGET_BUILD=1&lt;br&gt;
include/target.mk:&lt;/p&gt;
&lt;pre style="font-size:12px;line-height:21px;background-color:rgb(255,255,255);"&gt;ife&lt;span class="hljs-string" style="color:rgb(163,21,21);"&gt;q (&lt;span class="hljs-variable"&gt;$(&lt;/span&gt;TARGET_BUILD)&lt;/span&gt;,&lt;span class="hljs-number"&gt;1&lt;/span&gt;)
  include &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;INCLUDE_DIR)/kernel-build.mk
  BuildTarget?=&lt;span class="hljs-variable"&gt;$(&lt;/span&gt;BuildKernel)
endif&lt;/pre&gt;
&lt;p style="font-size:12px;font-family:Verdana, Arial, Helvetica, sans-serif;line-height:21px;"&gt;
BuildKernel是include/kernel-build.mk定义的一个多行变量，其中描述了如何编译内核, 主要关注其中install规则的依赖链：&lt;/p&gt;
&lt;pre style="font-size:12px;line-height:21px;background-color:rgb(255,255,255);"&gt; &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;KERNEL_BUILD_DIR)/symtab.h: FORCE
	rm -f &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;KERNEL_BUILD_DIR)/symtab.h
	touch &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;KERNEL_BUILD_DIR)/symtab.h
	+&lt;span class="hljs-variable"&gt;$(&lt;/span&gt;MAKE) &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;KERNEL_MAKEOPTS) vmlinux
	... &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;LINUX_DIR)/.&lt;span class="hljs-keyword" style="color:rgb(0,0,255);"&gt;image&lt;/span&gt;: &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;STAMP_CONFIGURED) &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;&lt;span class="hljs-keyword" style="color:rgb(0,0,255);"&gt;if&lt;/span&gt; &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;CONFIG_STRIP_KERNEL_EXPORTS),&lt;span class="hljs-variable"&gt;$(&lt;/span&gt;KERNEL_BUILD_DIR)/symtab.h) FORCE &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;Kernel/CompileImage) &lt;span class="hljs-variable"&gt;$(&lt;/span&gt;Kernel/CollectDebug)
	touch &lt;span class="hljs-variable"&gt;$$</span>@


  install: <span class="hljs-variable">$(&lt;/span&gt;LINUX_DIR)/.&lt;span class="hljs-keyword" style="color:rgb(0,0,255);"&gt;image&lt;/span&gt; +&lt;span class="hljs-variable"&gt;$(</span>MAKE) -C <span class="hljs-keyword">image</span> compile install TARGET_BUILD= </pre> 
<pre><span class="hljs-number">1</span>. 触发make vmlinux命令生成vmlinux： install --&gt; <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;LINUX_DIR)&lt;/span&gt;/.image --&amp;gt; &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">KERNEL_BUILD_DIR)</span>/symtab.h --&gt; `<span class="hljs-variable">$(</span><span class="hljs-constant">MAKE)</span> <span class="hljs-variable">$(</span><span class="hljs-constant">KERNEL_MAKEOPTS)</span> vmlinux` <span class="hljs-number">2</span>. 对vmlinux做objcopy, strip操作<span class="hljs-symbol">:</span> <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;LINUX_DIR)&lt;/span&gt;/.image --&amp;gt; &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">Kernel/CompileImage)</span> --&gt; <span class="hljs-variable">$(&lt;/span&gt;call &lt;span class="hljs-constant"&gt;Kernel/CompileImage/Default)&lt;/span&gt; --&amp;gt; &lt;span class="hljs-variable"&gt;$(</span>call <span class="hljs-constant">Kernel/CompileImage/Default)</span> <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;KERNEL_CROSS)&lt;/span&gt;objcopy -&lt;span class="hljs-constant"&gt;O &lt;/span&gt;binary &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">OBJCOPY_STRIP)</span> -<span class="hljs-constant">S </span><span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;LINUX_DIR)&lt;/span&gt;/vmlinux &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">LINUX_KERNEL)</span><span class="hljs-variable">$(</span><span class="hljs-number">1</span>)
        --&gt; build_dir/target-mipsel_24kec+dsp_uClibc-<span class="hljs-number">0</span>.<span class="hljs-number">9.33</span>.<span class="hljs-number">2</span>/linux-ramips_mt7620a/vmlinux <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;KERNEL_CROSS)&lt;/span&gt;objcopy &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">OBJCOPY_STRIP)</span> -<span class="hljs-constant">S </span><span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;LINUX_DIR)&lt;/span&gt;/vmlinux &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">KERNEL_BUILD_DIR)</span>/vmlinux<span class="hljs-variable">$(</span><span class="hljs-number">1</span>).elf
        --&gt; build_dir/target-mipsel_24kec+dsp_uClibc-<span class="hljs-number">0</span>.<span class="hljs-number">9.33</span>.<span class="hljs-number">2</span>/linux-ramips_mt7620a/vmlinux.elf <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;CP)&lt;/span&gt; &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">LINUX_DIR)</span>/vmlinux <span class="hljs-variable">$(</span><span class="hljs-constant">KERNEL_BUILD_DIR)</span>/vmlinux.debug
        --&gt; build_dir/target-mipsel_24kec+dsp_uClibc-<span class="hljs-number">0</span>.<span class="hljs-number">9.33</span>.<span class="hljs-number">2</span>/linux-ramips_mt7620a/vmlinux.debug</pre> 
<h3 id="firmware"> 生成firmware</h3> 
<p> firmware由kernel和rootfs两个部分组成，要对两个部分先分别处理，然后再合并成一个.bin文件。先看一下这个流程。</p> 
<p> “target/linux/ramips/image/Makefile” 文件中的最后一句：<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" style="position: relative;"> 
   
   <span class="math" id="MathJax-Span-8" style="width: 2.839em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.163em; height: 0px; font-size: 130%;"><span style="position: absolute; clip: rect(1.317em, 1002.13em, 2.606em, -1000em); top: -2.212em; left: 0em;"><span class="mrow" id="MathJax-Span-9"><span class="mo" id="MathJax-Span-10" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-11" style="font-family: MathJax_Math; font-style: italic;">e</span><span class="mi" id="MathJax-Span-12" style="font-family: MathJax_Math; font-style: italic;">v</span><span class="mi" id="MathJax-Span-13" style="font-family: MathJax_Math; font-style: italic;">a</span><span class="mi" id="MathJax-Span-14" style="font-family: MathJax_Math; font-style: italic;">l</span></span><span style="display: inline-block; width: 0px; height: 2.212em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.388em; border-left: 0px solid; width: 0px; height: 1.425em;"></span></span> 
  <span class="MJX_Assistive_MathML"> 
    
    
      ( 
     
    
      e 
     
    
      v 
     
    
      a 
     
    
      l 
     
   </span></span><script type="math/tex" id="MathJax-Element-2">(eval </script>(call BuildImage))，将BuildImage展开在这里。BuildImage定义在 include/image.mk 文件中，其中定义了数个目标的规则。</p> 
<pre>define BuildImage

    compile: compile-targets FORCE
        **$(call Build/Compile)**

    install: compile install-targets FORCE <span class="hljs-keyword">...</span> $(call Image/BuildKernel) &lt;span class="hljs-comment" style="color:#008000;"&gt;## 处理vmlinux&lt;/span&gt; &lt;span class="hljs-keyword" style="color:rgb(0,0,255);"&gt;...&lt;/span&gt; $(call Image/mkfs/squashfs) <span class="hljs-comment">## 生成squashfs，并与vmlinux合并成一个.bin文件</span> <span class="hljs-keyword">...</span> endef</pre> 
<h4 id="vmlinux-imagebuildkernel"> 处理vmlinux: Image/BuildKernel</h4> 
<p> target/linux/ramips/image/Makefile:</p> 
<pre>define Image/BuildKernel
    cp <span class="hljs-variable">$(KDIR)&lt;/span&gt;/vmlinux.elf &lt;span class="hljs-variable"&gt;$(BIN_DIR)</span>/<span class="hljs-variable">$(VMLINUX)</span>.elf
    cp <span class="hljs-variable">$(KDIR)&lt;/span&gt;/vmlinux &lt;span class="hljs-variable"&gt;$(BIN_DIR)</span>/<span class="hljs-variable">$(VMLINUX)&lt;/span&gt;.bin &lt;span class="hljs-variable"&gt;$(call CompressLzma,$(KDIR)&lt;/span&gt;/vmlinux,&lt;span class="hljs-variable"&gt;$(KDIR)</span>/vmlinux.bin.lzma) <span class="hljs-variable">$(call MkImage,lzma,$(KDIR)</span>/vmlinux.bin.lzma,<span class="hljs-variable">$(KDIR)</span>/uImage.lzma)
    cp <span class="hljs-variable">$(KDIR)&lt;/span&gt;/uImage.lzma &lt;span class="hljs-variable"&gt;$(BIN_DIR)</span>/<span class="hljs-variable">$(UIMAGE)</span>.bin
ifneq ($(CONFIG_TARGET_ROOTFS_INITRAMFS),)
    cp <span class="hljs-variable">$(KDIR)&lt;/span&gt;/vmlinux-initramfs.elf &lt;span class="hljs-variable"&gt;$(BIN_DIR)</span>/<span class="hljs-variable">$(VMLINUX)</span>-initramfs.elf
    cp <span class="hljs-variable">$(KDIR)&lt;/span&gt;/vmlinux-initramfs &lt;span class="hljs-variable"&gt;$(BIN_DIR)</span>/<span class="hljs-variable">$(VMLINUX)&lt;/span&gt;-initramfs.bin &lt;span class="hljs-variable"&gt;$(call CompressLzma,$(KDIR)&lt;/span&gt;/vmlinux-initramfs,&lt;span class="hljs-variable"&gt;$(KDIR)</span>/vmlinux-initramfs.bin.lzma) <span class="hljs-variable">$(call MkImage,lzma,$(KDIR)</span>/vmlinux-initramfs.bin.lzma,<span class="hljs-variable">$(KDIR)</span>/uImage-initramfs.lzma)
    cp <span class="hljs-variable">$(KDIR)&lt;/span&gt;/uImage-initramfs.lzma &lt;span class="hljs-variable"&gt;$(BIN_DIR)</span>/<span class="hljs-variable">$(UIMAGE)</span>-initramfs.bin
endif <span class="hljs-variable">$(call Image/Build/Initramfs)</span> endef</pre> 
<h5 id="lzma"> lzma压缩内核</h5> 
<p> build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/ 目录中:</p> 
<pre><span class="hljs-title">lzma</span> e vmlinux -lc1 -lp2 -pb2 vmlinux.bin.lzma</pre> 
<h5 id="mkimage"> MkImage</h5> 
<p> build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/ 目录中：</p> 
<pre>mkimage -A mips -O linux -T  kernel -C lzma <span class="hljs-operator">-a</span> <span class="hljs-number">0</span>x80000000 <span class="hljs-operator">-e</span> <span class="hljs-number">0</span>x80000000 -n <span class="hljs-string">"MIPS OpenWrt Linux-3.14.18"</span> <span class="hljs-operator">-d</span> vmlinux.bin.lzma uImage.lzma</pre> 
<h5 id="copy"> copy</h5> 
<pre><span class="hljs-constant">VMLINUX:</span>=<span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;IMG_PREFIX)&lt;/span&gt;-vmlinux --&amp;gt; openwrt-ramips-mt7620a-vmlinux &lt;span class="hljs-constant"&gt;UIMAGE:&lt;/span&gt;=&lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">IMG_PREFIX)</span>-uImage --&gt; openwrt-ramips-mt7620a-uImage
cp <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;KDIR)&lt;/span&gt;/uImage.lzma &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">BIN_DIR)</span>/<span class="hljs-variable">$(</span><span class="hljs-constant">UIMAGE)</span>.bin</pre> 
<p> 把uImage.lzma复制到bin/ramips/目录下：<br> cp $(KDIR)/uImage.lzma bin/ramips/openwrt-ramips-mt7620a-uImage</p> 
<h4 id="squashfs.bin-call-imagemkfssquashfs"> 制作squashfs，生成.bin: $(call Image/mkfs/squashfs)</h4> 
<pre> define <span class="hljs-constant">Image</span>/mkfs/squashfs <span class="hljs-variable">@mkdir</span> -p <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;TARGET_DIR&lt;/span&gt;)/overlay &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">STAGING_DIR_HOST</span>)/bin/mksquashfs4 <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;TARGET_DIR&lt;/span&gt;) &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">KDIR</span>)/root.squashfs -nopad -noappend -root-owned -comp <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;SQUASHFSCOMP&lt;/span&gt;) &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">SQUASHFSOPT</span>) -processors <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-keyword" style="color:rgb(0,0,255);"&gt;if&lt;/span&gt; &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">CONFIG_PKG_BUILD_JOBS</span>),<span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;CONFIG_PKG_BUILD_JOBS&lt;/span&gt;),&lt;span class="hljs-number"&gt;1&lt;/span&gt;) &lt;span class="hljs-variable"&gt;$(</span>call <span class="hljs-constant">Image</span>/<span class="hljs-constant">Build</span>,squashfs)
endif</pre> 
<h5 id="mkdir--p-target_diroverlay"> mkdir -p $(TARGET_DIR)/overlay</h5> 
<p> mkdir -p build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/root-ramips/overlay</p> 
<h5 id="mksquashfs4"> mksquashfs4</h5> 
<pre><span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;STAGING_DIR_HOST&lt;/span&gt;)/bin/mksquashfs4 &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">TARGET_DIR</span>) <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;KDIR&lt;/span&gt;)/root.squashfs -nopad -noappend -root-owned -comp &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">SQUASHFSCOMP</span>) <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;SQUASHFSOPT&lt;/span&gt;) -processors &lt;span class="hljs-variable"&gt;$(</span><span class="hljs-keyword">if</span> <span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;CONFIG_PKG_BUILD_JOBS&lt;/span&gt;),&lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">CONFIG_PKG_BUILD_JOBS</span>),<span class="hljs-number">1</span>)</pre> 
<p> 制作squashfs文件系统，生成root.squashfs:</p> 
<pre>mksquashfs4 root-ramips root.squashfs -nopad -noappend -root-owned -<span class="hljs-keyword">comp</span> gzip -<span class="hljs-keyword">b</span> <span class="hljs-number">256</span><span class="hljs-keyword">k</span> -<span class="hljs-keyword">p</span> <span class="hljs-string">'/dev d 755 0 0'</span> -<span class="hljs-keyword">p</span> <span class="hljs-string">'/dev/console c 600 0 0 5 1'</span> -processors <span class="hljs-number">1</span></pre> 
<h5 id="call-imagebuildsquashfs"> $(call Image/Build,squashfs)</h5> 
<p> 在 target/linux/ramips/image/Makefile 中：</p> 
<pre>define <span class="hljs-constant">Image</span>/<span class="hljs-constant">Build</span> <span class="hljs-variable">$(&lt;/span&gt;call &lt;span class="hljs-constant"&gt;Image&lt;/span&gt;/&lt;span class="hljs-constant"&gt;Build&lt;/span&gt;/&lt;span class="hljs-variable"&gt;$(</span><span class="hljs-number">1</span>))
    dd <span class="hljs-keyword">if</span>=<span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;KDIR&lt;/span&gt;)/root.&lt;span class="hljs-variable"&gt;$(</span><span class="hljs-number">1</span>) of=<span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;BIN_DIR&lt;/span&gt;)/&lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">IMG_PREFIX</span>)-root.<span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-number"&gt;1&lt;/span&gt;) bs=&lt;span class="hljs-number"&gt;128&lt;/span&gt;k conv=sync &lt;span class="hljs-variable"&gt;$(</span>call <span class="hljs-constant">Image</span>/<span class="hljs-constant">Build</span>/<span class="hljs-constant">Profile</span>/<span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;PROFILE&lt;/span&gt;),&lt;span class="hljs-variable"&gt;$(</span><span class="hljs-number">1</span>))
endef</pre> 
<ul><li> dd if=<span class="MathJax_Preview"></span>(KDIR)/root.squashfsof=(BIN_DIR)/$(IMG_PREFIX)-root.squashfs bs=128k conv=sync</li></ul> 
<p> dd if=build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/root.squashfs of=bin/ramips/openwrt-ramips-mt7620-root.squashfs bs=128k conv=sync</p> 
<ul><li> <span class="MathJax_Preview"></span>(callImage/Build/Profile/(PROFILE),squashfs)</li></ul> 
<p> target/linux/ramips/mt7620a/profiles/00-default.mk, 中调用 Profile 函数：<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" style="position: relative;"> 
   
   <span class="math" id="MathJax-Span-15" style="width: 2.839em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.163em; height: 0px; font-size: 130%;"><span style="position: absolute; clip: rect(1.317em, 1002.13em, 2.606em, -1000em); top: -2.212em; left: 0em;"><span class="mrow" id="MathJax-Span-16"><span class="mo" id="MathJax-Span-17" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-18" style="font-family: MathJax_Math; font-style: italic;">e</span><span class="mi" id="MathJax-Span-19" style="font-family: MathJax_Math; font-style: italic;">v</span><span class="mi" id="MathJax-Span-20" style="font-family: MathJax_Math; font-style: italic;">a</span><span class="mi" id="MathJax-Span-21" style="font-family: MathJax_Math; font-style: italic;">l</span></span><span style="display: inline-block; width: 0px; height: 2.212em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.388em; border-left: 0px solid; width: 0px; height: 1.425em;"></span></span> 
  <span class="MJX_Assistive_MathML"> 
    
    
      ( 
     
    
      e 
     
    
      v 
     
    
      a 
     
    
      l 
     
   </span></span><script type="math/tex" id="MathJax-Element-3">(eval </script>(call Profile,Default))</p> 
<p> include/target.mk 中定义了 Profile 函数， 其中令 PROFILE=Default</p> 
<pre>define Image/Build/Profile/Default
    $(call Image/Build/Profile/MT7620a,$(<span class="hljs-number">1</span>)) <span class="hljs-keyword">...</span> endef</pre> 
<p> 规则依赖序列如下：</p> 
<pre>$(call Image/Build/Profile/$(PROFILE),squashfs)
  -<span class="ruby"><span class="hljs-input"><span class="hljs-prompt">-&gt;</span> <span class="hljs-variable">$(&lt;/span&gt;call &lt;span class="hljs-constant"&gt;BuildFirmware&lt;/span&gt;/&lt;span class="hljs-constant"&gt;Default8M&lt;/span&gt;/squashfs,squashfs,mt7620a,&lt;span class="hljs-constant"&gt;MT7620a&lt;/span&gt;)&lt;/span&gt; &lt;/span&gt; -&lt;span class="ruby"&gt;&lt;span class="hljs-input"&gt;&lt;span class="hljs-prompt" style="color:rgb(43,145,175);"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="hljs-variable"&gt;$(</span>call <span class="hljs-constant">BuildFirmware</span>/<span class="hljs-constant">OF</span>,squashfs,mt7620a,<span class="hljs-constant">MT7620a</span>,<span class="hljs-number">8060928</span>)</span> </span> -<span class="ruby"><span class="hljs-input"><span class="hljs-prompt">-&gt;</span> <span class="hljs-variable">$(&lt;/span&gt;call &lt;span class="hljs-constant"&gt;MkImageLzmaDtb&lt;/span&gt;,mt7620a,&lt;span class="hljs-constant"&gt;MT7620a&lt;/span&gt;)&lt;/span&gt; &lt;/span&gt; -&lt;span class="ruby"&gt;&lt;span class="hljs-input"&gt;&lt;span class="hljs-prompt" style="color:rgb(43,145,175);"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="hljs-variable"&gt;$(</span>call <span class="hljs-constant">PatchKernelLzmaDtb</span>,mt7620a,<span class="hljs-constant">MT7620a</span>)</span> </span> -<span class="ruby"><span class="hljs-input"><span class="hljs-prompt">-&gt;</span> <span class="hljs-variable">$(&lt;/span&gt;call &lt;span class="hljs-constant"&gt;MkImage&lt;/span&gt;,lzma,&lt;span class="hljs-variable"&gt;$(</span><span class="hljs-constant">KDIR</span>)/vmlinux-mt7620a.bin.lzma,<span class="hljs-variable">$(&lt;/span&gt;&lt;span class="hljs-constant"&gt;KDIR&lt;/span&gt;)/vmlinux-mt7620a.uImage)&lt;/span&gt; &lt;/span&gt; -&lt;span class="ruby"&gt;&lt;span class="hljs-prompt" style="color:rgb(43,145,175);"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="hljs-variable"&gt;$(</span>call <span class="hljs-constant">MkImageSysupgrade</span>/squashfs,squashfs,mt7620a,<span class="hljs-number">8060928</span>)</span></span></pre> 
<p> 其中的主要步骤：</p> 
<ul><li> 复制： cp <span class="MathJax_Preview"></span>(KDIR)/vmlinux(KDIR)/vmlinux-mt7620a<br></li><li> 生成dtb文件： <span class="MathJax_Preview"></span>(LINUXDIR)/scripts/dtc/dtc?Odtb?o(KDIR)/MT7620a.dtb ../dts/MT7620a.dts<br></li><li> 将内核与dtb文件合并：<span class="MathJax_Preview"></span>(STAGINGDIRHOST)/bin/patch?dtb(KDIR)/vmlinux-mt7620a $(KDIR)/MT7620a.dtb<br></li><li> 使用lzma压缩：<span class="MathJax_Preview"></span>(callCompressLzma,(KDIR)/vmlinux-mt7620a,$(KDIR)/vmlinux-mt7620a.bin.lzma)<br></li><li> 将lzma压缩后的文件经过mkimage工具处理，即在头部添加uboot可识别的信息。</li></ul> 
<p> 接下来就是合并生成firmware固件了：</p> 
<p> MkImageSysupgrade/squashfs, squashfs, mt7620a,8060928</p> 
<p> cat vmlinux-mt7620a.uImage root.squashfs &gt; openwrt-ramips-mt7620-mt7620a-squashfs-sysupgrade.bin<br> –&gt; 制作squashfs bin文档, 并确认它的大小 &lt; 8060928 才是有效的，否则报错。</p> 
<hr> 
<p> 总结： 整个流程下来，其实最烦索的还是对内核生成文件vmlinux的操作，经过了objcopy, patch-dtb, lzma, mkimage 等过程生成一个uImage，再与mksquashfs工具制作的文件系统rootfs.squashfs合并。</p> 
<p></p> 
<p><br></p> 
<p><br></p> 
<pre><code>        &lt;/div&gt;
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9032442647798dcb7b49ad68a8bf3923/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">DbForge Studio for SQL Server入门教程：在查询生成器中创建查询</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8ec8983b12ac92030e5aa799d86c3050/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于kernel-devel、kernel-header和kernel src的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>