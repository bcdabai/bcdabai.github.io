<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>iptables详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="iptables详解" />
<meta property="og:description" content="iptables详解 一：Linux包过滤防火墙概述1.1：netfilter1.2：iptables 二：iptables的表、链结构2.1：5种规则链2.2：4个规则表2.3：表、链结构示意图 三：数据包过滤的匹配流程四：iptables的语法格式4.1：语法构成4.2：数据包的常见控制类型4.3：常用选项4.3.1：添加新的规则4.3.2：查看规则列表4.3.3：删除、清空、修改规则4.3.4：设置默认策略 4.4：规则的匹配条件4.4.1：通用匹配4.4.2：隐含匹配4.4.3：显式匹配 五：SNAT/DNAT策略六：iptables-save与iptables-restore 一：Linux包过滤防火墙概述 1.1：netfilter 位于Linux内核中的包过滤功能体系称为Linux防火墙的“内核态” 1.2：iptables 位于/sbin/iptables，用来管理防火墙规则的工具称为Linux防火墙的“用户态” netfilter/iptables（下文中简称为iptables）组成Linux平台下的包过滤防火墙，与大多数的Linux软件一样，这个包过滤防火墙是免费的，它可以代替昂贵的商业防火墙解决方案，完成封包过滤、封包重定向和网络地址转换（NAT）等功能。
二：iptables的表、链结构 2.1：5种规则链 规则的作用：对数据包进行过滤或处理链的作用：容纳各种防火墙规则链的分类依据：根据处理数据包的不同时机 5种规则链
INPUT：处理入站数据包OUTPUT：处理出站数据包FORWORD：处理转发数据包PREROUTING：在进行路由选择前处理数据包POSTROUTING：在进行路由选择后处理数据包 2.2：4个规则表 表的作用：容纳各种规则链表的划分依据：防火墙规则的作用相似 4个规则表：
raw表：确实是否对数据包进行状态跟踪mangle表：拆解报文，做出修改，并重新封装 的功能nat表：网络地址转换功能filter表：包过滤功能 2.3：表、链结构示意图 三：数据包过滤的匹配流程 规则表之间的顺序
raw–&gt;mangle–&gt;nat–&gt;filter规则链之间的顺序
入站：PREROUTING–&gt;INPUT
出站：OUTPUT–&gt;POSTROUTING
转发：PREROUTING–&gt;FORWORD–&gt;POSTROUTING规则链里的匹配顺序
按顺序依次检查、匹配即停止
若找不到相应的匹配规则，则按该链的默认策略处理 四：iptables的语法格式 4.1：语法构成 iptables [-t 表名] 选项 [链名] [条件] [-j 控制类型]
注意事项：
不指定表名时，默认指filter表不指定链名时，默认指表内的所有链除非设置链的默认策略，否则必须指定匹配条件选项、链名、控制类型使用大写字母，其余均为小写 4.2：数据包的常见控制类型 ACCEPT：允许通过DROP：直接丢弃，不给任何回应REJECT：拒绝通过，必要时会给出提示LOG：记录日志信息，然后传给下一条规则继续匹配SNAT：源地址转换DNAT：目标地址转换 4.3：常用选项 4.3.1：添加新的规则 -A：在链的末尾追加一条规则-I：在链的开头（或指定序号）插入一条规则 [root@server ~]# iptables -t filter -A INPUT -p tcp -j ACCEPT [root@server ~]# iptables -t filter -I INPUT -p udp -j ACCEPT [root@server ~]# iptables -t filter -I INPUT 2 -p icmp -j ACCEPT 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fa779b15655e193a1520eaa07421808a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-01T14:35:06+08:00" />
<meta property="article:modified_time" content="2020-08-01T14:35:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">iptables详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>iptables详解</h4> 
 <ul><li><a href="#Linux_1" rel="nofollow">一：Linux包过滤防火墙概述</a></li><li><ul><li><a href="#11netfilter_2" rel="nofollow">1.1：netfilter</a></li><li><a href="#12iptables_6" rel="nofollow">1.2：iptables</a></li></ul> 
  </li><li><a href="#iptables_12" rel="nofollow">二：iptables的表、链结构</a></li><li><ul><li><a href="#215_13" rel="nofollow">2.1：5种规则链</a></li><li><a href="#224_25" rel="nofollow">2.2：4个规则表</a></li><li><a href="#23_35" rel="nofollow">2.3：表、链结构示意图</a></li></ul> 
  </li><li><a href="#_37" rel="nofollow">三：数据包过滤的匹配流程</a></li><li><a href="#iptables_49" rel="nofollow">四：iptables的语法格式</a></li><li><ul><li><a href="#41_50" rel="nofollow">4.1：语法构成</a></li><li><a href="#42_59" rel="nofollow">4.2：数据包的常见控制类型</a></li><li><a href="#43_67" rel="nofollow">4.3：常用选项</a></li><li><ul><li><a href="#431_68" rel="nofollow">4.3.1：添加新的规则</a></li><li><a href="#432_76" rel="nofollow">4.3.2：查看规则列表</a></li><li><a href="#433_90" rel="nofollow">4.3.3：删除、清空、修改规则</a></li><li><a href="#434_107" rel="nofollow">4.3.4：设置默认策略</a></li></ul> 
   </li><li><a href="#44_120" rel="nofollow">4.4：规则的匹配条件</a></li><li><ul><li><a href="#441_121" rel="nofollow">4.4.1：通用匹配</a></li><li><a href="#442_133" rel="nofollow">4.4.2：隐含匹配</a></li><li><a href="#443_157" rel="nofollow">4.4.3：显式匹配</a></li></ul> 
  </li></ul> 
  </li><li><a href="#SNATDNAT_183" rel="nofollow">五：SNAT/DNAT策略</a></li><li><a href="#iptablessaveiptablesrestore_192" rel="nofollow">六：iptables-save与iptables-restore</a></li></ul> 
</div> 
<p></p> 
<h2><a id="Linux_1"></a>一：Linux包过滤防火墙概述</h2> 
<h3><a id="11netfilter_2"></a>1.1：netfilter</h3> 
<ul><li>位于Linux内核中的包过滤功能体系</li><li>称为Linux防火墙的“内核态”</li></ul> 
<h3><a id="12iptables_6"></a>1.2：iptables</h3> 
<ul><li>位于/sbin/iptables，用来管理防火墙规则的工具</li><li>称为Linux防火墙的“用户态”</li></ul> 
<p>netfilter/iptables（下文中简称为iptables）组成Linux平台下的包过滤防火墙，与大多数的Linux软件一样，这个包过滤防火墙是免费的，它可以代替昂贵的商业防火墙解决方案，完成封包过滤、封包重定向和网络地址转换（NAT）等功能。</p> 
<h2><a id="iptables_12"></a>二：iptables的表、链结构</h2> 
<h3><a id="215_13"></a>2.1：5种规则链</h3> 
<ul><li>规则的作用：对数据包进行过滤或处理</li><li>链的作用：容纳各种防火墙规则</li><li>链的分类依据：根据处理数据包的不同时机</li></ul> 
<p>5种规则链</p> 
<ul><li>INPUT：处理入站数据包</li><li>OUTPUT：处理出站数据包</li><li>FORWORD：处理转发数据包</li><li>PREROUTING：在进行路由选择前处理数据包</li><li>POSTROUTING：在进行路由选择后处理数据包</li></ul> 
<h3><a id="224_25"></a>2.2：4个规则表</h3> 
<ul><li>表的作用：容纳各种规则链</li><li>表的划分依据：防火墙规则的作用相似</li></ul> 
<p>4个规则表：</p> 
<ul><li>raw表：确实是否对数据包进行状态跟踪</li><li>mangle表：拆解报文，做出修改，并重新封装 的功能</li><li>nat表：网络地址转换功能</li><li>filter表：包过滤功能</li></ul> 
<h3><a id="23_35"></a>2.3：表、链结构示意图</h3> 
<p><img src="https://images2.imgbox.com/f7/5c/MMffGdrB_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_37"></a>三：数据包过滤的匹配流程</h2> 
<ul><li>规则表之间的顺序<br> raw–&gt;mangle–&gt;nat–&gt;filter</li><li>规则链之间的顺序<br> 入站：PREROUTING–&gt;INPUT<br> 出站：OUTPUT–&gt;POSTROUTING<br> 转发：PREROUTING–&gt;FORWORD–&gt;POSTROUTING</li><li>规则链里的匹配顺序<br> 按顺序依次检查、匹配即停止<br> 若找不到相应的匹配规则，则按该链的默认策略处理</li></ul> 
<p><img src="https://images2.imgbox.com/4d/c0/U2IkLCav_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="iptables_49"></a>四：iptables的语法格式</h2> 
<h3><a id="41_50"></a>4.1：语法构成</h3> 
<p>iptables [-t 表名] 选项 [链名] [条件] [-j 控制类型]</p> 
<p>注意事项：</p> 
<ul><li>不指定表名时，默认指filter表</li><li>不指定链名时，默认指表内的所有链</li><li>除非设置链的默认策略，否则必须指定匹配条件</li><li>选项、链名、控制类型使用大写字母，其余均为小写</li></ul> 
<h3><a id="42_59"></a>4.2：数据包的常见控制类型</h3> 
<ul><li>ACCEPT：允许通过</li><li>DROP：直接丢弃，不给任何回应</li><li>REJECT：拒绝通过，必要时会给出提示</li><li>LOG：记录日志信息，然后传给下一条规则继续匹配</li><li>SNAT：源地址转换</li><li>DNAT：目标地址转换</li></ul> 
<h3><a id="43_67"></a>4.3：常用选项</h3> 
<h4><a id="431_68"></a>4.3.1：添加新的规则</h4> 
<ul><li>-A：在链的末尾追加一条规则</li><li>-I：在链的开头（或指定序号）插入一条规则</li></ul> 
<pre><code>[root@server ~]# iptables -t filter -A INPUT -p tcp -j ACCEPT 
[root@server ~]# iptables -t filter -I INPUT -p udp -j ACCEPT
[root@server ~]# iptables -t filter -I INPUT 2 -p icmp -j ACCEPT 
</code></pre> 
<h4><a id="432_76"></a>4.3.2：查看规则列表</h4> 
<ul><li>-L：列出所有规则列表</li><li>-n：以数字形式显示地址、端口等信息</li><li>-v：以更详细的方法显示规则信息</li><li>–line-numbers：查看规则时，显示规则的序号</li></ul> 
<pre><code>[root@server ~]# iptables -nvL INPUT --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        7   993 ACCEPT     udp  --  *      *       0.0.0.0/0            0.0.0.0/0           
2        0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           
3      370 23696 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0        
</code></pre> 
<h4><a id="433_90"></a>4.3.3：删除、清空、修改规则</h4> 
<ul><li>-D：删除链内指定序号（或内容）的一条规则</li><li>-F：清空所有的规则</li><li>-R：修改规则</li></ul> 
<pre><code>[root@server ~]# iptables -t filter -D INPUT 2 
[root@server ~]# iptables -nvL INPUT --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        9  1127 ACCEPT     udp  --  *      *       0.0.0.0/0            0.0.0.0/0           
2      441 27884 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0   
[root@server ~]# iptables -t filter -F INPUT
[root@server ~]# iptables -nvL INPUT --line-numbers
Chain INPUT (policy ACCEPT 6 packets, 364 bytes)
num   pkts bytes target     prot opt in     out     source               destination       
</code></pre> 
<h4><a id="434_107"></a>4.3.4：设置默认策略</h4> 
<ul><li>-P：为指定的链设置默认规则</li></ul> 
<pre><code>[root@server ~]# iptables -nvL INPUT 
Chain INPUT (policy ACCEPT 47 packets, 2804 bytes)  #默认规则为ACCEPT
 pkts bytes target     prot opt in     out     source               destination   
 [root@server ~]# iptables -P INPUT DROP  #更改默认规则为DROP
 [root@server ~]# iptables -nvL INPUT
Chain INPUT (policy DROP 22 packets, 1888 bytes)  #默认规则变为DROP
 pkts bytes target     prot opt in     out     source               destination  

</code></pre> 
<h3><a id="44_120"></a>4.4：规则的匹配条件</h3> 
<h4><a id="441_121"></a>4.4.1：通用匹配</h4> 
<p>可直接匹配，不依赖于其他条件或扩展，包括网络协议、IP地址、网络接口等条件。<br> 常用的通用匹配条件：</p> 
<ul><li>协议匹配：-p 协议名</li><li>地址匹配：-s 源地址、-d 目的地址</li><li>接口匹配：-i 入站网卡、-o 出站网卡</li></ul> 
<pre><code>[root@server ~]# iptables -I INPUT -s 192.168.209.138 -p icmp -j REJECT 
[root@server ~]# iptables -I INPUT -i ens33  -s 192.168.209.140 -p tcp -j REJECT
</code></pre> 
<p>使用-s选项或者-d选项即可匹配报文的源地址与目标地址，而且在指定IP地址时，可以同时指定多个IP地址，每个IP用"逗号"隔开，但是，-s选项与-d选项并不能一次性的指定一段连续的IP地址范围，如果我们需要指定一段连续的IP地址范围，可以使用下面显式匹配中的iprange扩展模块。</p> 
<h4><a id="442_133"></a>4.4.2：隐含匹配</h4> 
<p>要求以特定的协议匹配作为前提，包括端口、tcp标记、icmp类型等条件。<br> 常用的隐含匹配条件：</p> 
<ul><li>端口匹配：–sport 源端口、–dport 目的端口</li><li>ICMP类型匹配：–icmp-type ICMP类型</li></ul> 
<pre><code>#拒绝来自192.168.10.10的ssh请求
[root@server ~]# iptables -t filter -I INPUT -s 192.168.10.10 -p tcp --dport 22 -j REJECT
#拒绝192.168.10.10主机访问本机的22-25端口
[root@server ~]# iptables -t filter -I INPUT -s 192.168.10.10 -p tcp --dport 22:25 -j REJECT
#拒绝192.168.10.10主机访问本机的0-25端口
[root@server ~]# iptables -t filter -I INPUT -s 192.168.10.10 -p tcp --dport :25 -j REJECT
#拒绝192.168.10.10主机访问本机的25端口以及其后的所有端口（直到65535）
[root@server ~]# iptables -t filter -I INPUT -s 192.168.10.10 -p tcp --dport 25: -j REJECT
</code></pre> 
<pre><code>#禁止所有icmp类型的报文进入本机
[root@server ~]# iptables -t filter -I INPUT -p icmp -j REJECT
#本主机能ping通其他主机，其他主机不能ping通本主机
[root@server ~]# iptables -t filter -I INPUT -p icmp --icmp-type 8 -j REJECT  #8表示请求，0表示回应，3表示不可达
</code></pre> 
<p>借助tcp隐含匹配的–sport或者–dport都可以指定一个连续的端口范围，但是无法同时指定多个离散的、不连续的端口，如果想要同时指定多个离散的端口，需要借助显式匹配的"multiport"多端口匹配。</p> 
<h4><a id="443_157"></a>4.4.3：显式匹配</h4> 
<p>要求以“-m扩展模块”的形式明确指出类型，包括多端口、MAC地址、IP范围、数据包状态等条件。<br> 常用的显式匹配条件：</p> 
<ul><li>多端口匹配：-m multiport --sports 源端口列表<br> -m multiport --dports 目的端口列表</li><li>IP范围匹配：-m iprange --src-range IP范围</li><li>MAC地址匹配：-m mac --mac-source MAC地址</li><li>状态匹配：-m state --state 连接状态</li></ul> 
<pre><code>#禁止来自192.168.10.10的主机上的tcp报文访问本机的22号端口、36号端口以及80号端口
[root@server ~]# iptables -t filter -I INPUT -s 192.168.10.10 -p tcp -m multiport --dports 22,36,80 -j DROP
#拒绝来自192.168.10.10至192.168.10.20之间的主机报文访问本主机
[root@server ~]# iptables -t filter -I INPUT -m iprange --src-range 192.168.10.10-192.168.10.20 -j REJECT
</code></pre> 
<p>使用iprange扩展模块可以指定"一段连续的IP地址范围"，用于匹配报文的源地址或者目标地址。</p> 
<p>为了让"提供服务方"能够正常的"响应"我们的请求，于是在主机上开放了对应的端口，开放这些端口的同时，也出现了问题，别人利用这些开放的端口，"主动"的攻击我们，他们发送过来的报文并不是为了响应我们，而是为了主动攻击我们，<br> 问题就是：怎样判断这些报文是为了回应我们之前发出的报文，还是主动向我们发送的报文呢？<br> 我们可以通过iptables的state扩展模块解决上述问题。<br> 对于state模块的连接而言，"连接"其中的报文可以分为5种状态，报文状态可以为NEW、ESTABLISHED、RELATED、INVALID、UNTRACKED。<br> 我们只要放行状态为ESTABLISHED的报文即可。</p> 
<pre><code>[root@server ~]# iptables -t filter -I INPUT -m state --state ESTABLISHED  -j ACCEPT 
[root@server ~]# iptables -t filter -A INPUT -j REJECT
</code></pre> 
<h2><a id="SNATDNAT_183"></a>五：SNAT/DNAT策略</h2> 
<p><img src="https://images2.imgbox.com/77/e8/xCe9JjSg_o.png" alt="在这里插入图片描述"><br> 防火墙配置</p> 
<pre><code>#SNAT
iptables -t nat -I POSTROUTING -s 192.168.1.10 -o ens33 -j SNAT --to-source 12.0.0.1
#DNAT
iptables -t nat -I PREROUTING -d 12.0.0.1 -i ens33 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10
</code></pre> 
<h2><a id="iptablessaveiptablesrestore_192"></a>六：iptables-save与iptables-restore</h2> 
<p>iptables-save：保存防火墙规则，上述所有操作都是临时的，重启时规则会失效，想要永久保存，可以用iptables-save重定向到/etc/sysconfig/iptables-config,也可以备份到指定文件中，如/opt/iptables.bak<br> iptables-restore：恢复防火墙规则，当原有的防火墙规则被破坏时，可用备份文件进行恢复<br> iptables-restore &lt; /opt/iptables.bak</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e0897336e73ae4a1125b14a6fd923dc1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">实习面经（网易雷火）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a814a4d77905cbb63bff24edbc025ec9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">FlinkSql on yarn 提交踩坑记录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>