<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LoRa SX1278通信代码开发学习 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="LoRa SX1278通信代码开发学习" />
<meta property="og:description" content="前言 最近在学习和摸索LoRa SX1278无线发射模块，其中学到了很多新知识和对SX1278也有了深一点的认识，现在将学习开发中遇到的问题、解决方法、调试完成和低功耗等内容分享出来，也是一种学习记录，方便日后有迹可循，再次学习。 本篇文章可能会比较粗暴一点，直接把需要注意的地方重点介绍一下，可能没有其他文章把每一个小知识点，专用名字都说的那么详尽，怕最后你看完了也不知道哪个是重点了；话不多说，直接来。
准备工具 1、SX1278芯片或者模块
2、主控EFM32（STM32、STM8均可，因为我使用模拟SPI，所以对芯片没要求，有GPIO口就可以）
专有名词 FHSS： 跳频扩频技术 ；
FIFO： 先进先出队列，这里代表队列寄存器
PA ：功率放大器 ；
LNA ：低噪声放大器；
SNR ：信噪比 ；
SF ：扩频因子 ；
PLL ：锁相环 ；
CAD ： 信道活动检测；
CR ：编码率 ；
BW ： 带宽 ；
RS ：符号速率 ；
Preamble ：序头；
其中SF 扩频因子是重点
因为扩频因子越大，传播时间越长。带宽低于62.5K时用TCXO做参考时钟源。在睡眠模式下通过配置寄存器RegOpMode 将FSK调制解调器切换成LoRa调制解调器。
在SX1276_LoRa.c文件中有相关参数的配置
tLoRaSettings LoRaSettings = { 470000000, //434000000, // RFFrequency //中心频率 20, // Power //发射功率 9, // SignalBw [0: 7.8kHz, 1: 10.4 kHz, 2: 15." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dabb6d6ec31f9eafa24644aae5e8d6f0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-13T09:57:04+08:00" />
<meta property="article:modified_time" content="2022-06-13T09:57:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">LoRa SX1278通信代码开发学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>最近在学习和摸索LoRa SX1278无线发射模块，其中学到了很多新知识和对SX1278也有了深一点的认识，现在将学习开发中遇到的问题、解决方法、调试完成和低功耗等内容分享出来，也是一种学习记录，方便日后有迹可循，再次学习。 <br> 本篇文章可能会比较粗暴一点，直接把需要注意的地方重点介绍一下，可能没有其他文章把每一个小知识点，专用名字都说的那么详尽，怕最后你看完了也不知道哪个是重点了；话不多说，直接来。</p> 
<h3><a id="_3"></a>准备工具</h3> 
<p>1、SX1278芯片或者模块<br> 2、主控EFM32（STM32、STM8均可，因为我使用模拟SPI，所以对芯片没要求，有GPIO口就可以）</p> 
<h4><a id="_6"></a>专有名词</h4> 
<p>FHSS： 跳频扩频技术 ；<br> FIFO： 先进先出队列，这里代表队列寄存器</p> 
<p><strong>PA</strong> ：功率放大器 ；<br> <strong>LNA</strong> ：低噪声放大器；<br> <strong>SNR</strong> ：信噪比 ；<br> <strong>SF</strong> ：扩频因子 ；<br> <strong>PLL</strong> ：锁相环 ；<br> <strong>CAD</strong> ： 信道活动检测；<br> <strong>CR</strong> ：编码率 ；<br> <strong>BW</strong> ： 带宽 ；<br> <strong>RS</strong> ：符号速率 ；<br> <strong>Preamble</strong> ：序头；<br> 其中SF 扩频因子是重点<br> <strong>因为扩频因子越大，传播时间越长。带宽低于62.5K时用TCXO做参考时钟源。在睡眠模式下通过配置寄存器RegOpMode 将FSK调制解调器切换成LoRa调制解调器。</strong><br> 在SX1276_LoRa.c文件中有相关参数的配置</p> 
<pre><code class="prism language-javascript">tLoRaSettings LoRaSettings <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token number">470000000</span><span class="token punctuation">,</span>        <span class="token comment">//434000000,        // RFFrequency                                                          //中心频率</span>
    <span class="token number">20</span><span class="token punctuation">,</span>               <span class="token comment">// Power                                                                                    //发射功率</span>
    <span class="token number">9</span><span class="token punctuation">,</span>                <span class="token comment">// SignalBw [0: 7.8kHz, 1: 10.4 kHz, 2: 15.6 kHz, 3: 20.8 kHz, 4: 31.2 kHz,                 //信号带宽</span>
                      <span class="token comment">// 5: 41.6 kHz, 6: 62.5 kHz, 7: 125 kHz, 8: 250 kHz, 9: 500 kHz, other: Reserved]</span>
    <span class="token number">12</span><span class="token punctuation">,</span>                <span class="token comment">// SpreadingFactor [6: 64, 7: 128, 8: 256, 9: 512, 10: 1024, 11: 2048, 12: 4096  chips]    //扩频因子</span>
    <span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment">// ErrorCoding [1: 4/5, 2: 4/6, 3: 4/7, 4: 4/8]                                             //编码率</span>
    <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment">// CrcOn [0: OFF, 1: ON]                                                                    //CRC校验开始</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token comment">// ImplicitHeaderOn [0: OFF, 1: ON]                                                        //设置隐式报文包</span>
    <span class="token number">1</span><span class="token punctuation">,</span>                <span class="token comment">// RxSingleOn [0: Continuous, 1 Single]                                                    //设置连续接收模式还是单一接收模式</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment">// FreqHopOn [0: OFF, 1: ON]                                                               //关闭调频模式</span>
    <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token comment">// HopPeriod Hops every frequency hopping period symbols</span>
    <span class="token number">1000</span><span class="token punctuation">,</span>              <span class="token comment">// TxPacketTimeout                                                                        //发送超时时间</span>
    <span class="token number">1000</span><span class="token punctuation">,</span>              <span class="token comment">// RxPacketTimeout                                                                        //接收超时时间</span>
    <span class="token number">128</span><span class="token punctuation">,</span>              <span class="token comment">// PayloadLength (used for implicit header mode)                                           //设置负载长度</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre> 
<p>注意：LoRaSettings结构体里面的配置根据你的需要修改，一般修改扩频因子，频率和发射功率等。</p> 
<h4><a id="_43"></a>移植代码流程</h4> 
<p><strong>1、首先我们需要有一个整体思路:<br> 主机发送“PING”字符给从机，从机接收到来自主机的“PING”会回复主机一个“PONG”，如果主机没有收到从机的“PONG”，会进入发送超时，然后主机重新发送“PING”，整个流程就是这样循环下去。</strong></p> 
<h5><a id="_46"></a>通信的准备：</h5> 
<h6><a id="1SPI_47"></a>1、SPI初始化（<strong>重中之重</strong>）</h6> 
<p>1.1、可以使用硬件SPI，也可以使用软件SPI；示例代码就是提供硬件SPI，移植性很差，换了芯片就需要更改读写函数，比较麻烦，所以我使用了软件SPI，容易移植。<br> 1.2、网上下载一份SX1278的芯片说明文档、找到关于SPI通信的部分的时序图，如下图：<br> <img src="https://images2.imgbox.com/38/a1/fOgu9EAe_o.png" alt="在这里插入图片描述"><br> 如果你不知道模块的SPI通信是什么极性，可以参考一下下面这篇文章的介绍。<br> https://blog.csdn.net/zwj695535100/article/details/107303648/<br> 1.3、修改SPI读写函数<br> SX1278是四线的SPI，但是我读写整合成一个函数：</p> 
<pre><code class="prism language-javascript">uint8_t <span class="token constant">SOFT_SPI_RW_MODE0</span><span class="token punctuation">(</span> <span class="token parameter">uint8_t write_dat</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    uint8_t i<span class="token punctuation">,</span>temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//    SPI_SCK_LOW;     //先将时钟线拉低</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>   
        <span class="token constant">SCLK_L</span><span class="token punctuation">;</span>     <span class="token comment">//先将时钟线拉低</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>write_dat<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token number">0x80</span><span class="token punctuation">)</span>  <span class="token comment">//从高位发送</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token constant">MOSI_H</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token constant">MOSI_L</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token constant">SCLK_H</span><span class="token punctuation">;</span>  <span class="token comment">//将时钟线拉高，在时钟上升沿，数据发送到从设备</span>
        
        write_dat<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        temp<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">MISO_R</span><span class="token punctuation">)</span>   <span class="token comment">//读取从设备发射的数据</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//write_dat|=0x01; </span>
            temp<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token constant">SCLK_L</span><span class="token punctuation">;</span>     <span class="token comment">//在下降沿数据被读取到主机</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> temp<span class="token punctuation">;</span>         <span class="token comment">//返回读取到的数据</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>1.4、修改sx1276_Hal.c文件的读写buffer函数：<br> <strong>写函数</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">void</span> <span class="token function">SX1276WriteBuffer</span><span class="token punctuation">(</span> <span class="token parameter">uint8_t addr<span class="token punctuation">,</span> uint8_t <span class="token operator">*</span>buffer<span class="token punctuation">,</span> uint8_t size</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  addr <span class="token operator">=</span> addr <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
  <span class="token constant">CS_L</span><span class="token punctuation">;</span><span class="token comment">//NSS = 0;</span>
  <span class="token constant">SOFT_SPI_RW_MODE0</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  spiNByteSend(buffer,size);</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>uint8_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
   <span class="token punctuation">{<!-- --></span>
      <span class="token constant">SOFT_SPI_RW_MODE0</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token constant">CS_H</span><span class="token punctuation">;</span> <span class="token comment">//NSS = 1;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>读函数</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">void</span> <span class="token function">SX1276ReadBuffer</span><span class="token punctuation">(</span> <span class="token parameter">uint8_t addr<span class="token punctuation">,</span> uint8_t <span class="token operator">*</span>buffer<span class="token punctuation">,</span> uint8_t size</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   addr <span class="token operator">=</span> addr <span class="token operator">&amp;</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>
   <span class="token constant">CS_L</span><span class="token punctuation">;</span><span class="token comment">//NSS = 0;</span>
   <span class="token constant">SOFT_SPI_RW_MODE0</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>uint8_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
   <span class="token punctuation">{<!-- --></span>
          buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">SOFT_SPI_RW_MODE0</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token comment">//   spiNByteSend(buffer,size);</span>
   
   <span class="token constant">CS_H</span><span class="token punctuation">;</span> <span class="token comment">//NSS = 1;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：<br> <strong>1、CS片选管脚记得修改成你自己选择的GPIO口。<br> 2、SPI初始化管脚这些太基础的就不说了，但是要注意配置输入和输出的关系。</strong><br> 这样我们的SPI初始化算完成了，这一步是最基础的，如果这一步出错后面就玩不下去了。</p> 
<h6><a id="2SX1278_124"></a>2、SX1278的初始化</h6> 
<pre><code class="prism language-javascript">   Radio <span class="token operator">=</span> <span class="token function">RadioDriverInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2.1、RadioDriverInit();<br> 此函数是用来芯片选型的，在官方例程或者网上其他地方下载的例程中，SX1278、SX1276、SX1272、SX1232都是通过此函数对选好的芯片类型进行初始化。<br> <strong>SX1278和SX1276是使用同一个配置！</strong><br> 2.2、Radio-&gt;Init();<br> 此函数是对SX1278所有的配置参数进行配置，会调用SX1276Init（）函数，如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">void</span> <span class="token function">SX1276Init</span><span class="token punctuation">(</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// static uint8_t spi_test=0;</span>
<span class="token comment">// Initialize FSK and LoRa registers structure</span>
   <span class="token constant">SX1276</span> <span class="token operator">=</span> <span class="token punctuation">(</span> tSX1276<span class="token operator">*</span> <span class="token punctuation">)</span>SX1276Regs<span class="token punctuation">;</span>
   <span class="token constant">SX1276LR</span> <span class="token operator">=</span> <span class="token punctuation">(</span> tSX1276LR<span class="token operator">*</span> <span class="token punctuation">)</span>SX1276Regs<span class="token punctuation">;</span>
<span class="token comment">//    memset(SX1276,(int)0,sizeof(tSX1276));</span>
<span class="token comment">//    memset(SX1276LR,(int)0,sizeof(tSX1276LR));</span>
   <span class="token function">SX1276Reset</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">SX1276LoRaSetOpMode</span><span class="token punctuation">(</span><span class="token constant">RFLR_OPMODE_STANDBY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// GetOpMode_test = SX1276LoRaGetOpMode();</span>
<span class="token comment">// REMARK: After radio reset the default modem is FSK</span>
#<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token constant">LORA</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> 
    LoRaOn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">SX1276SetLoRaOn</span><span class="token punctuation">(</span> LoRaOn <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Initialize FSK modem</span>
    <span class="token function">SX1276FskInit</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
#<span class="token keyword">else</span>
    LoRaOn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    LoRaOnState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">SX1276SetLoRaOn</span><span class="token punctuation">(</span> LoRaOn <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Initialize LoRa modem</span>
    <span class="token function">SX1276LoRaInit</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif
   <span class="token comment">// SX1276LoRaSetPreambleLength(100);</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2.2.1、SX1276LR = ( tSX1276LR* )SX1276Regs;<br> 这个SX1276Regs是SX1278初始化正常接收返回参数存放的数组，SPI通信正常，它里面存放的码流应该如下：<br> <img src="https://images2.imgbox.com/14/ae/oVfZ44p7_o.png" alt="在这里插入图片描述"><br> 2.2.2、复位函数：SX1276Reset( );</p> 
<pre><code class="prism language-javascript"><span class="token keyword">void</span> <span class="token function">SX1276Reset</span><span class="token punctuation">(</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    uint32_t startTick<span class="token punctuation">;</span>
    <span class="token function">SX1276SetReset</span><span class="token punctuation">(</span> <span class="token constant">RADIO_RESET_ON</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Wait 1ms</span>
    startTick <span class="token operator">=</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-</span> startTick <span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">TICK_RATE_MS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">SX1276SetReset</span><span class="token punctuation">(</span> <span class="token constant">RADIO_RESET_OFF</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Wait 6ms</span>
    startTick <span class="token operator">=</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-</span> startTick <span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">TICK_RATE_MS</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token comment">//嘀嗒定时器修改成你当前使用芯片的</span>
#define <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>                           <span class="token punctuation">(</span> TickCounter <span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">void</span></span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TickCounter<span class="token operator">++</span><span class="token punctuation">;</span>
    msTicks<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：复位管脚需要修改和你对应的管脚，不然程序会在SX1276Reset跑死了。<br> 2.2.3、<strong>映射函数</strong><br> SX1276SetLoRaOn( LoRaOn )和SX1276LoRaInit( )函数<br> 这两个函数一般不需要改动，里面都是Lora的一些基础参数的配置初始化，但是需要说一下IO口映射函数<br> 在SX1276SetLoRaOn和sx1276_LoRa.c文件中的SX1276LoRaProcess函数都有映射函数。</p> 
<pre><code class="prism language-javascript">                            <span class="token comment">// RxDone                    RxTimeout                   FhssChangeChannel           CadDone</span>
<span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegDioMapping1 <span class="token operator">=</span> <span class="token constant">RFLR_DIOMAPPING1_DIO0_00</span> <span class="token operator">|</span> <span class="token constant">RFLR_DIOMAPPING1_DIO1_00</span> <span class="token operator">|</span> <span class="token constant">RFLR_DIOMAPPING1_DIO2_00</span> <span class="token operator">|</span> <span class="token constant">RFLR_DIOMAPPING1_DIO3_00</span><span class="token punctuation">;</span>
                                   <span class="token comment">// PllLock              ModeReady</span>
<span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegDioMapping2 <span class="token operator">=</span> <span class="token constant">RFLR_DIOMAPPING2_DIO4_01</span> <span class="token operator">|</span> <span class="token constant">RFLR_DIOMAPPING2_DIO5_00</span><span class="token punctuation">;</span>
<span class="token function">SX1276WriteBuffer</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_DIOMAPPING1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegDioMapping1<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//映射到对应的IO口，检测相应的IO口是否收发完成。</span>
</code></pre> 
<p>映射到IO口主要的作用是在SX1276LoRaProcess（）函数中，当状态 RFLRState = RFLR_STATE_RX_RUNNING的时候，需要读取IO口是否有收到数据，才可以进入下一步，否则进入超时接收，会进入再次发送的流程，循环往复。<br> DIO可以设置不同的状态，在SX1278上有说明：<br> <img src="https://images2.imgbox.com/33/b1/BbCaOzB4_o.png" alt="在这里插入图片描述"></p> 
<p>初始化的大致流程就这样差不多了，还有一些细节的问题就需要去需要再摸索一下，后续有更多更深的理解我会再写文章总结。</p> 
<h6><a id="3_207"></a>3、主函数</h6> 
<pre><code class="prism language-javascript">int <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">void</span></span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token function">HW_Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//MCU初始化</span>
   Radio <span class="token operator">=</span> <span class="token function">RadioDriverInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token keyword">if</span><span class="token punctuation">(</span>EnableMaster <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
     TXBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'P'</span><span class="token punctuation">;</span>
     TXBuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'I'</span><span class="token punctuation">;</span>
     TXBuffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'N'</span><span class="token punctuation">;</span>
     TXBuffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'G'</span><span class="token punctuation">;</span>
     crc_value<span class="token operator">=</span><span class="token function">RadioComputeCRC</span><span class="token punctuation">(</span>TXBuffer<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token constant">CRC_TYPE_IBM</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算得出要发送数据包CRC值</span>
     TXBuffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span>crc_value<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">;</span>
     TXBuffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span>crc_value<span class="token punctuation">;</span>
     Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetTxPacket</span><span class="token punctuation">(</span>TXBuffer<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打包要发送的数据包</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
   <span class="token punctuation">{<!-- --></span>
       Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">StartRx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span> 
     <span class="token keyword">if</span><span class="token punctuation">(</span>EnableMaster <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>  
        <span class="token function">OnMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>    
      <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token function">OnSlave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主函数开始就是把你用到的初始化好了，然后根据你是选择主机还是从机进入对应的函数，定义主机或者从机函数在文件头部；</p> 
<pre><code class="prism language-javascript">bool  EnableMaster <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//主从选择 true为主 false 为从</span>
</code></pre> 
<p><strong>主机函数</strong></p> 
<pre><code class="prism language-javascript"><span class="token comment">/*
 * Manages the master operation
 */</span>
<span class="token keyword">void</span> <span class="token function">OnMaster</span><span class="token punctuation">(</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">switch</span><span class="token punctuation">(</span>Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> <span class="token constant">RF_TX_DONE</span><span class="token operator">:</span>
           
	       Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">StartRx</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span>
		
      <span class="token keyword">case</span> <span class="token constant">RF_RX_DONE</span><span class="token operator">:</span>
        Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetRxPacket</span><span class="token punctuation">(</span> RXBuffer<span class="token punctuation">,</span> <span class="token punctuation">(</span> uint16_t<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>num_rx <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>num_rx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
           crc_value<span class="token operator">=</span>RXBuffer<span class="token punctuation">[</span>num_rx<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
           crc_value<span class="token operator">&lt;&lt;=</span><span class="token number">8</span><span class="token punctuation">;</span>
           crc_value<span class="token operator">|=</span>RXBuffer<span class="token punctuation">[</span>num_rx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span><span class="token punctuation">(</span>crc_value<span class="token operator">==</span><span class="token function">RadioComputeCRC</span><span class="token punctuation">(</span>RXBuffer<span class="token punctuation">,</span>num_rx<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token constant">CRC_TYPE_IBM</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//CRC check</span>
           <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token keyword">const</span> char<span class="token operator">*</span> <span class="token punctuation">)</span>RXBuffer<span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token keyword">const</span> char<span class="token operator">*</span> <span class="token punctuation">)</span>PongMsg<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                  <span class="token function">LedToggle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//LED闪烁</span>
                 
                 <span class="token comment">// Send the next PING frame            </span>
		  TXBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'P'</span><span class="token punctuation">;</span>
                  TXBuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'I'</span><span class="token punctuation">;</span>
                  TXBuffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'N'</span><span class="token punctuation">;</span>
                  TXBuffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'G'</span><span class="token punctuation">;</span>
                  crc_value<span class="token operator">=</span><span class="token function">RadioComputeCRC</span><span class="token punctuation">(</span>TXBuffer<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token constant">CRC_TYPE_IBM</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算得出要发送数据包CRC值</span>
                  TXBuffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span>crc_value<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">;</span>
                  TXBuffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span>crc_value<span class="token punctuation">;</span>
			      
                  Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetTxPacket</span><span class="token punctuation">(</span> TXBuffer<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
            <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>            
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token keyword">case</span> <span class="token constant">RF_RX_TIMEOUT</span><span class="token operator">:</span>
        <span class="token comment">// Send the next PING frame</span>
        TXBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'P'</span><span class="token punctuation">;</span>
        TXBuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'I'</span><span class="token punctuation">;</span>
        TXBuffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'N'</span><span class="token punctuation">;</span>
        TXBuffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'G'</span><span class="token punctuation">;</span>
        crc_value <span class="token operator">=</span> <span class="token function">RadioComputeCRC</span><span class="token punctuation">(</span>TXBuffer<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token constant">CRC_TYPE_IBM</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算得出要发送数据包CRC值</span>
        TXBuffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> crc_value<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">;</span>
        TXBuffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> crc_value<span class="token punctuation">;</span>
			      		 
        Radio<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetTxPacket</span><span class="token punctuation">(</span> TXBuffer<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
				
        
     <span class="token keyword">default</span><span class="token operator">:</span><span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行主机函数，他会跑进去sx1276_LoRa.c文件中的SX1276LoRaProcess函数读取SX1278的状态机，根据当前的状态来进行对应的操作；它的包含的状态都在下面的结构体中：</p> 
<pre><code class="prism language-javascript">typedef <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token constant">RFLR_STATE_IDLE</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_RX_INIT</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_RX_RUNNING</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_RX_DONE</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_RX_TIMEOUT</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_TX_INIT</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_TX_RUNNING</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_TX_DONE</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_TX_TIMEOUT</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_CAD_INIT</span><span class="token punctuation">,</span>
    <span class="token constant">RFLR_STATE_CAD_RUNNING</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>tRFLRStates<span class="token punctuation">;</span>
</code></pre> 
<p>在SX1276LoRaProcess函数中，一般都不需要修改，只需要注意一个地方，就是下面两个：<br> <strong>如果你是主机需要注意</strong></p> 
<pre><code class="prism language-javascript"> <span class="token keyword">case</span> <span class="token constant">RFLR_STATE_TX_RUNNING</span><span class="token operator">:</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">DIO0</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment">// TxDone</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// Clear Irq</span>
       <span class="token function">SX1276Write</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_IRQFLAGS</span><span class="token punctuation">,</span> <span class="token constant">RFLR_IRQFLAGS_TXDONE</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
       RFLRState <span class="token operator">=</span> <span class="token constant">RFLR_STATE_TX_DONE</span><span class="token punctuation">;</span>   
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">DIO2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment">// FHSS Changed Channel </span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span><span class="token punctuation">(</span> LoRaSettings<span class="token punctuation">.</span>FreqHopOn <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span>
       <span class="token punctuation">{<!-- --></span>
           <span class="token function">SX1276Read</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_HOPCHANNEL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegHopChannel <span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">SX1276LoRaSetRFFrequency</span><span class="token punctuation">(</span> HoppingFrequencies<span class="token punctuation">[</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegHopChannel <span class="token operator">&amp;</span> <span class="token constant">RFLR_HOPCHANNEL_CHANNEL_MASK</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// Clear Irq</span>
       <span class="token function">SX1276Write</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_IRQFLAGS</span><span class="token punctuation">,</span> <span class="token constant">RFLR_IRQFLAGS_FHSSCHANGEDCHANNEL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>如果你是从机需要注意</strong></p> 
<pre><code class="prism language-javascript"> <span class="token keyword">case</span> <span class="token constant">RFLR_STATE_RX_RUNNING</span><span class="token operator">:</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">DIO0</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment">// RxDone</span>
     <span class="token punctuation">{<!-- --></span>
         RxTimeoutTimer <span class="token operator">=</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span> LoRaSettings<span class="token punctuation">.</span>FreqHopOn <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
             <span class="token function">SX1276Read</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_HOPCHANNEL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegHopChannel <span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">SX1276LoRaSetRFFrequency</span><span class="token punctuation">(</span> HoppingFrequencies<span class="token punctuation">[</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegHopChannel <span class="token operator">&amp;</span> <span class="token constant">RFLR_HOPCHANNEL_CHANNEL_MASK</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// Clear Irq</span>
         <span class="token function">SX1276Write</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_IRQFLAGS</span><span class="token punctuation">,</span> <span class="token constant">RFLR_IRQFLAGS_RXDONE</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
         RFLRState <span class="token operator">=</span> <span class="token constant">RFLR_STATE_RX_DONE</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">DIO2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment">// FHSS Changed Channel</span>
     <span class="token punctuation">{<!-- --></span>
         RxTimeoutTimer <span class="token operator">=</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span> LoRaSettings<span class="token punctuation">.</span>FreqHopOn <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
             <span class="token function">SX1276Read</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_HOPCHANNEL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegHopChannel <span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">SX1276LoRaSetRFFrequency</span><span class="token punctuation">(</span> HoppingFrequencies<span class="token punctuation">[</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegHopChannel <span class="token operator">&amp;</span> <span class="token constant">RFLR_HOPCHANNEL_CHANNEL_MASK</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// Clear Irq</span>
         <span class="token function">SX1276Write</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_IRQFLAGS</span><span class="token punctuation">,</span> <span class="token constant">RFLR_IRQFLAGS_FHSSCHANGEDCHANNEL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// Debug</span>
         RxGain <span class="token operator">=</span> <span class="token function">SX1276LoRaReadRxGain</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword">if</span><span class="token punctuation">(</span> LoRaSettings<span class="token punctuation">.</span>RxSingleOn <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span> <span class="token comment">// Rx single mode</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-</span> RxTimeoutTimer <span class="token punctuation">)</span> <span class="token operator">&gt;</span> PacketTimeout <span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
             RFLRState <span class="token operator">=</span> <span class="token constant">RFLR_STATE_RX_TIMEOUT</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<p>需要注意的就是Io1、Io2这些映射口的状态，如果你没有像上面的正确配置映射口，可能函数会一直在那里进行死循环操作，就无法进入下一步，最后通信失败；我的板子因为没有接Io1和Io2的引脚，所以我不能直接读取管脚状态进行下一步，但是SX1278手册里面有说到可以读取寄存器RegIrqFlags（0x12）也可以获取到是否可以正常发送或者接收<br> <img src="https://images2.imgbox.com/84/a1/rhFREYxz_o.png" alt="在这里插入图片描述">所以我把发射和接收的函数改造了一下，如下：</p> 
<pre><code class="prism language-javascript"><span class="token comment">//主机</span>
uint8_t flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">case</span> <span class="token constant">RFLR_STATE_TX_RUNNING</span><span class="token operator">:</span> 
    <span class="token function">SX1276Read</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_IRQFLAGS</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//读取发送完成标志位</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> <span class="token constant">RFLR_IRQFLAGS_TXDONE</span><span class="token punctuation">)</span>                            <span class="token comment">//判断发送完成标志位    </span>
    <span class="token punctuation">{<!-- --></span>   <span class="token comment">// Clear Irq</span>
        <span class="token function">SX1276Write</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_IRQFLAGS</span><span class="token punctuation">,</span> <span class="token constant">RFLR_IRQFLAGS_TXDONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RFLRState <span class="token operator">=</span> <span class="token constant">RFLR_STATE_TX_DONE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意：IO2是FHSS Changed Channel，我没用到，所以我去改写，如果需要改写也是一样的，只需要修改 if(flag &amp; RFLR_IRQFLAGS_TXDONE) ，与上对应的寄存器就好了。</p> 
<pre><code class="prism language-javascript"><span class="token comment">//从机</span>
uint8_t flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">case</span> <span class="token constant">RFLR_STATE_RX_RUNNING</span><span class="token operator">:</span>
    <span class="token function">SX1276Read</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_IRQFLAGS</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//读取发送完成标志位</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> <span class="token constant">RFLR_IRQFLAGS_RXDONE</span><span class="token punctuation">)</span>                            <span class="token comment">//判断发送完成标志位  </span>
    <span class="token punctuation">{<!-- --></span>
        RxTimeoutTimer <span class="token operator">=</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> LoRaSettings<span class="token punctuation">.</span>FreqHopOn <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">SX1276Read</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_HOPCHANNEL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegHopChannel <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">SX1276LoRaSetRFFrequency</span><span class="token punctuation">(</span> HoppingFrequencies<span class="token punctuation">[</span><span class="token constant">SX1276LR</span><span class="token operator">-</span><span class="token operator">&gt;</span>RegHopChannel <span class="token operator">&amp;</span> <span class="token constant">RFLR_HOPCHANNEL_CHANNEL_MASK</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Clear Irq</span>
        <span class="token function">SX1276Write</span><span class="token punctuation">(</span> <span class="token constant">REG_LR_IRQFLAGS</span><span class="token punctuation">,</span> <span class="token constant">RFLR_IRQFLAGS_RXDONE</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
        RFLRState <span class="token operator">=</span> <span class="token constant">RFLR_STATE_RX_DONE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> LoRaSettings<span class="token punctuation">.</span>RxSingleOn <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span> <span class="token comment">// Rx single mode</span>
    <span class="token punctuation">{<!-- --></span>
        uint32_t TimeCount <span class="token operator">=</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-</span> RxTimeoutTimer<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token constant">GET_TICK_COUNT</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-</span> RxTimeoutTimer <span class="token punctuation">)</span> <span class="token operator">&gt;</span> PacketTimeout <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            RFLRState <span class="token operator">=</span> <span class="token constant">RFLR_STATE_RX_TIMEOUT</span><span class="token punctuation">;</span>               
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<p>从机的原理也是一样的，我就不罗嗦了，还有相关的宏定义是在头文件sx1276_LoRa.h</p> 
<pre><code class="prism language-javascript">#define <span class="token constant">RFLR_IRQFLAGS_RXTIMEOUT</span>                     <span class="token number">0x80</span> 
#define <span class="token constant">RFLR_IRQFLAGS_RXDONE</span>                        <span class="token number">0x40</span> 
#define <span class="token constant">RFLR_IRQFLAGS_PAYLOADCRCERROR</span>               <span class="token number">0x20</span> 
#define <span class="token constant">RFLR_IRQFLAGS_VALIDHEADER</span>                   <span class="token number">0x10</span> 
#define <span class="token constant">RFLR_IRQFLAGS_TXDONE</span>                        <span class="token number">0x08</span> 
#define <span class="token constant">RFLR_IRQFLAGS_CADDONE</span>                       <span class="token number">0x04</span> 
#define <span class="token constant">RFLR_IRQFLAGS_FHSSCHANGEDCHANNEL</span>            <span class="token number">0x02</span> 
#define <span class="token constant">RFLR_IRQFLAGS_CADDETECTED</span>                   <span class="token number">0x01</span> 
</code></pre> 
<p>上面的修改完之后，通信配置就基本完成，就应该能正常通信上了，如果没有通信上，就需要检查一下其他细节的问题，或者在底下评论一起探讨。<br> 我将通信的buffer在串口上打印出来，因为我只用一台电脑，所以我只能切换不同串口来看打印信息：<br> <img src="https://images2.imgbox.com/b1/1b/PaN9OKM9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_442"></a>总结</h3> 
<p>好了，以上就是我最近学习SX1278的学习心得和总结，分享出来主要是对自己学习过程中遇到的问题的一个梳理，还有就是让一些刚开始接触LoRa通信的同学提供一下帮助，更重要是方便以后再用到的时候，也可以有迹可循；如果文章有什么错误的地方或者有不明白的地方，欢迎评论区留言，我们一起探讨。</p> 
<h5><a id="_444"></a>代码</h5> 
<p>源代码我晚一点分享链接，我自己移植的代码涉及到公司机密问题就不贴出来了。<br> 源代码百度网盘：<br> 链接：https://pan.baidu.com/s/1DZEGECa2WiUH4YsNbMp4yQ<br> 提取码：gy3u</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bb5c8eb48183e902ba2be53ec971a880/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">斗图吗？教你用Python来制作表情包</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aca97e916872e6f591dd4d6909ed40e8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">集合对象复制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>