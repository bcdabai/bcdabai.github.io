<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Rust 与 Mysql 交互篇之 Sqlx - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Rust 与 Mysql 交互篇之 Sqlx" />
<meta property="og:description" content="数据库在编程中是一个很重要的环节，这里是记录rust如何操作数据库并以mysql为主的做简单的使用说明。rust中对mysql数据库存有支持的我所知道的crate:
mysql 单一驱动sqlx 多驱动，异步，不是ORMdiesel 多驱动，异常，ORM 因为mysql的crate有点单一，这里主要是说明sqlx及diesel的使用，分两篇记录。本都吃是以sqlx为说明
在这过程的走了不少不能言语的弯路主要有以下两点：
文档都是英文，多数都是偏向于postgres（英文不好）select出来的数据不直观。不像php那样直接一个关联数据解决所有问题 sqlx的sql是原始的，我所知道的是它不像ORM那样，能通过一系列的方法组合成相应的sql，sql都是手写的。是不是用ORM，看自己的需求进行选择
crate 依赖(Cargo.toml文件) [dependencies] tokio = { version = &#34;1&#34;, features = [&#34;full&#34;] } sqlx = { version = &#34;0.6&#34;, features = [ &#34;runtime-tokio-native-tls&#34;, &#34;mysql&#34;, &#34;chrono&#34;, &#34;json&#34;, &#34;macros&#34;, &#34;decimal&#34; ] } dotenvy = &#34;0.15.6&#34; chrono = { version = &#34;0.4.23&#34;, features = [&#34;serde&#34;] } sqlx-cli = &#34;0.6.2&#34; serde = { version = &#34;1.0&#34;, features = [&#34;derive&#34;] } serde_json = &#34;1.0&#34; rust_decimal = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/45d5e177547cc572ee857883ad66e56d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-08T10:16:06+08:00" />
<meta property="article:modified_time" content="2023-02-08T10:16:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Rust 与 Mysql 交互篇之 Sqlx</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>数据库在编程中是一个很重要的环节，这里是记录<code>rust</code>如何操作数据库并以<code>mysql</code>为主的做简单的使用说明。<code>rust</code>中对<code>mysql</code>数据库存有支持的我所知道的<code>crate</code>:</p> 
<ul><li><code>mysql</code> 单一驱动</li><li><code>sqlx</code> 多驱动，异步，不是ORM</li><li><code>diesel</code> 多驱动，异常，ORM</li></ul> 
<p>因为<code>mysql</code>的<code>crate</code>有点单一，这里主要是说明<code>sqlx</code>及<code>diesel</code>的使用，分两篇记录。本都吃是以<code>sqlx</code>为说明</p> 
<p>在这过程的走了不少不能言语的弯路主要有以下两点：</p> 
<ul><li>文档都是英文，多数都是偏向于<code>postgres</code>（英文不好）</li><li><code>select</code>出来的数据不直观。不像<code>php</code>那样直接一个关联数据解决所有问题</li></ul> 
<p><code>sqlx</code>的sql是原始的，我所知道的是它不像ORM那样，能通过一系列的方法组合成相应的sql，sql都是手写的。是不是用ORM，看自己的需求进行选择</p> 
<h4><a id="crate_Cargotoml_15"></a><code>crate</code> 依赖(Cargo.toml文件)</h4> 
<pre><code class="prism language-toml">[dependencies]
tokio = { version = "1", features = ["full"] }
sqlx = { version = "0.6", features = [ 
    "runtime-tokio-native-tls", 
    "mysql", 
    "chrono", 
    "json",
    "macros",
    "decimal"
] }
dotenvy = "0.15.6"
chrono = { version = "0.4.23", features = ["serde"] }
sqlx-cli = "0.6.2"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
rust_decimal = "1.28.0"
</code></pre> 
<p>这里我使用的运行时是<code>tokio</code>，它好像支持三种运行时，另外两种是<code>Async-std</code>（runtime-async-std-native-tls），<code>Actix-web</code>（runtime-actix-native-tls），不同的运行里相应的要在<code>sqlx</code>开启相应的特性支持。在这里有一个很重要的特性<code>macros</code>，如果大量使用宏也就是<code>query*!</code>，而且也非常方面查询，可以让我获取类似<code>php</code>中操作数据库的感觉，所以这个特性很重要。</p> 
<h4><a id="1_37"></a>方式1：原始操作方面</h4> 
<p>通过下标来获取数据</p> 
<p><code>.env</code>文件内容</p> 
<pre><code class="prism language-env">DATABASE_URL=mysql://root:root@localhost:3306/test
</code></pre> 
<p><code>main.rs</code>文件内容</p> 
<pre><code class="prism language-rust"><span class="token keyword">use</span> <span class="token namespace">chrono<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">NaiveDateTime</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 处理 数据库中 datetime 类型</span>
<span class="token keyword">use</span> <span class="token namespace">sqlx<span class="token punctuation">::</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span>                  <span class="token comment">// get 方法的 trait</span>
<span class="token keyword">use</span> <span class="token namespace">sqlx<span class="token punctuation">::</span>mysql<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">MySqlRow</span><span class="token punctuation">,</span> <span class="token class-name">MySqlPoolOptions</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">dotenvy<span class="token punctuation">::</span></span>dotenv<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span>env<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">Deserialize</span><span class="token punctuation">,</span> <span class="token class-name">Serialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span>          <span class="token comment">// 处理 数据库中 json 类型</span>
<span class="token keyword">use</span> <span class="token namespace">rust_decimal<span class="token punctuation">::</span></span><span class="token class-name">Decimal</span><span class="token punctuation">;</span>      <span class="token comment">// 处理 数据库中 decimal 类型</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">RawRawData</span> <span class="token punctuation">{<!-- --></span>
    id<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> 
    title<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    subtitle<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    content<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    tag<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">,</span>
    create_time<span class="token punctuation">:</span> <span class="token class-name">NaiveDateTime</span><span class="token punctuation">,</span>
    normal_time<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    vip_pay<span class="token punctuation">:</span> <span class="token class-name">Decimal</span><span class="token punctuation">,</span>
    normal_pay<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[tokio::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">sqlx<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">dotenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token namespace">env<span class="token punctuation">::</span></span><span class="token function">var</span><span class="token punctuation">(</span><span class="token string">"DATABASE_URL"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"没有设置数据信息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pool <span class="token operator">=</span> <span class="token class-name">MySqlPoolOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> rows<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">MySqlRow</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token namespace">sqlx<span class="token punctuation">::</span></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"select id,title from test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetch_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> data<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">RawRawData</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> id<span class="token punctuation">:</span> <span class="token keyword">i32</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> title<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> subtitle<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> content<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> tag<span class="token punctuation">:</span> <span class="token class-name">Value</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> create_time<span class="token punctuation">:</span> <span class="token class-name">NaiveDateTime</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> normal_time<span class="token punctuation">:</span> <span class="token keyword">i32</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> vip_pay<span class="token punctuation">:</span> <span class="token class-name">Decimal</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> normal_pay<span class="token punctuation">:</span> <span class="token keyword">f32</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">RawRawData</span><span class="token punctuation">{<!-- --></span>
            id<span class="token punctuation">,</span>
            title<span class="token punctuation">,</span>
            subtitle<span class="token punctuation">,</span>
            content<span class="token punctuation">,</span>
            tag<span class="token punctuation">,</span>
            create_time<span class="token punctuation">,</span>
            normal_time<span class="token punctuation">,</span>
            vip_pay<span class="token punctuation">,</span>
            normal_pay
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>单纯的查询出来的 <code>rows</code> 数据打印出来有点初一看看不明白，没有直观性的 <code>key=&gt;value</code> 的形式，感觉是因为强类的原因，不能单纯的当做 <code>String=&gt;String</code> 来处理，所以数据库中的类型也要与<code>rust</code>中的类型相一一对应。上面的代码是通过索引(<code>get</code>)的方法来获取相应的值，这个方法依赖 <code>Row</code> trait，这个是关键</p> 
<blockquote> 
 <p>处理后的数据</p> 
</blockquote> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
    RawRawData <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"111"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">subtitle</span><span class="token operator">:</span> <span class="token string">"1111"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"11111"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">tag</span><span class="token operator">:</span> Array <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span>02T03<span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_time</span><span class="token operator">:</span> <span class="token number">1675278415</span><span class="token punctuation">,</span>
        <span class="token literal-property property">vip_pay</span><span class="token operator">:</span> <span class="token number">10.20</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_pay</span><span class="token operator">:</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    RawRawData <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"2222"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">subtitle</span><span class="token operator">:</span> <span class="token string">"222"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"2222"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">tag</span><span class="token operator">:</span> Array <span class="token punctuation">[</span>
            <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span>02T03<span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_time</span><span class="token operator">:</span> <span class="token number">1675278415</span><span class="token punctuation">,</span>
        <span class="token literal-property property">vip_pay</span><span class="token operator">:</span> <span class="token number">10.20</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_pay</span><span class="token operator">:</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<blockquote> 
 <p>原始数据</p> 
</blockquote> 
<pre><code>MySqlRow { row: Row { storage: b"\0\0\x01\0\0\0\x03111\x041111\x0511111\x02[]\x07\xe7\x07\x02\x02\x03\x06\x11O\xb8\xdac\x0510.20\0\0 A", values: [Some(2..6), Some(7..10), Some(11..15), Some(16..21), Some(22..24), Some(24..32), Some(32..36), Some(37..42), Some(42..46)] }, format: Binary, columns: [MySqlColumn { ordinal: 0, name: id, type_info: MySqlTypeInfo { type: Long, flags: NOT_NULL | PRIMARY_KEY | AUTO_INCREMENT, char_set: 63, max_size: Some(11) }, flags: Some(NOT_NULL | PRIMARY_KEY | AUTO_INCREMENT) }, MySqlColumn { ordinal: 1, name: title, type_info: MySqlTypeInfo { type: String, flags: (empty), char_set: 224, max_size: Some(80) }, flags: Some((empty)) }, MySqlColumn { ordinal: 2, name: subtitle, type_info: MySqlTypeInfo { type: VarString, flags: (empty), char_set: 224, max_size: Some(1020) }, flags: Some((empty)) }, MySqlColumn { ordinal: 3, name: content, type_info: MySqlTypeInfo { type: Blob, flags: BLOB, char_set: 224, max_size: Some(262140) }, flags: Some(BLOB) }, MySqlColumn { ordinal: 4, name: tag, type_info: MySqlTypeInfo { type: Json, flags: BLOB | BINARY, char_set: 63, max_size: Some(4294967295) }, flags: Some(BLOB | BINARY) }, MySqlColumn { ordinal: 5, name: create_time, type_info: MySqlTypeInfo { type: Datetime, flags: BINARY, char_set: 63, max_size: Some(19) }, flags: Some(BINARY) }, MySqlColumn { ordinal: 6, name: normal_time, type_info: MySqlTypeInfo { type: Long, flags: (empty), char_set: 63, max_size: Some(11) }, flags: Some((empty)) }, MySqlColumn { ordinal: 7, name: vip_pay, type_info: MySqlTypeInfo { type: NewDecimal, flags: (empty), char_set: 63, max_size: Some(12) }, flags: Some((empty)) }, MySqlColumn { ordinal: 8, name: normal, type_info: MySqlTypeInfo { type: Float, flags: (empty), char_set: 63, max_size: Some(10) }, flags: Some((empty)) }], column_names: {title: 1, id: 0, content: 3, vip_pay: 7, create_time: 5, subtitle: 2, tag: 4, normal_time: 6, normal: 8} }]
</code></pre> 
<h4><a id="2_145"></a>方法2，通过结构体自动转化</h4> 
<p>索引这个方法，在字段少的情况下还行，多的时间，代码量多，还要 <code>for</code> 二次处理，不是很方便。在已定义的结构中 <code>RawRawData</code> 所要的字段及对应的类型都有了，我们只要为它加一个 <code>sqlx::FromRow</code> 特性就可再配合 <code>query_as</code> 方法就可以实现自动转化，达到想要的效果。</p> 
<p>代码量减少的同时还更加符合人性化，这种使用方法相当不错，推荐使用，要注意点是查询出来的字段一定要多于结构的字段</p> 
<p>结构变化（部分）</p> 
<pre><code class="prism language-rust"><span class="token attribute attr-name">#[derive(Debug, sqlx::FromRow)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">RawRawData</span> <span class="token punctuation">{<!-- --></span>
    id<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> 
    title<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    subtitle<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    content<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    tag<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">,</span>
    create_time<span class="token punctuation">:</span> <span class="token class-name">NaiveDateTime</span><span class="token punctuation">,</span>
    normal_time<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    vip_pay<span class="token punctuation">:</span> <span class="token class-name">Decimal</span><span class="token punctuation">,</span>
    normal_pay<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查询部分</p> 
<pre><code class="prism language-rust"><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token namespace">sqlx<span class="token punctuation">::</span></span><span class="token function">query_as</span><span class="token punctuation">::</span><span class="token operator">&lt;</span>_<span class="token punctuation">,</span> <span class="token class-name">RawRawData</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"select * from test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetch_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-json">
<span class="token punctuation">[</span>
    RawRawData <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"111"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">subtitle</span><span class="token operator">:</span> <span class="token string">"1111"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"11111"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">tag</span><span class="token operator">:</span> Array <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span>02T03<span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_time</span><span class="token operator">:</span> <span class="token number">1675278415</span><span class="token punctuation">,</span>
        <span class="token literal-property property">vip_pay</span><span class="token operator">:</span> <span class="token number">10.20</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_pay</span><span class="token operator">:</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    RawRawData <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"2222"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">subtitle</span><span class="token operator">:</span> <span class="token string">"222"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"2222"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">tag</span><span class="token operator">:</span> Array <span class="token punctuation">[</span>
            <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span>02T03<span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_time</span><span class="token operator">:</span> <span class="token number">1675278415</span><span class="token punctuation">,</span>
        <span class="token literal-property property">vip_pay</span><span class="token operator">:</span> <span class="token number">10.20</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_pay</span><span class="token operator">:</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="3_205"></a>方法3：使用宏方法</h4> 
<p>宏方法查询来的结果不需要由手动转化，是一种比较接近 <code>php</code> 关联查询来的结果。可以通过字段名直接访问数据，要注意的一点是，它有很多数据类型的值都是 <code>Option</code> 类型（我这边除了主键是数字，其它都是 <code>Option</code>），主要有两个方法 <code>query!</code> 及 <code>query_as!</code></p> 
<p>部分代码</p> 
<pre><code class="prism language-rust"><span class="token keyword">let</span> rows <span class="token operator">=</span> <span class="token namespace">sqlx<span class="token punctuation">::</span></span><span class="token macro property">query!</span><span class="token punctuation">(</span><span class="token string">"select * from test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fetch_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
    Record <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token string">"111"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">subtitle</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token string">"1111"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token string">"11111"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            Array <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token number">2023</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span>02T03<span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_time</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token number">1675278415</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">vip_pay</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token number">10.20</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_pay</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token number">10.0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    Record <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token string">"2222"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token number">2023</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span>02T03<span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_time</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token number">1675278415</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">vip_pay</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token number">10.20</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">normal_pay</span><span class="token operator">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>
            <span class="token number">10.0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="_execute_268"></a>关于 execute</h4> 
<p>上面说的都是 <code>query</code> 也就是增删改查中的查。查关注的点是数据，增删改关注的点是影响数量，使用的方法很简单，只返回影响的数量及最新插入的<code>id</code></p> 
<p>代码</p> 
<pre><code class="prism language-rust"><span class="token comment">// 增加</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token namespace">sqlx<span class="token punctuation">::</span></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO `test`.`test`(`id`, `title`, `subtitle`, `content`, `tag`, `create_time`, `normal_time`, `vip_pay`, `normal_pay`) VALUES (4, '2222', '222', '2222', '[\"111\", \"222\"]', '2023-02-02 03:06:17', 1675278415, 10.20, 10);
"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token namespace">sqlx<span class="token punctuation">::</span></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"DELETE FROM `test` where id = ?"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>对应的结果</p> 
<pre><code class="prism language-json">MySqlQueryResult <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">rows_affected</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">last_insert_id</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

MySqlQueryResult <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">rows_affected</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">last_insert_id</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总的来说，查询常用的方法就两个 <code>fetch_all</code> 及 <code>fetch_one</code> 上面用的都是 <code>fetch_all</code> ，<code>fetch_one</code>的用法同时。而对于增删改则只有一个<code>execute</code>方法。</p> 
<h5><a id="_301"></a>小小问题</h5> 
<p>多数情况下<code>sql</code>是有条件参数的，条件一多，手动组合sql会有点麻烦，那么对于<code>sqlx</code>来说，怎么处理会比较好？</p> 
<p>The End。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c1afd421bcb4f404a80b2f90a463115a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Windows 鼠标键盘不可用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/72dc7366fe036c0816e9b77fe60591d5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【vuejs】大屏自适应快速解决方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>