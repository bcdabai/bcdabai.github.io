<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>centos7.9 openresty1.21 增加nginx_upstream_check_module第三方模块 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="centos7.9 openresty1.21 增加nginx_upstream_check_module第三方模块" />
<meta property="og:description" content="1、背景说明： OpenResty是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。
简单地说OpenResty 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应
本次教学操作是在rpm已安装openresty1.21的前提下（dockerfile安装），动态加入第三方模块nginx_upstream_check_module因此我们选择安装OpenResty1.21（目前最新版本）。
nginx_upstream_check_module是阿里的检测后端relaserver 真实状态的模块，使用前端负载均衡器nginx做到后端服务出错时，自动将出错的节点路踢掉，使得正常请求不发往出错的后端节点，当出错的后端节点恢复后，又能将节点自动加入集群中。nginx自身虽然带有简单的健康检测，但并不有效。因此我们选择单独安装nginx_upstream_check_module更好的做健康检查
首先根据rpm安装openresty1.21后发现三方模块无法在dockerfile加入，所以本次安装为手动动态添加
2、下载最新 openresty1.21（此版本要和你rpm安装的版本相同，必须相同） https://openresty.org/download/openresty-1.21.4.1.tar.gz
从GitHub下载三方zip 包
https://github.com/yaoweibin/nginx_upstream_check_module.git
3、nginx_upstream_check_module-master打补丁 cd /root
tar -zxvf openresty-1.21.4.1.tar.gz
unzip nginx_upstream_check_module-master.zip
打nginx_upstream_check_module补丁：
因为我们nginx是1.21版本，因此需要选择check_1.20.1&#43;.patch进行打补丁，这个地方版本需要对应好，不然会报错
打补丁过程中，因为安装的不是默认Nginx，是openresty，因此需要手工指定安装文件的路径和名称
打补丁过程中共需要手工录入5个文件的路径信息，其实就是要更新这5个文件的内容，使其兼容nginx_upstream_check_module-master的功能：
test# cd openresty-1.21.4.1 test# patch -p1 &lt; /root/nginx_upstream_check_module-master/check_1.21.1&#43;.patch file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/modules/ngx_http_upstream_hash_module.c file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/modules/ngx_http_upstream_ip_hash_module.c file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/modules/ngx_http_upstream_least_conn_module.c file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/ngx_http_upstream_round_robin.c file to patch：/root/openresty-1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/62c1bb6654a90bba6a7aa4a64db7a5cc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-14T16:26:20+08:00" />
<meta property="article:modified_time" content="2023-04-14T16:26:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">centos7.9 openresty1.21 增加nginx_upstream_check_module第三方模块</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>1、背景说明：</h3> 
<p><br> OpenResty是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p> 
<p>简单地说OpenResty 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应<br><strong>本次教学操作是在rpm已安装openresty1.21的前提下（dockerfile安装），动态加入第三方模块nginx_upstream_check_module因此我们选择安装OpenResty1.21（目前最新版本）。</strong></p> 
<p>nginx_upstream_check_module是阿里的检测后端relaserver 真实状态的模块，使用前端负载均衡器nginx做到后端服务出错时，自动将出错的节点路踢掉，使得正常请求不发往出错的后端节点，当出错的后端节点恢复后，又能将节点自动加入集群中。nginx自身虽然带有简单的健康检测，但并不有效。因此我们选择单独安装nginx_upstream_check_module更好的做健康检查</p> 
<p>首先根据rpm安装openresty1.21后发现三方模块无法在dockerfile加入，所以本次安装为手动动态添加</p> 
<h3>2、下载最新 openresty1.21（此版本要和你rpm安装的版本相同，必须相同）</h3> 
<p>https://openresty.org/download/openresty-1.21.4.1.tar.gz</p> 
<p>从GitHub下载三方zip 包<br><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fyaoweibin%2Fnginx_upstream_check_module.git" title="https://github.com/yaoweibin/nginx_upstream_check_module.git">https://github.com/yaoweibin/nginx_upstream_check_module.git</a></p> 
<h3>3、nginx_upstream_check_module-master打补丁</h3> 
<p><br> cd /root<br> tar -zxvf openresty-1.21.4.1.tar.gz<br> unzip nginx_upstream_check_module-master.zip</p> 
<p>打nginx_upstream_check_module补丁：<br> 因为我们nginx是1.21版本，因此需要选择check_1.20.1+.patch进行打补丁，这个地方版本需要对应好，不然会报错<br> 打补丁过程中，因为安装的不是默认Nginx，是openresty，因此需要手工指定安装文件的路径和名称<br> 打补丁过程中共需要手工录入5个文件的路径信息，其实就是要更新这5个文件的内容，使其兼容nginx_upstream_check_module-master的功能：</p> 
<pre><code class="language-bash">test# cd openresty-1.21.4.1
test# patch -p1 &lt; /root/nginx_upstream_check_module-master/check_1.21.1+.patch

file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/modules/ngx_http_upstream_hash_module.c
file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/modules/ngx_http_upstream_ip_hash_module.c
file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/modules/ngx_http_upstream_least_conn_module.c

file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/ngx_http_upstream_round_robin.c
file to patch：/root/openresty-1.21.4.1/bundle/nginx-1.21.4.1/src/http/ngx_http_upstream_round_robin.h</code></pre> 
<h3>4、编译openresty,动态添加三方模块</h3> 
<pre><code class="language-bash">yum -y install ccache pcre-devel openssl-devel gcc curl openldap-devel openresty-openssl111-devel

test# cd /root/openresty-1.21.4.1

openresty-1.21.4.1# ./configure --prefix=/usr/local/openresty --add-module=/root/nginx_upstream_check_module-master

## 切记 如果是动态添加模块，只执行gmake，不要执行gmake install,执行install 会把线上的-V得覆盖了
test# gmake


执行完之后，进入该目录下
cd /root/openresty-1.21.4.1/build/1.21.4.1/objs
## 停nginx
objs# /usr/local/openresty/nginx/sbin/nginx -s stop
objs# mv /usr/local/openresty/nginx/sbin/nginx /usr/local/openresty/nginx/sbin/nginxbak
objs# cp nginx /usr/local/openresty/nginx/sbin/

sbin# ./nginx -V
nginx version: openresty/1.21.4.1
built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) 
built with OpenSSL 1.0.2k-fips  26 Jan 2017
TLS SNI support enabled
configure arguments: --prefix=/usr/local/openresty/nginx --with-cc-opt=-O2 --add-module=../ngx_devel_kit-0.3.1 --add-module=../echo-nginx-module-0.62 --add-module=../xss-nginx-module-0.06 --add-module=../ngx_coolkit-0.2 --add-module=../set-misc-nginx-module-0.33 --add-module=../form-input-nginx-module-0.12 --add-module=../encrypted-session-nginx-module-0.09 --add-module=../srcache-nginx-module-0.32 --add-module=../ngx_lua-0.10.21 --add-module=../ngx_lua_upstream-0.07 --add-module=../headers-more-nginx-module-0.33 --add-module=../array-var-nginx-module-0.05 --add-module=../memc-nginx-module-0.19 --add-module=../redis2-nginx-module-0.15 --add-module=../redis-nginx-module-0.3.9 --add-module=../rds-json-nginx-module-0.15 --add-module=../rds-csv-nginx-module-0.09 --add-module=../ngx_stream_lua-0.0.11 --with-ld-opt=-Wl,-rpath,/usr/local/openresty/luajit/lib --add-module=/root/nginx_upstream_check_module --with-stream --with-stream_ssl_module --with-stream_ssl_preread_module --with-http_ssl_module</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/219b3fa0cea7c2ba15e6805ebf78e33a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">git代码使用空格缩进</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6836b94b7356e580d97e96594af750b8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu系统驱动掉了如何一步打驱动</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>