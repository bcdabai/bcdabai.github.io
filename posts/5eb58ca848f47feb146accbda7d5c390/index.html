<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>redis哨兵模式的功能-以及主从选举算法 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="redis哨兵模式的功能-以及主从选举算法" />
<meta property="og:description" content=" 对于哨兵模式而言，主要负责的内容有
1、监控 2、选主（选择主库） 3、通知 哨兵工作流程： 1、监控：节点发现和配置
2、心跳检测： 哨兵会定期向监控的节点发送PING命令来检测节点是否存活
3、节点状态变更： 当哨兵连续多次无法连接到一个节点时，它会将该节点标记为主观下线
4、故障判断和选举： 当主节点被标记为客观下线时，哨兵会执行故障判断。它会从剩余的健康主节点中选举一个作为新的主节点，并将该信息广播给其他哨兵和客户端。故障判断的逻辑考虑了多个因素，包括优先级、最近一次复制偏移量等。
5、自动故障切换： 如果主节点被标记为客观下线，哨兵会通知从节点晋升为新的主节点。同时，哨兵会更新其他从节点的配置，使其复制新的主节点。这确保了即使主节点发生故障，集群仍然可以继续提供服务。
6、监控从节点： 哨兵还会监控从节点的状态，包括从节点是否与主节点保持同步，以及从节点的复制延迟情况。如果从节点无法同步或者复制延迟过高，哨兵会将其标记为不健康。
7、节点恢复： 如果一个节点从客观下线状态恢复，哨兵会将其标记为健康，并将其重新纳入集群中。从节点恢复后，它会重新同步主节点的数据。
8、配置更新： 如果集群的拓扑发生变化，例如添加或移除节点，哨兵会自动更新配置，以便客户端能够正确连接到集群。
9、事件通知： 哨兵通过发布订阅机制向订阅者（通常是客户端）发送有关集群状态变化的消息。这使得应用程序能够根据实时的集群状态做出相应的决策。
10、持续监控： 哨兵会持续地监控集群中的节点，定期执行心跳检测、状态更新和故障判断，以确保集群的稳定运行。
选举流程-如何选定新主库 1、主观下线和客观下线判断： 当哨兵节点主观下线（单个哨兵认为不可用）一个主节点时，如果多数哨兵都主观下线了同一个主节点，那么这个主节点会被标记为客观下线（多数派共识）。
2、选举新主节点： 当一个主节点被标记为客观下线后，哨兵节点会开始选举一个新的主节点。选举过程如下：
哨兵会在所有没有下线的从节点（Slaves）中选择一个作为新主节点。哨兵会选择一个【延迟最小、复制偏移量最大】的从节点作为新主节点。这确保了新主节点是最接近原主节点的从节点。
如果没有合适的从节点，哨兵会选择一个【具备最高优先级的】从节点，将其升级为主节点。
如果优先级相同，那么哨兵会选择一个【复制偏移量最大】的从节点。
3、故障转移和切换：一旦新主节点被选定，哨兵会发起故障转移操作。旧主节点会变成新主节点的一个从节点。其他从节点会重新配置，指向新的主节点。这个过程会保证尽量不丢失数据，并且保证整个集群的高可用性。
Redis哨兵模式选举用的是Redis Sentinel自主选举
redis哨兵模式详细介绍：跳转
脑裂的问题解决和数据丢失的问题 解决方案：
1、首先是脑裂的问题，在配置文件中，设置如果主节点发现可以用从节点少于，原来配置的从节点，脑裂会生成新的Master，所以从节点就变少了，那么就告警，或者不在为客户端提供服务，这个就可以解决脑裂的问题。
2、第二个因为主节点真的挂机了，丢了很多数据，那么久判断如果每个从节点的偏移量差太大，比如某个节点的offset只有百分之80那么说明还有很多没有备份给从节点，如果主节点在新增数据，那么偏移量的差就会越来越大，所以此时主节点不能再对外提供服务。
缺点：就是本来高可用，结果变成不高可用了。
怎么发现Master挂了 哨兵的节点，最少是三台，或者三台以上，并且是单数，为什么是单数，主要是为了防止投票的时候，平票的情况。
如何选主 1、响应时间 2、从节点的数据完整性 3、稳定性，运行时间越长越稳定 4、如果三个情况都一样，那就更新runId来选。 " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5eb58ca848f47feb146accbda7d5c390/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-16T22:47:41+08:00" />
<meta property="article:modified_time" content="2023-12-16T22:47:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">redis哨兵模式的功能-以及主从选举算法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>对于哨兵模式而言，主要负责的内容有</p> 
<pre><code class="prism language-java"><span class="token number">1</span>、监控
<span class="token number">2</span>、选主（选择主库）
<span class="token number">3</span>、通知
</code></pre> 
<h2><a id="_8"></a>哨兵工作流程：</h2> 
<p>1、监控：节点发现和配置<br> 2、心跳检测： 哨兵会定期向监控的节点发送PING命令来检测节点是否存活<br> 3、节点状态变更： 当哨兵连续多次无法连接到一个节点时，它会将该节点标记为主观下线<br> 4、故障判断和选举： 当主节点被标记为客观下线时，哨兵会执行故障判断。它会从剩余的健康主节点中选举一个作为新的主节点，并将该信息广播给其他哨兵和客户端。故障判断的逻辑考虑了多个因素，包括优先级、最近一次复制偏移量等。</p> 
<p>5、自动故障切换： 如果主节点被标记为客观下线，哨兵会通知从节点晋升为新的主节点。同时，哨兵会更新其他从节点的配置，使其复制新的主节点。这确保了即使主节点发生故障，集群仍然可以继续提供服务。</p> 
<p>6、监控从节点： 哨兵还会监控从节点的状态，包括从节点是否与主节点保持同步，以及从节点的复制延迟情况。如果从节点无法同步或者复制延迟过高，哨兵会将其标记为不健康。</p> 
<p>7、节点恢复： 如果一个节点从客观下线状态恢复，哨兵会将其标记为健康，并将其重新纳入集群中。从节点恢复后，它会重新同步主节点的数据。</p> 
<p>8、配置更新： 如果集群的拓扑发生变化，例如添加或移除节点，哨兵会自动更新配置，以便客户端能够正确连接到集群。</p> 
<p>9、事件通知： 哨兵通过发布订阅机制向订阅者（通常是客户端）发送有关集群状态变化的消息。这使得应用程序能够根据实时的集群状态做出相应的决策。</p> 
<p>10、持续监控： 哨兵会持续地监控集群中的节点，定期执行心跳检测、状态更新和故障判断，以确保集群的稳定运行。</p> 
<h2><a id="_29"></a>选举流程-如何选定新主库</h2> 
<p>1、主观下线和客观下线判断： 当哨兵节点主观下线（单个哨兵认为不可用）一个主节点时，如果多数哨兵都主观下线了同一个主节点，那么这个主节点会被标记为客观下线（多数派共识）。</p> 
<p>2、选举新主节点： 当一个主节点被标记为客观下线后，哨兵节点会开始选举一个新的主节点。选举过程如下：</p> 
<p>哨兵会在所有没有下线的从节点（Slaves）中选择一个作为新主节点。哨兵会选择一个【延迟最小、复制偏移量最大】的从节点作为新主节点。这确保了新主节点是最接近原主节点的从节点。<br> 如果没有合适的从节点，哨兵会选择一个【具备最高优先级的】从节点，将其升级为主节点。<br> 如果优先级相同，那么哨兵会选择一个【复制偏移量最大】的从节点。</p> 
<p>3、故障转移和切换：一旦新主节点被选定，哨兵会发起故障转移操作。旧主节点会变成新主节点的一个从节点。其他从节点会重新配置，指向新的主节点。这个过程会保证尽量不丢失数据，并且保证整个集群的高可用性。</p> 
<p>Redis哨兵模式选举用的是Redis Sentinel自主选举</p> 
<p>redis哨兵模式详细介绍：<a href="https://zhuanlan.zhihu.com/p/651457150" rel="nofollow">跳转</a></p> 
<h2><a id="_45"></a>脑裂的问题解决和数据丢失的问题</h2> 
<p><img src="https://images2.imgbox.com/99/06/79JiZ1pX_o.png" alt="在这里插入图片描述"><br> 解决方案：<br> <img src="https://images2.imgbox.com/05/43/mmRqIxF5_o.png" alt="在这里插入图片描述"><br> 1、首先是脑裂的问题，在配置文件中，设置如果主节点发现可以用从节点少于，原来配置的从节点，脑裂会生成新的Master，所以从节点就变少了，那么就告警，或者不在为客户端提供服务，这个就可以解决脑裂的问题。</p> 
<p>2、第二个因为主节点真的挂机了，丢了很多数据，那么久判断如果每个从节点的偏移量差太大，比如某个节点的offset只有百分之80那么说明还有很多没有备份给从节点，如果主节点在新增数据，那么偏移量的差就会越来越大，所以此时主节点不能再对外提供服务。</p> 
<p>缺点：就是本来高可用，结果变成不高可用了。</p> 
<h2><a id="Master_56"></a>怎么发现Master挂了</h2> 
<p>哨兵的节点，最少是三台，或者三台以上，并且是单数，为什么是单数，主要是为了防止投票的时候，平票的情况。<br> <img src="https://images2.imgbox.com/17/83/1WDc87yA_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_59"></a>如何选主</h2> 
<center> 
 <img src="https://images2.imgbox.com/9b/2c/j2xTFzCB_o.png" width="90%"> 
</center> 
<pre><code class="prism language-java"><span class="token number">1</span>、响应时间
<span class="token number">2</span>、从节点的数据完整性
<span class="token number">3</span>、稳定性，运行时间越长越稳定
<span class="token number">4</span>、如果三个情况都一样，那就更新runId来选。
</code></pre> 
<p><img src="https://images2.imgbox.com/34/ea/Dv4DFTTc_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1fe08aae4126c1c1b99c0be7726ca135/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【鸿蒙开发】第六章 ArkTS基础知识 - 类、接口及泛型</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c9df4f98aff212a6aecf575080365c65/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">分享由于找不到msvcp140.dll，无法继续执行代码的多个解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>