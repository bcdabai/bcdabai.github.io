<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>同步FIFO和异步FIFO的实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="同步FIFO和异步FIFO的实现" />
<meta property="og:description" content="同步FIFO的实现 首先是同步的实现，只需要一个时钟用来控制读写。
同步 FIFO 实现较为直接，如下图所示，一个 FIFO 内部实现了 RAM 和一个控制读写的控制端，和普通的随机存储器不一样的是，FIFO 内部需要自动产生读写地址。
控制端产生空、满信号。因此如何实现控制端去产生空满信号是主要需要考虑的地方。通常空满的判断是通过读、写地址进行的。
第一种思路，利用读写地址的大小来判断空、满 方法很简单，设置一个信号量 factor 来表识空满，每次读一个数据则令 factor - 1，写一个数据则令其&#43;1。实现代码如下：
module fifo #( parameter DATA_WIDTH=16, parameter ADDR_WIDTH=8 )( input	clk	, input	rst_n	, input	write_en	, input	[DATA_WIDTH-1:0]	write_data	, input	read_en	, output	reg	[DATA_WIDTH-1:0]	read_data	, output	reg	empty	, output	reg	full	, output	[ADDR_WIDTH-1:0]	counter	); reg [ADDR_WIDTH-1:0] read_addr; reg [ADDR_WIDTH-1:0] write_addr; reg [ADDR_WIDTH-1:0] factor; assign counter	= factor; wire write_allow	= (write_en &amp;&amp; !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/550592092e0859f7bfca68f16c04b474/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-10T17:32:55+08:00" />
<meta property="article:modified_time" content="2021-06-10T17:32:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">同步FIFO和异步FIFO的实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="FIFO_0"></a>同步FIFO的实现</h3> 
<p>首先是同步的实现，只需要一个时钟用来控制读写。</p> 
<p>同步 FIFO 实现较为直接，如下图所示，一个 FIFO 内部实现了 RAM 和一个控制读写的控制端，和普通的随机存储器不一样的是，FIFO 内部需要自动产生读写地址。</p> 
<p>控制端产生空、满信号。因此如何实现控制端去产生空满信号是主要需要考虑的地方。通常空满的判断是通过读、写地址进行的。<br> <img src="https://images2.imgbox.com/e4/60/7fbKMFFM_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_7"></a>第一种思路，利用读写地址的大小来判断空、满</h5> 
<p>方法很简单，设置一个信号量 factor 来表识空满，每次读一个数据则令 factor - 1，写一个数据则令其+1。实现代码如下：</p> 
<pre><code class="prism language-clike">module fifo #<span class="token punctuation">(</span>
	parameter DATA_WIDTH<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
	parameter ADDR_WIDTH<span class="token operator">=</span><span class="token number">8</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>
	input							clk			<span class="token punctuation">,</span>
	input							rst_n		<span class="token punctuation">,</span>
	input							write_en	<span class="token punctuation">,</span>
	input		<span class="token punctuation">[</span>DATA_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	write_data	<span class="token punctuation">,</span>
	input							read_en		<span class="token punctuation">,</span>
	output	reg	<span class="token punctuation">[</span>DATA_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	read_data	<span class="token punctuation">,</span>
	output	reg						empty		<span class="token punctuation">,</span>
	output	reg						full		<span class="token punctuation">,</span>
	output		<span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	counter		
<span class="token punctuation">)</span><span class="token punctuation">;</span>

	
	reg <span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> read_addr<span class="token punctuation">;</span>
	reg <span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> write_addr<span class="token punctuation">;</span>
	reg <span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> factor<span class="token punctuation">;</span>
	assign counter		<span class="token operator">=</span> factor<span class="token punctuation">;</span>

	wire write_allow	<span class="token operator">=</span> <span class="token punctuation">(</span>write_en <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>full<span class="token punctuation">)</span><span class="token punctuation">;</span>
	wire read_allow		<span class="token operator">=</span> <span class="token punctuation">(</span>read_en	<span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 实例化 RAM</span>
	dual_ram <span class="token function">ram</span><span class="token punctuation">(</span>clk<span class="token punctuation">,</span> clk<span class="token punctuation">,</span> rst_n<span class="token punctuation">,</span> read_allow<span class="token punctuation">,</span> write_allow<span class="token punctuation">,</span> read_addr<span class="token punctuation">,</span> write_addr<span class="token punctuation">,</span> write_data<span class="token punctuation">,</span> read_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

	always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
			factor		<span class="token operator">&lt;=</span> 'h0<span class="token punctuation">;</span>
			read_addr	<span class="token operator">&lt;=</span> 'h0<span class="token punctuation">;</span>
			write_addr	<span class="token operator">&lt;=</span> 'h0<span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>write_allow<span class="token punctuation">)</span> begin
			factor 		<span class="token operator">&lt;=</span> factor <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
			write_addr	<span class="token operator">&lt;=</span> write_addr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>read_allow<span class="token punctuation">)</span> begin
			factor		<span class="token operator">&lt;=</span> factor <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
			read_addr	<span class="token operator">&lt;=</span> read_addr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		end
	end

	always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
			empty	<span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> begin
			empty	<span class="token operator">&lt;=</span> <span class="token punctuation">(</span> <span class="token operator">!</span>write_en <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>factor<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">7</span>'b0<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>factor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> read_en<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//empty	&lt;= factor == 8'b0;</span>
		end
	end

	always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
			full	<span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> begin
			full 	<span class="token operator">&lt;=</span> <span class="token punctuation">(</span> <span class="token operator">!</span>read_en <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>factor<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">7</span>'b1111111<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>factor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> write_en<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//full	&lt;= (factor == 8'hFF);</span>
		end
			
	end

endmodule

<span class="token comment">// 定义一个双端口 RAM</span>
module dual_ram#<span class="token punctuation">(</span>
	parameter DATA_WIDTH<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
	parameter ADDR_WIDTH<span class="token operator">=</span><span class="token number">8</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>
	input	read_clk<span class="token punctuation">,</span>
	input	write_clk<span class="token punctuation">,</span>
	input	rst_n<span class="token punctuation">,</span>
	input	read_en<span class="token punctuation">,</span>
	input	write_en<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	read_addr<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	write_addr<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>DATA_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	write_data<span class="token punctuation">,</span>
	output	reg	<span class="token punctuation">[</span>DATA_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	read_data

<span class="token punctuation">)</span><span class="token punctuation">;</span>

	reg <span class="token punctuation">[</span>DATA_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> mem <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	integer i<span class="token punctuation">;</span>
	always@<span class="token punctuation">(</span>posedge write_clk or negedge rst_n<span class="token punctuation">)</span> begin<span class="token punctuation">:</span> write_ram
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
				mem<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token punctuation">{<!-- --></span>DATA_WIDTH<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>write_en<span class="token punctuation">)</span> begin
			mem<span class="token punctuation">[</span>write_addr<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> write_data<span class="token punctuation">;</span>
		end
	end

	always@<span class="token punctuation">(</span>posedge read_clk or negedge rst_n<span class="token punctuation">)</span> begin<span class="token punctuation">:</span> read_ram
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
			read_data <span class="token operator">&lt;=</span> <span class="token punctuation">{<!-- --></span>DATA_WIDTH<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>read_en<span class="token punctuation">)</span> begin
			read_data <span class="token operator">&lt;=</span> mem<span class="token punctuation">[</span>read_addr<span class="token punctuation">]</span><span class="token punctuation">;</span>
		end
	end

endmodule

</code></pre> 
<p>值得注意的是，上面的代码对空满的判断并不简简单单是判断 factor 的大小为 0 还是等于 FIFO 大小。例如对空信号的判断：</p> 
<pre><code class="prism language-clike">empty <span class="token operator">&lt;=</span> <span class="token punctuation">(</span> <span class="token operator">!</span>write_en <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>factor<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">7</span>'b0<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>factor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> read_en<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这句代码的意思就是，要想为空，那么写信号一定无效，同时如果如果 factor==0，那么肯定是空；然而还有一种极端情况，即在FIFO 内部只有一个数据时，读信号还有效，那么下个 cycle，FIFO 一定为空。</p> 
<p>这样的判断有些繁琐，还需要两个 full、empty 寄存器。</p> 
<h5><a id="_126"></a>第二种思路，采用读写地址位进行空、满判断</h5> 
<p>假设，实例化的 RAM 地址位为 4，那么我们可以定义 5 bit 的读写地址寄存器（read_addr_e、write_addr_e），高位用来当作标志位，用来标识读写的次数关系。但是在访问 RAM 时还是需要输入 4 bit 的地址。判断规则如下：</p> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          i 
         
        
          f 
         
         
        
          w 
         
        
          r 
         
        
          i 
         
        
          t 
         
        
          e 
         
        
          _ 
         
        
          a 
         
        
          d 
         
        
          d 
         
        
          r 
         
        
          _ 
         
        
          e 
         
        
          = 
         
        
          = 
         
        
          r 
         
        
          e 
         
        
          a 
         
        
          d 
         
        
          _ 
         
        
          a 
         
        
          d 
         
        
          d 
         
        
          r 
         
        
          _ 
         
        
          e 
         
         
        
          t 
         
        
          h 
         
        
          e 
         
        
          n 
         
         
        
          e 
         
        
          m 
         
        
          p 
         
        
          t 
         
        
          y 
         
        
          = 
         
        
          1 
         
        
       
         if \quad write\_addr\_e == read\_addr\_e \quad then \quad empty=1 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.00444em; vertical-align: -0.31em;"></span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mspace" style="margin-right: 1em;"></span><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span><span class="base"><span class="strut" style="height: 0.36687em; vertical-align: 0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.00444em; vertical-align: -0.31em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right: 1em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 1em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span>（因为读写地址相同，意味着读指针、写指针重合）</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          i 
         
        
          f 
         
         
        
          ( 
         
        
          r 
         
        
          e 
         
        
          a 
         
        
          d 
         
        
          _ 
         
        
          a 
         
        
          d 
         
        
          d 
         
        
          r 
         
        
          _ 
         
        
          e 
         
        
          [ 
         
        
          4 
         
        
          ] 
         ⁣ 
        
          = 
         
        
          w 
         
        
          r 
         
        
          i 
         
        
          t 
         
         
         
           e 
          
         
           a 
          
         
        
          d 
         
        
          d 
         
         
         
           r 
          
         
           e 
          
         
        
          [ 
         
        
          4 
         
        
          ] 
         
        
          ) 
         
        
          &amp; 
         
        
          &amp; 
         
        
          ( 
         
        
          r 
         
        
          e 
         
        
          a 
         
        
          d 
         
        
          _ 
         
        
          a 
         
        
          d 
         
        
          d 
         
        
          r 
         
        
          _ 
         
        
          e 
         
        
          [ 
         
        
          3 
         
        
          : 
         
        
          0 
         
        
          ] 
         
        
          = 
         
        
          = 
         
        
          w 
         
        
          r 
         
        
          i 
         
        
          t 
         
        
          e 
         
        
          _ 
         
        
          a 
         
        
          d 
         
        
          d 
         
        
          r 
         
        
          _ 
         
        
          e 
         
        
          [ 
         
        
          3 
         
        
          : 
         
        
          0 
         
        
          ] 
         
        
          ) 
         
         
        
          t 
         
        
          h 
         
        
          e 
         
        
          n 
         
         
        
          f 
         
        
          u 
         
        
          l 
         
        
          l 
         
        
          = 
         
        
          1 
         
        
       
         if \quad (read\_addr\_e[4] \!= write_addr_e[4]) \&amp;\&amp; (read\_addr\_e[3:0] == write\_addr\_e[3:0]) \quad then \quad full=1 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.06em; vertical-align: -0.31em;"></span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mspace" style="margin-right: 1em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">e</span><span class="mopen">[</span><span class="mord">4</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mspace" style="margin-right: -0.166667em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.06em; vertical-align: -0.31em;"></span><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">[</span><span class="mord">4</span><span class="mclose">]</span><span class="mclose">)</span><span class="mord">&amp;</span><span class="mord">&amp;</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">e</span><span class="mopen">[</span><span class="mord">3</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">0</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span><span class="base"><span class="strut" style="height: 0.36687em; vertical-align: 0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.06em; vertical-align: -0.31em;"></span><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord" style="margin-right: 0.02778em;">_</span><span class="mord mathdefault">e</span><span class="mopen">[</span><span class="mord">3</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">0</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right: 1em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 1em;"></span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span>（因为标志位不同意味着写指针可能已经领先一圈，例如 00000,10000 表示已经写了 8 个数了，而还没有读出一个数，则满了）</li></ul> 
<p>实现代码如下：</p> 
<pre><code class="prism language-clike">module fifo #<span class="token punctuation">(</span>
	parameter DATA_WIDTH<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
	parameter ADDR_WIDTH<span class="token operator">=</span><span class="token number">4</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>
	input							clk			<span class="token punctuation">,</span>
	input							rst_n		<span class="token punctuation">,</span>
	input							write_en	<span class="token punctuation">,</span>
	input		<span class="token punctuation">[</span>DATA_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	write_data	<span class="token punctuation">,</span>
	input							read_en		<span class="token punctuation">,</span>
	
	output	reg	<span class="token punctuation">[</span>DATA_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	read_data	<span class="token punctuation">,</span>
	output							empty		<span class="token punctuation">,</span>
	output							full		
<span class="token punctuation">)</span><span class="token punctuation">;</span>

	wire	<span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> read_addr<span class="token punctuation">;</span>
	wire	<span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> write_addr<span class="token punctuation">;</span>

	reg		<span class="token punctuation">[</span>ADDR_WIDTH  <span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> read_addr_e<span class="token punctuation">;</span>
	reg		<span class="token punctuation">[</span>ADDR_WIDTH  <span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> write_addr_e<span class="token punctuation">;</span>
	
	assign read_addr	<span class="token operator">=</span> read_addr_e<span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	assign write_addr	<span class="token operator">=</span> write_addr_e<span class="token punctuation">[</span>ADDR_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	wire write_allow	<span class="token operator">=</span> <span class="token punctuation">(</span>write_en <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>full<span class="token punctuation">)</span><span class="token punctuation">;</span>
	wire read_allow		<span class="token operator">=</span> <span class="token punctuation">(</span>read_en	<span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 为了更加简洁，直接定义了一个 memory</span>
	reg <span class="token punctuation">[</span>DATA_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> mem <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	integer i<span class="token punctuation">;</span>
	always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
				mem<span class="token punctuation">[</span>i<span class="token punctuation">]</span>		<span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>write_allow<span class="token punctuation">)</span>
			mem<span class="token punctuation">[</span>write_addr<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> write_data<span class="token punctuation">;</span>
	end
	

	always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
			read_addr_e 	<span class="token operator">&lt;=</span> 'h0<span class="token punctuation">;</span>
			write_addr_e	<span class="token operator">&lt;=</span> 'h0<span class="token punctuation">;</span>
			read_data		<span class="token operator">&lt;=</span> 'h0<span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>write_allow<span class="token punctuation">)</span> begin
			write_addr_e	<span class="token operator">&lt;=</span> write_addr_e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		end
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>read_allow<span class="token punctuation">)</span> begin
			read_addr_e		<span class="token operator">&lt;=</span> read_addr_e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
			read_data		<span class="token operator">&lt;=</span> mem<span class="token punctuation">[</span>read_addr<span class="token punctuation">]</span><span class="token punctuation">;</span>
		end
	end
	<span class="token comment">// 空、满判断</span>
	assign empty	<span class="token operator">=</span> <span class="token punctuation">(</span>write_addr_e <span class="token operator">==</span> read_addr_e<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
	assign full		<span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>read_addr_e<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!=</span> write_addr_e<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>read_addr_e<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> write_addr_e<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

endmodule
</code></pre> 
<h3><a id="_FIFO__193"></a>异步 FIFO 的实现</h3> 
<p>在异步 FIFO 中，读写时钟不同，需要跨时钟域处理，还需要采用格雷码来打一拍，进行读写地址的采样（空满判断）。格雷码如下所示：<br> <img src="https://images2.imgbox.com/34/af/Ml8SDTTo_o.png" alt="在这里插入图片描述"><br> <strong>为什么采用格雷码？</strong></p> 
<p>事实上二进制读指针在增减时，经常发生多为突变，比如六位地址111111会在下一个 时刻变成000000，在实际电路中，这个变化过程要持续很长一段时间，会由 111111 经历 6 个状态转移到 00000，比如111111-&gt;101111-&gt;10111-&gt;100110-&gt;100100-&gt;000100-&gt;000000。由于写时钟与读时钟不同步，异步的写时钟很可能会在状态不稳定的中间某个状态采样，这样就会得到错误的读指针，进而做出错误的状态判断，导致系统异常（亚稳态问题）。而且由于多位同时突变，凭借概率论常识可知发生错误的可能性很大。</p> 
<p><strong>那么怎样才能避免这个问题的发生呢？</strong> 1000-&gt;1000(可能会错采样到它)-&gt;0000</p> 
<p>显然，在中间状态采样，这个是不可能避免的，这是异步系统天生的缺陷。我们的目标是：即使在中间状态采样，也不能影响空满状态的判断。符合这个要求的编码方式是：每次只能有1个bit发生改变。为什么这么说呢？因为当只有一个bit发生改变时，即使在中间状态采样，其结果也不外乎两种：递增前原指针和递增后新指针。显然递增后新指针是最新情况的反映，如果采样到这个指针，那么和我们的设计预期是一致的，如果采样到递增前的原指针，会有什么结果呢？<strong>假设现在采样读指针，那么最坏的情况就是把“不满”判断成了 “满”，使得本来被允许的写操作被禁正了，但是这并不会对逻辑产生影响，只是带来了写操作的延迟</strong>。同样的，<strong>如果现在采样写指针，那么最坏的情况就是把“不空”判断成“空”，产生“虚空”， 使得本来被允许的读操作被禁止了，但是这也不会对逻辑产生影响，只是带来了读操作的延迟</strong>。</p> 
<p>综上，使用格雷码进行采样是一种较好的选择。</p> 
<h5><a id="_206"></a>硬件架构设计</h5> 
<p><img src="https://images2.imgbox.com/ad/8c/bK0e8kgZ_o.png" alt="在这里插入图片描述"><br> 异步FIFO的整体结构大致如下：</p> 
<ul><li> <p>Write_control:控制写操作与满信号（w_full）的判断与产生。</p> </li><li> <p>Read_control:控制读操作与空信号(r_empty)的判断与产生。</p> </li><li> <p>RAM:双端口数据存取RAM。</p> </li><li> <p>Bin_to_gray:二进制码转格雷码模块。用于将读写地址二进制码转成格雷码。</p> </li><li> <p>SYN：跨时钟同步模块，即将读地址的格雷码（r_g_addr）向w_clk同步；将写地址的格雷码（w_g_addr）向r_clk同步。主要操作就是通过寄存器打两拍。</p> </li></ul> 
<pre><code class="prism language-clike">module asyn_fifo #<span class="token punctuation">(</span>
	parameter	WIDTH_D <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
	parameter	WIDTH_A	<span class="token operator">=</span> <span class="token number">8</span>	<span class="token punctuation">,</span>
	parameter	DEPTH	<span class="token operator">=</span> <span class="token number">256</span>
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
	input					r_clk<span class="token punctuation">,</span>
	input					w_clk<span class="token punctuation">,</span>
	input					rst_n<span class="token punctuation">,</span>
	input					r_en<span class="token punctuation">,</span>
	input					w_en<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>WIDTH_D<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	data_in<span class="token punctuation">,</span>
	output	<span class="token punctuation">[</span>WIDTH_D<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	data_out
<span class="token punctuation">)</span><span class="token punctuation">;</span>

wire	<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> 	w_addr_to_ram<span class="token punctuation">;</span>
wire	<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> 	r_addr_to_ram<span class="token punctuation">;</span>
wire					r_allow<span class="token punctuation">;</span>
wire					w_allow<span class="token punctuation">;</span>
wire					empty<span class="token punctuation">;</span>
wire					full<span class="token punctuation">;</span>

RAM #<span class="token punctuation">(</span>
	<span class="token punctuation">.</span><span class="token function">DEPTH</span><span class="token punctuation">(</span>DEPTH<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span><span class="token function">WIDTH_D</span><span class="token punctuation">(</span>WIDTH_D<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span><span class="token function">WIDTH_A</span><span class="token punctuation">(</span>WIDTH_A<span class="token punctuation">)</span>
<span class="token punctuation">)</span>ram <span class="token punctuation">(</span>
	<span class="token punctuation">.</span>clk_r		<span class="token punctuation">(</span>r_clk<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>clk_w		<span class="token punctuation">(</span>w_clk<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rst_n		<span class="token punctuation">(</span>rst_n<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write_en	<span class="token punctuation">(</span>w_allow<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read_en	<span class="token punctuation">(</span>r_allow<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write_data	<span class="token punctuation">(</span>data_in<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write_addr	<span class="token punctuation">(</span>w_addr_to_ram<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read_addr	<span class="token punctuation">(</span>r_addr_to_ram<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read_data	<span class="token punctuation">(</span>data_out<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

wire	<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	w_gray1<span class="token punctuation">;</span>
wire	<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	w_gray2<span class="token punctuation">;</span>
wire	<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	r_gray1<span class="token punctuation">;</span>
wire	<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	r_gray2<span class="token punctuation">;</span>

read_part #<span class="token punctuation">(</span>
	<span class="token punctuation">.</span><span class="token function">WIDTH_D</span><span class="token punctuation">(</span>WIDTH_D<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span><span class="token function">WIDTH_A</span><span class="token punctuation">(</span>WIDTH_A<span class="token punctuation">)</span>
<span class="token punctuation">)</span>read <span class="token punctuation">(</span>
	<span class="token punctuation">.</span>r_clk			<span class="token punctuation">(</span>r_clk<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rst_n			<span class="token punctuation">(</span>rst_n<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>r_en			<span class="token punctuation">(</span>r_en<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>w_gray			<span class="token punctuation">(</span>w_gray2<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>empty			<span class="token punctuation">(</span>empty<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>r_addr_to_ram	<span class="token punctuation">(</span>r_addr_to_ram<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>r_gray			<span class="token punctuation">(</span>r_gray1<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>r_allow		<span class="token punctuation">(</span>r_allow<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

write_part #<span class="token punctuation">(</span>
	<span class="token punctuation">.</span><span class="token function">WIDTH_D</span><span class="token punctuation">(</span>WIDTH_D<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span><span class="token function">WIDTH_A</span><span class="token punctuation">(</span>WIDTH_A<span class="token punctuation">)</span>
<span class="token punctuation">)</span>write <span class="token punctuation">(</span>
	<span class="token punctuation">.</span>w_clk			<span class="token punctuation">(</span>w_clk<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rst_n			<span class="token punctuation">(</span>rst_n<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>w_en			<span class="token punctuation">(</span>w_en<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>r_gray			<span class="token punctuation">(</span>r_gray2<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>full			<span class="token punctuation">(</span>full<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>w_addr_to_ram	<span class="token punctuation">(</span>w_addr_to_ram<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>w_gray			<span class="token punctuation">(</span>w_gray1<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>w_allow		<span class="token punctuation">(</span>w_allow<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

syn #<span class="token punctuation">(</span>
	<span class="token punctuation">.</span><span class="token function">WIDTH_A</span><span class="token punctuation">(</span>WIDTH_A<span class="token punctuation">)</span>
<span class="token punctuation">)</span>syn_1 <span class="token punctuation">(</span>
	<span class="token punctuation">.</span>clk		<span class="token punctuation">(</span>r_clk<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rst_n		<span class="token punctuation">(</span>rst_n<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>data_in	<span class="token punctuation">(</span>w_gray1<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>syn_data	<span class="token punctuation">(</span>w_gray2<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

syn	#<span class="token punctuation">(</span>
	<span class="token punctuation">.</span><span class="token function">WIDTH_A</span><span class="token punctuation">(</span>WIDTH_A<span class="token punctuation">)</span>
<span class="token punctuation">)</span>syn_2 <span class="token punctuation">(</span>
	<span class="token punctuation">.</span>clk		<span class="token punctuation">(</span>w_clk<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rst_n		<span class="token punctuation">(</span>rst_n<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>data_in	<span class="token punctuation">(</span>r_gray1<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>syn_data	<span class="token punctuation">(</span>r_gray2<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
endmodule

module bin_to_gray#<span class="token punctuation">(</span>
	parameter WIDTH_A <span class="token operator">=</span> <span class="token number">8</span>
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
	input	<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	bin_c	<span class="token punctuation">,</span>
	output	<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	gray_c
<span class="token punctuation">)</span><span class="token punctuation">;</span>

wire h_b <span class="token operator">=</span> bin_c<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">]</span><span class="token punctuation">;</span>

reg <span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> gray_c_r<span class="token punctuation">;</span>
integer i<span class="token punctuation">;</span>
always@<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> begin
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> WIDTH_A<span class="token punctuation">;</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		gray_c_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> bin_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> bin_c<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
end

assign	gray_c <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>h_b<span class="token punctuation">,</span> gray_c_r<span class="token punctuation">}</span><span class="token punctuation">;</span>

endmodule

module read_part#<span class="token punctuation">(</span>
	parameter	WIDTH_D <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
	parameter	WIDTH_A <span class="token operator">=</span> <span class="token number">8</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>

	input					r_clk			<span class="token punctuation">,</span>
	input					rst_n			<span class="token punctuation">,</span>
	input					r_en			<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>WIDTH_A  <span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	w_gray			<span class="token punctuation">,</span>

	output					empty			<span class="token punctuation">,</span>
	output	<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	r_addr_to_ram	<span class="token punctuation">,</span>
	output	reg	<span class="token punctuation">[</span>WIDTH_A  <span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	r_gray			<span class="token punctuation">,</span>
	output	reg				r_allow			
<span class="token punctuation">)</span><span class="token punctuation">;</span>

reg <span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> r_addr_r<span class="token punctuation">;</span>
assign	r_addr_ro_ram	<span class="token operator">=</span> r_addr_r<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// to RAM</span>

always@<span class="token punctuation">(</span>posedge r_clk or negedge rst_n<span class="token punctuation">)</span> begin
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin 
		r_addr_r <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
		r_allow <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
	end
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r_en <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>empty<span class="token punctuation">)</span> begin
		r_addr_r	<span class="token operator">&lt;=</span> r_addr_r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		r_allow		<span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	end
end

assign	empty <span class="token operator">=</span> <span class="token punctuation">(</span>w_gray<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> r_gray<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

wire <span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> r_gray_w<span class="token punctuation">;</span>
<span class="token comment">// 要通过寄存器打一拍之后再输出</span>
always@<span class="token punctuation">(</span>posedge r_clk or negedge rst_n<span class="token punctuation">)</span> begin
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>
		r_gray <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		r_gray <span class="token operator">&lt;=</span> r_gray_w<span class="token punctuation">;</span>
end

bin_to_gray bin1 <span class="token punctuation">(</span>r_addr_r<span class="token punctuation">,</span> r_gray_w<span class="token punctuation">)</span><span class="token punctuation">;</span>

endmodule

module write_part#<span class="token punctuation">(</span>
	parameter	WIDTH_A <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
	parameter	WIDTH_D <span class="token operator">=</span> <span class="token number">16</span>
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
	input					w_clk		<span class="token punctuation">,</span>
	input					rst_n		<span class="token punctuation">,</span>
	input					w_en		<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>WIDTH_A  <span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	r_gray		<span class="token punctuation">,</span>

	output	<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	w_addr_to_ram<span class="token punctuation">,</span>
	output	reg	<span class="token punctuation">[</span>WIDTH_A  <span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	w_gray		<span class="token punctuation">,</span>
	output					full		<span class="token punctuation">,</span>
	output	reg				w_allow		
<span class="token punctuation">)</span><span class="token punctuation">;</span>

reg <span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> w_addr_r<span class="token punctuation">;</span>
assign	w_addr_to_ram <span class="token operator">=</span> w_addr_r<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

always@<span class="token punctuation">(</span>posedge w_clk or negedge rst_n<span class="token punctuation">)</span> begin
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
		w_addr_r <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
		w_allow  <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
	end
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>w_en <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>full<span class="token punctuation">)</span> begin
		w_addr_r <span class="token operator">&lt;=</span> w_addr_r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		w_allow  <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	end
end

assign full <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">{<!-- --></span><span class="token operator">~</span>w_gray<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">~</span>w_gray<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w_gray<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token operator">==</span> r_gray <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
wire <span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> w_gray_w<span class="token punctuation">;</span>
always@<span class="token punctuation">(</span>posedge w_clk or negedge rst_n<span class="token punctuation">)</span> begin
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> 
		w_gray <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		w_gray <span class="token operator">&lt;=</span> w_gray_w<span class="token punctuation">;</span>
end
bin_to_gray bin2 <span class="token punctuation">(</span>w_addr_r<span class="token punctuation">,</span> w_gray_w<span class="token punctuation">)</span><span class="token punctuation">;</span>

endmodule

module syn #<span class="token punctuation">(</span>
	parameter	WIDTH_A <span class="token operator">=</span> <span class="token number">8</span>
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
	input					clk		<span class="token punctuation">,</span>
	input					rst_n	<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	data_in	<span class="token punctuation">,</span>
	output	<span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	syn_data
<span class="token punctuation">)</span><span class="token punctuation">;</span>

reg <span class="token punctuation">[</span>WIDTH_A<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> reg0<span class="token punctuation">,</span> reg1<span class="token punctuation">;</span>

always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
		reg0 <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
		reg1 <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
	end
	<span class="token keyword">else</span> begin
		reg0 <span class="token operator">&lt;=</span> data_in<span class="token punctuation">;</span>
		reg1 <span class="token operator">&lt;=</span> reg0<span class="token punctuation">;</span>
	end
end

assign	syn_data <span class="token operator">=</span> reg1<span class="token punctuation">;</span>

endmodule


module RAM #<span class="token punctuation">(</span>
	parameter DEPTH <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span>
	parameter WIDTH_A <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
	parameter WIDTH_D <span class="token operator">=</span> <span class="token number">16</span>
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
	input					clk_r		<span class="token punctuation">,</span>
	input					clk_w		<span class="token punctuation">,</span>
	input					rst_n		<span class="token punctuation">,</span>
	input					write_en	<span class="token punctuation">,</span>
	input					read_en		<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>WIDTH_D<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	write_data	<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	write_addr	<span class="token punctuation">,</span>
	input	<span class="token punctuation">[</span>WIDTH_A<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	read_addr	<span class="token punctuation">,</span>
	output reg	<span class="token punctuation">[</span>WIDTH_D<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>	read_data
<span class="token punctuation">)</span><span class="token punctuation">;</span>

reg <span class="token punctuation">[</span>WIDTH_D<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> memory <span class="token punctuation">[</span>DEPTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

integer i<span class="token punctuation">;</span>
always@<span class="token punctuation">(</span>posedge clk_w or negedge rst_n<span class="token punctuation">)</span> begin<span class="token punctuation">:</span> writing
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> DEPTH<span class="token punctuation">;</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> 
			memory<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
	end
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>write_en<span class="token punctuation">)</span> 
		memory<span class="token punctuation">[</span>write_addr<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> write_data<span class="token punctuation">;</span>
end

always@<span class="token punctuation">(</span>posedge clk_r or negedge rst_n<span class="token punctuation">)</span> begin<span class="token punctuation">:</span> reading
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span> begin
		read_data <span class="token operator">&lt;=</span> 'b0<span class="token punctuation">;</span>
	end
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>read_en<span class="token punctuation">)</span> 
		read_data <span class="token operator">&lt;=</span> memory<span class="token punctuation">[</span>read_addr<span class="token punctuation">]</span><span class="token punctuation">;</span>

end

endmodule

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/26b94092794ba4cad94000d2905de430/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">html5绘制不规则图形,详解HTML5 Canvas绘制不规则图形时的非零环绕原则</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9b3fa5dec7030394d69fdb691f8414b6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">初窥鸿蒙</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>