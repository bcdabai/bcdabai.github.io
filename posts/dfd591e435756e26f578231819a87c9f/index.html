<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Python】使用C语言编写Python扩展模块，史诗级详细 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Python】使用C语言编写Python扩展模块，史诗级详细" />
<meta property="og:description" content="1.前言 python已经成为了我工作中最主要的语言，从ETL到实时计算，从web后端到机器学习，我都非常乐意使用python。但是在进行计算非常密集的任务的时候，总觉得使用python不够极致，所以时常用c语言来实现部分反复执行的片段。这样：
兼顾开发效率与运行效率，达到平衡；另外c语言得天独厚的能够访问系统底层的特性，也为python添上了控制系统的可能；实际上numpy等优秀的计算框架都是如此实现的。 Python提供了完整的解决方案，允许开发者使用c/c&#43;&#43;编写高度原生的扩展，就像内置的str和list等类型一样。本文将手把手教会如何用C语言来编写python的扩展。
预期效果 实现一个简单的User类，可以学习到使用c语言来处理python字符串和常规数据类型。
在python中使用就像如下所示：
# 我们将要定义的module，命名为mymodule import mymodule # 创建User类 user = mymodule.User(10001, &#34;猪八戒&#34;, 18, &#34;高老庄22号&#34;) # 使用User类的方法，user_info实现了整理并返回User类中的成员。 print(user.user_info()) 结果：
10001 猪八戒 18 高老庄22号 2.编辑环境配置 因为我们后面会使用python的setup文件来进行模块安装，所以此处只需要配置编辑环境（引入头文件，有代码提示就可以了）。
command &#43; shift &#43; P，在弹出的命令框中输入&gt; edit configurations json，选择C/C&#43;&#43;：编辑配置(JSON)选项。
项目的根目录的.vscode文件夹下降会出现c_cpp_properties.json文件。内容如下：
{ &#34;configurations&#34;: [ { &#34;name&#34;: &#34;Mac&#34;, &#34;includePath&#34;: [ &#34;${workspaceFolder}/**&#34;, ], &#34;defines&#34;: [], &#34;macFrameworkPath&#34;: [ &#34;/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/System/Library/Frameworks&#34; ], &#34;compilerPath&#34;: &#34;/usr/bin/clang&#34;, &#34;cStandard&#34;: &#34;c11&#34;, &#34;cppStandard&#34;: &#34;c&#43;&#43;98&#34;, &#34;intelliSenseMode&#34;: &#34;macos-clang-x64&#34; } ], &#34;version&#34;: 4 } 在includePath标签下添加python根目录的include路径。以方便调用Python内部的头文件。
我的路径是&#34;/Users/bitekong/.conda/envs/plain/include/python3.8&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dfd591e435756e26f578231819a87c9f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-27T15:56:44+08:00" />
<meta property="article:modified_time" content="2021-08-27T15:56:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Python】使用C语言编写Python扩展模块，史诗级详细</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1.前言</h2> 
<p><code>python</code>已经成为了我工作中最主要的语言，从ETL到实时计算，从web后端到机器学习，我都非常乐意使用<code>python</code>。但是在进行计算非常密集的任务的时候，总觉得使用<code>python</code>不够极致，所以时常用c语言来实现部分反复执行的片段。这样：</p> 
<ol><li>兼顾开发效率与运行效率，达到平衡；</li><li>另外<code>c语言</code>得天独厚的能够访问系统底层的特性，也为<code>python</code>添上了控制系统的可能；</li><li>实际上<code>numpy</code>等优秀的计算框架都是如此实现的。</li></ol> 
<p><code>Python</code>提供了完整的解决方案，允许开发者使用<code>c/c++</code>编写高度原生的扩展，就像内置的<code>str</code>和<code>list</code>等类型一样。本文将手把手教会如何用C语言来编写<code>python</code>的扩展。</p> 
<h3><a id="_8"></a>预期效果</h3> 
<p>实现一个简单的User类，可以学习到<strong>使用c语言来处理python字符串</strong>和<strong>常规数据类型</strong>。<br> 在python中使用就像如下所示：</p> 
<pre><code class="prism language-python"><span class="token comment"># 我们将要定义的module，命名为mymodule</span>
<span class="token keyword">import</span> mymodule

<span class="token comment"># 创建User类</span>
user <span class="token operator">=</span> mymodule<span class="token punctuation">.</span>User<span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span> <span class="token string">"猪八戒"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"高老庄22号"</span><span class="token punctuation">)</span>
<span class="token comment"># 使用User类的方法，user_info实现了整理并返回User类中的成员。</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>user_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：</p> 
<pre><code>10001 猪八戒 18 高老庄22号
</code></pre> 
<h2><a id="2_27"></a>2.编辑环境配置</h2> 
<blockquote> 
 <p>因为我们后面会使用python的setup文件来进行模块安装，所以此处只需要配置编辑环境（引入头文件，有代码提示就可以了）。</p> 
</blockquote> 
<p><code>command + shift + P</code>，在弹出的命令框中输入<code>&gt; edit configurations json</code>，选择<code>C/C++：编辑配置(JSON)</code>选项。<br> 项目的根目录的<code>.vscode</code>文件夹下降会出现<code>c_cpp_properties.json</code>文件。内容如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Mac"</span><span class="token punctuation">,</span>
            <span class="token string">"includePath"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"${workspaceFolder}/**"</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"defines"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"macFrameworkPath"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/System/Library/Frameworks"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"compilerPath"</span><span class="token operator">:</span> <span class="token string">"/usr/bin/clang"</span><span class="token punctuation">,</span>
            <span class="token string">"cStandard"</span><span class="token operator">:</span> <span class="token string">"c11"</span><span class="token punctuation">,</span>
            <span class="token string">"cppStandard"</span><span class="token operator">:</span> <span class="token string">"c++98"</span><span class="token punctuation">,</span>
            <span class="token string">"intelliSenseMode"</span><span class="token operator">:</span> <span class="token string">"macos-clang-x64"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"version"</span><span class="token operator">:</span> <span class="token number">4</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>includePath</code>标签下添加<code>python</code>根目录的<code>include</code>路径。以方便调用<code>Python</code>内部的头文件。<br> 我的路径是<code>"/Users/bitekong/.conda/envs/plain/include/python3.8"</code></p> 
<pre><code class="prism language-json"><span class="token operator">...</span>
<span class="token string">"includePath"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"${workspaceFolder}/**"</span><span class="token punctuation">,</span>
                <span class="token string">"/Users/bitekong/.conda/envs/plain/include/python3.8"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token operator">...</span>
</code></pre> 
<h2><a id="3_65"></a>3.整体结构和相关概念</h2> 
<blockquote> 
 <p>如果你习惯于先把程序运行起来，可以先跳到后面<code>实战</code>一节，再回过头来理解结构和概念。</p> 
</blockquote> 
<p>先看一下整体结构。<br> 不要被这只纸老虎吓到了，其实后面你会发现，大部分地方都是固定的，实际开发只需要在此基础上做少量修改即可。<br> 且我会对下面的每一行代码做一个详细的解释。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PY_SSIZE_T_CLEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h&gt;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    PyObject_HEAD
    <span class="token comment">/* 此处定义其他字段. */</span>
<span class="token punctuation">}</span> UserObject<span class="token punctuation">;</span>

<span class="token keyword">static</span> PyTypeObject UserType <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">PyVarObject_HEAD_INIT</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>tp_name <span class="token operator">=</span> <span class="token string">"mymodel.User"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_doc <span class="token operator">=</span> <span class="token string">"User objects"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_basicsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>UserObject<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_itemsize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_flags <span class="token operator">=</span> Py_TPFLAGS_DEFAULT<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_new <span class="token operator">=</span> PyType_GenericNew<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> PyModuleDef mymodelmodule <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    PyModuleDef_HEAD_INIT<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_name <span class="token operator">=</span> <span class="token string">"mymodel"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_doc <span class="token operator">=</span> <span class="token string">"Example module that creates an extension type."</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_size <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

PyMODINIT_FUNC
<span class="token function">PyInit_mymodel</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    PyObject <span class="token operator">*</span>m<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyType_Ready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    m <span class="token operator">=</span> <span class="token function">PyModule_Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mymodelmodule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyModule_AddObject</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"User"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们把这串代码拆分一下：</p> 
<h4><a id="1_120"></a>1.定义内部字段</h4> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    PyObject_HEAD
    <span class="token comment">/* 此处定义其他类型字段. */</span>
<span class="token punctuation">}</span> UserObject<span class="token punctuation">;</span>
</code></pre> 
<p>显而易见这是一个结构体，相当于python中定义class的字段，在初始化函数中根据这个模版分配内存并产生新的类。<br> 其中，<code>PyObject_HEAD</code>宏帮助我们定义好了这个结构体内在的层级和调试时使用到的一些额外的字段。我们可以不用管他具体是做什么的，只需要知道它赋予了这个结构体一些必要的功能就好了。<br> 在<code>/* 此处定义其他字段. */</code>处，才是我们定义自定义字段的地方，例如：</p> 
<pre><code>typedef struct {
    PyObject_HEAD
    double im_a_variable;
} PyFloatObject;
</code></pre> 
<h4><a id="2_137"></a>2.定义调用类</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> PyTypeObject UserType <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">PyVarObject_HEAD_INIT</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>tp_name <span class="token operator">=</span> <span class="token string">"mymodel.User"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_doc <span class="token operator">=</span> <span class="token string">"User objects"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_basicsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>UserObject<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_itemsize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_flags <span class="token operator">=</span> Py_TPFLAGS_DEFAULT<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_new <span class="token operator">=</span> PyType_GenericNew<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>第二段是用来定义我们所编写的c语言函数python如何调用。</p> 
<ol><li><code>PyVarObject_HEAD_INIT(NULL, 0)</code>：初始化1.中所提到的结构体，也是固定的写法，不用特别在意。</li><li><code>.tp_name = "mymodel.User",</code>：类名。</li><li><code>.tp_doc = "User objects",</code>：此处的字符串降作为模块的<code>python doc</code>出现，可在<code>python</code>中通过<code>__doc__</code>调用。</li><li><code>.tp_basicsize = sizeof(UserObject),</code>：为了告诉python需要分配多少内存。</li><li><code>.tp_itemsize = 0,</code>：如果不是长度可以变化的类，此处总是为0。</li><li><code>.tp_flags = Py_TPFLAGS_DEFAULT,</code>：定义类的类型掩码，所有的类都应该包含<code>Py_TPFLAGS_DEFAULT</code>，所以也是固定写法，不用特别在意。后面会引入一些其他类型掩码。</li><li><code>.tp_new = PyType_GenericNew,</code>：要创建对象，必须提供tp_new处理程序，相当于Python方法__new__()，但必须显式指定。在本例中，我们使用API函数<code>PyType_GenericNew()</code>提供的默认实现。</li></ol> 
<p>实际上<code>PyTypeObject</code>的参数比上述例子要多很多，但是其他参数用得不多，大家可以参考官方文档进行自定义，也都是对类如何调用做一些说明。</p> 
<h4><a id="3_160"></a>3.定义模块</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> PyModuleDef mymodelmodule <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    PyModuleDef_HEAD_INIT<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_name <span class="token operator">=</span> <span class="token string">"mymodel"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_doc <span class="token operator">=</span> <span class="token string">"Example module that creates an extension type."</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_size <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>此处定义上述c语言函数所属的模块。</p> 
<ol><li><code>PyModuleDef_HEAD_INIT</code>：初始化Python模块的宏方法，固定写法。</li><li><code>.m_size = -1,</code>：含义不明，固定<code>-1</code>。</li></ol> 
<h4><a id="4_174"></a>4.初始化函数</h4> 
<pre><code class="prism language-c">PyMODINIT_FUNC
<span class="token function">PyInit_mymodel</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    PyObject <span class="token operator">*</span>m<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyType_Ready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    m <span class="token operator">=</span> <span class="token function">PyModule_Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mymodelmodule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyModule_AddObject</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"User"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此处定义init方法，即创建模块，再将C语言所编写的类挂载到模块上。<br> <code>Py_INCREF</code>、<code>Py_DECREF</code>用来增加对相应对象的引用计数。此函数返回<code>NULL</code>将会出发<code>python</code>端抛出异常。</p> 
<p>最后，我们将上述代码编译为python的包。python有内置编译工具。<br> 新建<code>setup.py</code>文件，配置如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> distutils<span class="token punctuation">.</span>core <span class="token keyword">import</span> setup<span class="token punctuation">,</span> Extension

setup<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"mymodel"</span><span class="token punctuation">,</span>   <span class="token comment"># 命名编译、安装到python库中的文件名 mymodel-1.0-py3.8.egg-info</span>
      version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token punctuation">,</span>    <span class="token comment"># 命名编译、安装到python库中的文件名 mymodel-1.0-py3.8.egg-info</span>
      include_dirs<span class="token operator">=</span><span class="token string">"/Users/bitekong/.conda/envs/plain/include/python3.8"</span><span class="token punctuation">,</span>  <span class="token comment"># 导入python头文件</span>
      ext_modules<span class="token operator">=</span><span class="token punctuation">[</span>Extension<span class="token punctuation">(</span><span class="token string">"mymodel"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"main.c"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>   <span class="token comment"># 此处mymodel必须与PyInit_mymodel后方命名一致。</span>
      <span class="token punctuation">)</span>
</code></pre> 
<h2><a id="4python_212"></a>4.编译、生成python模块：</h2> 
<pre><code class="prism language-bash">// 仅编译，生成在build下
python setup.py build

// 编译并安装
python setup.py <span class="token function">install</span>

/Users/bitekong/.conda/envs/plain/lib/python3.8/site-packages/mymodel-1.0-py3.8.egg-info
</code></pre> 
<h2><a id="5_223"></a>5.实战</h2> 
<p>但是我们好像什么都没做。下面我们在上述结构上添加一点内容，我们编写一个<code>User</code>类。<br> 完整代码如下，可以将下面代码拷贝到<code>vscode</code>中，使用刚刚介绍的编译方法编译，再导入<code>python</code>中看看效果。</p> 
<p><code>main2.c</code>文件</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PY_SSIZE_T_CLEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"structmember.h"</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
    PyObject_HEAD <span class="token comment">// 单独一行</span>
        <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span>username<span class="token punctuation">;</span>
    <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span>address<span class="token punctuation">;</span>
<span class="token punctuation">}</span> UserObject<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">User_dealloc</span><span class="token punctuation">(</span>UserObject <span class="token operator">*</span>self<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 每一个PyObject都需要显式地减少对象的引用。</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 释放UserObject的其他字段内存。</span>
    <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">tp_free</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// new函数，负责根据传入参数初始化类。</span>
<span class="token comment">// args和kwds的含义与python中的定义一致。</span>
<span class="token keyword">static</span> PyObject <span class="token operator">*</span><span class="token function">User_new</span><span class="token punctuation">(</span>PyTypeObject <span class="token operator">*</span>type<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>args<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>kwds<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建self指针，并分配和type相符的内存。</span>
    UserObject <span class="token operator">*</span>self<span class="token punctuation">;</span>
    self <span class="token operator">=</span> <span class="token punctuation">(</span>UserObject <span class="token operator">*</span><span class="token punctuation">)</span>type<span class="token operator">-&gt;</span><span class="token function">tp_alloc</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>self <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// username初始化为空字符串</span>
        self<span class="token operator">-&gt;</span>username <span class="token operator">=</span> <span class="token function">PyUnicode_FromString</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果分配失败，则返回NULL，返回NULL是在python端抛出异常的信号。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>username <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// address初始化为空字符串</span>
        self<span class="token operator">-&gt;</span>address <span class="token operator">=</span> <span class="token function">PyUnicode_FromString</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果分配失败，则返回NULL，返回NULL是在python端抛出异常的信号。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>address <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        self<span class="token operator">-&gt;</span>age <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>self<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">User_init</span><span class="token punctuation">(</span>UserObject <span class="token operator">*</span>self<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>args<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>kwds<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 参数列表</span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>kwlist<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"address"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span>username <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>address <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyArg_ParseTupleAndKeywords</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> kwds<span class="token punctuation">,</span>
                                     <span class="token comment">// 下面这个奇怪的字符串其实就是定义参数的必输</span>
                                     <span class="token comment">// 在文末有一个简要的介绍</span>
                                     <span class="token comment">// 此处地址可以为空</span>
                                     <span class="token string">"iOi|O"</span><span class="token punctuation">,</span> kwlist<span class="token punctuation">,</span>
                                     <span class="token comment">// 以下取出顺序和kwlist定义的要一致</span>
                                     <span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>id<span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>username<span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>age<span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// tmp指向当前self.username所指向的地址，暂存</span>
        tmp <span class="token operator">=</span> self<span class="token operator">-&gt;</span>username<span class="token punctuation">;</span>
        <span class="token comment">// 分配新的变量给self.username</span>
        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token operator">-&gt;</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
        <span class="token comment">// 删除之前暂存的self.username指向地址的变量</span>
        <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>address<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        tmp <span class="token operator">=</span> self<span class="token operator">-&gt;</span>address<span class="token punctuation">;</span>
        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token operator">-&gt;</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
        <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> PyMemberDef User_members<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">,</span> T_INT<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>UserObject<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
     <span class="token string">"用户id"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token punctuation">,</span> T_OBJECT_EX<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>UserObject<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
     <span class="token string">"用户名。"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"address"</span><span class="token punctuation">,</span> T_OBJECT_EX<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>UserObject<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
     <span class="token string">"地址"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"age"</span><span class="token punctuation">,</span> T_INT<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>UserObject<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
     <span class="token string">"年龄"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token constant">NULL</span><span class="token punctuation">}</span> <span class="token comment">/* Sentinel */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> PyObject <span class="token operator">*</span><span class="token function">User_user_info</span><span class="token punctuation">(</span>UserObject <span class="token operator">*</span>self<span class="token punctuation">,</span> PyObject <span class="token operator">*</span><span class="token function">Py_UNUSED</span><span class="token punctuation">(</span>ignored<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>id <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">PyErr_SetString</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>username <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">PyErr_SetString</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>age <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">PyErr_SetString</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// if (self-&gt;address == NULL)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     PyErr_SetString(PyExc_AttributeError, "address");</span>
    <span class="token comment">//     return NULL;</span>
    <span class="token comment">// }</span>

    <span class="token comment">// 创建一个unicode字符串</span>
    <span class="token keyword">return</span> <span class="token function">PyUnicode_FromFormat</span><span class="token punctuation">(</span><span class="token string">"%d %S %d %S"</span><span class="token punctuation">,</span> self<span class="token operator">-&gt;</span>id<span class="token punctuation">,</span> self<span class="token operator">-&gt;</span>username<span class="token punctuation">,</span> self<span class="token operator">-&gt;</span>age<span class="token punctuation">,</span> self<span class="token operator">-&gt;</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> PyMethodDef User_methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"user_info"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>PyCFunction<span class="token punctuation">)</span>User_user_info<span class="token punctuation">,</span> METH_NOARGS<span class="token punctuation">,</span>
     <span class="token string">"这段文字将显示在方法的说明文档里面。"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token constant">NULL</span><span class="token punctuation">}</span> <span class="token comment">/* Sentinel */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> PyTypeObject UserType <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">PyVarObject_HEAD_INIT</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>tp_name <span class="token operator">=</span> <span class="token string">"mymodule.User"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_doc <span class="token operator">=</span> <span class="token string">"这段文字将显示在类的说明文档里面。"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_basicsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>UserObject<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_itemsize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_flags <span class="token operator">=</span> Py_TPFLAGS_DEFAULT <span class="token operator">|</span> Py_TPFLAGS_BASETYPE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_new <span class="token operator">=</span> User_new<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_init <span class="token operator">=</span> <span class="token punctuation">(</span>initproc<span class="token punctuation">)</span>User_init<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_dealloc <span class="token operator">=</span> <span class="token punctuation">(</span>destructor<span class="token punctuation">)</span>User_dealloc<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_members <span class="token operator">=</span> User_members<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tp_methods <span class="token operator">=</span> User_methods<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> PyModuleDef mymodule <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    PyModuleDef_HEAD_INIT<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_name <span class="token operator">=</span> <span class="token string">"mymodule"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_doc <span class="token operator">=</span> <span class="token string">"这段文字将显示在模块的说明文档里面。"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>m_size <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

PyMODINIT_FUNC <span class="token function">PyInit_mymodule</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    PyObject <span class="token operator">*</span>m<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyType_Ready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    m <span class="token operator">=</span> <span class="token function">PyModule_Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mymodule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyModule_AddObject</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"User"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>setup.py</code>文件</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> distutils<span class="token punctuation">.</span>core <span class="token keyword">import</span> setup<span class="token punctuation">,</span> Extension

setup<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"mymodule"</span><span class="token punctuation">,</span>   <span class="token comment"># 命名编译、安装到python库中的文件名 mymodule-1.0-py3.8.egg-info</span>
      version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token punctuation">,</span>    <span class="token comment"># 命名编译、安装到python库中的文件名 mymodule-1.0-py3.8.egg-info</span>
      include_dirs<span class="token operator">=</span><span class="token string">"/Users/bitekong/.conda/envs/plain/include/python3.8"</span><span class="token punctuation">,</span>  <span class="token comment"># 导入python头文件</span>
      ext_modules<span class="token operator">=</span><span class="token punctuation">[</span>Extension<span class="token punctuation">(</span><span class="token string">"mymodule"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"main2.c"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>   <span class="token comment"># 此处mymodel必须与PyInit_mymodel后方命名一致。</span>
      <span class="token punctuation">)</span>
</code></pre> 
<p>编译并安装</p> 
<pre><code>python setup.py install
</code></pre> 
<p>在<code>python</code>中使用：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> mymodule

user <span class="token operator">=</span> mymodule<span class="token punctuation">.</span>User<span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span> <span class="token string">"猪八戒"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"高老庄22号"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>user_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：</p> 
<pre><code>10001 猪八戒 18 高老庄22号
</code></pre> 
<h2><a id="_442"></a>补充</h2> 
<p>下面对于<code>PyArg_ParseTupleAndKeywords</code>函数的用法做一个阐述。<br> 其中<code>ss|sss</code>实际上定义了参数的传递形式，s很自然就是字符串，i是数字，f是浮点数类型。竖线前面的是必要的，竖线后面的是可选的参数。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> PyObject <span class="token operator">*</span><span class="token function">test_function</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>self<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>args<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>kwds<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>kwlist<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyArg_ParseTupleAndKeywords</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> kwds<span class="token punctuation">,</span> <span class="token string">"ss|sss"</span><span class="token punctuation">,</span> kwlist<span class="token punctuation">,</span> 
                                     <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">,</span> <span class="token operator">&amp;</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a is %s\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b is %s\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"c is %s\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d is %s\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"e is %s\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Py_RETURN_NONE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以下是python中的使用效果，当没有传递参数a和参数b时，会像通常在python中定义的一样报错。</p> 
<pre><code class="prism language-python">test_function<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment"># missing required argument 'a' (pos 1)</span>
test_function<span class="token punctuation">(</span><span class="token string">'AA'</span><span class="token punctuation">)</span> <span class="token comment"># missing required argument 'b' (pos 2)</span>
test_function<span class="token punctuation">(</span><span class="token string">'AA'</span><span class="token punctuation">,</span> <span class="token string">'BB'</span><span class="token punctuation">)</span>
test_function<span class="token punctuation">(</span><span class="token string">'AA'</span><span class="token punctuation">,</span> <span class="token string">'BB'</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'CC'</span><span class="token punctuation">,</span> d<span class="token operator">=</span><span class="token string">'DD'</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token string">'EE'</span><span class="token punctuation">)</span> 
test_function<span class="token punctuation">(</span><span class="token string">'AA'</span><span class="token punctuation">,</span> <span class="token string">'BB'</span><span class="token punctuation">,</span> <span class="token string">'CC'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'DD'</span><span class="token punctuation">)</span>
test_function<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token string">'AA'</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token string">'BB'</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'CC'</span><span class="token punctuation">,</span> d<span class="token operator">=</span><span class="token string">'DD'</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token string">'EE'</span><span class="token punctuation">)</span>
</code></pre> 
<p>抛砖引玉，才疏学浅，如有纰漏，欢迎指正。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b8f953ca80468595e4d03be06d96473c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Sentinel系列(8)-Sentinel使用 Nacos 配置规则</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/50cae5c77d167b6c6e47c5889274e88a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一文解析TOP命令</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>