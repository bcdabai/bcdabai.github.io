<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>11gr2 新特性之：Oracle Flashback Data Archive（FDA） -（total recall） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="11gr2 新特性之：Oracle Flashback Data Archive（FDA） -（total recall）" />
<meta property="og:description" content="在Oracle 11g里又出了一个新特性：Oracle FlashbackData Archive（FDA）. 在11g的官方文档里搜到了相关内容说明，参考：
Using Oracle Flashback Technology
--Using Flashback Data Archive (Oracle Total Recall)
http://download.oracle.com/docs/cd/E11882_01/appdev.112/e17125/adfns_flashback.htm#BJFIEJGG
一. Flashback Data Archive 说明
官网的定义如下：
A Flashback Data Archive provides the ability to track and store transactional changes to atable over its lifetime. A Flashback Data Archive is useful for compliance with record stage policies and audit reports.
--Flashback Data Archive 在它的有效期内将保存事务改变的信息。
A Flashback Data Archive consists of one or more tablespaces or parts thereof." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f006d00ae2df0c7ea87f30375715860f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-02-27T15:58:51+08:00" />
<meta property="article:modified_time" content="2013-02-27T15:58:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">11gr2 新特性之：Oracle Flashback Data Archive（FDA） -（total recall）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>在<a target="_self">Oracle</a> <a target="_self">11g</a>里又出了一个新特性：Oracle<a target="_self"> Flashback</a><a target="_self">Data</a> Archive（FDA<strong>）</strong>.  在11g的官方文档里搜到了相关内容说明，参考：</p> 
<p><span style="color:red">            Using Oracle Flashback Technology</span></p> 
<p><span style="color:red">            --Using Flashback Data Archive (Oracle Total Recall)</span></p> 
<p>            <a href="http://download.oracle.com/docs/cd/E11882_01/appdev.112/e17125/adfns_flashback.htm%23BJFIEJGG" rel="nofollow" style="color:rgb(202,0,0)"> <span style="color:#00ff">http://download.oracle.com/docs/cd/E11882_01/appdev.112/e17125/adfns_flashback.htm#BJFIEJGG</span></a></p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p><span style="color:red">一</span><span style="color:red">.  Flashback Data Archive </span><span style="color:red">说明</span><br> </p> 
<p><span style="color:red">官网的定义如下：</span></p> 
<p>             A Flashback Data Archive provides the ability to track and store transactional changes to a<a target="_self"><u><strong>table</strong></u></a> over its lifetime. A Flashback Data Archive is useful for compliance with record stage policies and audit reports.</p> 
<p>            <span style="color:red">--Flashback Data Archive </span><span style="color:red">在它的有效期内将保存事务改变的信息。</span></p> 
<p>            A Flashback Data Archive consists of one or more tablespaces or parts thereof. <span style="color:red">You can have multiple Flashback Data Archives.</span> <span style="color:red">If you are logged on as SYSDBA, you can specify a default Flashback Data Archive for the system.</span> A Flashback Data Archive is configured with retention time. Data archived in the Flashback Data Archive is retained for the retention time.</p> 
<p>            <span style="color:red">-- FDA </span><span style="color:red">包含一个或者多个表空间，我们可以创建多个</span><span style="color:red">FDA</span><span style="color:red">。</span><span style="color:red"> </span><span style="color:red">当以</span><span style="color:red">sysdba </span><span style="color:red">登陆时，可以指定</span><span style="color:red">default FDA</span><span style="color:red">。</span></p> 
<p>            <span style="color:red">By default, flashback archiving is off for any table.</span> You can enable flashback archiving for a table if all of these conditions are true:</p> 
<p><span style="color:red">            -- </span><span style="color:red">默认情况下，</span><span style="color:red">FDA </span><span style="color:red">是关闭的，当具备一下条件时，我们可以启用</span><span style="color:red">FDA</span><span style="color:red">。</span></p> 
<p> </p> 
<p>（1）.  You have the FLASHBACK ARCHIVE object privilege on the Flashback Data Archive to use for that table.</p> 
<p>（2）.  The table is neither nested, clustered, temporary, remote, or external.</p> 
<p>（3）.  The table contains neither LONG nor nested columns.</p> 
<p> </p> 
<p>            After flashback archiving is enabled for a table, you can disable it only if you either have the FLASHBACK ARCHIVE ADMINISTER system privilege or you are logged on as SYSDBA.</p> 
<p><span style="color:red">           --</span><span style="color:red">当</span><span style="color:red">FDA </span><span style="color:red">启动以后，只有具有</span><span style="color:red">FLASHBACK ARCHIVE ADMINISTER </span><span style="color:red">权限的用户或者用</span><span style="color:red">SYSDBA</span><span style="color:red">登陆的用户才可以禁用</span><span style="color:red">FDA</span><span style="color:red">。</span></p> 
<p> </p> 
<p>            When choosing a Flashback Data Archive for a specific table, consider the data retention requirements for the table and the retention times of the Flashback Data Archives on which you have the FLASHBACK ARCHIVE object privilege.</p> 
<p> </p> 
<p><span style="color:red">给用户赋：</span></p> 
<p>SQL&gt; create user dvd identified by dvd default tablespace users temporary tablespace temp;</p> 
<p>User created.</p> 
<p> </p> 
<p>SQL&gt; grant resource,connect to dvd;</p> 
<p>Grant succeeded.</p> 
<p> </p> 
<p>SQL&gt; <span style="color:red">grant flashback archive administer to dvd;</span></p> 
<p>Grant succeeded.</p> 
<p> </p> 
<p>SQL&gt; select * from dba_sys_privs where grantee='DVD';</p> 
<p> </p> 
<p>GRANTEE        PRIVILEGE                            ADM</p> 
<p>----------------------- ---------------------------------------- ---</p> 
<p>DVD            FLASHBACK ARCHIVE ADMINISTER       NO</p> 
<p>DVD            UNLIMITED TABLESPACE                NO</p> 
<p> </p> 
<p> </p> 
<p>            在Oracle <a target="_self">10g</a>中的lashback 包括： flashback version query、flashback transaction query、flashback database、flashback table和flashback drop等特性。</p> 
<p>            在这些闪回<a target="_self">技术</a>当中，除了Flashback Database（依赖于闪回日志）之外，其他的闪回技术都是依赖于Undo撤销数据，都与<a target="_self">数据库</a>初始化参数UNDO_RETENTION密切相关。</p> 
<p>            它们是从撤销数据中读取信息来构造旧数据的。这样就有一个限制，就是undo中的信息不能被覆盖。而undo段是循环使用的，只要事务提交，之前的undo信息就可能被覆盖，虽然可以通过 undo_retention等参数来延长undo的存活期，但这个参数会影响所有的事务，设置过大，可能导致undo tablespace快速膨胀。</p> 
<p> </p> 
<p>            Oracle 11g中flashback增加了：Flashback Data Archive 特性。该技术与之前的Flashback的实现机制不同，通过将变化数据另外存储到创建的闪回归档区（Flashback Archive）中，以和undo区别开来，这样就可以为闪回归档区单独设置存储策略，使之可以闪回到指定时间之前的旧数据而不影响undo策略。并且可以根据需要指定哪些数据库对象需要保存历史变化数据，而不是将数据库中所有对象的变化数据都保存下来，这样可以极大地减少空间需求。</p> 
<p>            Flashback Data Archive并不是记录数据库的所有变化，而只是记录了指定表的数据变化。所以，Flashback Data Archive是针对对象的保护，是Flashback Database的有力补充。</p> 
<p> </p> 
<p>            通过Flashback Data Archive，可以查询指定对象的任何时间点（只要满足保护策略）的数据，而且不需要用到undo，这在有审计需要的环境，或者是安全性特别重要的高可用数据库中，是一个非常好的特性。缺点就是如果该表变化很频繁，对空间的要求可能很高。</p> 
<p> </p> 
<p><span style="color:red">闪回数据归档区</span></p> 
<p>            闪回数据归档区是闪回数据归档的历史数据存储区域，在一个系统中，可以有一个默认的闪回数据归档区，也可以创建其他许多的闪回数据归档区域。</p> 
<p>            每一个闪回数据归档区都可以有一个唯一的名称。同时，每一个闪回数据归档区都对应了一定的数据保留策略。</p> 
<p>            例如可以配置归档区FLASHBACK_DATA_ARCHIVE_1中的数据保留期为1年，而归档区FLASHBACK_DATA_ARCHIVE_2的数据保留期为2天或者更短。 以后如果将表放到对应的闪回数据归档区，则就按照该归档区的保留策略来保存历史数据。</p> 
<p>            闪回数据归档区是一个逻辑概念，是从一个或者多个表空间中拿出一定的空间，来保存表的修改历史，这样就摆脱了对Undo撤销数据的依赖，不利用undo就可以闪回到归档策略内的任何一个时间点上。</p> 
<p> </p> 
<p><span style="color:red">Flashback archive</span><span style="color:red">相关数据字典</span></p> 
<table border="1" cellpadding="0" cellspacing="0" style="color:rgb(0,0,0)"><tbody><tr><td> <p>*_FLASHBACK_ARCHIVE</p> </td><td> <p>Displays information about Flashback Data Archive files.</p> </td></tr><tr><td> <p>*_FLASHBACK_ARCHIVE_TS</p> </td><td> <p>Displays tablespaces of Flashback Data Archive files.</p> </td></tr><tr><td> <p>*_FLASHBACK_ARCHIVE_TABLES</p> </td><td> <p>Displays information about tables that are enabled for Data Flashback Archive files.</p> </td></tr></tbody></table> 
<p> </p> 
<p>* 代表DBA 或者User。</p> 
<p> </p> 
<p><span style="color:red">Flashback archive</span><span style="color:red">的后台进程</span></p> 
<p>            Oracle11g为Flashback data archive特性专门引入了一个新的后台进程<strong>FBDA</strong>，用于将追踪表(traced table，也就是将指定使用flashback data archive的table)的历史变化数据转存到闪回归档区。</p> 
<p><br> SQL&gt; select name,description from v$bgprocess where name='FBDA';</p> 
<p>NAME  DESCRIPTION</p> 
<p>----- -----------------------------------------------------------</p> 
<p>FBDA  Flashback Data Archiver Process</p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p><span style="color:red">Flashback archive </span><span style="color:red">的限制条件</span></p> 
<p>            （1）Flashback data archive只能在ASSM的tablespace上创建<br>             （2）Flashback data archive要求必须使用自动undo<a target="_self"><strong>管理</strong></a>，</p> 
<p>                        即 undo_management 参数为auto</p> 
<p> </p> 
<p><span style="color:red">二</span><span style="color:red">.  Flashback Data Archive </span><span style="color:red">的相关操作</span></p> 
<p><span style="color:red">2.1 Creating a Flashback Data Archive</span></p> 
<p>  Create a Flashback Data Archive with the CREATE FLASHBACK ARCHIVE statement, specifying:</p> 
<p>（1）Name of the Flashback Data Archive</p> 
<p>（2）Name of the first tablespace of the Flashback Data Archive</p> 
<p>（3）(Optional) Maximum amount of space that the Flashback Data Archive can use in the first tablespace。<span style="color:red">The default is unlimited.</span> Unless your space quota on the first tablespace is also unlimited, you must specify this value; <span style="color:red">otherwise, error ORA-55621 occurs.</span></p> 
<p>（4）Retention time (number of days that Flashback Data Archive data for the table is guaranteed to be stored)</p> 
<p> </p> 
<p><span style="color:red">             --  </span><span style="color:red">创建</span><span style="color:red">FDA </span><span style="color:red">时，可以指定以上</span><span style="color:red">4</span><span style="color:red">个参数，没有没有执行</span><span style="color:red">Flashback Archive </span><span style="color:red">的配额，默认为</span><span style="color:red"> unlimited</span><span style="color:red">。</span><span style="color:red"> </span><span style="color:red">这里的配额，只的是用户对表空间的配额。</span></p> 
<p>            If you are logged on as SYSDBA, you can also specify that this is the default Flashback Data Archive for the system. If you omit this option, you can still make this Flashback Data Archive the default later .</p> 
<p>            <span style="color:red">-- </span><span style="color:red">如果以</span><span style="color:red">SYSDBA </span><span style="color:red">登陆，还可以指定</span><span style="color:red">default Flashback Data Archive</span><span style="color:red">。</span><span style="color:red"> </span><span style="color:red">如果没有指定，也可以通过</span><span style="color:red">alter flashback archive </span><span style="color:red">命令来指定。</span></p> 
<p> </p> 
<p><span style="color:red">示例：</span></p> 
<p> </p> 
<p><span style="color:red">（</span><span style="color:red">1</span><span style="color:red">）</span><span style="color:red">. </span><span style="color:red">先创建几个测试的表空间</span></p> 
<p>SQL&gt; create tablespace FDA1 datafile 'D:/APP/ADMINISTRATOR/ORADATA/NEWCCS/FDA01.dbf' size 100M;</p> 
<p>Tablespace created.</p> 
<p><br> </p> 
<p>SQL&gt; create tablespace FDA2 datafile 'D:/APP/ADMINISTRATOR/ORADATA/NEWCCS/FDA02.dbf' size 100M;</p> 
<p>Tablespace created.</p> 
<p> </p> 
<p>SQL&gt; create tablespace FDA3 datafile 'D:/APP/ADMINISTRATOR/ORADATA/NEWCCS/FDA03.dbf' size 100M;</p> 
<p>Tablespace created.</p> 
<p> </p> 
<p>SQL&gt; create tablespace FDA4 datafile 'D:/APP/ADMINISTRATOR/ORADATA/NEWCCS/FDA04.dbf' size 100M;</p> 
<p>Tablespace created.</p> 
<p> </p> 
<p><span style="color:red">（</span><span style="color:red">2</span><span style="color:red">）</span><span style="color:red">. </span><span style="color:red">创建一个默认的</span><span style="color:red">Flashback Archive, </span><span style="color:red">配额为</span><span style="color:red">10M</span><span style="color:red">，数据保留期为</span><span style="color:red">1</span><span style="color:red">年</span><br> </p> 
<p>SQL&gt; create flashback archive default fla1 tablespace fda1 quota 10M retention 1 year;</p> 
<p> </p> 
<p><span style="color:red">默认的</span><span style="color:red">Flashback Archive </span><span style="color:red">只能有一个：</span></p> 
<p>SQL&gt; create flashback archive default fla3 tablespace fda1 quota 10M retention 1 year;</p> 
<p>create flashback archive default fla3 tablespace fda1 quota 10M retention 1 year</p> 
<p>                                                 *</p> 
<p>ERROR at line 1:</p> 
<p><span style="color:red">ORA-55609: Attempt to create duplicate default Flashback Archive</span></p> 
<p> </p> 
<p>这里报错了，我们可以是使用alter flashback 来修改默认的Flashback Archive.</p> 
<p> </p> 
<p><span style="color:red">（</span><span style="color:red">3</span><span style="color:red">）</span><span style="color:red">  </span><span style="color:red">创建一个</span><span style="color:red">Flashback Archive fla2</span><span style="color:red">，使用默认配额</span><span style="color:red">unlimited</span><span style="color:red">。</span><span style="color:red"> retention </span><span style="color:red">为</span><span style="color:red">2 </span><span style="color:red">年。</span></p> 
<p> </p> 
<p>SQL&gt; create flashback archive fla2 tablespace fda2 retention 2 year;</p> 
<p>Flashback archive created.</p> 
<p> </p> 
<p><span style="color:red">根据官网的说法，这种情况下，用户对该表空间的配额也必须为</span><span style="color:red">ulimited</span><span style="color:red">。</span><span style="color:red"> </span><span style="color:red">否则就会报错</span><span style="color:red">ORA-55621</span><span style="color:red">。</span></p> 
<p><span style="color:red"> </span></p> 
<p><span style="color:red">测试如下：</span></p> 
<p> </p> 
<p>SQL&gt; conn / as sysdba;</p> 
<p>Connected.</p> 
<p> </p> 
<p>SQL&gt; revoke unlimited tablespace from dvd;</p> 
<p>Revoke succeeded.</p> 
<p> </p> 
<p>SQL&gt; alter user dvd quota 10m on fda4;</p> 
<p>User altered.</p> 
<p> </p> 
<p>SQL&gt; conn dvd/dvd;</p> 
<p>Connected.</p> 
<p> </p> 
<p>SQL&gt; create flashback archive fla5 tablespace fda4 retention 1 day;</p> 
<p>create flashback archive fla5 tablespace fda4 retention 1 day</p> 
<p>                                         *</p> 
<p><span style="color:red">ERROR at line 1:</span></p> 
<p><span style="color:red">ORA-55621: User quota on tablespace "FDA4" is not enough for Flashback Archive</span></p> 
<p> </p> 
<p><span style="color:red">报错。</span></p> 
<p> </p> 
<p><span style="color:red">修改用户的配合，在创建，成功：</span></p> 
<p> </p> 
<p>SQL&gt; conn / as sysdba;</p> 
<p>Connected.</p> 
<p> </p> 
<p>SQL&gt; grant unlimited tablespace to dvd;</p> 
<p>Grant succeeded.</p> 
<p> </p> 
<p>SQL&gt; conn dvd/dvd;</p> 
<p>Connected.</p> 
<p> </p> 
<p>SQL&gt; create flashback archive fla5 tablespace fda4 retention 1 day;</p> 
<p>Flashback archive created.</p> 
<p> </p> 
<p><span style="color:red">2.2  Altering a Flashback Data Archive</span></p> 
<p>             With the ALTER FLASHBACK ARCHIVE statement, you can:</p> 
<p><span style="color:red">             -- </span><span style="color:red">使用</span><span style="color:red">alter flashback archive </span><span style="color:red">可以修改如下内容：</span></p> 
<p>            （1）Change the retention time of a Flashback Data Archive</p> 
<p>            （2）Purge some or all of its data</p> 
<p>            （3）Add, modify, and remove tablespaces</p> 
<p> </p> 
<p><span style="color:red">Note:</span></p> 
<p>            Removing all tablespaces of a Flashback Data Archive causes an error.</p> 
<p>            If you are logged on as SYSDBA, you can also use the ALTER FLASHBACK ARCHIVE statement to make a specific file the default Flashback Data Archive for the system.</p> 
<p>            <span style="color:red">-- </span><span style="color:red">不能移除</span><span style="color:red">Flashback Data Archive</span><span style="color:red">里的所有表空间。</span><span style="color:red"> </span><span style="color:red">否则报错。</span><span style="color:red"> </span><span style="color:red">如果用</span><span style="color:red">sysdba </span><span style="color:red">登陆，可以修改默认的</span><span style="color:red">Flashback archive</span><span style="color:red">。</span></p> 
<p> </p> 
<p><span style="color:red">示例：</span></p> 
<p><span style="color:red">2.2.1  </span><span style="color:red">将</span><span style="color:red">Flashback Data Archive </span><span style="color:red">修改为</span><span style="color:red">default FA</span></p> 
<p> </p> 
<p><span style="color:red">先用我们具有</span><span style="color:red">flashback archive administer </span><span style="color:red">权限的用户试试：</span></p> 
<p>SQL&gt; conn dvd/dvd;</p> 
<p>Connected.</p> 
<p>SQL&gt; alter flashback archive fla1 set default;</p> 
<p>alter flashback archive fla1 set default</p> 
<p>*</p> 
<p>ERROR at line 1:</p> 
<p>ORA-55611: No privilege to manage default Flashback Archive</p> 
<p> </p> 
<p><span style="color:red">报错，没有权限，用</span><span style="color:red">sysdba </span><span style="color:red">测试成功：</span></p> 
<p>SQL&gt; conn / as sysdba;</p> 
<p>Connected.</p> 
<p>SQL&gt; alter flashback archive fla1 set default;</p> 
<p> </p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p>注意一点，只能有一个默认的Flashback archive.</p> 
<p> </p> 
<p>SQL&gt; select flashback_archive_name name, status  from dba_flashback_archive;</p> 
<p>NAME       STATUS</p> 
<p>---------- -------</p> 
<p><span style="color:red">FLA1       DEFAULT</span></p> 
<p>FLA2</p> 
<p> </p> 
<p><span style="color:red">当前默认的</span><span style="color:red">Flashback Archive </span><span style="color:red">是</span><span style="color:red">FLA1</span><span style="color:red">，我们将默认改成</span><span style="color:red">FLA2</span><span style="color:red">，在查看：</span></p> 
<p>SQL&gt; alter flashback archive fla2 set default;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p>SQL&gt;  select flashback_archive_name name, status  from dba_flashback_archive;</p> 
<p>NAME       STATUS</p> 
<p>---------- -------</p> 
<p>FLA1</p> 
<p><span style="color:red">FLA2       DEFAULT</span></p> 
<p> </p> 
<p><span style="color:red">2.2.2  </span><span style="color:red">为已经存在的</span><span style="color:red">Flashback Archive </span><span style="color:red">添加表空间，并指定配额</span></p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla1 add tablespace fda3 quota 20M;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p><span style="color:red">2.2.3 </span><span style="color:red">为已经存在的</span><span style="color:red">Flashback Archive </span><span style="color:red">添加表空间，不指定配额，即需要多少用多少空间</span></p> 
<p> </p> 
<p>SQL&gt;  alter flashback archive fla1 add tablespace fda4;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p><span style="color:red">2.2.4  </span><span style="color:red">修改已经存在的</span><span style="color:red">Flashback Archive</span><span style="color:red">的配额</span></p> 
<p>SQL&gt; alter flashback archive fla1 modify tablespace fda1 quota 20m;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p><span style="color:red">2.2.5  </span><span style="color:red">修改配额不受限制</span></p> 
<p>SQL&gt; alter flashback archive fla1 modify tablespace fda1;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p><span style="color:red">2.2.6 </span><span style="color:red">修改</span><span style="color:red">Flashback Archive </span><span style="color:red">的</span><span style="color:red">retention time</span></p> 
<p>SQL&gt; alter flashback archive fla1 modify retention 2 year;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla1 modify retention 1 month;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla1 modify retention 2 month;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla1 modify retention 2 day;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla1 modify retention 1 day;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p><span style="color:red">2.2.7  </span><span style="color:red">将表空间从</span><span style="color:red">Flashback Archive</span><span style="color:red">中移除</span></p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla1 remove tablespace fda4;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p><span style="color:red">-- </span><span style="color:red">注意，这里移除的仅仅是</span><span style="color:red">Flashback Archive</span><span style="color:red">中的信息，表空间不会被删除。</span></p> 
<p><span style="color:red"> </span></p> 
<p><span style="color:red">2.2.8  </span><span style="color:red">清空</span><span style="color:red">Flashback Archive</span><span style="color:red">中的所有历史记录</span></p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla1 purge all;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p><span style="color:red">2.2.9 </span><span style="color:red">清空</span><span style="color:red">Flashback Archive </span><span style="color:red">中超过</span><span style="color:red">1</span><span style="color:red">天的历史数据</span></p> 
<p>SQL&gt; alter flashback archive fla1 purge before timestamp (systimestamp - interval '1' day);</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p><span style="color:red">2.2.10  </span><span style="color:red">清空</span><span style="color:red">Flashback Archive </span><span style="color:red">中指定</span><span style="color:red">SCN </span><span style="color:red">之前的所有历史数据</span></p> 
<p>SQL&gt; select current_scn from v$database;</p> 
<p>CURRENT_SCN</p> 
<p>-----------</p> 
<p> 1315755078</p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla1 purge before scn  1315755078;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p>我这里只是演示一个SCN。 具体要结合自己的情况。</p> 
<p> </p> 
<p><span style="color:red">2.3  Dropping a Flashback Data Archive</span></p> 
<p>Drop a Flashback Data Archive with the DROP FLASHBACK ARCHIVE statement. <span style="color:red">Dropping a Flashback Data Archive deletes its historical data, but does not drop its tablespaces.</span></p> 
<p><span style="color:red">--  </span><span style="color:red">删除</span><span style="color:red">Flashback Archive </span><span style="color:red">不会删除相应的表空间</span></p> 
<p> </p> 
<p><span style="color:red">示例：</span></p> 
<p>SQL&gt; DROP FLASHBACK ARCHIVE fla2;</p> 
<p>Flashback archive dropped.</p> 
<p> </p> 
<p>SQL&gt;  select flashback_archive_name name, status  from dba_flashback_archive;</p> 
<p>NAME       STATUS</p> 
<p>---------- -------</p> 
<p>FLA1</p> 
<p> </p> 
<p><span style="color:red">2.4  Specifying the Default Flashback Data Archive</span></p> 
<p>            By default, the system has no default Flashback Data Archive. If you are logged on as SYSDBA, you can specify default Flashback Data Archive in either of these ways:</p> 
<p><span style="color:red">            </span><span style="color:red">默认情况下，没有</span><span style="color:red">default Flashback Data Archive. </span><span style="color:red">当以</span><span style="color:red">sysdba </span><span style="color:red">登陆之后，就可以指定它。</span></p> 
<p> </p> 
<p><span style="color:red">2.4.1 </span><span style="color:red">修改已经存在的</span><span style="color:red">Flashback Archive </span><span style="color:red">为</span><span style="color:red">default</span></p> 
<p>SQL&gt; alter flashback archive fla1 set default;</p> 
<p>Flashback archive altered.</p> 
<p> </p> 
<p>SQL&gt; alter flashback archive fla10 set default;</p> 
<p>alter flashback archive fla10 set default</p> 
<p>*</p> 
<p>ERROR at line 1:</p> 
<p>ORA-55605: Incorrect Flashback Archive is specified</p> 
<p> </p> 
<p><span style="color:red">如果指定的</span><span style="color:red">Flashback </span><span style="color:red">不存在，就报错。</span></p> 
<p> </p> 
<p><span style="color:red">2.4.2 </span><span style="color:red">在创建</span><span style="color:red">Flashback Data Archive </span><span style="color:red">时，指定</span><span style="color:red">default</span></p> 
<p>SQL&gt;create flashback archive default fla2 tablespace tbs1 quota 10m retention 1 year;</p> 
<p> </p> 
<p>            <span style="color:red">The default Flashback Data Archive for the system is the default Flashback Data Archive for every user who does not have his or her own default Flashback Data Archive.</span></p> 
<p> </p> 
<p> </p> 
<p><span style="color:red">2.5  Enabling and Disabling Flashback Data Archive</span></p> 
<p>            By default, flashback archiving is disabled for any table. You can enable flashback archiving for a table if you have the FLASHBACK ARCHIVE object privilege on the Flashback Data Archive to use for that table.</p> 
<p>            <span style="color:red">默认情况下，所有表都没有启动</span><span style="color:red">flashback archive</span><span style="color:red">。</span></p> 
<p> </p> 
<p>            <span style="color:red">To enable flashback archiving for a table</span>, include the FLASHBACK ARCHIVE clause in either the CREATE TABLE or ALTER TABLE statement.</p> 
<p>            In the FLASHBACK ARCHIVE clause, you can specify the Flashback Data Archive where the historical data for the table are stored.<span style="color:red"> The default is the default Flashback Data Archive for the system.</span> If you specify a nonexistent Flashback Data Archive, an error occurs.</p> 
<p> </p> 
<p>            If you enable flashback archiving for a table, but AUM(automatic undo managed) is disabled, error ORA-55614 occurs when you try to modify the table.</p> 
<p> </p> 
<p>            <span style="color:red">If a table has flashback archiving enabled, and you try to enable it again with a different Flashback Data Archive, an error occurs</span></p> 
<p> </p> 
<p>            After flashback archiving is enabled for a table, <span style="color:red">you can disable it only if you either have the FLASHBACK ARCHIVE ADMINISTER system privilege or you are logged on as SYSDBA.</span></p> 
<p><span style="color:red">            </span>To disable flashback archiving for a table, specify NO FLASHBACK ARCHIVE in the ALTER TABLE statement. (It is unnecessary to specify NO FLASHBACK ARCHIVE in the CREATE TABLE statement, because that is the default.)</p> 
<p><a name="ADFNS639" style="color:rgb(202,0,0)"></a> </p> 
<p> </p> 
<p><span style="color:red">示例：</span></p> 
<p><span style="color:red">2.5.1 </span><span style="color:red">创建</span><span style="color:red">table</span><span style="color:red">，使用默认的</span><span style="color:red">Flashback Data Archive      </span><span style="color:red">来存储历史数据</span></p> 
<p>SQL&gt; create table 安庆 (id number) <span style="color:red">flashback archive;</span></p> 
<p>Table created.</p> 
<p> </p> 
<p><span style="color:red">2.5.2 </span><span style="color:red">创建</span><span style="color:red">table</span><span style="color:red">，使用指定的</span><span style="color:red">Flashback Data Archive </span><span style="color:red">来存储历史数据</span></p> 
<p> </p> 
<p>SQL&gt; create table 怀宁 (id number) <span style="color:red">flashback archive fla1;</span></p> 
<p>Table created.</p> 
<p> </p> 
<p><span style="color:red">2.5.3 </span><span style="color:red">对表启用</span><span style="color:red">Flashback archive</span><span style="color:red">，并使用默认的</span><span style="color:red">Flashback archive</span><span style="color:red">。</span></p> 
<p> </p> 
<p>SQL&gt; alter table dave flashback archive;</p> 
<p>Table altered.</p> 
<p> </p> 
<p><span style="color:red">2.5.4 </span><span style="color:red">禁用表的</span><span style="color:red">Flashback Archive</span></p> 
<p>SQL&gt; alter table dave no flashback archive;</p> 
<p>Table altered.</p> 
<p><span style="color:red"> </span></p> 
<p><span style="color:red">2.5.5 </span><span style="color:red">对</span><span style="color:red">table </span><span style="color:red">启用</span><span style="color:red">Flashback archive</span><span style="color:red">，并指定</span><span style="color:red">Flashaback Archive </span><span style="color:red">区。</span></p> 
<p>SQL&gt; alter table dave flashback <span style="color:red">archive fla1;</span></p> 
<p>Table altered.</p> 
<p> </p> 
<p> </p> 
<p><span style="color:red">2.6 DDL Statements on Tables Enabled for Flashback Data Archive</span></p> 
<p>            Flashback Data Archive supports many DDL statements, including some that alter the table definition or move data. For example:</p> 
<p><span style="color:red">            --</span><span style="color:red">启动</span><span style="color:red">Flashback Data Archive</span><span style="color:red">的表支持以下的</span><span style="color:red">DDL </span><span style="color:red">操作</span></p> 
<p>            （1）ALTER TABLE statement that does any of the following:</p> 
<p>                                    1）Adds, drops, renames, or modifies a column</p> 
<p>                                    2）Adds, drops, or renames a constraint</p> 
<p>                                    3）Drops or truncates a partition or subpartition operation</p> 
<p>            （2）TRUNCATE TABLE statement</p> 
<p>            （3）RENAME statement that renames a table</p> 
<p> </p> 
<p>            Some DDL statements cause error ORA-55610 when used on a table enabled for Flashback Data Archive. For example:</p> 
<p><span style="color:red">            -- </span><span style="color:red">启动</span><span style="color:red">Flashback Data Archive</span><span style="color:red">的表上的一些</span><span style="color:red">DDL </span><span style="color:red">操作可能触发</span><span style="color:red">ORA-55610</span><span style="color:red">的错误，这些</span><span style="color:red">DDL </span><span style="color:red">如下：</span></p> 
<p>            （1）ALTER TABLE statement that includes an UPGRADE TABLE clause, with or without an INCLUDING DATA clause</p> 
<p>            （3）ALTER TABLE statement that moves or exchanges a partition or subpartition operation</p> 
<p>            （3）DROP TABLE statement</p> 
<p> </p> 
<p> </p> 
<p>            <span style="color:red">If you must use unsupported DDL statements on a table enabled for Flashback Data Archive</span>, use the DBMS_FLASHBACK_ARCHIVE.DISASSOCIATE_FBA procedure to disassociate the base table from its Flashback Data Archive.</p> 
<p>            To reassociate the Flashback Data Archive with the base table afterward, use the DBMS_FLASHBACK_ARCHIVE.REASSOCIATE_FBA procedure.</p> 
<p> </p> 
<p>            <span style="color:red">-- </span><span style="color:red">如果必须在已经启用</span><span style="color:red">Flashback Archive</span><span style="color:red">的表上执行这些不支持的</span><span style="color:red">DDL </span><span style="color:red">操作，可以用</span><span style="color:red">DBMS_FLASHBACK_ARCHIVE </span><span style="color:red">包将表从</span><span style="color:red">Flashback Data Archive </span><span style="color:red">分离出来，待操作结束后在添加进去。</span></p> 
<p><span style="color:red"> </span></p> 
<p>            The DBMS_FLASHBACK_ARCHIVE package contains two simple procedures for <span style="color:red">disassociation and reassociation of a Flashback Data Archive (FDA) enabled table from/with its underlying FDA respectively.</span></p> 
<p><span style="color:red"> </span></p> 
<p><span style="color:red">            </span><span style="color:red">在</span><span style="color:red">Flashback Area</span><span style="color:red">中，会有一张历史表记录着我们启动</span><span style="color:red">FA</span><span style="color:red">表的所有操作。</span><span style="color:red"> </span><span style="color:red">我们可以通过如下</span><span style="color:red">SQL </span><span style="color:red">来查看他们之间的映射关系。</span></p> 
<p> </p> 
<p>SQL&gt; SELECT table_name,archive_table_name,status from dba_flashback_archive_tables;</p> 
<p> </p> 
<p>TABLE_NAME ARCHIVE_TABLE_NAME   STATUS</p> 
<p>---------- -------------------- --------</p> 
<p>ANQING     SYS_FBA_HIST_78429   ENABLED</p> 
<p>怀宁       SYS_FBA_HIST_78431   ENABLED</p> 
<p>ORA        SYS_FBA_HIST_78448   ENABLED</p> 
<p>DVD        SYS_FBA_HIST_78456   ENABLED</p> 
<p>HUAINING   SYS_FBA_HIST_78464   ENABLED</p> 
<p>QS         SYS_FBA_HIST_78472   ENABLED</p> 
<p>FA         SYS_FBA_HIST_78484   ENABLED</p> 
<p> </p> 
<p>7 rows selected.</p> 
<p> </p> 
<p>            我们要执行那些不支持的DDL，就需要用dbms_flashback_archive禁用他们之间的映射关系，在操作，操作完在用该包启用他们。</p> 
<p> </p> 
<p>关于dbms_flashback_archive包的使用，参考官网：</p> 
<p><span style="color:red">          DBMS_FLASHBACK_ARCHIVE</span></p> 
<p>            <a href="http://download.oracle.com/docs/cd/E11882_01/appdev.112/e16760/d_flashb_archive.htm%23ARPLS72464" rel="nofollow" style="color:rgb(202,0,0)"><span style="color:#00ff">http://download.oracle.com/docs/cd/E11882_01/appdev.112/e16760/d_flashb_archive.htm#ARPLS72464</span></a></p> 
<p> </p> 
<p><span style="color:red">示例：</span></p> 
<p> </p> 
<p>SQL&gt; drop table 怀宁;</p> 
<p>drop table 怀宁</p> 
<p>           *</p> 
<p>ERROR at line 1:</p> 
<p>ORA-55610: Invalid DDL statement on history-tracked table</p> 
<p> </p> 
<p>这个表使我们之前创建的，并启用了Flashback Archive.</p> 
<p> </p> 
<p><span style="color:red">表的分离和重新结合：</span><br> </p> 
<p>SQL&gt;exec dbms_flashback_archive.disassociate_fba('SYS','怀宁');<br> </p> 
<p>PL/SQL procedure successfully completed.</p> 
<p> </p> 
<p>SQL&gt; exec dbms_flashback_archive.reassociate_fba('SYS','怀宁');</p> 
<p>PL/SQL procedure successfully completed.</p> 
<p> </p> 
<p><span style="color:red">最后我们在分离，在</span><span style="color:red">drop table</span><span style="color:red">：</span></p> 
<p>SQL&gt; exec dbms_flashback_archive.disassociate_fba('SYS','怀宁');</p> 
<p>PL/SQL procedure successfully completed.</p> 
<p> </p> 
<p>SQL&gt; drop table 怀宁;</p> 
<p>drop table 怀宁</p> 
<p>           *</p> 
<p>ERROR at line 1:</p> 
<p>ORA-55610: Invalid DDL statement on history-tracked table</p> 
<p> </p> 
<p><span style="color:red">drop </span><span style="color:red">失败。</span></p> 
<p> </p> 
<p><span style="color:red">表情：</span> - -</p> 
<p><span style="color:red">猜测：</span>灵异事件。---认为是bug<br> </p> 
<p> </p> 
<p>google 一下，说是bug：9650074</p> 
<p> </p> 
<p>9650074 ORA-55633 in Flashback data archive DDL support area</p> 
<p>（此处会补充）<br> </p> 
<p> </p> 
<p> </p> 
<p><span style="color:red">三</span><span style="color:red">.  </span><span style="color:red">一个用</span><span style="color:red">Flashback Data Archive </span><span style="color:red"><a target="_self"><u><strong>恢复</strong></u></a>数据的测试</span></p> 
<p> </p> 
<p>这个测试使用之前的Flashback Archive: fla1.</p> 
<p> </p> 
<p><span style="color:red">创建测试表：</span></p> 
<p>SQL&gt; create table fa(id number) flashback archive;</p> 
<p>Table created.</p> 
<p> </p> 
<p><span style="color:red">插入数据：</span></p> 
<p>SQL&gt; declare</p> 
<p>  2  i number;</p> 
<p>  3  begin</p> 
<p>  4  for i in 1..100 loop</p> 
<p>  5  insert into fa values(i);</p> 
<p>  6  end loop;</p> 
<p>  7  commit;</p> 
<p>  8  end;</p> 
<p>  9  /</p> 
<p>PL/SQL procedure successfully completed.</p> 
<p> </p> 
<p>SQL&gt; select count(*) from fa;</p> 
<p>  COUNT(*)</p> 
<p>----------</p> 
<p>  100</p> 
<p> </p> 
<p><span style="color:red">查询时间：</span></p> 
<p>SQL&gt; select to_char(sysdate,'yyyy-mm-dd hh24:mi:ss') tm from dual;</p> 
<p>TM</p> 
<p>-------------------</p> 
<p>2011-05-11 15:33:35</p> 
<p> </p> 
<p><span style="color:red">在</span><span style="color:red">update </span><span style="color:red">一次数据：</span></p> 
<p>SQL&gt; update fa set id=200 where id &lt;50;</p> 
<p>49 rows updated.</p> 
<p>SQL&gt;commit;</p> 
<p> </p> 
<p><span style="color:red">在查询一次时间：</span></p> 
<p>SQL&gt; select to_char(sysdate,'yyyy-mm-dd hh24:mi:ss') tm from dual;</p> 
<p> </p> 
<p>TM</p> 
<p>-------------------</p> 
<p>2011-05-11 15:35:23</p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p><span style="color:red">使用</span><span style="color:red">Flashback Archive</span><span style="color:red">查询</span><span style="color:red">1</span><span style="color:red">分钟之前的数据：</span></p> 
<p>SQL&gt; select count(*) from fa as of timestamp (systimestamp - interval '1'minute);</p> 
<p> </p> 
<p>  COUNT(*)</p> 
<p>----------</p> 
<p>       100</p> 
<p> </p> 
<p><span style="color:red">使用</span><span style="color:red">Flashback Archive</span><span style="color:red">查询</span><span style="color:red">10</span><span style="color:red">分钟之前的数据：</span></p> 
<p>SQL&gt; select count(*) from fa as of timestamp (systimestamp - interval '10'minute);</p> 
<p> </p> 
<p>  COUNT(*)</p> 
<p>----------</p> 
<p>     0</p> 
<p> </p> 
<p>这里显示为0. 因为我们还没有做DML 操作。</p> 
<p> </p> 
<p><span style="color:red">或者使用时间来查：</span></p> 
<p>SQL&gt; select count(*) from fa as of timestamp to_timestamp('2011-05-11 15:35:23','yyyy-mm-dd hh24:mi:ss');</p> 
<p>  COUNT(*)</p> 
<p>----------</p> 
<p> 100</p> 
<p> </p> 
<p>SQL&gt; delete from fa;</p> 
<p>100 rows deleted</p> 
<p>SQL&gt; commit;</p> 
<p>Commit complete.</p> 
<p> </p> 
<p> </p> 
<p>SQL&gt;  select count(*) from fa as of timestamp (systimestamp - interval '1'minute);</p> 
<p> </p> 
<p>  COUNT(*)</p> 
<p>----------</p> 
<p>       100</p> 
<p> </p> 
<p><span style="color:red">根据时间的不同，查询的结果也不一样。</span><span style="color:red"> </span><span style="color:red">下面我们来确认下这个问题：</span></p> 
<p> </p> 
<p>SQL&gt; <span style="color:red">SELECT * from dba_flashback_archive_tables;</span></p> 
<p> </p> 
<p></p> TABLE_NAME OWNER_NAME FLASHBACK_ARCHI ARCHIVE_TABLE_NAME   STATUS 
<br> ---------- ---------- --------------- -------------------- -------- 
<br> FA         SYS        FLA1            SYS_FBA_HIST_78484   ENABLED 
<p></p> 
<p> </p> 
<p>从这个结果，可以看出，在Flashback archive对应的FA表的历史表是<span style="color:red">SYS_FBA_HIST_78484</span><span style="color:red">。</span></p> 
<p><span style="color:red"> </span></p> 
<p><span style="color:red">该表保存了</span><span style="color:red">FA</span><span style="color:red">表的所有的操作记录：</span></p> 
<p>SQL&gt; select count(*) from SYS_FBA_HIST_78484;</p> 
<p>  COUNT(*)</p> 
<p>----------</p> 
<p>    149</p> 
<p> </p> 
<p>SQL&gt; desc SYS_FBA_HIST_78484</p> 
<p> Name                                      Null?    Type</p> 
<p> ----------------------------------------- -------- ---------------</p> 
<p> RID                                                VARCHAR2(4000)</p> 
<p> STARTSCN                                     NUMBER</p> 
<p> ENDSCN                                        NUMBER</p> 
<p> XID                                                RAW(8)</p> 
<p> OPERATION                                  VARCHAR2(1)</p> 
<p> ID                                                 NUMBER</p> 
<p> </p> 
<p><span style="color:red">注意一点：我们不能对这些历史表做任何修改操作，只能查询。</span></p> 
<p> </p> 
<p>            如果想对这些历史表进行相关的修改操作，和之前的操作一样：使用dbms_flashback_archive分离2个表之间的关系。</p> 
<p> </p> 
<p>如：</p> 
<p>sql&gt;exec dbms_flashback_archive.disassociate_fba('scott','emp_test');</p> 
<p>sql&gt; exec dbms_flashback_archive.reassociate_fba('scott','emp_test');</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a2f8061ed53c4f6a405fd2b62f22105f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">搭建OpenWrt开发环境（包括编译过程）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d4ca1a84ec26007ceaf225403aea9393/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">centos普通用户登录提示鉴定故障</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>