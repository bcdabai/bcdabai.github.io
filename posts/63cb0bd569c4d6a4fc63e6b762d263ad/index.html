<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>oracledb_exporter踩坑记录 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="oracledb_exporter踩坑记录" />
<meta property="og:description" content="需求：
希望能通过oracledb_exporter采集到必要信息（表空间信息，交易统计数据等），并发送短信给开发人员。
踩坑总结：
1、值必须为数值类型！使用sum（xxx）等函数时，可能出现NULL的结果，必须使用nvl函数！
nvl(sum(xxxx),0) 2、metricsdesc展示列必须小写！且不允许有下划线！
labels = [“NAME”,&#34;TOTALBYTE&#34;,&#34;USED_BYTE&#34;]
metricsdesc ={TOTALBYTE=&#34;总空间&#34;, USED_BYTE=&#34;已用空间&#34;}
改为：
labels = [“name”,&#34;totalbyte&#34;,&#34;usedbyte&#34;]
metricsdesc ={totalbyte=&#34;总空间&#34;, usedbyte=&#34;已用空间&#34;}
踩坑记录：
1.统计交易信息
统计前一天的交易数量，交易总金额等信息
[[metric]]
context = &#34;testtrans&#34;
labels= [&#34;transdate&#34;,&#34;count&#34;,&#34;sumamt&#34;] -- 需要关注的列信息
metricsdess={ count=&#34;总笔数&#34;, sumamt = &#34;总金额&#34; } -- 必须为数值类型
request =&#34;
select to_char(sysdate-1,&#39;yyyyMMdd&#39;) as transdate ,
count(1) as count,
sum(t.amt) as sumamt
from t_test_table t where 1=1 and t.transdate = to_char(sysdate-1,&#39;yyyyMMdd&#39;)
&#34;
以上为oracledb_exporter 中 default-metrics.toml 追加的自定义查询，重启之后发现，sumamt一直没有数据，一开始测试的时候由于未造数据，所以sum(t.amt) 数据为 NULL ，造数据之后发现sql执行是有数据的，但是Prometheus页面（ip:端口/metrics）上还是 sumamt=&#34;&#34; 无数据。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/63cb0bd569c4d6a4fc63e6b762d263ad/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-25T09:13:33+08:00" />
<meta property="article:modified_time" content="2023-04-25T09:13:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">oracledb_exporter踩坑记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>需求：</p> 
<p>        希望能通过oracledb_exporter采集到必要信息（表空间信息，交易统计数据等），并发送短信给开发人员。</p> 
<p></p> 
<p>踩坑总结：</p> 
<p>1、值必须为数值类型！使用sum（xxx）等函数时，可能出现NULL的结果，必须使用nvl函数！</p> 
<blockquote> 
 <p>nvl(sum(xxxx),0) </p> 
</blockquote> 
<p>2、metricsdesc展示列必须小写！且不允许有下划线！</p> 
<blockquote> 
 <p>labels = [“NAME”,"<span style="color:#fe2c24;">TOTALBYTE</span>","<span style="color:#ff9900;">USED_BYTE</span><span style="color:#0d0016;">"]</span></p> 
 <p>metricsdesc ={<!-- --><span style="color:#fe2c24;">TOTALBYTE</span>="总空间", <span style="color:#ff9900;">USED_BYTE</span>="已用空间"}</p> 
 <p></p> 
 <p>改为：</p> 
 <p>labels = [“name”,"<span style="color:#fe2c24;">totalbyte</span>","<span style="color:#ff9900;">usedbyte</span><span style="color:#0d0016;">"]</span></p> 
 <p>metricsdesc ={<!-- --><span style="color:#fe2c24;">totalbyte</span>="总空间", <span style="color:#ff9900;">usedbyte</span>="已用空间"}</p> 
</blockquote> 
<p></p> 
<p></p> 
<p>踩坑记录：</p> 
<p>1.统计交易信息</p> 
<p>统计前一天的交易数量，交易总金额等信息</p> 
<blockquote> 
 <p>[[metric]]</p> 
 <p>context = "testtrans"</p> 
 <p>labels= ["transdate","count","sumamt"]                               <span style="color:#fe2c24;">-- 需要关注的列信息</span></p> 
 <p>metricsdess={ count="总笔数", sumamt = "总金额" }        <span style="color:#fe2c24;">-- 必须为数值类型</span></p> 
 <p>request ="</p> 
 <p>select to_char(sysdate-1,'yyyyMMdd') as transdate  ,</p> 
 <p>count(1) as count,</p> 
 <p>sum(t.amt) as sumamt</p> 
 <p>from t_test_table t  where  1=1 and t.transdate = to_char(sysdate-1,'yyyyMMdd')</p> 
 <p>"</p> 
</blockquote> 
<p>        以上为oracledb_exporter 中 default-metrics.toml 追加的自定义查询，重启之后发现，sumamt一直没有数据，一开始测试的时候由于未造数据，所以sum(t.amt) 数据为 NULL ，造数据之后发现sql执行是有数据的，但是Prometheus页面（ip:端口/metrics）上还是 sumamt="" 无数据。</p> 
<p>        尝试了很多次都是无数据，最后将<span style="color:#fe2c24;">sumamt</span> 改名为 <span style="color:#fe2c24;">totamt </span>后查出数据。</p> 
<p>        最后排查的结果是由于一开始未造数据时sum(t.amt) 结果为 NULL ，导致prometheus 将该值存为<span style="color:#fe2c24;"><strong> NaN</strong></span>，所以之后造数据也无法擦除sumamt 的值，float 类型无法写入当前 <span style="color:#fe2c24;"><strong>NaN</strong></span> 的值内。</p> 
<p>启动时的错误日志：</p> 
<blockquote> 
 <p>"Unable to convert current value to float (metric= sumamt,metricHelp=总金额,value=&lt;&gt;)"  source = "main.go:318"</p> 
</blockquote> 
<p>建议修改为：</p> 
<blockquote> 
 <p>[[metric]]</p> 
 <p>context = "testtrans"</p> 
 <p>labels= ["transdate","count","sumamt"]</p> 
 <p>metricsdess={ count="总笔数", sumamt = "总金额" }</p> 
 <p>request ="</p> 
 <p>select to_char(sysdate-1,'yyyyMMdd') as transdate  ,</p> 
 <p>count(1) as count,</p> 
 <p><span style="color:#fe2c24;">nvl(sum(t.amt),0) as sumamt                -- 使用nvl()函数，当值为NULL时赋值为0</span></p> 
 <p>from t_test_table t  where  1=1 and t.transdate = to_char(sysdate-1,'yyyyMMdd')</p> 
 <p>"</p> 
</blockquote> 
<p>若值无法擦除，建议改名后重启oracledb_exporter。</p> 
<p>2、查询表空间信息</p> 
<p>统计表空间信息，表空间初始内存，表空间已用内存，表空间剩余内存，表空间使用率等信息</p> 
<blockquote> 
 <p>[[metric]]</p> 
 <p>context = "testspace"</p> 
 <p>labels= [<span style="color:#fe2c24;">"TB_NAME","TB_TOTAL","TB_USED","TB_RATE"</span>]</p> 
 <p>metricsdess={ <span style="color:#fe2c24;">TB_TOTAL="默认内存",  TB_USED= "已使用空间" ,TB_RATE=”使用率“</span>}</p> 
 <p>request ="</p> 
 <p>select a.tablespace_name as TB_NAME,</p> 
 <p>nvl(round(a.total_size),0) as TB_TOTAL,</p> 
 <p>nvl(round(a.total_size)-round(b.free_size), 0) as TB_USED,</p> 
 <p>nvl((round(a.total_size-b.free_size)/total_size*100),2),0) TB_RATE</p> 
 <p>from (select tablespace_name, sum(bytes)/1024/1024/1024 as total_size from sys.dba_data_files where AUTOEXTENSIBLE='NO' group by tablespace_name ) a,</p> 
 <p>        (select tablespace_name, sum(bytes)/1024/1024/1024 as free_size from sys.dba_free_space group by tablespace_name) b</p> 
 <p>where a.tablespace_name = b.tablespace_name(+) </p> 
 <p>"</p> 
 <p></p> 
</blockquote> 
<p>错误日志：</p> 
<blockquote> 
 <p>"Unable to convert current value to float (metric= TB_TOTAL,metricHelp=默认内存,value=&lt;&gt;)"  source = "main.go:318"</p> 
 <p>"Error scraping for testspace _map[TB_TOTAL:默认内存]:No metrics found while parsing"  source = "main.do:266"</p> 
</blockquote> 
<p> 错误原因：</p> 
<p>改为小写并去掉下划线后，该sql可以执行</p> 
<blockquote> 
 <p>[[metric]]</p> 
 <p>context = "testspace"</p> 
 <p>labels= [<span style="color:#0d0016;">"name",</span><span style="color:#fe2c24;">"max","used","free","rate"</span>]</p> 
 <p>metricsdess={ <span style="color:#fe2c24;">max="默认内存", used= "已使用空间" ,free="剩余可用空间",rate=”使用率“</span>}</p> 
 <p>request ="</p> 
 <p>select a.tablespace_name as name,</p> 
 <p>nvl(round(a.total_size),0) as max,</p> 
 <p>nvl(round(a.total_size)-round(b.free_size), 0) as used,</p> 
 <p>nvl(round(b.free_size),0) as free,</p> 
 <p>nvl((round(a.total_size-b.free_size)/total_size*100),2),0) rate</p> 
 <p>from (select tablespace_name, sum(bytes)/1024/1024/1024 as total_size from sys.dba_data_files where AUTOEXTENSIBLE='NO' group by tablespace_name ) a,</p> 
 <p>        (select tablespace_name, sum(bytes)/1024/1024/1024 as free_size from sys.dba_free_space group by tablespace_name) b</p> 
 <p>where a.tablespace_name = b.tablespace_name(+) </p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3980a52891bb7ffad850c0bd61ecfe1a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[计算机图形学]蒙特卡洛积分与路径追踪(前瞻预习/复习回顾)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/161f7c6f0da2a01b2b7fcb41ae49e456/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">医学图像数据集</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>