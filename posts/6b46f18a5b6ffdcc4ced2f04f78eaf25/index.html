<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Prometheus&#43;Grafana监控K8S集群(基于K8S环境部署) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Prometheus&#43;Grafana监控K8S集群(基于K8S环境部署)" />
<meta property="og:description" content="文章目录 一、环境信息二、部署前准备工作三、部署Prometheus监控系统四、部署Node_exporter组件五、部署Kube_state_metrics组件六、部署Grafana可视化平台七、Grafana接入Prometheus数据八、Grafana添加监控模板九、拓展 一、环境信息 1、服务器及K8S版本信息：
IP地址主机名称角色K8S版本16.32.15.200master-1Master节点v1.23.016.32.15.201node-1Node节点v1.23.016.32.15.202node-2Node节点v1.23.0 2、部署组件版本：
序号名称版本作用1Prometheusv2.33.5收集、存储和处理指标数据2Node_exporterv0.16.0采集服务器指标，如CPU、内存、磁盘、网络等3Kube-state-metricsv1.9.0采集K8S资源指标，如Pod、Node、Deployment、Service等4Grafanav8.4.5可视化展示Prometheus收集数据 3、离线包下载：
包括本实验的离线镜像包、导入Grafana所需的模板文件。
点击下载：
二、部署前准备工作 1、创建名称空间，下面所有资源都放到这里
kubectl create ns prometheus 2、创建ServiceAccount账号，并绑定cluster-admin集群角色(Prometheus中需要指定)
kubectl create serviceaccount prometheus -n prometheus kubectl create clusterrolebinding prometheus-clusterrolebinding -n prometheus --clusterrole=cluster-admin --serviceaccount=prometheus:prometheus kubectl create clusterrolebinding prometheus-clusterrolebinding-1 -n prometheus --clusterrole=cluster-admin --user=system:serviceaccount:prometheus:prometheus 3、创建Prometheus存放数据目录
注意：我准备将Prometheus服务部署在Node-1节点，所以此步骤在Node-1节点执行
mkdir /data chmod -R 777 /data 4、创建Grafana存放数据目录
我准备将Grafana服务部署在Node-1节点，所以此步骤也在Node-1节点执行
mkdir /var/lib/grafana/ -p chmod 777 /var/lib/grafana/ 5、时间同步 &amp;&amp; 时区同步
# 时间同步 yum -y install ntpdate /usr/sbin/ntpdate -u ntp1.aliyun.com # 时区同步 timedatectl set-timezone Asia/Shanghai 定时同步：每天凌晨5点进行时间同步" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6b46f18a5b6ffdcc4ced2f04f78eaf25/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-03T18:50:07+08:00" />
<meta property="article:modified_time" content="2023-10-03T18:50:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Prometheus&#43;Grafana监控K8S集群(基于K8S环境部署)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">一、环境信息</a></li><li><a href="#_24" rel="nofollow">二、部署前准备工作</a></li><li><a href="#Prometheus_69" rel="nofollow">三、部署Prometheus监控系统</a></li><li><a href="#Node_exporter_288" rel="nofollow">四、部署Node_exporter组件</a></li><li><a href="#Kube_state_metrics_385" rel="nofollow">五、部署Kube_state_metrics组件</a></li><li><a href="#Grafana_479" rel="nofollow">六、部署Grafana可视化平台</a></li><li><a href="#GrafanaPrometheus_589" rel="nofollow">七、Grafana接入Prometheus数据</a></li><li><a href="#Grafana_600" rel="nofollow">八、Grafana添加监控模板</a></li><li><a href="#_645" rel="nofollow">九、拓展</a></li></ul> 
 </li></ul> 
</div> 
<br> 
<img src="https://images2.imgbox.com/b6/b0/Fl4wJRZv_o.png" alt="在这里插入图片描述"> 
<p></p> 
<h3><a id="_2"></a>一、环境信息</h3> 
<p>1、服务器及K8S版本信息：</p> 
<table><thead><tr><th>IP地址</th><th>主机名称</th><th>角色</th><th>K8S版本</th></tr></thead><tbody><tr><td>16.32.15.200</td><td>master-1</td><td>Master节点</td><td>v1.23.0</td></tr><tr><td>16.32.15.201</td><td>node-1</td><td>Node节点</td><td>v1.23.0</td></tr><tr><td>16.32.15.202</td><td>node-2</td><td>Node节点</td><td>v1.23.0</td></tr></tbody></table> 
<p>2、部署组件版本：</p> 
<table><thead><tr><th>序号</th><th>名称</th><th>版本</th><th>作用</th></tr></thead><tbody><tr><td>1</td><td>Prometheus</td><td>v2.33.5</td><td>收集、存储和处理指标数据</td></tr><tr><td>2</td><td>Node_exporter</td><td>v0.16.0</td><td>采集服务器指标，如CPU、内存、磁盘、网络等</td></tr><tr><td>3</td><td>Kube-state-metrics</td><td>v1.9.0</td><td>采集K8S资源指标，如Pod、Node、Deployment、Service等</td></tr><tr><td>4</td><td>Grafana</td><td>v8.4.5</td><td>可视化展示Prometheus收集数据</td></tr></tbody></table> 
<p>3、离线包下载：</p> 
<p>包括本实验的离线镜像包、导入Grafana所需的模板文件。</p> 
<p><a href="https://pan.baidu.com/s/13ZBhS_26-tqwWPwJgkon0g?pwd=6666" rel="nofollow">点击下载：</a></p> 
<h3><a id="_24"></a>二、部署前准备工作</h3> 
<p>1、创建名称空间，下面所有资源都放到这里</p> 
<pre><code class="prism language-bash">kubectl create ns prometheus
</code></pre> 
<p>2、创建ServiceAccount账号，并绑定cluster-admin集群角色(Prometheus中需要指定)</p> 
<pre><code class="prism language-bash">kubectl create serviceaccount prometheus <span class="token parameter variable">-n</span> prometheus

kubectl create clusterrolebinding prometheus-clusterrolebinding <span class="token parameter variable">-n</span> prometheus <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin  <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>prometheus:prometheus

kubectl create clusterrolebinding prometheus-clusterrolebinding-1 <span class="token parameter variable">-n</span> prometheus <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--user</span><span class="token operator">=</span>system:serviceaccount:prometheus:prometheus
</code></pre> 
<p>3、创建Prometheus存放数据目录<br> 注意：我准备将<code>Prometheus</code>服务部署在<code>Node-1</code>节点，所以此步骤在<code>Node-1</code>节点执行</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /data
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> /data
</code></pre> 
<p>4、创建Grafana存放数据目录<br> 我准备将<code>Grafana</code>服务部署在<code>Node-1</code>节点，所以此步骤也在<code>Node-1</code>节点执行</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /var/lib/grafana/ <span class="token parameter variable">-p</span>
<span class="token function">chmod</span> <span class="token number">777</span> /var/lib/grafana/
</code></pre> 
<p>5、时间同步 &amp;&amp; 时区同步</p> 
<pre><code class="prism language-bash"><span class="token comment"># 时间同步</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ntpdate
/usr/sbin/ntpdate <span class="token parameter variable">-u</span> ntp1.aliyun.com

<span class="token comment"># 时区同步</span>
timedatectl set-timezone Asia/Shanghai
</code></pre> 
<p>定时同步：每天凌晨5点进行时间同步</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"0 5 * * * /usr/sbin/ntpdate -u ntp1.aliyun.com &gt;/dev/null &amp;"</span> <span class="token operator">&gt;&gt;</span> /var/spool/cron/root
</code></pre> 
<p>6、提前下载所需镜像</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull prom/prometheus:v2.33.5
<span class="token function">docker</span> pull prom/node-exporter:v0.16.0
<span class="token function">docker</span> pull quay.io/coreos/kube-state-metrics:v1.9.0
<span class="token function">docker</span> pull grafana/grafana:8.4.5
</code></pre> 
<h3><a id="Prometheus_69"></a>三、部署Prometheus监控系统</h3> 
<p>1、创建 ConfigMap资源</p> 
<pre><code class="prism language-yaml">vim prometheus<span class="token punctuation">-</span>cfg.yaml
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">prometheus.yml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    global:
      scrape_interval: 15s           # 采集目标主机监控据的时间间隔
      scrape_timeout: 10s            # 数据采集超时时间，默认10s
      evaluation_interval: 1m        # 触发告警检测的时间，默认是1m
    scrape_configs:
    - job_name: 'kubernetes-node'
      kubernetes_sd_configs:          # 基于K8S的服务发现
      - role: node                    # 使用node模式服务发现
      relabel_configs:                # 正则匹配
      - source_labels: [__address__]  # 匹配带有IP的标签
        regex: '(.*):10250'           # 10250端口(kubelet端口)
        replacement: '${1}:9100'      # 替换成9100
        target_label: __address__
        action: replace
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
    - job_name: 'kubernetes-node-cadvisor' # cadvisor容器用于收集和提供有关节点上运行的容器的资源使用情况和性能指标
      kubernetes_sd_configs:
      - role:  node
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap   # 把匹配到的标签保留
        regex: __meta_kubernetes_node_label_(.+) # 保留匹配到的具有__meta_kubernetes_node_label的标签
      - target_label: __address__               
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
    - job_name: 'kubernetes-apiserver'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https
    - job_name: 'kubernetes-service-endpoints'
      kubernetes_sd_configs:
      - role: endpoints   # 使用k8s中的endpoint模式服务发现
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep      # 采集满足条件的实例，其他实例不采集
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_name  </span>
</code></pre> 
<p>执行配置清单：</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span>  prometheus-cfg.yaml
</code></pre> 
<p>查看ConfigMap资源信息：</p> 
<pre><code class="prism language-bash">kubectl get configmap <span class="token parameter variable">-n</span> prometheus prometheus-config
</code></pre> 
<p><img src="https://images2.imgbox.com/80/93/NfJP0UhA_o.png" alt="在这里插入图片描述"></p> 
<p>2、创建 Deployment资源</p> 
<pre><code class="prism language-yaml">vim prometheus<span class="token punctuation">-</span>deploy.yaml 
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>server
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
      <span class="token key atrule">component</span><span class="token punctuation">:</span> server
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
        <span class="token key atrule">component</span><span class="token punctuation">:</span> server
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">'false'</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">1</span>                <span class="token comment"># 调度到node-1节点</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> prometheus  <span class="token comment"># 指定sa服务账号</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus
        <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/prometheus<span class="token punctuation">:</span>v2.33.5
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">command</span><span class="token punctuation">:</span>                       <span class="token comment"># 启动时运行的命令</span>
          <span class="token punctuation">-</span> prometheus
          <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>config.file=/etc/prometheus/prometheus.yml  <span class="token comment"># 指定配置文件</span>
          <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.tsdb.path=/prometheus               <span class="token comment"># 数据存放目录</span>
          <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.tsdb.retention=720h                 <span class="token comment"># 暴露720小时(30天)</span>
          <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>web.enable<span class="token punctuation">-</span>lifecycle                        <span class="token comment"># 开启热加载</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9090</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/prometheus       <span class="token comment"># 将prometheus-config卷挂载至/etc/prometheus</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>config
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /prometheus/
          <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>storage<span class="token punctuation">-</span>volume
        <span class="token comment">#- name: localtime</span>
        <span class="token comment">#  mountPath: /etc/localtime</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>                           
        <span class="token comment">#- name: localtime</span>
          <span class="token comment">#hostPath:</span>
            <span class="token comment">#path: /etc/localtime</span>
            <span class="token comment">#type: File</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>config          <span class="token comment"># 将prometheus-config做成卷</span>
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>config
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>storage<span class="token punctuation">-</span>volume 
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
           <span class="token key atrule">path</span><span class="token punctuation">:</span> /data
           <span class="token key atrule">type</span><span class="token punctuation">:</span> Directory
</code></pre> 
<p>注意1：我把Prometheus部署到<code>node-1</code>节点，这里填写节点名称，根据自己当前的环境写，其他配置如果是跟做，都不用改！！</p> 
<p><img src="https://images2.imgbox.com/34/4f/MGaXe8mo_o.png" alt="在这里插入图片描述"><br> 注意2：可以将宿主机 <code>/etc/localtime</code> 文件挂载到容器中，但是第一次部署Prometheus可能会受到影响(也有可能是我是VMware虚拟机原因)，如果访问Prometheus WEB页面提示时间不对，可以在``文件中添加如下配置，然后在apply一下即可！<br> <img src="https://images2.imgbox.com/3d/82/7xwye3CY_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-yaml">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime
            <span class="token key atrule">type</span><span class="token punctuation">:</span> File
</code></pre> 
<p>执行配置清单：</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> prometheus-deploy.yaml
</code></pre> 
<p>查看Deployment资源信息：</p> 
<pre><code class="prism language-bash">kubectl get deployment prometheus-server <span class="token parameter variable">-n</span> prometheus
</code></pre> 
<p><img src="https://images2.imgbox.com/79/1c/x8tDVnOI_o.png" alt="在这里插入图片描述"></p> 
<p>3、创建 Service资源</p> 
<pre><code class="prism language-yaml">vim prometheus<span class="token punctuation">-</span>svc.yaml
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9090</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31090</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">component</span><span class="token punctuation">:</span> server
</code></pre> 
<p>执行配置清单：</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> prometheus-svc.yaml
</code></pre> 
<p>查看Service资源信息：</p> 
<pre><code class="prism language-bash">kubectl get svc prometheus-svc <span class="token parameter variable">-n</span> prometheus
</code></pre> 
<p><img src="https://images2.imgbox.com/50/04/Ot1UXsCg_o.png" alt="在这里插入图片描述"></p> 
<p>4、浏览器访问：<code>http://IP:31090</code><br> <img src="https://images2.imgbox.com/11/04/lUtDxhjU_o.png" alt="在这里插入图片描述"></p> 
<p>如上图，没有提示时间对上的问题，表示只此步骤，无误。</p> 
<h3><a id="Node_exporter_288"></a>四、部署Node_exporter组件</h3> 
<p>我直接写到一个文件中了，方便执行！</p> 
<pre><code class="prism language-yaml">vim node<span class="token punctuation">-</span>export.yaml
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">hostIPC</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># 使用物理机IP地址(调度到那个节点,就使用该节点IP地址)</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
        <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/node<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>v0.16.0
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token comment"># 暴露端口</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9100</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">0.15</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>path.procfs
        <span class="token punctuation">-</span> /host/proc
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>path.sysfs
        <span class="token punctuation">-</span> /host/sys
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>collector.filesystem.ignored<span class="token punctuation">-</span>mount<span class="token punctuation">-</span>points
        <span class="token punctuation">-</span> <span class="token string">'"^/(sys|proc|dev|host|etc)($|/)"'</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dev
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/dev
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proc
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/proc
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/sys
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rootfs
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /rootfs
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
      <span class="token comment"># 指定容忍度,允许调度到master节点</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"node-role.kubernetes.io/master"</span>
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span>
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoSchedule"</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proc
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /proc
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dev
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /dev
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /sys
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rootfs
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime
            <span class="token key atrule">type</span><span class="token punctuation">:</span> File
</code></pre> 
<p>注意：需要根据环境修改容忍度<code>tolerations</code> 允许调度到Master节点，其他不用修改！！</p> 
<p>可以使用以下命令查看master-1节点中的污点是什么，然后配置到上面的<code>tolerations</code>。</p> 
<pre><code class="prism language-bash">kubectl describe <span class="token function">node</span> master-1<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-w</span> Taints
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/96/BNZ1SVQC_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/74/2d/zRWQLXxz_o.png" alt="在这里插入图片描述"></p> 
<p>执行资源清单：</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> node-export.yaml
</code></pre> 
<p>查看资源信息，正常三个节点都要部署node_exporter，如果没有master节点，就要检查上面容忍度配置了。</p> 
<pre><code class="prism language-bash">kubectl get pods <span class="token parameter variable">-n</span> prometheus <span class="token parameter variable">-o</span> wide
</code></pre> 
<p><img src="https://images2.imgbox.com/2f/ca/gx9J3QSF_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Kube_state_metrics_385"></a>五、部署Kube_state_metrics组件</h3> 
<p>关于kube-state-metrics资源，我也都写到一个文件中了，直接执行，不需要修改(前提是按照上面环境跟做的！)</p> 
<pre><code class="prism language-yaml">vim kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics.yaml
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"nodes"</span><span class="token punctuation">,</span> <span class="token string">"pods"</span><span class="token punctuation">,</span> <span class="token string">"services"</span><span class="token punctuation">,</span> <span class="token string">"resourcequotas"</span><span class="token punctuation">,</span> <span class="token string">"replicationcontrollers"</span><span class="token punctuation">,</span> <span class="token string">"limitranges"</span><span class="token punctuation">,</span> <span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">,</span> <span class="token string">"persistentvolumes"</span><span class="token punctuation">,</span> <span class="token string">"namespaces"</span><span class="token punctuation">,</span> <span class="token string">"endpoints"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"extensions"</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"daemonsets"</span><span class="token punctuation">,</span> <span class="token string">"deployments"</span><span class="token punctuation">,</span> <span class="token string">"replicasets"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"statefulsets"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"batch"</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cronjobs"</span><span class="token punctuation">,</span> <span class="token string">"jobs"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"autoscaling"</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"horizontalpodautoscalers"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics<span class="token punctuation">:</span>v1.9.0
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
</code></pre> 
<p>执行资源清单：</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> kube-state-metrics.yaml
</code></pre> 
<p>查看资源信息：</p> 
<pre><code class="prism language-bash">kubectl get pods <span class="token parameter variable">-n</span> prometheus
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/94/jZxrVsLg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Grafana_479"></a>六、部署Grafana可视化平台</h3> 
<p>注意：修改<code>nodeName</code>指定部署到Node节点，其他不用修改！！</p> 
<pre><code class="prism language-yaml">vim grafana.yaml
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>server
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">task</span><span class="token punctuation">:</span> monitoring
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> grafana
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">task</span><span class="token punctuation">:</span> monitoring
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> grafana
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">1</span> <span class="token comment"># 部署到那个节点</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana
        <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/grafana<span class="token punctuation">:</span>8.4.5
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs
          <span class="token key atrule">name</span><span class="token punctuation">:</span> ca<span class="token punctuation">-</span>certificates
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var
          <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/grafana/
          <span class="token key atrule">name</span><span class="token punctuation">:</span> lib
        <span class="token comment">#- name: localtime</span>
         <span class="token comment">#mountPath: /etc/localtime</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> INFLUXDB_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> monitoring<span class="token punctuation">-</span>influxdb
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SERVER_HTTP_PORT
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"3000"</span>
          <span class="token comment"># The following env variables are required to make Grafana accessible via</span>
          <span class="token comment"># the kubernetes api-server proxy. On production clusters, we recommend</span>
          <span class="token comment"># removing these env variables, setup auth for grafana, and expose the grafana</span>
          <span class="token comment"># service using a LoadBalancer or a public IP.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_AUTH_BASIC_ENABLED
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_AUTH_ANONYMOUS_ENABLED
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_AUTH_ANONYMOUS_ORG_ROLE
          <span class="token key atrule">value</span><span class="token punctuation">:</span> Admin
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SERVER_ROOT_URL
          <span class="token comment"># If you're only using the API Server proxy, set this value instead:</span>
          <span class="token comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> /
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token comment">#- name: localtime</span>
        <span class="token comment">#hostPath:</span>
          <span class="token comment">#path: /etc/localtime</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ca<span class="token punctuation">-</span>certificates
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/ssl/certs
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage
        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lib
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
         <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/grafana/
         <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span>
    <span class="token comment"># If you are NOT using this as an addon, you should comment out this line.</span>
    <span class="token key atrule">kubernetes.io/cluster-service</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
    <span class="token key atrule">kubernetes.io/name</span><span class="token punctuation">:</span> monitoring<span class="token punctuation">-</span>grafana
  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># In a production setup, we recommend accessing Grafana through an external Loadbalancer</span>
  <span class="token comment"># or through a public IP.</span>
  <span class="token comment"># type: LoadBalancer</span>
  <span class="token comment"># You could also use NodePort to expose the service at a randomly-generated port</span>
  <span class="token comment"># type: NodePort</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31091</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> grafana
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre> 
<p>执行资源清单：</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> grafana.yaml
</code></pre> 
<p>查看资源信息：</p> 
<pre><code class="prism language-bash">kubectl get pods <span class="token parameter variable">-n</span> prometheus
</code></pre> 
<p><img src="https://images2.imgbox.com/7e/d1/vJEjWxDs_o.png" alt="在这里插入图片描述"><br> 浏览器访问：<code>http://IP:31091</code><br> <img src="https://images2.imgbox.com/99/e5/giG1gKaf_o.png" alt="在这里插入图片描述"><br> OK，浏览器可以访问到Grafana，表示至此步骤，无误！</p> 
<h3><a id="GrafanaPrometheus_589"></a>七、Grafana接入Prometheus数据</h3> 
<p>1、点击 <code>设置</code> &gt; <code>Data Sources</code> &gt; <code>Add data source</code> &gt; <code>选择Prometheus</code><br> <img src="https://images2.imgbox.com/8e/51/NzjNHTtB_o.png" alt="在这里插入图片描述"><br> 2、填写<code>Name</code>、<code>URL</code> 字段<br> <code>URL</code> 使用SVC的域名，格式是：<code>SVC名称.名称空间.svc</code></p> 
<pre><code class="prism language-bash">http://prometheus-svc.prometheus.svc:9090
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/94/WVyOjZkR_o.png" alt="在这里插入图片描述"><br> 3、往下滑，点击 <code>Save &amp; test</code><br> <img src="https://images2.imgbox.com/6e/0f/tZXSc54a_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Grafana_600"></a>八、Grafana添加监控模板</h3> 
<p>模板可以去这个地址下载，<a href="https://grafana.com/grafana/dashboards/?dataSource=prometheus" rel="nofollow">Grafana模板下载地址：</a>，下面我推荐几个对我来说比较满意的。</p> 
<table><thead><tr><th>序号</th><th>模板文件</th><th>备注</th></tr></thead><tbody><tr><td>1</td><td><code>1860_rev32.json</code></td><td>服务器监控模板-1</td></tr><tr><td>2</td><td><code>node_exporter.json</code></td><td>服务器监控模板-2</td></tr><tr><td>3</td><td><code>docker_rev1.json</code></td><td>Docker监控模板</td></tr><tr><td>4</td><td><code>Kubernetes-1577674936972.json</code></td><td>K8S集群监控模板</td></tr><tr><td>5</td><td><code>Kubernetes-1577691996738.json</code></td><td>K8S集群监控模板</td></tr></tbody></table> 
<p>1、我以导入 <code>1860_rev32.json</code> 服务器监控模板为例子演示：<br> <img src="https://images2.imgbox.com/b0/be/CbiOn8N9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/44/33/B13Wu6wc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/16/b7/oyewIdou_o.png" alt="在这里插入图片描述"><br> 最终效果：<br> <img src="https://images2.imgbox.com/6a/3d/CflybNkD_o.png" alt="在这里插入图片描述"></p> 
<p>2、导入<code>node_exporter.json</code> 服务器监控-2模板：<br> <img src="https://images2.imgbox.com/bf/ce/TpPft9AU_o.png" alt="在这里插入图片描述"><br> 最终效果图：<br> <img src="https://images2.imgbox.com/d9/65/kderHFxl_o.png" alt="在这里插入图片描述"></p> 
<p>3、导入<code>docker_rev1.json</code> Docker监控模板：<br> <img src="https://images2.imgbox.com/0d/32/JYL3ikEK_o.png" alt="在这里插入图片描述"></p> 
<p>最终效果：<br> <img src="https://images2.imgbox.com/89/28/UQOpqt6z_o.png" alt="在这里插入图片描述"></p> 
<p>4、导入<code>Kubernetes-1577674936972.json</code> K8S-1监控模板：<br> <img src="https://images2.imgbox.com/e5/b7/W0k5LJ7B_o.png" alt="在这里插入图片描述"></p> 
<p>最终效果：<br> <img src="https://images2.imgbox.com/4a/9c/nsbWPDzv_o.png" alt="在这里插入图片描述"></p> 
<p>5、导入<code>Kubernetes-1577691996738.json</code>K8S-2监控模板：<br> <img src="https://images2.imgbox.com/4e/25/tZODhMRb_o.png" alt="在这里插入图片描述"></p> 
<p>最终效果：<br> <img src="https://images2.imgbox.com/cc/dc/Ftshsoog_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_645"></a>九、拓展</h3> 
<p>1、Prometheus热加载</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-XPOST</span> http://16.32.15.200:31090/-/reload
</code></pre> 
<p>2、新增监控Service服务</p> 
<p>问：为什么我添加的Service服务，在Prometheus中查看不到？？？？<br> 答：在Service中添加注解才可以被Prometheus发现，如下图，这是我们定义的ConfigMap内容：<br> <img src="https://images2.imgbox.com/17/d1/XtJJj0xT_o.png" alt="在这里插入图片描述"><br> 案例：以上面定义的prometheus-svc 为例子，添加<code>prometheus_io_scrape</code>注解。</p> 
<pre><code class="prism language-yaml">vim prometheus<span class="token punctuation">-</span>svc.yaml
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prometheus
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus_io_scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token comment"># 注解,有这个才可以被Prometheus发现</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9090</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31090</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">component</span><span class="token punctuation">:</span> server
</code></pre> 
<p>更新一下资源清单：</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> prometheus-svc.yaml
</code></pre> 
<p>热加载一下Prometheus：</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-XPOST</span> http://16.32.15.200:31090/-/reload
</code></pre> 
<p><img src="https://images2.imgbox.com/60/02/v9C5Nua3_o.png" alt="在这里插入图片描述"><br> OK，Prometheus已经监控上了，如下图：</p> 
<p>3、prometheus配置注意项：<br> <img src="https://images2.imgbox.com/8d/4b/bNqA7FAE_o.png" alt="在这里插入图片描述"></p> 
<p><code>scrape_interval</code>采集时间的值，要小于<code>evaluation_interval</code>发送告警的值，比如 <code>scrape_interval</code>5分钟采集一次，<code>evaluation_interval</code>是1分钟告警一次，这样会产生5条告警，因为 <code>scrape_interval</code>是10分钟采集一次，而<code>scrape_interval</code>告警的是旧的值。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/efec787e47233de5bf49555443b6f9cb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue中的数据筛选与搜索功能实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5298cfe9778431ddbbc4e3222ac7acb0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数字时代古文的传承———云南文化瑰宝“爨文化“(我为家乡发声)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>