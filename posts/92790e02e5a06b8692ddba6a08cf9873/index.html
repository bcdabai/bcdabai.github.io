<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring源码分析衍生篇四：后处理器 BeanPostProcessor - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring源码分析衍生篇四：后处理器 BeanPostProcessor" />
<meta property="og:description" content="文章目录 一、前言二、BeanPostProcessor1. 什么是 BeanPostProcessor2. BeanPostProcessor 的种类3. BeanPostProcessor 的创建 三、基本介绍四、源码中的调用场景1. InstantiationAwareBeanPostProcessor1.1. IBP.postProcessBeforeInstantiation1.2. IBP.postProcessAfterInstantiation &amp; IBP.postProcessProperties &amp; IBP.postProcessPropertyValues 2. BeanPostProcessor2.1. BP.postProcessBeforeInitialization2.2. BP.postProcessAfterInitialization2.2.1 resolveBeforeInstantiation2.2.2 initializeBean2.2.3 postProcessObjectFromFactoryBean 3. SmartInstantiationAwareBeanPostProcessor 一、前言 本文是 Spring源码分析：单例bean的获取 - createBean 的衍生文章。主要是因为本人菜鸡，在分析源码的过程中还有一些其他的内容不理解，故开设衍生篇来完善内容以学习。
二、BeanPostProcessor 所谓的 BeanPostProcessor 翻译过来就是Bean后处理器。实际上Spring还有一类后处理器BeanFactoryPostProcessor，源码还没看到这，暂不分析。
1. 什么是 BeanPostProcessor BeanPostProcessor 是 Spring提供给我们的一个非常重要的扩展接口，并且Spring内部的很多功能也是通过 BeanPostProcessor 来完成的(目前看到最典型的就是 AnnotationAwareAspectJAutoProxyCreator 的 注入)。
2. BeanPostProcessor 的种类 BeanPostProcessor 在Spring 中的子类非常多(idea 显是有46个)，比如
InstantiationAwareBeanPostProcessorAdapter ： 在Spring 的bean加载过程中起了非常重要的作用AnnotationAwareAspectJAutoProxyCreator ： bean 创建过程中的 属性注入时起作用AspectJAwareAdvisorAutoProxyCreator ： Aspect 的 AOP 功能实现也全仰仗BeanPostProcessor 的特性。 3. BeanPostProcessor 的创建 个人认为 Bean的 创建时可以认为分为两个过程： 一是Bean对应的BeanDefinition 的创建。二是Bean 实例的创建。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/92790e02e5a06b8692ddba6a08cf9873/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-20T21:14:37+08:00" />
<meta property="article:modified_time" content="2020-05-20T21:14:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring源码分析衍生篇四：后处理器 BeanPostProcessor</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、前言</a></li><li><a href="#BeanPostProcessor_3" rel="nofollow">二、BeanPostProcessor</a></li><li><ul><li><a href="#1__BeanPostProcessor_6" rel="nofollow">1. 什么是 BeanPostProcessor</a></li><li><a href="#2_BeanPostProcessor___10" rel="nofollow">2. BeanPostProcessor 的种类</a></li><li><a href="#3_BeanPostProcessor__16" rel="nofollow">3. BeanPostProcessor 的创建</a></li></ul> 
  </li><li><a href="#_46" rel="nofollow">三、基本介绍</a></li><li><a href="#_112" rel="nofollow">四、源码中的调用场景</a></li><li><ul><li><a href="#1_InstantiationAwareBeanPostProcessor_153" rel="nofollow">1. InstantiationAwareBeanPostProcessor</a></li><li><ul><li><a href="#11_IBPpostProcessBeforeInstantiation_156" rel="nofollow">1.1. IBP.postProcessBeforeInstantiation</a></li><li><a href="#12_IBPpostProcessAfterInstantiation__IBPpostProcessProperties__IBPpostProcessPropertyValues_195" rel="nofollow">1.2. IBP.postProcessAfterInstantiation &amp; IBP.postProcessProperties &amp; IBP.postProcessPropertyValues</a></li></ul> 
   </li><li><a href="#2_BeanPostProcessor_250" rel="nofollow">2. BeanPostProcessor</a></li><li><ul><li><a href="#21_BPpostProcessBeforeInitialization_251" rel="nofollow">2.1. BP.postProcessBeforeInitialization</a></li><li><a href="#22_BPpostProcessAfterInitialization_276" rel="nofollow">2.2. BP.postProcessAfterInitialization</a></li><li><ul><li><a href="#221_resolveBeforeInstantiation_286" rel="nofollow">2.2.1 resolveBeforeInstantiation</a></li><li><a href="#222_initializeBean_294" rel="nofollow">2.2.2 initializeBean</a></li><li><a href="#223_postProcessObjectFromFactoryBean_298" rel="nofollow">2.2.3 postProcessObjectFromFactoryBean</a></li></ul> 
   </li></ul> 
   </li><li><a href="#3_SmartInstantiationAwareBeanPostProcessor_303" rel="nofollow">3. SmartInstantiationAwareBeanPostProcessor</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、前言</h2> 
<p>本文是 Spring源码分析：<a href="https://blog.csdn.net/qq_36882793/article/details/105800112">单例bean的获取 - createBean</a> 的衍生文章。主要是因为本人菜鸡，在分析源码的过程中还有一些其他的内容不理解，故开设衍生篇来完善内容以学习。</p> 
<h2><a id="BeanPostProcessor_3"></a>二、BeanPostProcessor</h2> 
<p>所谓的 <code>BeanPostProcessor</code> 翻译过来就是Bean后处理器。实际上Spring还有一类后处理器<code>BeanFactoryPostProcessor</code>，源码还没看到这，暂不分析。</p> 
<h3><a id="1__BeanPostProcessor_6"></a>1. 什么是 BeanPostProcessor</h3> 
<p><code>BeanPostProcessor</code> 是 Spring提供给我们的一个非常重要的扩展接口，并且Spring内部的很多功能也是通过 BeanPostProcessor 来完成的(目前看到最典型的就是 <code>AnnotationAwareAspectJAutoProxyCreator</code> 的 注入)。</p> 
<h3><a id="2_BeanPostProcessor___10"></a>2. BeanPostProcessor 的种类</h3> 
<p><code>BeanPostProcessor</code> 在Spring 中的子类非常多(idea 显是有46个)，比如</p> 
<ul><li><code>InstantiationAwareBeanPostProcessorAdapter</code> ： 在Spring 的bean加载过程中起了非常重要的作用</li><li><code>AnnotationAwareAspectJAutoProxyCreator</code> ： bean 创建过程中的 属性注入时起作用</li><li><code>AspectJAwareAdvisorAutoProxyCreator</code> ： Aspect 的 AOP 功能实现也全仰仗BeanPostProcessor 的特性。</li></ul> 
<h3><a id="3_BeanPostProcessor__16"></a>3. BeanPostProcessor 的创建</h3> 
<p>个人认为 Bean的 创建时可以认为分为两个过程： 一是Bean对应的BeanDefinition 的创建。二是Bean 实例的创建。</p> 
<p>因为在 Spring容器中，Bean的创建并非仅仅通过反射创建就结束了，在创建过程中，需要考虑到Bean针对Spring容器中的一些属性，所以BeanDefinition 中不仅仅包含了 Bean Class 文件信息，还包含了 当前Bean在Spring容器中的一些属性，比如在容器中的作用域、是否懒加载、别名等信息。当Bean 进行实例化创建时需要依赖于对应的BeanDefinition 提供对应的信息。</p> 
<hr> 
<p>BeanDefinition 的创建在 Spring 启动时对 BeanFactoryPostProcessor 的处理。<br> 详参：</p> 
<ol><li><a href="https://blog.csdn.net/qq_36882793/article/details/106447003">Spring源码分析二：BeanFactoryPostProcessor 的处理</a></li><li><a href="https://blog.csdn.net/qq_36882793/article/details/106558290">Spring 源码分析衍生篇八 ：ConfigurationClassPostProcessor 上篇</a></li><li><a href="https://blog.csdn.net/qq_36882793/article/details/106652607">Spring 源码分析衍生篇九 ：ConfigurationClassPostProcessor 下篇</a></li></ol> 
<p>Bean 实例的创建在Spring 启动时的收尾工作，详参:</p> 
<ol><li><a href="https://blog.csdn.net/qq_36882793/article/details/106441853">Spring源码分析一：容器的刷新 - refresh()</a></li></ol> 
<hr> 
<p><strong>而由于 BeanPostProcessor 是参与了 Bean 创建过程。所以其创建一定在普通 Bean 之前。实际上 BeanPostProcessor 的创建时在 Spring 启动时容器刷新的时候</strong>。</p> 
<p>BeanPostProcessor 的 BeanDefinition 创建时机和普通 Bean没有区别，都是在Spring 启动时的BeanFactoryPostProcessor 中完成(确切的说是 ConfigurationClassPostProcessor 中完成)。</p> 
<p>而BeanPostProcessor 的实例创建要优先于普通bean创建，Spring启动过程中会调用<code>.AbstractApplicationContext#registerBeanPostProcessors</code> 方法。 在这个方法中，Spring 会从容器中获取到所有BeanPostProcessor 类型的beanName， 通过 <code>beanFactory.getBean</code> 方法获取到对应实例，进行排序后注册到 <code>BeanFactory.beanPostProcessors</code> 属性中，其中 <code>BeanFactory.beanPostProcessors</code> 的定义如下</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&gt;</span></span> beanPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanPostProcessorCacheAwareList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>当容器需要执行 BeanPostProcessor 方法时可以直接从 beanPostProcessors 中获取即可。<br> 关于 refresh 方法的介绍，详参: <a href="https://blog.csdn.net/qq_36882793/article/details/106441853">Spring源码分析一：容器的刷新 - refresh()</a></p> 
<h2><a id="_46"></a>三、基本介绍</h2> 
<p>日常使用中，我们一般编写一个类来实现 <code>BeanPostProcessor</code> 或者 <code>InstantiationAwareBeanPostProcessor</code> 接口，根据每个方法的调用时机，来完成响应的工作。<br> 下面介绍一下接口方法，这里通过 <code>InstantiationAwareBeanPostProcessor</code> 接口来介绍 。<code>InstantiationAwareBeanPostProcessor</code> 是 <code>BeanPostProcessor</code> 的子接口，在 <code>BeanPostProcessor</code> 基础上又扩展了三个方法。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoPostProcesser</span> <span class="token keyword">implements</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//InstantiationAwareBeanPostProcessor 提供的方法， 在 Class&lt;T&gt; -&gt; T 的转换过程中</span>
    <span class="token comment">// 此时bean还没创建，可以通过这方法代替 Spring 容器创建的方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DemoPostProcesser.postProcessBeforeInstantiation   ###  1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//InstantiationAwareBeanPostProcessor 提供的方法， 返回的值代表是否需要继续注入属性，</span>
    <span class="token comment">// 如果返回true，则会调用postProcessProperties和postProcessPropertyValues 来注入属性</span>
    <span class="token comment">// 此时bean已经创建，属性尚未注入</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DemoPostProcesser.postProcessAfterInstantiation   ###  2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//InstantiationAwareBeanPostProcessor 提供的方法，可以在这个方法中进行bean属性的注入，Aop 就是在此方法中进行了代理的创建</span>
    <span class="token comment">// 只有postProcessAfterInstantiation 返回true 时才会调用</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PropertyValues</span> <span class="token function">postProcessProperties</span><span class="token punctuation">(</span><span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DemoPostProcesser.postProcessProperties   ###  3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pvs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//InstantiationAwareBeanPostProcessor 提供的方法，可以在这个方法中进行bean属性的注入, 这个方法已经过时，使用postProcessProperties 代理</span>
    <span class="token comment">// 只有postProcessAfterInstantiation 返回true 时 且 postProcessProperties 返回 null 时调用</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PropertyValues</span> <span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span><span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">,</span> <span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pds<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DemoPostProcesser.postProcessPropertyValues   ###  4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pvs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// BeanPostProcessor 提供的方法，在bean初始化前调用，这时候的bean大体已经创建完成了，在完成一些其他属性的注入</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DemoPostProcesser.postProcessBeforeInitialization   ###  5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// BeanPostProcessor 提供的方法，在bean初始化后调用，这时候的bean 已经创建完成了</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DemoPostProcesser.postProcessAfterInitialization   ###  6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其调用顺序也和标注相同<br> <img src="https://images2.imgbox.com/52/a9/yYM8jl7T_o.png" alt="在这里插入图片描述"><br> <strong>注意：</strong></p> 
<p>这里可以看到 <code>postProcessPropertyValues</code> 方法并没有调用，因为对于一个 过时的方法 没必要必须要调用它，前面也提到 <code>postProcessAfterInstantiation</code> 返回true 并且 <code>postProcessProperties</code> 返回不为null 才会调用该方法，这里<code>postProcessProperties</code> 返回不为null ，所以不会调用<code>postProcessPropertyValues</code> 方法</p> 
<hr> 
<h2><a id="_112"></a>四、源码中的调用场景</h2> 
<p>下面为了方便描述，进行一些简化写法，为了后面描述方便</p> 
<p><strong>BP : BeanPostProcessor<br> IBP : InstantiationAwareBeanPostProcessor<br> SBP : SmartInstantiationAwareBeanPostProcessor</strong></p> 
<hr> 
<p>其结构如下图：<br> <img src="https://images2.imgbox.com/13/ce/t3r691NR_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p>这里就不具体贴出多少代码。简单解释一下调用场景</p> 
<p>Spring 在启动过程中，会将所有实现了 BeanPostProcessor 接口的子类保存到 AbstractBeanFactory 中的 beanPostProcessors 集合中，如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&gt;</span></span> beanPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在适当的时候(这个适当的时候就根据 每个接口方法定义的意义来判断)， Spring会获取 所有的BeanPostProcessor 子类集合，即 beanPostProcessors ，经过类型过滤后，调用对应的方法。比如，就是对 <code>InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation</code> 方法的调用流程(其余方法的调用也类似)：</p> 
<pre><code class="prism language-java">	<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">applyBeanPostProcessorsBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 因为只有 InstantiationAwareBeanPostProcessor  类型才有postProcessBeforeInstantiation 方法，所以这里要判断一下是不是 InstantiationAwareBeanPostProcessor   类型</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
				<span class="token class-name">Object</span> result <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span> result<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h3><a id="1_InstantiationAwareBeanPostProcessor_153"></a>1. InstantiationAwareBeanPostProcessor</h3> 
<p>下面来介绍在 <strong>Spring 创建流程中</strong> 每个方法的实际调用位置：</p> 
<h4><a id="11_IBPpostProcessBeforeInstantiation_156"></a>1.1. IBP.postProcessBeforeInstantiation</h4> 
<p><code>IBP.postProcessBeforeInstantiation</code> 方法在 Bean 创建 之前调用，我所理解的目的是替换Spring 容器创建bean， 当 <code>IBP.postProcessBeforeInstantiation</code> 返回不为null时，则不会再通过Spring 创建bean，而是使用 <code>IBP.postProcessBeforeInstantiation</code> 返回的bean。</p> 
<pre><code class="prism language-java">			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token comment">// 该方法中 调用了postProcessBeforeInstantiation 方法，并且可能调用 postProcessAfterInitialization 方法</span>
			<span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> bean<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token comment">// 真正去创建bean</span>
			<span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p><code>resolveBeforeInstantiation</code> 方法内容如下，可以看到 当 <code>applyBeanPostProcessorsBeforeInstantiation</code> 方法(<code>applyBeanPostProcessorsBeforeInstantiation</code> 调用了 <code>postProcessBeforeInstantiation</code> 方法) 返回值不为 null，则会调用 <code>applyBeanPostProcessorsAfterInitialization</code> 方法，从而调用<code>postProcessAfterInitialization</code> 方法。因为这里bean返回不为null，则代表bean创建成功了，就会调用创建成功后的方法，即 <code>postProcessAfterInitialization</code>。</p> 
<pre><code class="prism language-java">	<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>beforeInstantiationResolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Make sure bean class is actually resolved at this point.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetType <span class="token operator">=</span> <span class="token function">determineTargetType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>targetType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					bean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInstantiation</span><span class="token punctuation">(</span>targetType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						bean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			mbd<span class="token punctuation">.</span>beforeInstantiationResolved <span class="token operator">=</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> bean<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>这里需要注意，在 <code>resolveBeforeInstantiation</code> 方法中，当 <code>bean ！= null</code> 时 调用了 <code>applyBeanPostProcessorsAfterInitialization</code> 方法，即 <code>BP.postProcessAfterInitialization</code> 方法。这是因为如果 <code>bean != null</code>， 则说明 bean 的创建已经完成，那么这里则是最后调用bean 的后置处理的机会，即调用<code>BP.postProcessAfterInitialization</code> 方法的最后机会。</p> 
<h4><a id="12_IBPpostProcessAfterInstantiation__IBPpostProcessProperties__IBPpostProcessPropertyValues_195"></a>1.2. IBP.postProcessAfterInstantiation &amp; IBP.postProcessProperties &amp; IBP.postProcessPropertyValues</h4> 
<p>I<code>BP.postProcessAfterInstantiation</code> 、<code>IBP.postProcessProperties</code> 、 <code>IBP.postProcessPropertyValues</code> 的调用场景只有一处，在<code>AbstractAutowireCapableBeanFactory#populateBean</code> 方法中，此时bean已经创建完成，正在进行属性注入。而 <code>IBP.postProcessAfterInstantiation</code> 的返回值决定是否继续注入</p> 
<p>大致代码如下</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token comment">// 调用 postProcessAfterInstantiation 方法吗，如果返回false，直接return;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">return</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				pvs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
					<span class="token comment">// 调用 postProcessProperties 注入属性</span>
					<span class="token class-name">PropertyValues</span> pvsToUse <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessProperties</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>pvsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>filteredPds <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token comment">// 调用 postProcessPropertyValues 注入属性</span>
						pvsToUse <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>pvsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token keyword">return</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					pvs <span class="token operator">=</span> pvsToUse<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>通过代码我们可以比较清楚的看到整体逻辑：</p> 
<ol><li>若<code>IBP.postProcessAfterInstantiation</code> 返回true，才会执行下面步骤</li><li>调用 <code>IBP.postProcessProperties</code> 注入属性，</li><li>若<code>IBP.postProcessProperties</code> 返回为null，才会执行下面步骤</li><li>调用 <code>IBP.postProcessPropertyValues</code> 注入属性</li></ol> 
<h3><a id="2_BeanPostProcessor_250"></a>2. BeanPostProcessor</h3> 
<h4><a id="21_BPpostProcessBeforeInitialization_251"></a>2.1. BP.postProcessBeforeInitialization</h4> 
<p>BP.<code>postProcessBeforeInitialization</code> 调用时机是bean已经创建完成，但是尚未初始化，即一些属性配置尚未完成(我看到的就一个 init-method 的配置)。使用场景也只有一处，即<br> <code>AbstractAutowireCapableBeanFactory#initializeBean(String, Object, RootBeanDefinition)</code>。</p> 
<p>程序走到这里，代表 <code>resolveBeforeInstantiation</code> 方法 中的 IBP.<code>postProcessBeforeInstantiation</code> 并未代理 bean的创建，在这里则是由Spring 创建的bean的时候来调用。</p> 
<p>代码如下，</p> 
<pre><code class="prism language-java">	<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token comment">// 调用 BP.postProcessBeforeInitialization</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 初始化属性，貌似就初始化了 一个 init-method</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 调用 BP.postProcessAfterInitialization</span>
			wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="22_BPpostProcessAfterInitialization_276"></a>2.2. BP.postProcessAfterInitialization</h4> 
<p><code>IBP.postProcessAfterInitialization</code> 的调用都被封装到 <code>AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization</code> 方法中。<br> 而<code>applyBeanPostProcessorsAfterInitialization</code> 方法的调用</p> 
<p><code>applyBeanPostProcessorsAfterInitialization</code> 方法在下面三个方法中调用：</p> 
<ul><li><strong>AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation</strong></li><li><strong>AbstractAutowireCapableBeanFactory#initializeBean(String, Object, RootBeanDefinition)</strong></li><li><strong>AbstractAutowireCapableBeanFactory#postProcessObjectFromFactoryBean</strong></li></ul> 
<hr> 
<h5><a id="221_resolveBeforeInstantiation_286"></a>2.2.1 resolveBeforeInstantiation</h5> 
<p><code>resolveBeforeInstantiation</code> 方法的调用有如下三处</p> 
<ul><li> <p><strong>AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])</strong> 这里的调用实际上就是上面讲的 IBP.postProcessBeforeInstantiation 的调用后续，所以这里不再重复</p> </li><li> <p><strong>AbstractAutowireCapableBeanFactory#getSingletonFactoryBeanForTypeCheck</strong></p> </li><li> <p><strong>AbstractAutowireCapableBeanFactory#getNonSingletonFactoryBeanForTypeCheck</strong></p> </li></ul> 
<hr> 
<h5><a id="222_initializeBean_294"></a>2.2.2 initializeBean</h5> 
<p>上面介绍 <code>BP.postProcessBeforeInitialization</code> 的时候已经说了，所以这里不再赘述</p> 
<hr> 
<h5><a id="223_postProcessObjectFromFactoryBean_298"></a>2.2.3 postProcessObjectFromFactoryBean</h5> 
<p>在 <code>FactoryBeanRegistrySupport#getObjectFromFactoryBean</code> 中调用，在从 FactoryBean 中获取 bean时调用，在此调用可以替换掉 FactoryBean 中的返回的bean。</p> 
<hr> 
<h3><a id="3_SmartInstantiationAwareBeanPostProcessor_303"></a>3. SmartInstantiationAwareBeanPostProcessor</h3> 
<p><code>SmartInstantiationAwareBeanPostProcessor</code> 在 IBP 之上又扩展了三个方法，不过我们一般不会使用，所以这里简单叙述一下<code>SmartInstantiationAwareBeanPostProcessor</code> 三个方法的作用</p> 
<ul><li> <p><strong>Class&lt;?&gt; predictBeanType(Class&lt;?&gt; beanClass, String beanName)</strong> ： 在进行bean类型匹配时调用，返回值和期望值进行匹配。</p> </li><li> <p><strong>Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, String beanName)</strong> ： 在 Spring 加载bean 的时候，判断是否需要通过构造注入时，如果返回的值不为空，则进行有参构造注入。</p> <pre><code class="prism language-java">	<span class="token comment">// determineConstructorsFromBeanPostProcessors 中调用了  determineCandidateConstructors 方法，如果ctors != null, 则进行有参构造autowireConstructor</span>
		<span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> AUTOWIRE_CONSTRUCTOR <span class="token operator">||</span>
				mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>Object getEarlyBeanReference(Object bean, String beanName)</strong> ： 在 Spring 解决循环依赖时候使用，返回的值将作为ObjectFactory 的 保存的Object，用于循环依赖的提前暴露。</p> <pre><code class="prism language-java">		<span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
						<span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// getEarlyBeanReference 的返回值作为 ObjectFactory 的返回值保存到singletonFactories缓存中</span>
			<span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre> </li></ul> 
<hr> 
<p><strong>最后，附一张自己画的调用流程图，由于完全有本人自己阅读绘制，可能会出现些许纰漏，如果发现，麻烦指正，谢谢。</strong><br> <img src="https://images2.imgbox.com/74/7d/2WmWfAPn_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p><strong>以上：内容部分参考<br> 《Spring源码深度解析》<br> 如有侵扰，联系删除。 内容仅用于自我记录学习使用。如有错误，欢迎指正</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c626d30a775a1c5309ab9a72ed5e7998/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【菜鸟进阶之路】P1765 手机 - 洛谷</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0bc8e3dab7674c06645c53ec60b1f9c3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python中的sort和lambda函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>