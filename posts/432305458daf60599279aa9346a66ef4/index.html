<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>R6服务器不稳定,gc服务器慢的原因分析 (r6笔记第14天) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="R6服务器不稳定,gc服务器慢的原因分析 (r6笔记第14天)" />
<meta property="og:description" content="在工作环境中有一台gc的服务器，已经好几年没有动过了，上面安装着gc的服务和数据库，也就说gc里面的HttpServer，数据库,webcache都在这台服务器上。
大家在访问gc的时候，感觉有些时候访问很慢，尽管是内网，但是还是有很大的延迟的感觉，大家认为可能是监控的机器比较多了，也就没有在意，今天我抽空查看了下这台机器，还是发现了一些问题。
首先看看gc的服务是否正常。我们也可以使用opmn来检测。
$ ./opmnctl status
Processes in Instance: EnterpriseManager0.cyoumon.cyou.com
-------------------&#43;--------------------&#43;---------&#43;---------
ias-component | process-type | pid | status
-------------------&#43;--------------------&#43;---------&#43;---------
DSA | DSA | N/A | Down
HTTP_Server | HTTP_Server | 20850 | Alive
LogLoader | logloaderd | 29381 | Alive
dcm-daemon | dcm-daemon | 29428 | Alive
OC4J | home | 20851 | Alive
OC4J | OC4J_EMPROV | 20852 | Alive
OC4J | OC4J_EM | 20853 | Alive
OC4J | OCMRepeater | 20855 | Alive" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/432305458daf60599279aa9346a66ef4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-05T13:03:40+08:00" />
<meta property="article:modified_time" content="2021-08-05T13:03:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">R6服务器不稳定,gc服务器慢的原因分析 (r6笔记第14天)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>在工作环境中有一台gc的服务器，已经好几年没有动过了，上面安装着gc的服务和数据库，也就说gc里面的HttpServer，数据库,webcache都在这台服务器上。</p> 
 <p>大家在访问gc的时候，感觉有些时候访问很慢，尽管是内网，但是还是有很大的延迟的感觉，大家认为可能是监控的机器比较多了，也就没有在意，今天我抽空查看了下这台机器，还是发现了一些问题。</p> 
 <p>首先看看gc的服务是否正常。我们也可以使用opmn来检测。</p> 
 <p>$ ./opmnctl status</p> 
 <p>Processes in Instance: EnterpriseManager0.cyoumon.cyou.com</p> 
 <p>-------------------+--------------------+---------+---------</p> 
 <p>ias-component | process-type | pid | status</p> 
 <p>-------------------+--------------------+---------+---------</p> 
 <p>DSA | DSA | N/A | Down</p> 
 <p>HTTP_Server | HTTP_Server | 20850 | Alive</p> 
 <p>LogLoader | logloaderd | 29381 | Alive</p> 
 <p>dcm-daemon | dcm-daemon | 29428 | Alive</p> 
 <p>OC4J | home | 20851 | Alive</p> 
 <p>OC4J | OC4J_EMPROV | 20852 | Alive</p> 
 <p>OC4J | OC4J_EM | 20853 | Alive</p> 
 <p>OC4J | OCMRepeater | 20855 | Alive</p> 
 <p>WebCache | WebCache | 20863 | Alive</p> 
 <p>WebCache | WebCacheAdmin | 20857 | Alive</p> 
 <p>这也就是例行检查，如果服务有问题，就不只是卡了。不过还是看了下，简单验证一下。</p> 
 <p>然后就是查看系统的情况</p> 
 <p>查看系统，我分为以下几个部分来看。</p> 
 <p>首先查看系统版本，发现这是一个比较老的版本，还是redhat 4</p> 
 <p>$ cat /etc/issue</p> 
 <p>Red Hat Enterprise Linux AS release 4 (Nahant Update 8)</p> 
 <p>Kernel \r on an \m</p> 
 <p>查看CPU的信息如下:</p> 
 <p>有8个物理CPU,8个逻辑CPU，CPU算是比较老的配置</p> 
 <p>$ ksh cpuinfo.sh</p> 
 <p>**************************************</p> 
 <p>CPU Physical NO: 8</p> 
 <p>CPU Processor NO: 8</p> 
 <p>CPU Core NO: cpu cores : 1</p> 
 <p>CPU model name : Intel(R) Xeon(R) CPU E5504 @ 2.00GHz</p> 
 <p>**************************************</p> 
 <p>这个配置在现在看来还是比较紧俏的。</p> 
 <p>但是这个肯定不是最根本的原因，不能一有问题就全部归结在硬件上，这个也是硬伤，不会说改进就改进，毕竟很多服务跑了很多年了。</p> 
 <p>我们来看看系统的负载</p> 
 <p>这个时候还是使用传统的top</p> 
 <p>可以看到还是存在大量的swap现象,</p> 
 <p>top - 14:07:46 up xxxx days, 19:18, 4 users, load average: 0.05, 0.16, 0.12</p> 
 <p>Tasks: 175 total, 1 running, 174 sleeping, 0 stopped, 0 zombie</p> 
 <p>Cpu(s): 0.7% us, 0.1% sy, 0.0% ni, 98.7% id, 0.5% wa, 0.0% hi, 0.0% si</p> 
 <p>Mem: 16430320k total, 16375716k used, 54604k free, 9680k buffers</p> 
 <p>Swap: 8385920k total, 3468324k used, 4917596k free, 4501616k cached</p> 
 <p>使用vmstat查看swap的情况</p> 
 <p>$ vmstat 1 5</p> 
 <p>procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----</p> 
 <p>r b swpd free buff cache si so bi bo in cs us sy id wa</p> 
 <p>0 0 3483652 50404 4896 4480752 14 4 48 42 0 0 1 0 99 0</p> 
 <p>0 0 3483652 51260 4936 4480712 0 0 0 332 1062 2594 0 0 100 0</p> 
 <p>0 0 3483652 52108 4936 4480712 0 0 0 0 1004 2565 0 0 100 0</p> 
 <p>0 0 3483652 52116 4936 4480712 0 0 0 0 1005 2468 0 0 100 0</p> 
 <p>0 0 3483652 55988 4940 4480776 0 0 16 92 1119 2705 0 0 99 0</p> 
 <p>可以从中看出很明显的swap,大概是3G的样子</p> 
 <p>如果这个时候来看系统的整体负载，还是使用sar,可以看到idle基本都在99%左右，所以说尽管在这样的情况下，还是存在问题，CPU尽管配置不高，但是利用率也确实不高。</p> 
 <p>$ sar</p> 
 <p>07:40:01 AM CPU %user %nice %system %iowait %idle</p> 
 <p>07:50:01 AM all 0.49 0.00 0.10 0.08 99.33</p> 
 <p>08:00:01 AM all 0.63 0.00 0.12 0.16 99.09</p> 
 <p>08:10:01 AM all 0.60 0.00 0.13 0.40 98.87</p> 
 <p>08:20:01 AM all 0.62 0.00 0.11 0.12 99.15</p> 
 <p>08:30:01 AM all 0.65 0.00 0.11 0.11 99.12</p> 
 <p>08:40:01 AM all 0.49 0.00 0.10 0.09 99.32</p> 
 <p>08:50:01 AM all 0.48 0.00 0.13 0.29 99.09</p> 
 <p>09:00:01 AM all 0.54 0.00 0.10 0.07 99.30</p> 
 <p>09:10:01 AM all 0.67 0.00 0.14 0.35 98.84</p> 
 <p>09:20:02 AM all 0.66 0.00 0.13 0.28 98.92</p> 
 <p>09:30:01 AM all 0.66 0.00 0.12 0.13 99.10</p> 
 <p>09:40:01 AM all 0.61 0.00 0.11 0.14 99.14</p> 
 <p>09:50:02 AM all 0.50 0.00 0.13 0.25 99.12</p> 
 <p>10:00:01 AM all 0.55 0.00 0.11 0.19 99.15</p> 
 <p>10:10:01 AM all 0.59 0.00 0.13 0.31 98.98</p> 
 <p>10:20:01 AM all 0.64 0.00 0.16 0.65 98.55</p> 
 <p>10:30:01 AM all 0.79 0.00 0.19 0.76 98.26</p> 
 <p>10:40:01 AM all 0.70 0.00 0.15 0.43 98.72</p> 
 <p>10:50:01 AM all 0.62 0.00 0.13 0.12 99.13</p> 
 <p>11:00:01 AM all 0.87 0.00 0.18 0.86 98.09</p> 
 <p>11:10:01 AM all 0.88 0.00 0.29 1.04 97.79</p> 
 <p>11:20:01 AM all 0.81 0.00 0.28 0.94 97.96</p> 
 <p>11:30:01 AM all 0.87 0.00 0.18 0.50 98.45</p> 
 <p>11:40:02 AM all 0.66 0.00 0.14 0.32 98.88</p> 
 <p>11:50:01 AM all 0.78 0.00 0.66 0.75 97.81</p> 
 <p>Average: all 0.69 0.00 0.17 0.53 98.61</p> 
 <p>查看内核参数，发现Memlock还是最低的默认值32，这个时候可以尝试修改memlock</p> 
 <p>oracle soft memlock unlimited</p> 
 <p>oracle hard memlock unlimited</p> 
 <p>查看内核中配置了Hugepage，但是实际来看，还是没有使用到。</p> 
 <p>$ cat /proc/meminfo | grep -i page</p> 
 <p>PageTables: 387504 kB</p> 
 <p>HugePages_Total: 5121</p> 
 <p>HugePages_Free: 5121</p> 
 <p>Hugepagesize: 2048 kB</p> 
 <p>可以使用Oracle提供的脚本来查看Hugepage的推荐配置。</p> 
 <p>$ ./hugepage_setting.sh</p> 
 <p>Recommended setting: vm.nr_hugepages = 3075</p> 
 <p>系统级的检查大体就是这些，我们来看看数据库级的情况</p> 
 <p>查看了session总数载50个左右，还是使用率不高，归档一两个小时切一次，数据库层面没有发现任何的阻塞和锁等待。</p> 
 <p>同时查看数据库的负载，都是一个很低的值。</p> 
 <p>这个时候发现有很多的历史日志，</p> 
 <p>但是在部分日志目录下存在大量日志文件，ls不可用</p> 
 <p>比如在adump目录下，使用ls的时候都会出错。</p> 
 <p>[/adump]$ ll *.aud|wc -l</p> 
 <p>bash: /bin/ls: Argument list too long</p> 
 <p>0</p> 
 <p>原来下面有不少的文件，但是都是好几年前的了。</p> 
 <p>$ ll |wc -l</p> 
 <p>32468</p> 
 <p>其它几个目录下也都有类似的问题，所以这类问题也是一个因素，可以根据条件进行过滤，删除掉很早的日志文件。</p> 
 <p>所以综上所述，整体的分析结论如下：</p> 
 <p>数据库的硬件资源比较旧，系统是RHEL4，CPU资源相对比较紧俏</p> 
 <p>系统的负载不高，但是有swap的争用，可以通过调整memlock进行改进</p> 
 <p>数据库hugepage没有生效，配置large page或者Hugepage</p> 
 <p>数据库级session使用率不高，数据库负载也不高。没有发现相关的锁等待，数据库级没有发现明显问题</p> 
 <p>在日志目录中发现了大量的历史日志，可以根据条件进行删减。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/29df22d99ed7f361210f6295dd80fc31/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用ajax获取一张图片,Python 实现AJAX获取图片</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fd56808bab7380d24f88514c351ea723/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">spring security3 ajax,spring security 3中关于ajax的处理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>