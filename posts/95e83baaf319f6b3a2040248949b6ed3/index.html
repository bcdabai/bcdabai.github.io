<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Prometheus监控DELL服务器硬件 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Prometheus监控DELL服务器硬件" />
<meta property="og:description" content="前言 注意标题说的监控dell服务器硬件,指的是监控服务器硬件的状态(磁盘,内存,电源等的状态),不是指监控硬件性能,磁盘的空间,内存等的使用量.而是类似于zabbix监控idrac的snmp获取硬件状态.
现在大部分公司是使用prometheus监控容器和服务,zabbix监控硬件,端口,当然还有其他监控架构.这里就不对比各个监控的优劣了.仅仅是做一篇文档.该文档对基础的内容解释不太详尽,仅适合具备一些prometheus基础的查看.不适合未接触者
前提条件 &lt;1&gt;各个需要监控的服务器开启idrac的snmp,并设置团体名,类似于密码(默认是public)
注意自己设置的密码,后面要用到
&lt;2&gt;由于安全问题,对网络一般进行了限制.找一台可以ping通各服务器idrac IP地址的服务器,安装snmp监控组件
&lt;3&gt;prometheus服务器需要能联通snmp_exporter
组件安装 安装依赖 yum -y install gcc gcc-g&#43;&#43; make net-snmp net-snmp-utils net-snmp-libs net-snmp-devel golang git snmp_exporter安装 &lt;1&gt;下载snmp_exporter
https://github.com/prometheus/snmp_exporter/releases cd /data wget https://github.com/prometheus/snmp_exporter/releases/download/v0.20.0/snmp_exporter-0.20.0.linux-amd64.tar.gz tar xf snmp_exporter-0.20.0.linux-amd64.tar.gz mv snmp_exporter-0.20.0.linux-amd64 snmp_exporter &lt;2&gt;配置启动方式
根据系统版本配置启动方式,暂时不需要启动(没有生成snmp)
Centos7 cat /usr/lib/systemd/system/snmp-exporter.service [Unit] Description=SNMP exporter Documentation=https://github.com/prometheus/snmp_exporter [Service] ExecStart=/data/snmp_exporter/snmp_exporter \ --config.file=/data/snmp_exporter/snmp.yml \ --web.listen-address=:9116 \ --snmp.wrap-large-counters ExecReload=/bin/kill -HUP $MAINPID KillMode=process Restart=on-failure [Install] WantedBy=multi-user.target 管理方式: systemctl daemon-reload systemctl enable snmp-exporter systemctl restart snmp-exporter systemctl status snmp-exporter systemctl stop snmp-exporter Centos6 cat /etc/init." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/95e83baaf319f6b3a2040248949b6ed3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-03T16:35:50+08:00" />
<meta property="article:modified_time" content="2021-09-03T16:35:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Prometheus监控DELL服务器硬件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<hr> 
<hr> 
<p>注意标题说的监控dell服务器硬件,指的是监控服务器硬件的状态(磁盘,内存,电源等的状态),不是指监控硬件性能,磁盘的空间,内存等的使用量.而是类似于zabbix监控idrac的snmp获取硬件状态.</p> 
<p>现在大部分公司是使用prometheus监控容器和服务,zabbix监控硬件,端口,当然还有其他监控架构.这里就不对比各个监控的优劣了.仅仅是做一篇文档.该文档对基础的内容解释不太详尽,仅适合具备一些prometheus基础的查看.不适合未接触者</p> 
<hr> 
<hr> 
<h2><a id="_12"></a>前提条件</h2> 
<hr> 
<hr> 
<p>&lt;1&gt;各个需要监控的服务器开启idrac的snmp,并设置团体名,类似于密码(默认是public)<br> 注意自己设置的密码,后面要用到</p> 
<p><img src="https://images2.imgbox.com/9d/c1/gHwH4xLU_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<hr> 
<p><img src="https://images2.imgbox.com/b1/88/Z1UUAnZc_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<hr> 
<p>&lt;2&gt;由于安全问题,对网络一般进行了限制.找一台可以ping通各服务器idrac IP地址的服务器,安装snmp监控组件</p> 
<hr> 
<hr> 
<p>&lt;3&gt;prometheus服务器需要能联通snmp_exporter</p> 
<hr> 
<hr> 
<hr> 
<h2><a id="_40"></a>组件安装</h2> 
<hr> 
<hr> 
<h3><a id="_45"></a>安装依赖</h3> 
<hr> 
<hr> 
<pre><code class="prism language-handlebars"><span class="token variable">yum</span> <span class="token variable">-y</span> <span class="token variable">install</span> <span class="token variable">gcc</span> <span class="token variable">gcc-g</span><span class="token punctuation">+</span><span class="token punctuation">+</span> <span class="token variable">make</span> <span class="token variable">net-snmp</span> <span class="token variable">net-snmp-utils</span> <span class="token variable">net-snmp-libs</span> <span class="token variable">net-snmp-devel</span> <span class="token variable">golang</span> <span class="token variable">git</span> 
</code></pre> 
<hr> 
<hr> 
<h3><a id="snmp_exporter_58"></a>snmp_exporter安装</h3> 
<hr> 
<hr> 
<p>&lt;1&gt;下载snmp_exporter</p> 
<pre><code class="prism language-handlebars"><span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">prometheus</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span><span class="token punctuation">/</span><span class="token variable">releases</span>

<span class="token variable">cd</span> <span class="token punctuation">/</span><span class="token variable">data</span>
<span class="token variable">wget</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">prometheus</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span><span class="token punctuation">/</span><span class="token variable">releases</span><span class="token punctuation">/</span><span class="token variable">download</span><span class="token punctuation">/</span><span class="token variable">v0</span><span class="token punctuation">.</span><span class="token number">20.0</span><span class="token block keyword">/snmp_exporter-</span><span class="token number">0.20</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">linux-amd64</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span>
<span class="token variable">tar</span> <span class="token variable">xf</span> <span class="token variable">snmp_exporter-</span><span class="token number">0.20</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">linux-amd64</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span>
<span class="token variable">mv</span> <span class="token variable">snmp_exporter-</span><span class="token number">0.20</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">linux-amd64</span> <span class="token variable">snmp_exporter</span>
</code></pre> 
<hr> 
<hr> 
<p>&lt;2&gt;配置启动方式</p> 
<p>根据系统版本配置启动方式,暂时不需要启动(没有生成snmp)</p> 
<pre><code class="prism language-handlebars"><span class="token variable">Centos7</span>

<span class="token variable">cat</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">lib</span><span class="token punctuation">/</span><span class="token variable">systemd</span><span class="token punctuation">/</span><span class="token variable">system</span><span class="token punctuation">/</span><span class="token variable">snmp-exporter</span><span class="token punctuation">.</span><span class="token variable">service</span> 

<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">Unit</span><span class="token punctuation">]</span></span>
<span class="token variable">Description</span><span class="token punctuation">=</span><span class="token variable">SNMP</span> <span class="token variable">exporter</span>
<span class="token variable">Documentation</span><span class="token punctuation">=</span><span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">prometheus</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span>


<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">Service</span><span class="token punctuation">]</span></span>
<span class="token variable">ExecStart</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span> <span class="token punctuation">\</span>
<span class="token variable">--config</span><span class="token punctuation">.</span><span class="token variable">file</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span><span class="token punctuation">/</span><span class="token variable">snmp</span><span class="token punctuation">.</span><span class="token variable">yml</span> <span class="token punctuation">\</span>
<span class="token variable">--web</span><span class="token punctuation">.</span><span class="token variable">listen-address</span><span class="token punctuation">=</span><span class="token punctuation">:</span><span class="token number">9116</span> <span class="token punctuation">\</span>
<span class="token variable">--snmp</span><span class="token punctuation">.</span><span class="token variable">wrap-large-counters</span>
<span class="token variable">ExecReload</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">bin</span><span class="token punctuation">/</span><span class="token variable">kill</span> <span class="token variable">-HUP</span> <span class="token variable">$MAINPID</span>
<span class="token variable">KillMode</span><span class="token punctuation">=</span><span class="token variable">process</span>
<span class="token variable">Restart</span><span class="token punctuation">=</span><span class="token variable">on-failure</span>

<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">Install</span><span class="token punctuation">]</span></span>
<span class="token variable">WantedBy</span><span class="token punctuation">=</span><span class="token variable">multi-user</span><span class="token punctuation">.</span><span class="token variable">target</span>


<span class="token variable">管理方式</span><span class="token punctuation">:</span>
<span class="token variable">systemctl</span> <span class="token variable">daemon-reload</span>
<span class="token variable">systemctl</span> <span class="token variable">enable</span> <span class="token variable">snmp-exporter</span>
<span class="token variable">systemctl</span> <span class="token variable">restart</span> <span class="token variable">snmp-exporter</span>
<span class="token variable">systemctl</span> <span class="token variable">status</span> <span class="token variable">snmp-exporter</span>
<span class="token variable">systemctl</span> <span class="token variable">stop</span> <span class="token variable">snmp-exporter</span>
</code></pre> 
<pre><code class="prism language-handlebars"><span class="token variable">Centos6</span>

<span class="token variable">cat</span> <span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">init</span><span class="token punctuation">.</span><span class="token variable">d</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span> 
<span class="token punctuation">#</span><span class="token punctuation">!</span><span class="token punctuation">/</span><span class="token variable">bin</span><span class="token punctuation">/</span><span class="token variable">bash</span>

<span class="token punctuation">#</span> <span class="token variable">chkconfig</span><span class="token punctuation">:</span> <span class="token number">2345</span> <span class="token number">80</span> <span class="token number">80</span>
<span class="token punctuation">#</span> <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token variable">Start</span> <span class="token variable">and</span> <span class="token variable">Stop</span> <span class="token variable">snmp_exporter</span>
<span class="token punctuation">#</span> <span class="token variable">Source</span> <span class="token variable">function</span> <span class="token variable">library</span><span class="token punctuation">.</span>

<span class="token punctuation">.</span> <span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">init</span><span class="token punctuation">.</span><span class="token variable">d</span><span class="token punctuation">/</span><span class="token variable">functions</span>

<span class="token variable">prog_name</span><span class="token punctuation">=</span><span class="token string">"snmp_exporter"</span>
<span class="token variable">prog_path</span><span class="token punctuation">=</span><span class="token string">"/data/${prog_name}"</span>
<span class="token variable">pidfile</span><span class="token punctuation">=</span><span class="token string">"/var/run/${prog_name}.pid"</span>
<span class="token variable">prog_logs</span><span class="token punctuation">=</span><span class="token string">"/data/${prog_name}/${prog_name}.log"</span>
<span class="token variable">options</span><span class="token punctuation">=</span><span class="token string">"--config.file=/data/snmp_exporter/snmp.yml --web.listen-address=:9116 --snmp.wrap-large-counters"</span>
<span class="token variable">DESC</span><span class="token punctuation">=</span><span class="token string">"snmp_exporter"</span>

<span class="token punctuation">[</span> <span class="token variable">-x</span> <span class="token string">"${prog_path}"</span> <span class="token punctuation">]</span> <span class="token punctuation">|</span><span class="token punctuation">|</span> <span class="token variable">exit</span> <span class="token number">1</span>

<span class="token variable">RETVAL</span><span class="token punctuation">=</span><span class="token number">0</span>

<span class="token variable">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token variable">action</span> <span class="token variable">$</span><span class="token string">"Starting $DESC..."</span> <span class="token variable">su</span> <span class="token variable">-s</span> <span class="token punctuation">/</span><span class="token variable">bin</span><span class="token punctuation">/</span><span class="token variable">sh</span> <span class="token variable">-c</span> <span class="token string">"nohup $prog_path $options &gt;&gt; $prog_logs 2&gt;&amp;1 &amp;"</span> <span class="token number">2</span><span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token variable">null</span>
<span class="token variable">RETVAL</span><span class="token punctuation">=</span><span class="token variable">$?</span>
<span class="token variable">PID</span><span class="token punctuation">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token variable">pidof</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">prog_path</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token punctuation">!</span> <span class="token variable">-z</span> <span class="token string">"${PID}"</span> <span class="token punctuation">]</span> <span class="token punctuation">&amp;</span><span class="token punctuation">&amp;</span> <span class="token variable">echo</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">PID</span><span class="token punctuation">}</span> <span class="token punctuation">&gt;</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">pidfile</span><span class="token punctuation">}</span>
<span class="token variable">echo</span>
<span class="token punctuation">[</span> <span class="token variable">$RETVAL</span> <span class="token variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">&amp;</span><span class="token punctuation">&amp;</span> <span class="token variable">touch</span> <span class="token punctuation">/</span><span class="token variable">var</span><span class="token punctuation">/</span><span class="token variable">lock</span><span class="token punctuation">/</span><span class="token variable">subsys</span><span class="token punctuation">/</span><span class="token variable">$prog_name</span>
<span class="token variable">return</span> <span class="token variable">$RETVAL</span>
<span class="token punctuation">}</span>

<span class="token variable">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token variable">echo</span> <span class="token variable">-n</span> <span class="token variable">$</span><span class="token string">"Shutting down $prog_name: "</span>
<span class="token variable">killproc</span> <span class="token variable">-p</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">pidfile</span><span class="token punctuation">}</span>
<span class="token variable">RETVAL</span><span class="token punctuation">=</span><span class="token variable">$?</span>
<span class="token variable">echo</span>
<span class="token punctuation">[</span> <span class="token variable">$RETVAL</span> <span class="token variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">&amp;</span><span class="token punctuation">&amp;</span> <span class="token variable">rm</span> <span class="token variable">-f</span> <span class="token punctuation">/</span><span class="token variable">var</span><span class="token punctuation">/</span><span class="token variable">lock</span><span class="token punctuation">/</span><span class="token variable">subsys</span><span class="token punctuation">/</span><span class="token variable">$prog_name</span>
<span class="token variable">return</span> <span class="token variable">$RETVAL</span>
<span class="token punctuation">}</span>

<span class="token variable">restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token variable">stop</span>
<span class="token variable">start</span>
<span class="token punctuation">}</span>

<span class="token variable">case</span> <span class="token string">"$1"</span> <span class="token variable">in</span>
<span class="token variable">start</span><span class="token punctuation">)</span>
<span class="token variable">start</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token variable">stop</span><span class="token punctuation">)</span>
<span class="token variable">stop</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token variable">restart</span><span class="token punctuation">)</span>
<span class="token variable">restart</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token variable">status</span><span class="token punctuation">)</span>
<span class="token variable">status</span> <span class="token variable">$prog_path</span>
<span class="token variable">RETVAL</span><span class="token punctuation">=</span><span class="token variable">$?</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token punctuation">*</span><span class="token punctuation">)</span>
<span class="token variable">echo</span> <span class="token variable">$</span><span class="token string">"Usage: $0 {start|stop|restart|status}"</span>
<span class="token variable">RETVAL</span><span class="token punctuation">=</span><span class="token number">1</span>
<span class="token variable">esac</span>

<span class="token variable">------------------------------------------------------------</span>
<span class="token variable">cat</span>  <span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">sysconfig</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span>
<span class="token variable">ARGS</span><span class="token punctuation">=</span><span class="token string">""</span>



<span class="token variable">------------------------------------------------------------</span>
<span class="token variable">管理方式</span><span class="token punctuation">:</span>
<span class="token variable">chmod</span> <span class="token punctuation">+</span><span class="token variable">x</span> <span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">init</span><span class="token punctuation">.</span><span class="token variable">d</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span>
<span class="token variable">chkconfig</span> <span class="token variable">snmp_exporter</span> <span class="token variable">on</span>
<span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">init</span><span class="token punctuation">.</span><span class="token variable">d</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span> <span class="token variable">restart</span>
</code></pre> 
<hr> 
<hr> 
<hr> 
<h2><a id="mibssnmpyml_197"></a>mibs下载并生成snmp.yml</h2> 
<hr> 
<hr> 
<h3><a id="MIBOID_202"></a>MIB与OID</h3> 
<hr> 
<hr> 
<p>OID是SNMP代理提供的用于唯一标识一个对象或者信息的id,1.3.6.1.4.1.4413.1.3.2.1.17这样一串数字<br> MIB是按树结构存放了OID对应信息的数据库</p> 
<hr> 
<hr> 
<p>&lt;1&gt;下载适合自己服务器型号的mib,查看兼容的系统</p> 
<p>https://www.dell.com/support/search/zh-cn#q=mibs&amp;sort=relevancy&amp;f:langFacet=[zh]</p> 
<p><img src="https://images2.imgbox.com/68/a8/BA0cyzC3_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-handlebars"><span class="token variable">wget</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">dl</span><span class="token punctuation">.</span><span class="token variable">dell</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">FOLDER06009600M</span><span class="token punctuation">/</span><span class="token number">1</span><span class="token block keyword">/Dell-OM-MIBS-</span><span class="token number">940</span><span class="token variable">_A00</span><span class="token punctuation">.</span><span class="token variable">zip</span>
<span class="token variable">unzip</span> <span class="token variable">Dell-OM-MIBS-</span><span class="token number">940</span><span class="token variable">_A00</span><span class="token punctuation">.</span><span class="token variable">zip</span>

</code></pre> 
<hr> 
<hr> 
<p>&lt;2&gt;查看OID</p> 
<pre><code class="prism language-handlebars"><span class="token variable">snmptranslate</span> <span class="token variable">-Tz</span> <span class="token variable">-m</span> <span class="token punctuation">/</span><span class="token variable">root</span><span class="token punctuation">/</span><span class="token variable">support</span><span class="token punctuation">/</span><span class="token variable">station</span><span class="token punctuation">/</span><span class="token variable">mibs</span><span class="token punctuation">/</span><span class="token variable">iDRAC-SMIv2</span><span class="token punctuation">.</span><span class="token variable">mib</span>
<span class="token variable">cp</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">share</span><span class="token punctuation">/</span><span class="token variable">snmp</span><span class="token punctuation">/</span><span class="token variable">mibs</span><span class="token punctuation">/</span><span class="token variable">SNMPv2-SMI</span><span class="token punctuation">.</span><span class="token variable">txt</span> <span class="token punctuation">/</span><span class="token variable">root</span><span class="token punctuation">/</span><span class="token variable">support</span><span class="token punctuation">/</span><span class="token variable">station</span><span class="token punctuation">/</span><span class="token variable">mibs</span><span class="token punctuation">/</span>
</code></pre> 
<hr> 
<hr> 
<p>&lt;3&gt;生成snmp.yml</p> 
<pre><code class="prism language-handlebars"><span class="token variable">官方地址</span><span class="token punctuation">:</span>
<span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">prometheus</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span><span class="token punctuation">/</span><span class="token variable">tree</span><span class="token punctuation">/</span><span class="token variable">main</span><span class="token punctuation">/</span><span class="token variable">generator</span><span class="token punctuation">#</span><span class="token variable">file-format</span>

<span class="token punctuation">#</span> <span class="token variable">配置变量</span>
<span class="token variable">export</span> <span class="token variable">GO111MODULE</span><span class="token punctuation">=</span><span class="token variable">on</span>
<span class="token variable">export</span> <span class="token variable">GOPROXY</span><span class="token punctuation">=</span><span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">mirrors</span><span class="token punctuation">.</span><span class="token variable">aliyun</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">goproxy</span><span class="token punctuation">/</span>
<span class="token variable">export</span> <span class="token variable">MIBDIRS</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">root</span><span class="token punctuation">/</span><span class="token variable">support</span><span class="token punctuation">/</span><span class="token variable">station</span><span class="token punctuation">/</span><span class="token variable">mibs</span><span class="token punctuation">/</span>

<span class="token punctuation">#</span><span class="token variable">拉取generator</span>
<span class="token variable">go</span> <span class="token variable">get</span> <span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">prometheus</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span><span class="token punctuation">/</span><span class="token variable">generator</span>
<span class="token variable">cd</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">GOPATH-$HOME</span><span class="token punctuation">/</span><span class="token variable">go</span><span class="token punctuation">}</span><span class="token punctuation">/</span><span class="token variable">pkg</span><span class="token punctuation">/</span><span class="token variable">mod</span><span class="token punctuation">/</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">prometheus</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span><span class="token punctuation">@</span><span class="token variable">v0</span><span class="token punctuation">.</span><span class="token number">20.0</span><span class="token block keyword">/generator</span>
<span class="token variable">go</span> <span class="token variable">build</span>


<span class="token punctuation">#</span><span class="token variable">编辑generator</span><span class="token punctuation">.</span><span class="token variable">yml</span>
<span class="token punctuation">(</span><span class="token variable">community要设置为你idrac的snmp团体名</span><span class="token punctuation">)</span>

<span class="token variable">vim</span> <span class="token variable">generator</span><span class="token punctuation">.</span><span class="token variable">yml</span>

<span class="token variable">modules</span><span class="token punctuation">:</span>
  <span class="token variable">idrac</span><span class="token punctuation">:</span>
    <span class="token variable">walk</span><span class="token punctuation">:</span>
      <span class="token variable">-</span> <span class="token number">1.3</span><span class="token number">.6</span><span class="token number">.1</span>
    <span class="token variable">version</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token variable">timeout</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token variable">s</span>
    <span class="token variable">auth</span><span class="token punctuation">:</span>
      <span class="token variable">community</span><span class="token punctuation">:</span> <span class="token variable">public</span>

<span class="token punctuation">#</span><span class="token variable">生成监控指标</span>
<span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">generator</span> <span class="token variable">generate</span>
<span class="token variable">cp</span> <span class="token variable">-r</span> <span class="token variable">snmp</span><span class="token punctuation">.</span><span class="token variable">yml</span> <span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span><span class="token punctuation">/</span>
</code></pre> 
<hr> 
<hr> 
<p>&lt;4&gt;启动snmp_exporter</p> 
<pre><code class="prism language-handlebars"><span class="token variable">systemctl</span> <span class="token variable">restart</span> <span class="token variable">snmp-exporter</span>
<span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">init</span><span class="token punctuation">.</span><span class="token variable">d</span><span class="token punctuation">/</span><span class="token variable">snmp_exporter</span> <span class="token variable">restart</span>
</code></pre> 
<hr> 
<hr> 
<p>&lt;5&gt;测试指标抓取是否正常</p> 
<p>http://snmp_exporter的IP:9116</p> 
<p><img src="https://images2.imgbox.com/74/c7/2bD1P923_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-handlebars"><span class="token variable">备注</span><span class="token punctuation">:</span>
<span class="token variable">Target填入要抓取的服务器的远程管理卡ip</span><span class="token punctuation">,</span><span class="token variable">服务器内部配置的网卡的ip无效</span> 
<span class="token variable">Module</span><span class="token punctuation">:</span><span class="token variable">填入该snmp的模块</span><span class="token punctuation">,</span><span class="token variable">snmp</span><span class="token punctuation">.</span><span class="token variable">yml文件中walk上面</span>
<span class="token variable">如果你部分的服务器snmp的密码是其他的</span><span class="token punctuation">,</span><span class="token variable">建议拷贝一个新的snmp文件</span><span class="token punctuation">,</span><span class="token variable">修改文件最末尾的community</span><span class="token punctuation">:</span> <span class="token variable">xxx</span>

</code></pre> 
<pre><code class="prism language-handlebars"><span class="token variable">cat</span> <span class="token variable">snmp</span><span class="token punctuation">.</span><span class="token variable">yml</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/53/6a/HDA8zCj1_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/7f/60/3CAAIrNP_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<hr> 
<hr> 
<h2><a id="Prometheus_319"></a>Prometheus配置</h2> 
<hr> 
<hr> 
<p>prometheus不管用什么方式,如果安装了就不需要再次安装了,重点是 prometheus.yml中添加一段idrac配置<br> 可能以后再写prometheus监控及报警相关文档</p> 
<hr> 
<hr> 
<h3><a id="prometheus_328"></a>prometheus配置</h3> 
<hr> 
<hr> 
<p>&lt;1&gt;配置从何处读取报警规则</p> 
<pre><code class="prism language-handlebars"><span class="token punctuation">#</span> <span class="token variable">Load</span> <span class="token variable">rules</span> <span class="token variable">once</span> <span class="token variable">and</span> <span class="token variable">periodically</span> <span class="token variable">evaluate</span> <span class="token variable">them</span> <span class="token variable">according</span> <span class="token variable">to</span> <span class="token variable">the</span> <span class="token variable">global</span> <span class="token string">'evaluation_interval'</span><span class="token punctuation">.</span>
<span class="token variable">rule_files</span><span class="token punctuation">:</span>
    <span class="token variable">-</span> <span class="token string">"rule/*.yml"</span>  
  <span class="token punctuation">#</span> <span class="token variable">-</span> <span class="token string">"second_rules.yml"</span>

</code></pre> 
<pre><code class="prism language-handlebars"><span class="token variable">创建报警规则的目录</span><span class="token punctuation">,</span><span class="token variable">在目录中写入报警规则的文件</span>
<span class="token variable">mkdir</span> <span class="token variable">rule</span>
<span class="token variable">vim</span> <span class="token variable">idrac</span><span class="token punctuation">.</span><span class="token variable">yml</span>
</code></pre> 
<hr> 
<hr> 
<p>&lt;2&gt;配置job,设置要收集或排除的指标</p> 
<pre><code class="prism language-handlebars"><span class="token variable">方式一</span>
<span class="token variable">static_configs方式</span>

<span class="token variable">-</span> <span class="token variable">job_name</span><span class="token punctuation">:</span> <span class="token string">'IDRAC'</span>
  <span class="token variable">scrape_interval</span><span class="token punctuation">:</span> <span class="token number">180</span><span class="token variable">s</span>             <span class="token punctuation">#</span><span class="token variable">抓取数据的间隔</span>
  <span class="token variable">scrape_timeout</span><span class="token punctuation">:</span> <span class="token number">180</span><span class="token variable">s</span>              <span class="token punctuation">#</span><span class="token variable">抓取数据的超时时间</span>
  <span class="token variable">static_configs</span><span class="token punctuation">:</span>
    <span class="token variable">-</span> <span class="token variable">targets</span><span class="token punctuation">:</span>
        <span class="token variable">-</span> <span class="token number">123.123</span><span class="token number">.123</span><span class="token number">.123</span>           <span class="token block keyword">#要监控的idrac</span> <span class="token variable">ip</span><span class="token punctuation">,</span><span class="token variable">默认snmp端口</span><span class="token number">161</span>
<span class="token punctuation">#</span>       <span class="token variable">-</span> <span class="token number">123.123</span><span class="token number">.123</span><span class="token number">.123</span><span class="token punctuation">:</span><span class="token number">161</span>       <span class="token block keyword">#如果是其他端口,也可以加端口</span>
<span class="token punctuation">#</span>      <span class="token variable">labels</span><span class="token punctuation">:</span>                      <span class="token punctuation">#</span><span class="token variable">labels可根据需求添加标签</span><span class="token punctuation">,</span><span class="token variable">例如该idrac对应的内部ip</span><span class="token punctuation">,</span><span class="token variable">工作机房等</span>
<span class="token punctuation">#</span>        <span class="token variable">IP</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span>
<span class="token punctuation">#</span>        <span class="token variable">project</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span>
  <span class="token variable">metrics_path</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">snmp</span>
  <span class="token variable">params</span><span class="token punctuation">:</span>
    <span class="token variable">module</span><span class="token punctuation">:</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">dell</span><span class="token punctuation">]</span></span>                  <span class="token punctuation">#</span>
  <span class="token variable">relabel_configs</span><span class="token punctuation">:</span>
    <span class="token variable">-</span> <span class="token variable">source_labels</span><span class="token punctuation">:</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">__address__</span><span class="token punctuation">]</span></span>
      <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">__param_target</span>
    <span class="token variable">-</span> <span class="token variable">source_labels</span><span class="token punctuation">:</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">__param_target</span><span class="token punctuation">]</span></span>
      <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">instance</span>
    <span class="token variable">-</span> <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">__address__</span>
      <span class="token variable">replacement</span><span class="token punctuation">:</span> <span class="token variable">xxxxx</span><span class="token punctuation">:</span><span class="token number">9116</span>      <span class="token block keyword">#你的snmp_exporter服务器</span>


<span class="token variable">该模式特点</span><span class="token punctuation">,</span><span class="token variable">要监控哪几台就需要在targets添加几台</span><span class="token punctuation">.</span><span class="token variable">如果是几百台会导致prometheus</span><span class="token punctuation">.</span><span class="token variable">yml文件行数特别多</span>
</code></pre> 
<hr> 
<hr> 
<pre><code class="prism language-handlebars"><span class="token variable">方式二</span>
<span class="token variable">file_sd_configs方式</span>


  <span class="token variable">-</span> <span class="token variable">job_name</span><span class="token punctuation">:</span> <span class="token string">"IDRAC"</span>
    <span class="token variable">params</span><span class="token punctuation">:</span>
      <span class="token variable">module</span><span class="token punctuation">:</span> 
      <span class="token variable">-</span> <span class="token variable">idrac</span>
    <span class="token variable">scrape_interval</span><span class="token punctuation">:</span> <span class="token number">180</span><span class="token variable">s</span>              
    <span class="token variable">scrape_timeout</span><span class="token punctuation">:</span> <span class="token number">180</span><span class="token variable">s</span>
    <span class="token variable">metrics_path</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">snmp</span>
    <span class="token variable">file_sd_configs</span><span class="token punctuation">:</span>
      <span class="token variable">-</span> <span class="token variable">files</span><span class="token punctuation">:</span>
        <span class="token variable">-</span> <span class="token variable">targets</span><span class="token punctuation">/</span><span class="token punctuation">*</span><span class="token punctuation">.</span><span class="token variable">json</span>               <span class="token punctuation">#</span><span class="token variable">读取json文件</span><span class="token punctuation">,</span><span class="token variable">目录名称任意</span><span class="token punctuation">,</span><span class="token variable">但是得创建</span>
        <span class="token variable">refresh_interval</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token variable">m</span>           <span class="token punctuation">#</span><span class="token variable">该文件载入时间</span><span class="token punctuation">,</span><span class="token variable">多长时间载入一次</span>
    <span class="token variable">relabel_configs</span><span class="token punctuation">:</span>
     <span class="token variable">-</span> <span class="token variable">source_labels</span><span class="token punctuation">:</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">__address__</span><span class="token punctuation">]</span></span>
       <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">__param_target</span>
     <span class="token variable">-</span> <span class="token variable">source_labels</span><span class="token punctuation">:</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">__param_target</span><span class="token punctuation">]</span></span>
       <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">instance</span>
     <span class="token variable">-</span> <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">__address__</span>
       <span class="token variable">replacement</span><span class="token punctuation">:</span> <span class="token variable">xxxx</span><span class="token punctuation">:</span><span class="token number">9116</span>         <span class="token block keyword">#你的snmp_exporter服务器</span>   




<span class="token variable">该模式特点</span><span class="token punctuation">,</span><span class="token variable">需要创建json文件</span><span class="token punctuation">,</span><span class="token variable">监控项写入json文件</span><span class="token punctuation">,</span><span class="token variable">json格式如下</span><span class="token punctuation">:</span>
<span class="token variable">cat</span> <span class="token variable">targets</span><span class="token punctuation">/</span><span class="token variable">idrac</span><span class="token punctuation">.</span><span class="token variable">json</span>

<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string">"targets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">"123.123.123.123:161"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"labels"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"IP"</span><span class="token punctuation">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>
      <span class="token string">"Project"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string">"targets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">"123.123.123.124:161"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"labels"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"IP"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>
      <span class="token string">"Project"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token variable">or</span>

<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string">"targets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">"123.123.123.123:161"</span><span class="token punctuation">,</span>
      <span class="token string">"123.123.123.124:161"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"labels"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"IP"</span><span class="token punctuation">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>
      <span class="token string">"Project"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre> 
<hr> 
<hr> 
<pre><code class="prism language-handlebars"><span class="token variable">方式三</span>
<span class="token variable">consul_sd_file方式</span>
<span class="token variable">该方式是将监控注册到consul服务中</span><span class="token punctuation">,</span><span class="token variable">prometheus通过consul实现服务的自动发现</span>
<span class="token variable">这里就不详细介绍consul</span><span class="token punctuation">,</span><span class="token variable">没有使用过consul和配置过prometheus报警的暂时不建议看这个方式</span><span class="token punctuation">,</span><span class="token variable">不容易理解</span>


  <span class="token variable">-</span> <span class="token variable">job_name</span><span class="token punctuation">:</span> <span class="token string">'IDRAC'</span>
    <span class="token variable">params</span><span class="token punctuation">:</span>
      <span class="token variable">module</span><span class="token punctuation">:</span>
      <span class="token variable">-</span> <span class="token variable">idrac</span>
    <span class="token variable">scrape_interval</span><span class="token punctuation">:</span> <span class="token number">180</span><span class="token variable">s</span>
    <span class="token variable">scrape_timeout</span><span class="token punctuation">:</span> <span class="token number">180</span><span class="token variable">s</span>
    <span class="token variable">metrics_path</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">snmp</span>
    <span class="token variable">consul_sd_configs</span><span class="token punctuation">:</span>
    <span class="token variable">-</span> <span class="token variable">server</span><span class="token punctuation">:</span> <span class="token string">'monitor-consul.com:8500'</span>           <span class="token block keyword">#这个是你consul服务的域名,也可直接填入ip</span>
      <span class="token variable">tag_separator</span><span class="token punctuation">:</span> <span class="token string">','</span>
      <span class="token variable">services</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">relabel_configs</span><span class="token punctuation">:</span>
      <span class="token variable">-</span> <span class="token variable">source_labels</span><span class="token punctuation">:</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">__meta_consul_tags</span><span class="token punctuation">]</span></span>
        <span class="token variable">regex</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">*</span><span class="token variable">idrac</span><span class="token punctuation">.</span><span class="token punctuation">*</span>                          <span class="token punctuation">#</span><span class="token variable">这个是将你consul打的tags中符合该正则的指标归类到该Job</span>
        <span class="token variable">action</span><span class="token punctuation">:</span> <span class="token variable">keep</span>
      <span class="token variable">-</span> <span class="token variable">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'__meta_consul_service_metadata_eth-ip'</span><span class="token punctuation">]</span>     <span class="token punctuation">#</span><span class="token variable">这个是你consul打的标签</span><span class="token punctuation">,</span><span class="token variable">在prometheus</span> <span class="token variable">-</span><span class="token punctuation">&gt;</span> <span class="token variable">Targets</span> <span class="token variable">-</span><span class="token punctuation">&gt;</span> <span class="token variable">IDRAC</span> <span class="token variable">-</span><span class="token punctuation">&gt;</span><span class="token variable">Endpoint展示出来</span>
        <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">__param_target</span>            
      <span class="token variable">-</span> <span class="token variable">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'__meta_consul_service_address'</span><span class="token punctuation">]</span>
        <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">instance</span>
      <span class="token variable">-</span> <span class="token variable">target_label</span><span class="token punctuation">:</span> <span class="token variable">__address__</span>
        <span class="token variable">replacement</span><span class="token punctuation">:</span> <span class="token variable">xxx</span><span class="token punctuation">:</span><span class="token number">9116</span>



<span class="token variable">该模式特点</span><span class="token punctuation">,</span><span class="token variable">需要将服务注册到consul</span><span class="token punctuation">,</span><span class="token variable">有静态和文件两种注册方式</span><span class="token punctuation">:</span>
<span class="token variable">json示例如下</span><span class="token punctuation">,</span><span class="token variable">根据需求写自己的</span><span class="token punctuation">(</span><span class="token variable">标签随意</span><span class="token punctuation">,</span><span class="token variable">但要符合你报警的钉钉群的关键字</span><span class="token punctuation">,</span><span class="token variable">符合alertmanger相关配置</span><span class="token punctuation">)</span>



<span class="token variable">cat</span> <span class="token variable">consul-idrac</span><span class="token punctuation">.</span><span class="token variable">json</span> 
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"ID"</span><span class="token punctuation">:</span> <span class="token string">"IDRAC-xxx"</span><span class="token punctuation">,</span>
  <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"IDARC-xxx"</span><span class="token punctuation">,</span>
  <span class="token string">"Tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">"idrac"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"Address"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                                  <span class="token punctuation">#</span><span class="token variable">IDRAC</span> <span class="token variable">IP</span>
  <span class="token string">"Meta"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>                                          <span class="token punctuation">#</span><span class="token variable">consul里的标签</span><span class="token punctuation">,</span><span class="token variable">之后标签会重写成prometheus的标签</span>
	<span class="token string">"eth-ip"</span><span class="token punctuation">:</span><span class="token string">"xxx"</span><span class="token punctuation">,</span>                                  <span class="token punctuation">#</span><span class="token variable">服务器业务ip</span>
	<span class="token string">"project"</span><span class="token punctuation">:</span><span class="token string">"beijing"</span>                              <span class="token block keyword">#所在地</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"EnableTagOverride"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">"Check"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
	  <span class="token string">"HTTP"</span><span class="token punctuation">:</span> <span class="token string">"http://xxxx:9116/metrics"</span><span class="token punctuation">,</span>            <span class="token punctuation">#</span><span class="token variable">你的snmp服务器IP和端口</span><span class="token punctuation">.</span><span class="token variable">健康检查</span>
      <span class="token string">"Interval"</span><span class="token punctuation">:</span> <span class="token string">"10s"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"Weights"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Passing"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string">"Warning"</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token variable">说明</span><span class="token punctuation">:</span><span class="token variable">由于健康检查使用的是snmp_exporter实际上检查的是snmp_exporter</span><span class="token punctuation">,</span><span class="token variable">因此哪怕前面的IP等内容是错误的</span><span class="token punctuation">,</span><span class="token variable">consul状态也是正常</span><span class="token punctuation">.</span><span class="token variable">不过不影响prometheus去监控</span><span class="token punctuation">,</span><span class="token variable">服务注册到consul后</span><span class="token punctuation">,</span><span class="token variable">它只是从consul获取服务的值和标签</span><span class="token punctuation">,</span><span class="token variable">然后prometheus再根据自己的配置去进行监控</span><span class="token punctuation">.</span><span class="token variable">对于snmp适合第二种json</span>

<span class="token variable">or</span>
<span class="token variable">cat</span> <span class="token variable">consul-idrac2</span><span class="token punctuation">.</span><span class="token variable">json</span>

<span class="token punctuation">{<!-- --></span>
  <span class="token string">"ID"</span><span class="token punctuation">:</span> <span class="token string">"IDRAC-xxx"</span><span class="token punctuation">,</span>
  <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"IDARC-xxx"</span><span class="token punctuation">,</span>
  <span class="token string">"Tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">"idrac"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"Address"</span><span class="token punctuation">:</span> <span class="token string">"xxx:161"</span><span class="token punctuation">,</span>
  <span class="token string">"Meta"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>                                          <span class="token punctuation">#</span><span class="token variable">consul里的标签</span><span class="token punctuation">,</span><span class="token variable">之后标签会重写成prometheus的标签</span>
	<span class="token string">"eth-ip"</span><span class="token punctuation">:</span><span class="token string">"xxx"</span><span class="token punctuation">,</span>                                  <span class="token punctuation">#</span><span class="token variable">服务器业务ip</span>
	<span class="token string">"project"</span><span class="token punctuation">:</span><span class="token string">"beijing"</span>                              <span class="token block keyword">#所在地</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>




<span class="token variable">注册</span>
<span class="token variable">curl</span> <span class="token variable">--request</span> <span class="token variable">PUT</span> <span class="token variable">--data</span> <span class="token punctuation">@</span><span class="token variable">consul-idrac</span><span class="token punctuation">.</span><span class="token variable">json</span> <span class="token variable">http</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">monitor-consul</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">:</span><span class="token number">8500</span><span class="token block keyword">/v1/agent/service/register?replace-existing-checks=</span><span class="token number">1</span>
<span class="token variable">取消注册</span>
<span class="token variable">curl</span> <span class="token variable">-X</span> <span class="token variable">PUT</span> <span class="token variable">http</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">monitor-consul</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">:</span><span class="token number">8500</span><span class="token block keyword">/v1/agent/service/deregister/IDRAC-xxx</span>
</code></pre> 
<hr> 
<hr> 
<p>效果:</p> 
<p><img src="https://images2.imgbox.com/4e/1c/YuD2ipLW_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<hr> 
<hr> 
<h3><a id="_559"></a>报警规则配置</h3> 
<hr> 
<hr> 
<p>注意你的snmp.yml中的指标,但是并不是所有的指标都可使用,可以在prometheus上搜索一下</p> 
<p><img src="https://images2.imgbox.com/5b/f1/EeMlVnRV_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e8/01/49LtOCKe_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<hr> 
<pre><code class="prism language-handlebars"><span class="token variable">cat</span> <span class="token variable">rule</span><span class="token punctuation">/</span><span class="token variable">idrac</span><span class="token punctuation">.</span><span class="token variable">yml</span> 
<span class="token variable">groups</span><span class="token punctuation">:</span>
    <span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">IDRAC-物理机硬件运行状态</span>
      <span class="token variable">rules</span><span class="token punctuation">:</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">IDRAC状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">up</span><span class="token punctuation">{<!-- --></span><span class="token variable">job</span><span class="token punctuation">=</span><span class="token punctuation">~</span><span class="token string">"IDRAC.*"</span><span class="token punctuation">}</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token number">0</span>
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} IDRAC异常"</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">机箱组件整体状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">chassisStatus</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span>
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"机箱组件总体运行状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}}机箱组件异常"</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">机箱CMOS电池整体状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">systemBatteryStatus</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span> 
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"机箱CMOS电池整体状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels}}机箱CMOS电池状态异常"</span>


      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">内存条运行状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">memoryDeviceStatus</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span>
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"内存条状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} 内存条 {<!-- -->{$labels.memoryDeviceIndex}}异常"</span>


      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">处理器CPU总体状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">processorDeviceStatusStatus</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span> 
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"处理器CPU总体状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} 处理器CPU{<!-- -->{$labels.processorDeviceStatusIndex}}异常"</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">网卡状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">networkDeviceStatus</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span> 
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} 网卡{<!-- -->{$labels.networkDeviceIndex}}异常"</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">ps电源总体状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">powerSupplyStatus</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span> 
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"ps电源总体状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} ps电源 {<!-- -->{ $labels.powerSupplyIndex }}状态异常"</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">存储控制器总体状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">globalStorageStatus</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span> 
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"存储控制器状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} 存储控制器异常"</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">物理系统组件总体状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">globalSystemStatus</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span> 
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"物理系统总体组件运行状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} 物理系统组件异常"</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">物理磁盘运行状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">physicalDiskState</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">3</span>
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"物理磁盘运行状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} 物理磁盘{<!-- -->{$labels. physicalDiskNumber}}异常"</span>

      <span class="token variable">-</span> <span class="token variable">alert</span><span class="token punctuation">:</span> <span class="token variable">虚拟磁盘运行状态</span>
        <span class="token variable">expr</span><span class="token punctuation">:</span> <span class="token variable">virtualDiskState</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">2</span>
        <span class="token variable">for</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token variable">m</span>
        <span class="token variable">labels</span><span class="token punctuation">:</span>
          <span class="token variable">status</span><span class="token punctuation">:</span> <span class="token variable">error</span>
        <span class="token variable">annotations</span><span class="token punctuation">:</span>
          <span class="token variable">summary</span><span class="token punctuation">:</span> <span class="token string">"虚拟磁盘运行状态异常请及时查看!!"</span>
          <span class="token variable">description</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{$labels.instance}} 虚拟磁盘{<!-- -->{$labels.virtualDiskNumber}}异常"</span>

</code></pre> 
<pre><code class="prism language-handlebars"><span class="token variable">重新加载prometheus</span>
<span class="token variable">curl</span> <span class="token variable">-X</span> <span class="token variable">POST</span> <span class="token variable">http</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">xxxx</span><span class="token punctuation">:</span><span class="token number">9090</span><span class="token block keyword">/-/reload</span>   <span class="token block keyword">#prometheus的IP</span>
</code></pre> 
<hr> 
<hr> 
<p>要想报警 还需要配置 报警插件Alertmanager 和 钉钉插件prometheus-webhook-dingtalk ,并在dingding群添加机器人.这里就不演示报警流程了.</p> 
<hr> 
<hr> 
<h2><a id="_697"></a>补充</h2> 
<hr> 
<hr> 
<p>关于出现snmp数据抓取的异常,需要注意几点：<br> &lt;1&gt;snmp_exporter服务器是否可访问要监控服务器的远程管理卡<br> &lt;2&gt;注册的json的IP是idrac的IP不要是服务器内部IP<br> &lt;3&gt;远程管理卡的snmp密码，是否你的snmp.yml中的community<br> &lt;4&gt;监控的超时时间需要根据网络情况调整，否则会因超时频繁报警<br> &lt;5&gt;如有大量idrac需监控，可配置多个job_name监控分流<br> &lt;6&gt;报警信息可根据需求调整，报警没的出来查看Alertmanager和prometheus-webhook-dingtalk配置</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ab63a76362c3972ac83d5cb8830fdb51/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jenkins</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9ceea012fa7efb662946053f4cc4a394/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">pip安装出现No such file or directory:‘D:\python\Lib\site-packages\pip-21.2.4.dist-info\METADAT‘</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>