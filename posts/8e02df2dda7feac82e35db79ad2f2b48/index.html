<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>二进制安装1.26版本k8s(docker) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="二进制安装1.26版本k8s(docker)" />
<meta property="og:description" content="文章目录 前言准备工作准备4台虚拟机说明下载对应的二进制包初始化操作CentOS7配置yum源配置免密、修改hostname、关闭防火墙、selinux、关闭swap分区(方便后面进行其它操作)下载软件包并批量安装配置时间同步配置打开文件描述符添加ipvs模块和内核模块 Ubuntu配置apt源配置免密、修改hostname、关闭防火墙、关闭swap分区(方便后面进行其它操作)下载软件包并批量安装配置时间同步配置打开文件描述符添加ipvs模块和内核模块 编译一个nginx做负载均衡安装容器运行时安装docker安装cri-docker 安装etcd准备etcd所需证书分发证书、二进制文件及service文件 安装k8s组件apiserver准备apiserver 证书准备metrics-server证书准备service文件分发apiserver文件并启动 kubectl准备admin证书创建kubeconfig创建 clusterrolebinding 实现 exec 进入容器权限 controller-manager准备controller-manager 证书创建kubeconfig准备service文件分发controller-manager文件并启动 scheduler准备scheduler证书创建kubeconfig准备service文件分发scheduler文件并启动 检查管理组件需要的服务是否正常kubelet准备kubelet证书创建kubeconfig准备kubelet配置文件准备service文件分发kubelet文件并启动 kube-proxy准备kube-proxy证书创建kubeconfig创建kube-proxy配置文件准备service文件分发kube-proxy文件并启动 检查是否起来 安装网络插件cni插件coredns 验证集群是否正常后记 前言 v1.24.0 - v1.26.0 之前支持docker，但是需要额外安装cri-docker来充当垫片由于工作原因作者会同时使用Ubuntu和CentOS，因此本次将两个系统的K8S安装一起记录一下(与CentOS7.9、Ubuntu2004验证)证书采用cfssl工具制作使用二进制方式部署3主1从高可用集群etcd采用二进制部署，复用3个管理节点本次还是选择docker，containerd很多命令不习惯，而且不能直接构建dockerfile本次环境为私有云环境，默认情况无法使用keepalived，因此本次部署无vip，采用nginx做负载均衡(各位可自行使用keepalived&#43;haproxy做vip来进行负载均衡)
理想拓扑图如下
准备工作 准备4台虚拟机 虚拟机建议同时使用相同操作系统并配置好正确的IP地址
# centos7网卡配置文件位置： /etc/sysconfig/network-scripts/ifcfg-eth0 或 ens33等，vim编辑完成之后重启network服务即可 # ubuntu2004网卡配置文件位置：/etc/netplan/50-cloud-init.yaml 一般是xxx.yaml文件，配置完成之后 netplan apply 生效即可 # centos8 无network服务，且centos7/8或者Ubuntu2004/2204都可以直接使用 NetworkManager服务来管理网络，可以使用nmtui类图形界面配置，也可以直接 nmcli 命令行配置 IP地址角色10.10.21.223master/worker10.10.21.224master/worker10.10.21.225master/worker10.10.21.226worker 说明 如无特殊说明，以下操作均在第一个节点进行
如果需要完全按官方给的各个软件推荐版本的话，可以先下载一个对应的kubeadm，然后命令查看镜像版本,再去下载对应版本，我这边就直接很多都给上新了
# 例如 [root@node1 ~]# kubeadm config images list W0523 17:58:43.225920 28717 version.go:104] could not fetch a Kubernetes version from the internet: unable to get URL &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8e02df2dda7feac82e35db79ad2f2b48/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-25T09:16:02+08:00" />
<meta property="article:modified_time" content="2023-05-25T09:16:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">二进制安装1.26版本k8s(docker)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_12" rel="nofollow">准备工作</a></li><li><ul><li><a href="#4_14" rel="nofollow">准备4台虚拟机</a></li><li><a href="#_32" rel="nofollow">说明</a></li><li><a href="#_51" rel="nofollow">下载对应的二进制包</a></li><li><a href="#_81" rel="nofollow">初始化操作</a></li><li><a href="#CentOS7_142" rel="nofollow">CentOS7</a></li><li><ul><li><a href="#yum_143" rel="nofollow">配置yum源</a></li><li><a href="#hostnameselinuxswap_196" rel="nofollow">配置免密、修改hostname、关闭防火墙、selinux、关闭swap分区(方便后面进行其它操作)</a></li><li><a href="#_229" rel="nofollow">下载软件包并批量安装</a></li><li><a href="#_290" rel="nofollow">配置时间同步</a></li><li><a href="#_348" rel="nofollow">配置打开文件描述符</a></li><li><a href="#ipvs_366" rel="nofollow">添加ipvs模块和内核模块</a></li></ul> 
   </li><li><a href="#Ubuntu_443" rel="nofollow">Ubuntu</a></li><li><ul><li><a href="#apt_445" rel="nofollow">配置apt源</a></li><li><a href="#hostnameswap_482" rel="nofollow">配置免密、修改hostname、关闭防火墙、关闭swap分区(方便后面进行其它操作)</a></li><li><a href="#_510" rel="nofollow">下载软件包并批量安装</a></li><li><a href="#_523" rel="nofollow">配置时间同步</a></li><li><a href="#_575" rel="nofollow">配置打开文件描述符</a></li><li><a href="#ipvs_593" rel="nofollow">添加ipvs模块和内核模块</a></li></ul> 
  </li></ul> 
  </li><li><a href="#nginx_671" rel="nofollow">编译一个nginx做负载均衡</a></li><li><a href="#_796" rel="nofollow">安装容器运行时</a></li><li><ul><li><a href="#docker_800" rel="nofollow">安装docker</a></li><li><a href="#cridocker_926" rel="nofollow">安装cri-docker</a></li></ul> 
  </li><li><a href="#etcd_997" rel="nofollow">安装etcd</a></li><li><ul><li><a href="#etcd_1048" rel="nofollow">准备etcd所需证书</a></li><li><a href="#service_1150" rel="nofollow">分发证书、二进制文件及service文件</a></li></ul> 
  </li><li><a href="#k8s_1184" rel="nofollow">安装k8s组件</a></li><li><ul><li><a href="#apiserver_1186" rel="nofollow">apiserver</a></li><li><ul><li><a href="#apiserver__1194" rel="nofollow">准备apiserver 证书</a></li><li><a href="#metricsserver_1243" rel="nofollow">准备metrics-server证书</a></li><li><a href="#service_1279" rel="nofollow">准备service文件</a></li><li><a href="#apiserver_1335" rel="nofollow">分发apiserver文件并启动</a></li></ul> 
   </li><li><a href="#kubectl_1369" rel="nofollow">kubectl</a></li><li><ul><li><a href="#admin_1371" rel="nofollow">准备admin证书</a></li><li><a href="#kubeconfig_1408" rel="nofollow">创建kubeconfig</a></li><li><a href="#_clusterrolebinding__exec__1465" rel="nofollow">创建 clusterrolebinding 实现 exec 进入容器权限</a></li></ul> 
   </li><li><a href="#controllermanager_1480" rel="nofollow">controller-manager</a></li><li><ul><li><a href="#controllermanager__1482" rel="nofollow">准备controller-manager 证书</a></li><li><a href="#kubeconfig_1521" rel="nofollow">创建kubeconfig</a></li><li><a href="#service_1566" rel="nofollow">准备service文件</a></li><li><a href="#controllermanager_1601" rel="nofollow">分发controller-manager文件并启动</a></li></ul> 
   </li><li><a href="#scheduler_1616" rel="nofollow">scheduler</a></li><li><ul><li><a href="#scheduler_1618" rel="nofollow">准备scheduler证书</a></li><li><a href="#kubeconfig_1657" rel="nofollow">创建kubeconfig</a></li><li><a href="#service_1702" rel="nofollow">准备service文件</a></li><li><a href="#scheduler_1729" rel="nofollow">分发scheduler文件并启动</a></li></ul> 
   </li><li><a href="#_1744" rel="nofollow">检查管理组件需要的服务是否正常</a></li><li><a href="#kubelet_1757" rel="nofollow">kubelet</a></li><li><ul><li><a href="#kubelet_1759" rel="nofollow">准备kubelet证书</a></li><li><a href="#kubeconfig_1803" rel="nofollow">创建kubeconfig</a></li><li><a href="#kubelet_1873" rel="nofollow">准备kubelet配置文件</a></li><li><a href="#service_1947" rel="nofollow">准备service文件</a></li><li><a href="#kubelet_1979" rel="nofollow">分发kubelet文件并启动</a></li></ul> 
   </li><li><a href="#kubeproxy_2002" rel="nofollow">kube-proxy</a></li><li><ul><li><a href="#kubeproxy_2004" rel="nofollow">准备kube-proxy证书</a></li><li><a href="#kubeconfig_2036" rel="nofollow">创建kubeconfig</a></li><li><a href="#kubeproxy_2089" rel="nofollow">创建kube-proxy配置文件</a></li><li><a href="#service_2116" rel="nofollow">准备service文件</a></li><li><a href="#kubeproxy_2144" rel="nofollow">分发kube-proxy文件并启动</a></li></ul> 
   </li><li><a href="#_2165" rel="nofollow">检查是否起来</a></li></ul> 
  </li><li><a href="#_2222" rel="nofollow">安装网络插件</a></li><li><ul><li><a href="#cni_2224" rel="nofollow">cni插件</a></li><li><a href="#coredns_2273" rel="nofollow">coredns</a></li></ul> 
  </li><li><a href="#_2505" rel="nofollow">验证集群是否正常</a></li><li><a href="#_2535" rel="nofollow">后记</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<ul><li>v1.24.0 - v1.26.0 之前支持docker，但是需要额外安装cri-docker来充当垫片</li><li>由于工作原因作者会同时使用Ubuntu和CentOS，因此本次将两个系统的K8S安装一起记录一下(与CentOS7.9、Ubuntu2004验证)</li><li>证书采用cfssl工具制作</li><li>使用二进制方式部署3主1从高可用集群</li><li>etcd采用二进制部署，复用3个管理节点</li><li>本次还是选择docker，containerd很多命令不习惯，而且不能直接构建dockerfile</li><li>本次环境为私有云环境，默认情况无法使用keepalived，因此本次部署无vip，采用nginx做负载均衡(各位可自行使用keepalived+haproxy做vip来进行负载均衡)<br> <em><strong>理想拓扑图如下</strong></em><br> <img src="https://images2.imgbox.com/f6/42/gZSgNrLK_o.png" alt="拓扑"></li></ul> 
<h2><a id="_12"></a>准备工作</h2> 
<h3><a id="4_14"></a>准备4台虚拟机</h3> 
<p><em><strong>虚拟机建议同时使用相同操作系统并配置好正确的IP地址</strong></em></p> 
<pre><code class="prism language-shell"><span class="token comment"># centos7网卡配置文件位置： /etc/sysconfig/network-scripts/ifcfg-eth0 或 ens33等，vim编辑完成之后重启network服务即可</span>
<span class="token comment"># ubuntu2004网卡配置文件位置：/etc/netplan/50-cloud-init.yaml 一般是xxx.yaml文件，配置完成之后 netplan apply 生效即可</span>

<span class="token comment"># centos8 无network服务，且centos7/8或者Ubuntu2004/2204都可以直接使用 NetworkManager服务来管理网络，可以使用nmtui类图形界面配置，也可以直接 nmcli 命令行配置</span>
</code></pre> 
<table><thead><tr><th>IP地址</th><th>角色</th></tr></thead><tbody><tr><td>10.10.21.223</td><td>master/worker</td></tr><tr><td>10.10.21.224</td><td>master/worker</td></tr><tr><td>10.10.21.225</td><td>master/worker</td></tr><tr><td>10.10.21.226</td><td>worker</td></tr></tbody></table> 
<h3><a id="_32"></a>说明</h3> 
<p><em><strong>如无特殊说明，以下操作均在第一个节点进行</strong></em></p> 
<p>如果需要完全按官方给的各个软件推荐版本的话，可以先下载一个对应的kubeadm，然后命令查看镜像版本,再去下载对应版本，我这边就直接很多都给上新了</p> 
<pre><code class="prism language-shell"><span class="token comment"># 例如</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm config images list</span>
W0523 <span class="token number">17</span>:58:43.225920   <span class="token number">28717</span> version.go:104<span class="token punctuation">]</span> could not fetch a Kubernetes version from the internet: unable to get URL <span class="token string">"https://dl.k8s.io/release/stable-1.txt"</span><span class="token builtin class-name">:</span> Get <span class="token string">"https://storage.googleapis.com/kubernetes-release/release/stable-1.txt"</span><span class="token builtin class-name">:</span> context deadline exceeded <span class="token punctuation">(</span>Client.Timeout exceeded <span class="token keyword">while</span> awaiting headers<span class="token punctuation">)</span>
W0523 <span class="token number">17</span>:58:43.225985   <span class="token number">28717</span> version.go:105<span class="token punctuation">]</span> falling back to the <span class="token builtin class-name">local</span> client version: v1.26.5
registry.k8s.io/kube-apiserver:v1.26.5
registry.k8s.io/kube-controller-manager:v1.26.5
registry.k8s.io/kube-scheduler:v1.26.5
registry.k8s.io/kube-proxy:v1.26.5
registry.k8s.io/pause:3.9
registry.k8s.io/etcd:3.5.6-0
registry.k8s.io/coredns/coredns:v1.9.3
</code></pre> 
<h3><a id="_51"></a>下载对应的二进制包</h3> 
<blockquote> 
 <p>kubernetes包可以在<strong>CHANGELOG-1.26.md</strong>找到：如1.26.5<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.26.md#server-binaries">链接</a></p> 
 <p>etcd的包也可以直接在github下载，<a href="https://github.com/etcd-io/etcd">项目地址</a>，进入Release即可下载</p> 
 <p>docker的包可以直接上docker<a href="https://download.docker.com/linux/static/stable/x86_64/" rel="nofollow">官网下载</a></p> 
 <p>cri-docker的包可以上github<a href="https://github.com/Mirantis/cri-dockerd">下载</a></p> 
 <p>cfssl工具包可以上github<a href="https://github.com/cloudflare/cfssl">下载</a></p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> /k8s/<span class="token punctuation">{<!-- --></span>service,ssl,pkg,conf<span class="token punctuation">}</span> -p     
<span class="token comment"># 创建文件夹存放后续文件，service存放service文件，ssl存放证书文件，pkg存放安装包，conf存放配置文件</span>
<span class="token builtin class-name">cd</span> /k8s/pkg 

<span class="token function">wget</span> https://dl.k8s.io/v1.26.5/kubernetes-server-linux-amd64.tar.gz
<span class="token comment"># k8s安装包</span>
<span class="token function">wget</span> https://github.com/etcd-io/etcd/releases/download/v3.5.9/etcd-v3.5.9-linux-amd64.tar.gz
<span class="token comment"># etcd安装包</span>
<span class="token function">wget</span> https://download.docker.com/linux/static/stable/x86_64/docker-23.0.6.tgz
<span class="token comment"># docker安装包</span>
<span class="token function">wget</span> https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.2/cri-dockerd-0.3.2.amd64.tgz
<span class="token comment"># cri-docker安装包</span>
<span class="token function">wget</span> https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssl_1.6.3_linux_amd64
<span class="token function">wget</span>  https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssljson_1.6.3_linux_amd64
<span class="token comment"># cfssl安装包</span>
</code></pre> 
<h3><a id="_81"></a>初始化操作</h3> 
<p><em><strong>大部分步骤只需要在管理节点1操作</strong></em><br> 记录一下规划的配置文件，避免后面写错</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/conf/k8s_env.sh</span>

# k8s节点网段,方便做chronyd对时
NODEIPS=10.10.21.0/24
# k8s集群所有节点，可以自定义名字，但是需要和后续名字一一对应,如节点超过4个，只需要加节点即可
HOSTS=(node1 node2 node3 node4)
# k8s管理节点
MASTERS=(node1 node2 node3)
# k8s工作节点
WORKS=(node1 node2 node3 node4)
# 每个节点对应的IP地址
node1=10.10.21.223
node2=10.10.21.224
node3=10.10.21.225
node4=10.10.21.226

# VIP地址+端口，可以是keepalived设置的vip，也可以是云平台申请的vip
VIP_server=127.0.0.1:8443

# 节点root密码，方便脚本自动免密
SSHPASS=666

# 配置kubectl自动补全，安装完成把这句加到需要使用kubectl的节点环境变量即可
#source &lt;(kubectl completion bash)

# 服务网段(Service CIDR)，部署前路由不可达，部署后集群内部使用IP:Port可达
SERVICE_CIDR="192.168.0.0/16"

# kubernetes服务地址，部署前路由不可达，部署后集群内部可达，需要在Service CIDR中可达，一般建议选用第1个地址
CLUSTER_KUBERNETES_IP="192.168.0.1"

# clusterDNS地址，部署前路由不可达，部署后集群内部使用IP:Port可达，需要在Service CIDR中可达，一般建议选用第10个地址
CLUSTER_KUBERNETES_SVC_IP="192.168.0.10"

# Pod 网段(Cluster CIDR)，部署前路由不可达，部署后路由可达(网络插件保证)
CLUSTER_CIDR="172.16.0.0/16"

# 服务端口范围(NodePort Range)
NODE_PORT_RANGE="30000-40000"

# etcd集群服务地址列表(默认复用3个master节点)
ETCD_ENDPOINTS="https://\<span class="token variable">$node1</span>:2379,https://\<span class="token variable">$node2</span>:2379,https://\<span class="token variable">$node3</span>:2379"

# etcd集群服务地址列表(默认复用3个master节点)
ETCD_CLUSTERS="node1=https://\<span class="token variable">$node1</span>:2380,node2=https://\<span class="token variable">$node2</span>:2380,node3=https://\<span class="token variable">$node3</span>:2380"

# k8s证书路径
K8S_SSL_Path=/etc/kubernetes/pki

EOF</span>

<span class="token punctuation">\</span>cp  /k8s/conf/k8s_env.sh /etc/profile.d/
<span class="token builtin class-name">source</span> /etc/profile
<span class="token comment"># 执行了这步的话，后面可以不用再多次source了</span>
</code></pre> 
<h3><a id="CentOS7_142"></a>CentOS7</h3> 
<h4><a id="yum_143"></a>配置yum源</h4> 
<ul><li>配置基础yum源(后续安装基础软件包)</li></ul> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> /opt/yum_bak <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> /etc/yum.repos.d/* /opt/yum_bak/    <span class="token comment"># 备份原有的repo</span>
<span class="token function">curl</span> -o /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo
<span class="token comment"># 配置基础源</span>
yum -y <span class="token function">install</span> epel-release
<span class="token function">sed</span> -i <span class="token string">"s/#baseurl/baseurl/g"</span> /etc/yum.repos.d/epel.repo
<span class="token function">sed</span> -i <span class="token string">"s/metalink/#metalink/g"</span> /etc/yum.repos.d/epel.repo
<span class="token function">sed</span> -i <span class="token string">"s@https\?://download.fedoraproject.org/pub@https://repo.huaweicloud.com@g"</span> /etc/yum.repos.d/epel.repo
<span class="token comment"># 配置epel源</span>
</code></pre> 
<ul><li>添加启用源(后续更新内核)</li></ul> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm -y 
<span class="token function">sed</span> -i <span class="token string">"s@mirrorlist@#mirrorlist@g"</span> /etc/yum.repos.d/elrepo.repo 
<span class="token function">sed</span> -i <span class="token string">"s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g"</span> /etc/yum.repos.d/elrepo.repo 
</code></pre> 
<ul><li><s>添加docker源(用于安装docker</s>(二进制安装docker，可以省略，如果是yum安装需要进行)</li></ul> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> -y yum-utils device-mapper-persistent-data lvm2
<span class="token function">curl</span> -o /etc/yum.repos.d/docker-ce.repo https://repo.huaweicloud.com/docker-ce/linux/centos/docker-ce.repo

<span class="token function">sed</span> -i <span class="token string">'s+download.docker.com+repo.huaweicloud.com/docker-ce+'</span> /etc/yum.repos.d/docker-ce.repo
</code></pre> 
<ul><li><s>添加k8s源(用于安装kubeadm、kubelet、kubectl</s>(二进制安装k8s可以省略，如果是yum安装需要进行)</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo </span>
[kubernetes] 
name=Kubernetes 
baseurl=https://repo.huaweicloud.com/kubernetes/yum/repos/kubernetes-el7-\<span class="token variable">$basearch</span> 
enabled=1 
gpgcheck=1
repo_gpgcheck=0
gpgkey=https://repo.huaweicloud.com/kubernetes/yum/doc/yum-key.gpg https://repo.huaweicloud.com/kubernetes/yum/doc/rpm-package-key.gpg 
EOF</span>
<span class="token comment"># 提示 若您使用的yum中变量 $basearch 无法解析, 请把第二步配置文件中的$basearch修改为相应系统架构(aarch64/armhfp/ppc64le/s390x/x86_64).</span>
</code></pre> 
<ul><li>建立yum缓存</li></ul> 
<pre><code class="prism language-shell">yum clean all <span class="token operator">&amp;&amp;</span> yum makecache fast
</code></pre> 
<h4><a id="hostnameselinuxswap_196"></a>配置免密、修改hostname、关闭防火墙、selinux、关闭swap分区(方便后面进行其它操作)</h4> 
<ul><li>修改hosts文件</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> <span class="token builtin class-name">echo</span> <span class="token string">"$"</span>$host<span class="token variable">)</span></span> <span class="token variable">$host</span>"</span> <span class="token operator">&gt;&gt;</span> /etc/hosts<span class="token punctuation">;</span><span class="token keyword">done</span>
<span class="token builtin class-name">echo</span> <span class="token string">"VIP <span class="token variable">$VIP</span>"</span>  <span class="token operator">&gt;&gt;</span> /etc/hosts
<span class="token comment"># 执行本命令之前记得先修改配置文件/k8s/conf/k8s_env.sh</span>
</code></pre> 
<ul><li>修改hostname、关闭防火墙、selinux、关闭swap分区</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
yum -y <span class="token function">install</span> sshpass
ssh-keygen -t rsa -b <span class="token number">2048</span> -P <span class="token string">""</span> -f /root/.ssh/id_rsa -q
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span>  <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token comment">#sshpass -p 1  ssh-copy-id -o StrictHostKeyChecking=no $host      </span>
    <span class="token comment"># 如果k8s_env.sh中未定义密码，就把这句打开，注释下面一句</span>
    sshpass -e  ssh-copy-id -o <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token variable">$host</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"hostnamectl set-hostname <span class="token variable">$host</span>"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl disable --now firewalld"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"setenforce 0"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"sed -ri '/^SELINUX=/cSELINUX=disabled' /etc/selinux/config"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"sed -i 's@.*swap.*@#&amp;@g' /etc/fstab"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"swapoff -a"</span>
    <span class="token function">scp</span> /etc/hosts <span class="token variable">$host</span>:/etc/hosts 
<span class="token keyword">done</span>
</code></pre> 
<ul><li>上面命令执行完成之后会修改服务器hostname，建议logout退出之后重新连接促使主机名生效</li></ul> 
<h4><a id="_229"></a>下载软件包并批量安装</h4> 
<ul><li>下载软件包至/k8s/rpm_dir方便后续一起安装</li></ul> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> /k8s/rpm_dir
<span class="token function">curl</span> http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.2-1.el8.x86_64.rpm -o /k8s/rpm_dir/libseccomp.rpm
<span class="token comment"># el7的libseccomp版本太低，给下载个el8的，如果是CentOS8的系统可以不做这一步</span>
yumdownloader --resolve --destdir /k8s/rpm_dir <span class="token function">wget</span> psmisc <span class="token function">vim</span> net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> <span class="token function">tar</span> <span class="token function">curl</span> ipvsadm ipset sysstat conntrack chrony 

<span class="token comment"># 常用基础软件包</span>
yumdownloader --resolve --destdir /k8s/rpm_dir kernel-ml --enablerepo<span class="token operator">=</span>elrepo-kernel
<span class="token comment"># 新版本ml内核软件包</span>
</code></pre> 
<ul><li>所有节点都安装以上软件包</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token keyword">do</span>
   <span class="token function">scp</span> /etc/yum.repos.d/*.repo <span class="token variable">$host</span>:/etc/yum.repos.d/
   <span class="token function">scp</span> -r /k8s/rpm_dir <span class="token variable">$host</span>:/tmp/
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"yum -y remove libseccomp"</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"yum -y localinstall /tmp/rpm_dir/*"</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"rm -rf /tmp/rpm_dir/"</span>
   <span class="token comment">#ssh $host "echo 'export LC_ALL=en_US.UTF-8' &gt;&gt; ~/.bashrc"</span>
   <span class="token comment"># 如果习惯中文可以将这句的注释去掉</span>
<span class="token keyword">done</span>
</code></pre> 
<ul><li>升级内核(节点会重启)</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"rpm -qa|grep kernel"</span>
   <span class="token comment">#ssh $host  " awk -F\' '$1=="menuentry " {print $2}' /etc/grub2.cfg"</span>
   <span class="token builtin class-name">echo</span> <span class="token variable">$host</span>
   <span class="token builtin class-name">echo</span> <span class="token string">""</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"grub2-set-default 0"</span>
<span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
   <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$host</span> <span class="token operator">==</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
      <span class="token builtin class-name">continue</span>
   <span class="token keyword">fi</span>
      <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token function">reboot</span>
<span class="token keyword">done</span>
init <span class="token number">6</span>
</code></pre> 
<ul><li>做完这一步之后可以等待一到三分钟左右再连接服务器</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># 此时检查内核版本会发现已经升级完成</span>
<span class="token function">uname</span> -r 
<span class="token number">6.3</span>.3-1.el7.elrepo.x86_64
</code></pre> 
<h4><a id="_290"></a>配置时间同步</h4> 
<p>计划node1同步阿里ntp服务器，其余节点同步node1</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/chrony.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
server ntp.aliyun.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
allow <span class="token variable">$NODEIPS</span>
local stratum 10
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /k8s/conf/chrony.conf.client <span class="token operator">&lt;&lt;</span><span class="token string">EOF
server <span class="token variable">$node1</span> iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
local stratum 10
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF</span>
</code></pre> 
<p>分发chrony配置文件</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime"</span>
   <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$host</span> <span class="token operator">==</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
      <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl restart chronyd"</span>
      <span class="token builtin class-name">continue</span>
   <span class="token keyword">fi</span>
   <span class="token function">scp</span> /k8s/conf/chrony.conf.client  <span class="token variable">$host</span>:/etc/chrony.conf 
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">" systemctl restart chronyd"</span>
<span class="token keyword">done</span>

</code></pre> 
<p>检查chrony是否配置成功</p> 
<pre><code class="prism language-shell"><span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"timedatectl"</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"chronyc sources -v"</span>
   <span class="token function">sleep</span> <span class="token number">1</span>
<span class="token keyword">done</span>
</code></pre> 
<h4><a id="_348"></a>配置打开文件描述符</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/security/limits.conf</span>
* soft nofile 655360
* hard nofile 131072
* soft nproc 655350
* hard nproc 655350
* seft memlock unlimited
* hard memlock unlimited
EOF</span>

<span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
        <span class="token function">scp</span> /etc/security/limits.conf <span class="token variable">$host</span>:/etc/security/limits.conf
<span class="token keyword">done</span>
</code></pre> 
<h4><a id="ipvs_366"></a>添加ipvs模块和内核模块</h4> 
<ul><li>添加ipvs模块</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/modules-load.d/ipvs.conf </span>
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo # 如遇到报错可以删除这个模块重试
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack #内核小于4.18，把这行改成nf_conntrack_ipv4,实际用的时候把注释删掉，否则可能报错
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
overlay
br_netfilter
EOF</span>
</code></pre> 
<ul><li>添加内核模块</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span>  /etc/sysctl.d/k8s.conf </span>
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
vm.swappiness=0
EOF</span>
</code></pre> 
<ul><li>进行配置文件分发</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh

<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span>  <span class="token variable">${WORKS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">scp</span> /etc/modules-load.d/ipvs.conf <span class="token variable">$host</span>:/etc/modules-load.d/ipvs.conf
    <span class="token function">scp</span> /etc/sysctl.d/k8s.conf <span class="token variable">$host</span>:/etc/sysctl.d/k8s.conf
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl restart systemd-modules-load.service"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"sysctl --system"</span>
<span class="token keyword">done</span>
</code></pre> 
<h3><a id="Ubuntu_443"></a>Ubuntu</h3> 
<h4><a id="apt_445"></a>配置apt源</h4> 
<ul><li>基础apt源</li></ul> 
<pre><code class="prism language-shell"><span class="token function">mv</span> /etc/apt/<span class="token punctuation">{<!-- --></span>sources.list,sources.list.bak<span class="token punctuation">}</span>    <span class="token comment"># 备份现有的apt源</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/apt/sources.list</span>
deb http://repo.huaweicloud.com/ubuntu focal main restricted
deb http://repo.huaweicloud.com/ubuntu focal-updates main restricted
deb http://repo.huaweicloud.com/ubuntu focal universe
deb http://repo.huaweicloud.com/ubuntu focal-updates universe
deb http://repo.huaweicloud.com/ubuntu focal multiverse
deb http://repo.huaweicloud.com/ubuntu focal-updates multiverse
deb http://repo.huaweicloud.com/ubuntu focal-backports main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu focal-security main restricted
deb http://repo.huaweicloud.com/ubuntu focal-security universe
deb http://repo.huaweicloud.com/ubuntu focal-security multiverse
EOF</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
</code></pre> 
<ul><li><s>添加docker源(用于安装containerd)</s>(二进制安装不需要)</li></ul> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -fsSL https://repo.huaweicloud.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token function">sudo</span> add-apt-repository <span class="token string">"deb [arch=amd64] https://repo.huaweicloud.com/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable"</span>
</code></pre> 
<ul><li><s>添加k8s源(用于安装kubeadm、kubelet、kubectl)</s> (二进制安装不需要)</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/apt/sources.list.d/kubernetes.list </span>
deb https://repo.huaweicloud.com/kubernetes/apt/ kubernetes-xenial main
EOF</span>
<span class="token function">curl</span> -s https://repo.huaweicloud.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
</code></pre> 
<h4><a id="hostnameswap_482"></a>配置免密、修改hostname、关闭防火墙、关闭swap分区(方便后面进行其它操作)</h4> 
<ul><li>修改hosts文件</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> <span class="token builtin class-name">echo</span> <span class="token string">"$"</span>$host<span class="token variable">)</span></span> <span class="token variable">$host</span>"</span>  <span class="token operator">&gt;&gt;</span> /etc/hosts<span class="token punctuation">;</span><span class="token keyword">done</span>
<span class="token builtin class-name">echo</span> <span class="token string">"VIP <span class="token variable">$VIP</span>"</span>  <span class="token operator">&gt;&gt;</span> /etc/hosts
<span class="token comment"># 执行本命令之前记得先修改配置文件/k8s/conf/k8s_env.sh</span>
</code></pre> 
<ul><li>修改hostname、关闭防火墙、关闭swap分区</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token function">apt</span> -y <span class="token function">install</span> sshpass
ssh-keygen -t rsa -b <span class="token number">2048</span> -P <span class="token string">""</span> -f /root/.ssh/id_rsa -q
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span>  <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
   <span class="token comment">#sshpass -p 1  ssh-copy-id -o StrictHostKeyChecking=no $host</span>
    sshpass -e  ssh-copy-id -o <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token variable">$host</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"hostnamectl set-hostname <span class="token variable">$host</span>"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl disable --now ufw"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"sed -i 's@.*swap.*@#&amp;@g' /etc/fstab"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"swapoff -a"</span>
    <span class="token function">scp</span> /etc/hosts <span class="token variable">$host</span>:/etc/hosts 
<span class="token keyword">done</span>
</code></pre> 
<h4><a id="_510"></a>下载软件包并批量安装</h4> 
<ul><li>本来想下载软件包然后一起dpkg安装的，但是总是少安装包，就还是直接安装了</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"apt -y install net-tools   ipvsadm ipset  conntrack  chrony "</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"apt -y install kubelet=1.26.0-00 kubeadm=1.26.0-00 kubectl=1.26.0-00"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"apt -y install containerd.io"</span>
<span class="token keyword">done</span>
</code></pre> 
<h4><a id="_523"></a>配置时间同步</h4> 
<p>计划node1同步阿里ntp服务器，其余节点同步node1</p> 
<pre><code class="prism language-bash"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/chrony/chrony.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
server ntp.aliyun.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
allow <span class="token variable">$NODEIPS</span>
local stratum 10
keyfile /etc/chrony/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /k8s/conf/chrony.conf.client <span class="token operator">&lt;&lt;</span><span class="token string">EOF
server <span class="token variable">$node1</span> iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
local stratum 10
keyfile /etc/chrony/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF</span>
</code></pre> 
<p>分发chrony配置文件</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime"</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$host</span> <span class="token operator">==</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl restart chrony"</span>
        <span class="token builtin class-name">continue</span>
    <span class="token keyword">fi</span>
    <span class="token function">scp</span> /k8s/conf/chrony.conf.client  <span class="token variable">$host</span>:/etc/chrony/chrony.conf 
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">" systemctl restart chrony"</span>
<span class="token keyword">done</span>

<span class="token function">sleep</span> <span class="token number">3</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable chrony"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"timedatectl"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"chronyc sources -v"</span>
<span class="token keyword">done</span>
</code></pre> 
<h4><a id="_575"></a>配置打开文件描述符</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/security/limits.conf</span>
* soft nofile 655360
* hard nofile 131072
* soft nproc 655350
* hard nproc 655350
* seft memlock unlimited
* hard memlock unlimited
EOF</span>

<span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
        <span class="token function">scp</span> /etc/security/limits.conf <span class="token variable">$host</span>:/etc/security/limits.conf
<span class="token keyword">done</span>
</code></pre> 
<h4><a id="ipvs_593"></a>添加ipvs模块和内核模块</h4> 
<ul><li>添加ipvs模块</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/modules-load.d/ipvs.conf </span>
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo # 如遇到报错可以删除这个模块重试
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack #内核小于4.18，把这行改成nf_conntrack_ipv4
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
overlay
br_netfilter
EOF</span>
</code></pre> 
<ul><li>添加内核模块</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span>  /etc/sysctl.d/k8s.conf </span>
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
vm.swappiness=0
EOF</span>
</code></pre> 
<ul><li>进行配置文件分发</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh

<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span>  <span class="token variable">${WORKS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">scp</span> /etc/modules-load.d/ipvs.conf <span class="token variable">$host</span>:/etc/modules-load.d/ipvs.conf
    <span class="token function">scp</span> /etc/sysctl.d/k8s.conf <span class="token variable">$host</span>:/etc/sysctl.d/k8s.conf
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl restart systemd-modules-load.service"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"sysctl --system"</span>
<span class="token keyword">done</span>
</code></pre> 
<h2><a id="nginx_671"></a>编译一个nginx做负载均衡</h2> 
<blockquote> 
 <p>如果是采用keepalived+haproxy的方式做负载均衡就不执行本步骤</p> 
</blockquote> 
<p>如果不想编译的话也可以直接yum/apt安装nginx，但是需要额外安装模块<br> <em><strong>CentOS</strong></em></p> 
<pre><code class="prism language-shell">yum -y <span class="token function">install</span> nginx
yum -y <span class="token function">install</span> nginx-all-modules.noarch
</code></pre> 
<p><em><strong>Ubuntu</strong></em></p> 
<pre><code class="prism language-shell"><span class="token function">apt</span> -y <span class="token function">install</span> nginx
</code></pre> 
<ul><li>安装编译需要的软件<br> <em><strong>CentOS</strong></em></li></ul> 
<pre><code class="prism language-shell">yum -y <span class="token function">install</span> gcc gcc-c++ //C语言环境
yum -y <span class="token function">install</span> pcre pcre-devel //正则
yum -y <span class="token function">install</span> zlib zlib-devel //lib包
yum -y <span class="token function">install</span> openssl openssl-devel <span class="token function">make</span>
</code></pre> 
<p><em><strong>Ubuntu</strong></em></p> 
<pre><code class="prism language-shell"><span class="token function">apt-get</span> <span class="token function">install</span> gcc
<span class="token function">apt-get</span> <span class="token function">install</span> libpcre3 libpcre3-dev
<span class="token function">apt-get</span> <span class="token function">install</span> zlib1g zlib1g-dev
<span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">make</span>
</code></pre> 
<ul><li>下载源码包</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/pkg/
<span class="token function">wget</span> http://nginx.org/download/nginx-1.20.1.tar.gz
<span class="token function">tar</span> -xf nginx-1.20.1.tar.gz
<span class="token builtin class-name">cd</span> nginx-1.20.1/
</code></pre> 
<ul><li>编译部署nginx</li></ul> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> /k8s/pkg/nginx_tmp
./configure --prefix<span class="token operator">=</span>/k8s/pkg/nginx_tmp --with-stream --without-http --without-http_uwsgi_module <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">make</span> <span class="token function">install</span>
</code></pre> 
<ul><li>编写nginx配置文件</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token function">cat</span> <span class="token operator">&gt;</span>     /k8s/conf/nginx.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
worker_processes auto;
events {
    worker_connections  1024;
}
stream {
    upstream backend {
        hash \<span class="token variable">$remote_addr</span> consistent;
        server <span class="token variable">$node1</span>:6443        max_fails=3 fail_timeout=30s;
        server <span class="token variable">$node2</span>:6443        max_fails=3 fail_timeout=30s;
        server <span class="token variable">$node3</span>:6443        max_fails=3 fail_timeout=30s;
    }
    server {
        listen *:8443;
        proxy_connect_timeout 1s;
        proxy_pass backend;
    }
}
EOF</span>
</code></pre> 
<ul><li>编写nginx的service文件</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>     /k8s/service/kube-nginx.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=kube-apiserver nginx proxy
After=network.target
After=network-online.target
Wants=network-online.target
[Service]
Type=forking
ExecStartPre=/usr/local/bin/nginx -c /etc/nginx/nginx.conf -p /etc/nginx -t
ExecStart=/usr/local/bin/nginx -c /etc/nginx/nginx.conf  -p /etc/nginx
ExecReload=/usr/local/bin/nginx -c /etc/nginx/nginx.conf  -p /etc/nginx -s reload
PrivateTmp=true
Restart=always
RestartSec=5
StartLimitInterval=0
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<ul><li>分发文件并启动nginx</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"mkdir /etc/nginx/logs -p"</span>
    <span class="token function">scp</span> /k8s/pkg/nginx_tmp/sbin/nginx <span class="token variable">$host</span>:/usr/local/bin/
    <span class="token function">scp</span> /k8s/conf/nginx.conf <span class="token variable">$host</span>:/etc/nginx/nginx.conf
    <span class="token function">scp</span> /k8s/service/kube-nginx.service <span class="token variable">$host</span>:/etc/systemd/system/
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl daemon-reload "</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable kube-nginx"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl restart kube-nginx"</span>
<span class="token keyword">done</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl is-active kube-nginx"</span>
<span class="token keyword">done</span>
<span class="token comment"># 检查nginx是否就绪</span>
</code></pre> 
<h2><a id="_796"></a>安装容器运行时</h2> 
<blockquote> 
 <p>可以装docker也可以装containerd，我实在是不习惯containerd，本次还是安装的docker</p> 
</blockquote> 
<h3><a id="docker_800"></a>安装docker</h3> 
<p>解压二进制包</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/pkg/
<span class="token function">tar</span> -xf docker-23.0.6.tgz
</code></pre> 
<p><s>准备containerd.service文件</s></p> 
<pre><code class="prism language-shell"><span class="token function">cat</span>  <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/service/containerd.service</span>
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<p><s>准备docker.socket文件</s></p> 
<pre><code class="prism language-shell"><span class="token function">cat</span>  <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/service/docker.socket</span>
[Unit]
Description=Docker Socket for the API

[Socket]
ListenStream=/var/run/docker.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF</span>
</code></pre> 
<p>准备docker.service文件</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/service/docker.service</span>
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target  firewalld.service  time-set.target
Wants=network-online.target 

[Service]
Type=notify
ExecStart=/usr/bin/dockerd 
ExecReload=/bin/kill -s HUP \<span class="token variable">$MAINPID</span>
TimeoutStartSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process
OOMScoreAdjust=-500

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<p>准备daemon.json文件</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /k8s/conf/docker.daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  "log-driver": "json-file",
  "log-opts": {
        "max-size": "20m",
        "max-file": "3"
    },
  "registry-mirrors": ["https://pilvpemn.mirror.aliyuncs.com"],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "live-restore": true 
}
EOF</span>
</code></pre> 
<p>分发二进制文件并启动docker</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"mkdir /etc/docker "</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"groupadd docker"</span>
    <span class="token function">scp</span> /k8s/pkg/docker/* <span class="token variable">$host</span>:/usr/bin/
    <span class="token function">scp</span> /k8s/conf/docker.daemon.json <span class="token variable">$host</span>:/etc/docker/daemon.json
    <span class="token function">scp</span> /k8s/service/docker.service <span class="token variable">$host</span>:/etc/systemd/system/docker.service
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl daemon-reload "</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable docker --now"</span>
<span class="token keyword">done</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl is-active docker"</span>
<span class="token keyword">done</span>
<span class="token comment"># 检查docker是否就绪</span>
</code></pre> 
<h3><a id="cridocker_926"></a>安装cri-docker</h3> 
<p>解压二进制包</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/pkg/
<span class="token function">tar</span> -xf cri-dockerd-0.3.2.amd64.tgz 
<span class="token builtin class-name">cd</span> cri-dockerd/
</code></pre> 
<p>准备cri-docer.service文件，<a href="https://github.com/Mirantis/cri-dockerd/blob/master/packaging/systemd/cri-docker.service">官网有参考文件</a></p> 
<blockquote> 
 <p>官方给出的模板，一些参数是需要做修改的</p> 
 <ul><li>–cni-bin-dir 默认路径是 /opt/cni/bin，有需要的话，可以做修改，为了避免大家后面忘记了，这里我就不做修改了，使用默认的路径</li><li>–container-runtime-endpoint 默认的路径是 unix:///var/run/cri-dockerd.sock ，可以把官方的这个参数去掉就好</li><li>–cri-dockerd-root-directory 默认路径是 /var/lib/cri-dockerd ，可以和 docker 一样修改路径，避免默认的路径空间不足</li><li>–pod-infra-container-image 默认镜像是 registry.k8s.io/pause:3.6，要改成阿里的镜像，如果没有国外服务器，拉取 k8s 的镜像会失败</li><li>其他参数可以通过 cri-dockerd --help 命令来获取</li></ul> 
</blockquote> 
<p>准备cri-docker.service文件</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/service/cri-docker.service</span>
[Unit]
Description=CRI Interface for Docker Application Container Engine
Documentation=https://docs.mirantis.com
After=network-online.target firewalld.service docker.service
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/bin/cri-dockerd --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.9
          
ExecReload=/bin/kill -s HUP \<span class="token variable">$MAINPID</span>
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<p>分发二进制文件并启动docker</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">scp</span> /k8s/pkg/cri-dockerd/* <span class="token variable">$host</span>:/usr/bin/
    <span class="token function">scp</span> /k8s/service/cri-docker.service <span class="token variable">$host</span>:/etc/systemd/system/cri-docker.service
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl daemon-reload "</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable cri-docker --now"</span>
<span class="token keyword">done</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl is-active cri-docker"</span>
<span class="token keyword">done</span>
<span class="token comment"># 检查docker是否就绪</span>
</code></pre> 
<h2><a id="etcd_997"></a>安装etcd</h2> 
<ul><li>下载二进制包</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/pkg/
<span class="token function">ls</span> etcd*
etcd-v3.5.9-linux-amd64.tar.gz
<span class="token comment"># 检查安装包是否存在</span>
<span class="token function">tar</span> -xf etcd-v3.5.9-linux-amd64.tar.gz
</code></pre> 
<ul><li>准备etcd的service文件</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/service/etcd.service</span>
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos

[Service]
Type=notify
WorkingDirectory=/var/lib/etcd/
ExecStart=/usr/local/bin/etcd <span class="token entity" title="\\">\\</span>
 --name=##NODE_NAME## <span class="token entity" title="\\">\\</span>
 --cert-file=/etc/etcd/ssl/etcd.pem <span class="token entity" title="\\">\\</span>
 --key-file=/etc/etcd/ssl/etcd-key.pem <span class="token entity" title="\\">\\</span>
 --peer-cert-file=/etc/etcd/ssl/etcd.pem <span class="token entity" title="\\">\\</span>
 --peer-key-file=/etc/etcd/ssl/etcd-key.pem <span class="token entity" title="\\">\\</span>
 --trusted-ca-file=/etc/etcd/ssl/ca.pem <span class="token entity" title="\\">\\</span>
 --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem <span class="token entity" title="\\">\\</span>
 --initial-advertise-peer-urls=https://##NODE_IP##:2380 <span class="token entity" title="\\">\\</span>
 --listen-peer-urls=https://##NODE_IP##:2380 <span class="token entity" title="\\">\\</span>
 --listen-client-urls=https://##NODE_IP##:2379,http://127.0.0.1:2379 <span class="token entity" title="\\">\\</span>
 --advertise-client-urls=https://##NODE_IP##:2379 <span class="token entity" title="\\">\\</span>
 --initial-cluster-token=etcd-cluster <span class="token entity" title="\\">\\</span>
 --initial-cluster=##ETCD_CLUSTERS## <span class="token entity" title="\\">\\</span>
 --initial-cluster-state=new <span class="token entity" title="\\">\\</span>
 --data-dir=/var/lib/etcd
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h3><a id="etcd_1048"></a>准备etcd所需证书</h3> 
<ul><li>下载cfssl工具制作证书</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/pkg/
<span class="token function">mv</span> cfssl_1.6.3_linux_amd64 /usr/local/bin/cfssl
<span class="token function">mv</span> cfssljson_1.6.3_linux_amd64 /usr/local/bin/cfssljson
<span class="token function">chmod</span>  +x /usr/local/bin/cfssl*

 cfssl version <span class="token comment"># 验证版本</span>
</code></pre> 
<ul><li>创建根证书配置</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
<span class="token function">cat</span> <span class="token operator">&gt;</span> ca-config.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
 "signing": {
   "default": {
     "expiry": "87600h"
   },
   "profiles": {
     "kubernetes": {       # 如果是etcd和k8s不共用证书，这里建议写etcd
       "usages": [         # 执行之前删除掉 # 注释
           "signing",
           "key encipherment",
           "server auth",
           "client auth"
       ],
       "expiry": "876000h"
     }
   }
 }
}
EOF</span>
</code></pre> 
<ul><li>创建ca证书请求文件</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> ca-csr.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "HuBei",
      "L": "WuHan",
      "O": "k8s",
      "OU": "System"
    }
  ],
  "ca": {
    "expiry": "876000h"
 }
}
EOF</span>
</code></pre> 
<ul><li>创建etcd证书请求文件</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> etcd-csr.json </span>
{
  "CN": "etcd",
  "hosts": [
    "127.0.0.1",
    "<span class="token variable">$node1</span>",
    "<span class="token variable">$node2</span>",
    "<span class="token variable">$node3</span>"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "HuBei",
      "L": "WuHan",
      "O": "k8s",
      "OU": "Etcd"
    }
  ]
}
EOF</span>
</code></pre> 
<ul><li>初始化ca证书，利用生成的根证书生成etcd证书文件</li></ul> 
<pre><code class="prism language-bash">cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes etcd-csr.json <span class="token operator">|</span>cfssljson -bare etcd
<span class="token comment"># 这里的profile要和CA里面的对应</span>
</code></pre> 
<h3><a id="service_1150"></a>分发证书、二进制文件及service文件</h3> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token builtin class-name">cd</span> /k8s/service
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${MASTERS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span> 
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"mkdir /etc/etcd/ssl/ -p"</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"mkdir /var/lib/etcd"</span>
   <span class="token function">scp</span>     /k8s/ssl/etcd* <span class="token variable">$host</span>:/etc/etcd/ssl/
   <span class="token function">scp</span>     /k8s/ssl/ca*  <span class="token variable">$host</span>:/etc/etcd/ssl/
<span class="token keyword">done</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${MASTERS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span> 
   <span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> <span class="token builtin class-name">echo</span> <span class="token string">"$"</span>$host<span class="token variable">)</span></span> 
   
   <span class="token function">sed</span> -e <span class="token string">"s@##NODE_NAME##@<span class="token variable">$host</span>@g"</span>  -e <span class="token string">"s@##NODE_IP##@<span class="token variable">$IP</span>@g"</span>  -e  <span class="token string">"s@##ETCD_CLUSTERS##@<span class="token variable">$ETCD_CLUSTERS</span>@g"</span> etcd.service <span class="token operator">&gt;</span> etcd.service.<span class="token variable">$host</span>
   
   <span class="token function">scp</span> etcd.service.<span class="token variable">$host</span> <span class="token variable">$host</span>:/etc/systemd/system/etcd.service
   <span class="token function">scp</span> /k8s/pkg/etcd*/etcd* <span class="token variable">$host</span>:/usr/local/bin/
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl daemon-reload"</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable etcd "</span>
   <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl start etcd --no-block"</span>
<span class="token keyword">done</span>
</code></pre> 
<p>检查etcd是否正常</p> 
<pre><code class="prism language-shell"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl --endpoints<span class="token operator">=</span><span class="token variable">$ETCD_ENDPOINTS</span> --cacert<span class="token operator">=</span>/etc/etcd/ssl/ca.pem --cert<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem --key<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem endpoint status --write-out<span class="token operator">=</span>table
</code></pre> 
<p><img src="https://images2.imgbox.com/f8/6c/F3Z9XdsP_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="k8s_1184"></a>安装k8s组件</h2> 
<h3><a id="apiserver_1186"></a>apiserver</h3> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/pkg/
<span class="token function">tar</span> -xf kubernetes-server-linux-amd64.tar.gz
<span class="token comment"># 解压出来的二进制包默认都在 kubernetes/server/bin/ 里面</span>
</code></pre> 
<h4><a id="apiserver__1194"></a>准备apiserver 证书</h4> 
<p>准备证书申请文件</p> 
<blockquote> 
 <p>和 etcd 组件一样，把所有的 apiserver 节点 ip 都要写进去</p> 
 <p>如果有 SLB 等高可用 ip，也要写进去 （我这里实际上是127.0.0.1做的负载均衡）</p> 
</blockquote> 
<pre><code class="prism language-shell"> <span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/ssl/apiserver-csr.json</span>
{
  "CN": "kubernetes",
  "hosts": [
    "127.0.0.1",
    "<span class="token variable">$node1</span>",
    "<span class="token variable">$node2</span>",
    "<span class="token variable">$node3</span>",
    "<span class="token variable">$CLUSTER_KUBERNETES_IP</span>",
    "kubernetes",
    "kubernetes.default",
    "kubernetes.default.svc",
    "kubernetes.default.svc.cluster",
    "kubernetes.default.svc.cluster.local"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "HuBei",
      "L": "WuHan",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
EOF</span>
</code></pre> 
<p>创建apiserver证书</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes apiserver-csr.json <span class="token operator">|</span>cfssljson -bare  apiserver
</code></pre> 
<h4><a id="metricsserver_1243"></a>准备metrics-server证书</h4> 
<blockquote> 
 <p>后期如果需要用到hpa的话那就需要起metrics-server，起这个pod可以不用证书，但是官方建议给配上</p> 
</blockquote> 
<p>准备证书申请文件</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/ssl/aggregator-csr.json</span>
{
  "CN": "aggregator",
  "hosts": [
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "HuBei",
      "L": "WuHan",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
EOF</span>
</code></pre> 
<p>创建metrics-server证书</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes aggregator-csr.json <span class="token operator">|</span>cfssljson -bare  aggregator
</code></pre> 
<h4><a id="service_1279"></a>准备service文件</h4> 
<blockquote> 
 <p><a href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/" rel="nofollow">参考</a></p> 
 <p>这里每个apiserver节点IP不一样，后续用sed替换</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/service/kube-apiserver.service.template</span>
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver <span class="token entity" title="\\">\\</span>
  --secure-port=6443 <span class="token entity" title="\\">\\</span>
  --allow-privileged=true <span class="token entity" title="\\">\\</span>
  --anonymous-auth=false <span class="token entity" title="\\">\\</span>
  --api-audiences=api,istio-ca <span class="token entity" title="\\">\\</span>
  --authorization-mode=Node,RBAC <span class="token entity" title="\\">\\</span>
  --bind-address=##masterIP## <span class="token entity" title="\\">\\</span>
  --client-ca-file=<span class="token variable">$K8S_SSL_Path</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --endpoint-reconciler-type=lease <span class="token entity" title="\\">\\</span>
  --etcd-cafile=<span class="token variable">$K8S_SSL_Path</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --etcd-certfile=<span class="token variable">$K8S_SSL_Path</span>/apiserver.pem <span class="token entity" title="\\">\\</span>
  --etcd-keyfile=<span class="token variable">$K8S_SSL_Path</span>/apiserver-key.pem <span class="token entity" title="\\">\\</span>
  --etcd-servers=<span class="token variable">$ETCD_ENDPOINTS</span> <span class="token entity" title="\\">\\</span>
  --kubelet-certificate-authority=<span class="token variable">$K8S_SSL_Path</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --kubelet-client-certificate=<span class="token variable">$K8S_SSL_Path</span>/apiserver.pem <span class="token entity" title="\\">\\</span>
  --kubelet-client-key=<span class="token variable">$K8S_SSL_Path</span>/apiserver-key.pem <span class="token entity" title="\\">\\</span>
  --service-account-issuer=https://kubernetes.default.svc <span class="token entity" title="\\">\\</span>
  --service-account-signing-key-file=<span class="token variable">$K8S_SSL_Path</span>/ca-key.pem <span class="token entity" title="\\">\\</span>
  --service-account-key-file=<span class="token variable">$K8S_SSL_Path</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --service-cluster-ip-range=<span class="token variable">$SERVICE_CIDR</span> <span class="token entity" title="\\">\\</span>
  --service-node-port-range=<span class="token variable">$NODE_PORT_RANGE</span> <span class="token entity" title="\\">\\</span>
  --tls-cert-file=<span class="token variable">$K8S_SSL_Path</span>/apiserver.pem <span class="token entity" title="\\">\\</span>
  --tls-private-key-file=<span class="token variable">$K8S_SSL_Path</span>/apiserver-key.pem <span class="token entity" title="\\">\\</span>
  --requestheader-client-ca-file=<span class="token variable">$K8S_SSL_Path</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --requestheader-allowed-names= <span class="token entity" title="\\">\\</span>
  --requestheader-extra-headers-prefix=X-Remote-Extra- <span class="token entity" title="\\">\\</span>
  --requestheader-group-headers=X-Remote-Group <span class="token entity" title="\\">\\</span>
  --requestheader-username-headers=X-Remote-User <span class="token entity" title="\\">\\</span>
  --proxy-client-cert-file=<span class="token variable">$K8S_SSL_Path</span>/aggregator.pem <span class="token entity" title="\\">\\</span>
  --proxy-client-key-file=<span class="token variable">$K8S_SSL_Path</span>/aggregator-key.pem <span class="token entity" title="\\">\\</span>
  --enable-aggregator-routing=true <span class="token entity" title="\\">\\</span>
  --v=2
Restart=always
RestartSec=5
Type=notify
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h4><a id="apiserver_1335"></a>分发apiserver文件并启动</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token builtin class-name">cd</span> /k8s/service
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${MASTERS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span> 
    <span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> <span class="token builtin class-name">echo</span> <span class="token string">"$"</span>$host<span class="token variable">)</span></span> 
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"mkdir <span class="token variable">${K8S_SSL_Path}</span> -p"</span>
    <span class="token function">scp</span> /k8s/ssl/<span class="token punctuation">{<!-- --></span>ca*.pem,apiserver*.pem,aggregator*.pem<span class="token punctuation">}</span> <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">${K8S_SSL_Path}</span>/
    <span class="token function">scp</span> /k8s/pkg/kubernetes/server/bin/kube<span class="token punctuation">{<!-- --></span>-apiserver,ctl<span class="token punctuation">}</span>  <span class="token variable">$host</span>:/usr/local/bin/
    <span class="token function">sed</span>  <span class="token string">"s@##masterIP##@<span class="token variable">$IP</span>@g"</span> kube-apiserver.service.template <span class="token operator">&gt;</span> kube-apiserver.service.<span class="token variable">${host}</span>
    <span class="token comment"># 注意这里sed需要用双引号才能成功替换</span>
    <span class="token function">scp</span> kube-apiserver.service.<span class="token variable">${host}</span> <span class="token variable">$host</span>:/etc/systemd/system/kube-apiserver.service
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl daemon-reload"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable kube-apiserver --now"</span>
<span class="token keyword">done</span>
</code></pre> 
<p>验证apiserver节点健康状态</p> 
<pre><code class="prism language-shell"><span class="token comment"># 验证apiserver是否健康</span>
<span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${MASTERS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span> 
    <span class="token function">curl</span> -k https://<span class="token variable">${host}</span>:6443/healthz  --cacert <span class="token variable">${K8S_SSL_Path}</span>/ca.pem  --cert <span class="token variable">${K8S_SSL_Path}</span>/apiserver.pem --key <span class="token variable">${K8S_SSL_Path}</span>/apiserver-key.pem
    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\t">\t</span><span class="token variable">$host</span>"</span>
<span class="token keyword">done</span>

<span class="token comment"># 正常结果如下</span>
ok	node1
ok	node2
ok	node3
</code></pre> 
<h3><a id="kubectl_1369"></a>kubectl</h3> 
<h4><a id="admin_1371"></a>准备admin证书</h4> 
<blockquote> 
 <p>后期肯定会用到kubectl命令操作集群，需要给准备个证书</p> 
</blockquote> 
<p>准备证书申请文件</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/ssl/admin-csr.json</span>
{
  "CN": "admin",
  "hosts": [
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "HuBei",
      "L": "WuHan",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
EOF</span>
<span class="token comment"># 这里的masters必不能掉</span>
</code></pre> 
<p>创建admin证书</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes admin-csr.json <span class="token operator">|</span>cfssljson -bare  admin
</code></pre> 
<h4><a id="kubeconfig_1408"></a>创建kubeconfig</h4> 
<blockquote> 
 <p>设置集群参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span>https://<span class="token variable">$VIP_server</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kubectl.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置客户端认证参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-credentials admin <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>admin.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>admin-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kubectl.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置上下文参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-context kubernetes <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>admin <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kubectl.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置默认上下文</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config use-context kubernetes --kubeconfig<span class="token operator">=</span>kubectl.kubeconfig
</code></pre> 
<blockquote> 
 <p>创建config</p> 
 <p>kubectl 命令默认从 <code>$HOME/.kube/config</code> 文件里面读取证书来访问 apiserver 节点的</p> 
 <p>如果不创建的话也可以<code>kubectl --kubeconfig=kubectl.kubeconfig</code>来指定</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> ~/.kube
<span class="token function">cp</span> /k8s/ssl/kubectl.kubeconfig ~/.kube/config
<span class="token function">cp</span> /k8s/ssl/kubectl.kubeconfig /etc/kubernetes/admin.conf
<span class="token comment"># 这步是为了归档，其实可以忽略</span>
</code></pre> 
<h4><a id="_clusterrolebinding__exec__1465"></a>创建 clusterrolebinding 实现 exec 进入容器权限</h4> 
<blockquote> 
 <p>不创建 clusterrolebinding ，使用 kubectl exec 命令会出现 error: unable to upgrade connection: Forbidden (user=kubernetes, verb=create, resource=nodes, subresource=proxy)类似报错</p> 
</blockquote> 
<pre><code class="prism language-shell">kubectl create clusterrolebinding kubernetes --clusterrole<span class="token operator">=</span>cluster-admin --user<span class="token operator">=</span>kubernetes
</code></pre> 
<p><s>配置kubectl命令自动补全</s>（可忽略）</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc
<span class="token builtin class-name">source</span> ~/.bashrc 
</code></pre> 
<h3><a id="controllermanager_1480"></a>controller-manager</h3> 
<h4><a id="controllermanager__1482"></a>准备controller-manager 证书</h4> 
<p>准备controller-manager证书申请文件</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/ssl/kube-controller-manager-csr.json</span>
{
  "CN": "system:kube-controller-manager",
  "hosts": [
    "127.0.0.1",
    "<span class="token variable">$node1</span>",
    "<span class="token variable">$node2</span>",
    "<span class="token variable">$node3</span>"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "HuBei",
      "L": "WuHan",
      "O": "system:kube-controller-manager",
      "OU": "System"
    }
  ]
}
EOF</span>
</code></pre> 
<p>创建controller-manager证书</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-controller-manager-csr.json <span class="token operator">|</span>cfssljson -bare kube-controller-manager
</code></pre> 
<h4><a id="kubeconfig_1521"></a>创建kubeconfig</h4> 
<blockquote> 
 <p>设置集群参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span>https://<span class="token variable">$VIP_server</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-controller-manager.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置客户端认证参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-credentials system:kube-controller-manager <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>kube-controller-manager.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>kube-controller-manager-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-controller-manager.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置上下文参数</p> 
</blockquote> 
<pre><code class="prism language-shelll">cd /k8s/ssl/
kubectl config \
set-context system:kube-controller-manager \
--cluster=kubernetes \
--user=system:kube-controller-manager \
--kubeconfig=kube-controller-manager.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置默认上下文</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
use-context system:kube-controller-manager --kubeconfig<span class="token operator">=</span>kube-controller-manager.kubeconfig
</code></pre> 
<h4><a id="service_1566"></a>准备service文件</h4> 
<blockquote> 
 <p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.26.md#server-binaries">参考</a></p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/service
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> kube-controller-manager.service</span>
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-controller-manager <span class="token entity" title="\\">\\</span>
  --bind-address=0.0.0.0 <span class="token entity" title="\\">\\</span>
  --allocate-node-cidrs=true <span class="token entity" title="\\">\\</span>
  --cluster-cidr=<span class="token variable">$CLUSTER_CIDR</span> <span class="token entity" title="\\">\\</span>
  --cluster-name=kubernetes <span class="token entity" title="\\">\\</span>
  --cluster-signing-cert-file=<span class="token variable">$K8S_SSL_Path</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --cluster-signing-key-file=<span class="token variable">$K8S_SSL_Path</span>/ca-key.pem <span class="token entity" title="\\">\\</span>
  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig <span class="token entity" title="\\">\\</span>
  --leader-elect=true <span class="token entity" title="\\">\\</span>
  --node-cidr-mask-size=24 <span class="token entity" title="\\">\\</span>
  --root-ca-file=<span class="token variable">$K8S_SSL_Path</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --service-account-private-key-file=<span class="token variable">$K8S_SSL_Path</span>/ca-key.pem <span class="token entity" title="\\">\\</span>
  --service-cluster-ip-range=<span class="token variable">$SERVICE_CIDR</span> <span class="token entity" title="\\">\\</span>
  --use-service-account-credentials=true <span class="token entity" title="\\">\\</span>
  --v=2
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h4><a id="controllermanager_1601"></a>分发controller-manager文件并启动</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token builtin class-name">cd</span> /k8s/service
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${MASTERS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span> 
    <span class="token function">scp</span> /k8s/ssl/kube-controller-manager<span class="token punctuation">{<!-- --></span>,-key<span class="token punctuation">}</span>.pem <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">${K8S_SSL_Path}</span>/
    <span class="token function">scp</span> /k8s/ssl/kube-controller-manager.kubeconfig <span class="token variable">$host</span>:/etc/kubernetes/
    <span class="token function">scp</span> /k8s/pkg/kubernetes/server/bin/kube-controller-manager  <span class="token variable">$host</span>:/usr/local/bin/
    <span class="token function">scp</span> kube-controller-manager.service <span class="token variable">$host</span>:/etc/systemd/system/kube-controller-manager.service
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl daemon-reload"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable kube-controller-manager --now"</span>
<span class="token keyword">done</span>
</code></pre> 
<h3><a id="scheduler_1616"></a>scheduler</h3> 
<h4><a id="scheduler_1618"></a>准备scheduler证书</h4> 
<p>准备scheduler证书申请文件</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/ssl/kube-scheduler-csr.json</span>
{
  "CN": "system:kube-scheduler",
  "hosts": [
    "127.0.0.1",
    "<span class="token variable">$node1</span>",
    "<span class="token variable">$node2</span>",
    "<span class="token variable">$node3</span>"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "HuBei",
      "L": "WuHan",
      "O": "system:kube-scheduler",
      "OU": "System"
    }
  ]
}
EOF</span>
</code></pre> 
<p>创建kube-scheduler证书</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-scheduler-csr.json <span class="token operator">|</span>cfssljson -bare kube-scheduler
</code></pre> 
<h4><a id="kubeconfig_1657"></a>创建kubeconfig</h4> 
<blockquote> 
 <p>设置集群参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span>https://<span class="token variable">$VIP_server</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-scheduler.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置客户端认证参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-credentials system:kube-scheduler <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>kube-scheduler.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>kube-scheduler-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-scheduler.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置上下文参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-context system:kube-scheduler <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>system:kube-scheduler <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-scheduler.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置默认上下文</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
use-context system:kube-scheduler --kubeconfig<span class="token operator">=</span>kube-scheduler.kubeconfig
</code></pre> 
<h4><a id="service_1702"></a>准备service文件</h4> 
<blockquote> 
 <p><a href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-scheduler/" rel="nofollow">参考</a></p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/service/
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> kube-scheduler.service</span>
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-scheduler <span class="token entity" title="\\">\\</span>
  --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig <span class="token entity" title="\\">\\</span>
  --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig <span class="token entity" title="\\">\\</span>
  --bind-address=0.0.0.0 <span class="token entity" title="\\">\\</span>
  --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig <span class="token entity" title="\\">\\</span>
  --leader-elect=true <span class="token entity" title="\\">\\</span>
  --v=2
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h4><a id="scheduler_1729"></a>分发scheduler文件并启动</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token builtin class-name">cd</span> /k8s/service
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${MASTERS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span> 
    <span class="token function">scp</span> /k8s/ssl/kube-scheduler<span class="token punctuation">{<!-- --></span>,-key<span class="token punctuation">}</span>.pem <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">${K8S_SSL_Path}</span>/
    <span class="token function">scp</span> /k8s/ssl/kube-scheduler.kubeconfig <span class="token variable">$host</span>:/etc/kubernetes/
    <span class="token function">scp</span> /k8s/pkg/kubernetes/server/bin/kube-scheduler  <span class="token variable">$host</span>:/usr/local/bin/
    <span class="token function">scp</span> kube-scheduler.service <span class="token variable">$host</span>:/etc/systemd/system/kube-scheduler.service
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl daemon-reload"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable kube-scheduler --now"</span>
<span class="token keyword">done</span>
</code></pre> 
<h3><a id="_1744"></a>检查管理组件需要的服务是否正常</h3> 
<pre><code class="prism language-shell">kubectl get componentstatuses （可简写为cs）

NAME                 STATUS    MESSAGE                         ERROR
etcd-0               Healthy   <span class="token punctuation">{<!-- --></span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span>   
controller-manager   Healthy   ok                              
etcd-2               Healthy   <span class="token punctuation">{<!-- --></span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span>   
etcd-1               Healthy   <span class="token punctuation">{<!-- --></span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span>   
scheduler            Healthy   ok  
</code></pre> 
<h3><a id="kubelet_1757"></a>kubelet</h3> 
<h4><a id="kubelet_1759"></a>准备kubelet证书</h4> 
<blockquote> 
 <p>kubelet计划每个节点单独配置一个证书文件，因此先使用模板，后面一一替换生成证书</p> 
</blockquote> 
<p>准备kubelet证书申请文件</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/ssl/kubelet-csr.json.template</span>
{
    "CN": "system:node:##nodeIP##",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "hosts": [
      "127.0.0.1",
      "##nodeIP##"
    ],
    "names": [
      {
        "C": "CN",
        "ST": "HuBei",
        "L": "WuHan",
        "O": "system:nodes",
        "OU": "System"
      }
    ]
}
EOF</span>
</code></pre> 
<p>创建kubelet证书</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
<span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token keyword">do</span>
  <span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> <span class="token builtin class-name">echo</span> <span class="token string">"$"</span>$host<span class="token variable">)</span></span> 
  <span class="token function">sed</span> <span class="token string">"s/##nodeIP##/<span class="token variable">$IP</span>/g"</span> kubelet-csr.json.template <span class="token operator">&gt;</span> kubelet-csr.<span class="token variable">${host}</span>.json
  cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kubelet-csr.<span class="token variable">${host}</span>.json <span class="token operator">|</span>cfssljson -bare kubelet.<span class="token variable">${host}</span>
<span class="token keyword">done</span>
</code></pre> 
<h4><a id="kubeconfig_1803"></a>创建kubeconfig</h4> 
<blockquote> 
 <p>设置集群参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token keyword">do</span>
    kubectl config <span class="token punctuation">\</span>
    set-cluster kubernetes <span class="token punctuation">\</span>
    --certificate-authority<span class="token operator">=</span>ca.pem <span class="token punctuation">\</span>
    --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
    --server<span class="token operator">=</span>https://<span class="token variable">$VIP_server</span> <span class="token punctuation">\</span>
    --kubeconfig<span class="token operator">=</span>kubelet.kubeconfig.<span class="token variable">$host</span>
<span class="token keyword">done</span>
</code></pre> 
<blockquote> 
 <p>设置客户端认证参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
<span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token keyword">do</span> 
    kubectl config <span class="token punctuation">\</span>
    set-credentials system:node:<span class="token variable">$host</span> <span class="token punctuation">\</span>
    --client-certificate<span class="token operator">=</span>kubelet.<span class="token variable">${host}</span>.pem <span class="token punctuation">\</span>
    --client-key<span class="token operator">=</span>kubelet.<span class="token variable">${host}</span>-key.pem <span class="token punctuation">\</span>
    --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
    --kubeconfig<span class="token operator">=</span>kubelet.kubeconfig.<span class="token variable">$host</span>
<span class="token keyword">done</span>
</code></pre> 
<blockquote> 
 <p>设置上下文参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
<span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token keyword">do</span> 
    kubectl config <span class="token punctuation">\</span>
    set-context system:node:<span class="token variable">$host</span> <span class="token punctuation">\</span>
    --cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
    --user<span class="token operator">=</span>system:node:<span class="token variable">$host</span> <span class="token punctuation">\</span>
    --kubeconfig<span class="token operator">=</span>kubelet.kubeconfig.<span class="token variable">$host</span>
<span class="token keyword">done</span>   
</code></pre> 
<blockquote> 
 <p>设置默认上下文</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
<span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token keyword">do</span> 
    kubectl config <span class="token punctuation">\</span>
    use-context system:node:<span class="token variable">$host</span> <span class="token punctuation">\</span>
    --cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
    --kubeconfig<span class="token operator">=</span>kubelet.kubeconfig.<span class="token variable">$host</span>
<span class="token keyword">done</span>   
</code></pre> 
<h4><a id="kubelet_1873"></a>准备kubelet配置文件</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/conf
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> kubelet-config.yaml</span>
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: 0.0.0.0
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: <span class="token variable">$K8S_SSL_Path</span>/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: true
clusterDNS:
- <span class="token variable">$CLUSTER_KUBERNETES_SVC_IP</span>
clusterDomain: cluster.local
configMapAndSecretChangeDetectionStrategy: Watch
containerLogMaxFiles: 3
containerLogMaxSize: 10Mi
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 300Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 40s
hairpinMode: hairpin-veth
healthzBindAddress: 0.0.0.0
healthzPort: 10248
httpCheckFrequency: 40s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
kubeAPIBurst: 100
kubeAPIQPS: 50
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeLeaseDurationSeconds: 40
nodeStatusReportFrequency: 1m0s
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
port: 10250
# disable readOnlyPort
readOnlyPort: 0
resolvConf: /etc/resolv.conf
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
tlsCertFile: <span class="token variable">$K8S_SSL_Path</span>/kubelet.pem
tlsPrivateKeyFile: <span class="token variable">$K8S_SSL_Path</span>/kubelet-key.pem
EOF</span>

</code></pre> 
<h4><a id="service_1947"></a>准备service文件</h4> 
<blockquote> 
 <p><a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet/" rel="nofollow">参考</a></p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/service/
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> kubelet.service.template</span>
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
WorkingDirectory=/var/lib/kubelet
ExecStart=/usr/local/bin/kubelet <span class="token entity" title="\\">\\</span>
  --config=/etc/kubernetes/kubelet-config.yaml <span class="token entity" title="\\">\\</span>
  --container-runtime=remote <span class="token entity" title="\\">\\</span>
  --container-runtime-endpoint=unix:///var/run/cri-dockerd.sock <span class="token entity" title="\\">\\</span>
  --hostname-override=##hostIP## <span class="token entity" title="\\">\\</span>
  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig <span class="token entity" title="\\">\\</span>
  --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.9 <span class="token entity" title="\\">\\</span>
  --root-dir=/var/lib/kubelet <span class="token entity" title="\\">\\</span>
  --v=2
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h4><a id="kubelet_1979"></a>分发kubelet文件并启动</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/service/
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token keyword">do</span>
    <span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> <span class="token builtin class-name">echo</span> <span class="token string">"$"</span>$host<span class="token variable">)</span></span> 
    <span class="token function">sed</span>  <span class="token string">"s@##hostIP##@<span class="token variable">$IP</span>@g"</span> kubelet.service.template <span class="token operator">&gt;</span> kubelet.service.<span class="token variable">$host</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"mkdir -p <span class="token variable">$K8S_SSL_Path</span> -p"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"mkdir -p /var/lib/kubelet -p"</span>
    <span class="token function">scp</span> /k8s/ssl/ca*.pem <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$K8S_SSL_Path</span>/
    <span class="token function">scp</span> /k8s/ssl/kubelet.<span class="token variable">${host}</span>.pem <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$K8S_SSL_Path</span>/kubelet.pem
    <span class="token function">scp</span> /k8s/ssl/kubelet.<span class="token variable">${host}</span>-key.pem <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$K8S_SSL_Path</span>/kubelet-key.pem
    <span class="token function">scp</span> /k8s/ssl/kubelet.kubeconfig.<span class="token variable">$host</span> <span class="token variable">$host</span>:/etc/kubernetes/kubelet.kubeconfig
    <span class="token function">scp</span> kubelet.service.<span class="token variable">$host</span> <span class="token variable">$host</span>:/etc/systemd/system/kubelet.service
    <span class="token function">scp</span> /k8s/conf/kubelet-config.yaml <span class="token variable">$host</span>:/etc/kubernetes/kubelet-config.yaml
    <span class="token function">scp</span> /k8s/pkg/kubernetes/server/bin/kubelet <span class="token variable">$host</span>:/usr/local/bin/
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable kubelet --now"</span>
<span class="token keyword">done</span>
</code></pre> 
<h3><a id="kubeproxy_2002"></a>kube-proxy</h3> 
<h4><a id="kubeproxy_2004"></a>准备kube-proxy证书</h4> 
<p>准备ku-proxy证书申请文件</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/ssl/kube-proxy-csr.json</span>
{
    "CN": "system:kube-proxy",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
      {
        "C": "CN",
        "ST": "HuBei",
        "L": "WuHan",
        "O": "system:nodes",
        "OU": "System"
      }
    ]
}
EOF</span>
</code></pre> 
<p>创建kube-proxy证书</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-proxy-csr.json <span class="token operator">|</span>cfssljson -bare kube-proxy
</code></pre> 
<h4><a id="kubeconfig_2036"></a>创建kubeconfig</h4> 
<blockquote> 
 <p>设置集群参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span>https://<span class="token variable">$VIP_server</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置客户端认证参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-credentials system:kube-proxy <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>kube-proxy.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>kube-proxy-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置上下文参数</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
set-context system:kube-proxy <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>system:kube-proxy <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
</code></pre> 
<blockquote> 
 <p>设置默认上下文</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/ssl/
kubectl config <span class="token punctuation">\</span>
use-context system:kube-proxy --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
</code></pre> 
<h4><a id="kubeproxy_2089"></a>创建kube-proxy配置文件</h4> 
<blockquote> 
 <p>参数要与前面的对应</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/conf/
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> kube-proxy-config.yaml.template</span>
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
clientConnection:
  kubeconfig: "/etc/kubernetes/kube-proxy.kubeconfig"
clusterCIDR: "<span class="token variable">$CLUSTER_CIDR</span>"
conntrack:
  maxPerCore: 32768
  min: 131072
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: "##hostIP##"
metricsBindAddress: 0.0.0.0:10249
mode: "ipvs"
EOF</span>
</code></pre> 
<h4><a id="service_2116"></a>准备service文件</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/service/
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> kube-proxy.service</span>
[Unit]
Description=Kubernetes Kube-Proxy Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
# kube-proxy 根据 --cluster-cidr 判断集群内部和外部流量
## 指定 --cluster-cidr 或 --masquerade-all 选项后
## kube-proxy 会对访问 Service IP 的请求做 SNAT
WorkingDirectory=/var/lib/kube-proxy
ExecStart=/usr/local/bin/kube-proxy <span class="token entity" title="\\">\\</span>
  --config=/etc/kubernetes/kube-proxy-config.yaml
Restart=always
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h4><a id="kubeproxy_2144"></a>分发kube-proxy文件并启动</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /k8s/service/
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token variable">${HOSTS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token keyword">do</span>
    <span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> <span class="token builtin class-name">echo</span> <span class="token string">"$"</span>$host<span class="token variable">)</span></span> 
    <span class="token function">sed</span>  <span class="token string">"s@##hostIP##@<span class="token variable">$IP</span>@g"</span> /k8s/conf/kube-proxy-config.yaml.template <span class="token operator">&gt;</span> /k8s/conf/kube-proxy-config.yaml.<span class="token variable">$host</span>
    <span class="token comment"># ssh $host "mkdir -p $K8S_SSL_Path -p"</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"mkdir -p /var/lib/kube-proxy -p"</span>
    <span class="token comment"># scp /k8s/ssl/ca*.pem $host:$K8S_SSL_Path/</span>
    <span class="token comment"># scp /k8s/ssl/kube-proxy{,-key}.pem $host:$K8S_SSL_Path/kubelet.pem</span>
    
    <span class="token function">scp</span> /k8s/ssl/kube-proxy.kubeconfig <span class="token variable">$host</span>:/etc/kubernetes/
    <span class="token function">scp</span> kube-proxy.service <span class="token variable">$host</span>:/etc/systemd/system/
    <span class="token function">scp</span> /k8s/conf/kube-proxy-config.yaml.<span class="token variable">$host</span> <span class="token variable">$host</span>:/etc/kubernetes/kube-proxy-config.yaml
    <span class="token function">scp</span> /k8s/pkg/kubernetes/server/bin/kube-proxy <span class="token variable">$host</span>:/usr/local/bin/
    <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">"systemctl enable kube-proxy --now"</span>
<span class="token keyword">done</span>
</code></pre> 
<h3><a id="_2165"></a>检查是否起来</h3> 
<pre><code class="prism language-shell">kubectl get node,svc,cs -owide
</code></pre> 
<p>我这边的输出如下</p> 
<pre><code class="prism language-shell">Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                STATUS     ROLES    AGE   VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION              CONTAINER-RUNTIME
node/10.10.21.223   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   31m   v1.26.5   <span class="token number">10.10</span>.21.223   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">6.3</span>.3-1.el7.elrepo.x86_64   docker://23.0.6
node/10.10.21.224   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   31m   v1.26.5   <span class="token number">10.10</span>.21.224   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-1160.el7.x86_64      docker://23.0.6
node/10.10.21.225   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   31m   v1.26.5   <span class="token number">10.10</span>.21.225   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-1160.el7.x86_64      docker://23.0.6
node/10.10.21.226   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   27m   v1.26.5   <span class="token number">10.10</span>.21.226   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">6.3</span>.3-1.el7.elrepo.x86_64   docker://23.0.6

NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR
service/kubernetes   ClusterIP   <span class="token number">192.168</span>.0.1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   4h    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

NAME                                 STATUS    MESSAGE                         ERROR
componentstatus/scheduler            Healthy   ok                              
componentstatus/controller-manager   Healthy   ok                              
componentstatus/etcd-2               Healthy   <span class="token punctuation">{<!-- --></span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span>   
componentstatus/etcd-1               Healthy   <span class="token punctuation">{<!-- --></span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span>   
componentstatus/etcd-0               Healthy   <span class="token punctuation">{<!-- --></span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span>  
</code></pre> 
<p>开始初始化</p> 
<pre><code class="prism language-shell"><span class="token function">sed</span> -i <span class="token string">"s@##node1##@<span class="token variable">$node1</span>@g"</span> kubeadm_init.yaml 
<span class="token function">sed</span> -i <span class="token string">"s@##SERVICE_CIDR##@<span class="token variable">$SERVICE_CIDR</span>@g"</span> kubeadm_init.yaml 
<span class="token function">sed</span> -i <span class="token string">"s@##CLUSTER_CIDR##@<span class="token variable">$CLUSTER_CIDR</span>@g"</span> kubeadm_init.yaml 
<span class="token function">sed</span> -i <span class="token string">"s@##CLUSTER_KUBERNETES_SVC_IP##@<span class="token variable">$CLUSTER_KUBERNETES_SVC_IP</span>@g"</span> kubeadm_init.yaml
kubeadm init --config<span class="token operator">=</span>kubeadm_init.yaml
</code></pre> 
<p>配置kubeconfig</p> 
<pre><code class="prism language-shell"> <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
 <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
 <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre> 
<h2><a id="_2222"></a>安装网络插件</h2> 
<h3><a id="cni_2224"></a>cni插件</h3> 
<blockquote> 
 <p>k8s常见的网络插件有很多，如flannel、cilium、calico等，如果是在各个云厂商的环境跑，可能每个厂商也都有自己的网络插件</p> 
 <p>这里我们选择calico来部署</p> 
</blockquote> 
<blockquote> 
 <p>从官方下载yaml文件</p> 
</blockquote> 
<pre><code class="prism language-yaml">wget <span class="token punctuation">-</span>O /k8s/conf/calico.yaml <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>check<span class="token punctuation">-</span>certificate https<span class="token punctuation">:</span>//docs.tigera.io/archive/v3.25/manifests/calico.yaml
</code></pre> 
<blockquote> 
 <p>修改CIDR</p> 
</blockquote> 
<p>找到这两行，将注释去掉，然后将<code>value</code>修改成自己的<code>pod</code>的<code>cidr</code></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-4tKNtppi-1684939084814)(https://pek3b.qingstor.com/chenjiao-0606//md/202305242140711.png)]</p> 
<pre><code class="prism language-shell"><span class="token comment"># 如不确定或不记得的话可以查询之前规划的文件 ，也可以直接echo查询</span>
<span class="token builtin class-name">source</span> /k8s/conf/k8s_env.sh
<span class="token builtin class-name">echo</span> <span class="token variable">$CLUSTER_CIDR</span>
</code></pre> 
<pre><code class="prism language-shell">- name: CALICO_IPV4POOL_CIDR
  value: <span class="token string">"172.16.0.0/16"</span>
<span class="token comment"># 我的改出来是这样</span>
</code></pre> 
<blockquote> 
 <p>创建calico对应pod</p> 
</blockquote> 
<pre><code class="prism language-shell">kubectl apply -f /k8s/conf/calico.yaml
<span class="token comment"># 这条命令执行完成会创建很多crd资源</span>
</code></pre> 
<blockquote> 
 <p>如果pod一直在init，那就应该是出问题了，可以看看日志</p> 
</blockquote> 
<pre><code class="prism language-shell"> kubectl -n kube-system logs calico-node-qrtpz 
 <span class="token comment"># 每个人的calico后缀不一样，我这边只是拿我的举例子</span>
Error from server: Get <span class="token string">"https://10.10.21.223:10250/containerLogs/kube-system/calico-node-qrtpz/calico-node"</span><span class="token builtin class-name">:</span> x509: certificate is valid <span class="token keyword">for</span> <span class="token number">127.0</span>.0.1, not <span class="token number">10.1021</span>.223
<span class="token comment"># 看到x509就知道是证书哪里不对，那就可以去检查证书文件，正常是 apiserver、controller-manager、scheduler、kubelet 的证书申请文件写了IP地址，那就重点检查这几个组件的证书申请文件 ，如 kube-scheduler-csr.json </span>
<span class="token comment"># 找到对应问题之后重新修改证书并且重新分发再重启对应组件，一般都可以解决</span>
</code></pre> 
<h3><a id="coredns_2273"></a>coredns</h3> 
<blockquote> 
 <p>准备yaml文件</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /k8s/conf/coredns.yaml</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coredns
  namespace: kube-system
  labels:
      kubernetes.io/cluster-service: "true"
      addonmanager.kubernetes.io/mode: Reconcile
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
    addonmanager.kubernetes.io/mode: Reconcile
  name: system:coredns
rules:
- apiGroups:
  - ""
  resources:
  - endpoints
  - services
  - pods
  - namespaces
  verbs:
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
    addonmanager.kubernetes.io/mode: EnsureExists
  name: system:coredns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:coredns
subjects:
- kind: ServiceAccount
  name: coredns
  namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
  labels:
      addonmanager.kubernetes.io/mode: EnsureExists
data:
  Corefile: |
    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
            max_concurrent 1000
        }
        cache 30
        reload
        loadbalance
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: "true"
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: "CoreDNS"
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  selector:
    matchLabels:
      k8s-app: kube-dns
  template:
    metadata:
      labels:
        k8s-app: kube-dns
    spec:
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      priorityClassName: system-cluster-critical
      serviceAccountName: coredns
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: k8s-app
                    operator: In
                    values: ["kube-dns"]
              topologyKey: kubernetes.io/hostname
      tolerations:
        - key: "CriticalAddonsOnly"
          operator: "Exists"
      nodeSelector:
        kubernetes.io/os: linux
      containers:
      - name: coredns
        image: coredns/coredns:1.9.3
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 300Mi
          requests:
            cpu: 100m
            memory: 70Mi
        args: [ "-conf", "/etc/coredns/Corefile" ]
        volumeMounts:
        - name: config-volume
          mountPath: /etc/coredns
          readOnly: true
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 9153
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 60
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /ready
            port: 8181
            scheme: HTTP
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - all
          readOnlyRootFilesystem: true
      dnsPolicy: Default
      volumes:
        - name: config-volume
          configMap:
            name: coredns
            items:
            - key: Corefile
              path: Corefile
---
apiVersion: v1
kind: Service
metadata:
  name: kube-dns
  namespace: kube-system
  annotations:
    prometheus.io/port: "9153"
    prometheus.io/scrape: "true"
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: "true"
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: "CoreDNS"
spec:
  selector:
    k8s-app: kube-dns
  clusterIP: <span class="token variable">$CLUSTER_KUBERNETES_SVC_IP</span>
  ports:
  - name: dns
    port: 53
    protocol: UDP
  - name: dns-tcp
    port: 53
    protocol: TCP
  - name: metrics
    port: 9153
    protocol: TCP
EOF</span>
</code></pre> 
<blockquote> 
 <p>部署coredns</p> 
</blockquote> 
<pre><code class="prism language-shell">kubectl apply -f /k8s/conf/coredns.yaml
<span class="token comment"># 只有cni插件的pod正常之后，coredns的pod才会正常，否则一直是pending</span>
</code></pre> 
<h2><a id="_2505"></a>验证集群是否正常</h2> 
<pre><code class="prism language-shell">kubectl run mybusybox --image<span class="token operator">=</span>busybox:1.28 --rm -it <span class="token comment"># 创建一个busybox的pod</span>
/<span class="token comment"># nslookup kubernetes</span>

/<span class="token comment"># kube-dns.kube-system</span>

<span class="token comment"># 看能否打印正常结果</span>
</code></pre> 
<blockquote> 
 <p>正常结果如下</p> 
</blockquote> 
<pre><code class="prism language-shell">/ <span class="token comment"># nslookup kubernetes</span>
Server:    <span class="token number">192.168</span>.0.10
Address <span class="token number">1</span>: <span class="token number">192.168</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address <span class="token number">1</span>: <span class="token number">192.168</span>.0.1 kubernetes.default.svc.cluster.local
/ <span class="token comment"># nslookup kube-dns.kube-system</span>
Server:    <span class="token number">192.168</span>.0.10
Address <span class="token number">1</span>: <span class="token number">192.168</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kube-dns.kube-system
Address <span class="token number">1</span>: <span class="token number">192.168</span>.0.10 kube-dns.kube-system.svc.cluster.local
</code></pre> 
<h2><a id="_2535"></a>后记</h2> 
<blockquote> 
 <p>二进制部署完成和kubeadm有一些差别，且二进制的master节点是没有污点的，可以直接调度pod上去，如有需要控制调度可以给node打标签加污点</p> 
</blockquote> 
<pre><code class="prism language-shell">kubectl label nodes <span class="token number">10.10</span>.21.223 kubernetes.io/os<span class="token operator">=</span>linux

kubectl label nodes <span class="token number">10.10</span>.21.223 node-role.kubernetes.io/control-plane<span class="token operator">=</span>

kubectl label nodes <span class="token number">10.10</span>.21.223 node-role.kubernetes.io/master<span class="token operator">=</span>

kubectl taint node <span class="token number">10.10</span>.21.223 node-role.kubernetes.io/master:NoSchedule

<span class="token comment"># 这里对应的是节点的name，也就是 kubectl get node -oname 打印出来的结果</span>
</code></pre> 
<pre><code class="prism language-shell">kubectl get node
NAME           STATUS   ROLES                  AGE    VERSION
<span class="token number">10.10</span>.21.223   Ready    control-plane,master   131m   v1.26.5
<span class="token number">10.10</span>.21.224   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 131m   v1.26.5
<span class="token number">10.10</span>.21.225   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 131m   v1.26.5
<span class="token number">10.10</span>.21.226   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 127m   v1.26.5

kubectl describe node <span class="token number">10.10</span>.21.223 <span class="token operator">|</span><span class="token function">grep</span> -i taints 
Taints:             node-role.kubernetes.io/master:NoSchedule
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3a7440540aa3a5fcf819813b61e978d2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot 插件 spring-boot-maven-plugin 原理，以及SpringBoo工程部署的 jar 包瘦身实战</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/49ebe83a01e92ce393ec17a39b5dc406/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">kali 单元07 渗透攻击</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>