<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ETCD容器化搭建集群 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ETCD容器化搭建集群" />
<meta property="og:description" content="系列文章目录
历史文章1
文章目录 前言一、环境信息二、搭建步骤1.准备前置条件1.1 安装Docker1.2 拉取镜像 2.安装Etcd2.1 新建目录2.2 编辑脚本2.3 执行部署 三、结果验证在这里插入图片描述 总结参考 前言 本文介绍使用docker搭建一个etcd集群，附带对应的搭建脚本。我极力希望讲操作步骤和原理说明的尽量详细，能够让读者更容易理解。
一、环境信息 使用本地的vmstation创建3个虚拟机，信息如下
节点名称节点IP节点配置操作系统Etcd版本Docker版本etcd1192.168.82.1281c1g 20gCentOS7.4v3.513.1etcd2192.168.82.1291c1g 20gCentOS7.4v3.513.1etcd3192.168.82.1301c1g 20gCentOS7.4v3.513.1 说明：服务器应该能够访问公网，以便能够下载对应的etcd镜像
二、搭建步骤 1.准备前置条件 1.1 安装Docker 代码如下（示例）：
# 安装docker yum install -y docker # 重启docker systemctl restart docker # 验证docker docker ps 备注，需要关闭防火墙
systemctl stop firewalld.service systemctl disable firewalld.service 1.2 拉取镜像 代码如下（示例）：
# 拉取镜像 docker pull quay.io/coreos/etcd:v3.5.0 # 验证镜像 docker images|grep etcd 2.安装Etcd 2.1 新建目录 分别在3台机器上都新建目录 /data/etcd，用于挂载到容器中，能够讲etcd的数据持久化到本地磁盘。需要注意的是，再生产环境中尽可能的将etcd的数据目录单独挂载一个磁盘，磁盘的io性能越快越好。磁盘的io带宽尽量需要保证在40MByte/s以上。否则etcd会因为磁盘性能差，导致不断的切主或者无法完成基础的wal&amp;snapshot写入，导致整体集群异常
2.2 编辑脚本 保存如下命令到脚本/data/start.sh，用于搭建etcd集群" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2bd33344e17b59efb429ece0e56a3c98/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-22T19:29:03+08:00" />
<meta property="article:modified_time" content="2022-05-22T19:29:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ETCD容器化搭建集群</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>系列文章目录</strong></p> 
<p><a href="%E5%AF%B9%E5%BA%94%E7%9A%84url" rel="nofollow">历史文章1</a></p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_10" rel="nofollow">前言</a></li><li><a href="#_16" rel="nofollow">一、环境信息</a></li><li><a href="#_29" rel="nofollow">二、搭建步骤</a></li><li><ul><li><a href="#1_30" rel="nofollow">1.准备前置条件</a></li><li><ul><li><a href="#11_Docker_31" rel="nofollow">1.1 安装Docker</a></li><li><a href="#12__49" rel="nofollow">1.2 拉取镜像</a></li></ul> 
   </li><li><a href="#2Etcd_59" rel="nofollow">2.安装Etcd</a></li><li><ul><li><a href="#21__60" rel="nofollow">2.1 新建目录</a></li><li><a href="#22__63" rel="nofollow">2.2 编辑脚本</a></li><li><a href="#23__78" rel="nofollow">2.3 执行部署</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_81" rel="nofollow">三、结果验证</a></li><li><ul><li><a href="#httpsimgblogcsdnimgcnd399247822774fc0a36b0509ba3c3264pngxossprocessimagewatermarktype_d3F5LXplbmhlaQshadow_50text_Q1NETiBA5ZCb5a2Q5Lmd5oCdJiEsize_20color_FFFFFFt_70g_sex_16_95" rel="nofollow">在这里插入图片描述</a></li></ul> 
  </li><li><a href="#_98" rel="nofollow">总结</a></li><li><a href="#_102" rel="nofollow">参考</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_10"></a>前言</h2> 
<p>本文介绍使用docker搭建一个etcd集群，附带对应的搭建脚本。我极力希望讲操作步骤和原理说明的尽量详细，能够让读者更容易理解。</p> 
<hr> 
<h2><a id="_16"></a>一、环境信息</h2> 
<p>使用本地的vmstation创建3个虚拟机，信息如下</p> 
<table><thead><tr><th>节点名称</th><th>节点IP</th><th>节点配置</th><th>操作系统</th><th>Etcd版本</th><th>Docker版本</th></tr></thead><tbody><tr><td>etcd1</td><td>192.168.82.128</td><td>1c1g 20g</td><td>CentOS7.4</td><td>v3.5</td><td>13.1</td></tr><tr><td>etcd2</td><td>192.168.82.129</td><td>1c1g 20g</td><td>CentOS7.4</td><td>v3.5</td><td>13.1</td></tr><tr><td>etcd3</td><td>192.168.82.130</td><td>1c1g 20g</td><td>CentOS7.4</td><td>v3.5</td><td>13.1</td></tr></tbody></table> 
<p>说明：服务器应该能够<strong>访问公网</strong>，以便能够下载对应的etcd镜像</p> 
<h2><a id="_29"></a>二、搭建步骤</h2> 
<h3><a id="1_30"></a>1.准备前置条件</h3> 
<h4><a id="11_Docker_31"></a>1.1 安装Docker</h4> 
<blockquote> 
 <p>代码如下（示例）：</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 安装docker</span>
yum <span class="token function">install</span> -y <span class="token function">docker</span> 
<span class="token comment"># 重启docker</span>
systemctl restart <span class="token function">docker</span> 
<span class="token comment"># 验证docker</span>
<span class="token function">docker</span> <span class="token function">ps</span>
</code></pre> 
<p>备注，需要关闭防火墙</p> 
<pre><code class="prism language-bash">systemctl stop firewalld.service
systemctl disable firewalld.service
</code></pre> 
<h4><a id="12__49"></a>1.2 拉取镜像</h4> 
<blockquote> 
 <p>代码如下（示例）：</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 拉取镜像</span>
<span class="token function">docker</span> pull quay.io/coreos/etcd:v3.5.0  

<span class="token comment"># 验证镜像</span>
<span class="token function">docker</span> images<span class="token operator">|</span><span class="token function">grep</span> etcd
</code></pre> 
<h3><a id="2Etcd_59"></a>2.安装Etcd</h3> 
<h4><a id="21__60"></a>2.1 新建目录</h4> 
<p>分别在3台机器上都新建目录 <strong>/data/etcd</strong>，用于挂载到容器中，能够讲etcd的数据持久化到本地磁盘。需要注意的是，<strong>再生产环境中尽可能的将etcd的数据目录单独挂载一个磁盘，磁盘的io性能越快越好。磁盘的io带宽尽量需要保证在40MByte/s以上</strong>。否则etcd会因为磁盘性能差，导致不断的切主或者无法完成基础的wal&amp;snapshot写入，导致整体集群异常</p> 
<h4><a id="22__63"></a>2.2 编辑脚本</h4> 
<p>保存如下命令到脚本/data/start.sh，用于搭建etcd集群</p> 
<blockquote> 
 <p>代码如下（示例）：</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token shebang important">#! /bin/sh</span>

<span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"etcd1"</span>
<span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token string">"192.168.92.128"</span>
<span class="token assign-left variable">cluster</span><span class="token operator">=</span><span class="token string">"etcd1=http://192.168.92.128:2380,etcd2=http://192.168.92.129:2380,etcd3=http://192.168.92.130:2380"</span>

<span class="token function">docker</span> run -d -p <span class="token number">2379</span>:2379   -p <span class="token number">2380</span>:2380 -v /data/etcd:/etcd-data/   --name <span class="token variable">$name</span> --net<span class="token operator">=</span>host  quay.io/coreos/etcd:v3.5.0   /usr/local/bin/etcd --name <span class="token variable">$name</span>   --data-dir /data/etcd/data   --listen-client-urls http://<span class="token variable">$host</span>:2379  --advertise-client-urls http://<span class="token variable">$host</span>:2379 --listen-peer-urls http://<span class="token variable">$host</span>:2380   --initial-advertise-peer-urls http://<span class="token variable">$host</span>:2380   --initial-cluster <span class="token variable">$cluster</span>  --initial-cluster-token tkn   --initial-cluster-state new   --log-level info   --logger zap   --log-outputs stderr
</code></pre> 
<p>说明：分别在不同机器部署时，分别替换脚本中的host和name即可。</p> 
<h4><a id="23__78"></a>2.3 执行部署</h4> 
<p>分别在3个节点上，编辑和调整完脚本的host、name配置后，执行bash /data/start.sh命令，创建etcd集群。</p> 
<h2><a id="_81"></a>三、结果验证</h2> 
<p>任意选一个节点，执行如下命令，进行集群验证，验证是否已经搭建完成。</p> 
<blockquote> 
 <p>代码如下（示例）：</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCD_ENDPOINTS</span><span class="token operator">=</span><span class="token number">192.168</span>.92.128:2379,192.168.92.129:2379,192.168.92.130:2379

/usr/local/bin/etcdctl --endpoints<span class="token operator">=</span><span class="token number">192.168</span>.92.128:2379 --write-out<span class="token operator">=</span>table member list
/usr/local/bin/etcdctl --endpoints<span class="token operator">=</span><span class="token variable">$ETCD_ENDPOINTS</span> --write-out<span class="token operator">=</span>table endpoint status
</code></pre> 
<p>注意 member list是记录整个集群中的所有节点信息。并不能反应集群当前的运行状态<br> endopont status是反应当前集群的运行状态，需要有Leader节点，并且datasize不为0，则说明集群搭建正常</p> 
<h3><a id="httpsimgblogcsdnimgcnd399247822774fc0a36b0509ba3c3264pngxossprocessimagewatermarktype_d3F5LXplbmhlaQshadow_50text_Q1NETiBA5ZCb5a2Q5Lmd5oCdJiEsize_20color_FFFFFFt_70g_sex_16_95"></a><img src="https://images2.imgbox.com/de/e1/8HrqQBIw_o.png" alt="在这里插入图片描述"></h3> 
<h2><a id="_98"></a>总结</h2> 
<p>如果单机节点运行<code>bash /data/start.sh</code>后，可以通过执行<code>docker ps -a|grep etcd</code>验证容器是否创建。并通过<code>docker logs ${dockerid}</code>的方法查看日志</p> 
<h2><a id="_102"></a>参考</h2> 
<ul><li><a href="https://etcd.io/docs/v3.5/install/" rel="nofollow">官网</a></li><li><a href="https://github.com/etcd-io/etcd/releases/">github</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1bffe87895f220b3eb5b102304768bda/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">张赐荣 | PHP 获取喜马拉雅音频直链地址</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ea7c32270c2e6aaacf2267d1bd2fefa5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">链表——递归魔法：反转单链表</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>