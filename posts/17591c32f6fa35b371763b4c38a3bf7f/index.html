<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Cloud Ribbon负载均衡策略（IRule接口） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring Cloud Ribbon负载均衡策略（IRule接口）" />
<meta property="og:description" content="Ribbon负载均衡策略 可以看到 Ribbon 中实现了非常多的选择策略，下面来详细解读一下 IRule 接口的各个实现。
AbstractLoadBalancerRule 负载均衡的策略的抽象类，在该抽象类中定义了负载均衡器 ILoadBalancer 对象，该对象能够在具体实现选择服务策略时，获取到一些负载均衡器中维护的信息来作为分配依据，并以此设计一些算法来实现针对特定场景的高效策略。
/** * Class that provides a default implementation for setting and getting load balancer * 该类提供用户设置和获取负载均衡器的默认实现 * @author stonse * */ public abstract class AbstractLoadBalancerRule implements IRule, IClientConfigAware { private ILoadBalancer lb; @Override public void setLoadBalancer(ILoadBalancer lb){ this.lb = lb; } @Override public ILoadBalancer getLoadBalancer(){ return lb; } } RandomRule 该策略实现了从服务实力清单中随机选择一个服务实例的功能。
@Override public Server choose(Object key) { return choose(getLoadBalancer(), key); } public Server choose(ILoadBalancer lb, Object key) { if (lb == null) { return null; } Server server = null; while (server == null) { if (Thread." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/17591c32f6fa35b371763b4c38a3bf7f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-12T00:28:11+08:00" />
<meta property="article:modified_time" content="2022-12-12T00:28:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Cloud Ribbon负载均衡策略（IRule接口）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Ribbon_0"></a>Ribbon负载均衡策略</h2> 
<p><img src="https://images2.imgbox.com/db/4d/eT4Ka4VZ_o.png" alt="在这里插入图片描述"><br> 可以看到 <code>Ribbon</code> 中实现了非常多的选择策略，下面来详细解读一下 <code>IRule</code> 接口的各个实现。</p> 
<h3><a id="AbstractLoadBalancerRule_4"></a>AbstractLoadBalancerRule</h3> 
<p>负载均衡的策略的抽象类，在该抽象类中定义了负载均衡器 <code>ILoadBalancer</code> 对象，该对象能够在具体实现选择服务策略时，获取到一些负载均衡器中维护的信息来作为分配依据，并以此设计一些算法来实现针对特定场景的高效策略。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Class that provides a default implementation for setting and getting load balancer
 * 该类提供用户设置和获取负载均衡器的默认实现
 * @author stonse
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token keyword">implements</span> <span class="token class-name">IRule</span><span class="token punctuation">,</span> <span class="token class-name">IClientConfigAware</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">;</span>
        
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lb <span class="token operator">=</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ILoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>      
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="RandomRule_31"></a>RandomRule</h3> 
<p>该策略实现了从服务实力清单中随机选择一个服务实例的功能。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">return</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//可用实例集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> upList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/*
             * No servers. End regardless of pass, because subsequent passes
             * only get more restrictive.
             */</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> index <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        server <span class="token operator">=</span> upList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/*
             * 服务器列表在被维护的情况下，可能会出现为null，释放CPU资源再重试
             */</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Shouldn't actually happen.. but must be transient or a bug.</span>
        server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> server<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到 <code>IRole</code> 接口的 <code>choose(Object key)</code> 函数实现，委托给了该类中的 <code>choose(ILoadBalancer lb, Object key)</code>，该方法增加了一个负载均衡器对象的参数。从具体的实现上看，他会使用传入的负载均衡器来获得可用实例列表 <code>upList</code> 和所有实例列表 <code>allList</code>，并通过 <code>rand.nextInt(serverCount)</code> 函数来获取一个随机数，并将该随机数作为 <code>upList</code> 的索引来返回具体实现。同时，具体的选择逻辑在一个 <code>while(server == null)</code> 循环之内，而根据选择逻辑的实现，正常情况下每次选择都应该选出一个服务实例，如果出现死循环获取不到服务实例时，则很有可能存在并发的 <code>Bug</code>。</p> 
<h3><a id="RoundRobinRule_91"></a>RoundRobinRule</h3> 
<p>该策略实现了按照线型轮询的方式一次选择每个服务实例的功能。</p> 
<p>其详细结构与 <code>RandomRule</code> 非常类似，除了循环条件不同外，就是从可以列表中获取所谓的逻辑不同。从循环条件中，我们可以看到增加了一个 <code>count</code> 计数变量，该变量会在每次循环值后累加，也就是说，如果一直选择不到 <code>server</code> 超过10次，那么就会结束尝试，并打印一个警告信息 <code>No up servers available from load balancer: ...</code>。而线型轮询的实现则是通过 <code>AtomicInteger nextServerCyclicCounter</code> 对象实现，每次进行实例选择时通过调用 <code>incrementAndGetModulo</code> 函数实现递增。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"no load balancer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> count<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> reachableServers <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allServers <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> upCount <span class="token operator">=</span> reachableServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>upCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"No up servers available from load balancer: "</span> <span class="token operator">+</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> nextServerIndex <span class="token operator">=</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        server <span class="token operator">=</span> allServers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextServerIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* Transient. */</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isReadyToServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Next.</span>
        server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"No available alive servers after 10 tries from load balancer: "</span>
                <span class="token operator">+</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> server<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="RetryRule_142"></a>RetryRule</h3> 
<p>该策略实现了一个具备重试机制的实例选择功能。从下边的实现中我们可以看到，在其内部还定义了一个 <code>IRule</code> 对象，默认使用了 <code>RoundRobinRule</code> 实例。而在 <code>choose</code> 方法中则实现了对内部定义的策略进行反复尝试的策略，若期间能够选择到具体的服务实例就返回，若选择不到就根据设置的尝试结束时间为阈值（<code>maxRetryMillis 参数定义的值 + choose方法开始中的时间戳</code>），当超过该阈值后就返回 <code>null</code>。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RetryRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">IRule</span> subRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> maxRetryMillis <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/*
	 * Loop if necessary. Note that the time CAN be exceeded depending on the
	 * subRule, because we're not spawning additional threads and returning
	 * early.
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">long</span> requestTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">long</span> deadline <span class="token operator">=</span> requestTime <span class="token operator">+</span> maxRetryMillis<span class="token punctuation">;</span>

		<span class="token class-name">Server</span> answer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

		answer <span class="token operator">=</span> subRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> deadline<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

			<span class="token class-name">InterruptTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterruptTask</span><span class="token punctuation">(</span>deadline
					<span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				answer <span class="token operator">=</span> subRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> deadline<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">/* pause and retry hoping it's transient */</span>
					<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> answer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="WeightedResponseTimeRule_198"></a>WeightedResponseTimeRule</h3> 
<p>该策略是对 <code>RoundRobinRule</code> 的扩展，增加了根据实例的运行情况来计算权重，并根据权重来挑选实例，以达到更优的分配效果，他的实现主要有三个核心内容。</p> 
<h4><a id="_202"></a>定时任务</h4> 
<p><code>WeightedResponseTimeRule</code> 策略在初始化的时候会通过 <code>serverWeightTimer.schedule(new DynamicServerWeightTask(), 0, serverWeightTaskTimerInterval)</code> 启动一个定时任务，用来为每个服务实例计算权重，该任务默认30秒执行一次。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">DynamicServerWeightTask</span> <span class="token keyword">extends</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerWeight</span> serverWeight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            serverWeight<span class="token punctuation">.</span><span class="token function">maintainWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
                    <span class="token string">"Throwable caught while running DynamicServerWeightTask for "</span>
                            <span class="token operator">+</span> name<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_221"></a>权重计算</h4> 
<p>在源码中我们可以轻松找到用于存储权重的对象<code>List&lt;Double&gt; accumulatedWeights = new ArrayList&lt;Double&gt;()</code>，该 <code>List</code> 中每个权重值所处的位置对应了负载均衡器维护的服务实例清单中所有示例在清单中的位置。</p> 
<p>维护实例权重的计算过程通过 <code>maintainWeight</code> 函数事项，具体如下面的代码所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">maintainWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ILoadBalancer</span> lb <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>serverWeightAssignmentInProgress<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Ping in progress - nothing to do</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        serverWeightAssignmentInProgress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Weight adjusting job started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AbstractLoadBalancer</span> nlb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractLoadBalancer</span><span class="token punctuation">)</span> lb<span class="token punctuation">;</span>
        <span class="token class-name">LoadBalancerStats</span> stats <span class="token operator">=</span> nlb<span class="token punctuation">.</span><span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// no statistics, nothing to do</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//所有示例的平均响应时间总和</span>
        <span class="token keyword">double</span> totalResponseTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> nlb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果服务实例的状态快照不在缓存汇总，这里会进行自动加载</span>
            <span class="token class-name">ServerStats</span> ss <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            totalResponseTime <span class="token operator">+=</span> ss<span class="token punctuation">.</span><span class="token function">getResponseTimeAvg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// weight for each server is (sum of responseTime of all servers - responseTime)</span>
        <span class="token comment">// so that the longer the response time, the less the weight and the less likely to be chosen</span>
        <span class="token class-name">Double</span> weightSoFar <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        
        <span class="token comment">// create new list and hot swap the reference</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> finalWeights <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> nlb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ServerStats</span> ss <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">double</span> weight <span class="token operator">=</span> totalResponseTime <span class="token operator">-</span> ss<span class="token punctuation">.</span><span class="token function">getResponseTimeAvg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            weightSoFar <span class="token operator">+=</span> weight<span class="token punctuation">;</span>
            finalWeights<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>weightSoFar<span class="token punctuation">)</span><span class="token punctuation">;</span>   
        <span class="token punctuation">}</span>
        <span class="token function">setWeights</span><span class="token punctuation">(</span>finalWeights<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Exception while dynamically calculating server weights"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        serverWeightAssignmentInProgress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>该函数的实现主要分为两个步骤：</p> 
<ul><li>根据 <code>LoadBalancerStats</code> 中记录的每个实例的统计信息，累加所有示例的平台响应时间，得到总平均响应时间 <code>totalResponseTime</code>，该值会用于后续的计算。</li><li>为负载均衡器中维护的实例清单逐个计算权重（从第一个开始），计算规则为 <code>weightSoFar + totalResponseTime - 实例的平均响应时间</code>，其中 <code>weightSoFar</code> 初始化为零，并且每计算好一个权重需要累加到 <code>weightSoFar</code> 上供下一次计算使用。</li></ul> 
<blockquote> 
 <p>举个简单的例子来理解这个计算过程，假设有4个实例A、B、C、D，他们的平均响应时间为10、40、60、80、100，所以总平均响应时间是 <code>10 + 40 + 80 + 100 = 230</code>，每个实例的权重为总响应时间与实例自身的平均响应时间的差的累计所得，所以实例A、B、C、D的权重分别如下所示。</p> 
 <ul><li>实例 A：<code>230 - 10 = 220</code></li><li>实例 B：<code>220 + (230 - 40) = 410</code></li><li>实例 C：<code>410 + (230 - 80) = 560</code></li><li>实例 D：<code>60 + (230 - 100) = 690</code></li></ul> 
 <p>需要注意的是，这里的权重值只是表示了各实例权重区间的上限，并非某个实例的优先级，所以不是数据越大被选中的概率就越大。那么什么是权重区间呢？以上边的计算记过为例，它实例上是为这4个实例构建了4个不同的区间，每个实例的区间下限是上一个实例的区间上线，而每个实例的区间上限则是我们上边计算并存储于 <code>List accumulatedWeights</code> 中的权重值，其中第一个实例的下限默认为零。所以，根据上面实例的权重计算结果，我们可以得到每个实例的权重区间。</p> 
 <ul><li>实例 A：<code>[0, 220]</code></li><li>实例 B：<code>(220, 410]</code></li><li>实例 C：<code>(410, 560]</code></li><li>实例 D：<code>(560, 690)</code></li></ul> 
 <p>不难发现，实例上每个区间的宽度就是：总的平均响应时间 - 实例的平均响应时间，所以实例的平均响应时间越短，权重区间的宽度越大，而权重区间的宽度越大被选中的概率就越高。具体这些区间边界的开闭是如何确定的？为什么不那么规则？会通过下面的实例选择算法来进行解释。</p> 
</blockquote> 
<h4><a id="_300"></a>实例选择</h4> 
<p><code>WeightedResponseTimeRule</code> 选择实例的实现与之前介绍的算法结构类似，下边是它主题的算法（省略了循环体和一些判断等处理）：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// get hold of the current reference in case it is changed from the other thread</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> currentWeights <span class="token operator">=</span> accumulatedWeights<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> serverIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取最后一个实例的权重</span>
        <span class="token keyword">double</span> maxTotalWeight <span class="token operator">=</span> currentWeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> currentWeights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentWeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// 如果最后一个实例的权重值小于0.001，则采用父类实现的线型轮询的策略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxTotalWeight <span class="token operator">&lt;</span> <span class="token number">0.001d</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            server <span class="token operator">=</span>  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> server<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果最后一个实例的权重值大于等于0.001，就产生一个[0, maxTotalWeight)的随机数</span>
            <span class="token keyword">double</span> randomWeight <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> maxTotalWeight<span class="token punctuation">;</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Double</span> d <span class="token operator">:</span> currentWeights<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 遍历维护的权重清单，若权重大于等于随机得到的数值，就选择这个实例</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&gt;=</span> randomWeight<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    serverIndex <span class="token operator">=</span> n<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    n<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            server <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serverIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* Transient. */</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Next.</span>
        server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> server<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从源码中我们可以看到，选择实例的核心过程就两步：</p> 
<ul><li> <p>生成一个 <code>[0, 最大权重值)</code> 区间内的随机数。</p> </li><li> <p>遍历权重列表，比较权重值与随机数的大小，如果权重值大于等于随机数，就拿当前权重列表的索引值去服务实例列表中获取具体的实例。</p> 
  <blockquote> 
   <p>这就是在上一节中提到的服务实例会根据权重区间挑选的原理，而权重区间边界的开闭原则根据算法，正常每个区间为 <code>(x, y]</code> 的形式，但是第一个实例和最后一个实例为什么不同呢？由于随机数的最小值可以为0，所以第一个实例的下限是闭区间，同时随机数的最大值娶不到最大权重值，所以最后一个实例的上线是开区间。</p> 
  </blockquote> </li></ul> 
<p>若继续以上面的数据为例进行服务实例的选择，则该方法会从 <code>[0, 690)</code> 区间中选出一个随机数，比如选出的随机数为230，由于该值位于第二个区间，所以此时就会选择实例B来进行请求。</p> 
<h3><a id="ClientConfigEnabledRoundRobinRule_379"></a>ClientConfigEnabledRoundRobinRule</h3> 
<p>该策略较为特殊，我们一般不直接使用它，因为他本身并没有实现什么特殊的处理逻辑，正如下面的源码所示，在它的内部定义了一个 <code>RoundRobinRule</code> 策略，而 choose 函数的实现也正是使用了 <code>RoundRobinRule</code> 的线型轮询机制，所以它实现的功能实际上与 <code>RoundRobinRule</code> 相同。</p> 
<p>虽然我们不会直接使用该策略，但是通过继承该策略，默认的 <code>choose</code> 就实现了线程轮询机制，在子类中做一些高级策略时通常有可能会存在一些无法实施的情况，那么就可以用父类的实现作为备选。在后文中我们将继续介绍的高级策略军事基于 <code>ClientConfigEnabledRoundRobinRule</code> 的扩展。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientConfigEnabledRoundRobinRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">RoundRobinRule</span> roundRobinRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>roundRobinRule <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> roundRobinRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                    <span class="token string">"This class has not been initialized with the RoundRobinRule class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="BestAvailableRule_405"></a>BestAvailableRule</h3> 
<p>该策略继承自 <code>ClientConfigEnabledRoundRobinRule</code>，在实现中它注入了负载均衡器的统计对象 <code>LoadBalancerStats</code>，同时在具体的 <code>choose</code> 算法中利用 <code>LoadBalancerStats</code> 保存的实例统计信息来选择满足要求的实例，从如下源码中我们可以看到，他通过遍历负载均衡器中维护的所有服务实例，会过滤掉故障的实例，并找出并发请求数最小的一个，所以该策略的特性是可选出最空闲的实例。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancerStats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverList <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> minimalConcurrentConnections <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Server</span> chosen <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token operator">:</span> serverList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerStats</span> serverStats <span class="token operator">=</span> loadBalancerStats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverStats<span class="token punctuation">.</span><span class="token function">isCircuitBreakerTripped</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> concurrentConnections <span class="token operator">=</span> serverStats<span class="token punctuation">.</span><span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>concurrentConnections <span class="token operator">&lt;</span> minimalConcurrentConnections<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                minimalConcurrentConnections <span class="token operator">=</span> concurrentConnections<span class="token punctuation">;</span>
                chosen <span class="token operator">=</span> server<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chosen <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> chosen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同时，由于该算法的核心依据是统计对象 <code>loadBalancerStats</code>，当其为空的时候，该策略是无法执行的。所以从源码中我们可以看到，当 <code>loadBalancerStats</code> 为空的时候，他会采用父类中的线型轮询策略，正如我们在介绍 <code>ClientConfigEnabledRoundRobinRule</code> 时那样，他的子类在无法满足实现高级策略的时候，可以使用线型轮询策略的特性。后边将要介绍的策略应为也都继承自 <code>ClientConfigEnabledRoundRobinRule</code>，所以他们都会具有这样的特性。</p> 
<h3><a id="PredicateBasedRule_438"></a>PredicateBasedRule</h3> 
<p>这是一个抽象策略，它也继承了 <code>ClientConfigEnabledRoundRobinRule</code>，从其命名中可以猜出这是一个基于 <code>Predicate</code> 实现的策略，<code>Predicate</code> 是 <code>Google Guava Collection</code> 工具对集合进行过滤的条件接口。</p> 
<p>如下面的源码所示，它定义了一个抽象函数 <code>getPredicate</code> 来获取 <code>AbstractServerPredicate</code> 对象的实现，而在 <code>choose</code> 函数中，通过 <code>AbstractServerPredicate </code>的 <code>chooseRoundRobinAfterFiltering</code> 函数来挑选出具体的服务实例。从该函数的命名我们也大致能猜出他的基础逻辑：先通过子类中实现的 <code>Predicate</code> 逻辑来过滤一部分服务实例，然后再以线型轮询的方式从过滤后的实例清单中选出一个。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PredicateBasedRule</span> <span class="token keyword">extends</span> <span class="token class-name">ClientConfigEnabledRoundRobinRule</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ILoadBalancer</span> lb <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> server <span class="token operator">=</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chooseRoundRobinAfterFiltering</span><span class="token punctuation">(</span>lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>       
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过下面 <code>AbstractServerPredicate</code> 的源码片段，可以证实我们上边所做的猜测。在上边 <code>choose</code> 函数中调用的 <code>chooseRoundRobinAfterFiltering</code> 方法先通过内部定义的 <code>getEligibleServers</code> 函数来获取备选的实例清单（实现了过滤），如果返回的清单为空，则用 <code>Optional.absent()</code> 来表示不存在，反之则以线型轮询的方式从备选清单中获取一个实例。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token keyword">implements</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PredicateKey</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancerKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span><span class="token class-name">Iterables</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServerOnlyPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token operator">:</span> servers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PredicateKey</span><span class="token punctuation">(</span>loadBalancerKey<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> results<span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    

    <span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">chooseRoundRobinAfterFiltering</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> eligible <span class="token operator">=</span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">absent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> eligible<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在了解了整体逻辑之后，我们来详细看看实现过滤功能的 <code>getEligibleServers</code> 函数。从源码上看，它的实现结构简单清晰，通过遍历服务清单，使用 <code>this.apply</code> 方法来判断实例是否需要保留，如果是就添加到结果列表中。</p> 
<p>不熟悉 <code>Google Guava Collections</code> 集合工具的朋友可能会感到困惑，这个 <code>apply</code> 在 AbstractServerPredicate 中找不到它的定义，那么它是如何实现过滤的呢？实际上，AbstractServerPredicate 实现了 <code>com.google.common.base.Predicate</code> 接口，而 apply 方法是该接口中的定义，主要用来实现过滤条件的判断逻辑，它输入的参数则是过滤条件需要用到的一些信息（比如源码中的 <code>new PredicateKey(loadBalancerKey, server)</code>），它传入了关于实例的统计信息和负载均衡器的选择算法，所以这里的 <code>chooseRoundRobinAfterFiltering</code> 函数只是定义了一个模板策略：“先过滤清单，再轮询选择”。对于如何过滤，需要我们在 <code>AbstractServerPredicate</code> 的子类中实现 <code>apply</code> 方法来确定具体的过滤策略。</p> 
<p>后面我们将要介绍的两个策略就是基于此抽象策略实现，只是它们使用了不同的 <code>Predicate</code> 实现来完成过滤逻辑以达到不同的实例选择效果。</p> 
<blockquote> 
 <p><code>Google Guava Collections</code> 是一个对 <code>Java Collections Framework</code> 增强和扩展的开源项目。虽然 <code>Java Collections Framework</code> 已经能够满足我们大多数情况下使用集合的要求，但是当遇到一些特殊的情况时我们的代码会比较冗长且容易出错。<code>Guava Collections</code> 可以帮助我们让集合操作代码更为简短精炼并大大增强代码的可读性。</p> 
</blockquote> 
<h3><a id="AvailabilityFilteringRule_504"></a>AvailabilityFilteringRule</h3> 
<p>该策略继承自上边介绍的抽象策略 <code>PredicateBasedRule</code>，所以它也继承了“先过滤清单，再轮询选择”的基本处理逻辑，其中过滤条件使用了 <code>AvailabilityPredicate</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AvailabilityPredicate</span> <span class="token keyword">extends</span>  <span class="token class-name">AbstractServerPredicate</span> <span class="token punctuation">{<!-- --></span>
        
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PredicateKey</span> input<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LoadBalancerStats</span> stats <span class="token operator">=</span> <span class="token function">getLBStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">shouldSkipServer</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldSkipServer</span><span class="token punctuation">(</span><span class="token class-name">ServerStats</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">CIRCUIT_BREAKER_FILTERING</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span><span class="token function">isCircuitBreakerTripped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
                <span class="token operator">||</span> stats<span class="token punctuation">.</span><span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> activeConnectionsLimit<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>从上述源码中，我们可以知道他的主要过滤逻辑位于 <code>shouldSkipServer</code> 方法中，他主要判断服务实例的两项内容：</p> 
<ul><li>是故障，即断路器是否生效已断开。</li><li>示例的并发请求数大于阈值，默认为<code>2的32次幂 - 1</code>，该配置可通过参数 <code>&lt;clientName&gt;.&lt;nameSpace&gt;.ActiveConnectionsLimit</code> 来修改。</li></ul> 
<p>这两项内容中只要有一个满足 <code>apply</code> 就返回 <code>false</code> （代表该节点可能存在故障或负载过高），都不满足就返回 true。</p> 
<p>在该策略中，除了实现了上面的过滤方法之外，对于 <code>choose</code> 的策略也做了一些改进的优化，所以父类的实现对于它来说只是一个备用选项，其具体实现如下所示：</p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Server</span> server <span class="token operator">=</span> roundRobinRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token operator">++</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>predicate<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PredicateKey</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> server<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            server <span class="token operator">=</span> roundRobinRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，它并没有像在父类中那样，先遍历所有的节点进行过滤，然后在过滤后的集合中选择实例。而是先以线型的方式选择一个实例。接着用过滤条件来判断该实例是否满足要求，若慢慢组就直接使用该实例，若不满足要求就再选择下一个实例，并检查是否满足要求，如此循环进行，当这个过程重复了 10 次还是没有找到符合要求的实例，就采用父类的实现方案。</p> 
<p>简单地说，该策略通过线型抽象的方式直接尝试寻找可用且较空闲的实例来使用，优化了父类每次都要遍历所有示例的开销。</p> 
<h3><a id="ZoneAvoidanceRule_561"></a>ZoneAvoidanceRule</h3> 
<p>该策略我们在介绍复杂均衡器 <code>ZoneAvoidanceRule</code> 时已经提到过，它也是 <code>PredicateBasedRule</code> 的具体实现类。在之前的介绍中主要针对 <code>ZoneAvoidanceRule</code> 中用于选择 Zone 区域策略的一些静态函数，比如 <code>createSnapshot</code>、<code>getAvailableZones</code>。</p> 
<p>在这里我们将详细看看 <code>ZoneAvoidanceRule</code> 作为服务实例过滤条件的实现原理。从下面 <code>ZoneAvoidanceRule</code> 的源码判断中可以看到，它使用了 <code>CompositePredicate</code> 来进行服务实例清单的过滤。这是一个组合过滤条件，在其构造函数中，它以 <code>ZoneAvoidancePredicate</code> 为主过滤条件，<code>AvailabilityPredicate</code> 为次过滤条件初始化了组合过滤条件的实例。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZoneAvoidanceRule</span> <span class="token keyword">extends</span> <span class="token class-name">PredicateBasedRule</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token class-name">CompositePredicate</span> compositePredicate<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ZoneAvoidanceRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ZoneAvoidancePredicate</span> zonePredicate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZoneAvoidancePredicate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AvailabilityPredicate</span> availabilityPredicate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AvailabilityPredicate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compositePredicate <span class="token operator">=</span> <span class="token function">createCompositePredicate</span><span class="token punctuation">(</span>zonePredicate<span class="token punctuation">,</span> availabilityPredicate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ZoneAvoidanceRule 在实现的时候并没有像 <code>AvailabilityFilteringRule</code> 那样重写 <code>choose</code> 函数来优化，所以它完全遵循了父类的过滤主逻辑：“先过滤清淡，再轮询选择”。其中过滤清淡的条件就是我们上面提到的以 <code>ZoneAvoidancePredicate</code> 为主过滤条件、<code>AvailabilityPredicate</code> 为次过滤条件的组合过滤条件 <code>CompositePredicate</code>。从 <code>CompositePredicate</code> 的源码片段中，我们可以看到它定义了一个主过滤条件 <code>AbstractServerPredicate delegate</code> 以及一组次过滤条件列表 <code>List&lt;AbstractServerPredicate&gt; fallbacks</code> ，所以它的次过滤列表是可以拥有多个的，并且由于它采用了 <code>List</code> 存储所以次过滤条件是按顺序执行的。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompositePredicate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">AbstractServerPredicate</span> delegate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">&gt;</span></span> fallbacks <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> minimalFilteredServers <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">float</span> minimalFilteredPercentage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PredicateKey</span> input<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">/**
     * 从主过滤条件获取筛选过的服务器，如果筛选过的服务器达不到指定要求，则用次过滤条件进行筛选
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">&gt;</span></span> i <span class="token operator">=</span> fallbacks<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> minimalFilteredServers <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> minimalFilteredPercentage<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">AbstractServerPredicate</span> predicate <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> predicate<span class="token punctuation">.</span><span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在获取过滤结果的实现函数 <code>getEligibleServers</code> 中，他的处理逻辑如下所示：</p> 
<ul><li>使用主过滤条件对所有实例过滤并返回过滤后的实例清单。</li><li>依次使用次过滤条件列表中的过滤条件对所有实例进行过滤。</li><li>每次过滤之后（包括主过滤条件和次过滤条件），都需要判断下面两个条件，只要有一个要求不符合就继续使用下一个过滤条件进行过滤，将最终符合两个条件的结果返回供线性轮询算法选择： 
  <ul><li>过滤后的实例总数 &gt;= 最小过滤是隶属（<code>minimalFilteredSevers</code>，默认为 1）。</li><li>过滤后的实例比例 &gt; 最小过滤百分比（<code>minimalFilteredPercentage</code>，默认为 0）。</li></ul> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6949e3bf2ce17babe51a3045e230618c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android Studio中默认Botton的颜色(学习笔记）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5f2c477c480edc91e8b7784aac363723/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言#bug#双向链表尾部插入</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>