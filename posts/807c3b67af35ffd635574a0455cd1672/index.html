<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>面向对象状态机框架 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="面向对象状态机框架" />
<meta property="og:description" content="1.状态类（Istate)当前状态下所有要执行的动作
using System.Collections; using System.Collections.Generic; using UnityEngine; namespace FSM { /// &lt;summary&gt; /// 状态接口 /// &lt;/summary&gt; public interface Istate { /// &lt;summary&gt; /// 状态名 /// &lt;/summary&gt; string Name { get; } /// &lt;summary&gt; /// 状态标签 /// &lt;/summary&gt; string Tag { set; get; } /// &lt;summary&gt; /// 当前状态的状态机 /// &lt;/summary&gt; IstateMachine Parent { get; set; } /// &lt;summary&gt; /// 从进入状态开始计算的时长 /// &lt;/summary&gt; float Timer { get; } /// &lt;summary&gt; /// 状态过度当前状态的所有过度 /// &lt;/summary&gt; List&lt;ITransition&gt; Transition { get; } /// &lt;summary&gt; /// 进入状态时的回调 /// &lt;/summary&gt; /// &lt;param name=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/807c3b67af35ffd635574a0455cd1672/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-09-29T17:32:41+08:00" />
<meta property="article:modified_time" content="2017-09-29T17:32:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">面向对象状态机框架</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/2f/e4/gIhJ8At2_o.png" alt="这里写图片描述" title=""> <br> 1.状态类（Istate)当前状态下所有要执行的动作</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;

namespace FSM
{
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态接口</span>
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> Istate
    {
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态名</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态标签</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">string</span> Tag { <span class="hljs-keyword">set</span>; <span class="hljs-keyword">get</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当前状态的状态机</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        IstateMachine Parent { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 从进入状态开始计算的时长</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">float</span> Timer { <span class="hljs-keyword">get</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态过度当前状态的所有过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        List&lt;ITransition&gt; Transition { <span class="hljs-keyword">get</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 进入状态时的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="prev"&gt;</span>上一个状态<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">void</span> EnterCallback(Istate prev);
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 退出状态时的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="next"&gt;</span>下一个状态<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">void</span> ExitCallback(Istate next);
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> Update的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="deltaTime"&gt;</span>Time.deltaTime<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">void</span> UpdateCallback(<span class="hljs-keyword">float</span> deltaTime);
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> LateUpdate的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="deltaTime"&gt;</span>Time.deltaTime<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">void</span> LateUpdateCallback(<span class="hljs-keyword">float</span> deltaTime);
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> FixUppdate的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">void</span> FixUppdateCallback();
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 添加过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="t"&gt;</span>状态过度<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">void</span> AddTransition(ITransition t);


    }
}</code></pre> 
<p>1.1状态类实现</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;
namespace FSM
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LexDelegate</span>();
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LexDelegateState</span>(Istate State);
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LexDelegateFloat</span>(<span class="hljs-keyword">float</span> f);
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> LexState : Istate
    {
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当进入状态时调用的事件</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> LexDelegateState OnEnter;
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当离开状态时调用的事件</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> LexDelegateState OnExit;
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当Update时调用的事件</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> LexDelegateFloat OnUpdate;
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当LateUpdate时调用的事件</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> LexDelegateFloat OnLateUpdate;
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当FixUpdate时调用的事件</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> LexDelegate OnFixUpdate;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> _name;<span class="hljs-comment">//状态名</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> _tag;<span class="hljs-comment">//状态标签</span>
        <span class="hljs-keyword">private</span> IstateMachine _parent;<span class="hljs-comment">//当前状态的状态机</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> _Timer;<span class="hljs-comment">//计时器</span>
        <span class="hljs-keyword">private</span> List&lt;ITransition&gt; _transition;<span class="hljs-comment">//状态过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 构造方法</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="name"&gt;</span>状态名<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-title">LexState</span>(<span class="hljs-keyword">string</span> name)
        {
            _name = name;
            _transition = <span class="hljs-keyword">new</span> List&lt;ITransition&gt;();
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态名</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _name;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态标签</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Tag
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _tag;
            }

            <span class="hljs-keyword">set</span>
            {
                _tag = <span class="hljs-keyword">value</span>;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当前状态的状态机</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> IstateMachine Parent
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _parent;
            }

            <span class="hljs-keyword">set</span>
            {
                _parent = <span class="hljs-keyword">value</span>;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 从进入状态开始计算的时长</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">float</span> Timer
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _Timer;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态过度当前状态的所有过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> List&lt;ITransition&gt; Transition
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _transition;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 添加过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="t"&gt;</span>状态过度<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddTransition</span>(ITransition t)
        {
            <span class="hljs-keyword">if</span>(t!=<span class="hljs-keyword">null</span>&amp;&amp;!_transition.Contains(t))
            {
                _transition.Add(t);
            }
        }

        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 进入状态时的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="prev"&gt;</span>上一个状态<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">EnterCallback</span>(Istate prev)
        {
            <span class="hljs-comment">//重置计时器</span>
            _Timer = <span class="hljs-number">0</span>;
            <span class="hljs-comment">//进入状态时系统调用OnEnter事件</span>
            <span class="hljs-keyword">if</span> (OnEnter != <span class="hljs-keyword">null</span>)
            {
                OnEnter(prev);
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 退出状态时的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="next"&gt;</span>下一个状态<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ExitCallback</span>(Istate next)
        {
            <span class="hljs-comment">//离开状态时系统调用OnEnter事件</span>
            <span class="hljs-keyword">if</span> (OnExit != <span class="hljs-keyword">null</span>)
            {
                OnExit(next);
            }
            <span class="hljs-comment">//重置计时器</span>
            _Timer = <span class="hljs-number">0</span>;
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> Update的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="deltaTime"&gt;</span>Time.deltaTime<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateCallback</span>(<span class="hljs-keyword">float</span> deltaTime)
        {
            <span class="hljs-comment">//累加计时器</span>
            _Timer += deltaTime;
            <span class="hljs-comment">//Update时系统会调用OnUpdate事件</span>
            <span class="hljs-keyword">if</span> (OnUpdate!=<span class="hljs-keyword">null</span>)
            {
                OnUpdate(deltaTime);
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> LateUpdate的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="deltaTime"&gt;</span>Time.deltaTime<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
         <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LateUpdateCallback</span>(<span class="hljs-keyword">float</span> deltaTime)
        {
            <span class="hljs-comment">//LateUpdate时系统会调用OnLateUpdate事件</span>
            <span class="hljs-keyword">if</span> (OnLateUpdate!=<span class="hljs-keyword">null</span>)
            {
                OnLateUpdate(deltaTime);
            }
        }

        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> FixUppdate的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FixUppdateCallback</span>()
        {
            <span class="hljs-comment">//FixUpdate时系统会调用OnFixUpdate事件</span>
            <span class="hljs-keyword">if</span> (OnFixUpdate!=<span class="hljs-keyword">null</span>)
            {
                OnFixUpdate();
            }
        }

    }
}</code></pre> 
<p>2.状态机类（IstateMachine）当前状态机类中的所有状态</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;
namespace FSM
{
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态机接口</span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> IstateMachine
    {
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当前状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        Istate CurrentState { <span class="hljs-keyword">get</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 默认状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        Istate DefaultState { <span class="hljs-keyword">set</span>; <span class="hljs-keyword">get</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 添加状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="state"&gt;</span>要添加的状态<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">void</span> AddState(Istate state);
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 删除状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="state"&gt;</span>要删除的状态<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">void</span> RemoveState(Istate state);
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 通过指定的tag值查找状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="tag"&gt;</span>状态 Tag值<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;returns&gt;</span>查找到的状态<span class="hljs-xmlDocTag">&lt;/returns&gt;</span></span>
        Istate GetStateWithTage(<span class="hljs-keyword">string</span> tag);
    }

}</code></pre> 
<p>2.1状态机类实现</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;
namespace FSM
{
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态机类需要继承与状态类并实现状态机接口</span>
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> LexStateMachine : LexState, IstateMachine
    {
        <span class="hljs-keyword">private</span> Istate _CurrentState;<span class="hljs-comment">//当前状态</span>
        <span class="hljs-keyword">private</span> Istate _DefaultState;<span class="hljs-comment">//默认状态</span>
        <span class="hljs-keyword">private</span> List&lt;Istate&gt; _States;<span class="hljs-comment">//所有状态</span>


        <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> _isTransition = <span class="hljs-keyword">false</span>;<span class="hljs-comment">//是否正在过度</span>
        <span class="hljs-keyword">private</span> ITransition _t;<span class="hljs-comment">//当前正在执行的过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 构造方法</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="name"&gt;</span><span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-title">LexStateMachine</span>(<span class="hljs-keyword">string</span>  name,Istate defaultState):<span class="hljs-title">base</span>(name)
        {
            _States = <span class="hljs-keyword">new</span> List&lt;Istate&gt;();
            _DefaultState = defaultState;
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 当前状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> Istate CurrentState
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _CurrentState;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 默认状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> Istate DefaultState
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _DefaultState;
            }

            <span class="hljs-keyword">set</span>
            {
                AddState(<span class="hljs-keyword">value</span>);
                _DefaultState = <span class="hljs-keyword">value</span>;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 添加状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="state"&gt;</span>要添加的状态<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddState</span>(Istate state)
        {
            <span class="hljs-keyword">if</span>(state!=<span class="hljs-keyword">null</span> &amp;&amp;!_States.Contains(state))
            {
                _States.Add(state);
                <span class="hljs-comment">//将加入的新状态的的Parent设置为当前状态机</span>
                state.Parent = <span class="hljs-keyword">this</span>;
                <span class="hljs-keyword">if</span>(_DefaultState==<span class="hljs-keyword">null</span>)
                {
                    _DefaultState = state;
                }
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 删除状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="state"&gt;</span>要删除的状态<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RemoveState</span>(Istate state)
        {
            <span class="hljs-comment">//再状态机运行过程中不能够删除当前状态</span>
            <span class="hljs-keyword">if</span> (_CurrentState == state)
            {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">if</span> (state != <span class="hljs-keyword">null</span> &amp;&amp; _States.Contains(state))
            {
                _States.Remove(state);
                <span class="hljs-comment">//将已经移除的Parent设置为空</span>
                state.Parent = <span class="hljs-keyword">null</span>;
                <span class="hljs-keyword">if</span> (_DefaultState == state)
                {
                    _DefaultState = (_States.Count &gt;= <span class="hljs-number">1</span>) ? _States[<span class="hljs-number">0</span>] : <span class="hljs-keyword">null</span>;
                }
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 通过指定的tag值查找状态</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="tag"&gt;</span>状态 Tag值<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;returns&gt;</span>查找到的状态<span class="hljs-xmlDocTag">&lt;/returns&gt;</span></span>
        <span class="hljs-keyword">public</span> Istate <span class="hljs-title">GetStateWithTage</span>(<span class="hljs-keyword">string</span> tag)
        {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateCallback</span>(<span class="hljs-keyword">float</span> deltaTime)
        {
            <span class="hljs-comment">//检测当前是否再过度状态</span>
            <span class="hljs-keyword">if</span>(_isTransition)
            {
                <span class="hljs-comment">//检测当前执行的过度是否完成</span>
                <span class="hljs-keyword">if</span>(_t.TransitionCallback())
                {
                    DoTransition(_t);
                    _isTransition = <span class="hljs-keyword">false</span>;
                }
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">base</span>.UpdateCallback(deltaTime);
            <span class="hljs-keyword">if</span>(_CurrentState==<span class="hljs-keyword">null</span>)
            {
                _CurrentState = _DefaultState;
            }
            List&lt;ITransition&gt; ts = _CurrentState.Transition;
            <span class="hljs-keyword">int</span> Count = _CurrentState.Transition.Count;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; Count; i++)
            {
                ITransition t = ts[i];
                <span class="hljs-keyword">if</span>(t.ShouldBengin())
                {
                    _isTransition = <span class="hljs-keyword">true</span>;
                    _t = t;
                    <span class="hljs-keyword">return</span>;
                }
            }
            _CurrentState.UpdateCallback(deltaTime);
        }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LateUpdateCallback</span>(<span class="hljs-keyword">float</span> deltaTime)
        {
            <span class="hljs-keyword">base</span>.LateUpdateCallback(deltaTime);
            _CurrentState.LateUpdateCallback(deltaTime);
        }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FixUppdateCallback</span>()
        {
            <span class="hljs-keyword">base</span>.FixUppdateCallback();
            _CurrentState.FixUppdateCallback();
        }
        <span class="hljs-comment">//开始执行过度</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoTransition</span>(ITransition t)
        {
            _CurrentState.ExitCallback(t.To);
            _CurrentState = t.To;
            _CurrentState.EnterCallback(t.From);
        }
    }
}</code></pre> 
<p>3.状态的转换过度类接口（ITransition）</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;

namespace FSM
{
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 状态过度的接口</span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> ITransition
    {
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 过度名</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">string</span> name { <span class="hljs-keyword">get</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 从哪个状态开始过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        Istate From { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 要过度到哪个状态去</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        Istate To { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 过度时的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;returns&gt;</span>返回true过度结束返回false继续进行过度<span class="hljs-xmlDocTag">&lt;/returns&gt;</span></span>
        <span class="hljs-keyword">bool</span> TransitionCallback();
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 能否开始过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;returns&gt;</span>如果是True就开始进行过度如果是False就不进行过度<span class="hljs-xmlDocTag">&lt;/returns&gt;</span></span>
        <span class="hljs-keyword">bool</span> ShouldBengin();

    }
}</code></pre> 
<p>3.1状态过渡</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;
namespace FSM
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">LexTransitionDelegate</span>();
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> LexTransition : ITransition
    {
        <span class="hljs-keyword">private</span> Istate _From;<span class="hljs-comment">//原状态</span>
        <span class="hljs-keyword">private</span> Istate _To;<span class="hljs-comment">//目标状态</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> _name;<span class="hljs-comment">//过度名</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> LexTransitionDelegate OnTransition;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> LexTransitionDelegate OnCheck;<span class="hljs-comment">//检测条件是否满足</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 构造方法</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="Name"&gt;</span><span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="fromstate"&gt;</span><span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="tostate"&gt;</span><span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-title">LexTransition</span>(<span class="hljs-keyword">string</span> Name, Istate fromstate, Istate tostate)
        {
            _name = Name;
            _From = fromstate;
            _To = tostate;

        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 过度名</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> name
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _name;
            }
        }

        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 从哪个状态开始过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> Istate From
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _From;
            }

            <span class="hljs-keyword">set</span>
            {
                _From = <span class="hljs-keyword">value</span>;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 要过度到哪个状态去</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">public</span> Istate To
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> _To;
            }
            <span class="hljs-keyword">set</span>
            {
                _To = <span class="hljs-keyword">value</span>;
            }
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 过度时的回调</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;returns&gt;</span>返回true过度结束返回false继续进行过度<span class="hljs-xmlDocTag">&lt;/returns&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">TransitionCallback</span>()
        {
            <span class="hljs-keyword">if</span> (OnTransition != <span class="hljs-keyword">null</span>)
            {
                <span class="hljs-keyword">return</span> OnTransition();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        }
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 能否开始过度</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;returns&gt;</span>如果是True就开始进行过度如果是False就不进行过度<span class="hljs-xmlDocTag">&lt;/returns&gt;</span></span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">ShouldBengin</span>()
        {
            <span class="hljs-keyword">if</span> (OnCheck != <span class="hljs-keyword">null</span>)
            {
                <span class="hljs-keyword">return</span> OnCheck();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        }
    }

}</code></pre> 
<p>4.调用</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> FSM;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Test : MonoBehaviour {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">float</span> speed; <span class="hljs-comment">//Cube每秒钟移动的距离</span>
    <span class="hljs-keyword">private</span> LexStateMachine _fsm;<span class="hljs-comment">//状态机</span>
    <span class="hljs-keyword">private</span> LexState Idle;<span class="hljs-comment">//闲置状态</span>
    <span class="hljs-keyword">private</span> LexState move;<span class="hljs-comment">//移动状态</span>
    <span class="hljs-keyword">private</span> LexTransition _IdleToMove;<span class="hljs-comment">//Idle到Move的状态过度</span>
    <span class="hljs-keyword">private</span> LexTransition _MoveToIdle;<span class="hljs-comment">//Move到Idle的状态过度</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> IsMove=<span class="hljs-keyword">false</span>;<span class="hljs-comment">//能否开始移动</span>
    <span class="hljs-comment">// Use this for initialization</span>
    <span class="hljs-keyword">void</span> Start () {
        <span class="hljs-comment">//初始化状态</span>
        Idle = <span class="hljs-keyword">new</span> LexState(<span class="hljs-string">"Idle"</span>);<span class="hljs-comment">//创建状态</span>
        Idle.OnEnter += (Istate state) =&gt;
          {
              Debug.Log(<span class="hljs-string">"进入Idle状态"</span>);
        };

        move = <span class="hljs-keyword">new</span> LexState(<span class="hljs-string">"Move"</span>);
        <span class="hljs-comment">//移动状态的时候的逻辑</span>
        move.OnUpdate += (<span class="hljs-keyword">float</span> f) =&gt;
          {
              transform.position += transform.forward * f * speed;
          };

        _IdleToMove = <span class="hljs-keyword">new</span> LexTransition(<span class="hljs-string">"idlemove"</span>, Idle, move);<span class="hljs-comment">//创建过渡状态</span>
        _IdleToMove.OnCheck += () =&gt;
          {
              <span class="hljs-keyword">return</span> IsMove;
          };
        Idle.AddTransition(_IdleToMove);<span class="hljs-comment">//加入过渡状态链表</span>
        <span class="hljs-comment">//_IdleToMove.OnTransition += () =&gt;</span>
        <span class="hljs-comment">//  {<!-- --></span>

        <span class="hljs-comment">//  };</span>
        _MoveToIdle = <span class="hljs-keyword">new</span> LexTransition(<span class="hljs-string">"moveIdle"</span>, move, Idle);
        _MoveToIdle.OnCheck += () =&gt;
        {
            <span class="hljs-keyword">return</span> !IsMove;
        };
        move.AddTransition(_MoveToIdle);
        _fsm = <span class="hljs-keyword">new</span> LexStateMachine(<span class="hljs-string">"Root"</span>, Idle);<span class="hljs-comment">//创建状态机并加入状态</span>
        _fsm.AddState(move);

    }

    <span class="hljs-comment">// Update is called once per frame</span>
    <span class="hljs-keyword">void</span> Update () {
        _fsm.UpdateCallback(Time.deltaTime);

    }
    <span class="hljs-keyword">void</span> OnGUI()
    {
        <span class="hljs-keyword">if</span>(GUILayout.Button(<span class="hljs-string">"move"</span>))
        {
            IsMove = <span class="hljs-keyword">true</span>;
        }
        <span class="hljs-keyword">if</span>(GUILayout.Button(<span class="hljs-string">"Stop"</span>))
        {
            IsMove = <span class="hljs-keyword">false</span>;
        }
    }
}</code></pre> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> FSM;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> LightControl : MonoBehaviour {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">float</span> maxIntensity;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">float</span> FadeSpeed;


    <span class="hljs-keyword">private</span> LexStateMachine _fsm;
    <span class="hljs-keyword">private</span> LexStateMachine _open;<span class="hljs-comment">//open状态下的子状态声明</span>
    <span class="hljs-keyword">private</span> LexState _close;
    <span class="hljs-keyword">private</span> LexTransition opentoclose;
    <span class="hljs-keyword">private</span> LexTransition closetoopen;
    <span class="hljs-keyword">private</span> LexState _changeIntensity;
    <span class="hljs-keyword">private</span> LexState _changeColor;
    <span class="hljs-keyword">private</span> LexTransition colortointensity;
    <span class="hljs-keyword">private</span> LexTransition intensitytocolor;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> isOpen=<span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> isAnimation;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> isResst;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> target;
    <span class="hljs-keyword">private</span> Color targetColor;
    <span class="hljs-keyword">private</span> Color StartColor;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> ColorTimer;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> ischangecolor;


    <span class="hljs-keyword">private</span> Light _light;
    <span class="hljs-comment">// Use this for initialization</span>
    <span class="hljs-keyword">void</span> Start () {
        InitFSM();
        _light = GetComponent&lt;Light&gt;();


    }

    <span class="hljs-comment">// Update is called once per frame</span>
    <span class="hljs-keyword">void</span> Update () {
        _fsm.UpdateCallback(Time.deltaTime);

    }
    <span class="hljs-comment">//初始化状态机</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitFSM</span>()
    {
        _changeIntensity = <span class="hljs-keyword">new</span> LexState(<span class="hljs-string">"changeIntensity"</span>);
        _changeIntensity.OnEnter += (Istate State) =&gt;
          {
              isAnimation = <span class="hljs-keyword">true</span>;
              isResst = <span class="hljs-keyword">true</span>;
          };
        _changeIntensity.OnUpdate += (<span class="hljs-keyword">float</span> f) =&gt;
        {
            <span class="hljs-keyword">if</span> (isAnimation)
            {
                <span class="hljs-keyword">if</span> (isResst)
                {
                    <span class="hljs-keyword">if</span> (Fadeto(maxIntensity))
                    {
                        isResst = <span class="hljs-keyword">false</span>;
                        isAnimation = <span class="hljs-keyword">false</span>;
                    }
                }
                <span class="hljs-keyword">else</span>
                {
                    <span class="hljs-keyword">if</span> (Fadeto(target))
                    {
                        isResst = <span class="hljs-keyword">true</span>;
                    }
                }
            }
            <span class="hljs-keyword">else</span>
            {
                target = Random.Range(<span class="hljs-number">0.3</span>f, <span class="hljs-number">0.7</span>f);
                isAnimation = <span class="hljs-keyword">true</span>;
            }
        };
        _changeColor = <span class="hljs-keyword">new</span> LexState(<span class="hljs-string">"changeColor"</span>);
        _changeColor.OnEnter += (Istate State) =&gt;
          {
              isAnimation = <span class="hljs-keyword">false</span>;
          };
        _changeColor.OnUpdate += (<span class="hljs-keyword">float</span> f) =&gt;
          {
              <span class="hljs-keyword">if</span>(isAnimation)
              {
                  <span class="hljs-keyword">if</span>(ColorTimer&gt;=<span class="hljs-number">1</span>f)
                  {
                      isAnimation = <span class="hljs-keyword">false</span>;
                  }
                  <span class="hljs-keyword">else</span>
                  {
                      ColorTimer += Time.deltaTime ;
                      _light.color = Color.Lerp(StartColor, targetColor, ColorTimer);
                  }
              }
              <span class="hljs-keyword">else</span>
              {
                  <span class="hljs-keyword">float</span> r = Random.Range(<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>f);
                  <span class="hljs-keyword">float</span> g = Random.Range(<span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>f);
                  <span class="hljs-keyword">float</span> b = Random.Range(<span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>f);
                  targetColor = <span class="hljs-keyword">new</span> Color(r, g, b);
                  StartColor = _light.color;
                  ColorTimer = <span class="hljs-number">0</span>f;
                  isAnimation = <span class="hljs-keyword">true</span>;
              }
          };
        colortointensity = <span class="hljs-keyword">new</span> LexTransition(<span class="hljs-string">"colortointensity"</span>,_changeColor,_changeIntensity);
        colortointensity.OnCheck += () =&gt;
        {
            <span class="hljs-keyword">return</span> !ischangecolor;
        };
        _changeColor.AddTransition(colortointensity);

        intensitytocolor = <span class="hljs-keyword">new</span> LexTransition(<span class="hljs-string">"intensitytocolor"</span>, _changeIntensity, _changeColor);
        intensitytocolor.OnCheck += () =&gt;
        {
            <span class="hljs-keyword">return</span> ischangecolor;
        };
        _changeIntensity.AddTransition(intensitytocolor);
        _open = <span class="hljs-keyword">new</span> LexStateMachine(<span class="hljs-string">"open"</span>, _changeIntensity);<span class="hljs-comment">//子状态的加入</span>
        _open.AddState(_changeColor);     
        _close = <span class="hljs-keyword">new</span> LexState(<span class="hljs-string">"close"</span>);
        _close.OnEnter += (Istate State) =&gt;
        {
            _light.intensity = <span class="hljs-number">0</span>;
        };
        opentoclose = <span class="hljs-keyword">new</span> LexTransition(<span class="hljs-string">"OpenClose"</span>, _open, _close);
        opentoclose.OnCheck += () =&gt;
        {
            <span class="hljs-keyword">return</span> !isOpen;
        };
        <span class="hljs-comment">//opentoclose.OnTransition += () =&gt;</span>
        <span class="hljs-comment">//{<!-- --></span>
        <span class="hljs-comment">//    return Fadeto(0);</span>
        <span class="hljs-comment">//};</span>
        _open.AddTransition(opentoclose);
        closetoopen = <span class="hljs-keyword">new</span> LexTransition(<span class="hljs-string">"CloseOpen"</span>, _close, _open);
        closetoopen.OnCheck += () =&gt;
        {
            <span class="hljs-keyword">return</span> isOpen;
        };
        closetoopen.OnTransition += () =&gt;
        {
            <span class="hljs-keyword">return</span> Fadeto(maxIntensity);
        };
        _close.AddTransition(closetoopen);
        _fsm = <span class="hljs-keyword">new</span> LexStateMachine(<span class="hljs-string">"Cube"</span>, _open);
        _fsm.AddState(_close);
    }
    <span class="hljs-keyword">void</span> OnGUI()
    {
        <span class="hljs-keyword">if</span> (GUI.Button(<span class="hljs-keyword">new</span> Rect(<span class="hljs-number">150</span>f,<span class="hljs-number">30</span>f,<span class="hljs-number">55</span>f,<span class="hljs-number">28</span>f),<span class="hljs-string">"open"</span>))
        {
            isOpen = <span class="hljs-keyword">true</span>;
        }
        <span class="hljs-keyword">if</span> (GUI.Button(<span class="hljs-keyword">new</span> Rect(<span class="hljs-number">150</span>f, <span class="hljs-number">65</span>f, <span class="hljs-number">55</span>f, <span class="hljs-number">28</span>f), <span class="hljs-string">"Close"</span>))
        {
            isOpen = <span class="hljs-keyword">false</span>;
        }
    }
    <span class="hljs-comment">//将灯光光强渐变到指定的值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">Fadeto</span>(<span class="hljs-keyword">float</span> f)
    {

        <span class="hljs-keyword">if</span>(Mathf.Abs(_light.intensity-f)&lt;=<span class="hljs-number">0.05</span>f)
        {
            _light.intensity = f;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-keyword">int</span> flag = _light.intensity &gt; f ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
            _light.intensity += Time.deltaTime * FadeSpeed*flag;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        }
    }
}</code></pre> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> FSM;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> CubeMoveState : LexState
{
    <span class="hljs-keyword">public</span> <span class="hljs-title">CubeMoveState</span>() : <span class="hljs-title">base</span>("CubeMoveState")
    {
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">EnterCallback</span>(Istate prev)
    {
        <span class="hljs-comment">//进入移动状态打印上一个状态的名字</span>
        Debug.Log(prev.Name);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateCallback</span>(<span class="hljs-keyword">float</span> deltaTime)
    {
       <span class="hljs-comment">//每当处于move状态每帧使用这个方法</span>
    }
}</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4fc6b6477ee091b8d9ab2530e803f7ee/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MMORPG战斗系统随笔（二）、浅谈场寻路Flow Field PathFinding算法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e8262cc7ebac3002d1f000d894b2a59c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">wireshark 找不到wifi网卡</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>