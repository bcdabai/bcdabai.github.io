<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【大数据之Hive】十六、Hive-HQL函数之窗口函数（开窗函数） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【大数据之Hive】十六、Hive-HQL函数之窗口函数（开窗函数）" />
<meta property="og:description" content="1 概述 先定义了窗口的大小（按行来算），然后对窗口内的行的数据进行计算，再将计算结果返回给改行。
窗口函数包括窗口和函数两部分，窗口用于定义计算范围，函数用于定义计算逻辑，窗口函数只会在原来的表上增加一列结果列，不改变原来的数据。
1.1 窗口函数使用语法 --窗口函数使用语法 select ..., 函数(col_name) over (窗口范围) result_col_name -表示在窗口范围之上应用函数逻辑 from table_name; 函数：
绝大多数聚合函数都可以配合窗口使用，如max()，min()，sum()，count()，avg()等。
窗口：
分为两种，一种是基于行的，一种是基于值的。
基于行的：如每行数据的窗口为上一行到当前行：对于第1行来说，处于窗口内的行为第0行和第1行；对于第2行来说，处于窗口内的行为第1、2行。
基于值的：如要求每行数据的窗口值位于当前值-1到当前值：对于值为1的数据来说，窗口范围的值为[1-1,1]即[0,1]，此时只有1行数据；对于值为2的数据来说，窗口范围的值为[2-1,2]即[1,2]，有第1、2、3行数据。
1.2 窗口语法（基于行row） 基于真正运算时的行，并不是基于看到的表数据，所以需要声明一个排序字段 order by ，在真正进行窗口计算时使用哪个窗口进行排序。
--基于行 函数(col_name) over (窗口范围) result_col_name --窗口范围(写在over后面的括号里)： order by [col_name] rows between ***1 and ***2 ***1(窗口的起点)：unbounded preceding / [num] preceding / current row / [num] following ***2(窗口的终点): 对于 unbounded preceding / [num] preceding 来说，终点可以写为 [num] preceding / current row / [num] following / unbounded following 对于 current row 来说，终点可以写为 current row / [num] following / unbounded following 对于 [num] following 来说，终点可以写为 [num] following / unbounded following （1）窗口起点（可以不包含当前行）：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/bcab99df23e507ecd3c558831e5eb47f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-26T17:57:38+08:00" />
<meta property="article:modified_time" content="2023-06-26T17:57:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【大数据之Hive】十六、Hive-HQL函数之窗口函数（开窗函数）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1 概述</h2> 
<p>  先定义了窗口的大小（按行来算），然后对窗口内的行的数据进行计算，再将计算结果返回给改行。<br> <img src="https://images2.imgbox.com/e9/cd/qUIrcz4t_o.png" alt="在这里插入图片描述"><br>   窗口函数包括窗口和函数两部分，窗口用于定义计算范围，函数用于定义计算逻辑，窗口函数只会在原来的表上增加一列结果列，不改变原来的数据。</p> 
<h3><a id="11__6"></a>1.1 窗口函数使用语法</h3> 
<pre><code class="prism language-java"><span class="token operator">--</span>窗口函数使用语法
select
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
    函数<span class="token punctuation">(</span>col_name<span class="token punctuation">)</span> over <span class="token punctuation">(</span>窗口范围<span class="token punctuation">)</span> result_col_name   <span class="token operator">-</span>表示在窗口范围之上应用函数逻辑
from table_name<span class="token punctuation">;</span>
</code></pre> 
<p>函数：<br>   绝大多数聚合函数都可以配合窗口使用，如max()，min()，sum()，count()，avg()等。</p> 
<p>窗口：<br>   分为两种，一种是基于行的，一种是基于值的。<br>   基于行的：如每行数据的窗口为上一行到当前行：对于第1行来说，处于窗口内的行为第0行和第1行；对于第2行来说，处于窗口内的行为第1、2行。<br>   基于值的：如要求每行数据的窗口值位于当前值-1到当前值：对于值为1的数据来说，窗口范围的值为[1-1,1]即[0,1]，此时只有1行数据；对于值为2的数据来说，窗口范围的值为[2-1,2]即[1,2]，有第1、2、3行数据。<br> <img src="https://images2.imgbox.com/69/fe/0DweaIPH_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12_row_24"></a>1.2 窗口语法（基于行row）</h3> 
<p>  基于真正运算时的行，并不是基于看到的表数据，所以需要声明一个排序字段 order by ，在真正进行窗口计算时使用哪个窗口进行排序。</p> 
<pre><code class="prism language-java"><span class="token operator">--</span>基于行
函数<span class="token punctuation">(</span>col_name<span class="token punctuation">)</span> over <span class="token punctuation">(</span>窗口范围<span class="token punctuation">)</span> result_col_name

<span class="token operator">--</span>窗口范围<span class="token punctuation">(</span>写在over后面的括号里<span class="token punctuation">)</span>：
order by <span class="token punctuation">[</span>col_name<span class="token punctuation">]</span> rows between <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">1</span> and <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">2</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token function">1</span><span class="token punctuation">(</span>窗口的起点<span class="token punctuation">)</span>：unbounded preceding <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding <span class="token operator">/</span> current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token function">2</span><span class="token punctuation">(</span>窗口的终点<span class="token punctuation">)</span><span class="token operator">:</span>
    对于 unbounded preceding <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding 来说，终点可以写为 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding <span class="token operator">/</span> current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
    对于 current row 来说，终点可以写为 current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
    对于 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following 来说，终点可以写为 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
</code></pre> 
<p><strong>（1）窗口起点（可以不包含当前行）：</strong><br> （1）unbounded preceding：无边界的，可以理解为负无穷，表示表起点的第一行。<br> （2）[num] preceding：num为数字，表示当前行的前 num 行作为起点。<br> （3）current row：起点为当前行。<br> （4）[num] following：表示当前行的后 num 行作为起点。</p> 
<p><strong>（2）窗口终点（取决于起点方式）：</strong><br> （1）[num] preceding：当前行的前 num 行作为终点；当起点和终点都用 [num] preceding 时，起点的num值要比终点的大，保证终点在起点后面。<br> （2）current row：当前行作为终点。<br> （3）[num] following：当前行的后 num 行作为终点；当起点和终点都用 [num] following 时，起点的num值要小于终点的num值，保证终点在起点后面。<br> （4）unbounded following：相当于正无穷，表示表里的最后一行作为终点。</p> 
<p>例如：<br> <img src="https://images2.imgbox.com/0d/ce/z4GCRMM8_o.png" alt="在这里插入图片描述"><br> 上述例子可以理解为统计从历史到当前的每一个订单的销售额。</p> 
<h3><a id="13_range_58"></a>1.3 窗口语法（基于值range）</h3> 
<p>  基于值的 order by 表示指定哪个字段的值进行划分窗口，当使用 [num] preceding 和 [num] following 时使用的字段必须是整数类型(否则窗口划分失效) 。</p> 
<pre><code class="prism language-java"><span class="token operator">--</span>基于值
函数<span class="token punctuation">(</span>col_name<span class="token punctuation">)</span> over <span class="token punctuation">(</span>窗口范围<span class="token punctuation">)</span> result_col_name

<span class="token operator">--</span>窗口范围<span class="token punctuation">(</span>写在over后面的括号里<span class="token punctuation">)</span>：
order by <span class="token punctuation">[</span>col_name<span class="token punctuation">]</span> range between <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">1</span> and <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">2</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token function">1</span><span class="token punctuation">(</span>窗口的起点<span class="token punctuation">)</span>：unbounded preceding <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding <span class="token operator">/</span> current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token function">2</span><span class="token punctuation">(</span>窗口的终点<span class="token punctuation">)</span><span class="token operator">:</span>
    对于 unbounded preceding <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding 来说，终点可以写为 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding <span class="token operator">/</span> current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
    对于 current row 来说，终点可以写为 current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
    对于 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following 来说，终点可以写为 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
</code></pre> 
<p><strong>（1）窗口起点（可以不包含当前行）：</strong><br> （1）unbounded preceding：无边界的，可以理解为负无穷。<br> （2）[num] preceding：num为数字，表示当前值 减num 的值作为起点。<br> （3）current row：起点为当前值。<br> （4）[num] following：表示当前值 加num 的值作为起点。</p> 
<p><strong>（2）窗口终点（取决于起点方式）：</strong><br> （1）[num] preceding：当前值 减num 的值作为终点；当起点和终点都用 [num] preceding 时，起点的num值要比终点的大，保证终点在起点后面。<br> （2）current row：当前值作为终点。<br> （3）[num] following：当前值 加num 的值作为终点；当起点和终点都用 [num] following 时，起点的num值要小于终点的num值，保证终点在起点后面。<br> （4）unbounded following：相当于正无穷。</p> 
<p>例如：<br> <img src="https://images2.imgbox.com/0f/44/GmszbYa9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="14__90"></a>1.4 窗口语法（分区）</h3> 
<p>  在定义窗口范围时，指定分区字段，可以对每个分区进行单独划分窗口。使用 partition by 进行分区。</p> 
<pre><code class="prism language-java"><span class="token operator">--</span>分区，在分区之后再使用基于行或基于值的窗口范围定义
函数<span class="token punctuation">(</span>col_name<span class="token punctuation">)</span> over <span class="token punctuation">(</span>窗口范围<span class="token punctuation">)</span> result_col_name

<span class="token operator">--</span>窗口范围<span class="token punctuation">(</span>写在over后面的括号里<span class="token punctuation">)</span>：
partition by col_name order by <span class="token punctuation">[</span>col_name<span class="token punctuation">]</span> range<span class="token operator">/</span>rows between <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">1</span> and <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">2</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token function">1</span><span class="token punctuation">(</span>窗口的起点<span class="token punctuation">)</span>：unbounded preceding <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding <span class="token operator">/</span> current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token function">2</span><span class="token punctuation">(</span>窗口的终点<span class="token punctuation">)</span><span class="token operator">:</span>
    对于 unbounded preceding <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding 来说，终点可以写为 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> preceding <span class="token operator">/</span> current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
    对于 current row 来说，终点可以写为 current row <span class="token operator">/</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
    对于 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following 来说，终点可以写为 <span class="token punctuation">[</span>num<span class="token punctuation">]</span> following <span class="token operator">/</span> unbounded following
</code></pre> 
<p>例如：<br> <img src="https://images2.imgbox.com/c6/1b/1oVSD11T_o.png" alt="在这里插入图片描述"><br> 上述例子可以理解为每个用户截至到每次下单时间的历史下单总额。</p> 
<h3><a id="15__111"></a>1.5 窗口语法（缺省）</h3> 
<p>  over() 中的三部分内容 partition by、order by、rows/range between … and … 都可以省略不写。</p> 
<p>（1）partition by 省略表示不分区。</p> 
<p>（2）order by 省略表示不排序；基本上使用 rows 和 range 都需要写 order by ；使用 rows 时不写 order by 即表示不声明排序，使用随机的顺序；使用 range 时不写 order by 则表示窗口划分为负无穷到正无穷。</p> 
<p>（3）rows/range between … and … 省略则使用默认值：<br>   （i）如果 over() 中包含 order by 则默认：range between unbounded preceding and current row （即第一行到当前行）。<br>   （ii）如果 over() 中不包含 order by 则默认：rows between unbounded preceding and unbounded following （即第一行到最后一行）。</p> 
<h2><a id="2__123"></a>2 常用窗口函数</h2> 
<p>  分为聚合函数、跨行取值函数、排名函数。</p> 
<h3><a id="21__127"></a>2.1 聚合函数</h3> 
<p>max()、min()、sum()、avg()、count()。</p> 
<h3><a id="22__131"></a>2.2 跨行取值函数</h3> 
<p><strong>（1）lead和lag</strong><br>   功能：获取当前行的**上面(lag)<strong>或</strong>下面(lead)**的某行、某个字段的值。<br>   <strong>lead和lag函数不支持自定义窗口，即不能用rows或range。</strong></p> 
<p>语法：</p> 
<pre><code class="prism language-java">select
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
    <span class="token function">lag</span><span class="token punctuation">(</span>col_name<span class="token punctuation">,</span>偏移量<span class="token punctuation">(</span>数字，指上面哪行<span class="token punctuation">)</span><span class="token punctuation">,</span>默认值<span class="token punctuation">(</span>用于取不到时<span class="token punctuation">)</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by col_name order by col_name<span class="token punctuation">)</span> result_last_col_name<span class="token punctuation">,</span>
    <span class="token function">lead</span><span class="token punctuation">(</span>col_name<span class="token punctuation">,</span>偏移量<span class="token punctuation">(</span>数字，指下面哪行<span class="token punctuation">)</span><span class="token punctuation">,</span>默认值<span class="token punctuation">(</span>用于取不到时<span class="token punctuation">)</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by col_name order by col_name<span class="token punctuation">)</span> result_next_col_name
from table_name<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2e/b4/j9VEtobj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2first_valuelast_value_148"></a>（2）first_value和last_value</h3> 
<p>  功能：获取窗口内某一列的第一个或最后一个值。允许自定义窗口。</p> 
<p>语法：</p> 
<pre><code class="prism language-java">select
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
    <span class="token function">first_value</span><span class="token punctuation">(</span>col_name<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token operator">/</span><span class="token boolean">false</span><span class="token punctuation">(</span>是否要跳过<span class="token keyword">null</span>值<span class="token punctuation">)</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by col_name order by col_name<span class="token punctuation">)</span> result_first_col_name<span class="token punctuation">,</span>
    <span class="token function">last_value</span><span class="token punctuation">(</span>col_name<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token operator">/</span><span class="token boolean">false</span><span class="token punctuation">(</span>是否要跳过<span class="token keyword">null</span>值<span class="token punctuation">)</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by col_name order by col_name<span class="token punctuation">)</span> result_last_col_name
from table_name<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4a/9f/96jb43SL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23__163"></a>2.3 排名函数</h3> 
<p>常用排名函数（<strong>排名函数不支持自定义窗口</strong>）：<br> （1）rank()：考虑并列，稀疏排名，如1 1 3<br> （2）dense_rank()：考虑并列，密集排名，如1 1 2<br> （3）row_number()：不考虑比列，如1 2 3</p> 
<p>语法：</p> 
<pre><code class="prism language-java">select 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
    <span class="token function">rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by col_name order by col_name asc<span class="token operator">/</span>desc<span class="token punctuation">)</span> result_rk_col_name<span class="token punctuation">,</span>
    <span class="token function">dense_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by col_name order by col_name asc<span class="token operator">/</span>desc<span class="token punctuation">)</span> result_dense_rk_col_name<span class="token punctuation">,</span>
    <span class="token function">row_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by col_name order by col_name asc<span class="token operator">/</span>desc<span class="token punctuation">)</span> result_rn_col_name
from table_name<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9b/aa/fffwdwdX_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3__182"></a>3 案例</h2> 
<p><strong>数据准备：</strong><br> 表结构：<br> <img src="https://images2.imgbox.com/f7/61/GhKVj4XH_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token operator">--</span>建表
create table order_info
<span class="token punctuation">(</span>
   order_id string<span class="token punctuation">,</span>    <span class="token operator">--</span>订单id
   user_id string<span class="token punctuation">,</span>    <span class="token operator">--</span> 用户id
   user_name string<span class="token punctuation">,</span>    <span class="token operator">--</span> 用户姓名
   order_date string<span class="token punctuation">,</span>    <span class="token operator">--</span> 下单日期
   order_amount <span class="token keyword">int</span>    <span class="token operator">--</span> 订单金额
<span class="token punctuation">)</span>
row format delimited fields terminated by <span class="token char">'\t'</span><span class="token punctuation">;</span>

<span class="token operator">--</span>插入数据
insert overwrite table order_info
values <span class="token punctuation">(</span><span class="token char">'1'</span><span class="token punctuation">,</span> <span class="token char">'1001'</span><span class="token punctuation">,</span> <span class="token char">'小元'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>'<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'2'</span><span class="token punctuation">,</span> <span class="token char">'1002'</span><span class="token punctuation">,</span> <span class="token char">'小海'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span>'<span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'3'</span><span class="token punctuation">,</span> <span class="token char">'1001'</span><span class="token punctuation">,</span> <span class="token char">'小元'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span>'<span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'4'</span><span class="token punctuation">,</span> <span class="token char">'1002'</span><span class="token punctuation">,</span> <span class="token char">'小海'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">04</span>'<span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'5'</span><span class="token punctuation">,</span> <span class="token char">'1001'</span><span class="token punctuation">,</span> <span class="token char">'小元'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">05</span>'<span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'6'</span><span class="token punctuation">,</span> <span class="token char">'1001'</span><span class="token punctuation">,</span> <span class="token char">'小元'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span>'<span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'7'</span><span class="token punctuation">,</span> <span class="token char">'1002'</span><span class="token punctuation">,</span> <span class="token char">'小海'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span>'<span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'8'</span><span class="token punctuation">,</span> <span class="token char">'1001'</span><span class="token punctuation">,</span> <span class="token char">'小元'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">08</span>'<span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'9'</span><span class="token punctuation">,</span> <span class="token char">'1003'</span><span class="token punctuation">,</span> <span class="token char">'小辉'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span>'<span class="token punctuation">,</span><span class="token number">62</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'10'</span><span class="token punctuation">,</span> <span class="token char">'1003'</span><span class="token punctuation">,</span> <span class="token char">'小辉'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span>'<span class="token punctuation">,</span><span class="token number">62</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'11'</span><span class="token punctuation">,</span> <span class="token char">'1004'</span><span class="token punctuation">,</span> <span class="token char">'小猛'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">10</span>'<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'12'</span><span class="token punctuation">,</span> <span class="token char">'1003'</span><span class="token punctuation">,</span> <span class="token char">'小辉'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">11</span>'<span class="token punctuation">,</span><span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'13'</span><span class="token punctuation">,</span> <span class="token char">'1004'</span><span class="token punctuation">,</span> <span class="token char">'小猛'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">12</span>'<span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token char">'14'</span><span class="token punctuation">,</span> <span class="token char">'1003'</span><span class="token punctuation">,</span> <span class="token char">'小辉'</span><span class="token punctuation">,</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">13</span>'<span class="token punctuation">,</span><span class="token number">94</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>需求及实现：</strong></p> 
<pre><code class="prism language-java"><span class="token operator">--</span>统计每个用户截至每次下单的累积下单总额：order_id user_id user_name order_date order_amount sum_so_far
select
    order_id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    user_name<span class="token punctuation">,</span>
    order_date<span class="token punctuation">,</span>
    order_amount<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by user_id 
                            order by order_date rows between unbounded preceding and current row<span class="token punctuation">)</span> sum_so_far
from order_info<span class="token punctuation">;</span>

<span class="token operator">--</span>统计每个用户截至每次下单的当月累积下单总额：order_id user_id user_name order_date order_amount sum_so_far
select
    order_id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    user_name<span class="token punctuation">,</span>
    order_date<span class="token punctuation">,</span>
    order_amount<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by user_id<span class="token punctuation">,</span><span class="token function">substring</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> 
                            order by order_date rows between unbounded preceding and current row<span class="token punctuation">)</span> sum_so_far
from order_info<span class="token punctuation">;</span>


<span class="token operator">--</span>统计每个用户每次下单距离上次下单相隔的天数（首次下单按<span class="token number">0</span>天算）：order_id user_id user_name order_date order_amount diff
select
    order_id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    user_name<span class="token punctuation">,</span>
    order_date<span class="token punctuation">,</span>
    order_amount<span class="token punctuation">,</span>
    <span class="token function">datediff</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token function">lag</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>order_date<span class="token punctuation">)</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by user_id order by order_date<span class="token punctuation">)</span> diff
from order_info<span class="token punctuation">;</span>

select
   order_id<span class="token punctuation">,</span>
   user_id<span class="token punctuation">,</span>
   user_name<span class="token punctuation">,</span>
   order_date<span class="token punctuation">,</span>
   order_amount<span class="token punctuation">,</span>
   <span class="token function">datediff</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span>last_order_date<span class="token punctuation">)</span> diff
from
<span class="token punctuation">(</span>
   select
       order_id<span class="token punctuation">,</span>
       user_id<span class="token punctuation">,</span>
       user_name<span class="token punctuation">,</span>
       order_date<span class="token punctuation">,</span>
       order_amount<span class="token punctuation">,</span>
       <span class="token function">lag</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>order_date<span class="token punctuation">)</span> <span class="token function">over</span><span class="token punctuation">(</span>partition by user_id order by order_date<span class="token punctuation">)</span>last_order_date
   from order_info
<span class="token punctuation">)</span>t1<span class="token punctuation">;</span>

<span class="token operator">--</span>查询所有下单记录以及每个用户的每个下单记录所在月份的首<span class="token operator">/</span>末次下单日期：order_id user_id user_name order_date order_amount first_date last_date
select
    order_id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    user_name<span class="token punctuation">,</span>
    order_date<span class="token punctuation">,</span>
    order_amount<span class="token punctuation">,</span>
    <span class="token function">first_value</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by user_id<span class="token punctuation">,</span><span class="token function">substring</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> order by order_date<span class="token punctuation">)</span> first_date<span class="token punctuation">,</span>
    <span class="token function">last_value</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by user_id<span class="token punctuation">,</span><span class="token function">substring</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> order by order_date
                                       rows between unbounded preceding and unbounded following<span class="token punctuation">)</span> last_date
from order_info<span class="token punctuation">;</span>

<span class="token operator">--</span>为每个用户的所有下单记录按照订单金额进行排名：order_id user_id user_name order_date order_amount rk drk rn
select
    order_id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    user_name<span class="token punctuation">,</span>
    order_date<span class="token punctuation">,</span>
    order_amount<span class="token punctuation">,</span>
    <span class="token function">rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by user_id order by order_amount desc<span class="token punctuation">)</span> rk<span class="token punctuation">,</span>
    <span class="token function">dense_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by user_id order by order_amount desc<span class="token punctuation">)</span> drk<span class="token punctuation">,</span>
    <span class="token function">row_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partition by user_id order by order_amount desc<span class="token punctuation">)</span> rn
from order_info<span class="token punctuation">;</span>
<span class="token operator">--</span><span class="token function">rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span>、<span class="token function">dense_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span>、<span class="token function">row_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span>可以解决分组topN问题，配合where使用

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/285b57624a47a03753ab0081c976f999/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Beyondcompare比较时文件一样也标红的解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4c32a01d4a087fb46fb8d1cfddca0f28/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL 语法SQL 命令解析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>