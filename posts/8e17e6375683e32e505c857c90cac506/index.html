<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【设计模式之美】重构二：重构提高代码可测试性、mock替换外部服务 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【设计模式之美】重构二：重构提高代码可测试性、mock替换外部服务" />
<meta property="og:description" content="文章目录 一、案例分析1. 案例说明2. 测试用例11. 引入mock 与代码重构2. 解决分布式锁的问题 3. 测试用例3 二. 其他常见的 Anti-Patterns1. 未决行为2. 全局变量3. 静态方法4. 复杂继承5. 高耦合代码 主要讨论几个问题：
什么是代码的可测试性？
如何写出可测试的代码？
有哪些常见的不好测试的代码？
一、案例分析 1. 案例说明 看一个例子：
电商系统的交易类，用来记录每笔订单交易的情况。execute() 函数负责执行转账操作，将钱从买家的钱包转到卖家的钱包中。真正的转账操作是通过调用 WalletRpcService RPC 服务来完成的。代码中还涉及一个分布式锁 DistributedLock 单例类，用来避免 Transaction 并发执行，导致用户的钱被重复转出。 public class Transaction { private String id; private Long buyerId; private Long sellerId; private Long productId; private String orderId; private Long createTimestamp; private Double amount; private STATUS status; private String walletTransactionId; // ...get() methods... public Transaction(String preAssignedId, Long buyerId, Long sellerId, Long productId, String orderId) { if (preAssignedId !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8e17e6375683e32e505c857c90cac506/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-11T23:42:05+08:00" />
<meta property="article:modified_time" content="2024-01-11T23:42:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【设计模式之美】重构二：重构提高代码可测试性、mock替换外部服务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_7" rel="nofollow">一、案例分析</a></li><li><ul><li><a href="#1__8" rel="nofollow">1. 案例说明</a></li><li><a href="#2_1_93" rel="nofollow">2. 测试用例1</a></li><li><ul><li><a href="#1_mock__109" rel="nofollow">1. 引入mock 与代码重构</a></li><li><a href="#2__188" rel="nofollow">2. 解决分布式锁的问题</a></li></ul> 
   </li><li><a href="#3_3_257" rel="nofollow">3. 测试用例3</a></li></ul> 
  </li><li><a href="#__AntiPatterns_378" rel="nofollow">二. 其他常见的 Anti-Patterns</a></li><li><ul><li><a href="#1__379" rel="nofollow">1. 未决行为</a></li><li><a href="#2__397" rel="nofollow">2. 全局变量</a></li><li><a href="#3__440" rel="nofollow">3. 静态方法</a></li><li><a href="#4__450" rel="nofollow">4. 复杂继承</a></li><li><a href="#5__460" rel="nofollow">5. 高耦合代码</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>主要讨论几个问题：</p> 
<blockquote> 
 <p>什么是代码的可测试性？<br> 如何写出可测试的代码？<br> 有哪些常见的不好测试的代码？</p> 
</blockquote> 
<h2><a id="_7"></a>一、案例分析</h2> 
<h3><a id="1__8"></a>1. 案例说明</h3> 
<p>看一个例子：</p> 
<blockquote> 
 <ol><li>电商系统的交易类，用来记录每笔订单交易的情况。</li><li>execute() 函数负责执行转账操作，将钱从买家的钱包转到卖家的钱包中。真正的转账操作是通过调用 WalletRpcService RPC 服务来完成的。</li><li>代码中还涉及一个分布式锁 DistributedLock 单例类，用来避免 Transaction 并发执行，导致用户的钱被重复转出。</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Transaction</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> buyerId<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> sellerId<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> productId<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> orderId<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> createTimestamp<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Double</span> amount<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">STATUS</span> status<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> walletTransactionId<span class="token punctuation">;</span>
  
  <span class="token comment">// ...get() methods...</span>
  
  <span class="token keyword">public</span> <span class="token class-name">Transaction</span><span class="token punctuation">(</span><span class="token class-name">String</span> preAssignedId<span class="token punctuation">,</span> <span class="token class-name">Long</span> buyerId<span class="token punctuation">,</span> <span class="token class-name">Long</span> sellerId<span class="token punctuation">,</span> <span class="token class-name">Long</span> productId<span class="token punctuation">,</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>preAssignedId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>preAssignedId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> preAssignedId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token class-name">IdGenerator</span><span class="token punctuation">.</span><span class="token function">generateTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">"t_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">"t_"</span> <span class="token operator">+</span> preAssignedId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buyerId <span class="token operator">=</span> buyerId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sellerId <span class="token operator">=</span> sellerId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>orderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">TO_BE_EXECUTD</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>createTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InvalidTransactionException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>buyerId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>sellerId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> amount <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidTransactionException</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">EXECUTED</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isLocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      isLocked <span class="token operator">=</span> <span class="token class-name">RedisDistributedLock</span><span class="token punctuation">.</span><span class="token function">getSingletonIntance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockTransction</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 锁定未成功，返回false，job兜底执行</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">EXECUTED</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// double check</span>
      <span class="token keyword">long</span> executionInvokedTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executionInvokedTimestamp <span class="token operator">-</span> createdTimestap <span class="token operator">&gt;</span> <span class="token number">14d</span>ays<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">EXPIRED</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">WalletRpcService</span> walletRpcService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WalletRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> walletTransactionId <span class="token operator">=</span> walletRpcService<span class="token punctuation">.</span><span class="token function">moveMoney</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> buyerId<span class="token punctuation">,</span> sellerId<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>walletTransactionId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>walletTransactionId <span class="token operator">=</span> walletTransactionId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">EXECUTED</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FAILED</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isLocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token class-name">RedisDistributedLock</span><span class="token punctuation">.</span><span class="token function">getSingletonIntance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlockTransction</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 Transaction 类中，主要逻辑集中在 execute() 函数中，所以它是我们测试的重点对象。为了尽可能全面覆盖各种正常和异常情况，针对这个函数，我设计了下面 6 个测试用例。</p> 
<p><img src="https://images2.imgbox.com/f0/d6/7rpLq3os_o.png" alt="在这里插入图片描述" height="200"></p> 
<blockquote> 
 <p>6个用例这么设计也是交易可能遇到的情况</p> 
</blockquote> 
<p>事实是，当我们将测试用例落实到具体的代码实现时，你就会发现有很多行不通的地方。</p> 
<p> </p> 
<h3><a id="2_1_93"></a>2. 测试用例1</h3> 
<p><strong>测试代码</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">Long</span> buyerId <span class="token operator">=</span> <span class="token number">123L</span><span class="token punctuation">;</span>
  <span class="token class-name">Long</span> sellerId <span class="token operator">=</span> <span class="token number">234L</span><span class="token punctuation">;</span>
  <span class="token class-name">Long</span> productId <span class="token operator">=</span> <span class="token number">345L</span><span class="token punctuation">;</span>
  <span class="token class-name">Long</span> orderId <span class="token operator">=</span> <span class="token number">456L</span><span class="token punctuation">;</span>
  <span class="token class-name">Transction</span> transaction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transaction</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> buyerId<span class="token punctuation">,</span> sellerId<span class="token punctuation">,</span> productId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> executedResult <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertTrue</span><span class="token punctuation">(</span>executedResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>单元测试代码存在下面几个问题<img src="https://images2.imgbox.com/3d/82/Lu3w0Rf2_o.png" alt="在这里插入图片描述" height="200"></p> 
<h4><a id="1_mock__109"></a>1. 引入mock 与代码重构</h4> 
<p>mock的逻辑</p> 
<blockquote> 
 <p>回到单元测试的定义上。单元测试主要是测试程序员自己编写的代码逻辑的正确性，并非是端到端的集成测试，它不需要测试所依赖的外部系统（分布式锁、Wallet RPC 服务）的逻辑正确性。<br>  <br> 所以，如果代码中依赖了外部系统或者不可控组件，比如，需要依赖数据库、网络通信、文件系统等，那我们就需要将被测代码<strong>与外部系统解依赖，而这种解依赖的方法就叫作“mock”。</strong></p> 
</blockquote> 
<p>所谓的 mock 就是用一个“假”的服务替换真正的服务。mock 的服务完全在我们的控制之下，模拟输出我们想要的数据。</p> 
<p> </p> 
<p><strong>mock的方式</strong><br> mock 的方式主要有两种，手动 mock 和利用框架 mock。利用框架 mock 仅仅是为了简化代码编写，每个框架的 mock 方式都不大一样。我们这里只展示手动 mock。</p> 
<p>通过继承 WalletRpcService 类，并且重写其中的 moveMoney() 函数的方式来实现 mock。</p> 
<blockquote> 
 <p>通过 mock 的方式，我们可以让 moveMoney() 返回任意我们想要的数据，完全在我们的控制范围内，并且不需要真正进行网络通信。</p> 
</blockquote> 
<pre><code class="prism language-c">public class MockWalletRpcServiceOne extends WalletRpcService <span class="token punctuation">{<!-- --></span>
  public String <span class="token function">moveMoney</span><span class="token punctuation">(</span>Long id<span class="token punctuation">,</span> Long fromUserId<span class="token punctuation">,</span> Long toUserId<span class="token punctuation">,</span> Double amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"123bac"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

public class MockWalletRpcServiceTwo extends WalletRpcService <span class="token punctuation">{<!-- --></span>
  public String <span class="token function">moveMoney</span><span class="token punctuation">(</span>Long id<span class="token punctuation">,</span> Long fromUserId<span class="token punctuation">,</span> Long toUserId<span class="token punctuation">,</span> Double amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>替换WalletRpcService</p> 
<blockquote> 
 <p>因为 WalletRpcService 是在 execute() 函数中通过 new 的方式创建的，我们无法动态地对其进行替换。也就是说，Transaction 类中的 execute() 方法的<strong>可测试性很差</strong>，需要通过重构来让其变得更容易测试。</p> 
</blockquote> 
<p>代码重构</p> 
<blockquote> 
 <p>应用依赖注入，将 WalletRpcService 对象的创建反转给上层逻辑，在外部创建好之后，再注入到 Transaction 类中。</p> 
</blockquote> 
<pre><code class="prism language-c">public class Transaction <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//...</span>
  <span class="token comment">// 添加一个成员变量及其set方法</span>
  private WalletRpcService walletRpcService<span class="token punctuation">;</span>
  
  public <span class="token keyword">void</span> <span class="token function">setWalletRpcService</span><span class="token punctuation">(</span>WalletRpcService walletRpcService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>walletRpcService <span class="token operator">=</span> walletRpcService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  public boolean <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 删除下面这一行代码</span>
    <span class="token comment">// WalletRpcService walletRpcService = new WalletRpcService();</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>重构之后的代码对应的单元测试如下所示：</p> 
<pre><code class="prism language-c">public <span class="token keyword">void</span> <span class="token function">testExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  Long buyerId <span class="token operator">=</span> <span class="token number">123L</span><span class="token punctuation">;</span>
  Long sellerId <span class="token operator">=</span> <span class="token number">234L</span><span class="token punctuation">;</span>
  Long productId <span class="token operator">=</span> <span class="token number">345L</span><span class="token punctuation">;</span>
  Long orderId <span class="token operator">=</span> <span class="token number">456L</span><span class="token punctuation">;</span>
  Transction transaction <span class="token operator">=</span> new <span class="token function">Transaction</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> buyerId<span class="token punctuation">,</span> sellerId<span class="token punctuation">,</span> productId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 使用mock对象来替代真正的RPC服务</span>
  transaction<span class="token punctuation">.</span><span class="token function">setWalletRpcService</span><span class="token punctuation">(</span>new <span class="token function">MockWalletRpcServiceOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span>
  boolean executedResult <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertTrue</span><span class="token punctuation">(</span>executedResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span>STATUS<span class="token punctuation">.</span>EXECUTED<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<h4><a id="2__188"></a>2. 解决分布式锁的问题</h4> 
<p>再来看 RedisDistributedLock。</p> 
<blockquote> 
 <p>它的 mock 和替换要复杂一些，主要是因为 RedisDistributedLock 是一个单例类。单例相当于一个全局变量，我们无法 mock（无法继承和重写方法），也无法通过依赖注入的方式来替换。</p> 
</blockquote> 
<p>分布式锁重构<br> 对 transaction 上锁这部分逻辑重新封装一下。</p> 
<pre><code class="prism language-c">public class TransactionLock <span class="token punctuation">{<!-- --></span>
  public boolean <span class="token function">lock</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> RedisDistributedLock<span class="token punctuation">.</span><span class="token function">getSingletonIntance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockTransction</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  public <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    RedisDistributedLock<span class="token punctuation">.</span><span class="token function">getSingletonIntance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlockTransction</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

public class Transaction <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//...</span>
  private TransactionLock lock<span class="token punctuation">;</span>
  
  public <span class="token keyword">void</span> <span class="token function">setTransactionLock</span><span class="token punctuation">(</span>TransactionLock lock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  public boolean <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
    try <span class="token punctuation">{<!-- --></span>
      isLocked <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span> finally <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isLocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c">public <span class="token keyword">void</span> <span class="token function">testExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  Long buyerId <span class="token operator">=</span> <span class="token number">123L</span><span class="token punctuation">;</span>
  Long sellerId <span class="token operator">=</span> <span class="token number">234L</span><span class="token punctuation">;</span>
  Long productId <span class="token operator">=</span> <span class="token number">345L</span><span class="token punctuation">;</span>
  Long orderId <span class="token operator">=</span> <span class="token number">456L</span><span class="token punctuation">;</span>
  
  TransactionLock mockLock <span class="token operator">=</span> new <span class="token function">TransactionLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    public boolean <span class="token function">lock</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> true<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    public <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  Transction transaction <span class="token operator">=</span> new <span class="token function">Transaction</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> buyerId<span class="token punctuation">,</span> sellerId<span class="token punctuation">,</span> productId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//模拟WalletRpcService服务</span>
  transaction<span class="token punctuation">.</span><span class="token function">setWalletRpcService</span><span class="token punctuation">(</span>new <span class="token function">MockWalletRpcServiceOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//模拟lock服务</span>
  transaction<span class="token punctuation">.</span><span class="token function">setTransactionLock</span><span class="token punctuation">(</span>mockLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  boolean executedResult <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertTrue</span><span class="token punctuation">(</span>executedResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span>STATUS<span class="token punctuation">.</span>EXECUTED<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<h3><a id="3_3_257"></a>3. 测试用例3</h3> 
<p>实现如下逻辑的测试用例</p> 
<blockquote> 
 <p>交易已过期（createTimestamp 超过 14 天），交易状态设置为 EXPIRED，返回 false。</p> 
</blockquote> 
<pre><code class="prism language-c">public <span class="token keyword">void</span> <span class="token function">testExecute_with_TransactionIsExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  Long buyerId <span class="token operator">=</span> <span class="token number">123L</span><span class="token punctuation">;</span>
  Long sellerId <span class="token operator">=</span> <span class="token number">234L</span><span class="token punctuation">;</span>
  Long productId <span class="token operator">=</span> <span class="token number">345L</span><span class="token punctuation">;</span>
  Long orderId <span class="token operator">=</span> <span class="token number">456L</span><span class="token punctuation">;</span>
  Transction transaction <span class="token operator">=</span> new <span class="token function">Transaction</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> buyerId<span class="token punctuation">,</span> sellerId<span class="token punctuation">,</span> productId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  transaction<span class="token punctuation">.</span><span class="token function">setCreatedTimestamp</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">14</span>days<span class="token punctuation">)</span><span class="token punctuation">;</span>
  boolean actualResult <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertFalse</span><span class="token punctuation">(</span>actualResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span>STATUS<span class="token punctuation">.</span>EXPIRED<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们将 transaction 的创建时间 createdTimestamp 设置为 14 天前，即设置过期状态。但是，如果在 Transaction 类中，并没有暴露修改 createdTimestamp 成员变量的 set 方法呢？</p> 
<p>反例</p> 
<blockquote> 
 <p>如果没有 createTimestamp 的 set 方法，那就重新添加一个！但这违反了类的封装特性。在 Transaction 类的设计中，createTimestamp 是在交易生成时（也就是构造函数中）自动获取的系统时间，本来就不应该人为地轻易修改，所以，暴露 createTimestamp 的 set 方法，虽然带来了灵活性，但也带来了不可控性。</p> 
</blockquote> 
<p> </p> 
<p><strong>重构代码</strong></p> 
<blockquote> 
 <p>实际上，这是一类比较常见的问题，就是代码中包含跟“时间”有关的“未决行为”逻辑。我们一般的处理方式是将这种未决行为逻辑重新封装。<br> 针对 Transaction 类，我们只需要将交易是否过期的逻辑，封装到 isExpired() 函数中即可，</p> 
</blockquote> 
<pre><code class="prism language-c">public class Transaction <span class="token punctuation">{<!-- --></span>

  protected boolean <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> executionInvokedTimestamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> executionInvokedTimestamp <span class="token operator">-</span> createdTimestamp <span class="token operator">&gt;</span> <span class="token number">14</span>days<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  public boolean <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> throws InvalidTransactionException <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        this<span class="token punctuation">.</span>status <span class="token operator">=</span> STATUS<span class="token punctuation">.</span>EXPIRED<span class="token punctuation">;</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>针对重构之后的代码，测试用例 3 的代码实现如下所示：</p> 
<pre><code class="prism language-c">public <span class="token keyword">void</span> <span class="token function">testExecute_with_TransactionIsExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  Long buyerId <span class="token operator">=</span> <span class="token number">123L</span><span class="token punctuation">;</span>
  Long sellerId <span class="token operator">=</span> <span class="token number">234L</span><span class="token punctuation">;</span>
  Long productId <span class="token operator">=</span> <span class="token number">345L</span><span class="token punctuation">;</span>
  Long orderId <span class="token operator">=</span> <span class="token number">456L</span><span class="token punctuation">;</span>
  Transction transaction <span class="token operator">=</span> new <span class="token function">Transaction</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> buyerId<span class="token punctuation">,</span> sellerId<span class="token punctuation">,</span> productId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    protected boolean <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> true<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  boolean actualResult <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertFalse</span><span class="token punctuation">(</span>actualResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span>STATUS<span class="token punctuation">.</span>EXPIRED<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>通过重构，Transaction 代码的可测试性提高了。</strong><br>  </p> 
<p>不过，Transaction 类的构造函数的设计还有点不妥。再来看下构造函数</p> 
<pre><code class="prism language-c">  public <span class="token function">Transaction</span><span class="token punctuation">(</span>String preAssignedId<span class="token punctuation">,</span> Long buyerId<span class="token punctuation">,</span> Long sellerId<span class="token punctuation">,</span> Long productId<span class="token punctuation">,</span> String orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>preAssignedId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>preAssignedId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      this<span class="token punctuation">.</span>id <span class="token operator">=</span> preAssignedId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      this<span class="token punctuation">.</span>id <span class="token operator">=</span> IdGenerator<span class="token punctuation">.</span><span class="token function">generateTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>this<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">"t_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      this<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">"t_"</span> <span class="token operator">+</span> preAssignedId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    this<span class="token punctuation">.</span>buyerId <span class="token operator">=</span> buyerId<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>sellerId <span class="token operator">=</span> sellerId<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>orderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>status <span class="token operator">=</span> STATUS<span class="token punctuation">.</span>TO_BE_EXECUTD<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>createTimestamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>构造函数中并非只包含简单赋值操作。交易 id 的赋值逻辑稍微复杂。我们最好也要测试一下，以保证这部分逻辑的正确性。<br>  </p> 
<p><strong>重构id赋值</strong><br> 把 id 赋值这部分逻辑单独抽象到一个函数中，</p> 
<pre><code class="prism language-c">  public <span class="token function">Transaction</span><span class="token punctuation">(</span>String preAssignedId<span class="token punctuation">,</span> Long buyerId<span class="token punctuation">,</span> Long sellerId<span class="token punctuation">,</span> Long productId<span class="token punctuation">,</span> String orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
    <span class="token function">fillTransactionId</span><span class="token punctuation">(</span>preAssignId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span>
  
  protected <span class="token keyword">void</span> <span class="token function">fillTransactionId</span><span class="token punctuation">(</span>String preAssignedId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>preAssignedId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>preAssignedId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      this<span class="token punctuation">.</span>id <span class="token operator">=</span> preAssignedId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      this<span class="token punctuation">.</span>id <span class="token operator">=</span> IdGenerator<span class="token punctuation">.</span><span class="token function">generateTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>this<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">"t_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      this<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">"t_"</span> <span class="token operator">+</span> preAssignedId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>到此为止，我们一步一步将 Transaction 从不可测试代码重构成了测试性良好的代码。</p> 
<p> </p> 
<h2><a id="__AntiPatterns_378"></a>二. 其他常见的 Anti-Patterns</h2> 
<h3><a id="1__379"></a>1. 未决行为</h3> 
<p>所谓的未决行为逻辑就是，代码的输出是随机或者说不确定的，比如，跟时间、随机数有关的代码。对于这一点，在刚刚的实战案例中我们已经讲到，你可以利用刚才讲到的方法，试着重构一下下面的代码，并且为它编写单元测试。</p> 
<pre><code class="prism language-c">public class Demo <span class="token punctuation">{<!-- --></span>
  public <span class="token keyword">long</span> <span class="token function">caculateDelayDays</span><span class="token punctuation">(</span>Date dueTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> currentTimestamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dueTime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> currentTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> delayTime <span class="token operator">=</span> currentTimestamp <span class="token operator">-</span> dueTime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> delayDays <span class="token operator">=</span> delayTime <span class="token operator">/</span> <span class="token number">86400</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> delayDays<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<h3><a id="2__397"></a>2. 全局变量</h3> 
<p>前面我们讲过，全局变量是一种面向过程的编程风格，有种种弊端。实际上，滥用全局变量也让编写单元测试变得困难。</p> 
<p>如下例子：</p> 
<blockquote> 
 <p>RangeLimiter 表示一个[-5, 5]的区间，position 初始在 0 位置，move() 函数负责移动 position。其中，position 是一个静态全局变量。RangeLimiterTest 类是为其设计的单元测试，不过，这里面存在很大的问题。</p> 
</blockquote> 
<pre><code class="prism language-c">public class RangeLimiter <span class="token punctuation">{<!-- --></span>
  private <span class="token keyword">static</span> AtomicInteger position <span class="token operator">=</span> new <span class="token function">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  public <span class="token keyword">static</span> final <span class="token keyword">int</span> MAX_LIMIT <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  public <span class="token keyword">static</span> final <span class="token keyword">int</span> MIN_LIMIT <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">;</span>

  public boolean <span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> currentPos <span class="token operator">=</span> position<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolean betweenRange <span class="token operator">=</span> <span class="token punctuation">(</span>currentPos <span class="token operator">&lt;=</span> MAX_LIMIT<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>currentPos <span class="token operator">&gt;=</span> MIN_LIMIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> betweenRange<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

public class RangeLimiterTest <span class="token punctuation">{<!-- --></span>
  public <span class="token keyword">void</span> <span class="token function">testMove_betweenRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    RangeLimiter rangeLimiter <span class="token operator">=</span> new <span class="token function">RangeLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertTrue</span><span class="token punctuation">(</span>rangeLimiter<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertTrue</span><span class="token punctuation">(</span>rangeLimiter<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertTrue</span><span class="token punctuation">(</span>rangeLimiter<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  public <span class="token keyword">void</span> <span class="token function">testMove_exceedRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    RangeLimiter rangeLimiter <span class="token operator">=</span> new <span class="token function">RangeLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertFalse</span><span class="token punctuation">(</span>rangeLimiter<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面的单元测试有可能会运行失败。</p> 
<blockquote> 
 <p>假设单元测试框架顺序依次执行 testMove_betweenRange() 和 testMove_exceedRange() 两个测试用例。在第一个测试用例执行完成之后，position 的值变成了 -1；再执行第二个测试用例的时候，position 变成了 5，move() 函数返回 true，assertFalse 语句判定失败。所以，第二个测试用例运行失败。</p> 
</blockquote> 
<p>并发问题</p> 
<blockquote> 
 <p>当然，如果 RangeLimiter 类有暴露重设（reset）position 值的函数，我们可以在每次执行单元测试用例之前，把 position 重设为 0，这样就能解决刚刚的问题。不过，每个单元测试框架执行单元测试用例的方式可能是不同的。有的是顺序执行，有的是并发执行。对于并发执行的情况，即便我们每次都把 position 重设为 0，也并不奏效。如果两个测试用例并发执行，第 16、17、18、23 这四行代码可能会交叉执行，影响到 move() 函数的执行结果。</p> 
</blockquote> 
<p> </p> 
<h3><a id="3__440"></a>3. 静态方法</h3> 
<p>在代码中调用静态方法，有时候会导致代码不易测试。主要原因是静态方法也很难 mock。</p> 
<blockquote> 
 <p>但是，这个要分情况来看。<br> 只有在这个静态方法执行耗时太长、依赖外部资源、逻辑复杂、行为未决等情况下，我们才需要在单元测试中 mock 这个静态方法。<br> 除此之外，如果只是类似 Math.abs() 这样的简单静态方法，并不会影响代码的可测试性，因为本身并不需要 mock。</p> 
</blockquote> 
<p> </p> 
<h3><a id="4__450"></a>4. 复杂继承</h3> 
<p>我们前面提到，相比组合关系，继承关系的代码结构更加耦合、不灵活，更加不易扩展、不易维护。实际上，继承关系也更加难测试。<strong>这也印证了代码的可测试性跟代码质量的相关性。</strong></p> 
<blockquote> 
 <p>如果父类需要 mock 某个依赖对象才能进行单元测试，那所有的子类、子类的子类……在编写单元测试的时候，都要 mock 这个依赖对象。对于层次很深（在继承关系类图中表现为纵向深度）、结构复杂（在继承关系类图中表现为横向广度）的继承关系，越底层的子类要 mock 的对象可能就会越多，这样就会导致，底层子类在写单元测试的时候，要一个一个 mock 很多依赖对象，而且还需要查看父类代码，去了解该如何 mock 这些依赖对象。</p> 
</blockquote> 
<p>利用组合：</p> 
<blockquote> 
 <p>如果我们利用组合而非继承来组织类之间的关系，类之间的结构层次比较扁平，在编写单元测试的时候，只需要 mock 类所组合依赖的对象即可。</p> 
</blockquote> 
<p> </p> 
<h3><a id="5__460"></a>5. 高耦合代码</h3> 
<p>如果一个类职责很重，需要依赖十几个外部对象才能完成工作，代码高度耦合，那我们在编写单元测试的时候，可能需要 mock 这十几个依赖的对象。不管是从代码设计的角度来说，还是从编写单元测试的角度来说，这都是不合理的。</p> 
<p> </p> 
<p>参考：《设计模式之美》-- 王争</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/484fe9b5a7beadc56ffd3c2b5f41415c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[JavaScript] 第七章 对象</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5383f332d76cfa7ec8b3f19df7705292/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【机器学习】半监督学习</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>