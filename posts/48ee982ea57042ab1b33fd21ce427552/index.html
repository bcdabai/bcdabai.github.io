<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>sersync/lsyncd实时同步 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="sersync/lsyncd实时同步" />
<meta property="og:description" content="第一章 sersync/lsync实时同步 1.1 实时同步服务原理/概念 1)需要部署好rsync守护进程服务，实现数据传输
2)需要部署好inotify服务，实现目录中数据变化监控
3)将rsync服务和inotify服务建立联系，将变化的数据进行实时备份传输
1.2 inotify介绍 ݦ Inotify是一种强大的,细粒度的,异步的文件系统事件监视机制,Linux2.6.13起加入了inotify支持,通过inotify可以监控文件系统中添加,删除,修改,移动等各种事件,利用这个内核接口,第三方软件就可以监控文件系统下文件的各种变化情况,而inotify-tools正是实施这样监控的软件,另外一个这样效果的软件是中国人周洋在金山公司开发的sersync,还有一个配置更简单的软件叫lsyncd
1.2.1 查看当前系统是否支持inotify [root@nfs data]# uname -r 3.10.0-693.el7.x86_64 1.2.2 安装inotify-tools [root@nfs data]# yum -y install inotify-tools 1.2.3 关键参数说明 [root@nfs backup]# ll /proc/sys/fs/inotify/ total 0 -rw-r--r-- 1 root root 0 Jul 19 15:46 max_queued_events -rw-r--r-- 1 root root 0 Jul 19 15:46 max_user_instances -rw-r--r-- 1 root root 0 Jul 19 15:46 max_user_watches ----------------------------------------------------------------------------- max_queued_events #设置inotify实例事件（event）队列可容纳的事件数量 max_user_instances #设置每个用户可以运行的inotify或者inotifywatch命令的进程数 max_user_watches #设置inotifywait或者inotifywatch命令可以监控的文件数量（单进程） 1.2.4 inotifywait命令参数说明 inotifywait命令参数说明 参数名称 参数说明 -m ,-monitor 始终保持事件监听状态 -r,-recursive 递归查询目录 -q,-quiet 只打印监控事件的信息 -exclude 排除文件或目录时,不区分大小写 -t,-timeout 超时时间 -timefmt 指定时间输出格式 -format 指定时间输出格式 -e,event 后面指定增,删,改等事件 inotifywait events 事件说明 access 读取文件或目录内容 modify 修改文件或目录内容 attrib 文件或目录的属性改变 close_write 修改真实文件内容 open 文件或目录被打开 moved_to 文件或目录移动到 moved_from 文件或目录从." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/48ee982ea57042ab1b33fd21ce427552/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-28T22:47:00+08:00" />
<meta property="article:modified_time" content="2019-07-28T22:47:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">sersync/lsyncd实时同步</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown"> 
 <h2 id="第一章-sersynclsync实时同步">第一章 sersync/lsync实时同步</h2> 
 <h3 id="实时同步服务原理概念">1.1 实时同步服务原理/概念</h3> 
 <p>1)需要部署好rsync守护进程服务，实现数据传输<br> 2)需要部署好inotify服务，实现目录中数据变化监控<br> 3)将rsync服务和inotify服务建立联系，将变化的数据进行实时备份传输</p> 
 <h3 id="inotify介绍">1.2 inotify介绍</h3> 
 <p>ݦ Inotify是一种强大的,细粒度的,异步的文件系统事件监视机制,Linux2.6.13起加入了inotify支持,通过inotify可以监控文件系统中添加,删除,修改,移动等各种事件,利用这个内核接口,第三方软件就可以监控文件系统下文件的各种变化情况,而inotify-tools正是实施这样监控的软件,另外一个这样效果的软件是中国人周洋在金山公司开发的sersync,还有一个配置更简单的软件叫lsyncd</p> 
 <h4 id="查看当前系统是否支持inotify">1.2.1 查看当前系统是否支持inotify</h4> 
 <pre class="bash"><code>[root@nfs data]# uname -r
3.10.0-693.el7.x86_64</code></pre> 
 <h4 id="安装inotify-tools">1.2.2 安装inotify-tools</h4> 
 <pre class="bash"><code>[root@nfs data]# yum -y install inotify-tools</code></pre> 
 <h4 id="关键参数说明">1.2.3 关键参数说明</h4> 
 <pre class="bash"><code>[root@nfs backup]# ll /proc/sys/fs/inotify/
total 0
-rw-r--r-- 1 root root 0 Jul 19 15:46 max_queued_events
-rw-r--r-- 1 root root 0 Jul 19 15:46 max_user_instances
-rw-r--r-- 1 root root 0 Jul 19 15:46 max_user_watches
-----------------------------------------------------------------------------
max_queued_events       #设置inotify实例事件（event）队列可容纳的事件数量
max_user_instances      #设置每个用户可以运行的inotify或者inotifywatch命令的进程数
max_user_watches        #设置inotifywait或者inotifywatch命令可以监控的文件数量（单进程）</code></pre> 
 <h4 id="inotifywait命令参数说明">1.2.4 inotifywait命令参数说明</h4> 
 <pre class="bash"><code>inotifywait命令参数说明
参数名称            参数说明
-m ,-monitor       始终保持事件监听状态
-r,-recursive      递归查询目录
-q,-quiet          只打印监控事件的信息
-exclude           排除文件或目录时,不区分大小写
-t,-timeout        超时时间
-timefmt           指定时间输出格式
-format            指定时间输出格式
-e,event           后面指定增,删,改等事件
inotifywait events 事件说明
access             读取文件或目录内容
modify             修改文件或目录内容
attrib             文件或目录的属性改变
close_write        修改真实文件内容
open               文件或目录被打开
moved_to           文件或目录移动到
moved_from         文件或目录从...移动到
move               移动文件或目录移动到监视目录
create             在监视目录下创建文件或目录
delete             删除监视目录下的文件或目录
umount             卸载文件系统
</code></pre> 
 <h4 id="inotify监控命令格式">1.2.5 inotify监控命令格式</h4> 
 <h5 id="测试创建和删除">测试创建和删除</h5> 
 <pre class="bash"><code>[root@nfs data]# touch {01..02}.txt
[root@nfs data]# rm -rf *
[root@nfs data]# 
</code></pre> 
 <pre class="bash"><code>[root@nfs data]# inotifywait -rmq --timefmt '%F %H:%M:%S' --format '%T %w%f 事件信息: %e' -e create,delete /data/

2019-07-19 15:58:32 /data/01.txt 事件信息: CREATE
2019-07-19 15:58:32 /data/02.txt 事件信息: CREATE
2019-07-19 15:59:30 /data/01.txt 事件信息: DELETE
2019-07-19 15:59:30 /data/02.txt 事件信息: DELETE</code></pre> 
 <h5 id="测试修改文件内容">测试修改文件内容</h5> 
 <pre class="bash"><code>[root@nfs data]# echo "11" &gt;1.txt </code></pre> 
 <pre class="bash"><code>[root@nfs data]# inotifywait -rmq --timefmt '%F %H:%M:%S' --format '%T %w%f 事件信息: %e' -e close_write /data/

2019-07-19 16:01:42 /data/1.txt 事件信息: CLOSE_WRITE,CLOSE
</code></pre> 
 <h4 id="利用inotify监控编写实时监控rsync发送脚本">1.2.6 利用inotify监控编写实时监控rsync发送脚本</h4> 
 <pre class="bash"><code>[root@nfs ~]# cat inotify_push.sh 
#!/bin/bash

Path=/data
backup_Server=172.16.1.41
export RSYNC_PASSWORD=oldboy

/usr/bin/inotifywait -mrq --format '%w%f' -e create,close_write,delete /data | while read line
do
echo "${line}"
if [ -f $line ];then
    rsync -azvP $line --delete rsync_backup@$backup_Server::data
fi
done</code></pre> 
 <h4 id="inotify的优缺点">1.2.7 inotify的优缺点</h4> 
 <p>inotify的优点<br> 1）监控文件系统事件变化，通过同步工具实现实时数据同步<br> inotify的缺点<br> 1）并发如果大于200个文（10-100K），同步就会由延迟<br> 2）我们前面的脚本，每次都是全部推送一次，但是确实是增量的，也可以只同步变化的文件<br> 3）监控到事件后，调用rsync的同步是单进程（加＆并发）sersync进程多同步</p> 
 <h4 id="sersync功能多inotify-rsync命令">1.2.8 sersync功能多：（inotify + rsync命令）</h4> 
 <p>1）支持通过配置文件管理<br> 2）真正的守护进程socket<br> 3）可以对失败文件定时重传（定时任务功能）<br> 4）第三方的HTTP接口（例如：更新cdn缓存）<br> 5）默认多线程rsync同步</p> 
 <h3 id="使用sersync前提条件">1.3 使用sersync前提条件</h3> 
 <p>1.部署好rsync的服务<br> 2.修改sersync配置文件<br> 3.启动sersync即可。</p> 
 <p>sersync下载地址：<a href="https://github.com/wsgzao/sersync/blob/master/sersync2.5.4_64bit_binary_stable_final.tar.gz"></a></p> 
 <h4 id="安装sersync服务">1.3.1 安装sersync服务</h4> 
 <pre class="bash"><code>[root@nfs application]# cd /home/tools/
[root@nfs tools]# ll
total 712
-rw-r--r-- 1 root root 727290 Jun 30 17:52 sersync2.5.4_64bit_binary_stable_final.tar.gz
[root@nfs tools]# tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz 
[root@nfs tools]# ll
total 712
drwxr-xr-x 2 root root     41 Oct 26  2011 GNU-Linux-x86
-rw-r--r-- 1 root root 727290 Jun 30 17:52 sersync2.5.4_64bit_binary_stable_final.tar.gz
[root@nfs tools]# mv GNU-Linux-x86/ /application/sersync
[root@nfs tools]# cd /application/sersync/
[root@nfs sersync]# tree ../sersync/
../sersync/
├── confxml.xml
└── sersync2

0 directories, 2 files
[root@nfs sersync]# 
</code></pre> 
 <h4 id="修改配置文件confxml.xml">1.3.2 修改配置文件confxml.xml</h4> 
 <pre class="bash"><code>#排除指定数据信息不要进行实时传输同步
   &lt;filter start="false"&gt;
        &lt;exclude expression="(.*)\.svn"&gt;&lt;/exclude&gt;
        &lt;exclude expression="(.*)\.gz"&gt;&lt;/exclude&gt;
        &lt;exclude expression="^info/*"&gt;&lt;/exclude&gt;
        &lt;exclude expression="^static/*"&gt;&lt;/exclude&gt;
    &lt;/filter&gt;</code></pre> 
 <pre class="bash"><code>#定义inotify程序需要监控的事件
    &lt;inotify&gt;
        &lt;delete start="true"/&gt;
        &lt;createFolder start="true"/&gt;
        &lt;createFile start="false"/&gt;
        &lt;closeWrite start="true"/&gt;
        &lt;moveFrom start="true"/&gt;
        &lt;moveTo start="true"/&gt;
        &lt;attrib start="false"/&gt;
        &lt;modify start="false"/&gt;
    &lt;/inotify&gt;
</code></pre> 
 <pre class="bash"><code>#定义rsync服务功能
 &lt;localpath watch="/data"&gt;
            &lt;remote ip="172.16.1.41" name="backup"/&gt;
            &lt;!--&lt;remote ip="192.168.8.39" name="tongbu"/&gt;--&gt;
            &lt;!--&lt;remote ip="192.168.8.40" name="tongbu"/&gt;--&gt;
        &lt;/localpath&gt;
        &lt;rsync&gt;
            &lt;commonParams params="-az"/&gt;
            &lt;auth start="true" users="rsync_backup" passwordfile="/etc/rsync.password"/&gt;
            &lt;userDefinedPort start="false" port="874"/&gt;&lt;!-- port=874 --&gt;
            &lt;timeout start="false" time="100"/&gt;&lt;!-- timeout=100 --&gt;
            &lt;ssh start="false"/&gt;
        &lt;/rsync&gt;
</code></pre> 
 <h4 id="查看sersync帮助说明">1.3.4 查看sersync帮助说明</h4> 
 <pre class="bash"><code>[root@nfs sersync]# sersync2 -h
set the system param
execute：echo 50000000 &gt; /proc/sys/fs/inotify/max_user_watches
execute：echo 327679 &gt; /proc/sys/fs/inotify/max_queued_events
parse the command param
_______________________________________________________
参数-d:启用守护进程模式
参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍
c参数-n: 指定开启守护线程的数量，默认为10个
参数-o:指定配置文件，默认使用confxml.xml文件
参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块
参数-m:单独启用其他模块，使用 -m socket 开启socket模块
参数-m:单独启用其他模块，使用 -m http 开启http模块
不加-m参数，则默认执行同步程序
________________________________________________________________
[root@nfs sersync]# 
</code></pre> 
 <h4 id="启动sersync">1.3.4启动sersync</h4> 
 <pre class="bash"><code>[root@nfs sersync]# sersync2 -dro /application/sersync/confxml.xml
set the system param
execute：echo 50000000 &gt; /proc/sys/fs/inotify/max_user_watches
execute：echo 327679 &gt; /proc/sys/fs/inotify/max_queued_events
parse the command param
option: -d  run as a daemon
option: -r  rsync all the local files to the remote servers before the sersync work
option: -o  config xml name：  /application/sersync/confxml.xml
daemon thread num: 10
parse xml config file
host ip : localhost host port: 8008
daemon start，sersync run behind the console 
use rsync password-file :
user is rsync_backup
passwordfile is     /etc/rsync.password
config xml parse success
please set /etc/rsyncd.conf max connections=0 Manually
sersync working thread 12  = 1(primary thread) + 1(fail retry thread) + 10(daemon sub threads) 
Max threads numbers is: 22 = 12(Thread pool nums) + 10(Sub threads)
please according your cpu ，use -n param to adjust the cpu rate
------------------------------------------
rsync the directory recursivly to the remote servers once
working please wait...
execute command: cd /data &amp;&amp; rsync -az -R --delete ./ rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password &gt;/dev/null 2&gt;&amp;1 
run the sersync: 
watch path is: /data
[root@nfs sersync]# </code></pre> 
 <h3 id="lsyncd简介">1.4 lsyncd简介</h3> 
 <p>Lysncd 实际上是lua语言封装了 inotify 和 rsync 工具，采用了 Linux 内核（2.6.13 及以后）里的 inotify 触发机制，然后通过rsync去差异同步，达到实时的效果。我认为它最令人称道的特性是，完美解决了 <code>inotify + rsync</code>海量文件同步带来的文件频繁发送文件列表的问题 —— 通过时间延迟或累计触发事件次数实现。另外，它的配置方式很简单，lua本身就是一种配置语言，可读性非常强。lsyncd也有多种工作模式可以选择，本地目录cp，本地目录rsync，远程目录rsyncssh。<br> 实现简单高效的本地目录同步备份（网络存储挂载也当作本地目录），一个命令搞定。</p> 
 <h4 id="安装lsyncd">1.4.1 安装lsyncd</h4> 
 <pre class="bash"><code>[root@nfs01 ~]# yum install lsyncd -y
[root@nfs sersync]# rpm -qc lsyncd
/etc/logrotate.d/lsyncd
/etc/lsyncd.conf
/etc/sysconfig/lsyncd</code></pre> 
 <h4 id="创建配置文件">1.4.2 创建配置文件</h4> 
 <pre class="bash"><code>[root@nfs ~]# vim /etc/lsyncd.conf 
settings {
  logfile = "/var/log/lsyncd/lsyncd.log",
  statusFile = "/var/log/lsyncd/lsyncd.status",
  inotifyMode = "CloseWrite",
  maxProcesses = 8,
}
sync {
  default.rsync,
  source = "/data",
  target = "rsync_backup@172.16.1.41::backup",
  delete= true,
  exclude = { ".*" },
  delay = 1,
  rsync = {
    binary = "/usr/bin/rsync",
    archive = true,
    compress = true,
    verbose = true,
    password_file = "/etc/rsync.password",
    _extra = {"--bwlimit=200"}
  }
}
</code></pre> 
 <p>配置说明</p> 
 <pre class="bash"><code>settings {                                      #里面是全局设置
  logfile = "/var/log/lsyncd/lsyncd.log",          #定义日志文件
  statusFile = "/var/log/lsyncd/lsyncd.status",     #定义状态文件
  inotifyMode = "CloseWrite",                     #指定inotify监控的事件
  maxProcesses = 8,                             #同步进程的最大个数。假如同时有20个文件需要同步，而                                                 maxProcesses = 8，则最大能看到有8个rysnc进程
}
sync {                                         #里面是定义同步参数
  default.rsync,
  source = "/data",                             #同步的源目录，使用绝对路径。             
  target = "rsync_backup@172.16.1.41::backup",     #定义目的地址.对应不同的模式有几种写法：
                                               #/tmp/dest ：本地目录同步，可用于direct和rsync模式172.29.88.223:/tmp/dest ：同步到远程服务器目录，可用于rsync和rsyncssh模式
  delete= true,                                 #为了保持target与souce完全同步
  exclude = { ".*" },                           #排除
  delay = 1,                                    #累计事件，等待rsync同步延时时间
  rsync = {                                    #rsync模式
    binary = "/usr/bin/rsync",                    #rsync命令路径
    archive = true,                             #归档模式传输, 等于-tropgDl
    compress = true,                            #压缩传输默认为true
    verbose = true,                             #详细模式输出, 打印速率, 文件数量等
    password_file = "/etc/rsync.password",        #免交互登录
    _extra = {"--bwlimit=200"}                   #限速，单位kb/s
  }
}</code></pre> 
 <h4 id="启动命令">1.4.3 启动命令</h4> 
 <pre class="bash"><code>[root@nfs ~]# systemctl start lsyncd</code></pre> 
</div> 
<p>转载于:https://www.cnblogs.com/opesn/p/11261359.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fd8f9d186cef4fb120417918a4d223ab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SCI三区论文大修笔记（已录用）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8051b7ac6b2919ee032a3876e48affd5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">“做好大数据测试，我是认真的！”</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>