<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Swin-Transformer图像分类 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Swin-Transformer图像分类" />
<meta property="og:description" content="文章目录 1. 准备数据集1.1 数据集存放格式1.2 config配置文件 2. 训练2.1 代码中调整了的部分2.2 训练命令 3. 评估4. 推理4.1 推理脚本4.2 推理命令4.3 推理结果4.4 特征可视化 源代码地址：Swin-Transformer
预训练模型链接：swinv2_base_patch4_window12_192_22k.pth
本机为Ubuntu系统，为了训练自己的数据集，在原代码的基础上做了一点小调整：
原代码中每个epoch保存一个模型，调整为只保存表现最佳的模型和最后一个epoch的模型原代码训练的ImageNet数据集，数据类别比较多，输出了两个评估指标：Top-1 Acc和Top-5 Acc，但我自己数据集只有3个类别，调整为输出Top-1 Acc和Top-2 Acc（其实Top-2 Acc没啥用，不输出也可以的）原代码未细化每个类别的Acc，简单补充了下该信息在终端的输出原代码没有推理脚本，简单补充了一个 1. 准备数据集 1.1 数据集存放格式 ── imagenet ├── train │ ├── class1 │ │ ├── cat0001.jpg │ │ ├── cat0002.jpg │ │ └── ... │ ├── class2 │ │ ├── dog0001.jpg │ │ ├── dog0002.jpg │ │ └── ... │ └── class3 │ ├── bird0001.jpg │ ├── bird0002." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/15c6e59c649bc9bac1154917521f4876/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-11T14:55:10+08:00" />
<meta property="article:modified_time" content="2023-12-11T14:55:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Swin-Transformer图像分类</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#1__9" rel="nofollow">1. 准备数据集</a></li><li><ul><li><a href="#11__10" rel="nofollow">1.1 数据集存放格式</a></li><li><a href="#12_config_31" rel="nofollow">1.2 config配置文件</a></li></ul> 
    </li><li><a href="#2__67" rel="nofollow">2. 训练</a></li><li><ul><li><a href="#21__68" rel="nofollow">2.1 代码中调整了的部分</a></li><li><a href="#22__229" rel="nofollow">2.2 训练命令</a></li></ul> 
    </li><li><a href="#3__234" rel="nofollow">3. 评估</a></li><li><a href="#4__242" rel="nofollow">4. 推理</a></li><li><ul><li><a href="#41__243" rel="nofollow">4.1 推理脚本</a></li><li><a href="#42__371" rel="nofollow">4.2 推理命令</a></li><li><a href="#43__376" rel="nofollow">4.3 推理结果</a></li><li><a href="#44__378" rel="nofollow">4.4 特征可视化</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p><strong>源代码地址</strong>：<a href="https://github.com/microsoft/Swin-Transformer/tree/afeb877fba1139dfbc186276983af2abb02c2196">Swin-Transformer</a><br> 预训练模型链接：<a href="https://github.com/SwinTransformer/storage/releases/download/v2.0.0/swinv2_base_patch4_window12_192_22k.pth">swinv2_base_patch4_window12_192_22k.pth</a><br> 本机为Ubuntu系统，为了训练自己的数据集，在原代码的基础上做了一点小调整：</p> 
<ul><li>原代码中每个epoch保存一个模型，调整为只保存表现<strong>最佳的模型</strong>和<strong>最后一个epoch的模型</strong></li><li>原代码训练的ImageNet数据集，数据类别比较多，输出了两个评估指标：Top-1 Acc和Top-5 Acc，但我自己数据集只有3个类别，调整为输出Top-1 Acc和Top-2 Acc（其实Top-2 Acc没啥用，不输出也可以的）</li><li>原代码未细化每个类别的Acc，简单补充了下该信息在终端的输出</li><li>原代码没有<strong>推理脚本</strong>，简单补充了一个</li></ul> 
<h4><a id="1__9"></a>1. 准备数据集</h4> 
<h5><a id="11__10"></a>1.1 数据集存放格式</h5> 
<pre><code class="prism language-bash">── imagenet
├── train
│   ├── class1
│   │   ├── cat0001.jpg
│   │   ├── cat0002.jpg
│   │   └── <span class="token punctuation">..</span>.
│   ├── class2
│   │   ├── dog0001.jpg
│   │   ├── dog0002.jpg
│   │   └── <span class="token punctuation">..</span>.
│   └── class3
│       ├── bird0001.jpg
│       ├── bird0002.jpg
│       └── <span class="token punctuation">..</span>.
└── val
    ├── class1
    ├── class2
    └── class3
</code></pre> 
<h5><a id="12_config_31"></a>1.2 config配置文件</h5> 
<p>以<code>swinv2_base_patch4_window12_192_22k.yaml</code>为例</p> 
<pre><code class="prism language-python">DATA<span class="token punctuation">:</span>
  <span class="token comment"># 为了配合上方的数据集存放格式，DATASET的value需设置为imagenet</span>
  DATASET<span class="token punctuation">:</span> imagenet
  IMG_SIZE<span class="token punctuation">:</span> <span class="token number">384</span>
  <span class="token comment"># NAME_CLASSES是自己增加的，在推理阶段可视化时使用</span>
  NAME_CLASSES<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cat"</span><span class="token punctuation">,</span> <span class="token string">"dog"</span><span class="token punctuation">,</span> <span class="token string">"bird"</span><span class="token punctuation">]</span>
MODEL<span class="token punctuation">:</span>
  TYPE<span class="token punctuation">:</span> swinv2
  NAME<span class="token punctuation">:</span> swinv2_base_patch4_window12_192_22k
  DROP_PATH_RATE<span class="token punctuation">:</span> <span class="token number">0.2</span>
  <span class="token comment"># NUM_CLASSES是增加进来的默认是1000</span>
  NUM_CLASSES<span class="token punctuation">:</span> <span class="token number">3</span>
  SWINV2<span class="token punctuation">:</span>
    EMBED_DIM<span class="token punctuation">:</span> <span class="token number">128</span>
    DEPTHS<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">]</span>
    NUM_HEADS<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span> <span class="token punctuation">]</span>
    WINDOW_SIZE<span class="token punctuation">:</span> <span class="token number">12</span>
TRAIN<span class="token punctuation">:</span>
  EPOCHS<span class="token punctuation">:</span> <span class="token number">90</span>
  WARMUP_EPOCHS<span class="token punctuation">:</span> <span class="token number">5</span>
  WEIGHT_DECAY<span class="token punctuation">:</span> <span class="token number">0.1</span>
  BASE_LR<span class="token punctuation">:</span> <span class="token number">1.25e-4</span> <span class="token comment"># 4096 batch-size</span>
  WARMUP_LR<span class="token punctuation">:</span> <span class="token number">1.25e-7</span>
  MIN_LR<span class="token punctuation">:</span> <span class="token number">1.25e-6</span>
</code></pre> 
<p>针对上方的调整相应地需要修改<code>config.py</code>文件</p> 
<pre><code class="prism language-python">_C<span class="token punctuation">.</span>DATA <span class="token operator">=</span> CN<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 增加NAME_CLASSES字段的默认值</span>
_C<span class="token punctuation">.</span>DATA<span class="token punctuation">.</span>NAME_CLASSES <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> 
<h4><a id="2__67"></a>2. 训练</h4> 
<h5><a id="21__68"></a>2.1 代码中调整了的部分</h5> 
<ul><li><code>main.py</code></li></ul> 
<pre><code class="prism language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    args<span class="token punctuation">,</span> config <span class="token operator">=</span> parse_option<span class="token punctuation">(</span><span class="token punctuation">)</span>
	
    <span class="token comment"># 训练环境为本地单机单卡，手动写入环境变量中一些字段</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'WORLD_SIZE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'1'</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'RANK'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'0'</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'MASTER_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'localhost'</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'MASTER_PORT'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'12345'</span>
    <span class="token comment"># ...</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">if</span> config<span class="token punctuation">.</span>TRAIN<span class="token punctuation">.</span>AUTO_RESUME<span class="token punctuation">:</span>
	resume_file <span class="token operator">=</span> auto_resume_helper<span class="token punctuation">(</span>config<span class="token punctuation">.</span>OUTPUT<span class="token punctuation">,</span> get_best<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 原代码中计算acc时输出的是top-1 acc和top-5 acc，但我自己的数据集只有3个类别</span>
<span class="token comment"># 所以调整为输出top-1 acc和top-2 acc</span>
<span class="token comment"># 增加了每个类别的acc的输出</span>
<span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> data_loader<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    criterion <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    batch_time <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loss_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    acc1_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    acc2_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cla_num_meter <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>NUM_CLASSES<span class="token punctuation">)</span>
    pre_num_meter <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>NUM_CLASSES<span class="token punctuation">)</span>

    end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>images<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        images <span class="token operator">=</span> images<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span>non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        target <span class="token operator">=</span> target<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span>non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># compute output</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp<span class="token punctuation">.</span>autocast<span class="token punctuation">(</span>enabled<span class="token operator">=</span>config<span class="token punctuation">.</span>AMP_ENABLE<span class="token punctuation">)</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> model<span class="token punctuation">(</span>images<span class="token punctuation">)</span>

        <span class="token comment"># measure accuracy and record loss</span>
        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
        acc1<span class="token punctuation">,</span> acc2 <span class="token operator">=</span> accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cla_num<span class="token punctuation">,</span> pre_num <span class="token operator">=</span> cla_accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>NUM_CLASSES<span class="token punctuation">)</span>
        cla_num_meter <span class="token operator">+=</span> cla_num
        pre_num_meter <span class="token operator">+=</span> pre_num

        acc1 <span class="token operator">=</span> reduce_tensor<span class="token punctuation">(</span>acc1<span class="token punctuation">)</span>
        acc2 <span class="token operator">=</span> reduce_tensor<span class="token punctuation">(</span>acc2<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> reduce_tensor<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>

        loss_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        acc1_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>acc1<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        acc2_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>acc2<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># measure elapsed time</span>
        batch_time<span class="token punctuation">.</span>update<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> end<span class="token punctuation">)</span>
        end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> idx <span class="token operator">%</span> config<span class="token punctuation">.</span>PRINT_FREQ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            memory_used <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>max_memory_allocated<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024.0</span> <span class="token operator">*</span> <span class="token number">1024.0</span><span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f'Test: [</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>idx<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>data_loader<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">]\t'</span></span>
                <span class="token string-interpolation"><span class="token string">f'Time </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_time<span class="token punctuation">.</span>val<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_time<span class="token punctuation">.</span>avg<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">)\t'</span></span>
                <span class="token string-interpolation"><span class="token string">f'Loss </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>loss_meter<span class="token punctuation">.</span>val<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>loss_meter<span class="token punctuation">.</span>avg<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">)\t'</span></span>
                <span class="token string-interpolation"><span class="token string">f'Acc@1 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>acc1_meter<span class="token punctuation">.</span>val<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>acc1_meter<span class="token punctuation">.</span>avg<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">)\t'</span></span>
                <span class="token string-interpolation"><span class="token string">f'Acc@2 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>acc2_meter<span class="token punctuation">.</span>val<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>acc2_meter<span class="token punctuation">.</span>avg<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">)\t'</span></span>
                <span class="token string-interpolation"><span class="token string">f'Mem </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>memory_used<span class="token punctuation">:</span><span class="token format-spec">.0f</span><span class="token punctuation">}</span></span><span class="token string">MB'</span></span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f' * Acc@1 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>acc1_meter<span class="token punctuation">.</span>avg<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> Acc@2 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>acc2_meter<span class="token punctuation">.</span>avg<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    ans <span class="token operator">=</span> <span class="token string">''</span>
    acc_each_class <span class="token operator">=</span> <span class="token punctuation">[</span>pre_num_meter<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> cla_num_meter<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>NUM_CLASSES<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>NUM_CLASSES<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ans <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'Acc of </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>config<span class="token punctuation">.</span>DATA<span class="token punctuation">.</span>NAME_CLASSES<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>acc_each_class<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\t'</span></span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>ans<span class="token punctuation">)</span>
    <span class="token keyword">return</span> acc1_meter<span class="token punctuation">.</span>avg<span class="token punctuation">,</span> acc2_meter<span class="token punctuation">.</span>avg<span class="token punctuation">,</span> loss_meter<span class="token punctuation">.</span>avg

<span class="token keyword">def</span> <span class="token function">cla_accuracy</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> num_class<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 计算每个类别的实际数目和识别正确数目</span>
    _<span class="token punctuation">,</span> pred <span class="token operator">=</span> output<span class="token punctuation">.</span>topk<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    sam_nums <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>num_class<span class="token punctuation">)</span>
    pre_cor_nums <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>num_class<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sam_nums<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">int</span><span class="token punctuation">(</span>pred<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pre_cor_nums<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> sam_nums<span class="token punctuation">,</span> pre_cor_nums
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 原代码每个epoch保存一个模型，调整为只保存best_ckpt.pth和last_epoch_ckpt.pth</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>TRAIN<span class="token punctuation">.</span>START_EPOCH<span class="token punctuation">,</span> config<span class="token punctuation">.</span>TRAIN<span class="token punctuation">.</span>EPOCHS<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data_loader_train<span class="token punctuation">.</span>sampler<span class="token punctuation">.</span>set_epoch<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>

    train_one_epoch<span class="token punctuation">(</span>config<span class="token punctuation">,</span> model<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> data_loader_train<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> mixup_fn<span class="token punctuation">,</span> lr_scheduler<span class="token punctuation">,</span>
                    loss_scaler<span class="token punctuation">)</span>

    acc1<span class="token punctuation">,</span> acc2<span class="token punctuation">,</span> loss <span class="token operator">=</span> validate<span class="token punctuation">(</span>config<span class="token punctuation">,</span> data_loader_val<span class="token punctuation">,</span> model<span class="token punctuation">)</span>

    <span class="token keyword">if</span> dist<span class="token punctuation">.</span>get_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>epoch <span class="token operator">%</span> config<span class="token punctuation">.</span>SAVE_FREQ <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> epoch <span class="token operator">==</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>TRAIN<span class="token punctuation">.</span>EPOCHS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> acc1 <span class="token operator">&gt;</span> max_accuracy<span class="token punctuation">:</span>
            ckpt_name <span class="token operator">=</span> <span class="token string">"best_ckpt"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            ckpt_name <span class="token operator">=</span> <span class="token string">"last_epoch_ckpt"</span>
        save_checkpoint<span class="token punctuation">(</span>config<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> model_without_ddp<span class="token punctuation">,</span> max_accuracy<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> lr_scheduler<span class="token punctuation">,</span> loss_scaler<span class="token punctuation">,</span>
                        logger<span class="token punctuation">,</span> ckpt_name<span class="token punctuation">)</span>
    
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Accuracy of the network on the </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>dataset_val<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> test images: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>acc1<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span>
    max_accuracy <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>max_accuracy<span class="token punctuation">,</span> acc1<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Max accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>max_accuracy<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">%'</span></span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>data/build.py</code></li></ul> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">build_loader</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span>
    config<span class="token punctuation">.</span>defrost<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 原代码为dataset_train, config.MODEL.NUM_CLASSES = </span>
    <span class="token comment"># 我们在config文件中已经指明了数据集类别数</span>
    dataset_train<span class="token punctuation">,</span> _ <span class="token operator">=</span> build_dataset<span class="token punctuation">(</span>is_train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> config<span class="token operator">=</span>config<span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>utils.py</code></li></ul> 
<pre><code class="prism language-python"><span class="token comment"># 修改代码resume时调用的是best_ckpt.pth</span>
<span class="token keyword">def</span> <span class="token function">auto_resume_helper</span><span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> get_best<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    checkpoints <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span>
    checkpoints <span class="token operator">=</span> <span class="token punctuation">[</span>ckpt <span class="token keyword">for</span> ckpt <span class="token keyword">in</span> checkpoints <span class="token keyword">if</span> ckpt<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'pth'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"All checkpoints founded in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>output_dir<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>checkpoints<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token comment">#  原本的代码是采用时间最近的模型，调整为读取best_ckpt.pth</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>checkpoints<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token keyword">not</span> get_best<span class="token punctuation">:</span>
        latest_checkpoint <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> checkpoints<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getmtime<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"The latest checkpoint founded: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>latest_checkpoint<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        resume_file <span class="token operator">=</span> latest_checkpoint
    <span class="token keyword">elif</span> get_best <span class="token keyword">and</span> <span class="token string">"best_ckpt.pth"</span> <span class="token keyword">in</span> checkpoints<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"The best checkpoint founded: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">'best_ckpt.pth'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        resume_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">'best_ckpt.pth'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        resume_file <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> resume_file
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">save_checkpoint</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> model<span class="token punctuation">,</span> max_accuracy<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> lr_scheduler<span class="token punctuation">,</span> loss_scaler<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> ckpt_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    save_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'model'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token string">'optimizer'</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token string">'lr_scheduler'</span><span class="token punctuation">:</span> lr_scheduler<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token string">'max_accuracy'</span><span class="token punctuation">:</span> max_accuracy<span class="token punctuation">,</span>
                  <span class="token string">'scaler'</span><span class="token punctuation">:</span> loss_scaler<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch<span class="token punctuation">,</span>
                  <span class="token string">'config'</span><span class="token punctuation">:</span> config<span class="token punctuation">}</span>

    save_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>OUTPUT<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ckpt_name<span class="token punctuation">}</span></span><span class="token string">.pth'</span></span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_path<span class="token punctuation">}</span></span><span class="token string"> saving......"</span></span><span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>save_state<span class="token punctuation">,</span> save_path<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_path<span class="token punctuation">}</span></span><span class="token string"> saved !!!"</span></span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="22__229"></a>2.2 训练命令</h5> 
<pre><code class="prism language-python">python main<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>cfg configs<span class="token operator">/</span>swinv2<span class="token operator">/</span>swinv2_base_patch4_window12_192_22k<span class="token punctuation">.</span>yaml <span class="token operator">-</span><span class="token operator">-</span>batch<span class="token operator">-</span>size <span class="token number">4</span> <span class="token operator">-</span><span class="token operator">-</span>data<span class="token operator">-</span>path imagenet <span class="token operator">-</span><span class="token operator">-</span>pretrained swinv2_base_patch4_window12_192_22k<span class="token punctuation">.</span>pth <span class="token operator">-</span><span class="token operator">-</span>local_rank <span class="token number">0</span>
</code></pre> 
<h4><a id="3__234"></a>3. 评估</h4> 
<pre><code class="prism language-python">python main<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span><span class="token builtin">eval</span> <span class="token operator">-</span><span class="token operator">-</span>cfg configs<span class="token operator">/</span>swinv2<span class="token operator">/</span>swinv2_base_patch4_window12_192_22k<span class="token punctuation">.</span>yaml <span class="token operator">-</span><span class="token operator">-</span>resume output<span class="token operator">/</span>swinv2_base_patch4_window12_192_22k<span class="token operator">/</span>default<span class="token operator">/</span>best_ckpt<span class="token punctuation">.</span>pth <span class="token operator">-</span><span class="token operator">-</span>data<span class="token operator">-</span>path imagenet <span class="token operator">-</span><span class="token operator">-</span>local_rank <span class="token number">0</span>
</code></pre> 
<p>评估阶段的终端输出：<br> <img src="https://images2.imgbox.com/31/a0/YYKmfKxj_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4__242"></a>4. 推理</h4> 
<h5><a id="41__243"></a>4.1 推理脚本</h5> 
<p>原作者没有提供inference代码，根据evaluate流程写一个简单的推理脚本。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> argparse
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">import</span> cv2

<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms

<span class="token keyword">from</span> config <span class="token keyword">import</span> get_config
<span class="token keyword">from</span> models <span class="token keyword">import</span> build_model
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token keyword">from</span> timm<span class="token punctuation">.</span>data<span class="token punctuation">.</span>constants <span class="token keyword">import</span> IMAGENET_DEFAULT_MEAN<span class="token punctuation">,</span> IMAGENET_DEFAULT_STD

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> InterpolationMode


    <span class="token keyword">def</span> <span class="token function">_pil_interp</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">'bicubic'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> InterpolationMode<span class="token punctuation">.</span>BICUBIC
        <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'lanczos'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> InterpolationMode<span class="token punctuation">.</span>LANCZOS
        <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'hamming'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> InterpolationMode<span class="token punctuation">.</span>HAMMING
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># default bilinear, do we want to allow nearest?</span>
            <span class="token keyword">return</span> InterpolationMode<span class="token punctuation">.</span>BILINEAR


    <span class="token keyword">import</span> timm<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> timm_transforms

    timm_transforms<span class="token punctuation">.</span>_pil_interp <span class="token operator">=</span> _pil_interp
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> timm<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> _pil_interp


<span class="token keyword">def</span> <span class="token function">parse_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token string">'Swin Transformer inference script'</span><span class="token punctuation">,</span> add_help<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cfg'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"FILE"</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'path to config file'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>
        <span class="token string">"--opts"</span><span class="token punctuation">,</span>
        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Modify config options by adding 'KEY VALUE' pairs. "</span><span class="token punctuation">,</span>
        default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># easy config modification</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--batch-size'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"batch size for single GPU"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--data-path'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'path to dataset'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--zip'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'use zipped dataset instead of folder dataset'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cache-mode'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'part'</span><span class="token punctuation">,</span> choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'no'</span><span class="token punctuation">,</span> <span class="token string">'full'</span><span class="token punctuation">,</span> <span class="token string">'part'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'no: no cache, '</span>
                             <span class="token string">'full: cache all data, '</span>
                             <span class="token string">'part: sharding the dataset into nonoverlapping pieces and only cache one piece'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--pretrained'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'pretrained weight from checkpoint, could be imagenet22k pretrained weight'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--resume'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'resume from checkpoint'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--accumulation-steps'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"gradient accumulation steps"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--use-checkpoint'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"whether to use gradient checkpointing to save memory"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--disable_amp'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Disable pytorch amp'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--amp-opt-level'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'O0'</span><span class="token punctuation">,</span> <span class="token string">'O1'</span><span class="token punctuation">,</span> <span class="token string">'O2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'mixed precision opt level, if O0, no amp is used (deprecated!)'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--output'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'output'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'PATH'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'root of output folder, the full path is &lt;output&gt;/&lt;model_name&gt;/&lt;tag&gt; (default: output)'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--tag'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'tag of experiment'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--eval'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Perform evaluation only'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--throughput'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Test throughput only'</span><span class="token punctuation">)</span>

    <span class="token comment"># distributed training</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--local_rank"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'local rank for DistributedDataParallel'</span><span class="token punctuation">)</span>

    <span class="token comment"># for acceleration</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--fused_window_process'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Fused window shift &amp; window partition, similar for reversed part.'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--fused_layernorm'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Use fused layernorm.'</span><span class="token punctuation">)</span>
    <span class="token comment">## overwrite optimizer in config (*.yaml) if specified, e.g., fused_adam/fused_lamb</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--optim'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'overwrite optimizer if provided, can be adamw/sgd/fused_adam/fused_lamb.'</span><span class="token punctuation">)</span>

    args<span class="token punctuation">,</span> unparsed <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_known_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    config <span class="token operator">=</span> get_config<span class="token punctuation">(</span>args<span class="token punctuation">)</span>

    <span class="token keyword">return</span> args<span class="token punctuation">,</span> config

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    args<span class="token punctuation">,</span> config <span class="token operator">=</span> parse_option<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    transform_test <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span>
            <span class="token punctuation">(</span>config<span class="token punctuation">.</span>DATA<span class="token punctuation">.</span>IMG_SIZE<span class="token punctuation">,</span> config<span class="token punctuation">.</span>DATA<span class="token punctuation">.</span>IMG_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> 
            interpolation<span class="token operator">=</span>_pil_interp<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DATA<span class="token punctuation">.</span>INTERPOLATION<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>IMAGENET_DEFAULT_MEAN<span class="token punctuation">,</span> IMAGENET_DEFAULT_STD<span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    classes <span class="token operator">=</span> config<span class="token punctuation">.</span>DATA<span class="token punctuation">.</span>NAME_CLASSES
    DEVICE <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> build_model<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>PRETRAINED<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>
    path <span class="token operator">=</span> config<span class="token punctuation">.</span>DATA<span class="token punctuation">.</span>DATA_PATH
    testList <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> testList<span class="token punctuation">:</span>
        img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> transform_test<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        img<span class="token punctuation">.</span>unsqueeze_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> Variable<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>
        out <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span>pred <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        ori_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        text <span class="token operator">=</span> <span class="token string">'ImageName:{}, predict:{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> classes<span class="token punctuation">[</span>pred<span class="token punctuation">.</span>data<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        font <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX
        txt_size <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>text<span class="token punctuation">,</span> font<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        x0 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ori_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>ori_img<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token punctuation">(</span>x0 <span class="token operator">-</span> <span class="token builtin">int</span><span class="token punctuation">(</span>txt_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> txt_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> font<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ori_img<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="42__371"></a>4.2 推理命令</h5> 
<pre><code class="prism language-shell">python inference.py <span class="token parameter variable">--cfg</span> configs/swinv2/swinv2_base_patch4_window12_192_22k.yaml --data-path images/ <span class="token parameter variable">--pretrained</span> output/swinv2_base_patch4_window12_192_22k/default/best_ckpt.pth <span class="token parameter variable">--local_rank</span> <span class="token number">0</span>
</code></pre> 
<h5><a id="43__376"></a>4.3 推理结果</h5> 
<p><img src="https://images2.imgbox.com/f4/53/iv0KVVcZ_o.png" alt=""></p> 
<h5><a id="44__378"></a>4.4 特征可视化</h5> 
<p>查看我的下一篇文章：<a href="https://blog.csdn.net/weixin_45977690/article/details/126946898?spm=1001.2014.3001.5501">使用grad-cam对swin transformer的特征进行可视化</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/232ee149d5ad04f7423d474a85c04e79/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Electron】富文本编辑器之回车换行</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/409c0aa7996c94cb8380610a9b397e3f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AI大模型专题：原生多模态大模型Gemini</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>