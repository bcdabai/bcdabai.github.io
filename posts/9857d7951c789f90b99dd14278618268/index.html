<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>第09章_性能分析工具的使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="第09章_性能分析工具的使用" />
<meta property="og:description" content="第09章_性能分析工具的使用
文章目录 1. 数据库服务器的优化步骤2. 查看系统性能参数3. 统计SQL的查询成本：last_query_cost4.定位执行慢的 SQL：慢查询日志4.1 开启慢查询日志参数4.2 查看慢查询数目4.3 案例演示4.4 测试及分析4.5 慢查询日志分析工具：mysqldumpslow4.6 关闭慢查询日志4.7 删除慢查询日志 5. 查看 SQL 执行成本：SHOW PROFILE6. 分析查询语句：EXPLAIN6.1 概述6.2 基本语法6.3 数据准备6.4 EXPLAIN各列作用1. table2. id3. select_type4. partitions (可略)5. type ☆阿里巴巴开发手册要求 6. possible_keys和key7. key_len ☆8. ref9. rows ☆10. filtered11. Extra ☆12. 小结 7. EXPLAIN的进一步使用7.1 EXPLAIN四种输出格式1. 传统格式2. JSON格式3. TREE格式4. 可视化输出 7.2 SHOW WARNINGS的使用 8. 分析优化器执行计划：trace9. MySQL监控分析视图-sys schema9.1 Sys schema视图摘要9.2 Sys schema视图使用场景 1. 数据库服务器的优化步骤 当我们遇到数据库调优问题的时候，该如何思考呢？这里把思考的流程整理成下面这张图。
整个流程划分成了观察（Show status）和行动（Action）两个部分。字母 S 的部分代表观察（会使用相应的分析工具），字母 A 代表的部分是行动（对应分析可以采取的行动）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9857d7951c789f90b99dd14278618268/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-30T23:23:48+08:00" />
<meta property="article:modified_time" content="2022-07-30T23:23:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">第09章_性能分析工具的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>第09章_性能分析工具的使用</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#1__6" rel="nofollow">1. 数据库服务器的优化步骤</a></li><li><a href="#2__39" rel="nofollow">2. 查看系统性能参数</a></li><li><a href="#3_SQLlast_query_cost_122" rel="nofollow">3. 统计SQL的查询成本：last_query_cost</a></li><li><a href="#4_SQL_199" rel="nofollow">4.定位执行慢的 SQL：慢查询日志</a></li><li><ul><li><a href="#41__209" rel="nofollow">4.1 开启慢查询日志参数</a></li><li><a href="#42__278" rel="nofollow">4.2 查看慢查询数目</a></li><li><a href="#43__288" rel="nofollow">4.3 案例演示</a></li><li><a href="#44__390" rel="nofollow">4.4 测试及分析</a></li><li><a href="#45_mysqldumpslow_448" rel="nofollow">4.5 慢查询日志分析工具：mysqldumpslow</a></li><li><a href="#46__524" rel="nofollow">4.6 关闭慢查询日志</a></li><li><a href="#47__573" rel="nofollow">4.7 删除慢查询日志</a></li></ul> 
   </li><li><a href="#5__SQL_SHOW_PROFILE_601" rel="nofollow">5. 查看 SQL 执行成本：SHOW PROFILE</a></li><li><a href="#6_EXPLAIN_746" rel="nofollow">6. 分析查询语句：EXPLAIN</a></li><li><ul><li><a href="#61__748" rel="nofollow">6.1 概述</a></li><li><a href="#62__783" rel="nofollow">6.2 基本语法</a></li><li><a href="#63__823" rel="nofollow">6.3 数据准备</a></li><li><a href="#64_EXPLAIN_979" rel="nofollow">6.4 EXPLAIN各列作用</a></li><li><ul><li><a href="#1_table_983" rel="nofollow">1. table</a></li><li><a href="#2_id_1008" rel="nofollow">2. id</a></li><li><a href="#3_select_type_1079" rel="nofollow">3. select_type</a></li><li><a href="#4_partitions__1238" rel="nofollow">4. partitions (可略)</a></li><li><a href="#5_type__1269" rel="nofollow">5. type ☆</a></li><li><ul><li><a href="#_1482" rel="nofollow">阿里巴巴开发手册要求</a></li></ul> 
     </li><li><a href="#6_possible_keyskey_1498" rel="nofollow">6. possible_keys和key</a></li><li><a href="#7_key_len__1527" rel="nofollow">7. key_len ☆</a></li><li><a href="#8_ref_1617" rel="nofollow">8. ref</a></li><li><a href="#9_rows__1665" rel="nofollow">9. rows ☆</a></li><li><a href="#10_filtered_1680" rel="nofollow">10. filtered</a></li><li><a href="#11_Extra__1709" rel="nofollow">11. Extra ☆</a></li><li><a href="#12__1949" rel="nofollow">12. 小结</a></li></ul> 
   </li></ul> 
   </li><li><a href="#7_EXPLAIN_1958" rel="nofollow">7. EXPLAIN的进一步使用</a></li><li><ul><li><a href="#71_EXPLAIN_1960" rel="nofollow">7.1 EXPLAIN四种输出格式</a></li><li><ul><li><a href="#1__1964" rel="nofollow">1. 传统格式</a></li><li><a href="#2_JSON_1982" rel="nofollow">2. JSON格式</a></li><li><a href="#3_TREE_2137" rel="nofollow">3. TREE格式</a></li><li><a href="#4__2152" rel="nofollow">4. 可视化输出</a></li></ul> 
    </li><li><a href="#72_SHOW_WARNINGS_2167" rel="nofollow">7.2 SHOW WARNINGS的使用</a></li></ul> 
   </li><li><a href="#8_trace_2192" rel="nofollow">8. 分析优化器执行计划：trace</a></li><li><a href="#9_MySQLsys_schema_2446" rel="nofollow">9. MySQL监控分析视图-sys schema</a></li><li><ul><li><a href="#91_Sys_schema_2449" rel="nofollow">9.1 Sys schema视图摘要</a></li><li><a href="#92_Sys_schema_2471" rel="nofollow">9.2 Sys schema视图使用场景</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1__6"></a>1. 数据库服务器的优化步骤</h3> 
<p>当我们遇到数据库调优问题的时候，该如何思考呢？这里把思考的流程整理成下面这张图。</p> 
<p>整个流程划分成了<code>观察（Show status）</code>和<code>行动（Action）</code>两个部分。字母 S 的部分代表观察（会使用相应的分析工具），字母 A 代表的部分是行动（对应分析可以采取的行动）。</p> 
<p><img src="https://images2.imgbox.com/c4/02/9h9ixBXt_o.png" alt=""></p> 
<p>我们可以通过观察了解数据库整体的运行状态，通过性能分析工具可以让我们了解执行慢的SQL都有哪些，查看具体的SQL执行计划，甚至是SQL执行中的每一步的成本代价，这样才能定位问题所在，找到了问题，再采取相应的行动。</p> 
<p><strong>详细解释一下这张图:</strong></p> 
<p>首先在S1部分，我们需要观察服务器的状态是否存在周期性的波动。如果<code>存在周期性波动</code>，有可能是周期性节点的原因，比如双十一、促销活动等。这样的话，我们可以通过A1这一步骤解决，也就是加缓存，或者更改缓存失效策略。</p> 
<p>如果缓存策略没有解决，或者不是周期性波动的原因，我们就需要进一步<code>分析查询延迟和卡顿的原因</code>。接下来进入<br> S2这一-步，我们需要<code>开启慢查询</code>。慢查询可以帮我们定位执行慢的SQL语句。我们可以通过设置<code>long_query_time</code>参数定义“慢”的阈值，如果SQL执行时间超过了<code>long_query_time</code>，则会认为是慢查询。当收集上来这些慢查询之后，我们就可以通过分析工具对慢查询日志进行分析。</p> 
<p>在S3这一步骤中，我们就知道了执行慢的SQL，这样就可以针对性地用<code>EXPLAIN</code>查看对应SQL语句的执行计划，或者使用<code>show profile</code>查看SQL中每一个步骤的时间成本。这样我们就可以了解SQL查询慢是因为执行时间长，还是等待时间长。</p> 
<p>​ 如果是SQL等待时间长，我们进入A2步骤。在这一步骤中，我们可以<code>调优服务器的参数</code>，比如适当增加数据库缓冲池等。如果是SQL执行时间长，就进入A3步骤，这一步中我们需要考虑是索引设计的问题?还是查询关联的数据表过多?还是因为数据表的字段设计问题导致了这一现象。然后在这些维度上进行对应的调整。</p> 
<p>如果A2和A3都不能解决问题，我们需要考虑数据库自身的SQL查询性能是否已经达到了瓶颈，如果确认没有达到性能瓶颈，就需要重新检查，重复以上的步骤。如果已经达到了<code>性能瓶颈</code>，进入A4阶段，需要考虑<code>增加服务器</code>，采用读写分离的架构，或者考虑对数据库进行<code>分库分表</code>，比如垂直分库、垂直分表和水平分表等。</p> 
<p>以上就是数据库调优的流程思路。如果我们发现执行SQL时存在不规则延迟或卡顿的时候，就可以采用分析工具帮我们定位有问题的SQL，这三种分析工具你可以理解是SQL调优的三个步骤:<code>慢查询、</code> <code>EXPLAIN</code>和 <code>SHOWPROFILING</code>。</p> 
<p><strong>小结：</strong></p> 
<p><img src="https://images2.imgbox.com/2b/f3/Amfp4Dk2_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2__39"></a>2. 查看系统性能参数</h3> 
<p>在MySQL中，可以使用<code>SHOW STATUS</code>语句查询一些MySQL数据库服务器的<code>性能参数</code>、<code>执行频率</code>。</p> 
<p>SHOW STATUS语句语法如下：</p> 
<pre><code class="prism language-sql">
<span class="token keyword">SHOW</span> <span class="token punctuation">[</span><span class="token keyword">GLOBAL</span><span class="token operator">|</span><span class="token keyword">SESSION</span><span class="token punctuation">]</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span><span class="token string">'参数'</span><span class="token punctuation">;</span>
</code></pre> 
<p>一些常用的性能参数如下：</p> 
<ul><li> <p>Connections：连接MySQL服务器的次数。</p> </li><li> <p>Uptime：MySQL服务器的上线时间。</p> </li><li> <p>Slow_queries：慢查询的次数。</p> 
  <ul><li>默认十秒以上</li></ul> </li><li> <p>Innodb_rows_read：Select查询返回的行数</p> </li><li> <p>Innodb_rows_inserted：执行INSERT操作插入的行数</p> </li><li> <p>Innodb_rows_updated：执行UPDATE操作更新的行数</p> </li><li> <p>Innodb_rows_deleted：执行DELETE操作删除的行数</p> </li><li> <p>Com_select：查询操作的次数。</p> </li><li> <p>Com_insert：插入操作的次数。对于批量插入的 INSERT 操作，只累加一次。</p> </li><li> <p>Com_update：更新操作的次数。</p> </li><li> <p>Com_delete：删除操作的次数。</p> </li></ul> 
<p>例如：</p> 
<p>若查询MySQL服务器的连接次数，则可以执行如下语句：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Connections'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Connections   <span class="token operator">|</span> <span class="token number">8</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.38</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>若查询服务器工作时间,则可以执行如下语句：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Uptime'</span><span class="token punctuation">;</span> <span class="token comment">#秒</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Uptime        <span class="token operator">|</span> <span class="token number">838</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token comment"># 慢查询次数</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'Slow_queries'</span><span class="token punctuation">;</span> 
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Slow_queries  <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>慢查询次数参数可以结合慢查询日志找出慢查询语句，然后针对慢查询语句进行<code>表结构优化</code>或者<code>查询语句优化</code>。再比如，如下的指令可以查看相关的指令情况:</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'Innodb_rows_%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------------+-------+</span>
<span class="token operator">|</span> Variable_name        <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------+-------+</span>
<span class="token operator">|</span> Innodb_rows_deleted  <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_rows_inserted <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_rows_read     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_rows_updated  <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------+-------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token comment">#Innodb_rows_read 查询数据的条数</span>
</code></pre> 
<h3><a id="3_SQLlast_query_cost_122"></a>3. 统计SQL的查询成本：last_query_cost</h3> 
<p>一条SQL查询语句在执行前需要确定查询执行计划，如果存在多种执行计划的话，MySQL会计算每个执行计划所需要的成本，从中选择<code>成本最小</code>的一个作为最终执行的执行计划。</p> 
<p>如果我们想要查看某条SQL语句的查询成本，可以在执行完这条SQL语句之后，通过查看当前会话中的<code>last_query_cost</code>变量值来得到当前查询的成本。它通常也是我们<code>评价一个查询的执行效率</code>的一个常用指标。这个查询成本对应的是<code>SQL语句所需要读取的页的数量</code>。</p> 
<p>我们依然使用第8章的 student_info 表为例：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>student_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
	<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>student_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>course_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>class_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">DATETIME</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> 
<p>如果我们想要查询 id=900001 的记录，然后看下查询成本，我们可以直接在聚簇索引上进行查找：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> student_id<span class="token punctuation">,</span> class_id<span class="token punctuation">,</span> NAME<span class="token punctuation">,</span> create_time <span class="token keyword">FROM</span> student_info <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">900001</span> <span class="token punctuation">;</span>
</code></pre> 
<p>运行结果（1条记录，运行时间为 <code>0.042s</code>）</p> 
<p>然后再看下查询优化器的成本，实际上我们只需要检索一个页即可：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'last_query_cost'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+----------+</span>
<span class="token operator">|</span> Variable_name   <span class="token operator">|</span> <span class="token keyword">Value</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+----------+</span>
<span class="token operator">|</span> Last_query_cost <span class="token operator">|</span> <span class="token number">1.000000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
<span class="token comment"># 当前查找的数据用到了一个数据页</span>
</code></pre> 
<p>如果我们想要查询 id 在 900001 到 9000100 之间的学生记录呢？</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> student_id<span class="token punctuation">,</span> class_id<span class="token punctuation">,</span> NAME<span class="token punctuation">,</span> create_time <span class="token keyword">FROM</span> student_info
<span class="token keyword">WHERE</span> id <span class="token operator">BETWEEN</span> <span class="token number">900001</span> <span class="token operator">AND</span> <span class="token number">900100</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行结果（100 条记录，运行时间为 <code>0.046s</code> ）</p> 
<p>然后再看下查询优化器的成本，这时我们大概需要进行 20 个页的查询。</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'last_query_cost'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------+</span>
<span class="token operator">|</span> Variable_name   <span class="token operator">|</span>   <span class="token keyword">Value</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------+</span>
<span class="token operator">|</span> Last_query_cost <span class="token operator">|</span> <span class="token number">21.134453</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------+</span>
</code></pre> 
<p>你能看到页的数量是刚才的 20 倍，但是查询的效率并没有明显的变化，实际上这两个 SQL 查询的时间基本上一样，就是因为采用了顺序读取的方式将页面一次性加载到缓冲池中，然后再进行查找。虽然<code>页数量（last_query_cost）增加了不少</code>，但是通过缓冲池的机制，<code>并没有增加多少查询时间</code>。</p> 
<p><strong>使用场景：</strong> 它对于比较开销是非常有用的，特别是我们有好几种查询方式可选的时候。</p> 
<blockquote> 
 <p>SQL查询是一个动态的过程，从页加载的角度来看，我们可以得到以下两点结论:</p> 
 <ol><li> <p><code>位置决定效率</code>。如果页就在数据库<code>缓冲池</code>中，那么效率是最高的，否则还需要从<code>磁盘</code>中进行<br> 读取，当然针对单个页的读取来说，如果页存在于内存中，会比在磁盘中读取效率高很多。</p> </li><li> <p><code>批量决定效率</code>。如果我们从磁盘中对单一页进行随机读，那么效率是很低的(差不多10ms)，而采用顺序读取的方式，批量对页进行读取，平均一页的读取效率就会提升很多，甚至要快于单个页面在内存中的随机读取。<br></p> </li></ol> 
 <p><br>所以说，遇到/O并不用担心，方法找对了，效率还是很高的。我们首先要考虑数据存放的位置，如果是经常使用的数据就要尽量放到<code>缓冲池</code>中，其次我们可以充分利用磁盘的吞吐能力，一次性批量读取数据，这样单个页的读取效率也就得到了提升。</p> 
</blockquote> 
<h3><a id="4_SQL_199"></a>4.定位执行慢的 SQL：慢查询日志</h3> 
<p>MySQL的慢查询日志，用来记录在MySQL中<code>响应时间超过阀值</code>的语句，具体指运行时间超过<code>long_query_time</code>值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为<code>10</code>，意思是运行10秒以上(不含10秒)的语句，认为是超出了我们的最大忍耐时间值。</p> 
<p>它的主要作用是，帮助我们发现那些执行时间特别长的SQL查询，并且有针对性地进行优化，从而提高系统的整体效率。当我们的数据库服务器发生阻塞、运行变慢的时候，检查一下慢查询日志，找到那些慢查询，对解决问题很有帮助。比如一条sq|执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合explain进行全面分析。</p> 
<p>默认情况下，MySQL数据库<code>没有开启慢查询日志</code>，需要我们手动来设置这个参数。<strong>如果不是调优需要的话，一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响</p> 
<p>慢查询日志支持将日志记录写入文件。</p> 
<h4><a id="41__209"></a>4.1 开启慢查询日志参数</h4> 
<p><strong>1.开启slow_query_log</strong></p> 
<pre><code class="prism language-sql">mysql <span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%slow_query_log%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-----------------------------------+</span>
<span class="token operator">|</span> Variable_name       <span class="token operator">|</span> <span class="token keyword">Value</span>                             <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-----------------------------------+</span>
<span class="token operator">|</span> slow_query_log      <span class="token operator">|</span> <span class="token keyword">OFF</span>                               <span class="token operator">|</span>
<span class="token operator">|</span> slow_query_log_file <span class="token operator">|</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>localhost<span class="token operator">-</span>slow<span class="token punctuation">.</span>log <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-----------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.27</span> sec<span class="token punctuation">)</span>


mysql <span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log<span class="token operator">=</span><span class="token string">'ON'</span><span class="token punctuation">;</span> <span class="token comment">#开启慢查询</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.12</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>然后我们再来查看下慢查询日志是否开启，以及慢查询日志文件的位置：</p> 
<p><img src="https://images2.imgbox.com/bc/1c/zKNpR4Bu_o.png" alt=""></p> 
<p>你能看到这时慢查询分析已经开启，同时文件保存在 <code>/var/lib/mysql/atguigu02-slow.log</code> 文件中。</p> 
<p><strong>2. 修改long_query_time阈值</strong></p> 
<p>接下来我们来看下慢查询的时间阈值设置，使用如下命令：</p> 
<pre><code class="prism language-sql">mysql <span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%long_query_time%'</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/12/15/TJTjsAQv_o.png" alt=""></p> 
<pre><code class="prism language-sql"><span class="token comment"># 测试发现：设置global的方式对当前session的long_query_time失效。对新连接的客户端有效。所以可以一并执行下述语句</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> long_query_time <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'%long-query_time%'</span><span class="token punctuation">;</span>

<span class="token comment"># 即更改global 也更改了session变量</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> long_query_time<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%long_query_time%'</span><span class="token punctuation">;</span>  
</code></pre> 
<p><img src="https://images2.imgbox.com/fd/7d/wYbFcEk1_o.png" alt=""></p> 
<p><strong>补充:配置文件中一并设置参数</strong></p> 
<p>如下的方式相较于前面的命令行方式，可以看作是永久设置的方式。</p> 
<p>修改<code>my.cnf</code> 文件，<code>[mysqld]下</code>增加或修改参数<code>long_query_time</code>、<code>slow_query_log</code>和<code>slow_query_log_file</code>后，然后重启MySQL服务器。|</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[mysqld]</span>
slow_query_log=ON <span class="token comment">#开启慢查询日志的开关</span>
slow_query_log_file=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/mysql/my-slow<span class="token punctuation">.</span>log <span class="token comment">#慢查询日志的目录和文件名信息</span>
long_query_time=3 <span class="token comment">#设置慢查询的阈值为3秒，超出此设定值的SQL即被记录到慢查询日志</span>
log_output=FILE
</code></pre> 
<p>如果不指定存储路径，慢查询日志将默认存储到MySQL数据库的数据文件夹下。如果不指定文件名，默认文件名为hostname-slow.log。</p> 
<h4><a id="42__278"></a>4.2 查看慢查询数目</h4> 
<p>查询当前系统中有多少条慢查询记录</p> 
<pre><code class="prism language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'%Slow_queries%'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="43__288"></a>4.3 案例演示</h4> 
<p><strong>步骤1. 建表</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>student<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
	<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>stuno<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>classId<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> 
<p><strong>步骤2：设置参数 log_bin_trust_function_creators</strong></p> 
<p>创建函数，假如报错：</p> 
<pre><code class="prism language-sql">This <span class="token keyword">function</span> has none <span class="token keyword">of</span> <span class="token keyword">DETERMINISTIC</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>命令开启：允许创建函数设置：</p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> <span class="token keyword">global</span> log_bin_trust_function_creators<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment"># 不加global只是当前窗口有效。</span>
</code></pre> 
<p><strong>步骤3：创建函数</strong></p> 
<p>随机产生字符串：（同上一章）</p> 
<pre><code class="prism language-sql"><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_string<span class="token punctuation">(</span>n <span class="token keyword">INT</span><span class="token punctuation">)</span>
	<span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token comment">#该函数会返回一个字符串</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> chars_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span>
    <span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> return_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">WHILE</span> i <span class="token operator">&lt;</span> n <span class="token keyword">DO</span>
        <span class="token keyword">SET</span> return_str <span class="token operator">=</span>CONCAT<span class="token punctuation">(</span>return_str<span class="token punctuation">,</span>SUBSTRING<span class="token punctuation">(</span>chars_str<span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
	<span class="token keyword">RETURN</span> return_str<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

</code></pre> 
<p>产生随机数值：（同上一章）</p> 
<pre><code class="prism language-sql"><span class="token comment">#测试</span>
<span class="token keyword">SELECT</span> rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_num <span class="token punctuation">(</span>from_num <span class="token keyword">INT</span> <span class="token punctuation">,</span>to_num <span class="token keyword">INT</span><span class="token punctuation">)</span> 
<span class="token keyword">RETURNS</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">SET</span> i <span class="token operator">=</span> FLOOR<span class="token punctuation">(</span>from_num <span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>to_num <span class="token operator">-</span> from_num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
	<span class="token keyword">RETURN</span> i<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">#测试：</span>
<span class="token keyword">SELECT</span> rand_num<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>步骤4：创建存储过程</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_stu1<span class="token punctuation">(</span> <span class="token keyword">START</span> <span class="token keyword">INT</span> <span class="token punctuation">,</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">#设置手动提交事务</span>
    <span class="token keyword">REPEAT</span> <span class="token comment">#循环</span>
    <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">#赋值</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student <span class="token punctuation">(</span>stuno<span class="token punctuation">,</span> NAME <span class="token punctuation">,</span>age <span class="token punctuation">,</span>classId <span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">START</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UNTIL i <span class="token operator">=</span> max_num
    <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span> <span class="token comment">#提交事务</span>
<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre> 
<p><strong>步骤5：调用存储过程</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">#调用刚刚写好的函数, 4000000条记录,从100001号开始</span>

<span class="token keyword">CALL</span> insert_stu1<span class="token punctuation">(</span><span class="token number">100001</span><span class="token punctuation">,</span><span class="token number">4000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="44__390"></a>4.4 测试及分析</h4> 
<p><strong>1.测试</strong></p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> stuno <span class="token operator">=</span> <span class="token number">3455655</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token operator">|</span>    id   <span class="token operator">|</span>  stuno  <span class="token operator">|</span>  name  <span class="token operator">|</span>  age <span class="token operator">|</span> classId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token operator">|</span> <span class="token number">3523633</span> <span class="token operator">|</span> <span class="token number">3455655</span> <span class="token operator">|</span> oQmLUr <span class="token operator">|</span>  <span class="token number">19</span>  <span class="token operator">|</span>    <span class="token number">39</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">2.09</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'oQmLUr'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token operator">|</span>    id   <span class="token operator">|</span>  stuno  <span class="token operator">|</span>  name  <span class="token operator">|</span>  age <span class="token operator">|</span> classId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token operator">|</span> <span class="token number">1154002</span> <span class="token operator">|</span> <span class="token number">1243200</span> <span class="token operator">|</span> OQMlUR <span class="token operator">|</span>  <span class="token number">266</span> <span class="token operator">|</span>   <span class="token number">28</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1405708</span> <span class="token operator">|</span> <span class="token number">1437740</span> <span class="token operator">|</span> OQMlUR <span class="token operator">|</span>  <span class="token number">245</span> <span class="token operator">|</span>   <span class="token number">439</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1748070</span> <span class="token operator">|</span> <span class="token number">1680092</span> <span class="token operator">|</span> OQMlUR <span class="token operator">|</span>  <span class="token number">240</span> <span class="token operator">|</span>   <span class="token number">414</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2119892</span> <span class="token operator">|</span> <span class="token number">2051914</span> <span class="token operator">|</span> oQmLUr <span class="token operator">|</span>  <span class="token number">17</span>  <span class="token operator">|</span>   <span class="token number">32</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2893154</span> <span class="token operator">|</span> <span class="token number">2825176</span> <span class="token operator">|</span> OQMlUR <span class="token operator">|</span>  <span class="token number">245</span> <span class="token operator">|</span>   <span class="token number">435</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3523633</span> <span class="token operator">|</span> <span class="token number">3455655</span> <span class="token operator">|</span> oQmLUr <span class="token operator">|</span>  <span class="token number">19</span>  <span class="token operator">|</span>   <span class="token number">39</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token number">6</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">2.39</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>从上面的结果可以看出来，查询学生编号为“3455655”的学生信息花费时间为2.09秒。查询学生姓名为“oQmLUr”的学生信息花费时间为2.39秒。已经达到了秒的数量级，说明目前查询效率是比较低的，下面<br> 的小节我们分析一下原因 。</p> 
<p><strong>2.分析</strong></p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'slow_queries'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Slow_queries  <span class="token operator">|</span> <span class="token number">3</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p><strong>补充说明:</strong></p> 
 <p>除了上述变量，控制慢查询日志的还有一个系统变量: min_examined_row_limit。这个变量的意思是，查询<code>扫描过的最少记录数</code>。这个变量和查询执行时间，共同组成了判别一个查询是否是慢查询的条件。如果查询扫描过的记录数大于等于这个变量的值，并且查询执行时间超过long_query_time的值，那么，这个查询就被记录到慢查询日志中; 反之，则不被记录到慢查询日志中。</p> 
 <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'min%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> Variable_name          <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> min_examined_row_limit <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
 <p>你也可以根据需要，通过修改“my.ini"文件，来修改"min_examined_row_limit”的值。</p> 
</blockquote> 
<h4><a id="45_mysqldumpslow_448"></a>4.5 慢查询日志分析工具：mysqldumpslow</h4> 
<p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具<code>mysqldumpslow</code> 。</p> 
<p>查看mysqldumpslow的帮助信息</p> 
<pre><code class="prism language-shell">mysqldumpslow --help
</code></pre> 
<p>mysqldumpslow 命令的具体参数如下：</p> 
<ul><li>-a: 不将数字抽象成N，字符串抽象成S</li><li><strong>-s: 是表示按照何种方式排序：</strong> 
  <ul><li>c: 访问次数</li><li>l: 锁定时间</li><li>r: 返回记录</li><li><strong>t: 查询时间</strong></li><li>al:平均锁定时间</li><li>ar:平均返回记录数</li><li>at:平均查询时间 （默认方式）</li><li>ac:平均查询次数</li></ul> </li><li><strong>-t: 即为返回前面多少条的数据；</strong></li><li><strong>-g: 后边搭配一个正则匹配模式，大小写不敏感的</strong></li></ul> 
<p>举例：我们想要按照查询时间排序，查看前五条 SQL 语句，这样写即可：</p> 
<pre><code class="prism language-sql">mysqldumpslow <span class="token operator">-</span>s t <span class="token operator">-</span>t <span class="token number">5</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>localhost<span class="token operator">-</span>slow<span class="token punctuation">.</span>log
</code></pre> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>root<span class="token variable">@localhost</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysqldumpslow -a -s t -t 5 /var/lib/mysql/localhost-slow.log</span>

Reading mysql slow query log <span class="token keyword">from</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>localhost<span class="token operator">-</span>slow<span class="token punctuation">.</span>log
Count: <span class="token number">1</span>  <span class="token keyword">Time</span><span class="token operator">=</span><span class="token number">1565.21</span>s <span class="token punctuation">(</span><span class="token number">1565</span>s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0.00</span>s <span class="token punctuation">(</span><span class="token number">0</span>s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@<span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.88</span><span class="token number">.1</span><span class="token punctuation">]</span>
  <span class="token keyword">CALL</span> insert_stu1<span class="token punctuation">(</span><span class="token number">100001</span><span class="token punctuation">,</span><span class="token number">4000000</span><span class="token punctuation">)</span>

Count: <span class="token number">1</span>  <span class="token keyword">Time</span><span class="token operator">=</span><span class="token number">6.00</span>s <span class="token punctuation">(</span><span class="token number">6</span>s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0.00</span>s <span class="token punctuation">(</span><span class="token number">0</span>s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">1.0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@<span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.88</span><span class="token number">.1</span><span class="token punctuation">]</span>
  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> stuno <span class="token operator">=</span> <span class="token number">3455655</span>

Count: <span class="token number">1</span>  <span class="token keyword">Time</span><span class="token operator">=</span><span class="token number">3.80</span>s <span class="token punctuation">(</span><span class="token number">3</span>s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0.00</span>s <span class="token punctuation">(</span><span class="token number">0</span>s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">7.0</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@<span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.88</span><span class="token number">.1</span><span class="token punctuation">]</span>
  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'oQmLUr'</span>

Count: <span class="token number">1</span>  <span class="token keyword">Time</span><span class="token operator">=</span><span class="token number">3.62</span>s <span class="token punctuation">(</span><span class="token number">3</span>s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0.00</span>s <span class="token punctuation">(</span><span class="token number">0</span>s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@<span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.88</span><span class="token number">.1</span><span class="token punctuation">]</span>
  <span class="token keyword">SET</span> PROFILING <span class="token operator">=</span> <span class="token number">1</span>

Count: <span class="token number">1</span>  <span class="token keyword">Time</span><span class="token operator">=</span><span class="token number">2.44</span>s <span class="token punctuation">(</span><span class="token number">2</span>s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0.00</span>s <span class="token punctuation">(</span><span class="token number">0</span>s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">1.0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@<span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.88</span><span class="token number">.1</span><span class="token punctuation">]</span>
  <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> student

</code></pre> 
<p><strong>工作常用参考：</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">#得到返回记录集最多的10个SQL</span>
mysqldumpslow <span class="token operator">-</span>s r <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>atguigu<span class="token operator">-</span>slow<span class="token punctuation">.</span>log

<span class="token comment">#得到访问次数最多的10个SQL</span>
mysqldumpslow <span class="token operator">-</span>s c <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>atguigu<span class="token operator">-</span>slow<span class="token punctuation">.</span>log

<span class="token comment">#得到按照时间排序的前10条里面含有左连接的查询语句</span>
mysqldumpslow <span class="token operator">-</span>s t <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">-</span>g <span class="token string">"left join"</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>atguigu<span class="token operator">-</span>slow<span class="token punctuation">.</span>log

<span class="token comment">#另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现爆屏情况</span>
mysqldumpslow <span class="token operator">-</span>s r <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>atguigu<span class="token operator">-</span>slow<span class="token punctuation">.</span>log <span class="token operator">|</span> more
</code></pre> 
<h4><a id="46__524"></a>4.6 关闭慢查询日志</h4> 
<p><strong>除了调优需要开，正常还是不要开了</strong></p> 
<p>MySQL服务器停止慢查询日志功能有两种方法：</p> 
<p><strong>方式1：永久性方式</strong></p> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
slow_query_log<span class="token operator">=</span><span class="token keyword">OFF</span>
</code></pre> 
<p>或者，把slow_query_log一项注释掉 或 删除</p> 
<pre><code class="prism language-sql">mysqld<span class="token punctuation">]</span>
<span class="token comment">#slow_query_log =OFF</span>
</code></pre> 
<p>重启MySQL服务，执行如下语句查询慢日志功能。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%slow%'</span><span class="token punctuation">;</span> <span class="token comment">#查询慢查询日志所在目录</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%long_query_time%'</span><span class="token punctuation">;</span> <span class="token comment">#查询超时时长</span>
</code></pre> 
<p><strong>方式2：临时性方式</strong></p> 
<p>使用SET语句来设置。 （1）停止MySQL慢查询日志功能，具体SQL语句如下。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> slow_query_log<span class="token operator">=</span><span class="token keyword">off</span><span class="token punctuation">;</span>
</code></pre> 
<p>（2）<strong>重启MySQL服务</strong>，使用SHOW语句查询慢查询日志功能信息，具体SQL语句如下</p> 
<pre><code class="prism language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%slow%'</span><span class="token punctuation">;</span>
<span class="token comment">#以及</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%long_query_time%'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="47__573"></a>4.7 删除慢查询日志</h4> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%slow_query_log%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+----------------------------+</span>
<span class="token operator">|</span> Variable_name       <span class="token operator">|</span> <span class="token keyword">Value</span>                      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+----------------------------+</span>
<span class="token operator">|</span> slow_query_log      <span class="token operator">|</span> <span class="token keyword">ON</span>                         <span class="token operator">|</span>
<span class="token operator">|</span> slow_query_log_file <span class="token operator">|</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>my<span class="token operator">-</span>slow<span class="token punctuation">.</span>log <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+----------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.07</span> se
</code></pre> 
<p>从执行结果可以看出，慢查询日志的目录默认为MySQL的数据目录，在该目录下<code>手动删除慢查询日志文件</code>即可。使用命令<code>mysqladmin flush-logs</code> 来重新生成查询日志文件，具体命令如下，执行完毕会在数据目录下重新生成慢查询日志文件。</p> 
<pre><code class="prism language-sql"><span class="token comment"># 不使用这个命令，没办法自己创建</span>
mysqladmin <span class="token operator">-</span>uroot <span class="token operator">-</span>p flush<span class="token operator">-</span>logs slow 

<span class="token comment">## 这个命令可以重置其他日志 例如undo日志</span>
</code></pre> 
<blockquote> 
 <p>提示</p> 
 <p>慢查询日志都是使用mysqladmin flush-logs命令来删除重建的。使用时-定要注意，一旦执行了这个命令，慢查询日志都只存在新的日志文件中，如果需要旧的查询日志，就必须事先备份。</p> 
</blockquote> 
<h3><a id="5__SQL_SHOW_PROFILE_601"></a>5. 查看 SQL 执行成本：SHOW PROFILE</h3> 
<p>show profile在《逻辑架构》章节中讲过，这里作为复习。</p> 
<p>Show Profile是MySQL提供的可以用来分析当前会话中SQL都做了什么、执行的资源消耗情况的工具，可用于sql调优的测量。<code>默认情况下处于关闭状态</code>，并保存最近15次的运行结果。</p> 
<p>我们可以在会话级别开启这个功能</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'profiling'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> profiling     <span class="token operator">|</span> <span class="token keyword">OFF</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.34</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>通过设置 <code>profiling='ON’</code> 来开启 show profile：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> profiling <span class="token operator">=</span> <span class="token string">'ON'</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.06</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'profiling'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> profiling     <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.13</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>然后执行相关的查询语句。接着看下当前会话都有哪些 profiles，使用下面这条命令：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> profiles<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------------+</span>
<span class="token operator">|</span> Query_ID <span class="token operator">|</span> Duration   <span class="token operator">|</span> Query                               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------------+</span>
<span class="token operator">|</span>        <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">0.13515975</span> <span class="token operator">|</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'profiling'</span>     <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">0.06386950</span> <span class="token operator">|</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student_info <span class="token keyword">limit</span> <span class="token number">10</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

</code></pre> 
<p>你能看到当前会话一共有 2 个查询。如果我们想要查看最近一次查询的开销，可以使用：</p> 
<pre><code class="prism language-sql">
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> profile<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">Status</span>                         <span class="token operator">|</span> Duration <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">starting</span>                       <span class="token operator">|</span> <span class="token number">0.029330</span> <span class="token operator">|</span>
<span class="token operator">|</span> Executing hook <span class="token keyword">on</span> <span class="token keyword">transaction</span>  <span class="token operator">|</span> <span class="token number">0.001174</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">starting</span>                       <span class="token operator">|</span> <span class="token number">0.002804</span> <span class="token operator">|</span>
<span class="token operator">|</span> checking permissions           <span class="token operator">|</span> <span class="token number">0.002918</span> <span class="token operator">|</span>
<span class="token operator">|</span> Opening <span class="token keyword">tables</span>                 <span class="token operator">|</span> <span class="token number">0.009026</span> <span class="token operator">|</span>
<span class="token operator">|</span> init                           <span class="token operator">|</span> <span class="token number">0.001605</span> <span class="token operator">|</span>
<span class="token operator">|</span> System <span class="token keyword">lock</span>                    <span class="token operator">|</span> <span class="token number">0.000503</span> <span class="token operator">|</span>
<span class="token operator">|</span> optimizing                     <span class="token operator">|</span> <span class="token number">0.000013</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">statistics</span>                     <span class="token operator">|</span> <span class="token number">0.007651</span> <span class="token operator">|</span>
<span class="token operator">|</span> preparing                      <span class="token operator">|</span> <span class="token number">0.000084</span> <span class="token operator">|</span>
<span class="token operator">|</span> executing                      <span class="token operator">|</span> <span class="token number">0.005307</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">end</span>                            <span class="token operator">|</span> <span class="token number">0.000017</span> <span class="token operator">|</span>
<span class="token operator">|</span> query <span class="token keyword">end</span>                      <span class="token operator">|</span> <span class="token number">0.000178</span> <span class="token operator">|</span>
<span class="token operator">|</span> waiting <span class="token keyword">for</span> <span class="token keyword">handler</span> <span class="token keyword">commit</span>     <span class="token operator">|</span> <span class="token number">0.000028</span> <span class="token operator">|</span>
<span class="token operator">|</span> closing <span class="token keyword">tables</span>                 <span class="token operator">|</span> <span class="token number">0.001087</span> <span class="token operator">|</span>
<span class="token operator">|</span> freeing items                  <span class="token operator">|</span> <span class="token number">0.000399</span> <span class="token operator">|</span>
<span class="token operator">|</span> cleaning up                    <span class="token operator">|</span> <span class="token number">0.001748</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------+----------+</span>
<span class="token number">17</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.04</span> sec<span class="token punctuation">)</span>

</code></pre> 
<p>我们也可以查看指定的Query lD的开销，比如<code>show profile for query 2</code>查询结果是一样的。在SHOWPROFILE中我们可以查看不同部分的开销，比如cpu、block.io等:</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> profile cpu<span class="token punctuation">,</span>block io <span class="token keyword">for</span> query <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------------+--------+----------+------------+-------------+</span>
<span class="token operator">|</span> <span class="token keyword">Status</span>                       <span class="token operator">|</span>Duration<span class="token operator">|</span> CPU_user <span class="token operator">|</span>Block_ops_in<span class="token operator">|</span>Block_ops_out<span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------------+--------+----------+------------+-------------+</span>
<span class="token operator">|</span> <span class="token keyword">starting</span>                     <span class="token operator">|</span><span class="token number">0.029330</span><span class="token operator">|</span> <span class="token number">0.017180</span> <span class="token operator">|</span>       <span class="token number">49712</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> Executing hook <span class="token keyword">on</span> <span class="token keyword">transaction</span><span class="token operator">|</span><span class="token number">0.001174</span><span class="token operator">|</span> <span class="token number">0.001079</span> <span class="token operator">|</span>        <span class="token number">3624</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">starting</span>                     <span class="token operator">|</span><span class="token number">0.002804</span><span class="token operator">|</span> <span class="token number">0.002169</span> <span class="token operator">|</span>        <span class="token number">4728</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> checking permissions         <span class="token operator">|</span><span class="token number">0.002918</span><span class="token operator">|</span> <span class="token number">0.002437</span> <span class="token operator">|</span>        <span class="token number">8168</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> Opening <span class="token keyword">tables</span>               <span class="token operator">|</span><span class="token number">0.009026</span><span class="token operator">|</span> <span class="token number">0.005841</span> <span class="token operator">|</span>       <span class="token number">14120</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> init                         <span class="token operator">|</span><span class="token number">0.001605</span><span class="token operator">|</span> <span class="token number">0.000392</span> <span class="token operator">|</span>          <span class="token number">80</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> System <span class="token keyword">lock</span>                  <span class="token operator">|</span><span class="token number">0.000503</span><span class="token operator">|</span> <span class="token number">0.000130</span> <span class="token operator">|</span>          <span class="token number">24</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> optimizing                   <span class="token operator">|</span><span class="token number">0.000013</span><span class="token operator">|</span> <span class="token number">0.000010</span> <span class="token operator">|</span>           <span class="token number">0</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">statistics</span>                   <span class="token operator">|</span><span class="token number">0.007651</span><span class="token operator">|</span> <span class="token number">0.003072</span> <span class="token operator">|</span>        <span class="token number">4160</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> preparing                    <span class="token operator">|</span><span class="token number">0.000084</span><span class="token operator">|</span> <span class="token number">0.000071</span> <span class="token operator">|</span>           <span class="token number">0</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> executing                    <span class="token operator">|</span><span class="token number">0.005307</span><span class="token operator">|</span> <span class="token number">0.001609</span> <span class="token operator">|</span>         <span class="token number">568</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">end</span>                          <span class="token operator">|</span><span class="token number">0.000017</span><span class="token operator">|</span> <span class="token number">0.000011</span> <span class="token operator">|</span>           <span class="token number">0</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> query <span class="token keyword">end</span>                    <span class="token operator">|</span><span class="token number">0.000178</span><span class="token operator">|</span> <span class="token number">0.000047</span> <span class="token operator">|</span>           <span class="token number">8</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> waiting <span class="token keyword">for</span> <span class="token keyword">handler</span> <span class="token keyword">commit</span>   <span class="token operator">|</span><span class="token number">0.000028</span><span class="token operator">|</span> <span class="token number">0.000025</span> <span class="token operator">|</span>           <span class="token number">0</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> closing <span class="token keyword">tables</span>               <span class="token operator">|</span><span class="token number">0.001087</span><span class="token operator">|</span> <span class="token number">0.000279</span> <span class="token operator">|</span>          <span class="token number">56</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> freeing items                <span class="token operator">|</span><span class="token number">0.000399</span><span class="token operator">|</span> <span class="token number">0.000259</span> <span class="token operator">|</span>           <span class="token number">8</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">|</span> cleaning up                  <span class="token operator">|</span><span class="token number">0.001748</span><span class="token operator">|</span> <span class="token number">0.000381</span> <span class="token operator">|</span>          <span class="token number">56</span><span class="token operator">|</span>            <span class="token number">0</span><span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------------+--------+----------+------------+-------------+</span>
<span class="token number">17</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>如果是executing比较长就可能是代码哪里没写好，使用explain 继续查询问题</p> 
</blockquote> 
<p><strong>show profile的常用查询参数：</strong></p> 
<p>① ALL：显示所有的开销信息。</p> 
<p>② BLOCK IO：显示块IO开销。</p> 
<p>③ CONTEXT SWITCHES：上下文切换开销。</p> 
<p>④ CPU：显示CPU开销信息。</p> 
<p>⑤ IPC：显示发送和接收开销信息。</p> 
<p>⑥ MEMORY：显示内存开销信息。</p> 
<p>⑦ PAGE FAULTS：显示页面错误开销信息。</p> 
<p>⑧ SOURCE：显示和Source_function，Source_file，Source_line相关的开销信息。</p> 
<p>⑨ SWAPS：显示交换次数开销信息。</p> 
<p><strong>日常开发需注意的结论:</strong></p> 
<ol><li><code>converting HEAP to MyISAM</code>: 查询结果太大，内存不够，数据往磁盘上搬了。</li><li><code>creating tmp table:</code> 创建临时表。先拷贝数据到临时表，用完后再删除临时表。</li><li><code>Copying to tmp table on disk</code>:把内存中临时表复制到磁盘上，警惕!</li><li><code>locked</code> 。<br> 如果在show profile诊断结果中出现了以上4条结果中的任何一条，则sql语句需要优化。</li></ol> 
<p><strong>注意:</strong></p> 
<p>不过SHOW PROFILE命令将被弃用，我们可以从information_schema中的profiling数据表进行查看。</p> 
<h3><a id="6_EXPLAIN_746"></a>6. 分析查询语句：EXPLAIN</h3> 
<h4><a id="61__748"></a>6.1 概述</h4> 
<p><strong>定位了查询慢的SQL之后，我们就可以使用EXPLAIN或DESCRIBE工具做针对性的分析查询语句。</strong> DESCRIBE语句的使用方法与EXPLAIN语句是一样的，并且分析结果也是一样的。</p> 
<p>MySQL中有专门负责优化SELECT语句的优化器模块，主要功能: 通过计算分析系统中收集到的统计信息，为客户端请求的Query提供它认为最优的<code>执行计划</code>（他认为最优的数据检索方式，但不见得是DBA认为是最优的，这部分最耗费时间)。</p> 
<p>这个执行计划展示了接下来具体执行查询的方式，比如多表连接的顺序是什么，对于每个表采用什么访问方法来具体执行查询等等。MySQL为我们提供了<code>EXPLAIN</code>语句来帮助我们查看某个查询语句的具体执行计划，大家看懂<code>EXPLAIN</code>语句的各个输出项，可以有针对性的提升我们查询语句的性能。</p> 
<p><strong>1.能做什么?</strong></p> 
<ul><li>表的读取顺序</li><li>数据读取操作的操作类型。</li><li>哪些索引可以使用</li><li><strong>哪些索引被实际使用</strong></li><li>表之间的引用</li><li><strong>每张表有多少行被优化器查询</strong></li></ul> 
<p>官网介绍</p> 
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html" rel="nofollow">https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</a><br> <a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html" rel="nofollow">https://dev.mysql.com/doc/refman/8.0/en/explain-output.html</a></p> 
<p><img src="https://images2.imgbox.com/df/44/5E5yz9q5_o.png" alt="在这里插入图片描述"></p> 
<p><strong>版本情况</strong></p> 
<ul><li>MySQL 5.6.3以前只能 EXPLAIN SELECT ；MYSQL 5.6.3以后就可以 <code>EXPLAIN</code> <code>SELECT</code>，<code>UPDATE</code>，<code>DELETE</code></li><li>在5.7以前的版本中，想要显示 <code>partitions</code> 需要使用 <code>explain partitions</code> 命令；想要显示<code>filtered</code> 需要使用 <code>explain extended</code> 命令。在5.7版本后，默认explain直接显示partitions和filtered中的信息。</li></ul> 
<p><img src="https://images2.imgbox.com/06/43/25TB1YIN_o.png" alt=""></p> 
<h4><a id="62__783"></a>6.2 基本语法</h4> 
<p>EXPLAIN 或 DESCRIBE语句的语法形式如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> select_options <span class="token comment">#推荐</span>
<span class="token comment"># 或者 两个是一样的</span>
<span class="token keyword">DESCRIBE</span> <span class="token keyword">SELECT</span> select_options
</code></pre> 
<p>如果我们想看看某个查询的执行计划的话，可以在具体的查询语句前边加一个 <code>EXPLAIN</code> ，就像这样：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3f/a7/o3TKAv8l_o.png" alt=""><br> 输出的上述信息就是所谓的<code>执行计划</code>。在这个执行计划的辅助下，我们需要知道应该怎样改进自己的查询语句以使查询执行起来更高效。其实除了以<code>SELECT</code>开头的查询语句，其余的<code>DELETE</code>、<code>INSERT</code>、<code>REPLACE</code>以及<code>UPDATE</code>语句等都可以加上<code>EXPLAIN</code>,用来查看这些语句的执行计划，只是平时我们对SELECT语句更感兴趣。</p> 
<p>注意：执行EXPLAIN时并没有真正的执行该后面的语句，因此可以安全的查看执行计划。</p> 
<p><code>EXPLAIN</code> 语句输出的各个列的作用如下</p> 
<table><thead><tr><th>列名</th><th>描述</th></tr></thead><tbody><tr><td>id</td><td>在一个大的查询语句中每个SELECT关键字都对应一个 <code>唯一的id</code></td></tr><tr><td>select_type</td><td>SELECT关键字对应的那个查询的类型</td></tr><tr><td>table</td><td>表名</td></tr><tr><td>partitions</td><td>匹配的分区信息</td></tr><tr><td><strong>type</strong></td><td><strong>针对单表的访问方法</strong>（重要）</td></tr><tr><td>possible_keys</td><td>可能用到的索引</td></tr><tr><td><strong>key</strong></td><td><strong>实际上使用的索引</strong></td></tr><tr><td><strong>key_len</strong></td><td><strong>实际使用到的索引长度</strong></td></tr><tr><td>ref</td><td>当使用索引列等值查询时，与索引列进行等值匹配的对象信息</td></tr><tr><td><strong>rows</strong></td><td><strong>预估的需要读取的记录条数</strong></td></tr><tr><td>filtered</td><td>某个表经过搜索条件过滤后剩余记录条数的百分比</td></tr><tr><td>Extra</td><td>一些额外的信息</td></tr><tr><td>在这里把它们都列出来只是为了描述一个轮廓，让大家有一个大致的印象。</td><td></td></tr></tbody></table> 
<h4><a id="63__823"></a>6.3 数据准备</h4> 
<p><strong>1.建表</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> s1 <span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	key1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
	key2 <span class="token keyword">INT</span><span class="token punctuation">,</span> 
	key3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
	key_part1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	key_part2 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	key_part3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	common_field <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">INDEX</span> idx_key1 <span class="token punctuation">(</span>key1<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_key2 <span class="token punctuation">(</span>key2<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">INDEX</span> idx_key3 <span class="token punctuation">(</span>key3<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">INDEX</span> idx_key_part<span class="token punctuation">(</span>key_part1<span class="token punctuation">,</span> key_part2<span class="token punctuation">,</span> key_part3<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> s2 <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    key1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key2 <span class="token keyword">INT</span><span class="token punctuation">,</span>
    key3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part2 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    common_field <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_key1 <span class="token punctuation">(</span>key1<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_key2 <span class="token punctuation">(</span>key2<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_key3 <span class="token punctuation">(</span>key3<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">INDEX</span> idx_key_part<span class="token punctuation">(</span>key_part1<span class="token punctuation">,</span> key_part2<span class="token punctuation">,</span> key_part3<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> 
<p><strong>2. 设置参数 log_bin_trust_function_creators</strong></p> 
<p>创建函数，假如报错，需开启如下命令：允许创建函数设置：</p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> <span class="token keyword">global</span> log_bin_trust_function_creators<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment"># 不加global只是当前窗口有效。</span>
</code></pre> 
<p><strong>3. 创建函数</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_string1 <span class="token punctuation">(</span> n <span class="token keyword">INT</span> <span class="token punctuation">)</span> 
	<span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span> <span class="token comment">#该函数会返回一个字符串</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span>
		chars_str <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		return_str <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">WHILE</span>
			i <span class="token operator">&lt;</span> n <span class="token keyword">DO</span>
			
			<span class="token keyword">SET</span> return_str <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>
				return_str<span class="token punctuation">,</span>
			SUBSTRING<span class="token punctuation">(</span> chars_str<span class="token punctuation">,</span> FLOOR<span class="token punctuation">(</span> <span class="token number">1</span><span class="token operator">+</span>RAND <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span> <span class="token number">52</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
	<span class="token keyword">RETURN</span> return_str<span class="token punctuation">;</span>
	
<span class="token keyword">END</span> <span class="token comment">// </span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre> 
<p><strong>4. 创建存储过程</strong></p> 
<p>创建往s1表中插入数据的存储过程：</p> 
<pre><code class="prism language-sql"><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_s1 <span class="token punctuation">(</span><span class="token operator">IN</span> min_num <span class="token keyword">INT</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">IN</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">REPEAT</span>
    <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> s1 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>min_num <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>
    rand_string1<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>min_num <span class="token operator">+</span> <span class="token number">30</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    rand_string1<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    rand_string1<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    rand_string1<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    rand_string1<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    rand_string1<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UNTIL i <span class="token operator">=</span> max_num
    <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre> 
<p>创建往s2表中插入数据的存储过程：</p> 
<pre><code class="prism language-sql"><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_s2 <span class="token punctuation">(</span><span class="token operator">IN</span> min_num <span class="token keyword">INT</span> <span class="token punctuation">(</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">IN</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">(</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">REPEAT</span>
 	<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> s2 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>
				<span class="token punctuation">(</span> min_num <span class="token operator">+</span> i <span class="token punctuation">)</span><span class="token punctuation">,</span>
				rand_string1 <span class="token punctuation">(</span> <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">(</span> min_num <span class="token operator">+</span> <span class="token number">30</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
				rand_string1 <span class="token punctuation">(</span> <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
				rand_string1 <span class="token punctuation">(</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
				rand_string1 <span class="token punctuation">(</span> <span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
				rand_string1 <span class="token punctuation">(</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
				rand_string1 <span class="token punctuation">(</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		UNTIL i <span class="token operator">=</span> max_num 
	<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
	<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
	
<span class="token keyword">END</span> <span class="token comment">// </span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre> 
<p><strong>5. 调用存储过程</strong></p> 
<p>s1表数据的添加：加入1万条记录：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CALL</span> insert_s1<span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># id 10002~20001</span>
</code></pre> 
<p>s2表数据的添加：加入1万条记录：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CALL</span> insert_s2<span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment"># id 10002~20001</span>
</code></pre> 
<h4><a id="64_EXPLAIN_979"></a>6.4 EXPLAIN各列作用</h4> 
<p>为了让大家有比较好的体验，我们调整了下 <code>EXPLAIN</code> 输出列的顺序。</p> 
<h5><a id="1_table_983"></a>1. table</h5> 
<p><strong>表名,查询的每一行记录都对应着一个单表</strong></p> 
<p>不论我们的查询语句有多复杂，里边儿 <code>包含了多少个表</code> ，到最后也是需要对每个表进行 <code>单表访问</code> 的，所以MySQL规定<strong>EXPLAIN语句输出的每条记录都对应着某个单表的访问方法</strong>，该条记录的table列代表着该表的表名（有时不是真实的表名字，可能是简称）</p> 
<pre><code class="prism language-sql"><span class="token comment">#1. table：表名</span>
<span class="token comment">#查询的每一行记录都对应着一个单表</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/53/78/v7sxm5BY_o.png" alt=""></p> 
<pre><code class="prism language-sql"><span class="token comment">#s1:驱动表  s2:被驱动表</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2<span class="token punctuation">;</span>
<span class="token comment"># 驱动表和被驱动表是 优化器决定的，他认为哪个比较好久用哪个</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/27/09/R85dc29o_o.png" alt=""></p> 
<blockquote> 
 <p>用到多少个表，就会有多少条记录</p> 
</blockquote> 
<h5><a id="2_id_1008"></a>2. id</h5> 
<p><strong>在一个大的查询语句中每个SELECT关键字都对应一个唯一的id,select查询的序列号,包含一组数字，表示查询中执行select子句或操作表的顺序</strong></p> 
<p>正常来说一个select 一个id ，也有例外的可能，查询优化器做了优化</p> 
<pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/39/8f/Jtz5JZnJ_o.png" alt=""></p> 
<p>一个相同的id</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/b3/NXXnaTjI_o.png" alt=""></p> 
<p>两个id</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2<span class="token punctuation">)</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3b/3c/zvFCrVbR_o.png" alt=""></p> 
<p><strong>查询优化器优化</strong></p> 
<pre><code class="prism language-sql"> <span class="token comment">######查询优化器可能对涉及子查询的查询语句进行重写,转变为多表查询的操作########</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key2 <span class="token keyword">FROM</span> s2 <span class="token keyword">WHERE</span> common_field <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行结果： id 只有一个，原因是查询优化器做了优化<br> <img src="https://images2.imgbox.com/18/f1/zdbL8Gwb_o.png" alt=""></p> 
<p><strong>Union去重</strong></p> 
<p>原本想的1个select 一个 id , 预计两个。</p> 
<pre><code class="prism language-sql"> <span class="token comment">#Union去重</span>
<span class="token comment"># union 去重，union all 不去重</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s2<span class="token punctuation">;</span>
</code></pre> 
<p>有一个临时表<br> <img src="https://images2.imgbox.com/e1/5f/9X36zRo0_o.png" alt=""></p> 
<pre><code class="prism language-sql"><span class="token comment"># union all 不去重  所以不需要放在临时表里面</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s2<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b5/95/UmsMNKqr_o.png" alt=""></p> 
<p><strong>小结:</strong></p> 
<ul><li>id如果相同，可以认为是一组，从上往下顺序执行</li><li>id不同，如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行</li><li>在所有组中，id值越大，优先级越高，越先执行</li><li>关注点：id号每个号码，表示一趟独立的查询, 一个sql的查询趟数越少越好</li></ul> 
<h5><a id="3_select_type_1079"></a>3. select_type</h5> 
<p>一条大的查询语句里边可以包含若干个SELECT关键字，<code>每个SELECT关键字代表着一个小的查询语句</code>，而每个SELECT关键字的FROM子句中都可以包含若干张表(这些表用来做连接查询)，<code>每一张表都对应着执行计划输出中的一条记录</code>，对于在同一个SELECT关键字中的表来说，它们的id值是相同的。</p> 
<p>MySQL为每一个SELECT关键字代表的小查询都定义了一个称之为<code>select_type</code>的属性，意思是我们只要知道了某个小查询的<code>select_type属性</code>，就知道了这个<code>小查询在整个大查询中扮演了一个什么角色</code>，我们看一下<br> <code>select_type</code>都能取哪些值，请看官方文档:</p> 
<table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>SIMPLE</td><td>Simple SELECT (not using UNION or subqueries)</td></tr><tr><td>PRIMARY</td><td>Outermost SELECT</td></tr><tr><td>UNION</td><td>Second or later SELECT statement in a UNION</td></tr><tr><td>UNION RESULT</td><td>Result of a UNION</td></tr><tr><td>SUBQUERY</td><td>First SELECT in subquery</td></tr><tr><td>DEPENDENT SUBQUERY</td><td>First SELECT in subquery, dependent on outer query</td></tr><tr><td>DEPENDENT UNION</td><td>Second or later SELECT statement in a UNION, dependent on outer query</td></tr><tr><td>DERIVED</td><td>Derived table</td></tr><tr><td>MATERIALIZED</td><td>Materialized subquery</td></tr><tr><td>UNCACHEABLE SUBQUERY</td><td>A subquery for which the result cannot be cached and must be re-evaluated for each row of the outer query</td></tr><tr><td>UNCACHEABLE UNION</td><td>The second or later select in a UNION that belongs to an uncacheable subquery (see UNCACHEABLE SUBQUERY)</td></tr></tbody></table> 
<ul><li> <p><code>SIMPLE</code></p> <pre><code class="prism language-sql"> <span class="token comment"># 查询语句中不包含`UNION`或者子查询的查询都算作是`SIMPLE`类型</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1<span class="token punctuation">;</span>
 
  <span class="token comment">#连接查询也算是`SIMPLE`类型</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2<span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>PRIMARY</code> 与 <code>UNION</code>与 <code>UNION RESULT</code></p> 
  <ul><li> <p><code>UNION RESULT</code></p> <p>MySQL选择使用临时表来完成<code>UNION</code>查询的去重工作，针对该临时表的查询的<code>select_type</code>就是<code>UNION RESULT</code>，例子上边有。</p> </li></ul> <pre><code class="prism language-mysql">#对于包含`UNION`或者`UNION ALL`或者子查询的大查询来说，它是由几个小查询组成的，其中最左边的那个查询的`select_type`值就是`PRIMARY`
 
#对于包含`UNION`或者`UNION ALL`的大查询来说，它是由几个小查询组成的，其中除了最左边的那个小查询以外，其余的小查询的`select_type`值就是`UNION`

#`MySQL`选择使用临时表来完成`UNION`查询的去重工作，针对该临时表的查询的`select_type`就是`UNION RESULT` 	
</code></pre> <p>测试sql:</p> <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s2<span class="token punctuation">;</span>	
</code></pre> <p><img src="https://images2.imgbox.com/cf/d6/fUoiQGvE_o.png" alt=""></p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s2<span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/f0/01/Wl72NtHg_o.png" alt=""></p> </li><li> <p><code>SUBQUERY</code></p> <p>如果包含子查询的查询语句不能够转为对应的<code>semi-join</code>的形式，并且该子查询是不相关子查询，并且查询优化器决定采用将该子查询物化的方案来执行该子查询时，该子查询的第个<code>SELECT</code> 关键字代表的那个查询的<code>select_type</code>就是 <code>SUBQUERY</code>，比如下边这个查询:</p> <pre><code class="prism language-sql"> <span class="token comment">#子查询：</span>
 <span class="token comment">#如果包含子查询的查询语句不能够转为对应的`semi-join`的形式，并且该子查询是不相关子查询。</span>
 <span class="token comment">#该子查询的第一个`SELECT`关键字代表的那个查询的`select_type`就是`SUBQUERY`</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2<span class="token punctuation">)</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/4b/cc/i1ZabNY8_o.png" alt=""></p> </li><li> <p><code>DEPENDENT SUBQUERY</code></p> <p>dependent subquery</p> <pre><code class="prism language-sql"> <span class="token comment">#如果包含子查询的查询语句不能够转为对应的`semi-join`的形式，并且该子查询是相关子查询，则该子查询的第一个`SELECT`关键字代表的那个查询的`select_type`就是`DEPENDENT SUBQUERY`</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 
 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2 <span class="token keyword">WHERE</span> s1<span class="token punctuation">.</span>key2 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key2<span class="token punctuation">)</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
 <span class="token comment">#注意的是，select_type为`DEPENDENT SUBQUERY`的查询可能会被执行多次。</span>
</code></pre> <p><img src="https://images2.imgbox.com/ee/86/zWxCDu3k_o.png" alt=""></p> </li><li> <p><code>DEPENDENT UNION</code></p> <pre><code class="prism language-sql"> <span class="token comment">#在包含`UNION`或者`UNION ALL`的大查询中，如果各个小查询都依赖于外层查询的话，那除了最左边的那个小查询之外，其余的小查询的`select_type`的值就是`DEPENDENT UNION`。</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 
 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment"># 这里优化器会重构成exist</span>
</code></pre> <p><img src="https://images2.imgbox.com/fc/f3/vlMuZ6Jt_o.png" alt=""></p> </li><li> <p><code>DERIVED</code></p> <p>derived : 衍生，派生</p> <pre><code class="prism language-sql"> <span class="token comment">#对于包含`派生表`的查询，该派生表对应的子查询的`select_type`就是`DERIVED`</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> 
 <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> c <span class="token keyword">FROM</span> s1 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> key1<span class="token punctuation">)</span> <span class="token keyword">AS</span> derived_s1 <span class="token keyword">WHERE</span> c <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/9d/75/23zP4CNR_o.png" alt=""></p> </li><li> <p><code>MATERIALIZED</code></p> <p>materialized: 英 [məˈtɪəri:əˌlaɪzd] 具体化</p> <pre><code class="prism language-sql"><span class="token comment">#当查询优化器在执行包含子查询的语句时，选择将子查询物化之后与外层查询进行连接查询时，该子查询对应的`select_type`属性就是`MATERIALIZED`</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">#子查询被转为了物化表 </span>

</code></pre> <p><img src="https://images2.imgbox.com/e9/d7/iTjY43l0_o.png" alt=""></p> 
  <blockquote> 
   <p>不理解： 为啥上面的子查询，没有雾化</p> 
   <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2<span class="token punctuation">)</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
 <span class="token comment"># 这个怎么不物化</span>
</code></pre> 
  </blockquote> </li><li> <p><code>UNCACHEABLE SUBQUERY</code></p> <p>uncacheable</p> </li><li> <p><code>UNCACHEABLE UNION</code></p> </li></ul> 
<h5><a id="4_partitions__1238"></a>4. partitions (可略)</h5> 
<ul><li>代表分区表中的命中情况，非分区表，该项为NULL。一般情况下我们的查询语句的执行计划的partitions列的值都是NULL。</li><li><a href="https://dev.mysql.com/doc/refman/5.7/en/alter-table-partition-operations.html" rel="nofollow">https://dev.mysql.com/doc/refman/5.7/en/alter-table-partition-operations.html</a></li><li>如果想详细了解，可以如下方式测试。创建分区表：</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建分区表，</span>
<span class="token comment">-- 按照id分区，id&lt;100 p0分区，其他p1分区</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_partitions <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> RANGE<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">(</span>
    <span class="token keyword">PARTITION</span> p0 <span class="token keyword">VALUES</span> less than<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">PARTITION</span> p1 <span class="token keyword">VALUES</span> less than MAXVALUE
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">DESC</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_partitions <span class="token keyword">WHERE</span> id<span class="token operator">&gt;</span><span class="token number">200</span><span class="token punctuation">;</span>
</code></pre> 
<p>查询id大于200（200&gt;100，p1分区）的记录，查看执行计划，partitions是p1，符合我们的分区规则</p> 
<p><img src="https://images2.imgbox.com/2b/03/sANmUgLO_o.png" alt=""></p> 
<h5><a id="5_type__1269"></a>5. type ☆</h5> 
<p><strong>针对单表的访问方法</strong></p> 
<p>执行计划的一条记录就代表着MySQL对某个表的<code>执行查询时的访问方法</code>，又称"访问类型”，其中的<code>type</code>列就表明了这个访问方法是啥，是较为重要的一个指标。比如，看到<code>type</code>列的值是<code>ref</code>，表明MySQL即将使用<code>ref</code>访问方法来执行对<code>s1</code>表的查询。</p> 
<p>完整的访问方法如下： <code>system</code> ， <code>const</code> ， <code>eq_ref</code> ， <code>ref</code> ， <code>fulltext</code> ， <code>ref_or_null</code> ，<code>index_merge</code> ， <code>unique_subquery</code> ， <code>index_subquery</code> ， <code>range</code> ， <code>index</code> ， <code>ALL</code> 。</p> 
<p>我们详细解释一下：</p> 
<ul><li> <p><code>system</code></p> <p>当表中<code>只有一条记录</code>并且该表使用的存储引擎的统计数据是精确的，比如MyISAM、Memory，那么对该表的访问方法就是<code>system</code>。比方说我们新建一个<code>MyISAM</code>表，并为其插入一条记录:</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t<span class="token punctuation">(</span>i <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">Engine</span><span class="token operator">=</span>MyISAM<span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.05</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> <p>然后我们看一下查询这个表的执行计划：</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> t     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> system <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
  <blockquote> 
   <p>这里如果是 innodb 会变成ALL ， 因为innodb系统不会存条数字段。。MyISAM会存储这么一个字段</p> 
  </blockquote> </li><li> <p><code>const</code></p> <p>当我们根据主键或者唯一二级索引列与常数进行等值匹配时，对单表的访问方法就是<code>const</code><br> 表最多有一个匹配行,它将在查询开始时被读取。因为仅有一行,在这行的列值可被优化器剩余部分认为是常数。const表很快,因为它们只读取一次!</p> <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">10005</span><span class="token punctuation">;</span>
 
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key2 <span class="token operator">=</span> <span class="token string">'10066'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>eq_ref</code></p> <p>对于每个来自于前面的表的行组合,从该表中读取一行。这可能是最好的联接类型,除了const类型。</p> <p>在连接查询时，如果被驱动表是通过主键或者唯一二级索引列等值匹配的方式进行访问的（如果该主键或者唯一二级索引是联合索引的话，所有的索引列都必须进行等值比较），则对该被驱动表的访问方法就是<code>eq_ref</code></p> <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>id <span class="token operator">=</span> s2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
 
</code></pre> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span>  <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>id <span class="token operator">=</span> s2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------------+------+--------+---------+---------+------------------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type<span class="token operator">|</span> <span class="token keyword">table</span><span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref              <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+------+--------+---------+---------+------------------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>     <span class="token operator">|</span> s1   <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>     <span class="token operator">|</span> s2   <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> atguigudb1<span class="token punctuation">.</span>s1<span class="token punctuation">.</span>id <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+------+--------+---------+---------+------------------+------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <p>从执行计划的结果中可以看出，MySQL打算将s2作为驱动表，s1作为被驱动表，重点关注s1的访问方法是 <code>eq_ref</code> ，表明在访问s1表的时候可以 <code>通过主键的等值匹配</code> 来进行访问。</p> </li><li> <p><code>ref</code></p> <p>非唯一性索引扫描，返回匹配某个单独值的所有行本质上也是一种索引访问，它返回所有匹配某个单独值的行，然而它可能会找到多个符合条件的行，所以他应该属于查找和扫描的混合体</p> <p>当通过普通的二级索引列与常量进行等值匹配时来查询某个表，那么对该表的访问方法就可能是<code>ref</code></p> <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> <p>执行结果：</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span>  <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------+------+---------------+----------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------+------+---------------+----------+---------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> s1    <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------+------+---------------+----------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
  <blockquote> 
   <p>tips: 类型相同才可以走索引</p> 
   <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key2 <span class="token operator">=</span> <span class="token number">10066</span><span class="token punctuation">;</span>
<span class="token comment"># 这个是不会走索引的 因为key2 是字符串</span>
<span class="token comment"># 类型不一样，mysql会加函数，进行隐式转换，一旦加上函数，就不会走索引了。</span>
</code></pre> 
  </blockquote> </li><li> <p><code>fulltext</code></p> <p>全文索引</p> </li><li> <p><code>ref_or_null</code></p> <p>当对普通二级索引进行等值匹配查询，该索引列的值也可以是<code>NULL</code>值时，那么对该表的访问方法，就可能是<code>ref_or_null</code></p> <pre><code class="prism language-sql">
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">OR</span> key1 <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>index_merge</code></p> <p><strong>该联接类型表示使用了索引合并优化方法。</strong></p> <p>单表访问方法时在某些场景下可以使用<code>Intersection</code>、<code>Union</code>、<code>Sort-Union</code>这三种索引合并的方式来执行查询</p> <pre><code class="prism language-sql">
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> <p>结果</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span>  <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---+-------+------------+-------------------+--------+-------------------------------+</span>
<span class="token operator">|</span> id<span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>       <span class="token operator">|</span> <span class="token keyword">key</span>               <span class="token operator">|</span> key_len<span class="token operator">|</span> Extra
<span class="token operator">+</span><span class="token comment">---+-------+------------+-------------------+--------+-------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span><span class="token operator">|</span> s1    <span class="token operator">|</span> index_merge<span class="token operator">|</span> idx_key1<span class="token punctuation">,</span>idx_key3 <span class="token operator">|</span> <span class="token number">303</span><span class="token punctuation">,</span><span class="token number">303</span><span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">union</span><span class="token punctuation">(</span>idx_key1<span class="token punctuation">,</span>idx_key3<span class="token punctuation">)</span><span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+-------+------------+-------------------+--------+-------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

</code></pre> <p>从执行计划的 <code>type</code> 列的值是 <code>index_merge</code> 就可以看出，MySQL 打算使用索引合并的方式来执行对 <code>s1</code> 表的查询。</p> </li><li> <p><code>unique_subquery</code></p> <p><code>unique_subquery</code>是针对在一些包含<code>IN</code>子查询的查询语句中，如果查询优化器决定将<code>IN</code>子查询转换为<code>EXISTS</code>子查询，而且子查询可以使用到主键进行等值匹配的话，那么该子查询执行计划的<code>type</code>列的值就是<code>unique_subquery</code></p> <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 
 <span class="token keyword">WHERE</span> key2 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> s2 <span class="token keyword">WHERE</span> s1<span class="token punctuation">.</span>key1 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key1<span class="token punctuation">)</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>index_subquery</code><br> 该联接类型类似于unique_subquery。可以替换IN子查询,但只适合下列形式的子查询中的非唯一索引</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> common_field <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key3 <span class="token keyword">FROM</span> s2 <span class="token keyword">where</span>
s1<span class="token punctuation">.</span>key1 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key1<span class="token punctuation">)</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>range</code><br> 只检索给定范围的行,使用一个索引来选择行。<br> 如果使用索引获取某些<code>范围区间</code>的记录，那么就可能使用到<code>range</code>访问方法</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">#同上</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">&gt;</span> <span class="token string">'a'</span> <span class="token operator">AND</span> key1 <span class="token operator">&lt;</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>index</code></p> <p>Full Index Scan,index与ALL区别为<strong>index类型只遍历索引树</strong> 。这通常比ALL快，因为索引文件通常比数据文件小。(也就是说虽然al和Index都是读全表，但index是从索引中读取的，而all是从硬盘中读的)</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> key_part2 <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key_part3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> 
  <blockquote> 
   <p>索引覆盖，<code>INDEX idx_key_part(key_part1, key_part2, key_part3）</code> 这3个构成一个复合索引 key_part3 在复合索引里面，查询的字段也在索引里面，干脆就直接遍历索引查出数据</p> 
   <p><br>思考： 好处，索引存的数据少，数据少页就少，这样可以减少io。</p> 
  </blockquote> </li><li> <p><code>ALL</code></p> <p>将遍历全表以找到匹配的行</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1<span class="token punctuation">;</span>
</code></pre> <p>一般来说，这些访问方法中除了<code>All</code>这个访问方法外，其余的访问方法都能用到索引，除了<code>index_merge</code>访问方法外，其余的访问方法都最多只能用到一个索引。</p> </li></ul> 
<h6><a id="_1482"></a>阿里巴巴开发手册要求</h6> 
<p><strong>小结:</strong></p> 
<p><strong>结果值从最好到最坏依次是：</strong></p> 
<p><font color="blue">system &gt; const &gt; eq_ref &gt; ref &gt;</font></p> 
<p><font color="red">fulltext &gt; ref_or_null &gt; index_merge &gt;unique_subquery &gt; index_subquery &gt; range &gt; </font></p> 
<p><font color="green">index &gt; ALL </font></p> 
<p><strong>SQL 性能优化的目标：至少要达到 range 级别，要求是 ref 级别，最好是 consts级别。（阿里巴巴开发手册要求）</strong></p> 
<h5><a id="6_possible_keyskey_1498"></a>6. possible_keys和key</h5> 
<p>在EXPLAIN语句输出的执行计划中， <code>possible_keys</code>列表示在某个查询语句中，对某个表执行<code>单表查询时可能用</code>到的索引有哪些。一般查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询使用。<code>key</code>列表示<code>实际用到</code>的索引有哪些，如果为NULL，则没有使用索引。比方说下边这个查询:</p> 
<pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">&gt;</span> <span class="token string">'z'</span> <span class="token operator">AND</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">&gt;</span> <span class="token string">'z'</span> <span class="token operator">AND</span> key3 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------+------+-------------------+----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span><span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys     <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------+------+-------------------+----------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1   <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1<span class="token punctuation">,</span>idx_key3 <span class="token operator">|</span> idx_key3 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------+------+-------------------+----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>上述执行计划的possible_keys列的值是<code>idx_key1,idx_key3</code>，表示该查询可能使用到<code>idx_key1</code> , <code>idx_key3</code>两个索引，然后key列的值是<code>idx_key3</code>，表示经过查询优化器计算使用不同索引的成本后，最后决定使用<code>idx_key3</code></p> 
<blockquote> 
 <p>索引只能用一个。所以他要选一个出来用。查看上面 <code>index_merge </code> or 的话 会走索引合并。</p> 
</blockquote> 
<h5><a id="7_key_len__1527"></a>7. key_len ☆</h5> 
<ul><li> <p>key_len：实际使用到的索引长度(即：字节数)</p> </li><li> <p>key_len越小 索引效果越好 这是前面学到的只是，短一点效率更高</p> </li><li> <p><strong>但是在联合索引里面，命中一次key_len加一次长度。越长代表精度越高，key_len值越大，效果越好</strong></p> </li></ul> 
<pre><code class="prism language-sql"><span class="token comment">#7. </span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">10005</span><span class="token punctuation">;</span>

<span class="token comment">## 结果key_len =4</span>
</code></pre> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key2 <span class="token operator">=</span> <span class="token number">10126</span><span class="token punctuation">;</span>

<span class="token comment">## 结果key_len = 5</span>
</code></pre> 
<p>key2 是int 类型 unique 索引。。因为还可能有一个null值，所以 null占一个字段。4+1 = 5</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>

<span class="token comment">## 结果key_len = 303 </span>
</code></pre> 
<p>原因： <code>key1</code> 是varchar字符类型，在utf8中一个字符占3个字节。所以是100*3 = 300。字段可以为空是占用字节1，字符类型变长的字节需要记录具体的实际长度是多少占2个字节，300+1+2=303。</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key_part1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------------+------+---------------+--------------+---------+-------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type<span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>          <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+------+---------------+--------------+---------+-------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>     <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key_part  <span class="token operator">|</span> idx_key_part <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+------+---------------+--------------+---------+-------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>结果key_len是303</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key_part1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">AND</span> key_part2 <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------------+-----+---------------+--------------+---------+------------</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type<span class="token operator">|</span><span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>          <span class="token operator">|</span> key_len <span class="token operator">|</span> ref        
<span class="token operator">+</span><span class="token comment">----+------------+-----+---------------+--------------+---------+------------</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>     <span class="token operator">|</span>ref  <span class="token operator">|</span> idx_key_part  <span class="token operator">|</span> idx_key_part <span class="token operator">|</span> <span class="token number">606</span>     <span class="token operator">|</span> const<span class="token punctuation">,</span>const
<span class="token operator">+</span><span class="token comment">----+------------+-----+---------------+--------------+---------+------------</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>结果key_606</p> 
<p><strong>这里命中了两次联合索引，精度更高，效果更好</strong></p> 
<p><strong>练习：</strong></p> 
<p><strong>key_len的长度计算公式：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>变长字段且允许<span class="token boolean">NULL</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token keyword">character</span> <span class="token keyword">set</span>：utf8<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>gbk<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>latin1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">(</span>变长字段<span class="token punctuation">)</span>

<span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>变长字段且不允许<span class="token boolean">NULL</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token keyword">character</span> <span class="token keyword">set</span>：utf8<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>gbk<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>latin1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">(</span>变长字段<span class="token punctuation">)</span>

<span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>固定字段且允许<span class="token boolean">NULL</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token keyword">character</span> <span class="token keyword">set</span>：utf8<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>gbk<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>latin1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">)</span>

<span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>固定字段且不允许<span class="token boolean">NULL</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token keyword">character</span> <span class="token keyword">set</span>：utf8<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>gbk<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>latin1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="8_ref_1617"></a>8. ref</h5> 
<p>当使用索引列等值查询时，与索引列进行等值匹配的对象信息。比如只是一个常数或者是某个列。常量</p> 
<pre><code class="prism language-sql">
 
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------+------+---------------+----------+---------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span><span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------+------+---------------+----------+---------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1   <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> const <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------+------+---------------+----------+---------+-------+</span>
</code></pre> 
<p>类型是type =ref，与const（常量）比较</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>id <span class="token operator">=</span> s2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---+------+--------+---------------+--------+------------------+-----</span>
<span class="token operator">|</span> id<span class="token operator">|</span> <span class="token keyword">table</span><span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>    <span class="token operator">|</span> ref              <span class="token operator">|</span> <span class="token keyword">rows</span>
<span class="token operator">+</span><span class="token comment">---+------+--------+---------------+--------+------------------+-----</span>
<span class="token operator">|</span>  <span class="token number">1</span><span class="token operator">|</span> s1   <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span> <span class="token number">9895</span>
<span class="token operator">|</span>  <span class="token number">1</span><span class="token operator">|</span> s2   <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span><span class="token operator">|</span> atguigudb1<span class="token punctuation">.</span>s1<span class="token punctuation">.</span>id <span class="token operator">|</span>    <span class="token number">1</span>
<span class="token operator">+</span><span class="token comment">---+------+--------+---------------+--------+------------------+-----</span>
</code></pre> 
<p>类型是type =eq_ref ， 与 atguigudb1.s1.id 比较</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s2<span class="token punctuation">.</span>key1 <span class="token operator">=</span> UPPER<span class="token punctuation">(</span>s1<span class="token punctuation">.</span>key1<span class="token punctuation">)</span><span class="token punctuation">;</span>                         
<span class="token operator">+</span><span class="token comment">----+------+------+---------------+----------+---------+------+------+----------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> <span class="token keyword">table</span><span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span>Extra                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+---------------+----------+---------+------+------+----------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> s1   <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span><span class="token boolean">NULL</span>                  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> s2   <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> func <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+---------------+----------+---------+------+------+----------------------+</span>
</code></pre> 
<p>与一个方法比较<code>func</code></p> 
<h5><a id="9_rows__1665"></a>9. rows ☆</h5> 
<p><strong>预估的需要读取的记录条数</strong></p> 
<ul><li><code>值越小越好</code></li><li>通常与filtered 一起使用</li></ul> 
<pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">&gt;</span> <span class="token string">'z'</span><span class="token punctuation">;</span>
</code></pre> 
<p>rows 值越小，代表，数据越有可能在一个页里面，这样io就会更小。</p> 
<h5><a id="10_filtered_1680"></a>10. filtered</h5> 
<p>filtered 的值指返回结果的行占需要读到的行(rows 列的值)的百分比。</p> 
<p><strong>越大越好</strong></p> 
<p>如果使用的是索引执行的单表扫描，那么计算时需要估计出满足除使用到对应索引的搜索条件外的其他搜索条件的记录有多少条。</p> 
<pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">&gt;</span> <span class="token string">'z'</span> <span class="token operator">AND</span> common_field <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2e/5d/e3toYHQt_o.png" alt=""></p> 
<p><strong>对于单表查询来说，这个filtered列的值没什么意义</strong>，我们<code>更关注在连接查询中驱动表对应的执行计划记录的filtered值</code>，它决定了被驱动表要执行的次数(即：rows * filtered)</p> 
<pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>key1 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key1 <span class="token keyword">WHERE</span> s1<span class="token punctuation">.</span>common_field <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/da/7e/UPuqheMy_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="11_Extra__1709"></a>11. Extra ☆</h5> 
<p>顾名思义，<code>Extra</code>列是用来说明一些额外信息的，包含不适合在其他列中显示但十分重要的额外信息。我们可以通过这些额外信息来<code>更准确的理解MySQL到底将如何执行给定的查询语句</code>。MySQL提供的额外信息有好几十个，一下捡重点介绍</p> 
<ul><li> <p><code>No tables used</code></p> <p>当查询语句的没有FROM子句时将会提示该额外信息，比如:</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token punctuation">;</span>				
</code></pre> <p><img src="https://images2.imgbox.com/20/10/Nw6pgovH_o.png" alt=""></p> </li><li> <p><code>Impossible WHERE</code></p> <p>查询语句的<code>WHERE</code>子句永远为<code>FALSE</code>时将会提示该额外信息</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> <span class="token number">1</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/6e/a7/MVEMYI8Q_o.png" alt=""></p> </li><li> <p>Using where</p> <p><strong>表明使用了where过滤</strong>，当我们使用全表扫描来执行对某个表的查询，并且该语句的<code>WHERE</code>子句中有针对该表的搜索条件时，在<code>Extra</code>列中会提示上述额外信息。</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> common_field <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/6d/3b/rSwdG6wY_o.png" alt=""></p> <p>当条件除了索引，还有其他条件，也会是这个提示</p> <pre><code class="prism language-sql"> <span class="token comment">#当使用索引访问来执行对某个表的查询，并且该语句的`WHERE`子句中</span>
 <span class="token comment">#有除了该索引包含的列之外的其他搜索条件时，在`Extra`列中也会提示上述额外信息。</span>
 <span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'fUhcQU'</span> <span class="token operator">and</span>  common_field <span class="token operator">=</span> <span class="token string">'uDHCOnalcF'</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/62/60/5d0AxBcJ_o.png" alt=""></p> </li><li> <p><code>No matching min/max row</code></p> <p>当查询列表处有<code>MIN</code>或者<code>MAX</code>聚合函数，但是并没有符合<code>WHERE</code>子句中的搜索条件的记录时，将会提示该额外信息</p> <pre><code class="prism language-sql"> <span class="token comment"># 数据库不存在 QLjKYOx</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token function">MIN</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'QLjKYOx'</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/b8/19/91szLq7k_o.png" alt=""></p> <pre><code class="prism language-sql"> <span class="token comment"># 数据库存在 QLjKYO</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token function">MIN</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'QLjKYO'</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/3b/f1/90B29JMI_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>Using index</code></p> <p>表示相应的select操作中使用了覆盖索引(Covering Index),避免访问了表的数据行，效率不错！<br> 如果同时出现using where,表明索引被用来执行索引键值的查找；<br> 如果没有同时出现using where,表明索引用来读取数据而非执行查找动作。</p> <p>比方说下边这个查询中只需要用到<code>idx_key1</code>而不需要回表操作：</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/d3/bc/wF9IKyhr_o.png" alt=""><br> <strong>覆盖索引（Covering Index）,一说为索引覆盖。</strong></p> <p><strong>理解方式一:</strong><br> 就是select的数据列只用从索引中就能够取得，不必读取数据行，MySQL可以利用索引返回select列表中的字段，而不必根据索引再次读取数据文件,换句话说查询列要被所建的索引覆盖。</p> <p><strong>理解方式二:</strong><br> 索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据;当能通过读取索引就可以得到想要的数据，那就不需要读取行了。一个索引包含了(或覆盖了)满足查询结果的数据就叫做覆盖索引。</p> <p><strong>注意：</strong><br> 如果要使用覆盖索引，一定要注意select列表中只取出需要的列，不可select *，<br> 因为如果将所有字段一起做索引会导致索引文件过大，查询性能下降。</p> </li><li> <p><code>Using index condition</code></p> <p>有些搜索条件中虽然出现了索引列，但却不能使用到索引，看课件理解索引条件下推</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">&gt;</span> <span class="token string">'z'</span> <span class="token operator">AND</span> key1 <span class="token operator">LIKE</span> <span class="token string">'%a'</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/ab/90/SYSJzKnV_o.png" alt=""></p> 
  <blockquote> 
   <p>步骤1. 这里key1 &gt; ‘z’ 走了索引，查出了378条数据。。。</p> 
   <p>步骤2. key1 LIKE ‘%b’; 这个条件依然是 key1 索引，，，所以接下来只要在遍历这378个索引。哪些符合 ‘%a’</p> 
   <p>步骤3. 通过步骤2 过滤出了有效 索引。。 这就是Using index condition 。</p> 
   <p>步骤4. 把符合条件的索引，进行回表查询。</p> 
  </blockquote> <p>完整的说明：</p> <p>其中的<code>key1 &gt; 'z'</code>可以使用到索引，但是<code>key1 LIKE '%a '</code>却无法使用到索引，在以前版本的MySQL中，是按照下边步骤来执行这个查询的:</p> 
  <ul><li> <p>先根据key1 &gt; 'z’这个条件，从二级索引<code>idx_key1</code>中获取到对应的二级索引记录。</p> </li><li> <p>根据上一步骤得到的二级索引记录中的主键值进行回表，找到完整的用户记录再检测该记录是否符合<code>key1 LIKE '%a'</code>这个条件，将符合条件的记录加入到最后的结果集。</p> <p>但是虽然<code>key1 LIKE ‘%a'</code>不能组成范围区间参与<code>range</code>访问方法的执行，但这个条件毕竟只涉及到了<code>key1</code>列，所以MySQL把上边的步骤改进了一下:</p> </li><li> <p>先根据<code>key1 &gt; 'z'</code>这个条件，定位到二级索引<code>idx_key1</code>中对应的二级索引记录。</p> </li><li> <p>对于指定的二级索引记录，先不着急回表，而是先检测一下该记录是否满足<code>key1 LIKE ‘%a'</code>这个条件，如果这个条件不满足，则该二级索引记录压根儿就没必要回表。</p> </li><li> <p>对于满足<code>key1 LIKE '%a'</code>这个条件的二级索引记录执行回表操作。</p> </li></ul> <p>我们说回表操作其实是一个<code>随机IO</code>，比较耗时，所以上述修改虽然只改进了一点点，但是可以省去好多回表操作的成本。MySQL把他们的这个改进称之为<code>索引条件下推</code> (英文名: Index Condition Pushdown )。如果在查询语句的执行过程中将要使用<code>索引条件下推</code>这个特性，在Extra列中将会显示<code>Using index condition</code></p> </li><li> <p><code>Using join buffer (Block Nested Loop)</code></p> <p>没有索引的字段进行表关联。</p> <p>在连接查询执行过程中，当被驱动表不能有效的利用索引加快访问速度，MySQL一般会为其分配一块名叫<code>join buffer</code>的内存块来加快查询速度，也就是我们所讲的<code>基于块的嵌套循环算法</code></p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>common_field <span class="token operator">=</span> s2<span class="token punctuation">.</span>common_field<span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/be/f8/VJT0HRqm_o.png" alt=""></p> </li><li> <p><code>Not exists</code></p> <p>当我们使用左（外）连接时，如果<code>WHERE</code>子句中包含要求被驱动表的某个列等于<code>NULL</code>值的搜索条件，而且那个列又是不允许存储<code>NULL</code>值的，那么在该表的执行计划的Extra列就会提示<code>Not exists</code>额外信息</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>key1 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key1 <span class="token keyword">WHERE</span> s2<span class="token punctuation">.</span>id <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/5a/63/kl4iwdCU_o.png" alt=""></p> </li><li> <p><code>Using intersect(...) 、 Using union(...) 和 Using sort_union(...)</code></p> 
  <ul><li> <p>如果执行计划的<code>Extra</code>列出现了<code>Using intersect(...)</code>提示，说明准备使用<code>Intersect</code>索引</p> </li><li> <p>合并的方式执行查询，括号中的<code>...</code>表示需要进行索引合并的索引名称；</p> </li><li> <p>如果出现了<code>Using union(...)</code>提示，说明准备使用<code>Union</code>索引合并的方式执行查询；</p> </li><li> <p>出现了<code>Using sort_union(...)</code>提示，说明准备使用<code>Sort-Union</code>索引合并的方式执行查询。</p> <pre><code class="prism language-mysql"> EXPLAIN SELECT * FROM s1 WHERE key1 = 'a' OR key3 = 'a';
</code></pre> <p><img src="https://images2.imgbox.com/6b/e4/g6AG7dFg_o.png" alt="在这里插入图片描述"></p> </li></ul> </li><li> <p><code>Zero limit</code><br> 当我们的<code>LIMIT</code>子句的参数为<code>0</code>时，表示压根儿不打算从表中读出任何记录，将会提示该额外信息</p> </li></ul> 
<pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">LIMIT</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li> <p><code>Using filesort</code></p> <p>说明ysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL中无法利用索引完成的排序操作称为文件排序”</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> key1 <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <p>这个查询语句可以利用<code>idx_key1</code>索引直接取出key1列的10条记录，然后再进行回表操作就好了。但是很多情况下排序操作无法使用到索引，只能在内存中(记录较少的时候）或者磁盘中(记录较多的时候）进行排序，MySQL把这种在内存中或者磁盘上进行排序的方式统称为文件排序（英文名: <code>filesort</code>)。如果某个查询需要使用文件排序的方式执行查询，就会在执行计划的<code>Extra</code>列中显示<code>Using filesort</code>提示</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> common_field <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>Using temporary</code></p> <p>在许多查询的执行过程中，MySQL可能会借助临时表来完成一些功能，比如去重、排序之类的，比如我们在执行许多包含<code>DISTINCT</code>、<code>GROUP BY</code>、<code>UNION</code>等子句的查询过程中，如果不能有效利用索引来完成查询，MySQL很有可能寻求通过建立内部的临时表来执行查询。如果查询中使用到了内部的临时表，在执行计划的<code>Extra</code>列将会显示<code>Using temporary</code>提示</p> <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> common_field <span class="token keyword">FROM</span> s1<span class="token punctuation">;</span>
 
</code></pre> <p><img src="https://images2.imgbox.com/75/c2/dYmLjBUi_o.png" alt=""></p> <pre><code class="prism language-sql"> <span class="token comment">#执行计划中出现`Using temporary`并不是一个好的征兆，因为建立与维护临时表要付出很大成本的，所以我们`最好能使用索引来替代掉使用临时表`。比如：扫描指定的索引idx_key1即可</span>
 <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> key1<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> amount <span class="token keyword">FROM</span> s1 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> key1<span class="token punctuation">;</span>
</code></pre> <p><img src="https://images2.imgbox.com/eb/e4/zNmWYeUF_o.png" alt=""></p> </li></ul> 
<h5><a id="12__1949"></a>12. 小结</h5> 
<ul><li>EXPLAIN不考虑各种Cache</li><li>EXPLAIN不能显示MySQL在执行查询时所作的优化工作</li><li>EXPLAIN不会告诉你关于触发器、存储过程的信息或用户自定义函数对查询的影响情况</li><li>部分统计信息是估算的，并非精确值</li></ul> 
<h3><a id="7_EXPLAIN_1958"></a>7. EXPLAIN的进一步使用</h3> 
<h4><a id="71_EXPLAIN_1960"></a>7.1 EXPLAIN四种输出格式</h4> 
<p>这里谈谈EXPLAIN的输出格式。EXPLAIN可以输出四种格式： <code>传统格式</code> ， <code>JSON格式</code> ， <code>TREE格式</code> 以及 <code>可视化输出</code> 。用户可以根据需要选择适用于自己的格式。</p> 
<h5><a id="1__1964"></a>1. 传统格式</h5> 
<p>传统格式简单明了，输出是一个表格形式，概要说明查询计划。</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> s1<span class="token punctuation">.</span>key1<span class="token punctuation">,</span> s2<span class="token punctuation">.</span>key1 <span class="token keyword">FROM</span> s1 <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>key1 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key1 <span class="token keyword">WHERE</span> s2<span class="token punctuation">.</span>common_field <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>  
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+-------</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>   
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+-------</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s2    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> <span class="token boolean">NULL</span>  
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_ke
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+-------</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="2_JSON_1982"></a>2. JSON格式</h5> 
<p>第1种格式中介绍的<code>EXPLAIN</code>语句输出中缺少了一个衡量执行计划好坏的重要属性——<code>成本</code>。而JSON格式是四种格式里面输出信息<code>最详尽的格式</code>，里面包含了执行的成本信息。</p> 
<ul><li> <p>JSON格式：在EXPLAIN单词和真正的查询语句中间加上 <code>FORMAT=JSON</code> 。</p> <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> FORMAT<span class="token operator">=</span>JSON <span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
</code></pre> </li><li> <p>EXPLAIN的Column与JSON的对应关系:(来源于MySQL 5.7文档)</p> <p><img src="https://images2.imgbox.com/86/08/V4mGLo2G_o.png" alt=""></p> </li></ul> 
<p>这样我们就可以得到一个json格式的执行计划，里面包含该计划花费的成本，比如这样:</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> FORMAT<span class="token operator">=</span>JSON <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>key1 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key2 <span class="token keyword">WHERE</span> s1<span class="token punctuation">.</span>common_field <span class="token operator">=</span> <span class="token string">'a'</span> \G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">EXPLAIN</span>: {
  <span class="token string">"query_block"</span>: {
    <span class="token string">"select_id"</span>: <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment"># 整个查询语句只有1个SELECT关键字，该关键字对应的1d号为1</span>
    <span class="token string">"cost_info"</span>: {
      <span class="token string">"query_cost"</span>: <span class="token string">"1360.07"</span> <span class="token comment"># 整个查询的执行成本预计为1360.07</span>
    }<span class="token punctuation">,</span>
    <span class="token string">"nested_loop"</span>: <span class="token punctuation">[</span> <span class="token comment"># 几个表之间采用嵌套循环连接算法执行</span>
      { <span class="token comment"># 以下是参与嵌套循环连接算法的各个表的信息</span>
        <span class="token string">"table"</span>: {
          <span class="token string">"table_name"</span>: <span class="token string">"s1"</span><span class="token punctuation">,</span> <span class="token comment"># s1表是驱动表</span>
          <span class="token string">"access_type"</span>: <span class="token string">"ALL"</span><span class="token punctuation">,</span> <span class="token comment"># 访问方法为ALL,意味着使用全表扫描访问</span>
          <span class="token string">"possible_keys"</span>: <span class="token punctuation">[</span> <span class="token comment"># 可能使用的索引</span>
            <span class="token string">"idx_key1"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"rows_examined_per_scan"</span>: <span class="token number">9895</span><span class="token punctuation">,</span> <span class="token comment"># 查询一次s1表大致需要扫描9895条记录</span>
          <span class="token string">"rows_produced_per_join"</span>: <span class="token number">989</span><span class="token punctuation">,</span> <span class="token comment"># 驱动表s1的扇出是989</span>
          <span class="token string">"filtered"</span>: <span class="token string">"10.00"</span><span class="token punctuation">,</span> <span class="token comment"># condition filtering代表的百分比</span>
          <span class="token string">"cost_info"</span>: {
            <span class="token string">"read_cost"</span>: <span class="token string">"914.80"</span><span class="token punctuation">,</span>
            <span class="token string">"eval_cost"</span>: <span class="token string">"98.95"</span><span class="token punctuation">,</span>
            <span class="token string">"prefix_cost"</span>: <span class="token string">"1013.75"</span><span class="token punctuation">,</span>  <span class="token comment"># 单次查询s1表总共的成本</span>
            <span class="token string">"data_read_per_join"</span>: <span class="token string">"1M"</span> <span class="token comment"># 读取的数据量</span>
          }<span class="token punctuation">,</span>
          <span class="token string">"used_columns"</span>: <span class="token punctuation">[</span> <span class="token comment"># 执行查询中涉及到的列</span>
            <span class="token string">"id"</span><span class="token punctuation">,</span>
            <span class="token string">"key1"</span><span class="token punctuation">,</span>
            <span class="token string">"key2"</span><span class="token punctuation">,</span>
            <span class="token string">"key3"</span><span class="token punctuation">,</span>
            <span class="token string">"key_part1"</span><span class="token punctuation">,</span>
            <span class="token string">"key_part2"</span><span class="token punctuation">,</span>
            <span class="token string">"key_part3"</span><span class="token punctuation">,</span>
            <span class="token string">"common_field"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token comment"># 对s1表访问时针对单表查询的条件</span>
          <span class="token string">"attached_condition"</span>: <span class="token string">"((`atguigudb1`.`s1`.`common_field` = 'a') and (`atguigudb1`.`s1`.`key1` is not null))"</span>
        }
      }<span class="token punctuation">,</span>
      {
        <span class="token string">"table"</span>: {
          <span class="token string">"table_name"</span>: <span class="token string">"s2"</span><span class="token punctuation">,</span>  <span class="token comment"># s2表是被驱动表</span>
          <span class="token string">"access_type"</span>: <span class="token string">"eq_ref"</span><span class="token punctuation">,</span> <span class="token comment"># 访问方法为ref,意味着使用索引等值匹配的方式访问</span>
          <span class="token string">"possible_keys"</span>: <span class="token punctuation">[</span> <span class="token comment"># 可能使用的索引</span>
            <span class="token string">"idx_key2"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"key"</span>: <span class="token string">"idx_key2"</span><span class="token punctuation">,</span> <span class="token comment"># 实际使用的索引</span>
          <span class="token string">"used_key_parts"</span>: <span class="token punctuation">[</span> <span class="token comment"># 使用到的索引列</span>
            <span class="token string">"key2"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"key_length"</span>: <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token comment"># key_len</span>
          <span class="token string">"ref"</span>: <span class="token punctuation">[</span>   <span class="token comment"># 与key2列进行等值匹配的对象</span>
            <span class="token string">"atguigudb1.s1.key1"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"rows_examined_per_scan"</span>: <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment"># 查询一次s2表大致需要扫描1条记录</span>
          <span class="token string">"rows_produced_per_join"</span>: <span class="token number">989</span><span class="token punctuation">,</span> <span class="token comment"># 被驱动表s2的扇出是968</span>
          <span class="token string">"filtered"</span>: <span class="token string">"100.00"</span><span class="token punctuation">,</span> <span class="token comment"># condition filtering代表的百分比</span>
          <span class="token comment">#s2表使用索引进行查询的搜索条件</span>
          <span class="token string">"index_condition"</span>: <span class="token string">"(cast(`atguigudb1`.`s1`.`key1` as double) = cast(`atguigudb1`.`s2`.`key2` as double))"</span><span class="token punctuation">,</span>
          <span class="token string">"cost_info"</span>: {
            <span class="token string">"read_cost"</span>: <span class="token string">"247.38"</span><span class="token punctuation">,</span>
            <span class="token string">"eval_cost"</span>: <span class="token string">"98.95"</span><span class="token punctuation">,</span>
            <span class="token string">"prefix_cost"</span>: <span class="token string">"1360.08"</span><span class="token punctuation">,</span>  <span class="token comment"># 单次查询s1、多次查询s2表总共的成本</span>
            <span class="token string">"data_read_per_join"</span>: <span class="token string">"1M"</span> <span class="token comment"># 读取的数据量</span>
          }<span class="token punctuation">,</span>
          <span class="token string">"used_columns"</span>: <span class="token punctuation">[</span> <span class="token comment"># 执行查询中涉及到的列</span>
            <span class="token string">"id"</span><span class="token punctuation">,</span>
            <span class="token string">"key1"</span><span class="token punctuation">,</span>
            <span class="token string">"key2"</span><span class="token punctuation">,</span>
            <span class="token string">"key3"</span><span class="token punctuation">,</span>
            <span class="token string">"key_part1"</span><span class="token punctuation">,</span>
            <span class="token string">"key_part2"</span><span class="token punctuation">,</span>
            <span class="token string">"key_part3"</span><span class="token punctuation">,</span>
            <span class="token string">"common_field"</span>
          <span class="token punctuation">]</span>
        }
      }
    <span class="token punctuation">]</span>
  }
}
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c2/61/4DAbV5ei_o.png" alt=""></p> 
<p>我们使用 <code>#</code> 后边跟随注释的形式为大家解释了 <code>EXPLAIN FORMAT=JSON</code> 语句的输出内容，但是大家可能<br> 有疑问 “<code>cost_info</code>” 里边的成本看着怪怪的，它们是怎么计算出来的？先看 <code>s1</code> 表的 “<code>cost_info</code>” 部<br> 分：</p> 
<pre><code class="prism language-json"><span class="token string-property property">"cost_info"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"read_cost"</span><span class="token operator">:</span> <span class="token string">"914.80"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"eval_cost"</span><span class="token operator">:</span> <span class="token string">"98.95"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"prefix_cost"</span><span class="token operator">:</span> <span class="token string">"1013.75"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"data_read_per_join"</span><span class="token operator">:</span> <span class="token string">"1M"</span>
<span class="token punctuation">}</span>  
</code></pre> 
<ul><li> <p><code>read_cost</code> 是由下边这两部分组成的：</p> 
  <ul><li>IO 成本</li><li>检测 <code>rows × (1 - filter)</code> 条记录的 CPU 成本</li></ul> 
  <blockquote> 
   <p>小贴士： rows和filter都是我们前边介绍执行计划的输出列，在JSON格式的执行计划中，rows相当于rows_examined_per_scan，filtered名称不变。</p> 
  </blockquote> </li><li> <p><code>eval_cost</code> 是这样计算的</p> <p>检测 <code>rows × filter</code> 条记录的成本。</p> </li><li> <p><code>prefix_cost</code> 就是单独查询 <code>s1</code> 表的成本，也就是：</p> <p><code>read_cost + eval_cost </code></p> </li><li> <p><code>data_read_per_join</code> 表示在此次查询中需要读取的数据量。</p> </li></ul> 
<p>对于 s2 表的 “cost_info” 部分是这样的：</p> 
<pre><code class="prism language-json"><span class="token string-property property">"cost_info"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"read_cost"</span><span class="token operator">:</span> <span class="token string">"247.38"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"eval_cost"</span><span class="token operator">:</span> <span class="token string">"98.95"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"prefix_cost"</span><span class="token operator">:</span> <span class="token string">"1360.08"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"data_read_per_join"</span><span class="token operator">:</span> <span class="token string">"1M"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于 <code>s2</code> 表是被驱动表，所以可能被读取多次，这里的 <code>read_cost</code> 和 <code>eval_cost</code> 是访问多次 <code>s2</code> 表后累<br> 加起来的值，大家主要关注里边儿的 <code>prefix_cost</code> 的值代表的是整个连接查询预计的成本，也就是单<br> 次查询 <code>s1</code> 表和多次查询 <code>s2</code> 表后的成本的和，也就是 :</p> 
<pre><code class="prism language-text">247.38 + 98.95 + 1013.75 = 1360.08
</code></pre> 
<h5><a id="3_TREE_2137"></a>3. TREE格式</h5> 
<p>TREE格式是8.0.16版本之后引入的新格式，主要根据查询的 <code>各个部分之间的关系</code> 和 <code>各部分的执行顺序</code> 来描述如何查询</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> FORMAT<span class="token operator">=</span>tree <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>key1 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key2 <span class="token keyword">WHERE</span> s1<span class="token punctuation">.</span>common_field <span class="token operator">=</span> <span class="token string">'a'</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">EXPLAIN</span>: <span class="token operator">-</span><span class="token operator">&gt;</span> Nested <span class="token keyword">loop</span> <span class="token keyword">inner</span> <span class="token keyword">join</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1360.08</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">990</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> Filter: <span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span>common_field <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>s1<span class="token punctuation">.</span>key1 <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1013.75</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">990</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">Table</span> scan <span class="token keyword">on</span> s1  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1013.75</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">9895</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> Single<span class="token operator">-</span><span class="token keyword">row</span> <span class="token keyword">index</span> lookup <span class="token keyword">on</span> s2 <span class="token keyword">using</span> idx_key2 <span class="token punctuation">(</span>key2<span class="token operator">=</span>s1<span class="token punctuation">.</span>key1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">with</span> <span class="token keyword">index</span> condition: <span class="token punctuation">(</span>cast<span class="token punctuation">(</span>s1<span class="token punctuation">.</span>key1 <span class="token keyword">as</span> <span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token operator">=</span> cast<span class="token punctuation">(</span>s2<span class="token punctuation">.</span>key2 <span class="token keyword">as</span> <span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.25</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="4__2152"></a>4. 可视化输出</h5> 
<p>可视化输出，可以通过MySQL Workbench可视化查看MySQL的执行计划。通过点击Workbench的放大镜图标，即可生成可视化的查询计划。</p> 
<p><img src="https://images2.imgbox.com/0e/62/mb49k9LB_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/ee/6d/TnMd3A3M_o.png" alt="在这里插入图片描述"></p> 
<p>上图按从左到右的连接顺序显示表。红色框表示 <code>全表扫描</code> ，而绿色框表示使用 <code>索引查找</code> 。对于每个表，显示使用的索引。还要注意的是，每个表格的框上方是每个表访问所发现的行数的估计值以及访问该表的成本。</p> 
<h4><a id="72_SHOW_WARNINGS_2167"></a>7.2 SHOW WARNINGS的使用</h4> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> s1<span class="token punctuation">.</span>key1<span class="token punctuation">,</span> s2<span class="token punctuation">.</span>key1 <span class="token keyword">FROM</span> s1 <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>key1 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key1 <span class="token keyword">WHERE</span> s2<span class="token punctuation">.</span>common_field <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
</code></pre> 
<p>使用完explain 后紧接着使用 <code>SHOW WARNINGS \G</code></p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> <span class="token keyword">WARNINGS</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token keyword">Level</span>: Note
   Code: <span class="token number">1003</span>
Message: <span class="token comment">/* select#1 */</span> <span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>atguigudb1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>s1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>key1<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>key1<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>atguigudb1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>s2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>key1<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>key1<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>atguigudb1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>s1<span class="token punctuation">`</span></span> <span class="token keyword">join</span> <span class="token identifier"><span class="token punctuation">`</span>atguigudb1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>s2<span class="token punctuation">`</span></span> <span class="token keyword">where</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>atguigudb1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>s1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>key1<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token identifier"><span class="token punctuation">`</span>atguigudb1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>s2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>key1<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>atguigudb1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>s2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>common_field<span class="token punctuation">`</span></span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>可以看到查询优化器真正执行的语句</p> 
 <p>粘出来并不一定可以运行</p> 
</blockquote> 
<p>大家可以看到<code>SHOW WARNINGS</code>展示出来的信息有三个字段，分别是<code>Level</code>、<code>Code</code>、<code>Message</code>。我们最常见的就是Code为1003的信息，当Code值为1003时,Message字段展示的信息类似于<code>查询优化器</code>将我们的查询语句<strong>重写后的语句</strong>。比如我们上边的查询本来是一个左(外)连接查询，但是有一个s2.common_field IS NOT NULL的条件，这就会导致查询优化器把左(外）连接查询优化为内连接查询，从 <code>SHOW WARNINGS</code>的<code>Message</code>字段也可以看出来，原本的LEFT JOIN已经变成了JOIN(内连接)。</p> 
<h3><a id="8_trace_2192"></a>8. 分析优化器执行计划：trace</h3> 
<p><code>OPTIMIZER_TRACE</code> 是MySQL 5.6引入的一项跟踪功能，它可以跟踪优化器做出的各种决策(比如访问表的方法、各种开销计算、各种转换等)，并将跟踪结果记录到<code>INFORMATION_SCHEMA.OPTIMIZER_TRACE</code>表中。</p> 
<p>此功能默认关闭。开启trace，并设置格式为JSON，同时设置trace最大能够使用的内存大小，避免解析过程中因为默认内存过小而不能够完整展示。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SET</span> optimizer_trace<span class="token operator">=</span><span class="token string">"enabled=on"</span><span class="token punctuation">,</span>end_markers_in_json<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>

<span class="token keyword">SET</span> optimizer_trace_max_mem_size<span class="token operator">=</span><span class="token number">1000000</span><span class="token punctuation">;</span>
</code></pre> 
<p>开启后，可分析如下语句：</p> 
<ul><li>SELECT</li><li>INSERT</li><li>REPLACE</li><li>UPDATE</li><li>DELETE</li><li>EXPLAIN</li><li>SET</li><li>DECLARE</li><li>CASE</li><li>IF</li><li>RETURN</li><li>CALL</li></ul> 
<p>测试：执行如下SQL语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p>最后， 查询 information_schema.optimizer_trace 就可以知道MySQL是如何执行SQL的 :</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>optimizer_trace\G
</code></pre> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>optimizer_trace\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token comment"># //第1部分：查询语句</span>
QUERY: <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;</span> <span class="token number">10</span>
<span class="token comment">//第2部分：QUERY字段对应语句的跟踪信息</span>
TRACE: {
  <span class="token string">"steps"</span>: <span class="token punctuation">[</span>
    {
      <span class="token string">"join_preparation"</span>: { <span class="token comment">/*预备工作*/</span>
        <span class="token string">"select#"</span>: <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"steps"</span>: <span class="token punctuation">[</span>
          {
            <span class="token string">"expanded_query"</span>: <span class="token string">"/* select#1 */ select `student`.`id` AS `id`,`student`.`stuno` AS `stuno`,`student`.`name` AS `name`,`student`.`age` AS `age`,`student`.`classId` AS `classId` from `student` where (`student`.`id` &lt; 10)"</span>
          }
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      } <span class="token comment">/* join_preparation */</span>
    }<span class="token punctuation">,</span>
    {
      <span class="token string">"join_optimization"</span>: {<!-- --><span class="token comment">/*进行优化*/</span>
        <span class="token string">"select#"</span>: <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"steps"</span>: <span class="token punctuation">[</span>
          {
            <span class="token string">"condition_processing"</span>: {<!-- --><span class="token comment">/*条件处理*/</span>
              <span class="token string">"condition"</span>: <span class="token string">"WHERE"</span><span class="token punctuation">,</span>
              <span class="token string">"original_condition"</span>: <span class="token string">"(`student`.`id` &lt; 10)"</span><span class="token punctuation">,</span>
              <span class="token string">"steps"</span>: <span class="token punctuation">[</span>
                {
                  <span class="token string">"transformation"</span>: <span class="token string">"equality_propagation"</span><span class="token punctuation">,</span>
                  <span class="token string">"resulting_condition"</span>: <span class="token string">"(`student`.`id` &lt; 10)"</span>
                }<span class="token punctuation">,</span>
                {
                  <span class="token string">"transformation"</span>: <span class="token string">"constant_propagation"</span><span class="token punctuation">,</span>
                  <span class="token string">"resulting_condition"</span>: <span class="token string">"(`student`.`id` &lt; 10)"</span>
                }<span class="token punctuation">,</span>
                {
                  <span class="token string">"transformation"</span>: <span class="token string">"trivial_condition_removal"</span><span class="token punctuation">,</span>
                  <span class="token string">"resulting_condition"</span>: <span class="token string">"(`student`.`id` &lt; 10)"</span>
                }
              <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
            } <span class="token comment">/* condition_processing */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">"substitute_generated_columns"</span>: {<!-- --><span class="token comment">/*替换生成的列*/</span>
            } <span class="token comment">/* substitute_generated_columns */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">"table_dependencies"</span>: <span class="token punctuation">[</span>   <span class="token comment">/* 表的依赖关系*/</span>
              {
                <span class="token string">"table"</span>: <span class="token string">"`student`"</span><span class="token punctuation">,</span>
                <span class="token string">"row_may_be_null"</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token string">"map_bit"</span>: <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"depends_on_map_bits"</span>: <span class="token punctuation">[</span>
                <span class="token punctuation">]</span> <span class="token comment">/* depends_on_map_bits */</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* table_dependencies */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">"ref_optimizer_key_uses"</span>: <span class="token punctuation">[</span> <span class="token comment">/* 使用键*/</span>
            <span class="token punctuation">]</span> <span class="token comment">/* ref_optimizer_key_uses */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">"rows_estimation"</span>: <span class="token punctuation">[</span> <span class="token comment">/*行判断*/</span>
              {
                <span class="token string">"table"</span>: <span class="token string">"`student`"</span><span class="token punctuation">,</span>
                <span class="token string">"range_analysis"</span>: {
                  <span class="token string">"table_scan"</span>: {
                    <span class="token string">"rows"</span>: <span class="token number">3945207</span><span class="token punctuation">,</span>
                    <span class="token string">"cost"</span>: <span class="token number">404306</span>
                  } <span class="token comment">/* table_scan */</span><span class="token punctuation">,</span><span class="token comment">/*表扫描*/</span>
                  <span class="token string">"potential_range_indexes"</span>: <span class="token punctuation">[</span>
                    {
                      <span class="token string">"index"</span>: <span class="token string">"PRIMARY"</span><span class="token punctuation">,</span>
                      <span class="token string">"usable"</span>: <span class="token boolean">true</span><span class="token punctuation">,</span>
                      <span class="token string">"key_parts"</span>: <span class="token punctuation">[</span>
                        <span class="token string">"id"</span>
                      <span class="token punctuation">]</span> <span class="token comment">/* key_parts */</span>
                    }
                  <span class="token punctuation">]</span> <span class="token comment">/* potential_range_indexes */</span><span class="token punctuation">,</span>
                  <span class="token string">"setup_range_conditions"</span>: <span class="token punctuation">[</span> 
                  <span class="token punctuation">]</span> <span class="token comment">/* 设置条件范围 */</span><span class="token punctuation">,</span>
                  <span class="token string">"group_index_range"</span>: {
                    <span class="token string">"chosen"</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token string">"cause"</span>: <span class="token string">"not_group_by_or_distinct"</span>
                  } <span class="token comment">/* group_index_range */</span><span class="token punctuation">,</span>
                  <span class="token string">"skip_scan_range"</span>: {
                    <span class="token string">"potential_skip_scan_indexes"</span>: <span class="token punctuation">[</span>
                      {
                        <span class="token string">"index"</span>: <span class="token string">"PRIMARY"</span><span class="token punctuation">,</span>
                        <span class="token string">"usable"</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">"cause"</span>: <span class="token string">"query_references_nonkey_column"</span>
                      }
                    <span class="token punctuation">]</span> <span class="token comment">/* potential_skip_scan_indexes */</span>
                  } <span class="token comment">/* skip_scan_range */</span><span class="token punctuation">,</span>
                  <span class="token string">"analyzing_range_alternatives"</span>: {<!-- --><span class="token comment">/*分析范围选项*/</span>
                    <span class="token string">"range_scan_alternatives"</span>: <span class="token punctuation">[</span>
                      {
                        <span class="token string">"index"</span>: <span class="token string">"PRIMARY"</span><span class="token punctuation">,</span>
                        <span class="token string">"ranges"</span>: <span class="token punctuation">[</span>
                          <span class="token string">"id &lt; 10"</span>
                        <span class="token punctuation">]</span> <span class="token comment">/* ranges */</span><span class="token punctuation">,</span>
                        <span class="token string">"index_dives_for_eq_ranges"</span>: <span class="token boolean">true</span><span class="token punctuation">,</span>
                        <span class="token string">"rowid_ordered"</span>: <span class="token boolean">true</span><span class="token punctuation">,</span>
                        <span class="token string">"using_mrr"</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">"index_only"</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">"in_memory"</span>: <span class="token number">0.159895</span><span class="token punctuation">,</span>
                        <span class="token string">"rows"</span>: <span class="token number">9</span><span class="token punctuation">,</span>
                        <span class="token string">"cost"</span>: <span class="token number">1.79883</span><span class="token punctuation">,</span>
                        <span class="token string">"chosen"</span>: <span class="token boolean">true</span>
                      }
                    <span class="token punctuation">]</span> <span class="token comment">/* range_scan_alternatives */</span><span class="token punctuation">,</span>
                    <span class="token string">"analyzing_roworder_intersect"</span>: {
                      <span class="token string">"usable"</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                      <span class="token string">"cause"</span>: <span class="token string">"too_few_roworder_scans"</span>
                    } <span class="token comment">/* analyzing_roworder_intersect */</span>
                  } <span class="token comment">/* analyzing_range_alternatives */</span><span class="token punctuation">,</span>
                  <span class="token string">"chosen_range_access_summary"</span>: {<!-- --><span class="token comment">/*选择范围访问摘要*/</span>
                    <span class="token string">"range_access_plan"</span>: {
                      <span class="token string">"type"</span>: <span class="token string">"range_scan"</span><span class="token punctuation">,</span>
                      <span class="token string">"index"</span>: <span class="token string">"PRIMARY"</span><span class="token punctuation">,</span>
                      <span class="token string">"rows"</span>: <span class="token number">9</span><span class="token punctuation">,</span>
                      <span class="token string">"ranges"</span>: <span class="token punctuation">[</span>
                        <span class="token string">"id &lt; 10"</span>
                      <span class="token punctuation">]</span> <span class="token comment">/* ranges */</span>
                    } <span class="token comment">/* range_access_plan */</span><span class="token punctuation">,</span>
                    <span class="token string">"rows_for_plan"</span>: <span class="token number">9</span><span class="token punctuation">,</span>
                    <span class="token string">"cost_for_plan"</span>: <span class="token number">1.79883</span><span class="token punctuation">,</span>
                    <span class="token string">"chosen"</span>: <span class="token boolean">true</span>
                  } <span class="token comment">/* chosen_range_access_summary */</span>
                } <span class="token comment">/* range_analysis */</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* rows_estimation */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">"considered_execution_plans"</span>: <span class="token punctuation">[</span><span class="token comment">/*考虑执行计划*/</span>
              {
                <span class="token string">"plan_prefix"</span>: <span class="token punctuation">[</span>
                <span class="token punctuation">]</span> <span class="token comment">/* plan_prefix */</span><span class="token punctuation">,</span>
                <span class="token string">"table"</span>: <span class="token string">"`student`"</span><span class="token punctuation">,</span>
                <span class="token string">"best_access_path"</span>: {<!-- --><span class="token comment">/*最佳访问路径*/</span>
                  <span class="token string">"considered_access_paths"</span>: <span class="token punctuation">[</span>
                    {
                      <span class="token string">"rows_to_scan"</span>: <span class="token number">9</span><span class="token punctuation">,</span>
                      <span class="token string">"access_type"</span>: <span class="token string">"range"</span><span class="token punctuation">,</span>
                      <span class="token string">"range_details"</span>: {
                        <span class="token string">"used_index"</span>: <span class="token string">"PRIMARY"</span>
                      } <span class="token comment">/* range_details */</span><span class="token punctuation">,</span>
                      <span class="token string">"resulting_rows"</span>: <span class="token number">9</span><span class="token punctuation">,</span>
                      <span class="token string">"cost"</span>: <span class="token number">2.69883</span><span class="token punctuation">,</span>
                      <span class="token string">"chosen"</span>: <span class="token boolean">true</span>
                    }
                  <span class="token punctuation">]</span> <span class="token comment">/* considered_access_paths */</span>
                } <span class="token comment">/* best_access_path */</span><span class="token punctuation">,</span>
                <span class="token string">"condition_filtering_pct"</span>: <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">/*行过滤百分比*/</span>
                <span class="token string">"rows_for_plan"</span>: <span class="token number">9</span><span class="token punctuation">,</span>
                <span class="token string">"cost_for_plan"</span>: <span class="token number">2.69883</span><span class="token punctuation">,</span>
                <span class="token string">"chosen"</span>: <span class="token boolean">true</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* considered_execution_plans */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">"attaching_conditions_to_tables"</span>: { <span class="token comment">/*将条件附加到表上*/</span>
              <span class="token string">"original_condition"</span>: <span class="token string">"(`student`.`id` &lt; 10)"</span><span class="token punctuation">,</span>
              <span class="token string">"attached_conditions_computation"</span>: <span class="token punctuation">[</span>
              <span class="token punctuation">]</span> <span class="token comment">/* attached_conditions_computation */</span><span class="token punctuation">,</span>
              <span class="token string">"attached_conditions_summary"</span>: <span class="token punctuation">[</span> <span class="token comment">/*附加条件概要*/</span>
                {
                  <span class="token string">"table"</span>: <span class="token string">"`student`"</span><span class="token punctuation">,</span>
                  <span class="token string">"attached"</span>: <span class="token string">"(`student`.`id` &lt; 10)"</span>
                }
              <span class="token punctuation">]</span> <span class="token comment">/* attached_conditions_summary */</span>
            } <span class="token comment">/* attaching_conditions_to_tables */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">"finalizing_table_conditions"</span>: <span class="token punctuation">[</span>
              {
                <span class="token string">"table"</span>: <span class="token string">"`student`"</span><span class="token punctuation">,</span>
                <span class="token string">"original_table_condition"</span>: <span class="token string">"(`student`.`id` &lt; 10)"</span><span class="token punctuation">,</span>
                <span class="token string">"final_table_condition   "</span>: <span class="token string">"(`student`.`id` &lt; 10)"</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* finalizing_table_conditions */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">"refine_plan"</span>: <span class="token punctuation">[</span> <span class="token comment">/*精简计划*/</span>
              {
                <span class="token string">"table"</span>: <span class="token string">"`student`"</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* refine_plan */</span>
          }
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      } <span class="token comment">/* join_optimization */</span>
    }<span class="token punctuation">,</span>
    {
      <span class="token string">"join_execution"</span>: {  <span class="token comment">/*执行*/</span>
        <span class="token string">"select#"</span>: <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"steps"</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      } <span class="token comment">/* join_execution */</span>
    }
  <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
}
<span class="token operator">/</span>
<span class="token comment">/*第3部分：跟踪信息过长时，被截断的跟踪信息的字节数。*/</span>
MISSING_BYTES_BEYOND_MAX_MEM_SIZE: <span class="token number">0</span> <span class="token comment">/*丢失的超出最大容量的字节*/</span>
<span class="token comment">/*第4部分：执行跟踪语句的用户是否有查看对象的权限。当不具有权限时，该列信息为1且TRACE字段为空，一般在
调用带有SQL SECURITY DEFINER的视图或者是存储过程的情况下，会出现此问题。*/</span>
INSUFFICIENT_PRIVILEGES: <span class="token number">0</span> <span class="token comment">/*缺失权限*/</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="9_MySQLsys_schema_2446"></a>9. MySQL监控分析视图-sys schema</h3> 
<p>关于MySQL的性能监控和问题诊断，我们一般都从performance_schema中去获取想要的数据，在MySQL5.7.7版本中新增sys schema,它将performance_schema和information_schema中的数据以更容易理解的方式总结归纳为”视图”，其目的就是为了<code>降低查询performance_schema的复杂度</code>，让DBA能够快速的定位问题。下面看看这些库中都有哪些监控表和视图，掌握了这些，在我们开发和运维的过程中就起到了事半功倍的效果。</p> 
<h4><a id="91_Sys_schema_2449"></a>9.1 Sys schema视图摘要</h4> 
<p><strong>1. 主机相关</strong>：以host_summary开头，主要汇总了IO延迟的信息。</p> 
<p><strong>2. Innodb相关</strong>：以innodb开头，汇总了innodb buffer信息和事务等待innodb锁的信息。</p> 
<p><strong>3. I/o相关</strong>：以io开头，汇总了等待I/O、I/O使用量情况。</p> 
<p><strong>4.内存使用情况</strong>：以memory开头，从主机、线程、事件等角度展示内存的使用情况</p> 
<p><strong>5.连接与会话信息</strong>：processlist和session相关视图，总结了会话相关信息。</p> 
<p><strong>6. 表相关</strong>：以schema_table开头的视图，展示了表的统计信息。</p> 
<p><strong>7. 索引信息</strong>：统计了索引的使用情况，包含冗余索引和未使用的索引情况。</p> 
<p><strong>8.语句相关</strong>：以statement开头，包含执行全表扫描、使用临时表、排序等的语句信息。</p> 
<p><strong>9. 用户相关</strong>：以user开头的视图，统计了用户使用的文件I/O、执行语句统计信息。</p> 
<p><strong>10.等待事件相关信息</strong>：以wait开头，展示等待事件的延迟情况。</p> 
<h4><a id="92_Sys_schema_2471"></a>9.2 Sys schema视图使用场景</h4> 
<p><strong>索引情况</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">#1. 查询冗余索引</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>schema_redundant_indexes<span class="token punctuation">;</span>

<span class="token comment">#2. 查询未使用过的索引</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>schema_unused_indexes<span class="token punctuation">;</span>

<span class="token comment">#3. 查询索引的使用情况</span>
<span class="token keyword">select</span> index_name<span class="token punctuation">,</span>rows_selected<span class="token punctuation">,</span>rows_inserted<span class="token punctuation">,</span>rows_updated<span class="token punctuation">,</span>rows_deleted
<span class="token keyword">from</span> sys<span class="token punctuation">.</span>schema_index_statistics <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token string">'dbname'</span> <span class="token punctuation">;</span>
</code></pre> 
<p><strong>表相关</strong></p> 
<pre><code class="prism language-sql"><span class="token comment"># 1. 查询表的访问量</span>
<span class="token keyword">select</span> table_schema<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>io_read_requests<span class="token operator">+</span>io_write_requests<span class="token punctuation">)</span> <span class="token keyword">as</span> io <span class="token keyword">from</span>
sys<span class="token punctuation">.</span>schema_table_statistics <span class="token keyword">group</span> <span class="token keyword">by</span> table_schema<span class="token punctuation">,</span>table_name <span class="token keyword">order</span> <span class="token keyword">by</span> io <span class="token keyword">desc</span><span class="token punctuation">;</span>

<span class="token comment"># 2. 查询占用bufferpool较多的表</span>
<span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>allocated<span class="token punctuation">,</span><span class="token keyword">data</span>
<span class="token keyword">from</span> sys<span class="token punctuation">.</span>innodb_buffer_stats_by_table <span class="token keyword">order</span> <span class="token keyword">by</span> allocated <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment"># 3. 查看表的全表扫描情况</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>statements_with_full_table_scans <span class="token keyword">where</span> db<span class="token operator">=</span><span class="token string">'dbname'</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>语句相关</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">#1. 监控SQL执行的频率</span>
<span class="token keyword">select</span> db<span class="token punctuation">,</span>exec_count<span class="token punctuation">,</span>query <span class="token keyword">from</span> sys<span class="token punctuation">.</span>statement_analysis
<span class="token keyword">order</span> <span class="token keyword">by</span> exec_count <span class="token keyword">desc</span><span class="token punctuation">;</span>

<span class="token comment">#2. 监控使用了排序的SQL</span>
<span class="token keyword">select</span> db<span class="token punctuation">,</span>exec_count<span class="token punctuation">,</span>first_seen<span class="token punctuation">,</span>last_seen<span class="token punctuation">,</span>query
<span class="token keyword">from</span> sys<span class="token punctuation">.</span>statements_with_sorting <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">#3. 监控使用了临时表或者磁盘临时表的SQL</span>
<span class="token keyword">select</span> db<span class="token punctuation">,</span>exec_count<span class="token punctuation">,</span>tmp_tables<span class="token punctuation">,</span>tmp_disk_tables<span class="token punctuation">,</span>query
<span class="token keyword">from</span> sys<span class="token punctuation">.</span>statement_analysis <span class="token keyword">where</span> tmp_tables<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">or</span> tmp_disk_tables <span class="token operator">&gt;</span><span class="token number">0</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>tmp_tables<span class="token operator">+</span>tmp_disk_tables<span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>IO 相关</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">#1. 查看消耗磁盘IO的文件</span>
<span class="token keyword">select</span> <span class="token keyword">file</span><span class="token punctuation">,</span>avg_read<span class="token punctuation">,</span>avg_write<span class="token punctuation">,</span>avg_read<span class="token operator">+</span>avg_write <span class="token keyword">as</span> avg_io
<span class="token keyword">from</span> sys<span class="token punctuation">.</span>io_global_by_file_by_bytes <span class="token keyword">order</span> <span class="token keyword">by</span> avg_read <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>Innodb 相关</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">#1. 行锁阻塞情况</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>innodb_lock_waits<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>风险提示:</p> 
 <p>通过sys库去查询时，MySQL会消耗大量资源去收集相关信息，严重的可能会导致业务请求被阻塞，从而引起故障。建议生产上<code>不要频繁</code>的去查询sys或者performance_schema、information_schema来完成监控、巡检等工作。</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5bf9b88e1459bd8b602ac67bf8857c77/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【模板】割点（割边）Tarjan</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c542989f798d913245594adf4a2cce51/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SQL查询语句之查询数据</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>