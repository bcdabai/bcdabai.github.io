<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【微信小程序开发】【源码学习】基于微信小程序的地图获取地点信息 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【微信小程序开发】【源码学习】基于微信小程序的地图获取地点信息" />
<meta property="og:description" content="源码来源 微信小程序地图获取地点信息（打卡签到功能为例）-2020-7-26
十分感谢作者能将代码分享出来让我们学习参考，如有侵权联系删除
准备工作 前提是要了解腾讯位置服务获取自己的key并且配置在项目中,可以看这篇文章来进行配置
【微信小程序开发】微信小程序集成腾讯位置项目配置
js源码解析 wxml与wxss的代码这里暂且就不做解析了，主要是功能实现的解析
一、require分析 这里作者一共在Page前require了这些数据，其中
util常量是作者自己写的一些工具方法，主要是对时间的处理app常量是获取app.js中的数据，为了让qqmapsdk来获取app.js中数据来进行核心业务逻辑的实现urlList是作者用工具类配置向后台请求数据的部分代码qqmapsdk是实例化API的核心类 // location_check_in/location_check_in.js const util = require(&#39;../../utils/util&#39;) // getAPP()相当于获得app.js中的数据 const app = getApp() // 发送wx.request请求 const urlList = require(&#34;../../utils/api.js&#34;) // 根据实际项目自己配置 // 实例化API核心类 // 相当于从app.js 中拿到 globalData 中的 qqmapsdk const qqmapsdk = app.globalData.qqmapsdk 二、Page页面逻辑分析 这里每一个方法上都给出了注释，我这里就不一一赘述了，主要是每个方法的具体实现
1.data 正常代码阅读逻辑应该是先从生命周期函数onLoad读起，碰到变量后再去data中查看对应的意思，但是对于写文章来说会逻辑过于混乱，所以我们这里直接吧data中的每个变量的含义进行解析
一共有这些数据，下面我们来一一剖析一下
markers，这个变量主要是用于我们后续getAddress中获取当前地址信息的作用，其中的每个数据我都给出了注释解释poi，就是单纯地存储getAddress中的经纬度信息addressName，是获取当前位置的名称time，是获取当前时间，用于前端显示，只显示时分秒timer，适用于存储每秒调用setINterval获取时间这个方法的返回值，用于程序结束后停止运行这个方法，以免浪费空间timer2，与timer同理，不过这个是每20秒重新获取地址信息的setINtervalcanClick，主要用于防止用户多次点击签到，让用户只能签到一次 data: { // markers： 也就是getAddress中的msk // 获取当前地点的 // 地名 title // 经度 longitude // 维度 latitude // 当前所在位置显示的图标路径 iconPath // 图片的宽高？ width height markers: &#39;&#39;, // poi: 也就是位置的经纬度(没有给定位置默认为当前位置) poi: { latitude: &#39;&#39;, longitude: &#39;&#39; }, // 当前地点的地点名 addressName: &#39;&#39;, // time是获取当前时间 只取时分秒 time: &#39;&#39;, // 是setInterval的返回值 // 返回的值是当前setInterval的id // 为什么要返回这个值呢？因为有的时候要涉及到clearInterval，clearInterval(id)就能删除相应的setInterval了 // 每秒获取时间的setInterval的id timer: &#39;&#39;, // 同上，只不过是每20秒获取一次当前的定位信息的setInterval的id timer2: &#39;&#39;, // 用来每个一段时间自动刷新一次定位 // 允许用户点击，防止多次提交 // 在checkIn函数中，代表签到只能进行一次 canClick: true }, 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fd112f4ffdf0068603897e7ca27eeecd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-02T17:26:45+08:00" />
<meta property="article:modified_time" content="2023-05-02T17:26:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【微信小程序开发】【源码学习】基于微信小程序的地图获取地点信息</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <h2><a id="_0"></a>源码来源</h2> 
</blockquote> 
<p><a href="https://blog.csdn.net/qq_37177115/article/details/114028871">微信小程序地图获取地点信息（打卡签到功能为例）-2020-7-26</a><br> 十分感谢作者能将代码分享出来让我们学习参考，如有侵权联系删除</p> 
<blockquote> 
 <h2><a id="_3"></a>准备工作</h2> 
</blockquote> 
<p>前提是要了解腾讯位置服务获取自己的<code>key</code>并且配置在项目中,可以看这篇文章来进行配置<br> <a href="https://blog.csdn.net/Elephant_King/article/details/130357345?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22130357345%22%2C%22source%22%3A%22Elephant_King%22%7D">【微信小程序开发】微信小程序集成腾讯位置项目配置</a></p> 
<blockquote> 
 <h2><a id="js_6"></a>js源码解析</h2> 
</blockquote> 
<p><code>wxml</code>与<code>wxss</code>的代码这里暂且就不做解析了，主要是功能实现的解析</p> 
<h3><a id="require_8"></a>一、require分析</h3> 
<p><img src="https://images2.imgbox.com/2c/9c/U2hrQz0q_o.png" alt="在这里插入图片描述"><br> 这里作者一共在<code>Page</code>前<code>require</code>了这些数据，其中</p> 
<ul><li><code>util</code>常量是作者自己写的一些工具方法，主要是对时间的处理</li><li><code>app</code>常量是获取<code>app.js</code>中的数据，为了让<code>qqmapsdk</code>来获取<code>app.js</code>中数据来进行核心业务逻辑的实现</li><li><code>urlList</code>是作者用工具类配置向后台请求数据的部分代码</li><li><code>qqmapsdk</code>是实例化<code>API</code>的核心类</li></ul> 
<pre><code class="prism language-js"><span class="token comment">// location_check_in/location_check_in.js</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../utils/util'</span><span class="token punctuation">)</span>

<span class="token comment">// getAPP()相当于获得app.js中的数据</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 发送wx.request请求</span>
<span class="token keyword">const</span> urlList <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../../utils/api.js"</span><span class="token punctuation">)</span>  <span class="token comment">// 根据实际项目自己配置</span>

<span class="token comment">// 实例化API核心类</span>
<span class="token comment">// 相当于从app.js 中拿到 globalData 中的 qqmapsdk</span>
<span class="token keyword">const</span> qqmapsdk <span class="token operator">=</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>qqmapsdk
</code></pre> 
<h3><a id="Page_30"></a>二、Page页面逻辑分析</h3> 
<p><img src="https://images2.imgbox.com/fe/03/TnDVGkC0_o.png" alt="在这里插入图片描述"><br> 这里每一个方法上都给出了注释，我这里就不一一赘述了，主要是每个方法的具体实现</p> 
<h4><a id="1data_33"></a>1.data</h4> 
<p>正常代码阅读逻辑应该是先从生命周期函数<code>onLoad</code>读起，碰到变量后再去<code>data</code>中查看对应的意思，但是对于写文章来说会逻辑过于混乱，所以我们这里直接吧<code>data</code>中的每个变量的含义进行解析<br> <img src="https://images2.imgbox.com/b7/6f/TGEUmdEh_o.png" alt="在这里插入图片描述"><br> 一共有这些数据，下面我们来一一剖析一下</p> 
<ul><li><code>markers</code>，这个变量主要是用于我们后续<code>getAddress</code>中获取当前地址信息的作用，其中的每个数据我都给出了注释解释</li><li><code>poi</code>，就是单纯地存储<code>getAddress</code>中的经纬度信息</li><li><code>addressName</code>，是获取当前位置的名称</li><li><code>time</code>，是获取当前时间，用于前端显示，只显示<code>时分秒</code></li><li><code>timer</code>，适用于存储每秒调用<code>setINterval</code>获取时间这个方法的返回值，用于程序结束后停止运行这个方法，以免浪费空间</li><li><code>timer2</code>，与<code>timer</code>同理，不过这个是每<code>20秒</code>重新获取地址信息的<code>setINterval</code></li><li><code>canClick</code>，主要用于防止用户多次点击签到，让用户只能签到一次</li></ul> 
<pre><code class="prism language-js"><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// markers：    也就是getAddress中的msk</span>
    <span class="token comment">// 获取当前地点的</span>
        <span class="token comment">// 地名 title</span>
        <span class="token comment">// 经度 longitude</span>
        <span class="token comment">// 维度 latitude</span>
        <span class="token comment">// 当前所在位置显示的图标路径   iconPath</span>
        <span class="token comment">// 图片的宽高？ width   height</span>
    <span class="token literal-property property">markers</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">// poi:     也就是位置的经纬度(没有给定位置默认为当前位置)</span>
    <span class="token literal-property property">poi</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">latitude</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token literal-property property">longitude</span><span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 当前地点的地点名</span>
    <span class="token literal-property property">addressName</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">// time是获取当前时间 只取时分秒</span>
    <span class="token literal-property property">time</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">// 是setInterval的返回值</span>
    <span class="token comment">// 返回的值是当前setInterval的id</span>
    <span class="token comment">// 为什么要返回这个值呢？因为有的时候要涉及到clearInterval，clearInterval(id)就能删除相应的setInterval了</span>
    <span class="token comment">// 每秒获取时间的setInterval的id</span>
    <span class="token literal-property property">timer</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">// 同上，只不过是每20秒获取一次当前的定位信息的setInterval的id</span>
    <span class="token literal-property property">timer2</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>  <span class="token comment">// 用来每个一段时间自动刷新一次定位</span>
    <span class="token comment">// 允许用户点击，防止多次提交</span>
    <span class="token comment">// 在checkIn函数中，代表签到只能进行一次</span>
    <span class="token literal-property property">canClick</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="2onLoad_76"></a>2.onLoad</h4> 
<p><img src="https://images2.imgbox.com/92/fa/DOuYRuts_o.png" alt="在这里插入图片描述"></p> 
<p>我们可以看到，页面打开主要干了三件事</p> 
<ul><li>调用了<code>getTime</code>方法</li><li>调用了<code>getAddress</code>方法</li><li>将<code>canClick</code>参数变为<code>ture</code>，代表用户可以点击签到按钮，并且每20秒重新调用一次<code>getAddress</code>方法，来对当前定位进行刷新</li></ul> 
<pre><code class="prism language-js"><span class="token comment">//   页面打开时发生</span>
  <span class="token function-variable function">onLoad</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    that<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    that<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">canClick</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 允许用户点击，防止多次提交</span>
      <span class="token literal-property property">timer2</span><span class="token operator">:</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        that<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">20000</span><span class="token punctuation">)</span>  <span class="token comment">// 每20秒刷新一次定位</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="3getTime_97"></a>3.getTime方法</h4> 
<p>既然页面第一个加载就是getTime方法，我们就来看一下获取时间这个方法具体是干什么，如何实现的<br> <img src="https://images2.imgbox.com/be/32/qweYiXPe_o.png" alt="在这里插入图片描述"><br> 每一步都给出了比较详细的解释，这里需要说的一共有两个点</p> 
<ul><li>调用了util工具类中的<code>formatDate</code>方法</li><li><code>time: time.substr(-8)</code>，这个主要是<code>formatDate</code>方法获得的是<code>年月日时分秒</code>，我们只需要<code>时分秒</code>，相当于<code>字符串前八位</code>是<code>年月日</code>我们省略了</li></ul> 
<pre><code class="prism language-js"><span class="token comment">// 获取时间</span>
  <span class="token function-variable function">getTime</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 设置一个临时变量time等于data内的time</span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>time
    that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// setInterval是一个实现定时调用的函数，可按照指定的周期（以毫秒计）来调用函数或计算表达式</span>
      <span class="token comment">// 本函数1000毫秒（1秒）调用一次</span>
      <span class="token literal-property property">timer</span><span class="token operator">:</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">// 获取当前时间</span>
        <span class="token comment">// 格式为</span>
        <span class="token comment">// 2023/05/02 15:18:41</span>
        time <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 相当于只取时分秒，不取年月日</span>
          <span class="token comment">// 格式为</span>
          <span class="token comment">// 15:24:01</span>
          <span class="token literal-property property">time</span><span class="token operator">:</span> time<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 页面跳转后，要把定时器清空掉，免得浪费性能</span>
          <span class="token comment">// clearInterval()函数是在JavaScript中用于取消setInterval()函数设定的定时执行操作。</span>
          <span class="token comment">// 相当于把每秒调用的这个函数关掉</span>
          <span class="token function">clearInterval</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>timer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h5><a id="1utilformatDate_135"></a>(1)util工具类中的formatDate方法</h5> 
<p><img src="https://images2.imgbox.com/2b/e3/T2NiPvuR_o.png" alt="在这里插入图片描述"></p> 
<p>这里没什么理解难点</p> 
<ul><li>注意一下<code>ES6</code>语法的箭头表达式</li><li>还有最后<code>return</code>中的返回形式，在注释中也有比较详细的解答</li><li><code>return</code>中还调用了一个<code>formatNumber</code></li></ul> 
<pre><code class="prism language-js"><span class="token comment">// 这里用到了ES6特性的箭头函数</span>
<span class="token comment">// 具体可看https://blog.csdn.net/weixin_45709829/article/details/123931582?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168300966016800222859768%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=168300966016800222859768&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-123931582-null-null.142^v86^insert_down28,239^v2^insert_chatgpt&amp;utm_term=es6%20%E7%AE%AD%E5%A4%B4%E5%87%BD%E6%95%B0&amp;spm=1018.2226.3001.4187</span>
<span class="token keyword">const</span> <span class="token function-variable function">formatTime</span> <span class="token operator">=</span> <span class="token parameter">date</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// const只能被定义赋值一次，初始化结束后就不能被重新定义或赋值</span>
  <span class="token keyword">const</span> year <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> month <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token keyword">const</span> day <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> hour <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> minute <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> second <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment">// [year,month,day] = [2023,5,2]</span>

    <span class="token comment">// [year, month, day].map(formatNumber) = ["2023", "05", "02"]</span>

    <span class="token comment">// [year, month, day].map(formatNumber).join('/') = 2023/05/02</span>

    <span class="token comment">// [year, month, day].map(formatNumber).join('/') + ' ' = 2023/05/02 (多了一个空格)</span>

    <span class="token comment">// [year, month, day].map(formatNumber).join('/') + ' ' + [hour, minute, second] = </span>
    <span class="token comment">//2023/05/02 15,17,28</span>

    <span class="token comment">// [year, month, day].map(formatNumber).join('/') + ' ' + [hour, minute, second].map(formatNumber) = </span>
    <span class="token comment">// 2023/05/02 15,18,18</span>

    <span class="token comment">// [year, month, day].map(formatNumber).join('/') + ' ' + [hour, minute, second].map(formatNumber).join(':') = </span>
    <span class="token comment">// 2023/05/02 15:18:41</span>
    <span class="token comment">// 也就是说join相当于把数组中间插入一个特定字符后再变成字符串</span>
    <span class="token comment">// map相当于补零到两位数</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>formatNumber<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token punctuation">[</span>hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>formatNumber<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2utilformatNumber_177"></a>(2)util工具类中的formatNumber</h5> 
<p><img src="https://images2.imgbox.com/3f/39/KLzatMRW_o.png" alt="在这里插入图片描述"><br> 注释中给出了解释</p> 
<pre><code class="prism language-js"><span class="token comment">//   用于map，将不是字符串的转化为字符串</span>
<span class="token comment">// 再将一位的时间补0</span>
<span class="token comment">// 比如17:3:2 =&gt;17:03:02</span>
<span class="token keyword">const</span> <span class="token function-variable function">formatNumber</span> <span class="token operator">=</span> <span class="token parameter">n</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  n <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">?</span> n <span class="token operator">:</span> <span class="token string">'0'</span> <span class="token operator">+</span> n
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="4getAddress_190"></a>4.getAddress方法</h4> 
<p><img src="https://images2.imgbox.com/47/bb/GsJkJ6nw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3c/bc/evAt3NYl_o.png" alt="在这里插入图片描述"><br> 这里是比较长的，但是基本上都是官网给出的模板，主要用到了我们开头常量中<code>qqmapsdk</code>的<code>逆地址解析(坐标位置描述)函数</code><br> 其中官方文档为<a href="https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/methodReverseGeocoder" rel="nofollow">逆地址解析(坐标位置描述)</a></p> 
<pre><code class="prism language-js"><span class="token comment">//  获取地址</span>
  <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// reverseGeocoder 逆地址解析(坐标位置描述)</span>
    <span class="token comment">// 详见官方文档https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/methodReverseGeocoder</span>
    qqmapsdk<span class="token punctuation">.</span><span class="token function">reverseGeocoder</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">//位置坐标，默认获取当前位置，非必须参数</span>
      <span class="token comment">/**
       * 
        location: {
          latitude: 39.984060,
          longitude: 116.307520
        },
      */</span>
      <span class="token comment">// 成功后的回调</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// console.log(res);</span>
        that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">addressName</span><span class="token operator">:</span> res<span class="token punctuation">.</span>result<span class="token punctuation">.</span>address
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> res <span class="token operator">=</span> res<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
        <span class="token keyword">var</span> mks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//当get_poi为0时或者为不填默认值时，检索目标位置，按需使用</span>
        mks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// 获取返回结果，放到mks数组中</span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> res<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
          <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token comment">//   维度</span>
          <span class="token literal-property property">latitude</span><span class="token operator">:</span> res<span class="token punctuation">.</span>location<span class="token punctuation">.</span>lat<span class="token punctuation">,</span>
        <span class="token comment">//   地名</span>
          <span class="token literal-property property">longitude</span><span class="token operator">:</span> res<span class="token punctuation">.</span>location<span class="token punctuation">.</span>lng<span class="token punctuation">,</span>
        <span class="token comment">//   当前所在位置显示的图标路径</span>
          <span class="token literal-property property">iconPath</span><span class="token operator">:</span> <span class="token string">'../../images/zcxj/myPosition.png'</span><span class="token punctuation">,</span> <span class="token comment">// 图标路径</span>
        <span class="token comment">//   图标的像素？</span>
          <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
          <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">28</span><span class="token punctuation">,</span>
          <span class="token comment">// callout: { //在markers上展示地址名称，根据需求是否需要</span>
          <span class="token comment">//   content: res.address,</span>
          <span class="token comment">//   color: '#000',</span>
          <span class="token comment">//   display: 'ALWAYS'</span>
          <span class="token comment">// }</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// 设置markers属性和地图位置poi，将结果在地图展示</span>
          <span class="token literal-property property">markers</span><span class="token operator">:</span> mks<span class="token punctuation">,</span>
          <span class="token literal-property property">poi</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">latitude</span><span class="token operator">:</span> res<span class="token punctuation">.</span>location<span class="token punctuation">.</span>lat<span class="token punctuation">,</span>
            <span class="token literal-property property">longitude</span><span class="token operator">:</span> res<span class="token punctuation">.</span>location<span class="token punctuation">.</span>lng
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="5rePosition_254"></a>5.rePosition方法</h4> 
<p><img src="https://images2.imgbox.com/3f/69/KVeZaBAE_o.png" alt="在这里插入图片描述"><br> 用户在前端主动点击了重新定位，我们这里要调用<code>getAddress</code>重新获取定位</p> 
<pre><code class="prism language-js"><span class="token comment">//   用户在前端点击重新定位的按钮，重新请求位置</span>
  <span class="token function-variable function">rePosition</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户点了重新定位'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="6onUnload_264"></a>6.onUnload方法</h4> 
<p><img src="https://images2.imgbox.com/fd/1f/qTfdTqCH_o.png" alt="在这里插入图片描述"><br> 在用户退出时触发，主要用于将两个Interval关闭，以免浪费资源</p> 
<pre><code class="prism language-js"><span class="token comment">//   onunload 事件在用户退出页面时发生</span>
  <span class="token function-variable function">onUnload</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//   根据timer和timer2存储的id来</span>
    <span class="token comment">// 清除两个不断循环的setInterval</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>timer<span class="token punctuation">)</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>timer2<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"定时器已被清除"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="7checkIn_277"></a>7.checkIn方法</h4> 
<p><img src="https://images2.imgbox.com/7c/3a/nPBk5DYq_o.png" alt="在这里插入图片描述"><br> 用户在前端点击了签到按钮，我们先把<code>canClick</code>设置为<code>FALSE</code>，代表用户点了一次除非签到失败是不能点第二次的，然后获取当前时间以及地点名称，并返回给前端的用户，提示用户检查当前签到时间和地点是否有误，如果有误则将<code>canClick</code>改回<code>true</code>，代表本次签到未成功，用户还可以点击一次签到事件，如果成功，则唤起业务逻辑</p> 
<pre><code class="prism language-js"><span class="token comment">//   用户在前端点击了签到按钮</span>
  <span class="token function-variable function">checkIn</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 这里canClick代表签到按钮只能点一次</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">canClick</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户点击了签到'</span><span class="token punctuation">)</span>

    
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 重新获得当前时间</span>
    <span class="token keyword">var</span> nowTime <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 展示弹窗</span>
    wx<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'请确认打卡信息'</span><span class="token punctuation">,</span>
      <span class="token comment">// content: '请确认待整改项已整改完毕！',</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">地点：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>addressName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n时间：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>nowTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>  <span class="token comment">// 开发者工具上没有换行，真机调试时会有的</span>
      <span class="token literal-property property">confirmText</span><span class="token operator">:</span> <span class="token string">'确认'</span><span class="token punctuation">,</span>
      <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户点击确定'</span><span class="token punctuation">)</span>
          <span class="token comment">// 调起签到接口</span>
          that<span class="token punctuation">.</span><span class="token function">realyCheckIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>cancel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户点击取消'</span><span class="token punctuation">)</span>
          that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">canClick</span><span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="8realyCheckIn_316"></a>8.realyCheckIn方法</h4> 
<p><img src="https://images2.imgbox.com/dc/ea/5klUjzKy_o.png" alt="在这里插入图片描述"><br> 因为作者本身逻辑代码的隐私要求以及本人实在没看懂下面的代码，这里就只说到<code>request</code>向后台发送请求的部分，欢迎其他读者进行补充<br> 首先我们要向后端传输数据，需要传递<code>经纬度</code>，<code>用户信息</code>，<code>签到事件</code>等信息，所以我们将所有信息封装成<code>表单</code>来向后端进行发送</p> 
<pre><code class="prism language-js"><span class="token comment">//   签到业务逻辑实现</span>
  <span class="token function-variable function">realyCheckIn</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 其他需要一并提交过去的业务数据</span>
    <span class="token keyword">var</span> patrolForm <span class="token operator">=</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>patrolForm  

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>globalData<span class="token punctuation">)</span>
    <span class="token comment">// debugger</span>
    <span class="token comment">// 要在这里给 patrolForm 补充其他的参数</span>
    <span class="token comment">// 补充了当前地点的名称以及当前的时间</span>
    patrolForm<span class="token punctuation">.</span>checkaddress <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>addressName
    patrolForm<span class="token punctuation">.</span>searchtime <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 应该先判断用户有没有登录，没登录就授权登录</span>
    patrolForm<span class="token punctuation">.</span>searchuser <span class="token operator">=</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>user <span class="token operator">?</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>user<span class="token punctuation">.</span>UserName <span class="token operator">:</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>nickName
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"传给后台的 searchuser："</span><span class="token punctuation">,</span> patrolForm<span class="token punctuation">.</span>searchuser<span class="token punctuation">)</span>
    <span class="token comment">// 拼接："经度,纬度"</span>
    patrolForm<span class="token punctuation">.</span>latandlon <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>poi<span class="token punctuation">.</span>longitude <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>poi<span class="token punctuation">.</span>latitude
    

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>patrolForm<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"↑ 签到提交的post参数"</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> tmpNumber <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 向后端发送请求</span>
    wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> urlList<span class="token punctuation">.</span>submitCheckInInfo<span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> patrolForm<span class="token punctuation">,</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token comment">// 如果请求成功了</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>IsSuccess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 这里typeof是返回当前 res.data.IsSuccess 的数据类型，比如String Int</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>IsSuccess<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>IsSuccess<span class="token punctuation">)</span><span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"请求成功"</span><span class="token punctuation">)</span>
          <span class="token keyword">var</span> patrolId <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ReturnData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id
          <span class="token comment">// // 看怎么取到返回的id</span>
          <span class="token comment">// debugger</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>patrolForm<span class="token punctuation">.</span>img_arr1<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> patrolForm<span class="token punctuation">.</span>img_arr1<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              tmpNumber <span class="token operator">=</span> i
            <span class="token comment">//   上传图片</span>
              wx<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 图片上传的接口地址</span>
                <span class="token literal-property property">url</span><span class="token operator">:</span> urlList<span class="token punctuation">.</span>submitCheckInPhoto <span class="token operator">+</span> <span class="token string">"?patrolid="</span> <span class="token operator">+</span> patrolId<span class="token punctuation">,</span>
                <span class="token literal-property property">filePath</span><span class="token operator">:</span> patrolForm<span class="token punctuation">.</span>img_arr1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'content'</span><span class="token punctuation">,</span>
                <span class="token comment">// formData: {<!-- --></span>
                <span class="token comment">//   // 这里面可以携带一些参数一并传过去</span>
                <span class="token comment">//   patrolId: patrolId</span>
                <span class="token comment">// },</span>
                <span class="token comment">// header: {<!-- --></span>
                <span class="token comment">//   Authorization: token</span>
                <span class="token comment">// },</span>
                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token literal-property property">canClick</span><span class="token operator">:</span> <span class="token boolean">true</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// 因为上传图片是异步操作,所以会导致这里的 i 会取不到，故需要用个作用域更大点的变量来标识，否则 if 里面的代码不会执行</span>
                  <span class="token keyword">if</span><span class="token punctuation">(</span>tmpNumber <span class="token operator">===</span> patrolForm<span class="token punctuation">.</span>img_arr1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 有图片就等图片上传完了再返回首页</span>
                    wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'巡查签到成功！'</span><span class="token punctuation">,</span>
                      <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span>
                      <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
                      <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        wx<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                          <span class="token literal-property property">delta</span><span class="token operator">:</span> <span class="token number">2</span>  <span class="token comment">// 回退两层页面</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'巡查签到成功！'</span><span class="token punctuation">,</span>
              <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span>
              <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
              <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                wx<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                  <span class="token literal-property property">delta</span><span class="token operator">:</span> <span class="token number">2</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">canClick</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eaea90e3978f3b8aec9fefc2b5bb75a2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MinIO分布式存储服务</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/74ef609276bb828bffcb075146965847/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【微信小程序开发】微信小程序集成腾讯位置项目配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>