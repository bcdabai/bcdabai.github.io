<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tensorflow h5转pb - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Tensorflow h5转pb" />
<meta property="og:description" content="Tensorflow 2 h5转pb tensorflow 2中h5转pb比较简单，加载h5模型后，使用save_model即可
from tensorflow.keras import models models.load_model(&#39;model.h5&#39;) models.save_model(model, pb_outpath) 但因为tf2推荐使用saved_model格式，实际保存的是saved_model，即1个pb文件和两个文件夹。
Tensorflow 1 h5转pb 这里使用的是keras，首先加载模型，查看输入输出
from keras.models import load_model model = load_model(&#39;./model/keras_model.h5&#39;) print(model.outputs) # [&lt;tf.Tensor &#39;dense_2/Softmax:0&#39; shape=(?, 10) dtype=float32&gt;] print(model.inputs) # [&lt;tf.Tensor &#39;conv2d_1_input:0&#39; shape=(?, 28, 28, 1) dtype=float32&gt;] 获取模型序列化静态计算图
from keras import backend as K import tensorflow as tf def freeze_session(session, keep_var_names=None, output_names=None, clear_devices=True): &#34;&#34;&#34; Freezes the state of a session into a pruned computation graph. Creates a new computation graph where variable nodes are replaced by constants taking their current value in the session." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a5d99263148df62125063e079cc803e1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-03T16:46:40+08:00" />
<meta property="article:modified_time" content="2021-07-03T16:46:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Tensorflow h5转pb</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>Tensorflow 2 h5转pb</h2> 
<p>tensorflow 2中h5转pb比较简单，加载h5模型后，使用save_model即可</p> 
<pre><code class="language-python">from tensorflow.keras import models

models.load_model('model.h5')
models.save_model(model, pb_outpath)</code></pre> 
<p>但因为tf2推荐使用saved_model格式，实际保存的是saved_model，即1个pb文件和两个文件夹。</p> 
<p><img alt="" height="121" src="https://images2.imgbox.com/c8/4c/4REv7KUl_o.png" width="189"></p> 
<h2>Tensorflow 1 h5转pb</h2> 
<p>这里使用的是keras，首先加载模型，查看输入输出</p> 
<pre><code class="language-python">from keras.models import load_model
model = load_model('./model/keras_model.h5')
print(model.outputs)
# [&lt;tf.Tensor 'dense_2/Softmax:0' shape=(?, 10) dtype=float32&gt;]
print(model.inputs)
# [&lt;tf.Tensor 'conv2d_1_input:0' shape=(?, 28, 28, 1) dtype=float32&gt;]</code></pre> 
<p>获取模型序列化静态计算图</p> 
<pre><code class="language-python">from keras import backend as K
import tensorflow as tf

def freeze_session(session, keep_var_names=None, output_names=None, clear_devices=True):
    """
    Freezes the state of a session into a pruned computation graph.

    Creates a new computation graph where variable nodes are replaced by
    constants taking their current value in the session. The new graph will be
    pruned so subgraphs that are not necessary to compute the requested
    outputs are removed.
    @param session The TensorFlow session to be frozen.
    @param keep_var_names A list of variable names that should not be frozen,
                          or None to freeze all the variables in the graph.
    @param output_names Names of the relevant graph outputs.
    @param clear_devices Remove the device directives from the graph for better portability.
    @return The frozen graph definition.
    """
    from tensorflow.python.framework.graph_util import convert_variables_to_constants
    graph = session.graph
    with graph.as_default():
        freeze_var_names = list(set(v.op.name for v in tf.global_variables()).difference(keep_var_names or []))
        output_names = output_names or []
        output_names += [v.op.name for v in tf.global_variables()]
        # Graph -&gt; GraphDef ProtoBuf
        input_graph_def = graph.as_graph_def()
        if clear_devices:
            for node in input_graph_def.node:
                node.device = ""
        frozen_graph = convert_variables_to_constants(session, input_graph_def,
                                                      output_names, freeze_var_names)
        return frozen_graph


frozen_graph = freeze_session(K.get_session(),
                              output_names=[out.op.name for out in model.outputs])</code></pre> 
<p>将模型保存出二进制pb文件</p> 
<pre><code class="language-python"># Save to ./model/tf_model.pb
tf.train.write_graph(frozen_graph, "model", "tf_model.pb", as_text=False)</code></pre> 
<p>使用pb模型的话，首先加载pb文件中的计算图</p> 
<pre><code class="language-python">import tensorflow as tf
from tensorflow.python.platform import gfile

f = gfile.FastGFile("./model/tf_model.pb", 'rb')
graph_def = tf.GraphDef()
# Parses a serialized binary message into the current message.
graph_def.ParseFromString(f.read())
f.close()

sess.graph.as_default()
# Import a serialized TensorFlow `GraphDef` protocol buffer
# and place into the current default `Graph`.
tf.import_graph_def(graph_def)</code></pre> 
<p>指定输入输出，做预测</p> 
<pre><code class="language-python">softmax_tensor = sess.graph.get_tensor_by_name('import/dense_2/Softmax:0')
predictions = sess.run(softmax_tensor, {'import/conv2d_1_input:0': x_test[:20]})</code></pre> 
<p>参考：<a href="https://www.dlology.com/blog/how-to-convert-trained-keras-model-to-tensorflow-and-make-prediction/" rel="nofollow">如何将训练有素的 Keras 模型转换为单个 TensorFlow .pb 文件，并做出预测|直学 (dlology.com)</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/707153a79106837a69e572fe7f6b3f35/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot集成Mail功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a746825bcf615e760050f192d23a9236/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Game101现代计算机图形学作业1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>