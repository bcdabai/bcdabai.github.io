<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用Nacos bootstrap application 远程配置优先级 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用Nacos bootstrap application 远程配置优先级" />
<meta property="og:description" content="结论 先说结论，bootstrap配置文件中的与nacos服务相关的配置不会被application配置文件覆盖
但是如果想要在bootstrap中配置项目应用所需的属性，那么优先级低于application配置文件。会被覆盖
这也符合bootstrap本身是用于引导的作用。
至于nacos服务器上的配置，默认最大（可以配置修改），即使是命令参数也无法覆盖。
加载bootstrap配置文件 springBoot启动时当执行到prepareContext触发environmentPrepared事件，会触发BootstrapApplicationListener#onApplicationEvent
然后进入org.springframework.cloud.bootstrap.BootstrapApplicationListener#bootstrapServiceContext
StandardEnvironment bootstrapEnvironment = new StandardEnvironment(); //将默认Environment的PropertySource全部清空 MutablePropertySources bootstrapProperties = bootstrapEnvironment .getPropertySources(); for (PropertySource&lt;?&gt; source : bootstrapProperties) { bootstrapProperties.remove(source.getName()); } String configLocation = environment .resolvePlaceholders(&#34;${spring.cloud.bootstrap.location:}&#34;); Map&lt;String, Object&gt; bootstrapMap = new HashMap&lt;&gt;(); //将配置文件名指定为bootstrap bootstrapMap.put(&#34;spring.config.name&#34;, configName); ····省略代码··· SpringApplicationBuilder builder = new SpringApplicationBuilder() .profiles(environment.getActiveProfiles()) //不打印启动banner .bannerMode(Mode.OFF) //设置新创建的Environment .environment(bootstrapEnvironment) // Don&#39;t use the default properties in this builder .registerShutdownHook(false).logStartupInfo(false) .web(WebApplicationType.NONE); //设置primarySource为 BootstrapImportSelectorConfiguration builder.sources(BootstrapImportSelectorConfiguration.class); //又新创建了一个springCloud的springAplication final SpringApplication builderApplication = builder." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e1b146046aa679090f3f84fbe8052abd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-26T17:22:52+08:00" />
<meta property="article:modified_time" content="2022-11-26T17:22:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用Nacos bootstrap application 远程配置优先级</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>结论</h2> 
<p><strong>先说结论，bootstrap配置文件中的与nacos服务相关的配置不会被application配置文件覆盖</strong><br> <strong>但是如果想要在bootstrap中配置项目应用所需的属性，那么优先级低于application配置文件。会被覆盖</strong><br> <strong>这也符合bootstrap本身是用于引导的作用。</strong><br> <strong>至于nacos服务器上的配置，默认最大（可以配置修改），即使是命令参数也无法覆盖。</strong></p> 
<h2><a id="bootstrap_7"></a>加载bootstrap配置文件</h2> 
<p>springBoot启动时当执行到prepareContext触发environmentPrepared事件，会触发BootstrapApplicationListener#onApplicationEvent<br> 然后进入org.springframework.cloud.bootstrap.BootstrapApplicationListener#bootstrapServiceContext</p> 
<pre><code class="prism language-java">	<span class="token class-name">StandardEnvironment</span> bootstrapEnvironment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将默认Environment的PropertySource全部清空</span>
		<span class="token class-name">MutablePropertySources</span> bootstrapProperties <span class="token operator">=</span> bootstrapEnvironment
				<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">:</span> bootstrapProperties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			bootstrapProperties<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">String</span> configLocation <span class="token operator">=</span> environment
				<span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span><span class="token string">"${spring.cloud.bootstrap.location:}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> bootstrapMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将配置文件名指定为bootstrap</span>
		bootstrapMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"spring.config.name"</span><span class="token punctuation">,</span> configName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ····省略代码···
        	<span class="token class-name">SpringApplicationBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">profiles</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getActiveProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//不打印启动banner</span>
                <span class="token punctuation">.</span><span class="token function">bannerMode</span><span class="token punctuation">(</span><span class="token class-name">Mode</span><span class="token punctuation">.</span><span class="token constant">OFF</span><span class="token punctuation">)</span>
                <span class="token comment">//设置新创建的Environment</span>
				<span class="token punctuation">.</span><span class="token function">environment</span><span class="token punctuation">(</span>bootstrapEnvironment<span class="token punctuation">)</span>
				<span class="token comment">// Don't use the default properties in this builder</span>
				<span class="token punctuation">.</span><span class="token function">registerShutdownHook</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logStartupInfo</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">web</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationType</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//设置primarySource为 BootstrapImportSelectorConfiguration</span>
        builder<span class="token punctuation">.</span><span class="token function">sources</span><span class="token punctuation">(</span><span class="token class-name">BootstrapImportSelectorConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//又新创建了一个springCloud的springAplication </span>
        <span class="token keyword">final</span> <span class="token class-name">SpringApplication</span> builderApplication <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动这个新创建的applicationContext</span>
        <span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置祖先Initializer 后续执行时会把新创建的applicationContext中的配置加入到实际的applicationContext</span>
        <span class="token function">addAncestorInitializer</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre> 
<p>通过上面代码分析BootstrapApplicationListener新创建的springCloud的springApplication与主应用程序启动创建的application的<br> 区别：<br> 1、primarySource不同，扫描的basePackage不同<br> 2、不会打印banner<br> 3、加载的配置文件名称不同，新创建的加载配置文件名为bootstrap<br> 相同点：<br> 和启动时创建的springBoot相同，首先也从classpath/META-INF/spring.facotries文件中加载并实例化initializers和listeners，会在prepareContext时通过执行这些initializer操作applicationContext<br> 新创建的springApplication也会在ConfigFileApplicationListener中加载bootstrap中的配置文件并且围绕BootstrapImportSelectorConfiguration进行bean的加载<br> 创建的applicationContext会加载bootstrap.*配置文件，并且会合并到当前的applicationContext上的<br> environment中，通过addLast方法加到environment中MutablePropertySources的最后一个</p> 
<p>通过BootstrapApplicationListener创建的springCloud的springApplication中创建的applicationContext即bean工厂，，经过ApplicationContextInitializer处理，会成为主应用程序启动创建的application的parent，在尝试从bean工厂中获取bean时，如本工厂不存在，从parent工厂中获取。</p> 
<p><strong>注意apply方法</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">,</span>
			<span class="token class-name">SpringApplication</span> application<span class="token punctuation">,</span> <span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationContextInitializer</span><span class="token punctuation">&gt;</span></span> initializers <span class="token operator">=</span> <span class="token function">getOrderedBeansOfType</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
				<span class="token class-name">ApplicationContextInitializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		application<span class="token punctuation">.</span><span class="token function">addInitializers</span><span class="token punctuation">(</span>initializers
				<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationContextInitializer</span><span class="token punctuation">[</span>initializers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">addBootstrapDecryptInitializer</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>会将新创建出来的applicationContext中的ApplicationContextInitializer全部放到application中，后续执行<br> applyInitializers将会执行父容器的Initializer进行配置的拉取</p> 
<h2><a id="application_75"></a>加载application配置文件</h2> 
<p>springBoot启动时当执行到prepareContext触发environmentPrepared事件，也会触发ConfigFileApplicationListener，优先级比BootstrapApplicationListener要低，也就是要晚于BootstrapApplicationListener执行，因此bootstrap优先于application.xml加载（注意，先加载未必优先级更高）<br> 加载完毕调用addLast方法，放到environment。</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">FilteredPropertySource</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token constant">DEFAULT_PROPERTIES</span><span class="token punctuation">,</span> <span class="token constant">LOAD_FILTERED_PROPERTY</span><span class="token punctuation">,</span>
					<span class="token punctuation">(</span>defaultProperties<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>profiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>processedProfiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>activatedProfiles <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token function">initializeProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>profiles<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token class-name">Profile</span> profile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>profiles<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDefaultProfile</span><span class="token punctuation">(</span>profile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
								<span class="token function">addProfileToEnvironment</span><span class="token punctuation">(</span>profile<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							<span class="token function">load</span><span class="token punctuation">(</span>profile<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getPositiveProfileFilter</span><span class="token punctuation">,</span>
									<span class="token function">addToLoaded</span><span class="token punctuation">(</span><span class="token class-name">MutablePropertySources</span><span class="token operator">::</span><span class="token function">addLast</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">this</span><span class="token punctuation">.</span>processedProfiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>profile<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getNegativeProfileFilter</span><span class="token punctuation">,</span> <span class="token function">addToLoaded</span><span class="token punctuation">(</span><span class="token class-name">MutablePropertySources</span><span class="token operator">::</span><span class="token function">addFirst</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token function">addLoadedPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token function">applyActiveProfiles</span><span class="token punctuation">(</span>defaultProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre> 
<p>addLoadedPropertySources();会将配加载到的配置内用通过addLast方法放到 environment中MutablePropertySources的最后一个<br> 因为ConfigFileApplicationListener要比BootstrapApplicationListener优先级低，因此此时application配置文件要在bootstrap配置之后（越靠前优先级越高）</p> 
<h2><a id="_105"></a>处理父容器配置文件</h2> 
<p>在org.springframework.cloud.bootstrap.BootstrapApplicationListener#bootstrapServiceContext中</p> 
<pre><code class="prism language-java">  <span class="token comment">//设置祖先Initializer 后续执行时会把新创建的applicationContext中的配置加入到实际的applicationContext</span>
        <span class="token function">addAncestorInitializer</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>添加了一个AncestorInitializer<br> 那么在prepareContext中执行applyInitializers(context);<br> 会进入<br> org.springframework.cloud.bootstrap.BootstrapApplicationListener.AncestorInitializer#initialize</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				context <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>  
             <span class="token comment">//把父applicationContext中的配置加入到实际的applicationContext</span>
			<span class="token function">reorderSources</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">//执行父applicationContext的initialize</span>
			<span class="token keyword">new</span> <span class="token class-name">ParentContextApplicationContextInitializer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">/**
* The name of the default properties.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_PROPERTIES</span> <span class="token operator">=</span> <span class="token string">"springCloudDefaultProperties"</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reorderSources</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> removed <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_PROPERTIES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>removed <span class="token keyword">instanceof</span> <span class="token class-name">ExtendedDefaultPropertySource</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">ExtendedDefaultPropertySource</span> defaultProperties <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExtendedDefaultPropertySource</span><span class="token punctuation">)</span> removed<span class="token punctuation">;</span>
				environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span>
						<span class="token constant">DEFAULT_PROPERTIES</span><span class="token punctuation">,</span> defaultProperties<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">:</span> defaultProperties<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addBefore</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_PROPERTIES</span><span class="token punctuation">,</span>
								source<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

</code></pre> 
<p>这里会将父容器加载的配置文件springCloudDefaultProperties挨个拆出来放到当前environment MutablePropertySources的尾部<br> 那么此时bootstrap配置文件会放置到application后面</p> 
<h2><a id="nacos_159"></a>加载nacos服务器上配置</h2> 
<p>PropertySourceBootstrapConfiguration继承ApplicationContextInitializer接口<br> <strong>注意这个PropertySourceBootstrapConfiguration是父容器创建的！</strong><br> 那么在prepareContext中执行applyInitializers(context)也会执行PropertySourceBootstrapConfiguration</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">CompositePropertySource</span> composite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OriginTrackedCompositePropertySource</span><span class="token punctuation">(</span>
				<span class="token constant">BOOTSTRAP_PROPERTY_SOURCE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceLocators<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> empty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PropertySourceLocator</span> locator <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceLocators<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			source <span class="token operator">=</span> locator<span class="token punctuation">.</span><span class="token function">locate</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Located property source: "</span> <span class="token operator">+</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
			composite<span class="token punctuation">.</span><span class="token function">addPropertySource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
			empty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>empty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> logConfig <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span><span class="token string">"${logging.config:}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">LogFile</span> logFile <span class="token operator">=</span> <span class="token class-name">LogFile</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>propertySources<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">BOOTSTRAP_PROPERTY_SOURCE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				propertySources<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token constant">BOOTSTRAP_PROPERTY_SOURCE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">insertPropertySources</span><span class="token punctuation">(</span>propertySources<span class="token punctuation">,</span> composite<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">reinitializeLoggingSystem</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> logConfig<span class="token punctuation">,</span> logFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">setLogLevels</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">handleIncludedProfiles</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

</code></pre> 
<pre><code>source = locator.locate(environment);
</code></pre> 
<p>会调用nacos服务获取配置信息<br> 那么locate从哪里来呢</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertySourceLocator</span><span class="token punctuation">&gt;</span></span> propertySourceLocators <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>也就是从bean容器中获取，但是当前的applicationContext并没有创建这个bean<br> 看下doGetBean中的一段逻辑</p> 
<pre><code class="prism language-java">	<span class="token class-name">BeanFactory</span> parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Not found -&gt; check parent.</span>
				<span class="token class-name">String</span> nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doGetBean</span><span class="token punctuation">(</span>
							nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> args<span class="token punctuation">,</span> typeCheckOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// Delegation to parent with explicit args.</span>
					<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// No args -&gt; delegate to standard getBean method.</span>
					<span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

</code></pre> 
<p>由于<strong>PropertySourceBootstrapConfiguration是父容器创建的</strong>，生效的nacos服务器配置自然是bootstrap配置。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">insertPropertySources</span><span class="token punctuation">(</span><span class="token class-name">MutablePropertySources</span> propertySources<span class="token punctuation">,</span>
			<span class="token class-name">CompositePropertySource</span> composite<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">MutablePropertySources</span> incoming <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutablePropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		incoming<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>composite<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">PropertySourceBootstrapProperties</span> remoteProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PropertySourceBootstrapProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">environment</span><span class="token punctuation">(</span>incoming<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"spring.cloud.config"</span><span class="token punctuation">,</span>
				<span class="token class-name">Bindable</span><span class="token punctuation">.</span><span class="token function">ofInstance</span><span class="token punctuation">(</span>remoteProperties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>remoteProperties<span class="token punctuation">.</span><span class="token function">isAllowOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>remoteProperties<span class="token punctuation">.</span><span class="token function">isOverrideNone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token operator">&amp;&amp;</span> remoteProperties<span class="token punctuation">.</span><span class="token function">isOverrideSystemProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>composite<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>remoteProperties<span class="token punctuation">.</span><span class="token function">isOverrideNone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			propertySources<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>composite<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>propertySources
				<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">StandardEnvironment</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>remoteProperties<span class="token punctuation">.</span><span class="token function">isOverrideSystemProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				propertySources<span class="token punctuation">.</span><span class="token function">addAfter</span><span class="token punctuation">(</span>
						<span class="token class-name">StandardEnvironment</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME</span><span class="token punctuation">,</span>
						composite<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				propertySources<span class="token punctuation">.</span><span class="token function">addBefore</span><span class="token punctuation">(</span>
						<span class="token class-name">StandardEnvironment</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME</span><span class="token punctuation">,</span>
						composite<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			propertySources<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>composite<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

</code></pre> 
<p>根据PropertySourceBootstrapProperties判断nacos服务器上配置优先级，默认是addLast也就是放到优先级最高的位置。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bfa8d99d8c0d6481ca97f2b2f955f591/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Springboot项目，前端上传富文本内容给后台，后台接收到的内容有标签丢失。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f52e91b3166f5d47b06baf58dd455e0b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring(完整版)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>