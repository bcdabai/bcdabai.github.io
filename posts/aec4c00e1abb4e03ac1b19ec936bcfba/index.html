<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>6.监控、审计和运行时安全 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="6.监控、审计和运行时安全" />
<meta property="og:description" content="监控、审计和运行时安全 主要内容 ❖ 分析容器系统调用：Sysdig
❖ 监控容器运行时：Falco
❖ Kubernetes 审计日志
分析容器系统调用：Sysdig Sysdig简介 Sysdig：一个非常强大的系统监控、分析和故障排查工具。
汇聚 strace&#43;tcpdump&#43;htop&#43;iftop&#43;lsof 工具功能于一身！
sysdig 除了能获取系统资源利用率、进程、网络连接、系统调用等信息， 还具备了很强的分析能力，例如：
按照CPU使用率对进程排序
按照数据包对进程排序
打开最多的文件描述符进程
查看进程打开了哪些文件
查看进程的HTTP请求报文
查看机器上容器列表及资源使用情况
项目地址：https://github.com/draios/sysdig
文档：https://github.com/draios/sysdig/wiki
sysdig 通过在内核的驱动模块注册系统调用的 hook，这样当有系 统调用发生和完成的时候，它会把系统调用信息拷贝到特定的 buffer，然后用户态组件对数据信息处理（解压、解析、过滤等）， 并最终通过 sysdig 命令行和用户进行交互。
安装sysdig 导入sysdig的repo源，安装epel源。
安装完sysdig的时候，需要更新一下软件包，会更新sysdig，才能加载模块。
[root@master01 ~]# rpm --import https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public [root@master01 ~]# curl -s -o /etc/yum.repos.d/draios.repo https://s3.amazonaws.com/download.draios.com/stable/rpm/draios.repo [root@master01 ~]# yum install epel-release -y [root@master01 ~]# yum install sysdig -y [root@master01 ~]# yum update -y [root@master01 ~]# /usr/bin/sysdig-probe-loader # 加载驱动模块 sysdig常用参数 -l, --list：列出可用于过滤和输出的字段" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/aec4c00e1abb4e03ac1b19ec936bcfba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-04T15:48:32+08:00" />
<meta property="article:modified_time" content="2023-04-04T15:48:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">6.监控、审计和运行时安全</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>监控、审计和运行时安全</h2> 
<h4><a id="_2"></a>主要内容</h4> 
<p>❖ 分析容器系统调用：Sysdig</p> 
<p>❖ 监控容器运行时：Falco</p> 
<p>❖ Kubernetes 审计日志</p> 
<h4><a id="Sysdig_12"></a>分析容器系统调用：Sysdig</h4> 
<h5><a id="Sysdig_14"></a>Sysdig简介</h5> 
<p>Sysdig：一个非常强大的系统监控、分析和故障排查工具。</p> 
<p>汇聚 strace+tcpdump+htop+iftop+lsof 工具功能于一身！</p> 
<p>sysdig 除了能获取系统资源利用率、进程、网络连接、系统调用等信息， 还具备了很强的分析能力，例如：</p> 
<ul><li> <p>按照CPU使用率对进程排序</p> </li><li> <p>按照数据包对进程排序</p> </li><li> <p>打开最多的文件描述符进程</p> </li><li> <p>查看进程打开了哪些文件</p> </li><li> <p>查看进程的HTTP请求报文</p> </li><li> <p>查看机器上容器列表及资源使用情况</p> </li></ul> 
<p>项目地址：https://github.com/draios/sysdig</p> 
<p>文档：https://github.com/draios/sysdig/wiki</p> 
<p>sysdig 通过在内核的驱动模块注册系统调用的 hook，这样当有系 统调用发生和完成的时候，它会把系统调用信息拷贝到特定的 buffer，然后用户态组件对数据信息处理（解压、解析、过滤等）， 并最终通过 sysdig 命令行和用户进行交互。</p> 
<img src="https://images2.imgbox.com/f7/68/0bCygetd_o.png" alt="image-20220414220604964"> 
<h5><a id="sysdig_48"></a>安装sysdig</h5> 
<p>导入sysdig的repo源，安装epel源。</p> 
<p>安装完sysdig的时候，需要更新一下软件包，会更新sysdig，才能加载模块。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -o /etc/yum.repos.d/draios.repo https://s3.amazonaws.com/download.draios.com/stable/rpm/draios.repo</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install epel-release -y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install sysdig -y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum update -y </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># /usr/bin/sysdig-probe-loader # 加载驱动模块</span>
</code></pre> 
<h5><a id="sysdig_65"></a>sysdig常用参数</h5> 
<p><code>-l, --list</code>：列出可用于过滤和输出的字段</p> 
<p><code>-M</code> ：多少秒后停止收集</p> 
<p><code>-p</code> , --print= ：指定打印事件时使用的格式</p> 
<ul><li>使用-pc或-pcontainer 容器友好的格式</li><li>使用-pk或-pkubernetes k8s友好的格式</li></ul> 
<p><code>-c</code> ：指定内置工具，可直接完成具体的数据聚合、分析工作</p> 
<p><code>-w</code> ：保存到文件中</p> 
<p><code>-r</code> ：从文件中读取</p> 
<p>执行sysdig命令，实时输出大量系统调用。</p> 
<p>示例：59509 23:59:19.023099531 0 kubelet (1738) &lt; epoll_ctl</p> 
<p>格式：%evt.num %evt.outputtime %evt.cpu %proc.name (%thread.tid) %evt.dir %evt.type %evt.info</p> 
<p><code>evt.num</code>： 递增的事件号</p> 
<p><code>evt.time</code>： 事件发生的时间</p> 
<p><code>evt.cpu</code>： 事件被捕获时所在的 CPU，也就是系统调用是在哪个 CPU 执行的</p> 
<p><code>proc.name</code>： 生成事件的进程名字</p> 
<p><code>thread.tid</code>： 线程的 id，如果是单线程的程序，这也是进程的 pid</p> 
<p><code>evt.dir</code>： 事件的方向（direction），&gt; 代表进入事件，&lt; 代表退出事件</p> 
<p><code>evt.type</code>： 事件的名称，比如 open、stat等，一般是系统调用</p> 
<p><code>evt.args</code>： 事件的参数。如果是系统调用，这些对应着系统调用的参数</p> 
<blockquote> 
 <p><strong>自定义格式输出</strong>：<code>sysdig -p "user:%user.name time:%evt.time proc_name:%proc.name"</code></p> 
</blockquote> 
<h5><a id="sysdig_112"></a>sysdig过滤</h5> 
<ol><li><strong>fd：</strong> 根据文件描述符过滤，比如 fd 标号（fd.num）、fd 名字（fd.name）</li><li><strong>process：</strong> 根据进程信息过滤，比如进程 id（proc.id）、进程名（proc.name）</li><li><strong>evt：</strong> 根据事件信息过滤，比如事件编号、事件名</li><li><strong>user：</strong> 根据用户信息过滤，比如用户 id、用户名、用户 home 目录</li><li><strong>syslog：</strong> 根据系统日志过滤，比如日志的严重程度、日志的内容</li><li><strong>container：</strong> 根据容器信息过滤，比如容器ID、容器名称、容器镜像</li></ol> 
<p>查看完整过滤器列表：sysdig -l</p> 
<p>示例：</p> 
<p>1、查看一个进程的系统调用</p> 
<p>sysdig proc.name=kubelet</p> 
<p>2、查看建立TCP连接的事件</p> 
<p>sysdig evt.type=accept</p> 
<p>3、查看/etc目录下打开的文件描述符</p> 
<p>sysdig fd.name contains /etc</p> 
<p>4、查看容器的系统调用</p> 
<p>sysdig -M 10 container.name=web</p> 
<blockquote> 
 <p>注：还支持运算操作符，= 、!=、&gt;=、&gt;、&lt;、 &lt;=、contains、in 、exists、and、or、not</p> 
</blockquote> 
<h5><a id="Chisels_149"></a>Chisels工具箱</h5> 
<p><strong>Chisels：</strong> 实用的工具箱，一组预定义的功能集合，用来分析特定的场景。</p> 
<p><strong>sysdig –cl</strong> 列出所有Chisels，以下是一些常用的：</p> 
<ul><li>topprocs_cpu：输出按照 CPU 使用率排序的进程列表，例如sysdig -c</li><li>topprocs_net：输出进程使用网络TOP</li><li>topprocs_file：进程读写磁盘文件TOP</li><li>topfiles_bytes：读写磁盘文件TOP</li><li>netstat：列出网络的连接情况</li></ul> 
<h5><a id="_163"></a>其他常用命令</h5> 
<p>sysdig -c netstat<br> sysdig -c ps<br> sysdig -c lsof</p> 
<table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>网络</td><td># 查看使用网络的进程<br>TOP sysdig -c topprocs_net <br># 查看建立连接的端口 <br>sysdig -c fdcount_by fd.sport “evt.type=accept” -M 10 <br># 查看建立连接的端口 <br>sysdig -c fdbytes_by fd.sport <br># 查看建立连接的IP <br>sysdig -c fdcount_by fd.cip “evt.type=accept” -M 10 <br># 查看建立连接的IP <br>sysdig -c fdbytes_by fd.cip</td></tr><tr><td>硬盘</td><td># 查看进程磁盘I/O读写 <br>sysdig -c topprocs_file <br># 查看进程打开的文件描述符数量 <br>sysdig -c fdcount_by proc.name “fd.type=file” -M 10 <br># 查看读写磁盘文件 <br>sysdig -c topfiles_bytes sysdig -c topfiles_bytes proc.name=etcd <br># 查看/tmp目录读写磁盘活动文件 <br>sysdig -c fdbytes_by fd.filename “fd.directory=/tmp/”</td></tr><tr><td>CPU</td><td># 查看CPU使用率TOP <br>sysdig -c topprocs_cpu <br># 查看容器CPU使用率TOP <br>sysdig -pc -c topprocs_cpu container.name=web <br>sysdig -pc -c topprocs_cpu container.id=web</td></tr><tr><td>容器</td><td># 查看机器上容器列表及资源使用情况 <br>csysdig –vcontainers <br># 查看容器资源使用TOP <br>sysdig -c topcontainers_cpu/topcontainers_net/topcontainers_file</td></tr></tbody></table> 
<h4><a id="Falco_180"></a>监控容器运行时：Falco</h4> 
<h5><a id="Falco_182"></a>Falco简介</h5> 
<p>Falco 是一个 Linux 安全工具，它使用系统调用来保护和监控系统。 Falco最初是由Sysdig开发的，后来加入CNCF孵化器，成为首个加入CNCF的运行时安全项目。</p> 
<p>Falco提供了一组默认规则，可以监控内核态的异常行为，例如：</p> 
<ul><li>对于系统目录/etc, /usr/bin, /usr/sbin的读写行为</li><li>文件所有权、访问权限的变更</li><li>从容器打开shell会话</li><li>容器生成新进程</li><li>特权容器启动</li></ul> 
<p>项目地址：https://github.com/falcosecurity/falco</p> 
<h5><a id="Falco_200"></a>Falco架构图</h5> 
<p><img src="https://images2.imgbox.com/ed/cb/JsPqiGRd_o.png" alt="image-20220414231953852"></p> 
<h5><a id="falco_206"></a>安装falco</h5> 
<p>falco配置文件目录：/etc/falco</p> 
<ul><li><code>falco.yaml</code> falco配置与输出告警通知方式</li><li><code>falco_rules.yaml</code> 规则文件，默认已经定义很多威胁场景</li><li><code>falco_rules.local.yaml</code> 自定义扩展规则文件</li><li><code>k8s_audit_rules.yaml</code> K8s审计日志规则</li></ul> 
<p>安装文档：https://falco.org/zh/docs/installation</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://falco.org/repo/falcosecurity-3672BA8F.asc</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -o /etc/yum.repos.d/falcosecurity.repo https://falco.org/repo/falcosecurity-rpm.repo</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install epel-release -y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum update</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install falco -y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start falco</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable falco</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># touch abc /usr/sbin/</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># tail -f /var/log/messages</span>

Apr <span class="token number">15</span> 02:04:03 master01 falco: 02:04:03.052503851: Error File below /etc opened <span class="token keyword">for</span> writing <span class="token punctuation">(</span>user<span class="token operator">=</span>root <span class="token assign-left variable">user_loginuid</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">command</span><span class="token operator">=</span>touch abc /usr/sbin/ <span class="token assign-left variable">parent</span><span class="token operator">=</span>bash <span class="token assign-left variable">pcmdline</span><span class="token operator">=</span>bash <span class="token assign-left variable">file</span><span class="token operator">=</span>/etc/falco/abc <span class="token assign-left variable">program</span><span class="token operator">=</span>touch <span class="token assign-left variable">gparent</span><span class="token operator">=</span>sshd <span class="token assign-left variable">ggparent</span><span class="token operator">=</span>sshd <span class="token assign-left variable">gggparent</span><span class="token operator">=</span>systemd <span class="token assign-left variable">container_id</span><span class="token operator">=</span>host <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token operator">&lt;</span>NA<span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="falco_235"></a>falco告警规则</h5> 
<p>告警规则示例（falco_rules.local.yaml）：</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># vim falco_rules.local.yaml</span>
<span class="token punctuation">-</span> <span class="token key atrule">rule</span><span class="token punctuation">:</span> The program "sudo" is run in a container
  <span class="token key atrule">desc</span><span class="token punctuation">:</span> An event will trigger every time you run sudo in a container
  <span class="token key atrule">condition</span><span class="token punctuation">:</span> evt.type = execve and evt.dir=&lt; and container.id <span class="token tag">!=</span> host and proc.name = sudo
  <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token string">"Sudo run in container (user=%user.name %container.info parent=%proc.pname cmdline=%proc.cmdline)"</span>
  <span class="token key atrule">priority</span><span class="token punctuation">:</span> ERROR
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>users<span class="token punctuation">,</span> container<span class="token punctuation">]</span>
</code></pre> 
<h5><a id="_251"></a>参数说明</h5> 
<ul><li><code>rule</code>：规则名称，唯一</li><li><code>desc</code>：规则的描述</li><li><code>condition</code>： 条件表达式</li><li><code>output</code>：符合条件事件的输出格式</li><li><code>priority</code>：告警的优先级</li><li><code>tags</code>：本条规则的 tags 分类</li></ul> 
<h5><a id="_262"></a><strong>威胁场景测试</strong></h5> 
<p>1、监控系统二进制文件目录读写（默认规则）</p> 
<p>2、监控根目录或者/root目录写入文件（默认规则）</p> 
<p>3、监控运行交互式Shell的容器（默认规则）</p> 
<p>4、监控容器创建的不可信任进程（自定义规则）</p> 
<p>验证：tail -f /var/log/messages（告警通知默认输出到标准输出和系统日志）</p> 
<p><strong>监控容器创建的不可信任进程规则</strong></p> 
<p>在falco_rules.local.yaml文件添加：</p> 
<p>condition表达式解读：</p> 
<ol><li><code>spawned_process</code> 运行新进程</li><li><code>container</code> 容器</li><li><code>container.image startswith nginx</code> 以nginx开头的容器镜像</li><li><code>not proc.name in (nginx)</code> 不属于nginx的进程名称（允许进程名称列表）</li></ol> 
<blockquote> 
 <p>重启falco应用新配置文件：</p> 
 <p><code>systemctl restart falco</code></p> 
</blockquote> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># vim falco_rules.local.yaml</span>
<span class="token punctuation">-</span> <span class="token key atrule">rule</span><span class="token punctuation">:</span> Unauthorized process on nginx containers
  <span class="token key atrule">condition</span><span class="token punctuation">:</span> spawned_process and container and container.image startswith nginx and not proc.name in (nginx)
  <span class="token key atrule">desc</span><span class="token punctuation">:</span> test
  <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token string">"Unauthorized process on nginx containers (user=%user.name container_name=%container.name container_id=%container.id image=%container.image.repository shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline terminal=%proc.tty)"</span>
  <span class="token key atrule">priority</span><span class="token punctuation">:</span> WARNING
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>container<span class="token punctuation">]</span>
  

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># systemctl restart falco</span>
<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># journalctl -u falco -f  </span>
<span class="token punctuation">-</span><span class="token punctuation">-</span> Logs begin at Thu 2022<span class="token punctuation">-</span>04<span class="token punctuation">-</span>14 14<span class="token punctuation">:</span>39<span class="token punctuation">:</span>00 UTC. <span class="token punctuation">-</span><span class="token punctuation">-</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Stopped Falco</span><span class="token punctuation">:</span> Container Native Runtime Security.
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Starting Falco</span><span class="token punctuation">:</span> Container Native Runtime Security<span class="token punctuation">...</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Started Falco</span><span class="token punctuation">:</span> Container Native Runtime Security.
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Falco version 0.31.1 (driver version b7eb0dd65226a8dc254d228c8d950d07bf3521d2)
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Falco initialized with configuration file /etc/falco/falco.yaml
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Loading rules from file /etc/falco/falco_rules.yaml</span><span class="token punctuation">:</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Loading rules from file /etc/falco/falco_rules.local.yaml</span><span class="token punctuation">:</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>06 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Loading rules from file /etc/falco/k8s_audit_rules.yaml</span><span class="token punctuation">:</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>07 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Starting internal webserver<span class="token punctuation">,</span> listening on port 8765
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>07 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">02:38:07.523070816</span><span class="token punctuation">:</span> Informational Privileged container started (user=&lt;NA<span class="token punctuation">&gt;</span> user_loginuid=0 command=container<span class="token punctuation">:</span>8ab8ea9eb331 kube<span class="token punctuation">-</span>proxy (id=8ab8ea9eb331) image=registry.aliyuncs.com/google_containers/kube<span class="token punctuation">-</span>proxy<span class="token punctuation">:</span>v1.22.1)
</code></pre> 
<p>创建container容器之后触发falco</p> 
<ol><li>第一次创建<code>nginx</code>的<code>container</code>的时候输入创建</li><li>第二次使用tail查看日志，触发<code>faclo</code>有输出<code>shell=tail</code>字段</li></ol> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker run -d nginx </span>
801e315438d5e62c0d02eff444df9b17a9e7d635061e85037df56be9eaa02c4d

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># tail -f /var/log/messages</span>
Apr <span class="token number">15</span> 02:39:34 master01 falco: 02:39:34.313610957: Warning Unauthorized process on nginx containers <span class="token punctuation">(</span>user<span class="token operator">=</span>root <span class="token assign-left variable">container_name</span><span class="token operator">=</span>cool_heisenberg <span class="token assign-left variable">container_id</span><span class="token operator">=</span>801e315438d5 <span class="token assign-left variable">image</span><span class="token operator">=</span>nginx <span class="token assign-left variable">shell</span><span class="token operator">=</span>md5sum <span class="token assign-left variable">parent</span><span class="token operator">=</span><span class="token number">10</span>-listen-on-ip <span class="token assign-left variable">cmdline</span><span class="token operator">=</span>md5sum -c - <span class="token assign-left variable">terminal</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
Apr <span class="token number">15</span> 02:39:34 master01 falco: 02:39:34.319772871: Warning Unauthorized process on nginx containers <span class="token punctuation">(</span>user<span class="token operator">=</span>root <span class="token assign-left variable">container_name</span><span class="token operator">=</span>cool_heisenberg <span class="token assign-left variable">container_id</span><span class="token operator">=</span>801e315438d5 <span class="token assign-left variable">image</span><span class="token operator">=</span>nginx <span class="token assign-left variable">shell</span><span class="token operator">=</span>sed <span class="token assign-left variable">parent</span><span class="token operator">=</span><span class="token number">10</span>-listen-on-ip <span class="token assign-left variable">cmdline</span><span class="token operator">=</span>sed -i -E s,listen       <span class="token number">80</span><span class="token punctuation">;</span>,listen       <span class="token number">80</span><span class="token punctuation">;</span><span class="token punctuation">\</span>n    listen  <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:80<span class="token punctuation">;</span>, /etc/nginx/conf.d/default.conf <span class="token assign-left variable">terminal</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker exec -it 801e315438d5 tail /var/log/nginx/access.log </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># tail -f /var/log/messages</span>
Apr <span class="token number">15</span> 02:43:33 master01 falco: 02:43:33.449344235: Warning Unauthorized process on nginx containers <span class="token punctuation">(</span>user<span class="token operator">=</span>root <span class="token assign-left variable">container_name</span><span class="token operator">=</span>cool_heisenberg <span class="token assign-left variable">container_id</span><span class="token operator">=</span>801e315438d5 <span class="token assign-left variable">image</span><span class="token operator">=</span>nginx <span class="token assign-left variable">shell</span><span class="token operator">=</span>tail <span class="token assign-left variable">parent</span><span class="token operator">=</span>runc <span class="token assign-left variable">cmdline</span><span class="token operator">=</span>tail /var/log/nginx/access.log <span class="token assign-left variable">terminal</span><span class="token operator">=</span><span class="token number">34816</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="Falco_342"></a>Falco输出方式</h5> 
<p><strong>Falco支持五种输出告警通知的方式：</strong></p> 
<ol><li>输出到标准输出（默认启用）</li><li>输出到文件</li><li>输出到Syslog（默认启用）</li><li>输出到HTTP服务</li><li>输出到其他程序（命令行管道方式）</li></ol> 
<p>告警配置文件：<code>/etc/falco/falco.yaml</code></p> 
<p>例如输出到指定文件，使用json格式：</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># vim falco.yaml </span>
<span class="token key atrule">json_output</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
···
<span class="token key atrule">syslog_output</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
···
<span class="token key atrule">file_output</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">keep_alive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">filename</span><span class="token punctuation">:</span> /var/log/falco_events.log
···
<span class="token key atrule">stdout_output</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  
<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># systemctl restart falco </span>
</code></pre> 
<h5><a id="Falco_378"></a>Falco告警集中化展示</h5> 
<p><img src="https://images2.imgbox.com/82/10/iNykJZ7B_o.png" alt="image-20220415010916499"></p> 
<p>• FalcoSideKick：一个集中收集并指定输出，支持大量方式输出，例如Influxdb、Elasticsearch等</p> 
<p>项目地址 https://github.com/falcosecurity/falcosidekick</p> 
<p>• FalcoSideKick-UI：告警通知集中图形展示系统</p> 
<p>项目地址 https://github.com/falcosecurity/falcosidekick-ui</p> 
<h5><a id="Falco_UI_393"></a>部署Falco UI</h5> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker run -d \</span>
-p <span class="token number">2801</span>:2801 <span class="token punctuation">\</span>
--name falcosidekick <span class="token punctuation">\</span>
-e <span class="token assign-left variable">WEBUI_URL</span><span class="token operator">=</span>http://10.11.121.118:2802 <span class="token punctuation">\</span>
falcosecurity/falcosidekick

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker run -d \</span>
-p <span class="token number">2802</span>:2802 <span class="token punctuation">\</span>
--name falcosidekick-ui <span class="token punctuation">\</span>
falcosecurity/falcosidekick-ui 

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker ps </span>
CONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS                                       NAMES
9663f92ade3a   falcosecurity/falcosidekick-ui   <span class="token string">"./falcosidekick-ui"</span>     <span class="token number">6</span> minutes ago    Up <span class="token number">6</span> minutes    <span class="token number">0.0</span>.0.0:2802-<span class="token operator">&gt;</span><span class="token number">2802</span>/tcp, :::2802-<span class="token operator">&gt;</span><span class="token number">2802</span>/tcp   falcosidekick-ui
80c5d162842f   falcosecurity/falcosidekick      <span class="token string">"./falcosidekick"</span>        <span class="token number">7</span> minutes ago    Up <span class="token number">7</span> minutes    <span class="token number">0.0</span>.0.0:2801-<span class="token operator">&gt;</span><span class="token number">2801</span>/tcp, :::2801-<span class="token operator">&gt;</span><span class="token number">2801</span>/tcp   falcosidekick
</code></pre> 
<p>修改falco配置文件指定http方式输出：</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># vim falco.yaml </span>
<span class="token key atrule">json_output</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">json_include_output_property</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http_output</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"http://10.11.121.118:2801/"</span>
  
<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># systemctl restart falco</span>
</code></pre> 
<p>UI访问地址：http://10.11.121.118:2802/ui/</p> 
<p><img src="https://images2.imgbox.com/6d/e2/1VAL0f0g_o.png" alt="image-20220415105834715"></p> 
<h4><a id="Kubernetes__433"></a>Kubernetes 审计日志</h4> 
<h5><a id="_435"></a>什么是审计日志？</h5> 
<p>在Kubernetes集群中，API Server的审计日志记录了哪些用户、哪些服务请求操作集群资源，并且可以编写不同规则， 控制忽略、存储的操作日志。 审计日志采用JSON格式输出，每条日志都包含丰富的元数据，例如请求的URL、HTTP方法、客户端来源等，你可以使 用监控服务来分析API流量，以检测趋势或可能存在的安全隐患。</p> 
<p>这些可能服务会访问API Server：</p> 
<ul><li><strong>管理节点</strong>（controller-manager、scheduler）</li><li><strong>工作节点</strong>（kubelet、kube-proxy）</li><li><strong>集群服务</strong>（CoreDNS、Calico、HPA等）</li><li>kubectl、API、Dashboard</li></ul> 
<h5><a id="_450"></a>事件阶段</h5> 
<p>当客户端向 API Server发出请求时，该请求将经历一个或多个阶段：</p> 
<img src="https://images2.imgbox.com/63/1a/3VUnTAyA_o.png" alt="image-20220414232402761"> 
<table><thead><tr><th>阶段</th><th>说明</th></tr></thead><tbody><tr><td>RequestReceived</td><td>审核处理程序已收到请求</td></tr><tr><td>ResponseStarted</td><td>已发送响应标头，但尚未发送响应正文</td></tr><tr><td>ResponseComplete</td><td>响应正文已完成，不再发送任何字节</td></tr><tr><td>Panic</td><td>内部服务器出错，请求未完成</td></tr></tbody></table> 
<h5><a id="_465"></a>审计日志策略规则</h5> 
<p>Kubernetes审核策略文件包含一系列规则，描述了记录日志的级别， 采集哪些日志，不采集哪些日志。 规则级别如下表所示：</p> 
<table><thead><tr><th>级别</th><th>说明</th></tr></thead><tbody><tr><td>None</td><td>不为事件创建日志条目</td></tr><tr><td>Metadata</td><td>创建日志条目。包括元数据，但不包括请求正文或响应正文</td></tr><tr><td>Request</td><td>创建日志条目。包括元数据和请求正文，但不包括响应正文</td></tr><tr><td>RequestResponse</td><td>创建日志条目。包括元数据、请求正文和响应正文</td></tr></tbody></table> 
<p>参考资料：https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/</p> 
<h5><a id="_480"></a>日志格式示例</h5> 
<p><img src="https://images2.imgbox.com/03/36/Xon91Gmf_o.png" alt="image-20220414232719211"></p> 
<h5><a id="_485"></a>配置审计日志</h5> 
<p>审计日志支持写入本地文件和Webhook（发送到外部HTTP API）两种方式。</p> 
<p><strong>配置流程：</strong></p> 
<ol><li>准备配置文件（审计规则）</li><li>启用准入控制器</li><li>查看日志情况</li></ol> 
<p><strong>启用审计日志功能：</strong></p> 
<p><img src="https://images2.imgbox.com/1a/69/MPWQew2c_o.png" alt="image-20220415000552047"></p> 
<blockquote> 
 <p>注：需要使用hostpath数据卷将宿主 机策略文件和日志文件挂载到容器中</p> 
</blockquote> 
<h6><a id="1_507"></a>1.准备配置文件</h6> 
<p>在<code>/etc/kubernetes/</code>下创建<code>audit</code>目录</p> 
<p>配置文件为<code>audit-policy.yaml</code>，准入控制器需要挂载该目录的文件。</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/kubernetes/audit &amp;&amp; cd /etc/kubernetes/audit</span>
<span class="token punctuation">[</span>root@master01 audit<span class="token punctuation">]</span><span class="token comment"># cat audit-policy.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> audit.k8s.io/v1 <span class="token comment"># This is required.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Policy
<span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">"RequestReceived"</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> RequestResponse
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods/log"</span><span class="token punctuation">,</span> <span class="token string">"pods/status"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"configmaps"</span><span class="token punctuation">]</span>
      <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"controller-leader"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">users</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"system:kube-proxy"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"watch"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">,</span> <span class="token string">"services"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">userGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"system:authenticated"</span><span class="token punctuation">]</span>
    <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"/api*"</span> <span class="token comment"># Wildcard matching.</span>
    <span class="token punctuation">-</span> <span class="token string">"/version"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"configmaps"</span><span class="token punctuation">]</span>
    <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"kube-system"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">,</span> <span class="token string">"configmaps"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span> <span class="token comment"># core API group</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">"extensions"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"RequestReceived"</span>
</code></pre> 
<h6><a id="2_564"></a>2.启用准入控制器</h6> 
<p>审计日志支持写入本地文件和Webhook（发送到外部HTTP API）两种方式。</p> 
<p>启用审计日志功能：</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/kubernetes/manifests/kube-apiserver.yaml</span>
…
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>policy<span class="token punctuation">-</span>file=/etc/kubernetes/audit/audit<span class="token punctuation">-</span>policy.yaml
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>log<span class="token punctuation">-</span>path=/var/log/k8s_audit.log
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>log<span class="token punctuation">-</span>maxage=30
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>log<span class="token punctuation">-</span>maxbackup=10
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>log<span class="token punctuation">-</span>maxsize=100
<span class="token punctuation">...</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/audit/audit<span class="token punctuation">-</span>policy.yaml
      <span class="token key atrule">name</span><span class="token punctuation">:</span> audit
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/k8s_audit.log
      <span class="token key atrule">name</span><span class="token punctuation">:</span> audit<span class="token punctuation">-</span>log
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> audit
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/audit/audit<span class="token punctuation">-</span>policy.yaml
    <span class="token key atrule">type</span><span class="token punctuation">:</span> File
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> audit<span class="token punctuation">-</span>log
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log/k8s_audit.log
    <span class="token key atrule">type</span><span class="token punctuation">:</span> FileOrCreate

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet </span>
</code></pre> 
<h6><a id="3_599"></a>3.查看日志</h6> 
<p>测试查看当前的资源操作日志：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat  /var/log/k8s_audit.log</span>
···
<span class="token punctuation">{<!-- --></span><span class="token string">"kind"</span><span class="token builtin class-name">:</span><span class="token string">"Event"</span>,<span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span><span class="token string">"audit.k8s.io/v1"</span>,<span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"Metadata"</span>,<span class="token string">"auditID"</span><span class="token builtin class-name">:</span><span class="token string">"a2fb8bdd-1289-4045-b0f4-ccbafe4416c8"</span>,<span class="token string">"stage"</span><span class="token builtin class-name">:</span><span class="token string">"ResponseComplete"</span>,<span class="token string">"requestURI"</span><span class="token builtin class-name">:</span><span class="token string">"/apis/discovery.k8s.io/v1/namespaces/default/endpointslices/kubernetes"</span>,<span class="token string">"verb"</span><span class="token builtin class-name">:</span><span class="token string">"get"</span>,<span class="token string">"user"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"system:apiserver"</span>,<span class="token string">"uid"</span><span class="token builtin class-name">:</span><span class="token string">"bb28e427-363f-4841-9925-7ae0f7af6c1d"</span>,<span class="token string">"groups"</span>:<span class="token punctuation">[</span><span class="token string">"system:masters"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token string">"sourceIPs"</span>:<span class="token punctuation">[</span><span class="token string">"::1"</span><span class="token punctuation">]</span>,<span class="token string">"userAgent"</span><span class="token builtin class-name">:</span><span class="token string">"kube-apiserver/v1.22.1 (linux/amd64) kubernetes/632ed30"</span>,<span class="token string">"objectRef"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"resource"</span><span class="token builtin class-name">:</span><span class="token string">"endpointslices"</span>,<span class="token string">"namespace"</span><span class="token builtin class-name">:</span><span class="token string">"default"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"kubernetes"</span>,<span class="token string">"apiGroup"</span><span class="token builtin class-name">:</span><span class="token string">"discovery.k8s.io"</span>,<span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span><span class="token string">"v1"</span><span class="token punctuation">}</span>,<span class="token string">"responseStatus"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,<span class="token string">"code"</span>:200<span class="token punctuation">}</span>,<span class="token string">"requestReceivedTimestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-04-14T16:13:56.054960Z"</span>,<span class="token string">"stageTimestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-04-14T16:13:56.056415Z"</span>,<span class="token string">"annotations"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"authorization.k8s.io/decision"</span><span class="token builtin class-name">:</span><span class="token string">"allow"</span>,<span class="token string">"authorization.k8s.io/reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"kind"</span><span class="token builtin class-name">:</span><span class="token string">"Event"</span>,<span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span><span class="token string">"audit.k8s.io/v1"</span>,<span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"Metadata"</span>,<span class="token string">"auditID"</span><span class="token builtin class-name">:</span><span class="token string">"51e01b26-c275-4953-9472-efec1f8b0ca2"</span>,<span class="token string">"stage"</span><span class="token builtin class-name">:</span><span class="token string">"ResponseComplete"</span>,<span class="token string">"requestURI"</span><span class="token builtin class-name">:</span><span class="token string">"/apis/coordination.k8s.io/v1/namespaces/kube-node-lease/leases/master02?timeout=10s"</span>,<span class="token string">"verb"</span><span class="token builtin class-name">:</span><span class="token string">"update"</span>,<span class="token string">"user"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"system:node:master02"</span>,<span class="token string">"groups"</span>:<span class="token punctuation">[</span><span class="token string">"system:nodes"</span>,<span class="token string">"system:authenticated"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token string">"sourceIPs"</span>:<span class="token punctuation">[</span><span class="token string">"10.11.121.116"</span><span class="token punctuation">]</span>,<span class="token string">"userAgent"</span><span class="token builtin class-name">:</span><span class="token string">"kubelet/v1.22.1 (linux/amd64) kubernetes/632ed30"</span>,<span class="token string">"objectRef"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"resource"</span><span class="token builtin class-name">:</span><span class="token string">"leases"</span>,<span class="token string">"namespace"</span><span class="token builtin class-name">:</span><span class="token string">"kube-node-lease"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"master02"</span>,<span class="token string">"uid"</span><span class="token builtin class-name">:</span><span class="token string">"b2b0fc89-4220-48ee-86c9-b08e8c283f94"</span>,<span class="token string">"apiGroup"</span><span class="token builtin class-name">:</span><span class="token string">"coordination.k8s.io"</span>,<span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span><span class="token string">"v1"</span>,<span class="token string">"resourceVersion"</span><span class="token builtin class-name">:</span><span class="token string">"921237"</span><span class="token punctuation">}</span>,<span class="token string">"responseStatus"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,<span class="token string">"code"</span>:200<span class="token punctuation">}</span>,<span class="token string">"requestReceivedTimestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-04-14T16:13:56.316392Z"</span>,<span class="token string">"stageTimestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-04-14T16:13:56.324183Z"</span>,<span class="token string">"annotations"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"authorization.k8s.io/decision"</span><span class="token builtin class-name">:</span><span class="token string">"allow"</span>,<span class="token string">"authorization.k8s.io/reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h6><a id="4_612"></a>4.只记录指定资源操作日志</h6> 
<p>创建日志条目,包括元数据，但不包括请求正文或响应正文支持资源如下：</p> 
<ul><li>pods</li><li>deployments</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat  /etc/kubernetes/audit/audit-policy.yaml  </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> audit.k8s.io/v1 <span class="token comment"># This is required.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Policy
<span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">"RequestReceived"</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None 
    <span class="token key atrule">users</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> system<span class="token punctuation">:</span>apiserver 
    <span class="token punctuation">-</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
    <span class="token punctuation">-</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>scheduler
    <span class="token punctuation">-</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>proxy
    <span class="token punctuation">-</span> kubelet 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span> 
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">"apps"</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"deployments"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None 

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># ps -ef | grep kubelet </span>
root      72326  72272 10 16<span class="token punctuation">:</span>04 <span class="token punctuation">?</span>        00<span class="token punctuation">:</span>04<span class="token punctuation">:</span>02 kube<span class="token punctuation">-</span>apiserver <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>address=10.11.121.118 

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kill -9 72326 </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet </span>
</code></pre> 
<p>创建一个Pod查看当前的日志情况、使用jq转换为json查看：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run  web-test-my-pod --image=nginx --image-pull-policy=IfNotPresent </span>
pod/web created
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat /var/log/k8s_audit.log  | grep web-test-my-pod </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># echo '{"kind":"Event","apiVersion":"audit.k8s.io/v1","level":"Metadata","auditID":"53298e83-3e00-471a-80b0-e7f9fa721be9","stage":"ResponseComplete","requestURI":"/api/v1/namespaces/default/pods?fieldManager=kubectl-run","verb":"create","user":{"username":"kubernetes-admin","groups":["system:masters","system:authenticated"]},"sourceIPs":["10.11.121.118"],"userAgent":"kubectl/v1.23.5 (linux/amd64) kubernetes/c285e78","objectRef":{"resource":"pods","namespace":"default","name":"web-test-my-pod","apiVersion":"v1"},"responseStatus":{"metadata":{},"code":201},"requestReceivedTimestamp":"2022-04-14T16:51:26.948369Z","stageTimestamp":"2022-04-14T16:51:26.959232Z","annotations":{"authorization.k8s.io/decision":"allow","authorization.k8s.io/reason":"","imagepolicywebhook.image-policy.k8s.io/failed-open":"true"}}' | jq .</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Event"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"audit.k8s.io/v1"</span>,
  <span class="token string">"level"</span><span class="token builtin class-name">:</span> <span class="token string">"Metadata"</span>,
  <span class="token string">"auditID"</span><span class="token builtin class-name">:</span> <span class="token string">"53298e83-3e00-471a-80b0-e7f9fa721be9"</span>,
  <span class="token string">"stage"</span><span class="token builtin class-name">:</span> <span class="token string">"ResponseComplete"</span>,
  <span class="token string">"requestURI"</span><span class="token builtin class-name">:</span> <span class="token string">"/api/v1/namespaces/default/pods?fieldManager=kubectl-run"</span>,
  <span class="token string">"verb"</span><span class="token builtin class-name">:</span> <span class="token string">"create"</span>,
  <span class="token string">"user"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"username"</span><span class="token builtin class-name">:</span> <span class="token string">"kubernetes-admin"</span>,
    <span class="token string">"groups"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"system:masters"</span>,
      <span class="token string">"system:authenticated"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"sourceIPs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">"10.11.121.118"</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"userAgent"</span><span class="token builtin class-name">:</span> <span class="token string">"kubectl/v1.23.5 (linux/amd64) kubernetes/c285e78"</span>,
  <span class="token string">"objectRef"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"resource"</span><span class="token builtin class-name">:</span> <span class="token string">"pods"</span>,
    <span class="token string">"namespace"</span><span class="token builtin class-name">:</span> <span class="token string">"default"</span>,
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"web-test-my-pod"</span>,
    <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"responseStatus"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
    <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">201</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"requestReceivedTimestamp"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-04-14T16:51:26.948369Z"</span>,
  <span class="token string">"stageTimestamp"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-04-14T16:51:26.959232Z"</span>,
  <span class="token string">"annotations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"authorization.k8s.io/decision"</span><span class="token builtin class-name">:</span> <span class="token string">"allow"</span>,
    <span class="token string">"authorization.k8s.io/reason"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
    <span class="token string">"imagepolicywebhook.image-policy.k8s.io/failed-open"</span><span class="token builtin class-name">:</span> <span class="token string">"true"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="5_698"></a>5.审计日志练习</h6> 
<p>编辑和扩展基本策略到日志：</p> 
<ol><li>命名空间在 RequestResponse 级别更改</li><li>PV 的请求内容在 front-apps 命名空间发生了更改</li><li>Configmap 和 secret 在所有命名空间 Metadata 级别更改</li><li>另外，添加一个catch-all来记录在Metadata 级别的所有请求。</li></ol> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/kubernetes/audit/audit-policy.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> audit.k8s.io/v1 <span class="token comment"># This is required.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Policy
<span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">"RequestReceived"</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>  
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> RequestResponse   
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span> 
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"namespaces"</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    
    <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"front-apps"</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">,</span> <span class="token string">"configmaps"</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"RequestReceived"</span>
</code></pre> 
<p>练习</p> 
<p>编辑和扩展基本策略到日志：</p> 
<ol><li>命名空间在 RequestResponse 级别更改</li><li>PV 的请求内容在 front-apps 命名空间发生了更改</li><li>Configmap 和 secret 在所有命名空间 Metadata 级别更改</li><li>另外，添加一个catch-all来记录在Metadata 级别的所有请求。</li></ol> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/kubernetes/audit/audit-policy.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> audit.k8s.io/v1 <span class="token comment"># This is required.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Policy
<span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">"RequestReceived"</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>  
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> RequestResponse   
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span> 
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"namespaces"</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    
    <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"front-apps"</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">,</span> <span class="token string">"configmaps"</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"RequestReceived"</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c8295ef1e6143140544b738426fe55da/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">4.最小化微服务漏洞</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/668d6198f365928bd71e4f97f40c74c4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LVGL V8自定义实现radio button</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>