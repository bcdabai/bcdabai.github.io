<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>containerd版安装k8s - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="containerd版安装k8s" />
<meta property="og:description" content="内核调整 cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF net.bridge.bridge-nf-call-iptables=1 net.bridge.bridge-nf-call-ip6tables=1 net.bridge.bridge-nf-call-arptables = 1 net.ipv4.ip_forward=1 net.ipv4.tcp_tw_recycle=0 net.core.somaxconn = 32768 vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它 vm.overcommit_memory=1 # 不检查物理内存是否够用 vm.panic_on_oom=0 # 开启 OOM fs.inotify.max_user_instances=8192 fs.inotify.max_user_watches=1048576 fs.file-max=52706963 fs.nr_open=52706963 net.ipv6.conf.all.disable_ipv6=1 net.netfilter.nf_conntrack_max=2310720 net.ipv4.conf.all.rp_filter = 1 net.ipv4.neigh.default.gc_thresh1 = 80000 net.ipv4.neigh.default.gc_thresh2 = 90000 net.ipv4.neigh.default.gc_thresh3 = 100000 EOF kube-proxy开启ipvs的前置条件 modprobe br_netfilter cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF #!/bin/bash modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack modprobe br_netfilter EOF cat&lt;&lt;END&gt; install-1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/07580973b33cfecdca10bfef2c13c401/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-23T15:55:04+08:00" />
<meta property="article:modified_time" content="2022-05-23T15:55:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">containerd版安装k8s</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <ul><li>内核调整</li></ul> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.bridge.bridge-nf-call-arptables = 1
net.ipv4.ip_forward=1
net.ipv4.tcp_tw_recycle=0
net.core.somaxconn = 32768
vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它 vm.overcommit_memory=1 # 不检查物理内存是否够用
vm.panic_on_oom=0 # 开启 OOM
fs.inotify.max_user_instances=8192
fs.inotify.max_user_watches=1048576
fs.file-max=52706963
fs.nr_open=52706963
net.ipv6.conf.all.disable_ipv6=1
net.netfilter.nf_conntrack_max=2310720
net.ipv4.conf.all.rp_filter = 1
net.ipv4.neigh.default.gc_thresh1 = 80000
net.ipv4.neigh.default.gc_thresh2 = 90000
net.ipv4.neigh.default.gc_thresh3 = 100000
EOF</span>
</code></pre> 
<ul><li> <h5><a id="kubeproxyipvs_23"></a>kube-proxy开启ipvs的前置条件</h5> </li></ul> 
<pre><code class="prism language-shell">modprobe br_netfilter
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
modprobe br_netfilter
EOF</span>
</code></pre> 
<pre><code class="prism language-shell">cat<span class="token operator">&lt;&lt;</span>END<span class="token operator">&gt;</span> install-1.sh 
<span class="token comment">#!/bin/bash</span>
<span class="token comment">#yum源配置</span>
systemctl stop firewalld.service
systemctl disable firewalld.service
yum <span class="token function">install</span> ipset <span class="token function">vim</span> ipvsadm <span class="token function">wget</span> bash-completion.noarch -y
yum <span class="token function">install</span> -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;&gt;</span>  /etc/security/limits.conf</span>
root        soft        nofile        1048576
root        hard        nofile        1048576
root        soft        stack         10240
EOF</span>

<span class="token comment"># 关闭selinux</span>
setenforce <span class="token number">0</span>
<span class="token function">sed</span> -i <span class="token string">'s/^SELINUX=enforcing$/SELINUX=disabled/'</span> /etc/selinux/config
<span class="token function">grep</span> --color<span class="token operator">=</span>auto <span class="token string">'^SELINUX'</span> /etc/selinux/config
<span class="token comment">#关闭Swap</span>
swapoff -a
<span class="token function">sed</span> -i <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab 
yum makecache fast -y
yum <span class="token function">install</span> -y kubelet-1.23.6 kubeadm-1.23.6 kubectl-1.23.6 <span class="token operator">&amp;&amp;</span> yum <span class="token function">install</span> -y  containerd.io
systemctl <span class="token builtin class-name">enable</span> kubelet containerd
modprobe br_netfilter
sysctl --system
sysctl -p /etc/sysctl.d/k8s.conf
<span class="token function">chmod</span> +x /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> /etc/sysconfig/modules/ipvs.modules
lsmod <span class="token operator">|</span> <span class="token function">grep</span> -e ip_vs -e nf_conntrack_ipv4
<span class="token function">cut</span> -f1 -d <span class="token string">" "</span> /proc/modules <span class="token operator">|</span> <span class="token function">grep</span> -e ip_vs -e nf_conntrack_ipv4
lsmod <span class="token operator">|</span> <span class="token function">grep</span> ip_vs
END
</code></pre> 
<ul><li> <h5><a id="containerd__82"></a>containerd 配置</h5> </li></ul> 
<pre><code class="prism language-shell">cat<span class="token operator">&lt;&lt;</span>END<span class="token operator">&gt;</span> install-2.sh 
<span class="token comment">#!/bin/bash</span>
containerd config default <span class="token operator">&gt;</span> /etc/containerd/config.toml
<span class="token function">sed</span> -i <span class="token string">"s#k8s.gcr.io/pause:3.6#registry.aliyuncs.com/google_containers/pause:3.6#g"</span> /etc/containerd/config.toml
<span class="token function">sed</span> -i <span class="token string">"s#https://registry-1.docker.io#https://0k0953tv.mirror.aliyuncs.com#g"</span> /etc/containerd/config.toml
<span class="token function">sed</span> -i <span class="token string">'s/SystemdCgroup = false/SystemdCgroup = true/'</span> /etc/containerd/config.toml
systemctl restart containerd
systemctl status containerd.service
<span class="token comment">#wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.22.0/crictl-v1.22.0-linux-amd64.tar.gz</span>
<span class="token function">tar</span> zxvf crictl-v1.23.0-linux-amd64.tar.gz -C /usr/local/bin

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/crictl.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF</span>
crictl config runtime-endpoint unix:/run/containerd/containerd.sock
<span class="token builtin class-name">echo</span> <span class="token string">"测试拉取镜像"</span>
crictl pull nginx
crictl images
<span class="token comment">#runtime</span>
<span class="token comment">#cat &gt; /etc/sysconfig/kubelet &lt;&lt;EOF</span>
<span class="token comment">#KUBELET_EXTRA_ARGS=--cgroup-driver=systemd</span>
<span class="token comment">#EOF</span>
<span class="token comment">#crictl pull coredns/coredns:1.8.4</span>
<span class="token comment">#ctr -n k8s.io i tag  docker.io/coredns/coredns:1.8.4 registry.aliyuncs.com/google_containers/coredns:v1.8.4</span>
END
</code></pre> 
<ul><li> <h5><a id="_113"></a>最后初始化</h5> </li><li>方法1</li></ul> 
<pre><code class="prism language-shell">kubeadm init --image-repository registry.aliyuncs.com/google_containers --pod-network-cidr<span class="token operator">=</span><span class="token number">192.168</span>.0.0/16
</code></pre> 
<ul><li>方法2</li></ul> 
<pre><code class="prism language-javascript">kubeadm config print init<span class="token operator">-</span>defaults <span class="token operator">&gt;</span> kubeadm<span class="token operator">-</span>config<span class="token punctuation">.</span>yaml

<span class="token literal-property property">apiVersion</span><span class="token operator">:</span> kubeadm<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">/</span>v1beta2
<span class="token literal-property property">bootstrapTokens</span><span class="token operator">:</span>
<span class="token operator">-</span> groups<span class="token operator">:</span>
  <span class="token operator">-</span> system<span class="token operator">:</span>bootstrappers<span class="token operator">:</span>kubeadm<span class="token operator">:</span><span class="token keyword">default</span><span class="token operator">-</span>node<span class="token operator">-</span>token
  <span class="token literal-property property">token</span><span class="token operator">:</span> abcdef<span class="token punctuation">.</span>0123456789abcdef
  <span class="token literal-property property">ttl</span><span class="token operator">:</span> 24h0m0s
  <span class="token literal-property property">usages</span><span class="token operator">:</span>
  <span class="token operator">-</span> signing
  <span class="token operator">-</span> authentication
<span class="token literal-property property">kind</span><span class="token operator">:</span> InitConfiguration
<span class="token literal-property property">localAPIEndpoint</span><span class="token operator">:</span>
  <span class="token literal-property property">advertiseAddress</span><span class="token operator">:</span> <span class="token number">1.2</span><span class="token number">.3</span><span class="token number">.4</span> #<span class="token punctuation">(</span>这里的ip修改为主机ip）
  <span class="token literal-property property">bindPort</span><span class="token operator">:</span> <span class="token number">6443</span>
<span class="token literal-property property">nodeRegistration</span><span class="token operator">:</span>
  <span class="token literal-property property">criSocket</span><span class="token operator">:</span> <span class="token operator">/</span>run<span class="token operator">/</span>containerd<span class="token operator">/</span>containerd<span class="token punctuation">.</span>sock
  <span class="token literal-property property">name</span><span class="token operator">:</span> node
  <span class="token literal-property property">taints</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token operator">--</span><span class="token operator">-</span>
<span class="token literal-property property">apiServer</span><span class="token operator">:</span>
  <span class="token literal-property property">timeoutForControlPlane</span><span class="token operator">:</span> 4m0s
<span class="token literal-property property">apiVersion</span><span class="token operator">:</span> kubeadm<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">/</span>v1beta2
<span class="token literal-property property">certificatesDir</span><span class="token operator">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>pki
<span class="token literal-property property">clusterName</span><span class="token operator">:</span> kubernetes
<span class="token literal-property property">controllerManager</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token literal-property property">dns</span><span class="token operator">:</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> CoreDNS
<span class="token literal-property property">etcd</span><span class="token operator">:</span>
  <span class="token literal-property property">local</span><span class="token operator">:</span>
    <span class="token literal-property property">dataDir</span><span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>etcd
# 默认拉取镜像地址k8s<span class="token punctuation">.</span>gcr<span class="token punctuation">.</span>io国内无法访问，指定阿里云镜像仓库地址
<span class="token literal-property property">imageRepository</span><span class="token operator">:</span> registry<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>google_containers
<span class="token literal-property property">kind</span><span class="token operator">:</span> ClusterConfiguration
<span class="token literal-property property">kubernetesVersion</span><span class="token operator">:</span> <span class="token number">1.21</span><span class="token number">.0</span>
<span class="token literal-property property">networking</span><span class="token operator">:</span>
  <span class="token literal-property property">dnsDomain</span><span class="token operator">:</span> cluster<span class="token punctuation">.</span>local
  # networking组下新增一行 podSubnet<span class="token operator">:</span> <span class="token string">"10.244.0.0/16"</span> flannel默认使用的网断
  <span class="token literal-property property">podSubnet</span><span class="token operator">:</span> <span class="token string">"10.244.0.0/16"</span>
  <span class="token literal-property property">serviceSubnet</span><span class="token operator">:</span> <span class="token number">10.96</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">12</span>
<span class="token literal-property property">scheduler</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">-</span>
#开启ipvs
<span class="token literal-property property">apiVersion</span><span class="token operator">:</span> kubeproxy<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">/</span>v1alpha1
<span class="token literal-property property">kind</span><span class="token operator">:</span> KubeProxyConfiguration
<span class="token literal-property property">mode</span><span class="token operator">:</span> ipvs
</code></pre> 
<p>初始化集群master</p> 
<pre><code class="prism language-shell">kubeadm init  --config kubeadm-init-config.yaml
</code></pre> 
<ul><li>执行安装日志中的加入命令</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># 执行安装日志中的加入命令</span>
<span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre> 
<h5><a id="1_178"></a>我使用的是方法1</h5> 
<pre><code class="prism language-javascript">curl https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>projectcalico<span class="token punctuation">.</span>org<span class="token operator">/</span>manifests<span class="token operator">/</span>calico<span class="token punctuation">.</span>yaml <span class="token operator">-</span><span class="token constant">O</span>
kubectl apply <span class="token operator">-</span>f calico<span class="token punctuation">.</span>yaml
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dab69d4bb147e64ac6b2785cd09c8b3d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mysql解决of ORDER BY clause is not in GROUP BY clause and contains nonaggregated column问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a369ed97761f72b972a5339b96a90aa4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">简单2步轻松查找、免费下载国内外数据集？在OpenDataLab 真的可以</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>