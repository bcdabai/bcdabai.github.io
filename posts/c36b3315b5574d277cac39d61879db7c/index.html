<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32F103 HAL库外部中断（三） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32F103 HAL库外部中断（三）" />
<meta property="og:description" content="外部中断 1、外部中断配置1.1、初始化中断I/O，设置触发条件1.2、配置中断优先级（NVIC），并使能中断。1.3、编写中断服务函数。1.4、编写中断处理回调函数 HAL_GPIO_EXTI_Callback HAL库基本使用系列的 全部博客是我重新学习HAL库的学习记录，仅作为学习记录。其中使用了正点原子Mini开发板和正点原子HAL库Demo，详细的资料请观看正点原子官网
本来计划写一下串口的使用，但是前面的博客里面已经介绍到了串口的文件夹以及串口的初始化以及基本使用，最多就是在加一个中断处理函数，对接收到的数据进行处理，关于串口不同中断的区别，后期单独介绍。
STM32F1 的每个 IO 都可以作为外部中断的中断输入口，中断控制器支持 19个外部中断/事件请求。每个中断设有状态位，每个中断/事件都有独立的触发和屏蔽设置。
STM32F103 的 19 个外部中断为：
EXTI 线 0~15：对应外部 IO 口的输入中断。
EXTI 线 16：连接到 PVD 输出。
EXTI 线 17：连接到 RTC 闹钟事件。
EXTI 线 18：连接到 USB 唤醒事件。
EXTI 线 19：连接到以太网唤醒事件。
STM32通过映射关系，把GPIOx.0~GPIOx.15(x=A,B,C,D,E，F,G,H,I)分别对应中断线 0~15。这样每个中断线对应了最多 9 个 IO 口，以线 0 为例：它对应了 GPIOA.0、GPIOB.0、GPIOC.0、GPIOD.0、GPIOE.0、GPIOF.0、GPIOG.0。而中断线每次只能连接到 1 个 IO 口上，这样就需要通过配置来决定对应的中断线配置到哪个 GPIO 上了。
IO 口外部中断的一般步骤：
1）使能 IO 口时钟。
2）调用函数 HAL_GPIO_Init 设置 IO 口模式，触发条件，使能 SYSCFG 时钟以及设置 IO
口与中断线的映射关系。
3）配置中断优先级（NVIC），并使能中断。
4）在中断服务函数中调用外部中断共用入口函数 HAL_GPIO_EXTI_IRQHandler。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c36b3315b5574d277cac39d61879db7c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-11T21:16:30+08:00" />
<meta property="article:modified_time" content="2021-08-11T21:16:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32F103 HAL库外部中断（三）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>外部中断</h4> 
 <ul><li><a href="#1_22" rel="nofollow">1、外部中断配置</a></li><li><ul><li><a href="#11IO_23" rel="nofollow">1.1、初始化中断I/O，设置触发条件</a></li><li><a href="#12NVIC_56" rel="nofollow">1.2、配置中断优先级（NVIC），并使能中断。</a></li><li><a href="#13_75" rel="nofollow">1.3、编写中断服务函数。</a></li><li><a href="#14_HAL_GPIO_EXTI_Callback_106" rel="nofollow">1.4、编写中断处理回调函数 HAL_GPIO_EXTI_Callback</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<blockquote> 
 <p>HAL库基本使用系列的 全部博客是我重新学习HAL库的学习记录，仅作为学习记录。其中使用了正点原子Mini开发板和正点原子HAL库Demo，详细的资料请观看正点原子官网</p> 
</blockquote> 
<p>  本来计划写一下串口的使用，但是前面的博客里面已经介绍到了串口的文件夹以及串口的初始化以及基本使用，最多就是在加一个中断处理函数，对接收到的数据进行处理，关于串口不同中断的区别，后期单独介绍。</p> 
<p>  STM32F1 的每个 IO 都可以作为外部中断的中断输入口，中断控制器支持 19个外部中断/事件请求。每个中断设有状态位，每个中断/事件都有独立的触发和屏蔽设置。<br> STM32F103 的 19 个外部中断为：</p> 
<blockquote> 
 <p>EXTI 线 0~15：对应外部 IO 口的输入中断。<br> EXTI 线 16：连接到 PVD 输出。<br> EXTI 线 17：连接到 RTC 闹钟事件。<br> EXTI 线 18：连接到 USB 唤醒事件。<br> EXTI 线 19：连接到以太网唤醒事件。</p> 
</blockquote> 
<p>STM32通过映射关系，把GPIOx.0~GPIOx.15(x=A,B,C,D,E，F,G,H,I)分别对应中断线 0~15。这样每个中断线对应了最多 9 个 IO 口，以线 0 为例：它对应了 GPIOA.0、GPIOB.0、GPIOC.0、GPIOD.0、GPIOE.0、GPIOF.0、GPIOG.0。而中断线每次只能连接到 1 个 IO 口上，这样就需要通过配置来决定对应的中断线配置到哪个 GPIO 上了。</p> 
<p>IO 口外部中断的一般步骤：</p> 
<blockquote> 
 <p>1）使能 IO 口时钟。<br> 2）调用函数 HAL_GPIO_Init 设置 IO 口模式，触发条件，使能 SYSCFG 时钟以及设置 IO<br> 口与中断线的映射关系。<br> 3）配置中断优先级（NVIC），并使能中断。<br> 4）在中断服务函数中调用外部中断共用入口函数 HAL_GPIO_EXTI_IRQHandler。<br> 5）编写外部中断回调函数 HAL_GPIO_EXTI_Callback。</p> 
</blockquote> 
<h2><a id="1_22"></a>1、外部中断配置</h2> 
<h3><a id="11IO_23"></a>1.1、初始化中断I/O，设置触发条件</h3> 
<p>I/O作为中断，那么端口输入模式为输入模式。</p> 
<pre><code class="prism language-c">GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
    
    <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//开启GPIOA时钟</span>
    <span class="token function">__HAL_RCC_GPIOC_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//开启GPIOC时钟</span>
    
    GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_0<span class="token punctuation">;</span>                <span class="token comment">//PA0</span>
    GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_IT_RISING<span class="token punctuation">;</span>      <span class="token comment">//上升沿触发</span>
    GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLDOWN<span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_15<span class="token punctuation">;</span> 				<span class="token comment">//PA15</span>
    GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_IT_FALLING<span class="token punctuation">;</span>     <span class="token comment">//下降沿触发</span>
    GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLUP<span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_5<span class="token punctuation">;</span> 				<span class="token comment">//PC5</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>通过定位查找，可以看到中断模式的设置有如下几种：</p> 
<pre><code class="prism language-c">GPIO_MODE_IT_RISING（外部中断上升沿触发），
GPIO_MODE_IT_FALLING （外部中断下降沿触发）
GPIO_MODE_IT_RISING_FALLING（外部中断双边沿触发）
</code></pre> 
<p><img src="https://images2.imgbox.com/3a/ad/GKe3Hv8a_o.png" alt="在这里插入图片描述"><br> 该函数内部会通过判断Mode 的值来开启 SYSCFG 时钟，并且设置 IO 口和中断线的映射关系。<br> 初始化了PA0，如果PB0在初始化中断，那么PA0的中断映射将会被清除。</p> 
<h3><a id="12NVIC_56"></a>1.2、配置中断优先级（NVIC），并使能中断。</h3> 
<p>设置好了中断的触发模式等初始化参数。既然是外部中断，涉及到中断我们当然还要设置 NVIC 中断优先级。</p> 
<pre><code class="prism language-c"> <span class="token comment">//中断线0-PA0</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>EXTI0_IRQn<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//抢占优先级为2，子优先级为2</span>
    <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>EXTI0_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//使能中断线0</span>
    
	<span class="token comment">//中断线5-PC5</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>EXTI9_5_IRQn<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   	<span class="token comment">//抢占优先级为2，子优先级为1</span>
    <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>EXTI9_5_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	
    <span class="token comment">//中断线15-PA15</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>EXTI15_10_IRQn<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//抢占优先级为2，子优先级为0</span>
    <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>EXTI15_10_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>        	<span class="token comment">//使能中断线15</span>
</code></pre> 
<p>外部中断的5-9,10-15各自共用了一个通道EXTI15_10_IRQn以及EXTI9_5_IRQn，如图所示：<br> <img src="https://images2.imgbox.com/c7/b5/EqIMNhxl_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="13_75"></a>1.3、编写中断服务函数。</h3> 
<p>中断服务函数的名字是在 HAL 库中事先有定义的。STM32F1 的 IO 口外部中断函数只有 7 个，分别为：</p> 
<blockquote> 
 <p>void EXTI0_IRQHandler();<br> void EXTI1_IRQHandler();<br> void EXTI2_IRQHandler();<br> void EXTI3_IRQHandler();<br> void EXTI4_IRQHandler();<br> void EXTI9_5_IRQHandler();<br> void EXTI15_10_IRQHandler();</p> 
</blockquote> 
<p> &amp;emsp；通过上面的图中我们也可以知道中断线 0-4 每个中断线对应一个中断函数，中断线 5-9 共用中断函数 EXTI9_5_IRQHandler，中断线 10-15 共用中断函数EXTI15_10_IRQHandler。</p> 
<pre><code class="prism language-c"><span class="token comment">//中断服务函数</span>
<span class="token keyword">void</span> <span class="token function">EXTI0_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_GPIO_EXTI_IRQHandler</span><span class="token punctuation">(</span>GPIO_PIN_0<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//调用中断处理公用函数</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">EXTI9_5_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_GPIO_EXTI_IRQHandler</span><span class="token punctuation">(</span>GPIO_PIN_5<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//调用中断处理公用函数</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">EXTI15_10_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_GPIO_EXTI_IRQHandler</span><span class="token punctuation">(</span>GPIO_PIN_15<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//调用中断处理公用函数</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="14_HAL_GPIO_EXTI_Callback_106"></a>1.4、编写中断处理回调函数 HAL_GPIO_EXTI_Callback</h3> 
<p>通过查找可以看到HAL_GPIO_EXTI_Callback函数是HAL库定义的弱函数，我们可以重新定义新的回调函数，并且编写中断函数控制逻辑。<br> <img src="https://images2.imgbox.com/f5/41/FSPcuVKD_o.png" alt="在这里插入图片描述"><br> 提 供 了一个中断通用入口 函 数HAL_GPIO_EXTI_IRQHandler，在该函数内部直接调用回调函数 HAL_GPIO_EXTI_Callback。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HAL_GPIO_EXTI_IRQHandler</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> GPIO_Pin<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">__HAL_GPIO_EXTI_GET_IT</span><span class="token punctuation">(</span>GPIO_Pin<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x00u</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
 <span class="token function">__HAL_GPIO_EXTI_CLEAR_IT</span><span class="token punctuation">(</span>GPIO_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">HAL_GPIO_EXTI_Callback</span><span class="token punctuation">(</span>GPIO_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该函数实现的作用非常简单，就是清除中断标志位，然后调用回调函数<br> HAL_GPIO_EXTI_Callback()实现控制逻辑。</p> 
<pre><code class="prism language-c"><span class="token comment">//中断服务程序中需要做的事情</span>
<span class="token comment">//在HAL库中所有的外部中断服务函数都会调用此函数</span>
<span class="token comment">//GPIO_Pin:中断引脚号</span>
<span class="token keyword">void</span> <span class="token function">HAL_GPIO_EXTI_Callback</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> GPIO_Pin<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      	<span class="token comment">//消抖</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>GPIO_Pin<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> GPIO_PIN_0<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>WK_UP<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
				LED1<span class="token operator">=</span><span class="token operator">!</span>LED1<span class="token punctuation">;</span>	<span class="token comment">//控制LED0,LED1互斥点亮</span>
				LED0<span class="token operator">=</span><span class="token operator">!</span>LED1<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> GPIO_PIN_5<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>KEY0<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>  	<span class="token comment">//控制LED0翻转 </span>
            <span class="token punctuation">{<!-- --></span>
                LED0<span class="token operator">=</span><span class="token operator">!</span>LED0<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> GPIO_PIN_15<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>  
            <span class="token punctuation">{<!-- --></span>
				LED1<span class="token operator">=</span><span class="token operator">!</span>LED1<span class="token punctuation">;</span>	<span class="token comment">//控制LED0翻转</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/59fe64b826c27c42294c65a4d20df7e9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">华为服务器上传文件,向服务器上传文件方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/261b33bdce2e2ae8017d76dc517addb1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">文档保护 服务器,服务器保护</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>