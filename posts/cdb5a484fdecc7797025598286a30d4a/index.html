<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【鸿蒙开发】第九章 ArkTS语言UI范式-状态管理（一） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【鸿蒙开发】第九章 ArkTS语言UI范式-状态管理（一）" />
<meta property="og:description" content="1 前言 在前文的描述中，我们构建的页面多为静态界面。如果希望构建一个动态的、有交互的界面，就需要引入“状态”的概念。我们本章节来学习状态管理机制
2 概念 在声明式UI编程框架中，UI是程序状态的运行结果，用户构建了一个UI模型，其中应用的运行时的状态是参数。当参数改变时，UI作为返回结果，也将进行对应的改变。这些运行时的状态变化所带来的UI的重新渲染，在ArkUI中统称为状态管理机制。
自定义组件拥有变量，变量必须被装饰器装饰才可以成为状态变量，状态变量的改变会引起UI的渲染刷新。如果不使用状态变量，UI只能在初始化时渲染，后续将不会再刷新。 下图展示了State和View（UI）之间的关系。
View(UI)：UI渲染，指将build方法内的UI描述和@Builder装饰的方法内的UI描述映射到界面。State：状态，指驱动UI更新的数据。用户通过触发组件的事件方法，改变状态数据。状态数据的改变，引起UI的重新渲染。 3 状态管理 @Component struct MyComponent { // @Prop状态装饰器，状态变量 @Prop count: number = 0; // 常规变量 private increaseBy: number = 1; build() { Column() { Text(&#34;count:&#34;&#43;this.count&#43;&#34; increaseBy:&#34;&#43;this.increaseBy) .fontSize(30) .fontWeight(FontWeight.Bold) } .width(&#39;100%&#39;) } } @Component struct Parent { // @State状态装饰器，状态变量 @State count: number = 1; build() { Column() { Button(&#34;count&#43;&#43;&#34;).onClick(()=&gt;{ console.log(&#34;yvan&#34;, &#34;count:&#34;&#43;this.count) this.count = this.count &#43; 1 }) // 从父组件初始化，覆盖本地定义的默认值 MyComponent({ count: this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cdb5a484fdecc7797025598286a30d4a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-06T22:56:54+08:00" />
<meta property="article:modified_time" content="2024-01-06T22:56:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【鸿蒙开发】第九章 ArkTS语言UI范式-状态管理（一）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1 前言</h2> 
<p>在前文的描述中，我们构建的页面多为静态界面。如果希望构建一个<strong>动态的、有交互的界面，就需要引入“状态”的概念</strong>。我们本章节来学习<code>状态管理机制</code></p> 
<h2><a id="2__2"></a>2 概念</h2> 
<p>在声明式UI编程框架中，UI是程序状态的运行结果，用户构建了一个UI模型，其中应用的运行时的状态是参数。当参数改变时，UI作为返回结果，也将进行对应的改变。<strong>这些运行时的状态变化所带来的UI的重新渲染，在ArkUI中统称为<code>状态管理机制</code></strong>。</p> 
<p>自定义组件拥有变量，变量必须被<code>装饰器装饰</code>才可以成为<code>状态变量</code>，状态变量的改变会引起UI的渲染刷新。如果不使用状态变量，UI只能在初始化时渲染，后续将不会再刷新。 下图展示了<code>State和View（UI）之间的关系</code>。<br> <img src="https://images2.imgbox.com/29/06/RyWfdYVD_o.png" alt="在这里插入图片描述"></p> 
<ol><li><code>View(UI)：UI渲染</code>，指将<code>build方法</code>内的<code>UI描述</code>和<code>@Builder装饰的方法内的UI描述</code>映射到界面。</li><li><code>State：状态</code>，指驱动UI更新的数据。用户通过触发组件的事件方法，改变状态数据。<code>状态数据的改变，引起UI的重新渲染</code>。</li></ol> 
<h2><a id="3__11"></a>3 状态管理</h2> 
<pre><code class="prism language-typescript">
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct MyComponent <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// @Prop状态装饰器，状态变量</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span> count<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// 常规变量</span>
  <span class="token keyword">private</span> increaseBy<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">"count:"</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">+</span><span class="token string">" increaseBy:"</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>increaseBy<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fontSize</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fontWeight</span><span class="token punctuation">(</span>FontWeight<span class="token punctuation">.</span>Bold<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token string">'100%'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Parent <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// @State状态装饰器，状态变量</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> count<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">"count++"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"yvan"</span><span class="token punctuation">,</span> <span class="token string">"count:"</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 从父组件初始化，覆盖本地定义的默认值</span>
      <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> count<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">,</span> increaseBy<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6a/c9/crxu6X5E_o.png" alt="在这里插入图片描述"></p> 
<ol><li> <p><strong>状态变量</strong>：<code>被状态装饰器装饰的变量，状态变量值的改变会引起UI的渲染更新</code>。示例中：<code>@State num: number = 1</code>,其中，<code>@State</code>是状态装饰器，<code>num</code>是状态变量。</p> </li><li> <p><strong>常规变量</strong>：<code>不会引起UI的刷新</code>，示例中<code>increaseBy</code>变量为<code>常规变量</code>。</p> </li><li> <p><strong>从父组件初始化</strong>：父组件使用命名参数机制，将指定参数传递给子组件。<code>子组件初始化的默认值在有父组件传值的情况下，会被覆盖</code>。</p> </li><li> <p><strong>初始化子节点</strong>：<code>父组件中状态变量可以传递给子组件</code>，初始化子组件对应的状态变量。</p> </li></ol> 
<h2><a id="4__63"></a>4 装饰器</h2> 
<p>根据状态变量的影响范围，将所有的装饰器可以大致分为<code>管理组件拥有状态的装饰器</code>和<code>管理应用拥有状态的装饰器</code></p> 
<ol><li> <p><code>管理组件拥有状态的装饰器</code>：<code>组件级别的状态管理</code>，可以观察组件内变化，和不同组件层级的变化，但需要唯一观察同一个组件树上，即同一个页面内。</p> </li><li> <p><code>管理应用拥有状态的装饰器</code>：<code>应用级别的状态管理</code>，可以观察不同页面，甚至不同UIAbility的状态变化，是应用内全局的状态管理。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/c6/0c/takUQfBw_o.png" alt="在这里插入图片描述"><br> 上图中，<code>Components部分的装饰器为组件级别的状态管理</code>，<code>Application部分为应用的状态管理</code>。开发者可以通过<code>@StorageLink/@LocalStorageLink</code>实现应用和组件状态的<code>双向同步</code>，通过<code>@StorageProp/@LocalStorageProp</code>实现应用和组件状态的<code>单向同步</code>。</p> 
<h2><a id="5__75"></a>5 组件状态的装饰器</h2> 
<h3><a id="51_State_76"></a>5.1 @State装饰器</h3> 
<p><code>@State</code>装饰的变量，或称为<code>状态变量</code>，<code>组件内状态</code>，一旦变量拥有了状态属性，就和自定义组件的渲染绑定起来。<code>当状态改变时，UI会发生对应的渲染改变</code>。与声明式范式中的其他被装饰变量一样，是<code>私有的</code>，只能从<code>组件内部访问</code>，<code>声明时必须指定其类型和本地初始化</code>。初始化也可选择使用命名参数机制<code>从父组件完成初始化</code>。</p> 
<h4><a id="511_State_80"></a>5.1.1 @State装饰的变量特点</h4> 
<ol><li><code>@State</code>装饰的变量与子组件中的<code>@Prop</code>装饰变量之间建立<code>单向数据同步</code>,与<code>@Link</code>、<code>@ObjectLink</code>装饰变量之间建立<code>双向数据同步</code>。</li><li><code>@State</code>装饰的变量<code>生命周期</code>与其所属自定义组件的生命周期相同。</li></ol> 
<h4><a id="512_State_84"></a>5.1.2 @State装饰器使用规则</h4> 
<ol><li>不支持<code>any</code>，不支持简单类型和复杂类型的<code>联合类型</code>，不允许使用<code>undefined</code>和<code>null</code>。<br> 说明：</li><li>不支持<code>Length</code>、<code>ResourceStr</code>、<code>ResourceColor</code>类型，<code>Length</code>、<code>ResourceStr</code>、<code>ResourceColor</code>为简单类型和复杂类型的<code>联合类型</code>。</li><li>类型必须被指定。</li><li>必须本地初始化。</li></ol> 
<h4><a id="513__91"></a>5.1.3 变量的传递/访问规则</h4> 
<p><img src="https://images2.imgbox.com/b5/42/HOtRRjn8_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="514__94"></a>5.1.4 可观察的状态</h4> 
<p><strong>并不是状态变量的所有更改都会引起UI的刷新，只有可以被框架观察到的修改才会引起UI刷新</strong>。该小节去介绍什么样的修改才能被观察到，以及观察到变化后，框架的是怎么引起UI刷新的，即框架的行为表现是什么。</p> 
<ol><li>当装饰的数据类型为<code>boolean</code>、<code>string</code>、<code>number</code>类型时，可以观察到数值的变化。</li><li>当装饰的数据类型为<code>class</code>或<code>Object</code>时，可以观察到<code>自身和其属性</code>赋值的变化，即<code>Object.keys(observedObject)</code>返回的所有属性。简单理解为<code>类一级属性可以观察到变化</code>。</li><li>当装饰的对象是<code>array</code>时，可以观察到数组本身的<code>赋值</code>和<code>添加</code>、<code>删除</code>、<code>更新数组</code>的变化。但<code>无法观察array中元素内的属性</code>。</li><li>当装饰的对象是<code>Date</code>时，可以观察到Date整体的赋值，同时可通过调用Date的<code>setxxx()方法</code>来更新<code>Date</code>的属性。</li></ol> 
<p>当状态变量被改变时，查询依赖该状态变量的组件；执行依赖该状态变量的组件的更新方法，组件更新渲染；<strong>和该状态变量不相关的组件或者UI描述不会发生重新渲染</strong>，从而实现页面渲染的按需更新。</p> 
<h4><a id="515__104"></a>5.1.5 实例</h4> 
<pre><code class="prism language-typescript">

<span class="token keyword">class</span> <span class="token class-name"><span class="token constant">W</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> say<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> p <span class="token operator">:</span> <span class="token constant">P</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">P</span></span><span class="token punctuation">(</span><span class="token string">"Yvan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>say<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>say <span class="token operator">=</span> say<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name"><span class="token constant">P</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct MyComponent <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 本地初始化</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> count<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> w<span class="token operator">:</span> <span class="token constant">W</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">W</span></span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Button</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token punctuation">.</span>say<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token punctuation">.</span>p<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 值改变后UI刷新</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token punctuation">.</span>say <span class="token operator">=</span> <span class="token string">'Hi'</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token punctuation">.</span>p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Joe'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
<span class="token keyword">export</span> struct Index <span class="token punctuation">{<!-- --></span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 初始值可传入</span>
      <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>count<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token string">'100%'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<h3><a id="52_Prop_158"></a>5.2 @Prop装饰器</h3> 
<p>@Prop装饰的变量实现<code>父子组件单向同步</code>，<code>与父组件建立单向</code>的同步关系。<strong>@Prop装饰的变量是可变的，但是变化不会同步回其父组件。</strong></p> 
<h4><a id="521_Prop_163"></a>5.2.1 @Prop装饰的变量特点</h4> 
<ol><li><code>数据源改变会更新@Prop变量</code></li><li><code>@Prop变量可以本地修改，但不会同步给数据源</code></li><li>@Prop修饰复杂类型时是<code>深拷贝</code>，在拷贝的过程中除了基本类型、Map、Set、Date、Array外，都会丢失类型。</li><li>@Prop装饰器<code>不能在@Entry装饰的入口组件中使用</code></li></ol> 
<h4><a id="522_Prop_169"></a>5.2.2 @Prop装饰器使用规则</h4> 
<ol><li>对父组件状态变量值的修改，将同步给子组件@Prop装饰的变量，子组件@Prop变量的修改不会同步到父组件的状态变量上，<code>单向同步</code></li><li><code>@Prop</code>装饰的变量和<code>@State</code>以及<code>其他装饰器</code>同步时双方的<code>类型必须相同</code></li><li>在组件复用场景，建议@Prop深度嵌套数据不要超过5层，嵌套太多会导致深拷贝占用的空间过大以及GarbageCollection(垃圾回收)，引起性能问题，此时更建议使用@ObjectLink。如果子组件的数据不想同步回父组件，建议采用@Reusable中的aboutToReuse，实现父组件向子组件传递数据</li><li>@Prop需要被初始化，如果没有进行本地初始化的，则必须通过父组件进行初始化。如果进行了本地初始化，那么是可以不通过父组件进行初始化的。</li><li>允许本地初始化。</li></ol> 
<h4><a id="523__178"></a>5.2.3 变量的传递/访问规则说明</h4> 
<p><img src="https://images2.imgbox.com/f9/db/g0JG6OEH_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="524__180"></a>5.2.4 可观察的状态</h4> 
<p>基本和5.1.4 @State的观察变化相同，这里列举下不同点：</p> 
<ol><li>对于嵌套场景，如果class是被@Observed装饰的，可以观察到class属性的变化</li><li>除了@State，数据源也可以用@Link或@Prop装饰，对@Prop的同步机制是相同的。</li><li>当父组件的数据源更新时，子组件的@Prop装饰的变量将被来自父组件的数据源重置，所有@Prop装饰的本地的修改将被父组件的更新覆盖。</li></ol> 
<h4><a id="525__186"></a>5.2.5 实例一：简单案例</h4> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CountDownComponent <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span> count<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">子组件 count:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token comment">// @Prop装饰的变量不会同步给父组件</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">子组件 count+1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">子组件 count-1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct ParentComponent <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> count<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">父组件 count:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token comment">// 父组件的数据源的修改会同步给子组件</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">父组件 count+1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">父组件 count-1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token function">CountDownComponent</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> count<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
<span class="token keyword">export</span> struct Index <span class="token punctuation">{<!-- --></span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">ParentComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token string">'100%'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token string">'100%'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">justifyContent</span><span class="token punctuation">(</span>FlexAlign<span class="token punctuation">.</span>Center<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">alignItems</span><span class="token punctuation">(</span>VerticalAlign<span class="token punctuation">.</span>Center<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总结一句话：<strong>子组件中@Prop装饰器修饰的变量的变化，不会同步给父组件数据源。父组件的数据源(实例的@State修饰变量)的变化会同步覆盖到子组件@Prop变量。</strong></p> 
<h4><a id="526__242"></a>5.2.6 实例二：嵌套案例</h4> 
<pre><code class="prism language-typescript"><span class="token comment">// 以下是嵌套类对象的数据结构。</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Observed</span></span>
<span class="token keyword">class</span> <span class="token class-name">ClassA</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> title<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Observed</span></span>
<span class="token keyword">class</span> <span class="token class-name">ClassB</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> a<span class="token operator">:</span> ClassA<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> a<span class="token operator">:</span> ClassA<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Parent <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> votes<span class="token operator">:</span> ClassB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassB</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ClassA</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">'change ClassB name'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 第一层属性被修改，当前组件、Child组件都能观察到</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>votes<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"B name"</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">'change ClassA title'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 第二层属性被修改，Child不能观察到。</span>
            <span class="token comment">// @Observed修饰后，Child的值往下传，Child1组件能观察到。</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>votes<span class="token punctuation">.</span>a<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">"A title"</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">Child</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> vote<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>votes <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Child <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span> vote<span class="token operator">:</span> ClassB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassB</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ClassA</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vote<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 第一层属性被修改，当前组件都能观察到</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>vote<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Bye'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vote<span class="token punctuation">.</span>a<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 当前组件不能观察到</span>
          <span class="token comment">// @Observed修饰后，Child1组件能观察到。</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>vote<span class="token punctuation">.</span>a<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">"openHarmony"</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Child1</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> vote1<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vote<span class="token punctuation">.</span>a <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Child1 <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span> vote1<span class="token operator">:</span> ClassA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassA</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vote1<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 只有当前组件能观察</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>vote1<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">'Bye Bye'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
<span class="token keyword">export</span> struct Index <span class="token punctuation">{<!-- --></span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token string">'100%'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token string">'100%'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">justifyContent</span><span class="token punctuation">(</span>FlexAlign<span class="token punctuation">.</span>Center<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">alignItems</span><span class="token punctuation">(</span>VerticalAlign<span class="token punctuation">.</span>Center<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol><li>在嵌套场景下，每一层都要用<code>@Observed装饰</code>，且每一层都要被<code>@Prop</code>接收，这样才能观察到嵌套。</li><li>在嵌套场景下，也只有第一层属性变化能被观察到，<code>@Observed装饰</code>只能使观察的值往下传，这个地方难以说清楚，看上面Child和Child1的案例表现。</li></ol> 
<h3><a id="53_Link_345"></a>5.3 @Link装饰器</h3> 
<p>子组件中被<code>@Link</code>装饰的变量与其父组件中对应的数据源建立<code>双向数据绑定</code>，实现组件间<code>父子双向同步</code>。@Link装饰的变量与其父组件中的数据源共享相同的值。但需要注意<code>@Link装饰器不能在@Entry装饰的自定义组件中使用</code>。</p> 
<h4><a id="531__348"></a>5.3.1 装饰器使用规则说明</h4> 
<ol><li>父组件中@State, @StorageLink和@Link 和子组件@Link可以建立双向数据同步，反之亦然。</li><li>类型必须被指定，且和双向绑定状态变量的类型相同。</li><li>不支持any，不支持简单类型和复杂类型的联合类型，不允许使用undefined和null</li><li>不支持Length、ResourceStr、ResourceColor类型，Length、ResourceStr、ResourceColor为简单类型和复杂类型的联合类型。</li><li>禁止本地初始化。</li></ol> 
<h4><a id="532__356"></a>5.3.2 变量的传递/访问规则说明</h4> 
<p><img src="https://images2.imgbox.com/07/10/sGneWEDz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="533__358"></a>5.3.3 可观察的状态</h4> 
<p>基本和5.1.4 @State的观察变化相同</p> 
<h4><a id="534__362"></a>5.3.4 实例</h4> 
<pre><code class="prism language-typescript"><span class="token keyword">class</span> <span class="token class-name">GreenButtonState</span> <span class="token punctuation">{<!-- --></span>
  width<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>width<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct GreenButton <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Link</span></span> greenButtonState<span class="token operator">:</span> GreenButtonState<span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">'Green Button'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>greenButtonState<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">backgroundColor</span><span class="token punctuation">(</span><span class="token string">'#64bb5c'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子组件改变@Link属性，同步到父组件中</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>greenButtonState<span class="token punctuation">.</span>width <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct ShufflingContainer <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> greenButtonState<span class="token operator">:</span> GreenButtonState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GreenButtonState</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Flex</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> direction<span class="token operator">:</span> FlexDirection<span class="token punctuation">.</span>Column<span class="token punctuation">,</span> alignItems<span class="token operator">:</span> ItemAlign<span class="token punctuation">.</span>Center <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从父组件@State向子组件@Link数据同步</span>
        <span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">'Parent View: Set GreenButton'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>greenButtonState<span class="token punctuation">.</span>width <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 初始化@Link</span>
        <span class="token function">GreenButton</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> greenButtonState<span class="token operator">:</span> $greenButtonState <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">margin</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在子组件中使用<code>@Link</code>装饰状态变量需要保证该<code>变量与数据源类型完全相同</code>，且该数据源需为被诸如<code>@State</code>等装饰器装饰的<code>状态变量</code>。</p> 
<h3><a id="54_ProvideConsume_409"></a>5.4 @Provide装饰器和@Consume装饰器</h3> 
<p><code>@Provide和@Consume，应用于与后代组件的双向数据同步</code>，应用于状态数据在多个层级之间传递的场景。不同于上文提到的父子组件之间通过命名参数机制传递，<code>@Provide和@Consume摆脱参数传递机制的束缚，实现跨层级传递</code>。</p> 
<ol><li><code>@Provide</code>装饰的变量是在<code>祖先组件中</code>，可以理解为被<code>“提供”</code>给后代的状态变量。</li><li><code>@Consume</code>装饰的变量是在<code>后代组件中</code>，去<code>“消费（绑定）”</code>祖先组件提供的变量。</li></ol> 
<p><code>@Provide</code>和<code>@Consume</code>可以通过相同的<code>变量名</code>或者相同的<code>变量别名</code>绑定，建议<code>类型相同</code>，<code>@Provide</code>修饰的变量和<code>@Consume</code>修饰的变量是<code>一对多</code>的关系。</p> 
<p><code>@State</code>的规则同样适用于<code>@Provide</code>，差异为<code>@Provide</code>还作为<code>多层后代的同步源</code>。</p> 
<h4><a id="541__419"></a>5.4.1 变量的传递/访问规则说明</h4> 
<p><img src="https://images2.imgbox.com/6d/98/LuxgLLLZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/03/db/3BkyOgdp_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="542__423"></a>5.4.2 可观察的状态</h4> 
<p>基本和5.1.4 @State的观察变化相同，我们直接看实例</p> 
<h4><a id="543__426"></a>5.4.3 实例</h4> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompD <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// @Consume装饰的变量通过相同的属性名绑定其祖先组件CompA内的@Provide装饰的变量</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Consume</span></span> reviewVotes<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">reviewVotes(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>reviewVotes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">reviewVotes(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>reviewVotes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">), give +1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reviewVotes <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token string">'50%'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompC <span class="token punctuation">{<!-- --></span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> space<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">CompD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">CompD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompB <span class="token punctuation">{<!-- --></span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">CompC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompA <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// @Provide装饰的变量reviewVotes由入口组件CompA提供其后代组件</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Provide</span></span> reviewVotes<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">reviewVotes(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>reviewVotes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">), give +1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reviewVotes <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">CompB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>@BuilderParam</code>尾随闭包情况下<code>@Provide</code>会报未定义错误，和<code>@BuidlerParam</code>连用的时候要谨慎<code>this</code>的指向。</p> 
<h3><a id="55_ObservedObjectLink_477"></a>5.5 @Observed装饰器和@ObjectLink装饰器</h3> 
<p>上文所述的装饰器仅能观察到第一层的变化，但是在实际应用开发中，应用会根据开发需要，封装自己的数据模型。对于多层嵌套的情况，比如二维数组，或者数组项class，或者class的属性是class，他们的第二层的属性变化是无法观察到的。这就引出了<code>@Observed/@ObjectLink</code>装饰器。<br> <code>@ObjectLink和@Observed</code>类装饰器用于在涉及<code>嵌套对象或数组</code>的场景中进行<code>双向数据同步</code></p> 
<p><code>@Observed类装饰器</code>：装饰<code>class</code>。需要放在class的定义前，使用new创建类对象。<br> <code>@ObjectLink变量装饰器</code>：必须为被<code>@Observed</code>装饰的<code>class</code>实例，必须指定类型。不支持简单类型，可以使用<code>@Prop</code>。<code>@ObjectLink的变量只读，但变量的属性可变</code>。<code>@ObjectLink</code>装饰的变量不能被赋值，如果要使用赋值操作，请使用<code>@Prop</code>。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/da6450dc662047f51a4b9381a80ee56d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【鸿蒙开发】第八章 ArkTS语言UI范式-基础语法（二）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bf66c5ba1bc456d286d8a783bee6bbe0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何查看虚拟机的IP地址</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>