<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【.Net Core】使用SignalR实现实时通信 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【.Net Core】使用SignalR实现实时通信" />
<meta property="og:description" content="SignalR SignalR是一个.NET Core/.NET Framework的开源实时框架. SignalR的可使用Web Socket, Server Sent Events 和 Long Polling作为底层传输方式.
SignalR基于这三种技术构建, 抽象于它们之上, 它让你更好的关注业务问题而不是底层传输技术问题.
SignalR这个框架分服务器端和客户端, 服务器端支持ASP.NET Core 和 ASP.NET; 而客户端除了支持浏览器里的javascript以外, 也支持其它类型的客户端, 例如桌面应用.
三种通信方式 long polling（长轮询） 长轮询是客户端发起请求到服务端，服务器有数据就会直接返回。如果没有数据就保持连接并且等待，一直到有新的数据返回。如果请求保持到一段时间仍然没有返回，这时候就会超时，然后客户端再次发起请求。
这种方式优点就是简单，缺点就是资源消耗太多，基本是不考虑的。
server sent events（sse） 如果使用了sse，服务器就拥有了向客户端推送的能力，这些信息和流信息差不多，期间会保持连接。
这种方式优点还是简单，也支持自动重连，综合来讲比long polling好用。缺点也很明显，不支持旧的浏览器不说，还只能发送本文信息，而且浏览器对sse还有连接数量的限制（6个）。
web socket web socket允许客户端和服务端同时向对方发送消息（也就是双工通信），而且不限制信息类型。虽然浏览器同样有连接数量限制（可能是50个），但比sse强得多。理论上最优先使用。
回落机制 在Web Socket, Server Sent Events 和 Long Polling中
Web Socket仅支持比较现代的浏览器, Web服务器也不能太老.
而Server Sent Events 情况可能好一点, 但是也存在同样的问题.
所以SignalR采用了回落机制, SignalR有能力去协商支持的传输类型.
RPC RPC (Remote Procedure Call). 它的优点就是可以像调用本地方法一样调用远程服务.
SignalR采用RPC范式来进行客户端与服务器端之间的通信.
SignalR利用底层传输来让服务器可以调用客户端的方法, 反之亦然, 这些方法可以带参数, 参数也可以是复杂对象, SignalR负责序列化和反序列化." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a4fbfa9454cb326fd33ffc9cc11973dd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-23T09:51:32+08:00" />
<meta property="article:modified_time" content="2022-08-23T09:51:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【.Net Core】使用SignalR实现实时通信</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="SignalR_0"></a>SignalR</h3> 
<p>SignalR是一个.NET Core/.NET Framework的开源实时框架. SignalR的可使用Web Socket, Server Sent Events 和 Long Polling作为底层传输方式.</p> 
<p>SignalR基于这三种技术构建, 抽象于它们之上, 它让你更好的关注业务问题而不是底层传输技术问题.</p> 
<p>SignalR这个框架分服务器端和客户端, 服务器端支持ASP.NET Core 和 ASP.NET; 而客户端除了支持浏览器里的javascript以外, 也支持其它类型的客户端, 例如桌面应用.</p> 
<h3><a id="_7"></a>三种通信方式</h3> 
<h4><a id="long_polling_9"></a>long polling（长轮询）</h4> 
<p>长轮询是客户端发起请求到服务端，服务器有数据就会直接返回。如果没有数据就保持连接并且等待，一直到有新的数据返回。如果请求保持到一段时间仍然没有返回，这时候就会超时，然后客户端再次发起请求。</p> 
<p>这种方式优点就是简单，缺点就是资源消耗太多，基本是不考虑的。</p> 
<h4><a id="server_sent_eventssse_15"></a>server sent events（sse）</h4> 
<p>如果使用了sse，服务器就拥有了向客户端推送的能力，这些信息和流信息差不多，期间会保持连接。</p> 
<p>这种方式优点还是简单，也支持自动重连，综合来讲比long polling好用。缺点也很明显，不支持旧的浏览器不说，还只能发送本文信息，而且浏览器对sse还有连接数量的限制（6个）。</p> 
<h4><a id="web_socket_21"></a>web socket</h4> 
<p>web socket允许客户端和服务端同时向对方发送消息（也就是双工通信），而且不限制信息类型。虽然浏览器同样有连接数量限制（可能是50个），但比sse强得多。理论上最优先使用。</p> 
<h4><a id="_24"></a>回落机制</h4> 
<p>在Web Socket, Server Sent Events 和 Long Polling中</p> 
<p>Web Socket仅支持比较现代的浏览器, Web服务器也不能太老.<br> 而Server Sent Events 情况可能好一点, 但是也存在同样的问题.<br> 所以SignalR采用了回落机制, SignalR有能力去协商支持的传输类型.</p> 
<p><img src="https://images2.imgbox.com/48/c1/gufxkF4V_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="RPC_33"></a>RPC</h3> 
<p>RPC (Remote Procedure Call). 它的优点就是可以像调用本地方法一样调用远程服务.</p> 
<p>SignalR采用RPC范式来进行客户端与服务器端之间的通信.</p> 
<p>SignalR利用底层传输来让服务器可以调用客户端的方法, 反之亦然, 这些方法可以带参数, 参数也可以是复杂对象, SignalR负责序列化和反序列化.</p> 
<h3><a id="Hub_41"></a>Hub</h3> 
<p>Hub是SignalR的一个组件, 它运行在ASP.NET Core应用里. 所以它是服务器端的一个类.</p> 
<p>Hub使用RPC接受从客户端发来的消息, 也能把消息发送给客户端. 所以它就是一个通信用的Hub.</p> 
<p>在ASP.NET Core里, 自己创建的Hub类需要继承于基类Hub.</p> 
<p>在Hub类里面, 我们就可以调用所有客户端上的方法了. 同样客户端也可以调用Hub类里的方法.<br> <img src="https://images2.imgbox.com/53/d6/tKbczhVL_o.png" alt="在这里插入图片描述"><br> 这种Hub+RPC的方式还是非常适合实时场景的.</p> 
<p>之前说过方法调用的时候可以传递复杂参数, SignalR可以将参数序列化和反序列化. 这些参数被序列化的格式叫做Hub 协议, 所以Hub协议就是一种用来序列化和反序列化的格式.</p> 
<p>Hub协议的默认协议是JSON, 还支持另外一个协议是MessagePack. MessagePack是二进制格式的, 它比JSON更紧凑, 而且处理起来更简单快速, 因为它是二进制的.</p> 
<h3><a id="_57"></a>实现</h3> 
<blockquote> 
 <p>.net core的SDK已经内置了Microsoft.AspNetCore.SignalR.Core</p> 
</blockquote> 
<p>接下来注入SignalR，如下代码：</p> 
<pre><code class="prism language-csharp"><span class="token comment">//注入SignalR实时通讯，默认用json传输</span>
            services<span class="token punctuation">.</span><span class="token function">AddSignalR</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//客户端发保持连接请求到服务端最长间隔，默认30秒，改成4分钟，网页需跟着设置connection.keepAliveIntervalInMilliseconds = 12e4;即2分钟</span>
                options<span class="token punctuation">.</span>ClientTimeoutInterval <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//服务端发保持连接请求到客户端间隔，默认15秒，改成2分钟，网页需跟着设置connection.serverTimeoutInMilliseconds = 24e4;即4分钟</span>
                options<span class="token punctuation">.</span>KeepAliveInterval <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这个解释一下，SignalR默认是用Json传输的，但是还有另外一种更短小精悍的传输方式MessagePack，用这个的话性能会稍微高点，但是需要另外引入一个DLL，JAVA端调用的话也是暂时不支持的。但是我其实是不需要这点性能的，所以我就用默认的json好了。另外有个概念，就是实时通信，其实是需要发“心跳包”的，就是双方都需要确定对方还在不在，若挂掉的话我好重连或者把你干掉啊，所以就有了两个参数，一个是发心跳包的间隔时间，另一个就是等待对方心跳包的最长等待时间。一般等待的时间设置成发心跳包的间隔时间的两倍即可，默认KeepAliveInterval是15秒，ClientTimeoutInterval是30秒，我觉得不需要这么频繁的确认对方“死掉”了没，所以我改成2分钟发一次心跳包，最长等待对方的心跳包时间是4分钟，对应的客户端就得设置</p> 
<p>注入了SignalR之后，接下来需要使用WebSocket和SignalR，对应代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token comment">//添加WebSocket支持，SignalR优先使用WebSocket传输</span>
            app<span class="token punctuation">.</span><span class="token function">UseWebSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//app.UseWebSockets(new WebSocketOptions</span>
            <span class="token comment">//{<!-- --></span>
            <span class="token comment">//    //发送保持连接请求的时间间隔，默认2分钟</span>
            <span class="token comment">//    KeepAliveInterval = TimeSpan.FromMinutes(2)</span>
            <span class="token comment">//});</span>
            app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                endpoints<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                endpoints<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">MapHub</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MessageHub<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里提醒一下，WebSocket只是实现SignalR实时通信的一种手段，若这个走不通的情况下，他还可以降级使用SSE，再不行就用轮询的方式，也就是我最开始想的那种办法。</p> 
<p>另外得说一下的是假如前端调用的话，他是需要测试的，这时候其实需要跨域访问，不然每次打包好放到服务器再测这个实时通信的话有点麻烦。添加跨域的代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token preprocessor property">#<span class="token directive keyword">if</span> DEBUG</span>
            <span class="token comment">//注入跨域</span>
            services<span class="token punctuation">.</span><span class="token function">AddCors</span><span class="token punctuation">(</span>option <span class="token operator">=&gt;</span> option<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"cors"</span><span class="token punctuation">,</span>
                policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">AllowAnyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllowAnyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllowCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">WithOrigins</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8001"</span><span class="token punctuation">,</span> <span class="token string">"http://localhost:8000"</span><span class="token punctuation">,</span> <span class="token string">"http://localhost:8002"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endif</span></span>
</code></pre> 
<p>然后加上如下代码即可。</p> 
<pre><code class="prism language-csharp"><span class="token preprocessor property">#<span class="token directive keyword">if</span> DEBUG</span>
            <span class="token comment">//允许跨域，不支持向所有域名开放了，会有错误提示</span>
            app<span class="token punctuation">.</span><span class="token function">UseCors</span><span class="token punctuation">(</span><span class="token string">"cors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endif</span></span>
</code></pre> 
<p>好了，可以开始动工了。创建一个MessageHub：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageHub</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Hub</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUidClient</span> _uidClient<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">MessageHub</span><span class="token punctuation">(</span><span class="token class-name">IUidClient</span> uidClient<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _uidClient <span class="token operator">=</span> uidClient<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnConnectedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _uidClient<span class="token punctuation">.</span><span class="token function">GetLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将同一个人的连接ID绑定到同一个分组，推送时就推送给这个分组</span>
            <span class="token keyword">await</span> Groups<span class="token punctuation">.</span><span class="token function">AddToGroupAsync</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>ConnectionId<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Account<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>由于每次连接的连接ID不同，所以最好把他和登录用户的用户ID绑定起来，推送时直接推给绑定的这个用户ID即可，做法可以直接把连接ID和登录用户ID绑定起来，把这个用户ID作为一个分组ID。</p> 
<p>然后使用时就如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">BaseService<span class="token punctuation">&lt;</span>Message<span class="token punctuation">,</span> ObjectId<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IMessageService</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUidClient</span> _uidClient<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IHubContext<span class="token punctuation">&lt;</span>MessageHub<span class="token punctuation">&gt;</span></span> _messageHub<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">MessageService</span><span class="token punctuation">(</span><span class="token class-name">IMessageRepository</span> repository<span class="token punctuation">,</span> <span class="token class-name">IUidClient</span> uidClient<span class="token punctuation">,</span> <span class="token class-name">IHubContext<span class="token punctuation">&lt;</span>MessageHub<span class="token punctuation">&gt;</span></span> messageHub<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>repository<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _uidClient <span class="token operator">=</span> uidClient<span class="token punctuation">;</span>
            _messageHub <span class="token operator">=</span> messageHub<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 添加并推送站内信</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="dto"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">MessageDTO</span> dto<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> now <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
            
            <span class="token class-name"><span class="token keyword">var</span></span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Message</span>
            <span class="token punctuation">{<!-- --></span>
                Id <span class="token operator">=</span> ObjectId<span class="token punctuation">.</span><span class="token function">GenerateNewId</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span>
                CreateTime <span class="token operator">=</span> now<span class="token punctuation">,</span>
                Name <span class="token operator">=</span> dto<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                Detail <span class="token operator">=</span> dto<span class="token punctuation">.</span>Detail<span class="token punctuation">,</span>
                ToUser <span class="token operator">=</span> dto<span class="token punctuation">.</span>ToUser<span class="token punctuation">,</span>
                Type <span class="token operator">=</span> dto<span class="token punctuation">.</span>Type
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> push <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PushMessageDTO</span>
            <span class="token punctuation">{<!-- --></span>
                Id <span class="token operator">=</span> log<span class="token punctuation">.</span>Id<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> log<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                Detail <span class="token operator">=</span> log<span class="token punctuation">.</span>Detail<span class="token punctuation">,</span>
                Type <span class="token operator">=</span> log<span class="token punctuation">.</span>Type<span class="token punctuation">,</span>
                ToUser <span class="token operator">=</span> log<span class="token punctuation">.</span>ToUser<span class="token punctuation">,</span>
                CreateTime <span class="token operator">=</span> now
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> Repository<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//推送站内信</span>
            <span class="token keyword">await</span> _messageHub<span class="token punctuation">.</span>Clients<span class="token punctuation">.</span><span class="token function">Groups</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span>ToUser<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token string">"newmsg"</span><span class="token punctuation">,</span> push<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//推送未读条数</span>
            <span class="token keyword">await</span> <span class="token function">SendUnreadCount</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span>ToUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>dto<span class="token punctuation">.</span>PushCorpWeixin<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> content <span class="token operator">=</span> <span class="token string">@"&lt;font color='blue'&gt;{0}&lt;/font&gt;
&lt;font color='comment'&gt;{1}&lt;/font&gt;
系统：**CMS**
站内信ID：&lt;font color='info'&gt;{2}&lt;/font&gt;
详情：&lt;font color='comment'&gt;{3}&lt;/font&gt;"</span><span class="token punctuation">;</span>

                <span class="token comment">//把站内信推送到企业微信</span>
                <span class="token keyword">await</span> _uidClient<span class="token punctuation">.</span><span class="token function">SendMarkdown</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CorpSendTextDto</span>
                <span class="token punctuation">{<!-- --></span>
                    touser <span class="token operator">=</span> dto<span class="token punctuation">.</span>ToUser<span class="token punctuation">,</span>
                    content <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> dto<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> now<span class="token punctuation">,</span> log<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> dto<span class="token punctuation">.</span>Detail<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 获取本人的站内信列表</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="name"&gt;标题&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="detail"&gt;详情&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="unread"&gt;只显示未读&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="type"&gt;类型&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="createStart"&gt;创建起始时间&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="createEnd"&gt;创建结束时间&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="pageIndex"&gt;当前页&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="pageSize"&gt;每页个数&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>PagedData<span class="token punctuation">&lt;</span>PushMessageDTO<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetMyMessage</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> detail<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> unread <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">EnumMessageType<span class="token punctuation">?</span></span> type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DateTime<span class="token punctuation">?</span></span> createStart <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DateTime<span class="token punctuation">?</span></span> createEnd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> pageIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _uidClient<span class="token punctuation">.</span><span class="token function">GetLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>Message<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> exp <span class="token operator">=</span> o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>ToUser <span class="token operator">==</span> user<span class="token punctuation">.</span>Account<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>unread<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                exp <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>ReadTime <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                exp <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>Name<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                exp <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>Detail<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                exp <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>Type <span class="token operator">==</span> type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>createStart <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                exp<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>CreateTime <span class="token operator">&gt;=</span> createStart<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>createEnd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                exp<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>CreateTime <span class="token operator">&lt;</span> createEnd<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">await</span> Repository<span class="token punctuation">.</span><span class="token function">FindPageObjectList</span><span class="token punctuation">(</span>exp<span class="token punctuation">,</span> o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> pageIndex<span class="token punctuation">,</span>
                pageSize<span class="token punctuation">,</span> o <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PushMessageDTO</span>
                <span class="token punctuation">{<!-- --></span>
                    Id <span class="token operator">=</span> o<span class="token punctuation">.</span>Id<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    CreateTime <span class="token operator">=</span> o<span class="token punctuation">.</span>CreateTime<span class="token punctuation">,</span>
                    Detail <span class="token operator">=</span> o<span class="token punctuation">.</span>Detail<span class="token punctuation">,</span>
                    Name <span class="token operator">=</span> o<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                    ToUser <span class="token operator">=</span> o<span class="token punctuation">.</span>ToUser<span class="token punctuation">,</span>
                    Type <span class="token operator">=</span> o<span class="token punctuation">.</span>Type<span class="token punctuation">,</span>
                    ReadTime <span class="token operator">=</span> o<span class="token punctuation">.</span>ReadTime
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 设置已读</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="id"&gt;站内信ID&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token class-name">ObjectId</span> id<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> msg <span class="token operator">=</span> <span class="token keyword">await</span> Repository<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CmsException</span><span class="token punctuation">(</span>EnumStatusCode<span class="token punctuation">.</span>ArgumentOutOfRange<span class="token punctuation">,</span> <span class="token string">"不存在此站内信"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>ReadTime <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//已读的不再更新读取时间</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            msg<span class="token punctuation">.</span>ReadTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
            <span class="token keyword">await</span> Repository<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">"ReadTime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token function">SendUnreadCount</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>ToUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 设置本人全部已读</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">ReadAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _uidClient<span class="token punctuation">.</span><span class="token function">GetLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> Repository<span class="token punctuation">.</span><span class="token function">UpdateMany</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>ToUser <span class="token operator">==</span> user<span class="token punctuation">.</span>Account <span class="token operator">&amp;&amp;</span> o<span class="token punctuation">.</span>ReadTime <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> o <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Message</span>
            <span class="token punctuation">{<!-- --></span>
                ReadTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> <span class="token function">SendUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Account<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 获取本人未读条数</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetUnreadCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _uidClient<span class="token punctuation">.</span><span class="token function">GetLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> Repository<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>ToUser <span class="token operator">==</span> user<span class="token punctuation">.</span>Account <span class="token operator">&amp;&amp;</span> o<span class="token punctuation">.</span>ReadTime <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 推送未读数到前端</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendUnreadCount</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> account<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> count <span class="token operator">=</span> <span class="token keyword">await</span> Repository<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>ToUser <span class="token operator">==</span> account <span class="token operator">&amp;&amp;</span> o<span class="token punctuation">.</span>ReadTime <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _messageHub<span class="token punctuation">.</span>Clients<span class="token punctuation">.</span><span class="token function">Groups</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token string">"unread"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>IHubContext可以直接注入并且使用，然后调用_messageHub.Clients.Groups(account).SendAsync即可推送。接下来就简单了，在MessageController里把这些接口暴露出去，通过HTTP请求添加站内信，或者直接内部调用添加站内信接口，就可以添加站内信并且推送给前端页面了，当然除了站内信，我们还可以做得更多，比如比较重要的顺便也推送到第三方app，比如企业微信或钉钉，这样你还会怕错过重要信息？<br> 　　接下来到了客户端了，客户端只说网页端的，代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"container"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"button"</span> id<span class="token operator">=</span><span class="token string">"getValues"</span> <span class="token keyword">value</span><span class="token operator">=</span><span class="token string">"Send"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token class-name">ul</span> id<span class="token operator">=</span><span class="token string">"discussion"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token class-name">script</span>
        src<span class="token operator">=</span><span class="token string">"https://cdn.jsdelivr.net/npm/@microsoft/signalr@3.0.0-preview7.19365.7/dist/browser/signalr.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token class-name">script</span> type<span class="token operator">=</span><span class="token string">"text/javascript"</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">signalR<span class="token punctuation">.</span>HubConnectionBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUrl</span><span class="token punctuation">(</span><span class="token string">"/message"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span>serverTimeoutInMilliseconds <span class="token operator">=</span> <span class="token number">24e4</span><span class="token punctuation">;</span> 
        connection<span class="token punctuation">.</span>keepAliveIntervalInMilliseconds <span class="token operator">=</span> <span class="token number">12e4</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"getValues"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        connection<span class="token punctuation">.</span><span class="token keyword">on</span><span class="token punctuation">(</span>'newmsg'<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> liElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>'li'<span class="token punctuation">)</span><span class="token punctuation">;</span>
            liElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> 'Someone caled a controller method <span class="token class-name">with</span> <span class="token keyword">value</span><span class="token punctuation">:</span> ' <span class="token operator">+</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>'discussion'<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>liElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"api/message/sendtest"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">signalR<span class="token punctuation">.</span>HubConnectionBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUrl</span><span class="token punctuation">(</span><span class="token string">"/message"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        connection<span class="token punctuation">.</span><span class="token keyword">on</span><span class="token punctuation">(</span>'newmsg'<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
</code></pre> 
<p>上面的代码还是需要解释下的，serverTimeoutInMilliseconds和keepAliveIntervalInMilliseconds必须和后端的配置保持一致，不然分分钟出现下面异常：</p> 
<p><img src="https://images2.imgbox.com/48/91/gTSC6kZi_o.png" alt="在这里插入图片描述"><br> 这是因为你没有在我规定的时间内向我发送“心跳包”，所以我认为你已经“阵亡”了，为了避免不必要的傻傻连接，我停止了连接。另外需要说的是重连机制，有多种重连机制，这里我选择每隔10秒重连一次，因为我觉得需要重连，那一般是因为服务器挂了，既然挂了，那我每隔10秒重连也是不会浪费服务器性能的，浪费的是浏览器的性能，客户端的就算了，忽略不计。自动重连代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">async</span> <span class="token return-type class-name">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">onclose</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">await</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>当然还有其他很多重连的方案，可以去官网看看。</p> 
<p>当然若你的客户端是用vue写的话，写法会有些不同，如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token string">'../../public/signalR.js'</span>
<span class="token keyword">const</span> wsUrl <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'/msg'</span> <span class="token operator">:</span><span class="token string">'http://xxx.net/msg'</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">signalR<span class="token punctuation">.</span>HubConnectionBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withUrl</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
connection<span class="token punctuation">.</span>serverTimeoutInMilliseconds <span class="token operator">=</span> <span class="token number">24e4</span>
connection<span class="token punctuation">.</span>keepAliveIntervalInMilliseconds <span class="token operator">=</span> <span class="token number">12e4</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$connection <span class="token operator">=</span> connection
</code></pre> 
<p>接下来就可以用this.$connection 愉快的使用了。</p> 
<p>到这里或许你觉得大功告成了，若没看浏览器的控制台输出，我也是这么认为的，然后控制台出现了红色！：<br> 　　<img src="https://images2.imgbox.com/f7/bb/5kCGPCx7_o.png" alt="在这里插入图片描述"><br> 虽然出现了这个红色，但是依然可以正常使用，只是降级了，不使用WebSocket了，心跳包变成了一个个的post请求</p> 
<p>这个是咋回事呢，咋就用不了WebSocket呢，我的是谷歌浏览器呀，肯定是支持WebSocket的，咋办，只好去群里讨教了，后来大神告诉我，需要在ngnix配置一下下面的就可以了：</p> 
<pre><code class="prism language-powershell">location <span class="token operator">/</span>msg  <span class="token punctuation">{<!-- --></span>
          proxy_connect_timeout   300<span class="token punctuation">;</span>
          proxy_read_timeout        300<span class="token punctuation">;</span>
          proxy_send_timeout        300<span class="token punctuation">;</span>
          proxy_pass http:<span class="token operator">/</span><span class="token operator">/</span>xxx<span class="token punctuation">.</span>net<span class="token punctuation">;</span>
          proxy_http_version 1<span class="token punctuation">.</span>1<span class="token punctuation">;</span>
          proxy_set_header Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
          proxy_set_header Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>
          proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>
          proxy_cache_bypass <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_426"></a>来源</h3> 
<p><a href="https://baijiahao.baidu.com/s?id=1609579444741128721&amp;wfr=spider&amp;for=pc" rel="nofollow">ASP.NET Core的实时库：SignalR简介及使用</a><br> <a href="https://www.cnblogs.com/wl-blog/p/15771998.html" rel="nofollow">.Net Core——SignalR（实时web应用）</a><br> <a href="https://www.cnblogs.com/hambert/p/11767125.html" rel="nofollow">在.net core3.0中使用SignalR实现实时通信</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a7a47c98f30d16635549ef86e8870250/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Unity Shader实现《氮气加速特效》</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3796b50ab8943d180269f2d1c562793c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python-popen函数解析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>