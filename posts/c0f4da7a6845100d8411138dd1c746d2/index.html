<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于FFmpeg,ANativeWindow渲染实现播放器功能 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于FFmpeg,ANativeWindow渲染实现播放器功能" />
<meta property="og:description" content="一、客户端选择音视频文件 MainActivity
package com.anniljing.ffmpegnative; import android.Manifest; import android.content.ContentResolver; import android.content.Context; import android.content.Intent; import android.database.Cursor; import android.net.Uri; import android.os.Bundle; import android.provider.MediaStore; import android.provider.OpenableColumns; import android.text.TextUtils; import android.util.Log; import android.view.SurfaceHolder; import com.anniljing.ffmpegnative.databinding.ActivityMainBinding; import androidx.activity.result.ActivityResultLauncher; import androidx.activity.result.contract.ActivityResultContracts; import androidx.annotation.NonNull; import androidx.appcompat.app.AppCompatActivity; import pub.devrel.easypermissions.EasyPermissions; public class MainActivity extends AppCompatActivity implements SurfaceHolder.Callback { private static final String TAG = MainActivity.class.getSimpleName(); private ActivityMainBinding binding; private Context mContext; private FFmpegPlayer mFFmpegPlayer; private String[] PERMISSIONS_STORAGE = {Manifest.permission.READ_EXTERNAL_STORAGE, Manifest." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c0f4da7a6845100d8411138dd1c746d2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-21T10:37:26+08:00" />
<meta property="article:modified_time" content="2023-12-21T10:37:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于FFmpeg,ANativeWindow渲染实现播放器功能</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/38/98/KAlL6rrL_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_2"></a>一、客户端选择音视频文件</h2> 
<p>MainActivity</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>anniljing<span class="token punctuation">.</span>ffmpegnative</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span></span><span class="token class-name">Manifest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ContentResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Intent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>database<span class="token punctuation">.</span></span><span class="token class-name">Cursor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">Uri</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">MediaStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">OpenableColumns</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">TextUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">SurfaceHolder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>anniljing<span class="token punctuation">.</span>ffmpegnative<span class="token punctuation">.</span>databinding<span class="token punctuation">.</span></span><span class="token class-name">ActivityMainBinding</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">ActivityResultLauncher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>result<span class="token punctuation">.</span>contract<span class="token punctuation">.</span></span><span class="token class-name">ActivityResultContracts</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">NonNull</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">AppCompatActivity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">pub<span class="token punctuation">.</span>devrel<span class="token punctuation">.</span>easypermissions<span class="token punctuation">.</span></span><span class="token class-name">EasyPermissions</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">SurfaceHolder<span class="token punctuation">.</span>Callback</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ActivityMainBinding</span> binding<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Context</span> mContext<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">FFmpegPlayer</span> mFFmpegPlayer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">PERMISSIONS_STORAGE</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">READ_EXTERNAL_STORAGE</span><span class="token punctuation">,</span> <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">WRITE_EXTERNAL_STORAGE</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ActivityResultLauncher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Intent</span><span class="token punctuation">&gt;</span></span> mResultLauncher<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> videoPath<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SurfaceHolder</span> mSurfaceHolder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        binding <span class="token operator">=</span> <span class="token class-name">ActivityMainBinding</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token function">getLayoutInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">EasyPermissions</span><span class="token punctuation">.</span><span class="token function">hasPermissions</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token constant">PERMISSIONS_STORAGE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">EasyPermissions</span><span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token constant">PERMISSIONS_STORAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mSurfaceHolder <span class="token operator">=</span> binding<span class="token punctuation">.</span>surfaceView<span class="token punctuation">.</span><span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSurfaceHolder<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFFmpegPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FFmpegPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mResultLauncher <span class="token operator">=</span> <span class="token function">registerForActivityResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActivityResultContracts<span class="token punctuation">.</span>StartActivityForResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">RESULT_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Uri</span> data <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onActivityResult:"</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                videoPath <span class="token operator">=</span> <span class="token function">getPathFromContentUri</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"getPathFromContentUri:"</span> <span class="token operator">+</span> videoPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        binding<span class="token punctuation">.</span>play<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_OPEN_DOCUMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">CATEGORY_OPENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"video/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mResultLauncher<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> permissions<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> grantResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EasyPermissions</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getPathFromContentUri</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Uri</span> uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uri <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">ContentResolver</span><span class="token punctuation">.</span><span class="token constant">SCHEME_CONTENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ContentResolver</span> contentResolver <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Cursor</span> cursor <span class="token operator">=</span> contentResolver<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> columnIndex <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getColumnIndex</span><span class="token punctuation">(</span><span class="token class-name">OpenableColumns</span><span class="token punctuation">.</span><span class="token constant">DISPLAY_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>columnIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> displayName <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>displayName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        filePath <span class="token operator">=</span> <span class="token function">getFilePathFromDisplayName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> displayName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                cursor<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> filePath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getFilePathFromDisplayName</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Uri</span> uri<span class="token punctuation">,</span> <span class="token class-name">String</span> displayName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ContentResolver</span> contentResolver <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Uri</span> mediaUri <span class="token operator">=</span> <span class="token class-name">MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media</span><span class="token punctuation">.</span><span class="token constant">EXTERNAL_CONTENT_URI</span><span class="token punctuation">;</span>
        <span class="token class-name">Cursor</span> cursor <span class="token operator">=</span> contentResolver<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>mediaUri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media</span><span class="token punctuation">.</span><span class="token constant">DISPLAY_NAME</span> <span class="token operator">+</span> <span class="token string">"=?"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>displayName<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> columnIndex <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getColumnIndex</span><span class="token punctuation">(</span><span class="token class-name">MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media</span><span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>columnIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                filePath <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            cursor<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> filePath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceCreated</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">SurfaceHolder</span> holder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>videoPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mFFmpegPlayer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mFFmpegPlayer<span class="token punctuation">.</span><span class="token function">native_start</span><span class="token punctuation">(</span>videoPath<span class="token punctuation">,</span> mSurfaceHolder<span class="token punctuation">.</span><span class="token function">getSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceChanged</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">SurfaceHolder</span> holder<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceDestroyed</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">SurfaceHolder</span> holder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="11_135"></a>1.1、访问视频文件目录</h3> 
<pre><code class="prism language-java">   <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_OPEN_DOCUMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   intent<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">CATEGORY_OPENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   intent<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"video/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mResultLauncher<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
</code></pre> 
<h3><a id="12_143"></a>1.2、解析返回的视频路径</h3> 
<p><strong>ActivityResultLauncher</strong> 是 Android Jetpack 中的一个组件，用于简化处理启动活动并接收结果的过程。它是在 Android API 级别 30（Android 11）引入的新特性，旨在替代过时的 startActivityForResult 方法。</p> 
<p>ActivityResultLauncher 使用了一种更简单和类型安全的方式来处理活动结果。它通过注册一个回调并在回调中处理结果，而不需要重写 onActivityResult 方法。这使得代码更加清晰和易于维护。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">ActivityResultLauncher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Intent</span><span class="token punctuation">&gt;</span></span> mResultLauncher<span class="token punctuation">;</span>

mResultLauncher <span class="token operator">=</span> <span class="token function">registerForActivityResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActivityResultContracts<span class="token punctuation">.</span>StartActivityForResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ActivityResultCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityResult</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token class-name">ActivityResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">RESULT_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Uri</span> data <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onActivityResult:"</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    videoPath <span class="token operator">=</span> <span class="token function">getPathFromContentUri</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"getPathFromContentUri:"</span> <span class="token operator">+</span> videoPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getPathFromContentUri</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Uri</span> uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uri <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">ContentResolver</span><span class="token punctuation">.</span><span class="token constant">SCHEME_CONTENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ContentResolver</span> contentResolver <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Cursor</span> cursor <span class="token operator">=</span> contentResolver<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> columnIndex <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getColumnIndex</span><span class="token punctuation">(</span><span class="token class-name">OpenableColumns</span><span class="token punctuation">.</span><span class="token constant">DISPLAY_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>columnIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> displayName <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>displayName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        filePath <span class="token operator">=</span> <span class="token function">getFilePathFromDisplayName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> displayName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                cursor<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> filePath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getFilePathFromDisplayName</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Uri</span> uri<span class="token punctuation">,</span> <span class="token class-name">String</span> displayName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ContentResolver</span> contentResolver <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Uri</span> mediaUri <span class="token operator">=</span> <span class="token class-name">MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media</span><span class="token punctuation">.</span><span class="token constant">EXTERNAL_CONTENT_URI</span><span class="token punctuation">;</span>
        <span class="token class-name">Cursor</span> cursor <span class="token operator">=</span> contentResolver<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>mediaUri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media</span><span class="token punctuation">.</span><span class="token constant">DISPLAY_NAME</span> <span class="token operator">+</span> <span class="token string">"=?"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>displayName<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> columnIndex <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getColumnIndex</span><span class="token punctuation">(</span><span class="token class-name">MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media</span><span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>columnIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                filePath <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            cursor<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> filePath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="native_197"></a>二、声明native方法</h2> 
<p>FFmpegPlayer.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>anniljing<span class="token punctuation">.</span>ffmpegnative</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">Surface</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FFmpegPlayer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"ffmpegnative"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">native_start</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Surface</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="jni_213"></a>三、jni层实现</h2> 
<p>native-lib.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/native_window_jni.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libswscale/swscale.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/imgutils.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AndroidLog.h"</span></span>


JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_anniljing_ffmpegnative_FFmpegPlayer_native_1start</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jstring path<span class="token punctuation">,</span>
                                                           jobject surface<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>


    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mPath <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化AVFormatContext</span>
    AVFormatContext <span class="token operator">*</span>avFormatContext <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AVDictionary <span class="token operator">*</span>pDictionary <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">av_dict_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pDictionary<span class="token punctuation">,</span> <span class="token string">"timeout"</span><span class="token punctuation">,</span> <span class="token string">"3000000"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打开输入文件</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">,</span> mPath<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pDictionary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取流信息</span>
    <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>avFormatContext<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查找视频流</span>
    <span class="token keyword">int</span> video_stream_index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>avFormatContext<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            video_stream_index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"video stream index:%d"</span><span class="token punctuation">,</span> video_stream_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    AVStream<span class="token operator">*</span> videoStream <span class="token operator">=</span> avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    AVRational timeBase <span class="token operator">=</span> videoStream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>
    <span class="token comment">// 计算帧率</span>
    <span class="token keyword">double</span> frameRate <span class="token operator">=</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>timeBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"video rate:%f"</span><span class="token punctuation">,</span>frameRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取视频流解码器参数</span>
    AVCodecParameters <span class="token operator">*</span>codecParameters <span class="token operator">=</span> avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_stream_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">;</span>
    <span class="token comment">// 查找视频流解码器</span>
    AVCodec <span class="token operator">*</span>avCodecVideo <span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>codecParameters<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建解码器上下文</span>
    AVCodecContext <span class="token operator">*</span>avCodecContext <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>avCodecVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置解码器参数</span>
    <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>avCodecContext<span class="token punctuation">,</span> codecParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打开解码器</span>
    <span class="token function">avcodec_open2</span><span class="token punctuation">(</span>avCodecContext<span class="token punctuation">,</span> avCodecVideo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建图像转换上下文</span>
    SwsContext <span class="token operator">*</span>swsContext <span class="token operator">=</span> <span class="token function">sws_getContext</span><span class="token punctuation">(</span>avCodecContext<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> avCodecContext<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
                                            avCodecContext<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span> avCodecContext<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>
                                            avCodecContext<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> AV_PIX_FMT_RGBA<span class="token punctuation">,</span> SWS_BILINEAR<span class="token punctuation">,</span>
                                            <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 ANativeWindow 对象</span>
    ANativeWindow <span class="token operator">*</span>nativeWindow <span class="token operator">=</span> <span class="token function">ANativeWindow_fromSurface</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置渲染格式和大小</span>
    <span class="token function">ANativeWindow_setBuffersGeometry</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">,</span> avCodecContext<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> avCodecContext<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
                                     WINDOW_FORMAT_RGBA_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 分配渲染缓冲区</span>
    ANativeWindow_Buffer outBuffer<span class="token punctuation">;</span>
    <span class="token comment">//从视频流读取数据包到avpacket</span>
    AVPacket <span class="token operator">*</span>avPacketVideo <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从音视频文件中读取下一帧</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>avFormatContext<span class="token punctuation">,</span> avPacketVideo<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将要解码的数据包送入解码器</span>
        <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>avCodecContext<span class="token punctuation">,</span> avPacketVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AVFrame <span class="token operator">*</span>avFrameVideo <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//从解码器内部缓存中提取解码后的音视频帧</span>
        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>avCodecContext<span class="token punctuation">,</span> avFrameVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">uint8_t</span> <span class="token operator">*</span>dst_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dst_linesize<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">av_image_alloc</span><span class="token punctuation">(</span>dst_data<span class="token punctuation">,</span> dst_linesize<span class="token punctuation">,</span> avCodecContext<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> avCodecContext<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
                       AV_PIX_FMT_RGBA<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 锁定 Surface 并获取渲染缓冲区</span>
        <span class="token function">ANativeWindow_lock</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outBuffer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将解码后的帧转换为目标格式</span>
        <span class="token function">sws_scale</span><span class="token punctuation">(</span>swsContext<span class="token punctuation">,</span> avFrameVideo<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> avFrameVideo<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> avFrameVideo<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
                  dst_data<span class="token punctuation">,</span> dst_linesize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//渲染</span>
        <span class="token keyword">uint8_t</span> <span class="token operator">*</span>first <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>outBuffer<span class="token punctuation">.</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">uint8_t</span> <span class="token operator">*</span>src_data <span class="token operator">=</span> dst_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dstStride <span class="token operator">=</span> outBuffer<span class="token punctuation">.</span>stride <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> src_linesize <span class="token operator">=</span> dst_linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outBuffer<span class="token punctuation">.</span>height<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>first <span class="token operator">+</span> i <span class="token operator">*</span> dstStride<span class="token punctuation">,</span> src_data <span class="token operator">+</span> i <span class="token operator">*</span> src_linesize<span class="token punctuation">,</span> dstStride<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 解锁 Surface</span>
        <span class="token function">ANativeWindow_unlockAndPost</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span>frameRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFrameVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"release"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>avPacketVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANativeWindow_release</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sws_freeContext</span><span class="token punctuation">(</span>swsContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avCodecContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-&gt;</span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> mPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>


</code></pre> 
<h3><a id="31AVFormatContexthttpsffmpegorgdoxygen44structAVFormatContexthtml_333"></a>3.1、<a href="https://ffmpeg.org/doxygen/4.4/structAVFormatContext.html" rel="nofollow">AVFormatContext</a></h3> 
<p>AVFormatContext 是 FFmpeg 库中的一个结构体，用于表示音视频封装格式的上下文信息。它包含了音视频流的封装格式、容器级别的参数和状态，以及与输入输出相关的信息。</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * A class for logging and @ref avoptions. Set by avformat_alloc_context().
     * Exports (de)muxer private options if they exist.
     */</span>
    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>av_class<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 输入容器格式.
     * 用于分流，通过avformat_open_input()设置.
     */</span>
    <span class="token keyword">struct</span> <span class="token class-name">AVInputFormat</span> <span class="token operator">*</span>iformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 输出容器格式。
     *
     * 用于混流，必须在avformat_write_header()调用前设置.
     */</span>
    <span class="token keyword">struct</span> <span class="token class-name">AVOutputFormat</span> <span class="token operator">*</span>oformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Format private data. This is an AVOptions-enabled struct
     * if and only if iformat/oformat.priv_class is not NULL.
     *
     * - muxing: set by avformat_write_header()
     * - demuxing: set by avformat_open_input()
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>priv_data<span class="token punctuation">;</span>

    <span class="token comment">/**
     * I/O 上下文.
     *
     * - 分流: 在avformat_open_input() 之前设置(用户必须手动释放)或者通过avformat_open_input()
     *		  自动设置.
     * - 混流: 在avformat_write_header()之前设置.用户必须注意及时关闭/释放IO上下文。
     *
     * 不要设置AVFMT_NOFILE标志给iformat/oformat.flags。因为这种情况下，该值为NULL，混/分流器会通
     * 过其它方式处理I/O。
     */</span>
    AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">;</span>

    <span class="token comment">/* 后面都是流信息 */</span>
    <span class="token comment">/**
     * 信号流属性标志，AVFMTCTX_*的组合.
     * 通过libavformat设置.
     */</span>
    <span class="token keyword">int</span> ctx_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * AVFormatContext.streams中的元素数量，其实就是流的总数.
     *
     * 通过avformat_new_stream()设置, 禁止其它代码修改。
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_streams<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 媒体中，所有流的列表，新的流由avformat_new_stream()创建。
     *
     * - 分流: 流在avformat_open_input()函数中由libavformat创建。如果AVFMTCTX_NOHEANDER被设置
     *        带ctx_flags中，新的流可能出现在av_read_frame()中。
     * - 混流: 流在avformat_write_header()函数之前被用户创建
     *
     * 在avformat_free_context()函数中，通过libavformat释放。
     */</span>
    AVStream <span class="token operator">*</span><span class="token operator">*</span>streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 输入输出文件名
     *
     * - 分流: 通过avformat_open_input()设置。
     * - 混流: 在avformat_write_header()调用前，可以被使用者设置。
     */</span>
    <span class="token keyword">char</span> filename<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 组件第一帧的位置，用AV_TIME_BASE分数秒表示。禁止直接设置，由AVStream的值推导而来。
     *
     * - 分流：通过libavformat设置.
     */</span>
    <span class="token class-name">int64_t</span> start_time<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 留的时长，以AV_TIME_BASE分数秒为单位。如果您不知道任何单个流的持续时间，也不设置其中的任何一
     * 个，请仅设置此值。 如果没有设置，该值可以被AVStream推导出来
     *
     * 只用于分流操作，通过libavformat设置。
     */</span>
    <span class="token class-name">int64_t</span> duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 总流的比特率以bit/s为单位，如果流不可用，该值为0。如果流文件大小和时长已知，不要直接设置它，
     * FFmpeg会自动计算。
     */</span>
    <span class="token class-name">int64_t</span> bit_rate<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> packet_size<span class="token punctuation">;</span>
    <span class="token keyword">int</span> max_delay<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 修改分/混流器操作的标志，一个AVFMT_FLAG_*的组合。
     * 在avformat_open_input() / avformat_write_header()调用之前用户自行设置.
     */</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_GENPTS</span>       <span class="token expression"><span class="token number">0x0001</span> </span><span class="token comment">///&lt; Generate missing pts even if it requires parsing future frames.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNIDX</span>       <span class="token expression"><span class="token number">0x0002</span> </span><span class="token comment">///&lt; Ignore index.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NONBLOCK</span>     <span class="token expression"><span class="token number">0x0004</span> </span><span class="token comment">///&lt; Do not block when reading packets from input.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNDTS</span>       <span class="token expression"><span class="token number">0x0008</span> </span><span class="token comment">///&lt; Ignore DTS on frames that contain both DTS &amp; PTS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOFILLIN</span>     <span class="token expression"><span class="token number">0x0010</span> </span><span class="token comment">///&lt; Do not infer any values from other values, just return what is stored in the container</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOPARSE</span>      <span class="token expression"><span class="token number">0x0020</span> </span><span class="token comment">///&lt; Do not use AVParsers, you also must set AVFMT_FLAG_NOFILLIN as the fillin code works on frames and no parsing -&gt; no frames. Also seeking to frames can not work if parsing to find frame boundaries has been disabled</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOBUFFER</span>     <span class="token expression"><span class="token number">0x0040</span> </span><span class="token comment">///&lt; Do not buffer frames when possible</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_CUSTOM_IO</span>    <span class="token expression"><span class="token number">0x0080</span> </span><span class="token comment">///&lt; The caller has supplied a custom AVIOContext, don't avio_close() it.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_DISCARD_CORRUPT</span>  <span class="token expression"><span class="token number">0x0100</span> </span><span class="token comment">///&lt; Discard frames marked corrupted</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FLUSH_PACKETS</span>    <span class="token expression"><span class="token number">0x0200</span> </span><span class="token comment">///&lt; Flush the AVIOContext every packet.</span></span>
<span class="token comment">/**
 * 混流时，尽量避免将随机/不可控的数据写入输出中，包括随机IDs,实时时间戳/日期，混流器版本等等。
 *
 * 该标记主要用于测试
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_BITEXACT</span>         <span class="token expression"><span class="token number">0x0400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_MP4A_LATM</span>    <span class="token expression"><span class="token number">0x8000</span> </span><span class="token comment">///&lt; Enable RTP MP4A-LATM payload</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SORT_DTS</span>    <span class="token expression"><span class="token number">0x10000</span> </span><span class="token comment">///&lt; try to interleave outputted packets by dts (using this flag can slow demuxing down)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_PRIV_OPT</span>    <span class="token expression"><span class="token number">0x20000</span> </span><span class="token comment">///&lt; Enable use of private options by delaying codec open (this could be made default once all code is converted)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_KEEPSIDE_FLAG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_KEEP_SIDE_DATA</span> <span class="token expression"><span class="token number">0x40000</span> </span><span class="token comment">///&lt; Don't merge side data but keep it separate. Deprecated, will be the default.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FAST_SEEK</span>   <span class="token expression"><span class="token number">0x80000</span> </span><span class="token comment">///&lt; Enable fast, but inaccurate seeks for some formats</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SHORTEST</span>   <span class="token expression"><span class="token number">0x100000</span> </span><span class="token comment">///&lt; Stop muxing when the shortest stream stops.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_AUTO_BSF</span>   <span class="token expression"><span class="token number">0x200000</span> </span><span class="token comment">///&lt; Wait for packet data before writing a header, and add bitstream filters as requested by the muxer</span></span>

    <span class="token comment">/**
     * 从指定容器格式的输入中读取最大数据的大小。
     * 仅用于分流操作，用户可以在avformat_open_input()函数前设置。
     */</span>
    <span class="token class-name">int64_t</span> probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 从指定容器格式的输入中读取的最大数据时长（以AV_TIME_BASE为单位）。
     * 仅用于分流操作，在avformat_find_stream_info()调用前设置。为0时，让avformat自动选择。
     */</span>
    <span class="token class-name">int64_t</span> max_analyze_duration<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    <span class="token keyword">int</span> keylen<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_programs<span class="token punctuation">;</span>
    AVProgram <span class="token operator">*</span><span class="token operator">*</span>programs<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 强制视频codec_id.
     * 分流操作: 用户设置。
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> video_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 强制音频codec_id.
     * 分流操作: 用户设置。
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> audio_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 强制字幕codec_id.
     * 分流操作: 用户设置。
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> subtitle_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 每个索引使用的内存最大值（以字节为单位）。
     * 如果索引超出内存限制，项目会被丢弃以保持较小的内存占用。这回导致seeking较慢和不准确（取决于分流
     * 器）
     * 完全内存索引是强制性的分解器将忽略这一点。
     * - 混流操作: 不实用
     * - 分流操作: 由用户设置
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_index_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 从设备获取的实时帧缓冲的最大内存大小（以字节为单位）
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_picture_buffer<span class="token punctuation">;</span>

    <span class="token comment">/**
     * AVChapter数组中的章节数量。
     * 混流时，章节信息通畅会写在文件头中，所以nb_chapters应该在写文件头之前被初始化。一些混流器（例如
     * mov、mkv)可以将章节写在预告中。为了在预告中撰写章节，在write_header调用时nb_chapters必须为
     * 并且在write_trailer被调用时为非0数。
     * - 混流操作: 用户设置
     * - 分流操作: libavformat设置
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_chapters<span class="token punctuation">;</span>
    AVChapter <span class="token operator">*</span><span class="token operator">*</span>chapters<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 适用于整个文件的元数据。
     *
     * - 分流操作: libavformat在avformat_open_input()函数中设置。
     * - 混流操作: 调用者可以在avformat_write_header()函数调用前设置。
     *
     * 通过libavformat在函数avformat_free_context()中释放。
     */</span>
    AVDictionary <span class="token operator">*</span>metadata<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 从Unix纪元（1970年1月1日00:00）开始，以真实世界时间开始流的开始时间，以微秒为单位。 即，流在现
     * 实世界被使用的pts=0时间。
     * - 混流操作: 在avformat_write_header()调用前被调用者设置。如果设置为0或AV_NOPTS_VALUE，则
     * 将使用当前时间(wall-time)。
     * - 分流操作: 由libavformat设置. 如果AV_NOPTS_VALUE未知，注意，一定数量的帧被获取后，该值可能
     * 变得已知。
     */</span>
    <span class="token class-name">int64_t</span> start_time_realtime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用于确定avformat_find_stream_info（）中帧率的帧数。
     * 仅用于分流，在avformat_find_stream_info()调用前由调用者设置
     */</span>
    <span class="token keyword">int</span> fps_probe_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 错误识别; 较高的值将检测到更多的错误，但可能会错误检测一些或多或少有效的部分作为错误。 在
     * avformat_open_input（）之前由调用方设置的仅用于解分流。
     */</span>
    <span class="token keyword">int</span> error_recognition<span class="token punctuation">;</span>

    <span class="token comment">/**
     * I/O层自定义中断回调函数。
     *
     * 分流操作: avformat_open_input()调用前由用户设置.
     * 混流操作: avformat_write_header()调用前由用户设置（主要用于AVFMT_NOFILE 格式）。如果用它来
     * 打开文件，该回调也会传递给avio_open2().
     */</span>
    AVIOInterruptCB interrupt_callback<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 启用debug标志。
     */</span>
    <span class="token keyword">int</span> debug<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FF_FDEBUG_TS</span>        <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum buffering duration for interleaving.
     *
     * To ensure all the streams are interleaved correctly,
     * av_interleaved_write_frame() will wait until it has at least one packet
     * for each stream before actually writing any packets to the output file.
     * When some streams are "sparse" (i.e. there are large gaps between
     * successive packets), this can result in excessive buffering.
     *
     * This field specifies the maximum difference between the timestamps of the
     * first and the last packet in the muxing queue, above which libavformat
     * will output a packet regardless of whether it has queued a packet for all
     * the streams.
     *
     * Muxing only, set by the caller before avformat_write_header().
     */</span>
    <span class="token class-name">int64_t</span> max_interleave_delta<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 允许非标准和实验性扩展
     * @see AVCodecContext.strict_std_compliance
     */</span>
    <span class="token keyword">int</span> strict_std_compliance<span class="token punctuation">;</span>

    <span class="token comment">/**
	 * 供用户检测文件上发生事件的标志。事件处理后，用户必须清除标志。AVFMT_EVENT_FLAG_ *的组合。
     */</span>
    <span class="token keyword">int</span> event_flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_EVENT_FLAG_METADATA_UPDATED</span> <span class="token expression"><span class="token number">0x0001</span> </span><span class="token comment">///&lt; The call resulted in updated metadata.</span></span>

    <span class="token comment">/**
     * 在等待第一个时间戳时要读取的最大数据包数。仅用于解码。
     */</span>
    <span class="token keyword">int</span> max_ts_probe<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 避免混流过程中的负面时间戳。 AVFMT_AVOID_NEG_TS_ *常量中的任何值。 请注意，这只适用于使用
     * av_interleaved_write_frame。 （interleave_packet_per_dts正在使用中）
     * - 混流: 用户设置
     * - 分流: 不使用
     */</span>
    <span class="token keyword">int</span> avoid_negative_ts<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_AUTO</span>             <span class="token expression"><span class="token operator">-</span><span class="token number">1</span> </span><span class="token comment">///&lt; Enabled when required by target format</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_NON_NEGATIVE</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">///&lt; Shift timestamps so they are non negative</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_ZERO</span>         <span class="token expression"><span class="token number">2</span> </span><span class="token comment">///&lt; Shift timestamps so that they start at 0</span></span>

    <span class="token comment">/**
     * 传输流id。
     * 这将被移入分流器的私有选项。 因此没有API / ABI兼容性
     */</span>
    <span class="token keyword">int</span> ts_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 音频预加载以微秒为单位。 请注意，并非所有格式都支持此功能，如果在不支持的情况下使用它，则可能会发
     * 生不可预知的情况。
     * - 编码: 用户设置
     * - 解码: 不使用
     */</span>
    <span class="token keyword">int</span> audio_preload<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 最大块时间（以微秒为单位）。 请注意，并非所有格式都支持此功能，如果在不支持的情况下使用它，则可能
     * 会发生不可预知的情况。
     * - 编码: 用户设置
     * - 解码: 不使用
     */</span>
    <span class="token keyword">int</span> max_chunk_duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 最大块大小（以字节为单位）。注意，并非所有格式都支持此功能，如果在不支持的情况下使用它，可能会发
     * 生不可预知的情况。
     * - 编码: 用户设置
     * - 解码: 不使用
     */</span>
    <span class="token keyword">int</span> max_chunk_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     *  强制使用wallclock时间戳作为pts / dts数据包在B帧存在的情况下存在未定义的结果。
     * - 编码: 不使用
     * - 解码: 用户设置
     */</span>
    <span class="token keyword">int</span> use_wallclock_as_timestamps<span class="token punctuation">;</span>

    <span class="token comment">/**
     * avio标志，用于强制使用AVIO_FLAG_DIRECT。
     * - 编码: 不使用
     * - 解码: 用户设置
     */</span>
    <span class="token keyword">int</span> avio_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 时长字段可以通过各种方式进行计算，并且可以使用此字段了解时长是如何计算的。
     * - 编码: 不使用
     * - 解码: 用户读取
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVDurationEstimationMethod</span> duration_estimation_method<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 打开流时跳过初始字节
     * - 编码: 不使用
     * - 解码: 用户设置
     */</span>
    <span class="token class-name">int64_t</span> skip_initial_bytes<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 正确的单个时间戳溢出
     * - 编码: 不使用
     * - 解码: 用户设置
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> correct_ts_overflow<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 强制seeking到任意帧（即使没有关键帧）
     * - 编码: 不使用
     * - 解码: 用户设置
     */</span>
    <span class="token keyword">int</span> seek2any<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 在每个数据包之后刷新I / O上下文。
     * - 编码: 用户设置
     * - 解码: 不使用
     */</span>
    <span class="token keyword">int</span> flush_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 格式探测分数。 最高分是AVPROBE_SCORE_MAX，当分流器探测格式时设置它。
     * - 编码: 不使用
     * - 解码: avformat设置，用户读取
     */</span>
    <span class="token keyword">int</span> probe_score<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 要最大限度地读取以识别格式的字节数。
     * - 编码: 不使用
     * - 解码: 用户设置
     */</span>
    <span class="token keyword">int</span> format_probesize<span class="token punctuation">;</span>
    <span class="token comment">/**
     * ',' 分割的支持的解码器刘表，如果值为NULL，表示支持所有解码器。
     * - 编码: 不使用
     * - 解码: 用户设置
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>codec_whitelist<span class="token punctuation">;</span>
     <span class="token comment">/**
      * ',' 分割的支持的分流器列表，如果值为NULL，所有分流器都支持。
      * - 编码: 不使用
      * - 解码: 用户设置
      */</span>
     <span class="token keyword">char</span> <span class="token operator">*</span>format_whitelist<span class="token punctuation">;</span>
 
     <span class="token comment">/**
 	  * libavformat内部使用的不透明字段。 不得以任何方式访问。
      */</span>
     AVFormatInternal <span class="token operator">*</span>internal<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * IO重定位标志。
      * 当基础IO上下文读指针重新定位时，例如在执行基于字节的查找时，这由avformat设置。 分流器可以使用
      * 标志来检测这种变化。
      */</span>
     <span class="token keyword">int</span> io_repositioned<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 强制视频解码器。强制数据解码器。这允许使用强制指定的解码器，即使有多个相同的codec_id.
      * 分流: 用户设置
      */</span>
     AVCodec <span class="token operator">*</span>video_codec<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 强制音频解码器。强制数据解码器。这允许使用强制指定的解码器，即使有多个相同的codec_id.
      * 分流: 用户设置
      */</span>
     AVCodec <span class="token operator">*</span>audio_codec<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 强制数据解码器。这允许使用强制指定的解码器，即使有多个相同的codec_id.
      * 分流: 用户设置
      */</span>
     AVCodec <span class="token operator">*</span>subtitle_codec<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 强制数据解码器。这允许使用强制指定的解码器，即使有多个相同的codec_id.
      * 分流: 用户设置
      */</span>
     AVCodec <span class="token operator">*</span>data_codec<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 在原数据头中，充当填充（分割）的字节数
      * 分流: 不使用
      * 混流: 用户可以通过av_format_set_metadata_header_padding设置.
      */</span>
     <span class="token keyword">int</span> metadata_header_padding<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 用户数据，这是用户的私有数据空间。
      */</span>
     <span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 设备用应用通讯的回调。
      */</span>
     av_format_control_message control_message_cb<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 输出时移，以微妙为单位。
      * 混流: 用户设置
      */</span>
     <span class="token class-name">int64_t</span> output_ts_offset<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 转储格式分隔符。可以是", " 或者 "\n" 等
      * - 混流: 用户设置
      * - 分流: 用户设置
      */</span>
     <span class="token class-name">uint8_t</span> <span class="token operator">*</span>dump_separator<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 强制数据codec_id.
      * 分流操作: 用户设置
      */</span>
     <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> data_codec_id<span class="token punctuation">;</span>
 
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_OLD_OPEN_CALLBACKS</span></span>
     <span class="token comment">/**
      * Called to open further IO contexts when needed for demuxing.
      *
      * This can be set by the user application to perform security checks on
      * the URLs before opening them.
      * The function should behave like avio_open2(), AVFormatContext is provided
      * as contextual information and to reach AVFormatContext.opaque.
      *
      * If NULL then some simple checks are used together with avio_open2().
      *
      * Must not be accessed directly from outside avformat.
      * @See av_format_set_open_cb()
      *
      * Demuxing: Set by user.
      *
      * @deprecated Use io_open and io_close.
      */</span>
     attribute_deprecated
     <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open_cb<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span><span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> AVIOInterruptCB <span class="token operator">*</span>int_cb<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
     <span class="token comment">/**
      * ',' 符号分割的支持协议列表separated list of allowed protocols.
      * - 编码: 不使用
      * - 解码: 用户设置
      */</span>
     <span class="token keyword">char</span> <span class="token operator">*</span>protocol_whitelist<span class="token punctuation">;</span>
 
     <span class="token comment">/*
      * A callback for opening new IO streams.
      *
      * Whenever a muxer or a demuxer needs to open an IO stream (typically from
      * avformat_open_input() for demuxers, but for certain formats can happen at
      * other times as well), it will call this callback to obtain an IO context.
      *
      * @param s the format context
      * @param pb on success, the newly opened IO context should be returned here
      * @param url the url to open
      * @param flags a combination of AVIO_FLAG_*
      * @param options a dictionary of additional options, with the same
      *                semantics as in avio_open2()
      * @return 0 on success, a negative AVERROR code on failure
      *
      * @note Certain muxers and demuxers do nesting, i.e. they open one or more
      * additional internal format contexts. Thus the AVFormatContext pointer
      * passed to this callback may be different from the one facing the caller.
      * It will, however, have the same 'opaque' field.
      */</span>
     <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span><span class="token operator">*</span>pb<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span>
                    <span class="token keyword">int</span> flags<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 将AVFormateContext.io_open()打开流关闭的回调。
      */</span>
     <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * ',' 符分割的不支持协议列表。
      * - 编码: 不使用
      * - 解码: 用户设置
      */</span>
     <span class="token keyword">char</span> <span class="token operator">*</span>protocol_blacklist<span class="token punctuation">;</span>
 
     <span class="token comment">/**
      * 最大streams数量
      * - 编码: 不使用
      * - 解码: 用户设定
      */</span>
     <span class="token keyword">int</span> max_streams<span class="token punctuation">;</span>
 <span class="token punctuation">}</span> AVFormatContext<span class="token punctuation">;</span>



</code></pre> 
<h3><a id="32AVCodecContexthttpsffmpegorgdoxygen44structAVCodecContexthtml_870"></a>3.2、<a href="https://ffmpeg.org/doxygen/4.4/structAVCodecContext.html" rel="nofollow">AVCodecContext</a></h3> 
<p>AVCodecContext 是 FFmpeg 库中的一个结构体，用于描述音视频编解码器的上下文信息。它包含了音视频编解码器的参数和状态，用于配置和控制编解码的过程。</p> 
<pre><code class="prism language-cpp">
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 编解码器实现的名称。
     * 该名称是全局唯一的（但编码器和解码器可以共享名称）。
     * 这是从用户角度查找编解码器的主要方式。
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 编解码器的描述性名称，比前面的名称更具可读性。
     * 您应该使用NULL_IF_CONFIG_SMALL（）宏来定义它。
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>long_name<span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVMediaType</span> type<span class="token punctuation">;</span><span class="token comment">//编解码器类型，视频，音频，或者字幕</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> id<span class="token punctuation">;</span><span class="token comment">//全局唯一的编解码器ID</span>
    <span class="token comment">/**
     * Codec capabilities.
     * see AV_CODEC_CAP_*
     */</span>
    <span class="token keyword">int</span> capabilities<span class="token punctuation">;</span>
    <span class="token keyword">const</span> AVRational <span class="token operator">*</span>supported_framerates<span class="token punctuation">;</span> <span class="token comment">///支持帧率的数组，用于视频</span>
    <span class="token keyword">const</span> <span class="token keyword">enum</span> <span class="token class-name">AVPixelFormat</span> <span class="token operator">*</span>pix_fmts<span class="token punctuation">;</span>     <span class="token comment">///&lt; 支持的像素格式数组，或者如果未知，则为NULL，数组以-1结尾。用于视频</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>supported_samplerates<span class="token punctuation">;</span>       <span class="token comment">///&lt; 支持的音频采样率数组，或者如果未知，则为NULL，数组以0结尾。用于音频</span>
    <span class="token keyword">const</span> <span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> <span class="token operator">*</span>sample_fmts<span class="token punctuation">;</span> <span class="token comment">///&lt;支持的采样数组，或者如果未知，则为NULL，数组以-1结尾。用于音频</span>
    <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> <span class="token operator">*</span>channel_layouts<span class="token punctuation">;</span>         <span class="token comment">///&lt; 支持声道数组，如果未知，则为NULL。 数组以0结尾，用于音频</span>
    <span class="token keyword">uint8_t</span> max_lowres<span class="token punctuation">;</span>                     <span class="token comment">///&lt; maximum value for lowres supported by the decoder</span>
    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>priv_class<span class="token punctuation">;</span>              <span class="token comment">///&lt; 私有上下文的AVClass</span>
    <span class="token keyword">const</span> AVProfile <span class="token operator">*</span>profiles<span class="token punctuation">;</span>              <span class="token comment">///&lt; 已识别配置文件的数组，或者如果未知，则为NULL，数组以{FF_PROFILE_UNKNOWN}结尾</span>

    <span class="token comment">/*****************************************************************
     * 以下所有的字段都不是公共API，不可在libavcodec以外使用。以后新增字段都会放在上面。
     *****************************************************************
     */</span>
    <span class="token keyword">int</span> priv_data_size<span class="token punctuation">;</span><span class="token comment">//私有数据大小</span>
    <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token comment">/**
     * @name Frame-level threading support functions
     * @{
     */</span>
    <span class="token comment">/**
     * 如果已定义，则在创建线程上下文时调用它们。
     * 如果编解码器在init（）中分配可写表，请在此处重新分配它们。
     * priv_data将被设置为原件的副本。
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>init_thread_copy<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Copy necessary context variables from a previous thread context to the current one.
     * If not defined, the next thread will start automatically; otherwise, the codec
     * must call ff_thread_finish_setup().
     *
     * dst and src will (rarely) point to the same context, in which case memcpy should be skipped.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>update_thread_context<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token keyword">const</span> AVCodecContext <span class="token operator">*</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/** @} */</span>

    <span class="token comment">/**
     * 私有编解码器默认值。
     */</span>
    <span class="token keyword">const</span> AVCodecDefault <span class="token operator">*</span>defaults<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 初始化时从avcodec_register（）调用的编解码器静态数据。
     */</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>init_static_data<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>init<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>encode_sub<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buf_size<span class="token punctuation">,</span>
                      <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVSubtitle</span> <span class="token operator">*</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Encode data to an AVPacket.
     *
     * @param      avctx          codec context
     * @param      avpkt          output AVPacket (may contain a user-provided buffer)
     * @param[in]  frame          AVFrame containing the raw data to be encoded
     * @param[out] got_packet_ptr encoder sets to 0 or 1 to indicate that a
     *                            non-empty packet was returned in avpkt.
     * @return 0 on success, negative error code on failure
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>encode2<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>avpkt<span class="token punctuation">,</span> <span class="token keyword">const</span> AVFrame <span class="token operator">*</span>frame<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> <span class="token operator">*</span>got_packet_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>decode<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>outdata<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>outdata_size<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>avpkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>close<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Decode/encode API with decoupled packet/frame dataflow. The API is the
     * same as the avcodec_ prefixed APIs (avcodec_send_frame() etc.), except
     * that:
     * - never called if the codec is closed or the wrong type,
     * - AVPacket parameter change side data is applied right before calling
     *   AVCodec-&gt;send_packet,
     * - if AV_CODEC_CAP_DELAY is not set, drain packets or frames are never sent,
     * - only one drain packet is ever passed down (until the next flush()),
     * - a drain AVPacket is always NULL (no need to check for avpkt-&gt;size).
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>send_frame<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> <span class="token keyword">const</span> AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>send_packet<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> <span class="token keyword">const</span> AVPacket <span class="token operator">*</span>avpkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>receive_frame<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>receive_packet<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>avpkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Flush buffers.
     * Will be called when seeking
     */</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush<span class="token punctuation">)</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Internal codec capabilities.
     * See FF_CODEC_CAP_* in internal.h
     */</span>
    <span class="token keyword">int</span> caps_internal<span class="token punctuation">;</span>
<span class="token punctuation">}</span> AVCodec<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="33AVPackethttpsffmpegorgdoxygen44structAVPackethtml_983"></a>3.3、<a href="https://ffmpeg.org/doxygen/4.4/structAVPacket.html" rel="nofollow">AVPacket</a></h3> 
<p>AVPacket 是 FFmpeg 库中的一个结构体，用于存储音视频数据的压缩数据包。它是 FFmpeg 中处理音视频数据的重要数据结构之一。</p> 
<p>AVPacket 结构体用于存储音视频数据的压缩数据，例如从容器中读取的音视频帧，或者编码后的音视频帧待写入容器。它包含了数据的时间戳、大小和相关信息，用于解码和编码过程中的数据处理。</p> 
<p>在使用 AVPacket 时，可以通过 FFmpeg 的函数和接口进行创建、释放、填充数据等操作。例如，av_packet_alloc 函数用于分配一个新的 AVPacket 对象，av_packet_free 函数用于释放 AVPacket 对象，av_packet_ref 函数用于创建 AVPacket 的副本，av_packet_rescale_ts 函数用于对时间戳进行重新缩放等。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVPacket</span> <span class="token punctuation">{<!-- --></span>
    AVBufferRef <span class="token operator">*</span>buf<span class="token punctuation">;</span> <span class="token comment">// data的buffer引用指针计数结构体</span>
    <span class="token keyword">int64_t</span> pts<span class="token punctuation">;</span> <span class="token comment">// 控制显示的pts时间</span>
    <span class="token keyword">int64_t</span> dts<span class="token punctuation">;</span> <span class="token comment">// 控制解码的dts时间</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">;</span> <span class="token comment">// 媒体数据buffer的指针</span>
    <span class="token keyword">int</span>   size<span class="token punctuation">;</span> <span class="token comment">// 数据大小</span>
    <span class="token keyword">int</span>   stream_index<span class="token punctuation">;</span> <span class="token comment">// 流index</span>
    <span class="token keyword">int</span>   flags<span class="token punctuation">;</span> <span class="token comment">// AV_PKT_FLAG值的组合</span>
    AVPacketSideData <span class="token operator">*</span>side_data<span class="token punctuation">;</span> <span class="token comment">// 容器可以提供的附加数据包数据。 数据包可以包含几种类型的辅助信息。</span>
		<span class="token comment">// AVStream-&gt; time_base单位中此数据包的持续时间，如果未知则为0。 在演示顺序中等于next_pts  -  this_pts。</span>
    <span class="token keyword">int64_t</span> duration<span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> pos<span class="token punctuation">;</span> <span class="token comment">// 流中的字节位置，如果未知则为-1</span>
<span class="token punctuation">}</span> AVPacket<span class="token punctuation">;</span>

</code></pre> 
<h3><a id="34AVFramehttpsffmpegorgdoxygen44structAVFramehtml_1006"></a>3.4、<a href="https://ffmpeg.org/doxygen/4.4/structAVFrame.html" rel="nofollow">AVFrame</a></h3> 
<p>AVFrame 是 FFmpeg 库中的一个结构体，用于表示音视频帧的数据。它包含了一个音频帧或视频帧的各种信息，如像素数据、采样数据、时间戳等。</p> 
<pre><code class="prism language-cpp">
    <span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVStream</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> index<span class="token punctuation">;</span>    <span class="token comment">/**&lt; 在AVFormatContext中的stream索引 */</span>
        <span class="token comment">/**
         * 特定格式的stream id。
         * 解码: 由libavformat设定
         * 编码: 如果未设置，则由用户通过libavformat设置
         */</span>
        <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_AVCTX</span></span>
        <span class="token comment">/**
         * @deprecated use the codecpar struct instead
         */</span>
        attribute_deprecated
        AVCodecContext <span class="token operator">*</span>codec<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">void</span> <span class="token operator">*</span>priv_data<span class="token punctuation">;</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_FRAC</span></span>
        <span class="token comment">/**
         * @deprecated this field is unused
         */</span>
        attribute_deprecated
        <span class="token keyword">struct</span> <span class="token class-name">AVFrac</span> pts<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
        <span class="token comment">/**
         * 这是表示帧时间戳的基本时间单位（以秒为单位）。
         *
         * 解码: libavformat设置
         * 编码: 可以在avformat_write_header（）之前由调用者设置，以向混流器提供关于所需单位时间的
         * 提示。在avformat_write_header（）中，混流器将用实际用于写入文件的时间戳（根据格式可能与
         * 用户提供的时间戳相关或不相关）的单位时间覆盖该字段。
         */</span>
        AVRational time_base<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 解码: 流显示序列中的第一帧pts时间，基于流时间（in stream time base.）。
         * 只有当你百分百确定该值就是真实的第一帧的pts时间，才可以设置它
         * 该值可能未定义(AV_NOPTS_VALUE).
         * @note The ASF header does NOT contain a correct start_time the ASF
         * 分流器禁止设置该值。
         */</span>
        <span class="token keyword">int64_t</span> start_time<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 解码: 流时长，基于流时间（in stream time base.）
         *      如果一个源文件指定了比特率，而未指定流时长，该值将由比特率和文件大小估算。
         *
         * 编码: May be set by the caller before 用户可以在avformat_write_header()调用前设
         * 置，提示混流器估算时长
         */</span>
        <span class="token keyword">int64_t</span> duration<span class="token punctuation">;</span>
    
        <span class="token keyword">int64_t</span> nb_frames<span class="token punctuation">;</span>                 <span class="token comment">///&lt; 表示该流的已知帧数，或者为0</span>
    
        <span class="token keyword">int</span> disposition<span class="token punctuation">;</span> <span class="token comment">/**&lt; AV_DISPOSITION_* 推荐比特字段 */</span>
    
        <span class="token keyword">enum</span> <span class="token class-name">AVDiscard</span> discard<span class="token punctuation">;</span> <span class="token comment">///&lt; 选择那些数据包可以被丢掉而不用被分流器分流。</span>
    
        <span class="token comment">/**
         * 采样率(如果未知，该值为0)
         * - 编码: 用户设置.
         * - 解码: libavformat设置.
         */</span>
        AVRational sample_aspect_ratio<span class="token punctuation">;</span>
    
        AVDictionary <span class="token operator">*</span>metadata<span class="token punctuation">;</span><span class="token comment">//原数据信息</span>
    
        <span class="token comment">/**
         * 平均帧率
         *
         * - 分流: 在创建流时或者才函数avformat_find_stream_info()函数中可能被设置。
         * - 混流: 可能在avformat_write_header()函数调用前被设置
         */</span>
        AVRational avg_frame_rate<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 对于设置有AV_DISPOSITION_ATTACHED_PIC标志的流, 该数据包会包含该附加图片（专辑图片什么的）
         *
         * 解码: libavformat设置, 不能被用户修改。
         * 编码: 不使用
         */</span>
        AVPacket attached_pic<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * An array of side data that applies to the whole stream (i.e. the
         * container does not allow it to change between packets).
         *
         * There may be no overlap between the side data in this array and side data
         * in the packets. I.e. a given side data is either exported by the muxer
         * (demuxing) / set by the caller (muxing) in this array, then it never
         * appears in the packets, or the side data is exported / sent through
         * the packets (always in the first packet where the value becomes known or
         * changes), then it does not appear in this array.
         *
         * - demuxing: Set by libavformat when the stream is created.
         * - muxing: May be set by the caller before avformat_write_header().
         *
         * Freed by libavformat in avformat_free_context().
         *
         * @see av_format_inject_global_side_data()
         */</span>
        AVPacketSideData <span class="token operator">*</span>side_data<span class="token punctuation">;</span>
        <span class="token comment">/**
         * The number of elements in the AVStream.side_data array.
         */</span>
        <span class="token keyword">int</span>            nb_side_data<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 供用户检测流上发生的时间标志。 事件处理后，用户必须清除标志。 AVSTREAM_EVENT_FLAG_ *的组合。
         */</span>
        <span class="token keyword">int</span> event_flags<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVSTREAM_EVENT_FLAG_METADATA_UPDATED</span> <span class="token expression"><span class="token number">0x0001</span> </span><span class="token comment">///&lt; The call resulted in updated metadata.</span></span>
    
        <span class="token comment">/*****************************************************************
      	 *该行下面的所有字段不是公共API的一部分。 它们不能在libavformat之外使用，并且可以随意更改和删
      	 *除。内部提示：请注意，物理删除这些字段将会破坏ABI。 用空字段替换已删除的字段，并向
      	 *AVStreamInternal添加新字段。
         *****************************************************************
         */</span>
    
        <span class="token comment">/**
         * avformat_find_stream_info()函数使用的内部流信息
         */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_STD_TIMEBASES</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">30</span><span class="token operator">*</span><span class="token number">12</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span></span></span>
        <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int64_t</span> last_dts<span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> duration_gcd<span class="token punctuation">;</span>
            <span class="token keyword">int</span> duration_count<span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> rfps_duration_sum<span class="token punctuation">;</span>
            <span class="token keyword">double</span> <span class="token punctuation">(</span><span class="token operator">*</span>duration_error<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>MAX_STD_TIMEBASES<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> codec_info_duration<span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> codec_info_duration_fields<span class="token punctuation">;</span>
    
            <span class="token comment">/**
             * 0  -&gt; 解码器还未被检索到
             * &gt;0 -&gt; 解码器已被找到
             * &lt;0 -&gt; decoder with codec_id == -found_decoder has not been found
             */</span>
            <span class="token keyword">int</span> found_decoder<span class="token punctuation">;</span>
    
            <span class="token keyword">int64_t</span> last_duration<span class="token punctuation">;</span>
    
            <span class="token comment">/**
             * 这些字段用于估算平均帧率
             */</span>
            <span class="token keyword">int64_t</span> fps_first_dts<span class="token punctuation">;</span>
            <span class="token keyword">int</span>     fps_first_dts_idx<span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> fps_last_dts<span class="token punctuation">;</span>
            <span class="token keyword">int</span>     fps_last_dts_idx<span class="token punctuation">;</span>
    
        <span class="token punctuation">}</span> <span class="token operator">*</span>info<span class="token punctuation">;</span>
    
        <span class="token keyword">int</span> pts_wrap_bits<span class="token punctuation">;</span> <span class="token comment">/**&lt; number of bits in pts (used for wrapping control) */</span>
    
        <span class="token comment">// 时间戳生成支持:</span>
        <span class="token comment">/**
         * 最后同步点的时间戳。
         *
         * 当AVCodecParserContext.dts_sync_point &gt;= 0 时初始化，并且接受一个当前容器的DTS。否
         * 则，AV_NOPTS_VALUE使用默认值
         */</span>
        <span class="token keyword">int64_t</span> first_dts<span class="token punctuation">;</span>
        <span class="token keyword">int64_t</span> cur_dts<span class="token punctuation">;</span>
        <span class="token keyword">int64_t</span> last_IP_pts<span class="token punctuation">;</span>
        <span class="token keyword">int</span> last_IP_duration<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 编解码器探测缓存的数据包数量
         */</span>
        <span class="token keyword">int</span> probe_packets<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * avformat_find_stream_info()调用期间，已经被分流的帧数
         */</span>
        <span class="token keyword">int</span> codec_info_nb_frames<span class="token punctuation">;</span>
    
        <span class="token comment">/* av_read_frame() 支持 */</span>
        <span class="token keyword">enum</span> <span class="token class-name">AVStreamParseType</span> need_parsing<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">AVCodecParserContext</span> <span class="token operator">*</span>parser<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 正在混流操作的流在数据包缓冲中的最后一个数据包
         */</span>
        <span class="token keyword">struct</span> <span class="token class-name">AVPacketList</span> <span class="token operator">*</span>last_in_packet_buffer<span class="token punctuation">;</span>
        AVProbeData probe_data<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_REORDER_DELAY</span> <span class="token expression"><span class="token number">16</span></span></span>
        <span class="token keyword">int64_t</span> pts_buffer<span class="token punctuation">[</span>MAX_REORDER_DELAY<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
        AVIndexEntry <span class="token operator">*</span>index_entries<span class="token punctuation">;</span> <span class="token comment">/**&lt; 只有当格式不支持本地seeking时使用*/</span>
        <span class="token keyword">int</span> nb_index_entries<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> index_entries_allocated_size<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 流的真实基准帧率.
         * 这是所有时间戳可以准确表示的最低帧速率（它是流中所有帧速率的最小公倍数）。 请注意，这个值只
         * 是一个猜测！ 例如，如果时基为1/90000，并且所有帧都具有约3600或1800个计时器滴答，则
         * r_frame_rate将为50/1。
         *
         * avformat以外的代码应该使用此字段访问:
         * av_stream_get/set_r_frame_rate(stream)
         */</span>
        AVRational r_frame_rate<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 流标志符
         * 这是MPEG-TS流标识符 +1
         * 0 意味着未知
         */</span>
        <span class="token keyword">int</span> stream_identifier<span class="token punctuation">;</span>
    
        <span class="token keyword">int64_t</span> interleaver_chunk_size<span class="token punctuation">;</span>
        <span class="token keyword">int64_t</span> interleaver_chunk_duration<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 流探测状态
         * -1   -&gt; 探测完毕
         *  0   -&gt; 没有探测请求
         * rest -&gt; 以request_probe作为接受的最低分数执行探测。
         * 不是公共API的一部分
         */</span>
        <span class="token keyword">int</span> request_probe<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 表示直到下一个关键帧的所有内容都应该丢弃。
         */</span>
        <span class="token keyword">int</span> skip_to_keyframe<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 在下一个数据包解码的帧开始时跳过的采样数。
         */</span>
        <span class="token keyword">int</span> skip_samples<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 如果不是0，则应从流的开始位置跳过的样本数量（样本从pts == 0的包中移除，这也假定负时间戳不会
         * 发生）。 旨在用于具有ad-hoc无间断音频支持的mp3等格式。
         */</span>
        <span class="token keyword">int64_t</span> start_skip_samples<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 如果不是0，应该从流中丢弃的第一个音频采样。 这是由设计丢弃的（需要全球采样计数），但无法避免
         * 由设计格式（如带有ad-hoc无间隙音频支持的mp3）破坏。
         */</span>
        <span class="token keyword">int64_t</span> first_discard_sample<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 在first_discard_sample之后打算丢弃的最后一个样本之后的样本。 仅适用于框架边界。 用于防止
         * 早期EOF，如果无间隙信息被破坏（考虑连接的MP3）。
         */</span>
        <span class="token keyword">int64_t</span> last_discard_sample<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 在libavformat内部使用的内部解码帧的数量不会访问其生存期，这与信息不同，因此它不在该结构
         * 中。
         */</span>
        <span class="token keyword">int</span> nb_decoded_frames<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 时间戳偏移添加到混流之前的时间戳
         * 非公共API
         */</span>
        <span class="token keyword">int64_t</span> mux_ts_offset<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 内部数据检查时间戳的包装
         */</span>
        <span class="token keyword">int64_t</span> pts_wrap_reference<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * Options for behavior, when a wrap is detected.
         *
         * Defined by AV_PTS_WRAP_ values.
         *
         * If correction is enabled, there are two possibilities:
         * If the first time stamp is near the wrap point, the wrap offset
         * will be subtracted, which will create negative time stamps.
         * Otherwise the offset will be added.
         */</span>
        <span class="token keyword">int</span> pts_wrap_behavior<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 禁止执行两次update_initial_durations（）的内部数据
         */</span>
        <span class="token keyword">int</span> update_initial_durations_done<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 内部数据，用于从pts生成dts
         */</span>
        <span class="token keyword">int64_t</span> pts_reorder_error<span class="token punctuation">[</span>MAX_REORDER_DELAY<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">uint8_t</span> pts_reorder_error_count<span class="token punctuation">[</span>MAX_REORDER_DELAY<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 内部数据，用于分析DTS和检测错误的MPEG流
         */</span>
        <span class="token keyword">int64_t</span> last_dts_for_order_check<span class="token punctuation">;</span>
        <span class="token keyword">uint8_t</span> dts_ordered<span class="token punctuation">;</span>
        <span class="token keyword">uint8_t</span> dts_misordered<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * Internal data to inject global side data
         */</span>
        <span class="token keyword">int</span> inject_global_side_data<span class="token punctuation">;</span>
    
        <span class="token comment">/*****************************************************************
         * 该行上方的所有字段都不是公共API的一部分。 下面的字段是公共API和ABI的一部分。
         *****************************************************************
         */</span>
    
        <span class="token comment">/**
         * 包含键和值的一系列字符串，用于描述推荐的编码器配置。
         * 系列以 ','分割.
         * 键和值由'='分割.
         */</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>recommended_encoder_configuration<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * 显示宽高比（如果未知，则为0）
         * - 编码: 不使用
         * - 解码: libavformat设置， 用于在内部计算显示宽高比。
         */</span>
        AVRational display_aspect_ratio<span class="token punctuation">;</span>
    
        <span class="token keyword">struct</span> <span class="token class-name">FFFrac</span> <span class="token operator">*</span>priv_pts<span class="token punctuation">;</span>
    
        <span class="token comment">/**
         * libavformat内部使用的不透明字段。 不得以任何方式访问。
         */</span>
        AVStreamInternal <span class="token operator">*</span>internal<span class="token punctuation">;</span>
    
        <span class="token comment">/*
         * 与此流关联的编解码器参数。 分别在avformat_new_stream（）和avformat_free_context（）
         * 中由libavformat分配和释放。
         *
         * - 分流: 由libavformat在流创建时填充或在avformat_find_stream_info（）赋值。
         * - 混流: 在avformat_write_header（）之前由调用者填充
         */</span>
        AVCodecParameters <span class="token operator">*</span>codecpar<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> AVStream<span class="token punctuation">;</span>


</code></pre> 
<h3><a id="35SwsContexthttpsffmpegorgdoxygen44structSwsContexthtml_1351"></a>3.5、<a href="https://ffmpeg.org/doxygen/4.4/structSwsContext.html" rel="nofollow">SwsContext</a></h3> 
<p>SwsContext 是 FFmpeg 库中的一个结构体，用于进行图像的缩放、颜色空间转换等操作。它是 FFmpeg 中的图像转换模块（swscale）的上下文。</p> 
<p>SwsContext 结构体用于图像转换，适用于将一个像素格式的图像转换为另一个像素格式的图像。它可以用于图像缩放、色彩空间转换、图像格式转换等操作。</p> 
<p>在 FFmpeg 4.0 版本及以后的版本中，SwsContext 结构体已经被弃用，取而代之的是 sws_getCachedContext 函数。该函数返回一个 struct SwsContext* 类型的指针，用于进行图像的缩放、颜色空间转换等操作。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">SwsContext</span> <span class="token operator">*</span><span class="token function">sws_getCachedContext</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">SwsContext</span> <span class="token operator">*</span>context<span class="token punctuation">,</span>
    <span class="token keyword">int</span> srcW<span class="token punctuation">,</span> <span class="token keyword">int</span> srcH<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">AVPixelFormat</span> srcFormat<span class="token punctuation">,</span>
    <span class="token keyword">int</span> dstW<span class="token punctuation">,</span> <span class="token keyword">int</span> dstH<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">AVPixelFormat</span> dstFormat<span class="token punctuation">,</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">,</span> SwsFilter <span class="token operator">*</span>srcFilter<span class="token punctuation">,</span> SwsFilter <span class="token operator">*</span>dstFilter<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>int srcW：源图像的宽度。</li><li>int srcH：源图像的高度。</li><li>enum AVPixelFormat srcFormat：源图像的像素格式。</li><li>int dstW：目标图像的宽度。</li><li>int dstH：目标图像的高度。</li><li>enum AVPixelFormat dstFormat：目标图像的像素格式。</li><li>struct SwsFilter *srcFilter：源图像的过滤器。</li><li>struct SwsFilter *dstFilter：目标图像的过滤器。</li><li>float *param：用于可选参数的数组。</li><li>int paramCount：可选参数的数量。</li></ul> 
<p>使用 SwsContext 结构体进行图像转换的一般流程如下：<br> 1、创建 SwsContext 对象：使用 sws_getContext 函数创建 SwsContext 对象，需要指定源图像的宽度、高度、像素格式，以及目标图像的宽度、高度、像素格式等参数。</p> 
<pre><code class="prism language-cpp">SwsContext <span class="token operator">*</span><span class="token function">sws_getContext</span><span class="token punctuation">(</span><span class="token keyword">int</span> srcW<span class="token punctuation">,</span> <span class="token keyword">int</span> srcH<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">AVPixelFormat</span> srcFormat<span class="token punctuation">,</span>
                           <span class="token keyword">int</span> dstW<span class="token punctuation">,</span> <span class="token keyword">int</span> dstH<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">AVPixelFormat</span> dstFormat<span class="token punctuation">,</span>
                           <span class="token keyword">int</span> flags<span class="token punctuation">,</span> SwsFilter <span class="token operator">*</span>srcFilter<span class="token punctuation">,</span> SwsFilter <span class="token operator">*</span>dstFilter<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2、进行图像转换：使用 sws_scale 函数进行图像的实际转换，将源图像数据转换为目标图像数据。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">sws_scale</span><span class="token punctuation">(</span>SwsContext <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token keyword">const</span> srcSlice<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">int</span> srcStride<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> srcSliceY<span class="token punctuation">,</span> <span class="token keyword">int</span> srcSliceH<span class="token punctuation">,</span>
              <span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token keyword">const</span> dst<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> dstStride<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>3、释放 SwsContext 对象：使用 sws_freeContext 函数释放 SwsContext 对象，释放相关资源。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">sws_freeContext</span><span class="token punctuation">(</span>SwsContext <span class="token operator">*</span>swsContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="36ANativeWindow_1391"></a>3.6、ANativeWindow</h3> 
<p>ANativeWindow是一个在Android NDK中使用的本地窗口抽象。它提供了与Android平台上的原生窗口进行交互的功能。</p> 
<p>通过ANativeWindow，开发者可以在NDK中创建和管理原生窗口，用于图形渲染和显示。它提供了一组函数和数据结构，用于控制窗口的属性、缓冲区的管理和渲染的配置。</p> 
<p>使用ANativeWindow进行图形渲染的一般步骤如下：</p> 
<ul><li> <p>获取ANativeWindow对象：通过ANativeActivity结构体中的window成员，可以获取当前应用程序的ANativeWindow对象。</p> </li><li> <p>设置窗口属性：使用ANativeWindow的函数，如ANativeWindow_setBuffersGeometry()，可以设置窗口的宽度、高度和像素格式等属性。</p> </li><li> <p>锁定窗口并获取绘图缓冲区：使用ANativeWindow_lock()函数可以锁定窗口，然后使用ANativeWindow_getBuffersGeometry()函数获取绘图缓冲区的信息。</p> </li><li> <p>渲染图形：根据获取的绘图缓冲区信息，使用图形渲染的算法或库，将图形数据绘制到绘图缓冲区中。</p> </li><li> <p>解锁窗口并显示：使用ANativeWindow_unlockAndPost()函数解锁窗口，并将绘制的图形缓冲区显示在屏幕上。</p> </li></ul> 
<h4><a id="_1407"></a>参考链接</h4> 
<p>https://blog.csdn.net/leixiaohua1020/article/details/14215833</p> 
<p>https://blog.csdn.net/qq_25333681/category_7686458.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fb079880887fc436963c2d06dab8a566/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">idea 弹出Server‘s certificate is not trusted 如何关闭</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a9659c77b8bb1f07f7670ca8f516a443/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python发送邮件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>