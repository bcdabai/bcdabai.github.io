<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【ASP.NET Core 基础知识】--中间件--创建自定义中间件 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【ASP.NET Core 基础知识】--中间件--创建自定义中间件" />
<meta property="og:description" content="一、为什么需要自定义中间件 自定义中间件在ASP.NET Core中的应用主要有以下几个原因：
满足特定需求： 默认情况下，ASP.NET Core提供了许多内置的中间件来处理常见的任务，如身份验证、授权、静态文件服务等。然而，某些项目可能有特定的需求，需要定制化的处理流程，这时就需要创建自定义中间件以满足项目的特殊要求。增加业务逻辑： 自定义中间件允许开发人员向请求处理流程中添加业务逻辑。这对于执行与应用程序的核心功能相关的任务非常有用，例如日志记录、性能监控、请求转换等。通过自定义中间件，开发人员可以灵活地将业务逻辑集成到请求处理管道中。解耦和模块化： 自定义中间件有助于将应用程序的不同部分解耦，使代码更具模块化和可维护性。每个中间件可以专注于特定的任务，这样代码的组织结构更清晰，便于理解和维护。性能优化： 自定义中间件可以用于执行性能优化任务，例如缓存、压缩、请求重定向等。通过在请求处理流程中插入自定义中间件，可以更好地控制和优化应用程序的性能。适应特定场景： 不同的应用场景可能需要不同类型的中间件。通过创建自定义中间件，开发人员可以根据应用的特定需求，灵活地调整和配置中间件，以适应不同的使用场景。 自定义中间件为开发人员提供了更大的灵活性和控制权，使他们能够更好地定制和优化ASP.NET Core应用程序的请求处理流程，满足特定的业务和性能需求。
二、创建自定义中间件的基本步骤 创建自定义中间件涉及以下基本步骤：
创建一个类： 创建一个类来实现你的中间件。这个类通常需要包含一个构造函数以及一个名为Invoke、InvokeAsync等的方法，用于处理请求。public class CustomMiddleware { private readonly RequestDelegate _next; public CustomMiddleware(RequestDelegate next) { _next = next; } public async Task InvokeAsync(HttpContext context) { // 中间件逻辑处理 await _next(context); } } 添加中间件的基本结构： 在中间件类中，你需要编写逻辑来处理请求。可以在Invoke方法中执行你的自定义逻辑，然后通过_next字段调用下一个中间件。注册中间件： 在Startup.cs文件的Configure方法中，使用UseMiddleware或Use方法将中间件添加到请求处理管道中。确保注册中间件的顺序正确，因为中间件的执行顺序很重要。public void Configure(IApplicationBuilder app) { // 其他中间件 app.UseMiddleware&lt;CustomMiddleware&gt;(); // 或者使用 app.Use&lt;CustomMiddleware&gt;(); // 其他中间件 } 中间件的执行流程： 确保理解中间件的执行流程。当请求到达时，每个中间件按照注册的顺序依次执行，然后请求通过管道传递给下一个中间件，直到最终的处理程序。配置中间件： 如果中间件需要配置选项，可以通过构造函数参数或其他方式将配置传递给中间件。这允许你在Startup.cs中配置中间件的行为。public void Configure(IApplicationBuilder app, IHostingEnvironment env) { // 其他中间件 app." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/556eb2232f369d22b02ac94a0e429fd9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-16T22:53:30+08:00" />
<meta property="article:modified_time" content="2024-01-16T22:53:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【ASP.NET Core 基础知识】--中间件--创建自定义中间件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>一、为什么需要自定义中间件</h4> 
<p>自定义中间件在ASP.NET Core中的应用主要有以下几个原因：</p> 
<ol><li><strong>满足特定需求：</strong> 默认情况下，ASP.NET Core提供了许多内置的中间件来处理常见的任务，如身份验证、授权、静态文件服务等。然而，某些项目可能有特定的需求，需要定制化的处理流程，这时就需要创建自定义中间件以满足项目的特殊要求。</li><li><strong>增加业务逻辑：</strong> 自定义中间件允许开发人员向请求处理流程中添加业务逻辑。这对于执行与应用程序的核心功能相关的任务非常有用，例如日志记录、性能监控、请求转换等。通过自定义中间件，开发人员可以灵活地将业务逻辑集成到请求处理管道中。</li><li><strong>解耦和模块化：</strong> 自定义中间件有助于将应用程序的不同部分解耦，使代码更具模块化和可维护性。每个中间件可以专注于特定的任务，这样代码的组织结构更清晰，便于理解和维护。</li><li><strong>性能优化：</strong> 自定义中间件可以用于执行性能优化任务，例如缓存、压缩、请求重定向等。通过在请求处理流程中插入自定义中间件，可以更好地控制和优化应用程序的性能。</li><li><strong>适应特定场景：</strong> 不同的应用场景可能需要不同类型的中间件。通过创建自定义中间件，开发人员可以根据应用的特定需求，灵活地调整和配置中间件，以适应不同的使用场景。</li></ol> 
<p>自定义中间件为开发人员提供了更大的灵活性和控制权，使他们能够更好地定制和优化ASP.NET Core应用程序的请求处理流程，满足特定的业务和性能需求。</p> 
<h4><a id="_10"></a>二、创建自定义中间件的基本步骤</h4> 
<p>创建自定义中间件涉及以下基本步骤：</p> 
<ol><li><strong>创建一个类：</strong> 创建一个类来实现你的中间件。这个类通常需要包含一个构造函数以及一个名为<code>Invoke</code>、<code>InvokeAsync</code>等的方法，用于处理请求。<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMiddleware</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CustomMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 中间件逻辑处理</span>
        <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li><strong>添加中间件的基本结构：</strong> 在中间件类中，你需要编写逻辑来处理请求。可以在<code>Invoke</code>方法中执行你的自定义逻辑，然后通过<code>_next</code>字段调用下一个中间件。</li><li><strong>注册中间件：</strong> 在<code>Startup.cs</code>文件的<code>Configure</code>方法中，使用<code>UseMiddleware</code>或<code>Use</code>方法将中间件添加到请求处理管道中。确保注册中间件的顺序正确，因为中间件的执行顺序很重要。<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 其他中间件</span>
    app<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseMiddleware</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomMiddleware<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 或者使用 app.Use&lt;CustomMiddleware&gt;();</span>
    <span class="token comment">// 其他中间件</span>
<span class="token punctuation">}</span>
</code></pre> </li><li><strong>中间件的执行流程：</strong> 确保理解中间件的执行流程。当请求到达时，每个中间件按照注册的顺序依次执行，然后请求通过管道传递给下一个中间件，直到最终的处理程序。</li><li><strong>配置中间件：</strong> 如果中间件需要配置选项，可以通过构造函数参数或其他方式将配置传递给中间件。这允许你在<code>Startup.cs</code>中配置中间件的行为。<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span> <span class="token class-name">IHostingEnvironment</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 其他中间件</span>
    app<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseMiddleware</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomMiddleware<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token comment">/* configuration options */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 其他中间件</span>
<span class="token punctuation">}</span>
</code></pre> </li><li><strong>测试中间件：</strong> 最后，确保测试你的中间件。创建单元测试和集成测试，验证中间件在不同场景下的正确性和可靠性。</li></ol> 
<h4><a id="_53"></a>三、中间件的参数和上下文对象</h4> 
<h6><a id="31__54"></a>3.1 解释中间件的参数</h6> 
<p>ASP.NET Core 中间件的 <code>Invoke</code> 或 <code>InvokeAsync</code> 方法通常接受一个 <code>HttpContext</code> 参数，该参数提供了关于当前请求和响应的信息。此外，中间件的构造函数也可以接受其他服务或选项，以实现更多的定制和灵活性。</p> 
<ol><li><strong>HttpContext 参数：</strong> 
  <ul><li><code>HttpContext</code> 包含了有关当前请求和响应的信息，如请求路径、请求方法、请求头、查询参数、响应状态等。</li><li>可以使用 <code>HttpContext</code> 提供的方法来访问请求和响应的内容，以及执行与中间件逻辑相关的操作。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 使用 context 处理请求和响应</span>
<span class="token punctuation">}</span>
</code></pre> </li><li><strong>构造函数参数：</strong> 
  <ul><li>构造函数可以接受其他服务作为参数，这些服务是通过 ASP.NET Core 依赖注入系统提供的。通过依赖注入，可以在中间件中使用其他组件，如数据库上下文、日志记录器等。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMiddleware</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>CustomMiddleware<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CustomMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>CustomMiddleware<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> </li><li><strong>配置选项：</strong> 
  <ul><li>如果中间件需要配置选项，可以通过构造函数参数传递配置信息。这样，中间件的行为可以在 <code>Startup.cs</code> 中进行配置。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMiddlewareOptions</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> OptionValue <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMiddleware</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">CustomMiddlewareOptions</span> _options<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CustomMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span> <span class="token class-name">IOptions<span class="token punctuation">&lt;</span>CustomMiddlewareOptions<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _options <span class="token operator">=</span> options<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h6><a id="32__105"></a>3.2 上下文对象的作用和使用方法</h6> 
<p><code>HttpContext</code> 是 ASP.NET Core 中间件中的关键对象，它提供了有关当前请求和响应的信息，允许中间件与请求处理流程进行交互。以下是 <code>HttpContext</code> 的主要作用和使用方法：</p> 
<ol><li> <p><strong>请求信息的获取：</strong></p> 
  <ul><li>通过 <code>HttpContext.Request</code> 属性，可以获取有关当前请求的详细信息，如路径、方法、协议、头部、查询参数等。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">string</span></span> path <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> method <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method<span class="token punctuation">;</span>
    <span class="token comment">// 其他请求信息的获取</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>响应信息的设置：</strong></p> 
  <ul><li>通过 <code>HttpContext.Response</code> 属性，可以设置有关响应的信息，如状态码、头部、内容类型等。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"text/plain"</span><span class="token punctuation">;</span>
    <span class="token comment">// 其他响应信息的设置</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>处理请求和响应内容：</strong></p> 
  <ul><li>通过 <code>HttpContext.Request.Body</code> 和 <code>HttpContext.Response.Body</code> 属性，可以访问请求和响应的主体内容，允许中间件对其进行读取或写入。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">StreamReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">string</span></span> requestBody <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理请求主体内容</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理响应主体内容</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>用户认证和授权信息：</strong></p> 
  <ul><li><code>HttpContext.User</code> 属性包含有关用户的认证和授权信息，允许中间件根据用户的角色和声明执行相应的逻辑。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ClaimsPrincipal</span> user <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
    <span class="token comment">// 处理用户认证和授权信息</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>重定向和路由：</strong></p> 
  <ul><li>通过 <code>HttpContext.Response.Redirect</code> 方法，可以执行重定向操作。而通过 <code>HttpContext.GetRouteData</code> 方法，可以获取有关当前路由的信息。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 执行重定向</span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token string">"/newpath"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取路由信息</span>
    <span class="token class-name">RouteData</span> routeData <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">GetRouteData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理路由信息</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>上下文的传递：</strong></p> 
  <ul><li><code>HttpContext.Items</code> 属性允许中间件在请求处理流程中传递数据。这对于在中间件之间共享信息非常有用。</li></ul> <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    context<span class="token punctuation">.</span>Items<span class="token punctuation">[</span><span class="token string">"Key"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Value"</span><span class="token punctuation">;</span>
    <span class="token comment">// 在中间件之间传递数据</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>通过充分利用 <code>HttpContext</code> 对象的这些功能，中间件可以与请求处理管道中的其他组件进行交互，执行特定的逻辑，并对请求和响应进行处理。</p> 
<h4><a id="_180"></a>四、示例：记录请求日志的中间件</h4> 
<p>以下是一个简单的示例，展示如何创建一个记录请求日志的自定义中间件。该中间件将请求的路径和时间戳记录到控制台，并继续将请求传递给下一个中间件或处理程序。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Http</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Logging</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggingMiddleware</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>LoggingMiddleware<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">LoggingMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>LoggingMiddleware<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 记录请求日志</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Request logged: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path</span><span class="token punctuation">}</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">DateTime<span class="token punctuation">.</span>Now</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将请求传递给下一个中间件或处理程序</span>
        <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后，在 <code>Startup.cs</code> 文件的 <code>Configure</code> 方法中，注册这个中间件：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span> <span class="token class-name">IHostingEnvironment</span> env<span class="token punctuation">,</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>Startup<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 其他中间件</span>

    <span class="token comment">// 注册日志中间件</span>
    app<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseMiddleware</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>LoggingMiddleware<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 其他中间件</span>

    <span class="token comment">// 配置异常处理中间件等</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这个示例中，<code>LoggingMiddleware</code> 类接受 <code>RequestDelegate</code> 和 <code>ILogger</code> 作为构造函数参数，分别表示请求处理管道的下一个组件和日志记录器。在 <code>InvokeAsync</code> 方法中，记录请求的路径和时间戳，然后调用 <code>_next(context)</code> 将请求传递给下一个中间件或处理程序。</p> 
<p>这个中间件可以用于记录每个请求的基本信息，对于调试和监视应用程序的运行非常有用。</p> 
<h4><a id="_227"></a>五、总结</h4> 
<p>ASP.NET Core 中间件是请求处理管道中的可插拔组件，通过自定义中间件，开发人员能够灵活处理请求和响应。创建自定义中间件的基本步骤包括编写类、注册和配置中间件，同时理解中间件的参数和上下文对象的使用。自定义中间件的需求源自对特定业务逻辑、性能优化和模块化的需求。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/474d461c95c7fc0f90e7e04c9229103b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">国考省考行测：语句排序，选择首句、选择尾句</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d5b725119b2ddfae63a0891ef38d505f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Code Coverage for .NET Crack</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>