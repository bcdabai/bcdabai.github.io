<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>内核NFS-V4部署服务，挂载，ACL使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="内核NFS-V4部署服务，挂载，ACL使用" />
<meta property="og:description" content="2019独角兽企业重金招聘Python工程师标准&gt;&gt;&gt; v4挂载服务端设置 vim /etc/exports /tmp *(fsid=0,rw,sync,no_root_squash,acl) /tmp/nfsdata *(rw,sync,no_root_squash,acl) 客户端挂载 mount.nfs4 ip:/nfsdata /mnt/nfs 导出IP设置 [root@rootbug ~]#vim /etc/exports /share/iso *(ro) --把/share/iso 共享给*（代表所有IP） ro (代表只读） /share/iso *(rw) --rw代表可读可写 /share/iso 10.10.10.0/24(ro) --只共享给10.10.10的网段的计算机访问 /share/iso 10.10.10.0/255.255.255.0(ro) /share/iso 10.10.10.10/255.255.255.255(ro) --定义只10.10.10.10这台计算机可以访问 /share/iso 10.10.10.10(ro) /share/iso 10.10.10.10/32(ro)10.10.10.254/32（rw) --定义只有10和254这两台可以访问 NFSv4和NFSv3的差别如下：
(1) NFSv4设计成了一种有状态的协议，自身实现了文件锁功能和获取文件系统根节点功能，不需要NLM和MOUNT协议协助了。
(2) NFSv4增加了安全性，支持RPCSEC-GSS身份认证。
(3) NFSv4只提供了两个请求NULL和COMPOUND，所有的操作都整合进了COMPOUND中，客户端可以根据实际请求将多个操作封装到一个COMPOUND请求中，增加了灵活性。
(4) NFSv4文件系统的命令空间发生了变化，服务器端必须设置一个根文件系统(fsid=0)，其他文件系统挂载在根文件系统上导出。
(5)
NFSv4支持delegation。由于多个客户端可以挂载同一个文件系统，为了保持文件同步，NFSv3中客户端需要经常向服务器发起请求，请求文件属性信息，判断其他客户端是否修改了文件。如果文件系统是只读的，或者客户端对文件的修改不频繁，频繁向服务器请求文件属性信息会降低系统性能。NFSv4可以依靠delegation实现文件同步。当客户端A打开一个文件时，服务器会分配给客户端A一个delegation。只要客户端A具有delegation，就可以认为与服务器保持了一致。如果另外一个客户端B访问同一个文件，则服务器会暂缓客户端B的访问请求，向客户端A发送RECALL请求。当客户端A接收到RECALL请求时将本地缓存刷新到服务器中，然后将delegation返回服务器，这时服务器开始处理客户端B的请求。
(6) NFSv4修改了文件属性的表示方法。由于NFS是Sun开发的一套文件系统，设计之出NFS文件属性参考了UNIX中的文件属性，可能Windows中不具备某些属性，因此NFS对操作系统的兼容性不太好。NFSv4将文件属性划分成了三类：
Mandatory Attributes: 这是文件的基本属性，所有的操作系统必须支持这些属性。
Recommended Attributes: 这是NFS建议的属性，如果可能操作系统尽量实现这些属性。
Named Attributes: 这是操作系统可以自己实现的一些文件属性。
（7）服务器端拷贝：
如果客户需要从一个NFS服务器拷贝数据到另外一个NFS服务器,nfsv4可以让两台NFS服务器之间直接拷贝数据，不需要经过客户端。
（8）资源预留和回收：
NFSv4为虚拟分配提供的新特性。随着存储虚拟分配功能的普及使用，nfsv4可以为预留固定大小的存储空间;同样在文件系统上删除文件后，也能够在存储上面释放相应空间。
（9）国际化支持：
NFSv4文件名、目录、链接、用户与组可以使用 UTF-8字符集，UTF-8兼容ASCII码，使得NFSv4支持更多语言。
（10）RPC合并调用：
NFSv4允许将多个请求合并为一个rpc引用，在NFSv3每个请求对应一个rpc调用。WAN环境中，NFSv4合并rpc调用可以显著降低延迟。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/294aac75ffea5e0d35b066257f0d8f5e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-05-11T09:54:00+08:00" />
<meta property="article:modified_time" content="2018-05-11T09:54:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">内核NFS-V4部署服务，挂载，ACL使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="content" id="articleContent"> 
 <div class="ad-wrap"> 
  <p><a style="color:#A00;font-weight:bold;" href="https://my.oschina.net/u/2663968/blog/3061697" rel="nofollow">2019独角兽企业重金招聘Python工程师标准&gt;&gt;&gt; </a> <img src="https://images2.imgbox.com/c8/c6/sa3sh6u0_o.png" alt="hot3.png"></p> 
 </div> 
 <span id="OSC_h1_1"></span> 
 <h2>v4挂载服务端设置</h2> 
 <pre><code class="language-apache">vim /etc/exports
/tmp *(fsid=0,rw,sync,no_root_squash,acl)
/tmp/nfsdata *(rw,sync,no_root_squash,acl)</code></pre> 
 <span id="OSC_h1_2"></span> 
 <h2>客户端挂载</h2> 
 <pre><code class="language-apache">mount.nfs4 ip:/nfsdata /mnt/nfs</code></pre> 
 <span id="OSC_h1_3"></span> 
 <h2>导出IP设置</h2> 
 <pre><code>[root@rootbug ~]#vim /etc/exports
/share/iso *(ro) --把/share/iso 共享给*（代表所有IP） ro (代表只读）
/share/iso *(rw) --rw代表可读可写
/share/iso 10.10.10.0/24(ro) --只共享给10.10.10的网段的计算机访问
/share/iso 10.10.10.0/255.255.255.0(ro)
/share/iso 10.10.10.10/255.255.255.255(ro) --定义只10.10.10.10这台计算机可以访问
/share/iso 10.10.10.10(ro)
/share/iso 10.10.10.10/32(ro)10.10.10.254/32（rw) --定义只有10和254这两台可以访问</code></pre> 
 <table cellpadding="0" cellspacing="0"><tbody><tr><td>NFSv4和NFSv3的差别如下：<br> (1) NFSv4设计成了一种有状态的协议，自身实现了文件锁功能和获取文件系统根节点功能，不需要NLM和MOUNT协议协助了。<br> (2) NFSv4增加了安全性，支持RPCSEC-GSS身份认证。<br> (3) NFSv4只提供了两个请求NULL和COMPOUND，所有的操作都整合进了COMPOUND中，客户端可以根据实际请求将多个操作封装到一个COMPOUND请求中，增加了灵活性。<br> (4) NFSv4文件系统的命令空间发生了变化，服务器端必须设置一个根文件系统(fsid=0)，其他文件系统挂载在根文件系统上导出。<br> (5)<br> NFSv4支持delegation。由于多个客户端可以挂载同一个文件系统，为了保持文件同步，NFSv3中客户端需要经常向服务器发起请求，请求文件属性信息，判断其他客户端是否修改了文件。如果文件系统是只读的，或者客户端对文件的修改不频繁，频繁向服务器请求文件属性信息会降低系统性能。NFSv4可以依靠delegation实现文件同步。当客户端A打开一个文件时，服务器会分配给客户端A一个delegation。只要客户端A具有delegation，就可以认为与服务器保持了一致。如果另外一个客户端B访问同一个文件，则服务器会暂缓客户端B的访问请求，向客户端A发送RECALL请求。当客户端A接收到RECALL请求时将本地缓存刷新到服务器中，然后将delegation返回服务器，这时服务器开始处理客户端B的请求。<br> (6) NFSv4修改了文件属性的表示方法。由于NFS是Sun开发的一套文件系统，设计之出NFS文件属性参考了UNIX中的文件属性，可能Windows中不具备某些属性，因此NFS对操作系统的兼容性不太好。NFSv4将文件属性划分成了三类：<br>         Mandatory Attributes: 这是文件的基本属性，所有的操作系统必须支持这些属性。<br>         Recommended Attributes: 这是NFS建议的属性，如果可能操作系统尽量实现这些属性。<br>         Named Attributes: 这是操作系统可以自己实现的一些文件属性。<br> （7）服务器端拷贝：<br> 如果客户需要从一个NFS服务器拷贝数据到另外一个NFS服务器,nfsv4可以让两台NFS服务器之间直接拷贝数据，不需要经过客户端。<br> （8）资源预留和回收：<br> NFSv4为虚拟分配提供的新特性。随着存储虚拟分配功能的普及使用，nfsv4可以为预留固定大小的存储空间;同样在文件系统上删除文件后，也能够在存储上面释放相应空间。<br> （9）国际化支持：<br> NFSv4文件名、目录、链接、用户与组可以使用 UTF-8字符集，UTF-8兼容ASCII码，使得NFSv4支持更多语言。<br> （10）RPC合并调用：<br> NFSv4允许将多个请求合并为一个rpc引用，在NFSv3每个请求对应一个rpc调用。WAN环境中，NFSv4合并rpc调用可以显著降低延迟。<br> （11）安全性：<br> NFSv4用户验证采用“用户名+域名”的模式，与Windows  AD验证方式类似，NFSv4强制使用Kerberos验证方式。(Kerberos与Windows  AD都遵循相同RFC1510标准)，这样方便windows和*nix环境混合部署。<br> （12）pNFS<br> 并行NFS文件系统，元数据服务器负责用户请求调度、数据服务器负责客户请求处理。pNFS需要NFS服务器和客户端协同支持<br><br> 后来的 NFSv4.1<br>         与NFSv4.0相比，NFSv4.1最大的变化是支持并行存储了。在以前的协议中，客户端直接与服务器连接，客户端直接将数据传输到服务器中。当客户端数量较少时这种方式没有问题，但是如果大量的客户端要访问数据时，NFS服务器很快就会成为一个瓶颈，抑制了系统的性能。NFSv4.1支持并行存储，服务器由一台元数据服务器(MDS)和多台数据服务器(DS)构成，元数据服务器只管理文件在磁盘中的布局，数据传输在客户端和数据服务器之间直接进行。由于系统中包含多台数据服务器，因此数据可以以并行方式访问，系统吞吐量迅速提升。现在新的是nfsv4.2<br>         所以尽可能用nfs4<br><br><br><br><br><br> 补充：<br> nfs4挂载的fsid问题<br> 问题现象：<br> 挂载nfs4时，报错：reason given by server :No such file or directory<br><br> 背景知识：<br> NFSv4将所有共享使用一个虚拟文件系统展示给客户端。伪文件系统根目录(/)使用fsid=0标示，只有一个共享可以是fsid=0。客户端需要使用“nfs server ip:/”挂载伪文件系统，伪文件系统一般使用RO方式共享，其他共享可以通过mount –bind选项在伪文件系统目录下挂载。客户端挂载过程需要通过mount –t nfs4指定NFS版本为4，默认采用nfsv3。<br><br> 解决：<br> 以下是我的配置文件，我想挂在/datapool/nfs目录<br> /  *(rw,fsid=0,insecure,no_root_squash)<br> /datapool/nfs   *(rw,fsid=1000,insecure,no_root_squash<br><br> 然后mount -t nfs4 ip:/datapool/nfs   /mnt/nfs/<br><br><br><br> nfs配置参数选项说明：<br> ro：共享目录只读；<br> rw：共享目录可读可写；<br> all_squash：所有访问用户都映射为匿名用户或用户组；<br> no_all_squash（默认）：访问用户先与本机用户匹配，匹配失败后再映射为匿名用户或用户组；<br> root_squash（默认）：将来访的root用户映射为匿名用户或用户组；<br> no_root_squash：来访的root用户保持root帐号权限；<br> anonuid=&lt;UID&gt;：指定匿名访问用户的本地用户UID，默认为nfsnobody（65534）；<br> anongid=&lt;GID&gt;：指定匿名访问用户的本地用户组GID，默认为nfsnobody（65534）；<br> secure（默认）：限制客户端只能从小于1024的tcp/ip端口连接服务器；<br> insecure：允许客户端从大于1024的tcp/ip端口连接服务器；<br> sync：将数据同步写入内存缓冲区与磁盘中，效率低，但可以保证数据的一致性；<br> async：将数据先保存在内存缓冲区中，必要时才写入磁盘；<br> wdelay（默认）：检查是否有相关的写操作，如果有则将这些写操作一起执行，这样可以提高效率；<br> no_wdelay：若有写操作则立即执行，应与sync配合使用；<br> subtree_check（默认） ：若输出目录是一个子目录，则nfs服务器将检查其父目录的权限；<br> no_subtree_check ：即使输出目录是一个子目录，nfs服务器也不检查其父目录的权限，这样可以提高效率；<br><strong>Troubleshooting</strong> <p>1、在上面的操作过程中，如果你不幸遇到下面这个问题的话，可以尝试更新 Linux kernel 或通过打开 IPv6 来解决这个问题，这是1个 bug：</p> # mount -t nfs4 172.16.20.1:/ /home/vpsee/bak/<br> mount.nfs4: Cannot allocate memory <p>2、如果遇到如下问题，可能是因为你的 mount -t nfs 使用的是 nfsv3 协议，需要明确指出使用 nfsv4 协议挂载 mount -t nfs4：</p> # mount -t nfs 172.16.20.1:/ /home/vpsee/bak/<br> mount: mount to NFS server '172.16.20.1' failed: RPC Error: Program not registered.<br><br> # mount -t nfs4 172.16.20.1:/ /home/vpsee/bak/<br> 如果网络不稳定<br>   <p>NFS默认是用UDP协议，换成TCP协议挂载即可：</p> <p>mount -t nfs 11.11.165.115:/tmp/test0920   /data  -o proto=tcp -o nolock</p> </td></tr></tbody></table> 
 <div class="ad-wrap"> 
  <div id="blog-title-ad"> 
   <ins class="adsbygoogle"></ins> 
  </div> 
 </div> 
</div> 
<p>转载于:https://my.oschina.net/linjiezang/blog/1810589</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c8ae51694d2b42a7daf4fa7a9ab7f008/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Word 交叉引用如何调整引用顺序？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1b0f9e98254c3c19072a29f0da2c8243/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">react框架设计原理及生命周期</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>