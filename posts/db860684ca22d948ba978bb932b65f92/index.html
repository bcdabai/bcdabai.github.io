<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>YOLOv8推理详解及部署实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="YOLOv8推理详解及部署实现" />
<meta property="og:description" content="目录 注意事项一、2024/1/10更新前言一、YOLOv8推理(Python)1. YOLOv8预测2. YOLOv8预处理3. YOLOv8后处理4. YOLOv8推理 二、YOLOv8推理(C&#43;&#43;)1. ONNX导出2. YOLOv8预处理3. YOLOv8后处理4. YOLOv8推理 三、YOLOv8部署1. 源码下载2. 环境配置2.1 配置CMakeLists.txt2.2 配置Makefile 3. ONNX导出4. 源码修改5. 运行 结语下载链接参考 注意事项 一、2024/1/10更新 修改第 4 部分 YOLOv8 推理中后处理 iou 计算代码，原代码存在问题，原代码如下：
def iou(box1, box2): def area_box(box): return (box[2] - box[0]) * (box[3] - box[1]) left, top = max(box1[:2], box2[:2]) right, bottom = min(box1[2:4], box2[2:4]) ... 其中，box1 和 box2 是表示边界框的列表，格式为 [left, top, right, bottom, …]。在 Python 中，当 max 函数用于两个列表时，它会比较列表中的元素，从左到右，直到找到某一个列表中的较大元素，然后返回那个较大元素的完整列表。比如现在比较 max([3,0],[2,1])，因为 3 大于 2，而不考虑后面的元素，返回的就是 [3,0]。这意味着在计算交集区域的左上角坐标时，仅比较了 left 坐标，而没有正确地处理 top 坐标，同理右下角坐标也存在类似的问题" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/db860684ca22d948ba978bb932b65f92/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T15:43:24+08:00" />
<meta property="article:modified_time" content="2024-01-10T15:43:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">YOLOv8推理详解及部署实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">注意事项</a></li><li><a href="#2024110_4" rel="nofollow">一、2024/1/10更新</a></li><li><a href="#_35" rel="nofollow">前言</a></li><li><a href="#YOLOv8Python_43" rel="nofollow">一、YOLOv8推理(Python)</a></li><li><ul><li><a href="#1_YOLOv8_45" rel="nofollow">1. YOLOv8预测</a></li><li><a href="#2_YOLOv8_121" rel="nofollow">2. YOLOv8预处理</a></li><li><a href="#3_YOLOv8_205" rel="nofollow">3. YOLOv8后处理</a></li><li><a href="#4_YOLOv8_329" rel="nofollow">4. YOLOv8推理</a></li></ul> 
   </li><li><a href="#YOLOv8C_493" rel="nofollow">二、YOLOv8推理(C++)</a></li><li><ul><li><a href="#1_ONNX_497" rel="nofollow">1. ONNX导出</a></li><li><a href="#2_YOLOv8_584" rel="nofollow">2. YOLOv8预处理</a></li><li><a href="#3_YOLOv8_680" rel="nofollow">3. YOLOv8后处理</a></li><li><a href="#4_YOLOv8_734" rel="nofollow">4. YOLOv8推理</a></li></ul> 
   </li><li><a href="#YOLOv8_756" rel="nofollow">三、YOLOv8部署</a></li><li><ul><li><a href="#1__762" rel="nofollow">1. 源码下载</a></li><li><a href="#2__772" rel="nofollow">2. 环境配置</a></li><li><ul><li><a href="#21_CMakeListstxt_778" rel="nofollow">2.1 配置CMakeLists.txt</a></li><li><a href="#22_Makefile_812" rel="nofollow">2.2 配置Makefile</a></li></ul> 
    </li><li><a href="#3_ONNX_846" rel="nofollow">3. ONNX导出</a></li><li><a href="#4__850" rel="nofollow">4. 源码修改</a></li><li><a href="#5__865" rel="nofollow">5. 运行</a></li></ul> 
   </li><li><a href="#_887" rel="nofollow">结语</a></li><li><a href="#_893" rel="nofollow">下载链接</a></li><li><a href="#_898" rel="nofollow">参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>注意事项</h3> 
<h3><a id="2024110_4"></a>一、2024/1/10更新</h3> 
<p><strong>修改第 4 部分 YOLOv8 推理中后处理 iou 计算代码</strong>，原代码存在问题，原代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    left<span class="token punctuation">,</span> top <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>其中，<strong>box1</strong> 和 <strong>box2</strong> 是表示边界框的列表，格式为 <strong>[left, top, right, bottom, …]</strong>。在 Python 中，当 <strong>max</strong> 函数用于两个列表时，它会比较列表中的元素，从左到右，直到找到某一个列表中的较大元素，<strong>然后返回那个较大元素的完整列表</strong>。比如现在比较 <strong>max([3,0],[2,1])</strong>，因为 3 大于 2，而不考虑后面的元素，返回的就是 <strong>[3,0]</strong>。这意味着在计算交集区域的左上角坐标时，仅比较了 <strong>left</strong> 坐标，而没有正确地处理 <strong>top</strong> 坐标，同理右下角坐标也存在类似的问题</p> 
<p>因此，修改后的代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h3><a id="_35"></a>前言</h3> 
<blockquote> 
 <p>梳理下 YOLOv8 的预处理和后处理流程，顺便让 tensorRT_Pro 支持 YOLOv8</p> 
 <p>参考：<a href="https://github.com/shouxieai/tensorRT_Pro">https://github.com/shouxieai/tensorRT_Pro</a></p> 
 <p>实现：<a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a></p> 
</blockquote> 
<h3><a id="YOLOv8Python_43"></a>一、YOLOv8推理(Python)</h3> 
<h4><a id="1_YOLOv8_45"></a>1. YOLOv8预测</h4> 
<blockquote> 
 <p>我们先尝试利用官方预训练权重来推理一张图片并保存，看能否成功</p> 
</blockquote> 
<p>在 YOLOv8 主目录下新建 <strong>predict.py</strong> 预测文件，其内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

<span class="token keyword">def</span> <span class="token function">hsv2bgr</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_i <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> h <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">-</span> h_i
    p <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span>
    q <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">*</span> s<span class="token punctuation">)</span>
    t <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
    
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token keyword">if</span> h_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> t<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> q<span class="token punctuation">,</span> v<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">random_color</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x937151</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    s_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x315793</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    <span class="token keyword">return</span> hsv2bgr<span class="token punctuation">(</span>h_plane<span class="token punctuation">,</span> s_plane<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov8s.pt"</span><span class="token punctuation">)</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"ultralytics/assets/bus.jpg"</span><span class="token punctuation">)</span>
    results <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    names   <span class="token operator">=</span> results<span class="token punctuation">.</span>names
    boxes   <span class="token operator">=</span> results<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span>data<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> obj <span class="token keyword">in</span> boxes<span class="token punctuation">:</span>
        left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span>color <span class="token punctuation">,</span>thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> lineType<span class="token operator">=</span>cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
        caption <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>confidence<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"predict.jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"save done"</span><span class="token punctuation">)</span>    
</code></pre> 
<p>在上述代码中我们通过 opencv 读取了一张图像，并送入模型中推理得到输出 results，results 中保存着不同任务的结果，我们这里是检测任务，因此只需要拿到对应的 boxes 即可。</p> 
<p>拿到 boxes 后我们就可以将对应的框和模型预测的类别以及置信度绘制在图像上并保存。</p> 
<p>关于可视化的代码实现参考自 tensorRT_Pro 中的实现，可以参考：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo.cpp#L95">app_yolo.cpp#L95</a></p> 
<p>关于随机颜色的代码实现参考自 tensorRT_Pro 中的实现，可以参考：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/tensorRT/common/ilogger.cpp#L90">ilogger.cpp#L90</a></p> 
<p>模型推理保存的结果图像如下所示：</p> 
<p><img src="https://images2.imgbox.com/b2/00/z17DoIO0_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="2_YOLOv8_121"></a>2. YOLOv8预处理</h4> 
<blockquote> 
 <p>模型预测成功后我们就需要自己动手来写下 YOLOv8 的预处理和后处理，方便后续在 C++ 上的实现，我们先来看看预处理的实现。</p> 
</blockquote> 
<p>经过我们的调试分析可知 YOLOv8 的预处理过程在 <strong>ultralytics/engine/predictor.py</strong> 文件中，可以参考：<a href="https://github.com/ultralytics/ultralytics/blob/main/ultralytics/engine/predictor.py#L111">predictor.py#L111</a></p> 
<p>代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Prepares input image before inference.

    Args:
        im (torch.Tensor | List(np.ndarray)): BCHW for tensor, [(HWC) x B] for list.
    """</span>
    not_tensor <span class="token operator">=</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span>
    <span class="token keyword">if</span> not_tensor<span class="token punctuation">:</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_transform<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">)</span>
        im <span class="token operator">=</span> im<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># BGR to RGB, BHWC to BCHW, (n, 3, h, w)</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>im<span class="token punctuation">)</span>  <span class="token comment"># contiguous</span>
        im <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>im<span class="token punctuation">)</span>

    im <span class="token operator">=</span> im<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    im <span class="token operator">=</span> im<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fp16 <span class="token keyword">else</span> im<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32</span>
    <span class="token keyword">if</span> not_tensor<span class="token punctuation">:</span>
        im <span class="token operator">/=</span> <span class="token number">255</span>  <span class="token comment"># 0 - 255 to 0.0 - 1.0</span>
    <span class="token keyword">return</span> im
</code></pre> 
<p>它包含以下步骤：</p> 
<ul><li><strong>self.pre_transform</strong>：即 letterbox 添加灰条</li><li><strong>im[…,::-1]</strong>：BGR → RGB</li><li><strong>transpose((0, 3, 1, 2))</strong>：添加 batch 维度，HWC → CHW</li><li><strong>torch.from_numpy</strong>：to Tensor</li><li><strong>im /= 255</strong>：除以 255，归一化</li></ul> 
<p>大家如果对 YOLOv5 的预处理熟悉的话，会发现 YOLOv8 的预处理和 YOLOv5 的预处理一模一样，因此我们不难写出对应的预处理代码，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess_warpAffine</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dst_width<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> dst_height<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dst_width <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst_height <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ox <span class="token operator">=</span> <span class="token punctuation">(</span>dst_width  <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    oy <span class="token operator">=</span> <span class="token punctuation">(</span>dst_height <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    M <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span>scale<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ox<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> oy<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    
    img_pre <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>image<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_width<span class="token punctuation">,</span> dst_height<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">,</span>
                             borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> borderValue<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    IM <span class="token operator">=</span> cv2<span class="token punctuation">.</span>invertAffineTransform<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

    img_pre <span class="token operator">=</span> <span class="token punctuation">(</span>img_pre<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> img_pre<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
    img_pre <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_pre<span class="token punctuation">,</span> IM
</code></pre> 
<p>其中的 letterbox 添加灰条步骤我们可以通过仿射变换 warpAffine 实现，warpAffine 非常适合在 CUDA 上加速，关于 warpAffine 仿射变换的细节大家可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a>，这边不再赘述。其它步骤倒是和官方的没有区别。</p> 
<p>值得注意的是，letterbox 的操作是先将长边缩放到 640，再将短边按比例缩放，同时确保缩放后的短边能整除 32，如果不能则向上取整多余部分填充。warpAffine 的操作则是将图像分辨率固定在 640x640，多余部分添加灰条，博主对一张 <strong>1080x810</strong> 分辨率的图像经过两种不同预处理后的结果进行了对比，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/95/2f/CdfXRnaG_o.jpg" alt="在这里插入图片描述"></p> 
<center> 
 <b>图1-1 LeeterBox预处理图像</b> 
</center> 
<p><img src="https://images2.imgbox.com/60/33/sAHnTwgd_o.jpg" alt="在这里插入图片描述"></p> 
<center> 
 <b>图1-2 warpAffine预处理图像</b> 
</center> 
<p>可以看到二者明显的差别，letterbox 中没有灰条，因为长边缩放到 640 后短边刚好缩放到 480，能整除 32。而 warpAffine 则是固定分辨率 640x640，因此短边多余部分将用灰条填充。</p> 
<p>warpAffine 预处理方法将图像分辨率固定在 640x640，主要有以下几点考虑：(<strong>from chatGPT</strong>)</p> 
<ul><li><strong>简化处理逻辑</strong>：所有预处理后的图像分辨率相同，可以简化 CUDA 中并行处理的逻辑，使得代码更易于编写和维护。</li><li><strong>优化内存访问</strong>：在 GPU 上，连续的内存访问模式通常比非连续的访问更高效。如果所有图像具有相同的大小和布局，这可以帮助优化内存访问，提高处理速度。</li><li><strong>避免动态内存分配</strong>：动态内存分配和释放是昂贵的操作，特别是在 GPU 上。固定分辨率意味着可以预先分配足够的内存，而不需要根据每个图像的大小动态调整内存大小。</li></ul> 
<p>这两种不同的预处理方法生成的图片输入到神经网络时的维度不同，letterbox 的输入是 <strong>torch.Size([1, 3, 640, 480])</strong>，warpAffine 的输入是 <strong>torch.Size([1, 3, 640, 640])</strong>。由于输入维度不同将导致模型输出维度的差异，leetrbox 的输出是 <strong>torch.Size([1, 84, 6300])</strong> 只有 6300 个框，而 warpAffine 的输出是 <strong>torch.Size([1, 84, 8400])</strong> 有 8400 个框，这点大家需要清楚。</p> 
<h4><a id="3_YOLOv8_205"></a>3. YOLOv8后处理</h4> 
<blockquote> 
 <p>我们再来看看后处理的实现</p> 
</blockquote> 
<p>经过我们的调试分析可知 YOLOv8 的后处理过程在 <strong>ultralytics/models/yolo/detect/predict.py</strong> 文件中，可以参考：<a href="https://github.com/ultralytics/ultralytics/blob/main/ultralytics/models/yolo/detect/predict.py#L23">detect/predict.py#L23</a></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DetectionPredictor</span><span class="token punctuation">(</span>BasePredictor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class extending the BasePredictor class for prediction based on a detection model.

    Example:
        ```python
        from ultralytics.utils import ASSETS
        from ultralytics.models.yolo.detect import DetectionPredictor

        args = dict(model='yolov8n.pt', source=ASSETS)
        predictor = DetectionPredictor(overrides=args)
        predictor.predict_cli()

    """</span>
    
    <span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">,</span> img<span class="token punctuation">,</span> orig_imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Post-processes predictions and returns a list of Results objects."""</span>
        preds <span class="token operator">=</span> ops<span class="token punctuation">.</span>non_max_suppression<span class="token punctuation">(</span>preds<span class="token punctuation">,</span>
                                        self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>conf<span class="token punctuation">,</span>
                                        self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>iou<span class="token punctuation">,</span>
                                        agnostic<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>agnostic_nms<span class="token punctuation">,</span>
                                        max_det<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>max_det<span class="token punctuation">,</span>
                                        classes<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>classes<span class="token punctuation">)</span>
    
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>orig_imgs<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># input images are a torch.Tensor, not a list</span>
            orig_imgs <span class="token operator">=</span> ops<span class="token punctuation">.</span>convert_torch2numpy_batch<span class="token punctuation">(</span>orig_imgs<span class="token punctuation">)</span>
    
        results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> pred <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
            orig_img <span class="token operator">=</span> orig_imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span>scale_boxes<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
            img_path <span class="token operator">=</span> self<span class="token punctuation">.</span>batch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Results<span class="token punctuation">(</span>orig_img<span class="token punctuation">,</span> path<span class="token operator">=</span>img_path<span class="token punctuation">,</span> names<span class="token operator">=</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>names<span class="token punctuation">,</span> boxes<span class="token operator">=</span>pred<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> results
</code></pre> 
<p>它包含以下步骤：</p> 
<ul><li><strong>ops.non_max_suppression</strong>：非极大值抑制，即 NMS</li><li><strong>ops.scale_boxes</strong>：框的解码，即 decode boxes</li></ul> 
<p>大家如果对 YOLOv5 的后处理熟悉的话，会发现 YOLOv8 的后处理和 YOLOv5 的后处理基本相似，为什么说基本相似呢，是因为 YOLOv8 是基于 anchor-free 的，在框的解码上有略微差异，因此我们不难写出对应的后处理代码，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cross  <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bottom<span class="token operator">-</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    union  <span class="token operator">=</span> area_box<span class="token punctuation">(</span>box1<span class="token punctuation">)</span> <span class="token operator">+</span> area_box<span class="token punctuation">(</span>box2<span class="token punctuation">)</span> <span class="token operator">-</span> cross
    <span class="token keyword">if</span> cross <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> cross <span class="token operator">/</span> union

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>

    remove_flags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ibox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        keep_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ibox<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            jbox <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ibox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">!=</span> jbox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> iou<span class="token punctuation">(</span>ibox<span class="token punctuation">,</span> jbox<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iou_thres<span class="token punctuation">:</span>
                remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> keep_boxes

<span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> IM<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 输入是模型推理的结果，即8400个预测框</span>
    <span class="token comment"># 1,8400,84 [cx,cy,w,h,class*80]</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> label<span class="token punctuation">]</span>
        <span class="token keyword">if</span> confidence <span class="token operator">&lt;</span> conf_thres<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        left    <span class="token operator">=</span> cx <span class="token operator">-</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        top     <span class="token operator">=</span> cy <span class="token operator">-</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        right   <span class="token operator">=</span> cx <span class="token operator">+</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        bottom  <span class="token operator">=</span> cy <span class="token operator">+</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> label<span class="token punctuation">]</span><span class="token punctuation">)</span>

    boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>
    lr <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    tb <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> lr <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> tb <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> NMS<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>
</code></pre> 
<p>其中预测框的解码我们是通过仿射变换逆矩阵 IM 实现的，关于 IM 的细节大家可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a>，这边不再赘述。关于 NMS 的代码参考自 tensorRT_Pro 中的实现：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo/yolo.cpp#L119">yolo.cpp#L119</a></p> 
<p>对于一张 640x640 的图片来说，YOLOv8 预测框的总数量是 <strong>8400</strong>，每个预测框的维度是 <strong>84</strong>（针对 COCO 数据集的 80 个类别而言）<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
            
              8400 
             
            
              × 
             
            
              84 
             
            
           
          
          
           
            
             
            
              = 
             
            
              80 
             
            
              × 
             
            
              80 
             
            
              × 
             
            
              84 
             
            
              + 
             
            
              40 
             
            
              × 
             
            
              40 
             
            
              × 
             
            
              84 
             
            
              + 
             
            
              20 
             
            
              × 
             
            
              20 
             
            
              × 
             
            
              84 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              80 
             
            
              × 
             
            
              80 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              ) 
             
            
              + 
             
            
              40 
             
            
              × 
             
            
              40 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              ) 
             
            
              + 
             
            
              20 
             
            
              × 
             
            
              20 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              ) 
             
            
           
          
         
        
       
         \begin{aligned} 8400\times84&amp;=80\times80\times84+40\times40\times84+20\times20\times84\\ &amp;=80\times80\times(4+80)+40\times40\times(4+80)+20\times20\times(4+80) \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3em; vertical-align: -1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span class="" style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">8400</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">84</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span class="" style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">84</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">84</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">84</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 其中的 4 对应的是 <strong>cx</strong>, <strong>cy</strong>, <strong>w</strong>, <strong>h</strong>，分别代表的含义是边界框中心点坐标、宽高；80 对应的是 COCO 数据集中的 80 个类别置信度。</p> 
<h4><a id="4_YOLOv8_329"></a>4. YOLOv8推理</h4> 
<blockquote> 
 <p>通过上面对 YOLOv8 的预处理和后处理分析之后，整个推理过程就显而易见了。YOLOv8 的推理包括图像预处理、模型推理、预测结果后处理三部分，其中预处理主要包括 <strong>warpAffine 仿射变换</strong>，后处理主要包括 <strong>decode 解码和 NMS</strong> 两部分。</p> 
</blockquote> 
<p>完整的推理代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>data<span class="token punctuation">.</span>augment <span class="token keyword">import</span> LetterBox
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>autobackend <span class="token keyword">import</span> AutoBackend

<span class="token keyword">def</span> <span class="token function">preprocess_letterbox</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    letterbox <span class="token operator">=</span> LetterBox<span class="token punctuation">(</span>new_shape<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> auto<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> letterbox<span class="token punctuation">(</span>image<span class="token operator">=</span>image<span class="token punctuation">)</span>
    image <span class="token operator">=</span> <span class="token punctuation">(</span>image<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token comment"># BGR to RGB, 0 - 255 to 0.0 - 1.0</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># BHWC to BCHW (n, 3, h, w)</span>
    image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    <span class="token keyword">return</span> image

<span class="token keyword">def</span> <span class="token function">preprocess_warpAffine</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dst_width<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> dst_height<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dst_width <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst_height <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ox <span class="token operator">=</span> <span class="token punctuation">(</span>dst_width  <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    oy <span class="token operator">=</span> <span class="token punctuation">(</span>dst_height <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    M <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span>scale<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ox<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> oy<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    
    img_pre <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>image<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_width<span class="token punctuation">,</span> dst_height<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">,</span>
                             borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> borderValue<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    IM <span class="token operator">=</span> cv2<span class="token punctuation">.</span>invertAffineTransform<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

    img_pre <span class="token operator">=</span> <span class="token punctuation">(</span>img_pre<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> img_pre<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
    img_pre <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_pre<span class="token punctuation">,</span> IM

<span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cross  <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bottom<span class="token operator">-</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    union  <span class="token operator">=</span> area_box<span class="token punctuation">(</span>box1<span class="token punctuation">)</span> <span class="token operator">+</span> area_box<span class="token punctuation">(</span>box2<span class="token punctuation">)</span> <span class="token operator">-</span> cross
    <span class="token keyword">if</span> cross <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> cross <span class="token operator">/</span> union

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>

    remove_flags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ibox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        keep_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ibox<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            jbox <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ibox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">!=</span> jbox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> iou<span class="token punctuation">(</span>ibox<span class="token punctuation">,</span> jbox<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iou_thres<span class="token punctuation">:</span>
                remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> keep_boxes

<span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> IM<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 输入是模型推理的结果，即8400个预测框</span>
    <span class="token comment"># 1,8400,84 [cx,cy,w,h,class*80]</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> label<span class="token punctuation">]</span>
        <span class="token keyword">if</span> confidence <span class="token operator">&lt;</span> conf_thres<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        left    <span class="token operator">=</span> cx <span class="token operator">-</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        top     <span class="token operator">=</span> cy <span class="token operator">-</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        right   <span class="token operator">=</span> cx <span class="token operator">+</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        bottom  <span class="token operator">=</span> cy <span class="token operator">+</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> label<span class="token punctuation">]</span><span class="token punctuation">)</span>

    boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>
    lr <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    tb <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> lr <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> tb <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> NMS<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">hsv2bgr</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_i <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> h <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">-</span> h_i
    p <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span>
    q <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">*</span> s<span class="token punctuation">)</span>
    t <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
    
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token keyword">if</span> h_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> t<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> q<span class="token punctuation">,</span> v<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">random_color</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x937151</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    s_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x315793</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    <span class="token keyword">return</span> hsv2bgr<span class="token punctuation">(</span>h_plane<span class="token punctuation">,</span> s_plane<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"ultralytics/assets/bus.jpg"</span><span class="token punctuation">)</span>

    <span class="token comment"># img_pre = preprocess_letterbox(img)</span>
    img_pre<span class="token punctuation">,</span> IM <span class="token operator">=</span> preprocess_warpAffine<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

    model  <span class="token operator">=</span> AutoBackend<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">"yolov8s.pt"</span><span class="token punctuation">)</span>
    names  <span class="token operator">=</span> model<span class="token punctuation">.</span>names
    result <span class="token operator">=</span> model<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 1,8400,84</span>

    boxes  <span class="token operator">=</span> postprocess<span class="token punctuation">(</span>result<span class="token punctuation">,</span> IM<span class="token punctuation">)</span>

    <span class="token keyword">for</span> obj <span class="token keyword">in</span> boxes<span class="token punctuation">:</span>
        left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span>color <span class="token punctuation">,</span>thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> lineType<span class="token operator">=</span>cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
        caption <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>confidence<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"infer.jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"save done"</span><span class="token punctuation">)</span>  
</code></pre> 
<p>推理效果如下图：</p> 
<p><img src="https://images2.imgbox.com/ff/e9/plk8Yvro_o.jpg" alt="在这里插入图片描述"></p> 
<p>至此，我们在 Python 上面完成了 YOLOv8 的整个推理过程，下面我们去 C++ 上实现。</p> 
<h3><a id="YOLOv8C_493"></a>二、YOLOv8推理(C++)</h3> 
<blockquote> 
 <p>C++ 上的实现我们使用的 repo 依旧是 tensorRT_Pro，现在我们就基于 tensorRT_Pro 完成 YOLOv8 在 C++ 上的推理。</p> 
</blockquote> 
<h4><a id="1_ONNX_497"></a>1. ONNX导出</h4> 
<p>首先我们需要将 YOLOv8 模型导出为 ONNX，为了适配 tensorRT_Pro 我们需要做一些修改，主要有以下几点：</p> 
<ul><li>修改输出节点名为 <strong>output</strong>，输入输出只让 batch 维度动态，宽高不动态</li><li>增加 <strong>transpose</strong> 节点交换输出的 2、3 维度</li></ul> 
<p>具体修改如下：</p> 
<p><strong>1.</strong> <strong>在 ultralytics/engine/exporter.py 文件中改动一处</strong></p> 
<ul><li><strong>323 行</strong>：输出节点名修改为 <strong>output</strong></li><li><strong>326 行</strong>：输入只让 batch 维度动态，宽高不动态</li><li><strong>331 行</strong>：输出只让 batch 维度动态，宽高不动态</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># ========== exporter.py ==========</span>

<span class="token comment"># ultralytics/engine/exporter.py第323行</span>
<span class="token comment"># output_names = ['output0', 'output1'] if isinstance(self.model, SegmentationModel) else ['output0']</span>
<span class="token comment"># dynamic = self.args.dynamic</span>
<span class="token comment"># if dynamic:</span>
<span class="token comment">#     dynamic = {'images': {0: 'batch', 2: 'height', 3: 'width'}}  # shape(1,3,640,640)</span>
<span class="token comment">#     if isinstance(self.model, SegmentationModel):</span>
<span class="token comment">#         dynamic['output0'] = {0: 'batch', 2: 'anchors'}  # shape(1, 116, 8400)</span>
<span class="token comment">#         dynamic['output1'] = {0: 'batch', 2: 'mask_height', 3: 'mask_width'}  # shape(1,32,160,160)</span>
<span class="token comment">#     elif isinstance(self.model, DetectionModel):</span>
<span class="token comment">#         dynamic['output0'] = {0: 'batch', 2: 'anchors'}  # shape(1, 84, 8400)</span>
<span class="token comment"># 修改为：</span>

output_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">,</span> <span class="token string">'output1'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> SegmentationModel<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span>
dynamic <span class="token operator">=</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>dynamic
<span class="token keyword">if</span> dynamic<span class="token punctuation">:</span>
    dynamic <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'images'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1,3,640,640)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> SegmentationModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'anchors'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1, 116, 8400)</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'mask_height'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'mask_width'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1,32,160,160)</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> DetectionModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1, 84, 8400)</span>
</code></pre> 
<p><strong>2.</strong> <strong>在 ultralytics/nn/modules/head.py 文件中改动一处</strong></p> 
<ul><li><strong>72 行</strong>：添加 <strong>transpose</strong> 节点交换输出的第 2 和第 3 维度</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># ========== head.py ==========</span>

<span class="token comment"># ultralytics/nn/modules/head.py第72行，forward函数</span>
<span class="token comment"># return y if self.export else (y, x)</span>
<span class="token comment"># 修改为：</span>

<span class="token keyword">return</span> y<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
</code></pre> 
<p>以上就是为了适配 tensorRT_Pro 而做出的代码修改，修改好以后，将预训练权重 <strong>yolov8s.pt</strong> 放在 ultralytics-main 主目录下，新建导出文件 <strong>export.py</strong>，内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov8s.pt"</span><span class="token punctuation">)</span>

success <span class="token operator">=</span> model<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"onnx"</span><span class="token punctuation">,</span> dynamic<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> simplify<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>在终端执行如下指令即可完成 onnx 导出：</p> 
<pre><code class="prism language-shell">python export.py
</code></pre> 
<p>导出过程如下图所示：</p> 
<p><img src="https://images2.imgbox.com/78/39/sTeseAcb_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到导出的 pytorch 模型的输入 shape 是 1x3x640x640，输出 shape 是 1x8400x84，符合我们的预期。</p> 
<p>导出成功后会在当前目录下生成 yolov8s.onnx 模型，我们可以使用 <a href="https://netron.app/" rel="nofollow">Netron</a> 可视化工具查看，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/cf/5d/HHkU8ivL_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到输入节点名是 <strong>images</strong>，维度是 batchx3x640x640，保证只有 batch 维度动态，输出节点名是 <strong>output</strong>，维度是 batchxTransposeoutput_dim_1xTransposeoutput_dim_2，保证只有 batch 维度动态，符合 tensorRT_Pro 的格式。</p> 
<p>大家不要看到 Transposeoutput_dim_1 和 Transposeoutput_dim_2 就认为这也是动态的，其实输出节点的维度是根据输入节点的维度和模型的结构生成的，而额外的维度 Transposeoutput_dim_1 和 Transposeoutput_dim_2 可能是由模型结构中某些操作决定的，如通道数变换（Transpose）操作的输出维度，而不是由动态维度决定的。因此，通常情况下，这些维度是静态的，不会在推理时改变。</p> 
<h4><a id="2_YOLOv8_584"></a>2. YOLOv8预处理</h4> 
<blockquote> 
 <p>之前有提到过 YOLOv8 预处理部分和 YOLOv5 实现一模一样，因此我们在 tensorRT_Pro 中 YOLOv8 模型的预处理可以直接使用 YOLOv5 的预处理。</p> 
</blockquote> 
<p>tensorRT_Pro 中预处理的代码如下：</p> 
<pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">warp_affine_bilinear_and_normalize_plane_kernel</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> src_line_size<span class="token punctuation">,</span> <span class="token keyword">int</span> src_width<span class="token punctuation">,</span> <span class="token keyword">int</span> src_height<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> dst_width<span class="token punctuation">,</span> <span class="token keyword">int</span> dst_height<span class="token punctuation">,</span> 
	<span class="token keyword">uint8_t</span> const_value_st<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> warp_affine_matrix_2_3<span class="token punctuation">,</span> Norm norm<span class="token punctuation">,</span> <span class="token keyword">int</span> edge<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token keyword">int</span> position <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> edge<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token keyword">float</span> m_x1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_y1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_z1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_x2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_y2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_z2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> dx      <span class="token operator">=</span> position <span class="token operator">%</span> dst_width<span class="token punctuation">;</span>
	<span class="token keyword">int</span> dy      <span class="token operator">=</span> position <span class="token operator">/</span> dst_width<span class="token punctuation">;</span>
	<span class="token keyword">float</span> src_x <span class="token operator">=</span> m_x1 <span class="token operator">*</span> dx <span class="token operator">+</span> m_y1 <span class="token operator">*</span> dy <span class="token operator">+</span> m_z1<span class="token punctuation">;</span>
	<span class="token keyword">float</span> src_y <span class="token operator">=</span> m_x2 <span class="token operator">*</span> dx <span class="token operator">+</span> m_y2 <span class="token operator">*</span> dy <span class="token operator">+</span> m_z2<span class="token punctuation">;</span>
	<span class="token keyword">float</span> c0<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>src_x <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> src_x <span class="token operator">&gt;=</span> src_width <span class="token operator">||</span> src_y <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> src_y <span class="token operator">&gt;=</span> src_height<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// out of range</span>
		c0 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> y_low <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>src_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x_low <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>src_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> y_high <span class="token operator">=</span> y_low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x_high <span class="token operator">=</span> x_low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

		<span class="token keyword">uint8_t</span> const_value<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>const_value_st<span class="token punctuation">,</span> const_value_st<span class="token punctuation">,</span> const_value_st<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> ly    <span class="token operator">=</span> src_y <span class="token operator">-</span> y_low<span class="token punctuation">;</span>
		<span class="token keyword">float</span> lx    <span class="token operator">=</span> src_x <span class="token operator">-</span> x_low<span class="token punctuation">;</span>
		<span class="token keyword">float</span> hy    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> ly<span class="token punctuation">;</span>
		<span class="token keyword">float</span> hx    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> lx<span class="token punctuation">;</span>
		<span class="token keyword">float</span> w1    <span class="token operator">=</span> hy <span class="token operator">*</span> hx<span class="token punctuation">,</span> w2 <span class="token operator">=</span> hy <span class="token operator">*</span> lx<span class="token punctuation">,</span> w3 <span class="token operator">=</span> ly <span class="token operator">*</span> hx<span class="token punctuation">,</span> w4 <span class="token operator">=</span> ly <span class="token operator">*</span> lx<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v1 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v2 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v3 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v4 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>y_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				v1 <span class="token operator">=</span> src <span class="token operator">+</span> y_low <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_low <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_high <span class="token operator">&lt;</span> src_width<span class="token punctuation">)</span>
				v2 <span class="token operator">=</span> src <span class="token operator">+</span> y_low <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_high <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>y_high <span class="token operator">&lt;</span> src_height<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				v3 <span class="token operator">=</span> src <span class="token operator">+</span> y_high <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_low <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_high <span class="token operator">&lt;</span> src_width<span class="token punctuation">)</span>
				v4 <span class="token operator">=</span> src <span class="token operator">+</span> y_high <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_high <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// same to opencv</span>
		c0 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>channel_type <span class="token operator">==</span> ChannelType<span class="token double-colon punctuation">::</span>Invert<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">float</span> t <span class="token operator">=</span> c2<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> c0<span class="token punctuation">;</span>  c0 <span class="token operator">=</span> t<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>type <span class="token operator">==</span> NormType<span class="token double-colon punctuation">::</span>MeanStd<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		c0 <span class="token operator">=</span> <span class="token punctuation">(</span>c0 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> <span class="token punctuation">(</span>c1 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>type <span class="token operator">==</span> NormType<span class="token double-colon punctuation">::</span>AlphaBeta<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		c0 <span class="token operator">=</span> c0 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> c1 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> c2 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> area <span class="token operator">=</span> dst_width <span class="token operator">*</span> dst_height<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c0 <span class="token operator">=</span> dst <span class="token operator">+</span> dy <span class="token operator">*</span> dst_width <span class="token operator">+</span> dx<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c1 <span class="token operator">=</span> pdst_c0 <span class="token operator">+</span> area<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c2 <span class="token operator">=</span> pdst_c1 <span class="token operator">+</span> area<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c0 <span class="token operator">=</span> c0<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c1 <span class="token operator">=</span> c1<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c2 <span class="token operator">=</span> c2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于预处理部分其实就是调用了上述 CUDA 核函数来实现 warpAffine，由于在 CUDA 中我们是对每个像素进行操作，因此非常容易实现 BGR → RGB，/255.0 等操作。关于代码的具体分析可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a>，这边不再赘述。</p> 
<h4><a id="3_YOLOv8_680"></a>3. YOLOv8后处理</h4> 
<blockquote> 
 <p>之前有提到过 YOLOv8 后处理部分和 YOLOv5 基本相似，但由于 YOLOv8 是基于 anchor-free 的，因此对于 decode 解码部分我们需要进行简单调整，代码可参考：<a href="https://github.com/shouxieai/infer/blob/main/src/yolo.cu#L129">yolo.cu#L129</a></p> 
</blockquote> 
<p>因此我们不难写出 YOLOv8 的 decode 解码部分的实现代码，如下所示：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> __global__ <span class="token keyword">void</span> <span class="token function">decode_kernel_v8</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">*</span>predict<span class="token punctuation">,</span> <span class="token keyword">int</span> num_bboxes<span class="token punctuation">,</span> <span class="token keyword">int</span> num_classes<span class="token punctuation">,</span> <span class="token keyword">float</span> confidence_threshold<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> invert_affine_matrix<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> parray<span class="token punctuation">,</span> <span class="token keyword">int</span> MAX_IMAGE_BOXES<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">int</span> position <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> num_bboxes<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span><span class="token operator">*</span> pitem            <span class="token operator">=</span> predict <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span> <span class="token operator">*</span> position<span class="token punctuation">;</span>
    <span class="token keyword">float</span><span class="token operator">*</span> class_confidence <span class="token operator">=</span> pitem <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> confidence        <span class="token operator">=</span> <span class="token operator">*</span>class_confidence<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> label               <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_classes<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token operator">++</span>class_confidence<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>class_confidence <span class="token operator">&gt;</span> confidence<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            confidence <span class="token operator">=</span> <span class="token operator">*</span>class_confidence<span class="token punctuation">;</span>
            label      <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>confidence <span class="token operator">&lt;</span> confidence_threshold<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span>parray<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> MAX_IMAGE_BOXES<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> cx         <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cy         <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> width      <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> height     <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> left   <span class="token operator">=</span> cx <span class="token operator">-</span> width  <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> top    <span class="token operator">=</span> cy <span class="token operator">-</span> height <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> right  <span class="token operator">=</span> cx <span class="token operator">+</span> width  <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> bottom <span class="token operator">=</span> cy <span class="token operator">+</span> height <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token function">affine_project</span><span class="token punctuation">(</span>invert_affine_matrix<span class="token punctuation">,</span> left<span class="token punctuation">,</span>  top<span class="token punctuation">,</span>    <span class="token operator">&amp;</span>left<span class="token punctuation">,</span>  <span class="token operator">&amp;</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">affine_project</span><span class="token punctuation">(</span>invert_affine_matrix<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> <span class="token operator">&amp;</span>right<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> <span class="token operator">*</span>pout_item <span class="token operator">=</span> parray <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> index <span class="token operator">*</span> NUM_BOX_ELEMENT<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> left<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> top<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> bottom<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> confidence<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> label<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 1 = keep, 0 = ignore</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于 decode 的具体实现其实就是启动多个线程，每个线程处理一个框的解码，我们会通过仿射变换逆矩阵 IM 将坐标映射回原图上，关于 decode 代码的详细分析可参考 <a href="https://blog.csdn.net/qq_40672115/article/details/129837469">infer源码阅读之yolo.cu</a>，这边不再赘述，另外关于 NMS 部分的实现无需修改，其具体实现可以参考：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo/yolo_decode.cu#L81">yolo_decode.cu#L81</a></p> 
<h4><a id="4_YOLOv8_734"></a>4. YOLOv8推理</h4> 
<blockquote> 
 <p>通过上面对 YOLOv8 的预处理和后处理分析之后，整个推理过程就显而易见了。C++ 上 YOLOv8 的预处理部分可直接沿用 YOLOv5 的预处理，后处理中的 decode 解码部分需要简单修改，NMS 部分无需修改。</p> 
</blockquote> 
<p>我们在终端执行如下指令即可完成推理（<strong>注意！完整流程博主会在后续内容介绍，这边只是简单演示</strong>）</p> 
<pre><code class="prism language-shell"><span class="token function">make</span> yolo
</code></pre> 
<p>编译图解如下所示：</p> 
<p><img src="https://images2.imgbox.com/fa/ee/y3KtlzC2_o.png" alt="在这里插入图片描述"></p> 
<p>推理结果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/d1/e3/ULRFG68o_o.jpg" alt="在这里插入图片描述"></p> 
<p>至此，我们在 C++ 上面完成了 YOLOv8 的整个推理过程，下面我们将完整的走一遍流程。</p> 
<h3><a id="YOLOv8_756"></a>三、YOLOv8部署</h3> 
<blockquote> 
 <p>博主新建了一个仓库 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">tensorRT_Pro-YOLOv8</a>，该仓库基于 <a href="https://github.com/shouxieai/tensorRT_Pro">shouxieai/tensorRT_Pro</a>，并进行了调整以支持 YOLOv8 的各项任务，目前已支持分类、检测、分割、姿态点估计任务。</p> 
 <p>下面我们就来具体看看如何利用 tensorRT_Pro-YOLOv8 这个 repo 完成 YOLOv8 的推理。</p> 
</blockquote> 
<h4><a id="1__762"></a>1. 源码下载</h4> 
<p>tensorRT_Pro-YOLOv8 的代码可以直接从 GitHub 官网上下载，源码下载地址是 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a>，Linux 下代码克隆指令如下：</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8.git
</code></pre> 
<p>也可手动点击下载，点击右上角的 <code>Code</code> 按键，将代码下载下来。至此整个项目就已经准备好了。也可以点击 <a href="https://pan.baidu.com/s/1yn8rdGVruCkhfHuVhTr8_w" rel="nofollow">here</a> 下载博主准备好的源代码（<strong>注意代码下载于 2023/11/7 日，若有改动请参考最新</strong>）</p> 
<h4><a id="2__772"></a>2. 环境配置</h4> 
<blockquote> 
 <p>需要使用的软件环境有 <strong>TensorRT、CUDA、cuDNN、OpenCV、Protobuf</strong>，所有软件环境的安装可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/130255299">Ubuntu20.04软件安装大全</a>，这里不再赘述，需要各位看官自行配置好相关环境😄，外网访问较慢，这里提供下博主安装过程中的软件安装包下载链接 <a href="https://pan.baidu.com/s/1XPe6xd6q1TLDMlVO-84KXA" rel="nofollow">Baidu Drive【pwd:yolo】</a>🚀🚀🚀</p> 
 <p>tensorRT_Pro-YOLOv8 提供 CMakeLists.txt 和 Makefile 两种方式编译，<strong>二者选一即可</strong></p> 
</blockquote> 
<h5><a id="21_CMakeListstxt_778"></a>2.1 配置CMakeLists.txt</h5> 
<p>主要修改五处</p> 
<p><strong>1.</strong> 修改第 13 行，修改 OpenCV 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>OpenCV_DIR   <span class="token string">"/usr/local/include/opencv4"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>2.</strong> 修改第 15 行，修改 CUDA 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDA_TOOLKIT_ROOT_DIR     <span class="token string">"/usr/local/cuda-11.6"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>3.</strong> 修改第 16 行，修改 cuDNN 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDNN_DIR    <span class="token string">"/usr/local/cudnn8.4.0.27-cuda11.6"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>4.</strong> 修改第 17 行，修改 tensorRT 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>TENSORRT_DIR <span class="token string">"/opt/TensorRT-8.4.1.5"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>5.</strong> 修改第 20 行，修改 protobuf 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>PROTOBUF_DIR <span class="token string">"/home/jarvis/protobuf"</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="22_Makefile_812"></a>2.2 配置Makefile</h5> 
<p>主要修改五处</p> 
<p><strong>1.</strong> 修改第 4 行，修改 protobuf 路径</p> 
<pre><code class="prism language-cpp">lean_protobuf  <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>home<span class="token operator">/</span>jarvis<span class="token operator">/</span>protobuf
</code></pre> 
<p><strong>2.</strong> 修改第 5 行，修改 tensorRT 路径</p> 
<pre><code class="prism language-cpp">lean_tensor_rt <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>TensorRT<span class="token operator">-</span><span class="token number">8.4</span><span class="token punctuation">.</span><span class="token number">1.5</span>
</code></pre> 
<p><strong>3.</strong> 修改第 6 行，修改 cuDNN 路径</p> 
<pre><code class="prism language-cpp">lean_cudnn     <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cudnn8<span class="token punctuation">.</span><span class="token number">4.0</span><span class="token punctuation">.</span><span class="token number">27</span><span class="token operator">-</span>cuda11<span class="token punctuation">.</span><span class="token number">6</span>
</code></pre> 
<p><strong>4.</strong> 修改第 7 行，修改 OpenCV 路径</p> 
<pre><code class="prism language-cpp">lean_opencv    <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local
</code></pre> 
<p><strong>5.</strong> 修改第 8 行，修改 CUDA 路径</p> 
<pre><code class="prism language-cpp">lean_cuda      <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda<span class="token operator">-</span><span class="token number">11.6</span>
</code></pre> 
<h4><a id="3_ONNX_846"></a>3. ONNX导出</h4> 
<p>导出细节可以查看之前的内容，这边不再赘述。记得将导出的 ONNX 模型放在 tensorRT_Pro-YOLOv8/workspace 文件夹下。</p> 
<h4><a id="4__850"></a>4. 源码修改</h4> 
<blockquote> 
 <p>如果你想推理自己训练的模型还需要修改下源代码，YOLOv8 模型的推理代码主要在 <strong>app_yolo.cpp</strong> 文件中，我们就只需要修改这一个文件中的内容即可，源码修改较简单主要有以下几点：</p> 
</blockquote> 
<ul><li><strong>1.</strong> <strong>app_yolo.cpp 277行，“yolov8s” 修改为你导出的 ONNX 模型名</strong></li><li><strong>2.</strong> <strong>app_yolo.cpp 11行， 将 cocolabels 数组中的类别名称修改为你训练的类别</strong></li></ul> 
<p>具体修改示例如下：</p> 
<pre><code class="prism language-cpp"><span class="token function">test</span><span class="token punctuation">(</span>Yolo<span class="token double-colon punctuation">::</span>Type<span class="token double-colon punctuation">::</span>V8<span class="token punctuation">,</span> TRT<span class="token double-colon punctuation">::</span>Mode<span class="token double-colon punctuation">::</span>FP32<span class="token punctuation">,</span> <span class="token string">"best"</span><span class="token punctuation">)</span>	<span class="token comment">// 修改1 277行"yolov8s"改成"best"</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cocolabels<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"have_mask"</span><span class="token punctuation">,</span> <span class="token string">"no_mask"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">// 修改2 11行修改检测类别，为自训练模型的类别名称</span>
</code></pre> 
<h4><a id="5__865"></a>5. 运行</h4> 
<p>OK！源码修改好了，Makefile 编译文件也搞定了，ONNX 模型也准备好了，现在可以编译运行了，直接在终端执行如下指令即可：</p> 
<pre><code class="prism language-shell"><span class="token function">make</span> yolo
</code></pre> 
<p>编译过程如下所示：</p> 
<p><img src="https://images2.imgbox.com/69/80/emhOwOCt_o.png" alt="在这里插入图片描述"></p> 
<p>编译运行成功后在 workspace 文件夹下会生成 engine 文件 <strong>yolov8s.FP32.trtmodel</strong> 用于模型推理，同时它还会生成 <strong>yolov8s_YoloV8_FP32_result</strong> 文件夹，该文件夹下保存了推理的图片。</p> 
<p>模型推理效果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/d0/7d/LVzBv614_o.jpg" alt="在这里插入图片描述"></p> 
<p>OK！以上就是使用 tensorRT_Pro-YOLOv8 推理 YOLOv8 的大致流程，若有问题，欢迎各位看官批评指正。</p> 
<h3><a id="_887"></a>结语</h3> 
<blockquote> 
 <p>博主在这里针对 YOLOv8 的预处理和后处理做了简单分析，同时与大家分享了 C++ 上的实现流程，目的是帮大家理清思路，更好的完成后续的部署工作😄。感谢各位看到最后，创作不易，读后有收获的看官请帮忙点个👍⭐️</p> 
 <p>最后大家如果觉得 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">tensorRT_Pro-YOLOv8</a> 这个 repo 对你有帮助的话，不妨点个 ⭐️ 支持一波，这对博主来说非常重要，感谢各位🙏。</p> 
</blockquote> 
<h3><a id="_893"></a>下载链接</h3> 
<ul><li><a href="https://pan.baidu.com/s/1XPe6xd6q1TLDMlVO-84KXA" rel="nofollow">软件安装包下载链接【提取码:yolo】</a>🚀🚀🚀</li><li><a href="https://pan.baidu.com/s/1yn8rdGVruCkhfHuVhTr8_w" rel="nofollow">源代码、权重下载链接【提取码:yolo】</a></li></ul> 
<h3><a id="_898"></a>参考</h3> 
<ul><li><a href="https://github.com/shouxieai/infer">https://github.com/shouxieai/infer</a></li><li><a href="https://github.com/ultralytics/ultralytics">https://github.com/ultralytics/ultralytics</a></li><li><a href="https://github.com/shouxieai/tensorRT_Pro">https://github.com/shouxieai/tensorRT_Pro</a></li><li><a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a></li><li><a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a8ca09a43ad10206ea39ab48f2d73226/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">阿里云服务器购买多少钱一年？2024年最新阿里云活动价格汇总</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8c8d89d1d5ce54ac92f9d035e56f67f3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">软件系统测试怎么进行?对软件产品起到什么作用?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>