<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>python 接口自动化unittest&#43;DingtalkChatbot钉钉机器人消息封装 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="python 接口自动化unittest&#43;DingtalkChatbot钉钉机器人消息封装" />
<meta property="og:description" content="python 接口自动化unittest&#43;DingtalkChatbot机器人消息封装 安装DingtalkChatbot： pip install DingtalkChatbot
钉钉配置机器人：
智能群助手
给机器人取一个名字～
webhook需要保存好，需要传入钉钉DingtalkChatbot()方法内
自定义关键词，这里需要注意一下，自定义关键词内的文案在msg内一定要有，否则无法触发机器人报警
钉钉模块内有很多种类型的消息场景，我的目的是接口自动化巡检，所以只需要消息场景就可以，其他的场景感兴趣的可以查一下场景字段参数～
把自己想要的日志内容写在msg内，并且单独封装一个方法获取需要的消息参数内容
# WebHook地址 from dingtalkchatbot.chatbot import DingtalkChatbot class DingDing: def __init__(self): self.yhn = &#34;9z7_66n6cmbqy&#34; self.webhook = &#34;https://oapi.dingtalk.com/robot/send?access_token=6e3cc2451e89506e630b5be62de31ef28501a32bd2ef1181aaaa968527624b9b&#34; def run_error(self, *args): xiaoding = DingtalkChatbot(self.webhook) xiaoding.send_text( msg=f&#39;监测预警，测试用例数量：{args[0]}，用例异常数量: {args[1]}&#39; f&#39;\n测试用例名称：{args[2]}\n日志内容：{args[3]}&#39; f&#39;\n链接地址：{args[4]} 请注意及时处理！&#39;, at_dingtalk_ids=[self.yhn], is_at_all=False ) def run_normal(self, *args): xiaoding = DingtalkChatbot(self.webhook) xiaoding.send_text( msg=f&#39;监测预警，接口自动化case执行完毕\n测试用例数量：{args[0]}，用例异常数量: {args[1]}&#39; f&#39;\n测试报告地址：{args[2]} 请关注～&#39;, at_dingtalk_ids=[self.yhn], is_at_all=False ) def run_trigger(self, list_dict, if_print=True): &#34;&#34;&#34; 触发钉钉机器人 :param list_dict: case_list列表 :param if_print: 是否需要过滤测试通过的case True为是不会触发机器人 False不会过滤 :return: &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f4b16db96a3cb6a56e77bf1ec40ac0bb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-18T11:53:17+08:00" />
<meta property="article:modified_time" content="2022-02-18T11:53:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">python 接口自动化unittest&#43;DingtalkChatbot钉钉机器人消息封装</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>python 接口自动化unittest+DingtalkChatbot机器人消息封装</h4> 
 <br> 安装DingtalkChatbot： 
</div> 
<p></p> 
<blockquote> 
 <p>pip install DingtalkChatbot</p> 
</blockquote> 
<p>钉钉配置机器人：<br> 智能群助手<br> <img src="https://images2.imgbox.com/37/fc/HYmuF3hV_o.png" alt="在这里插入图片描述"><br> 给机器人取一个名字～<br> webhook需要保存好，需要传入钉钉DingtalkChatbot()方法内<br> <img src="https://images2.imgbox.com/60/56/KrH9YeJi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/38/ae/EwxRmmdG_o.png" alt="在这里插入图片描述"><br> 自定义关键词，这里需要注意一下，自定义关键词内的文案在msg内一定要有，否则无法触发机器人报警<br> <img src="https://images2.imgbox.com/2a/f8/34kkkgYp_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d1/ed/oqYRivEn_o.png" alt="在这里插入图片描述"></p> 
<p>钉钉模块内有很多种类型的消息场景，我的目的是接口自动化巡检，所以只需要消息场景就可以，其他的场景感兴趣的可以查一下场景字段参数～<br> <img src="https://images2.imgbox.com/21/1c/keqhLJSK_o.png" alt="在这里插入图片描述"><br> 把自己想要的日志内容写在msg内，并且单独封装一个方法获取需要的消息参数内容</p> 
<pre><code class="prism language-bash"><span class="token comment"># WebHook地址</span>
from dingtalkchatbot.chatbot <span class="token function">import</span> DingtalkChatbot


class DingDing:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        self.yhn <span class="token operator">=</span> <span class="token string">"9z7_66n6cmbqy"</span>
        self.webhook <span class="token operator">=</span> <span class="token string">"https://oapi.dingtalk.com/robot/send?access_token=6e3cc2451e89506e630b5be62de31ef28501a32bd2ef1181aaaa968527624b9b"</span>
        
    def run_error<span class="token punctuation">(</span>self, *args<span class="token punctuation">)</span>:
        xiaoding <span class="token operator">=</span> DingtalkChatbot<span class="token punctuation">(</span>self.webhook<span class="token punctuation">)</span>
        xiaoding.send_text<span class="token punctuation">(</span>
            <span class="token assign-left variable">msg</span><span class="token operator">=</span>f<span class="token string">'监测预警，测试用例数量：{args[0]}，用例异常数量: {args[1]}'</span>
                f<span class="token string">'<span class="token entity" title="\n">\n</span>测试用例名称：{args[2]}<span class="token entity" title="\n">\n</span>日志内容：{args[3]}'</span>
                f<span class="token string">'<span class="token entity" title="\n">\n</span>链接地址：{args[4]} 请注意及时处理！'</span>,
            <span class="token assign-left variable">at_dingtalk_ids</span><span class="token operator">=</span><span class="token punctuation">[</span>self.yhn<span class="token punctuation">]</span>,
            <span class="token assign-left variable">is_at_all</span><span class="token operator">=</span>False
        <span class="token punctuation">)</span>

    def run_normal<span class="token punctuation">(</span>self, *args<span class="token punctuation">)</span>:
        xiaoding <span class="token operator">=</span> DingtalkChatbot<span class="token punctuation">(</span>self.webhook<span class="token punctuation">)</span>
        xiaoding.send_text<span class="token punctuation">(</span>
            <span class="token assign-left variable">msg</span><span class="token operator">=</span>f<span class="token string">'监测预警，接口自动化case执行完毕<span class="token entity" title="\n">\n</span>测试用例数量：{args[0]}，用例异常数量: {args[1]}'</span>
                f<span class="token string">'<span class="token entity" title="\n">\n</span>测试报告地址：{args[2]} 请关注～'</span>,
            <span class="token assign-left variable">at_dingtalk_ids</span><span class="token operator">=</span><span class="token punctuation">[</span>self.yhn<span class="token punctuation">]</span>,
            <span class="token assign-left variable">is_at_all</span><span class="token operator">=</span>False
        <span class="token punctuation">)</span>

    def run_trigger<span class="token punctuation">(</span>self, list_dict, <span class="token assign-left variable">if_print</span><span class="token operator">=</span>True<span class="token punctuation">)</span>:
        <span class="token string">""</span>"
        触发钉钉机器人
        :param list_dict: case_list列表
        :param if_print: 是否需要过滤测试通过的case True为是不会触发机器人 False不会过滤
        :return:
        <span class="token string">""</span>"
        <span class="token keyword">for</span> <span class="token for-or-select variable">dict_list</span> <span class="token keyword">in</span> list_dict:
            kwargs <span class="token operator">=</span> dict_list
            errorCount <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">"error_count"</span><span class="token punctuation">]</span>
            testRun <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">"testRun"</span><span class="token punctuation">]</span>
            case_name <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">"case_name"</span><span class="token punctuation">]</span>
            error <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span>
            fail_count <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">"failure"</span><span class="token punctuation">]</span>
            count <span class="token operator">=</span> errorCount + fail_count
            <span class="token comment"># todo 缺少报告地址获取</span>
            report_url <span class="token operator">=</span> <span class="token string">"完善中，后期替换～"</span>
            <span class="token keyword">if</span> count <span class="token operator">!=</span> <span class="token number">0</span>:
                <span class="token keyword">if</span> error <span class="token operator">!=</span> <span class="token string">""</span><span class="token builtin class-name">:</span>
                    self.run_error<span class="token punctuation">(</span>testRun, count, case_name, error, report_url<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> not if_print:
                    error <span class="token operator">=</span> <span class="token string">"当前case执行通过"</span>
                    self.run_error<span class="token punctuation">(</span>testRun, errorCount, case_name, error, report_url<span class="token punctuation">)</span>
            else:
                <span class="token builtin class-name">return</span> self.run_normal<span class="token punctuation">(</span>testRun, errorCount, report_url<span class="token punctuation">)</span>
</code></pre> 
<p>书接上回，上一章写的是html报告与unittest执行方法的封装，我的目的是获取到一些报告内的用例名称/错误参数/执行用例数量/与用例异常数量，通过机器人发送到群内，所以需要取出数据，然后传给钉钉机器人方法</p> 
<p>下面是接着上一章的两个方法获取下来result参数内容，然后通过字典的形式储存，因为是多条case，所以每执行一条需要在list内储存一份，这样每条case的数据就都有了，然后再通过封装好的</p> 
<blockquote> 
 <p>DingDing().run_trigger(result_list_dict, True)</p> 
</blockquote> 
<p>钉钉的方法把参数带入，这里需要注意的一点就是，error异常与fail失败是分开的数量，所以要分别储存，然后相加数量来判断是否有异常case～</p> 
<pre><code class="prism language-bash">def run_dingDing<span class="token punctuation">(</span>way, run_list, <span class="token assign-left variable">test_py</span><span class="token operator">=</span>None<span class="token punctuation">)</span>:
    result_list_dict <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    global result
    <span class="token keyword">if</span> way <span class="token operator">==</span> <span class="token number">1</span>:
        result <span class="token operator">=</span> run_py<span class="token punctuation">(</span>run_list<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> way <span class="token operator">==</span> <span class="token number">2</span>:
        result <span class="token operator">=</span> run_case<span class="token punctuation">(</span>test_py, run_list<span class="token punctuation">)</span>
    error_count <span class="token operator">=</span> result.error_count
    testRun <span class="token operator">=</span> result.testsRun
    failure <span class="token operator">=</span> result.failure_count
    result_list <span class="token operator">=</span> list<span class="token punctuation">(</span>result.result<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">rel</span> <span class="token keyword">in</span> result_list:
        dict_result <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"error_count"</span><span class="token builtin class-name">:</span> error_count,
            <span class="token string">"testRun"</span><span class="token builtin class-name">:</span> testRun,
            <span class="token string">"failure"</span><span class="token builtin class-name">:</span> failure,
            <span class="token string">"case_doc"</span><span class="token builtin class-name">:</span> rel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>._testMethodDoc,
            <span class="token string">"case_name"</span><span class="token builtin class-name">:</span> rel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>._testMethodName,
            <span class="token string">"error"</span><span class="token builtin class-name">:</span> rel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        result_list_dict.append<span class="token punctuation">(</span>dict_result<span class="token punctuation">)</span>
    <span class="token comment">#     print(f"dict_result{dict_result}")</span>
    <span class="token comment"># print(f"result_list_dict{result_list_dict}")</span>
    DingDing<span class="token punctuation">(</span><span class="token punctuation">)</span>.run_trigger<span class="token punctuation">(</span>result_list_dict, True<span class="token punctuation">)</span>
    <span class="token builtin class-name">return</span> result_list_dict


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token builtin class-name">:</span>
    file_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"test_shiyan.py"</span>, <span class="token string">"MeetSpringFestival.py"</span><span class="token punctuation">]</span>
    <span class="token comment"># run_py(file_list)</span>
    case_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"test_case_01"</span>, <span class="token string">"test_case_02"</span><span class="token punctuation">]</span>
    <span class="token comment"># run_case(test_sample, case_list)</span>
    dingDing_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span>, case_list, test_sample<span class="token punctuation">]</span>
    run_dingDing<span class="token punctuation">(</span>*dingDing_list<span class="token punctuation">)</span>
</code></pre> 
<p>下期会加入定时任务，定时执行接口自动化巡检触发钉钉～</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/acdeb27190b01c03b1721e938bca8a55/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">modbus协议使用【android串口通信】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8a1d85278973753902e568a635fbb7ce/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Springboot&#43;Websocket&#43;JWT实现的即时通讯模块</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>