<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2023年电赛---运动目标控制与自动追踪系统（E题）发挥题思路 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2023年电赛---运动目标控制与自动追踪系统（E题）发挥题思路" />
<meta property="og:description" content="如果有嵌入式企业需要招聘校园大使，湖南区域的日常实习，任何区域的暑假Linux驱动实习岗位，可C站直接私聊，或者邮件：zhangyixu02@gmail.com，此消息至2025年1月1日前均有效
前言 （1）因为博客编辑字数超过1W字会导致MD编辑器非常卡顿。所以我将发挥题和基础题的思路拆开了。
（2）更新日记：
&lt;1&gt;2023年8月4日，9点20分。分离发挥题思路和基础题思路，增加了博主Huiyeee整体代码，增加关于红点被黑带吸收问题的调试方法
&lt;2&gt;2023年8月4日，15点55分。回答追小球代码中的目标值是那个。
关于红点被黑带吸收问题 让IDE上出现红点 （1）很多人反馈，红点被黑色矩形框吸收了，识别不到。
（2）这边推荐的调试办法如下：
&lt;1&gt;首要目的是让PC端的IDE上人们肉眼能够看到红色激光。所以外面要适当调整下面初始化部分代码。
&lt;2&gt;我们可以将RGB565改成GRAYSCALE的灰度图。
&lt;3&gt;适当提高图像分辨率，将QQVGA改成其他图像画质。
&lt;4&gt;设置亮度，因为是从OpenART移植过来的，所以亮度不能是3000。使用OpenMV的同学请注意，应该是-3到&#43;3.
&lt;5&gt;曝光度可以按照另外一位博主的来。通过调整曝光度，可以控制图像的明暗程度，从而创造出不同的视觉效果。我们这里没有使用sensor.set_auto_exposure()函数设置曝光度，所以是默认打开了的。你们可以看看另外一位博主的思路和调整。
&lt;6&gt;我们图像识别要关闭白平衡和自增益。但是如果调节出来没结果。可以尝试打开看看有木有优化
# 初始化摄像头 sensor.reset() sensor.set_pixformat(sensor.RGB565) # 设置图像色彩格式为RGB565格式 sensor.set_framesize(sensor.QQVGA) # 设置图像大小为160*120 sensor.set_auto_whitebal(True) # 设置自动白平衡 sensor.set_brightness(3000) # 设置亮度为3000 sensor.skip_frames(time = 20) # 跳过帧 （3）注意，这一阶段只需要调整摄像头的初始化！！！PC端IDE出现了红色斑点再开始处理！！！
白平衡和自增益的作用 （1）关闭白平衡和自增益可能适用于以下场景：
&lt;1&gt;保持色彩一致性：在某些图像识别应用中，特别是涉及色彩信息重要性较高的场景，关闭白平衡可以保持图像中的色彩一致性。白平衡会根据不同光源调整图像颜色，这可能导致相同对象在不同光照条件下的颜色出现差异，影响识别的准确性。
&lt;2&gt;特定光照条件下的优化：在一些特殊环境中，如低光照条件或强烈光线照射的情况下，关闭自增益可以避免图像过度曝光或欠曝光。这样做可以保留图像中更多细节，有助于图像识别算法更好地处理图像。
&lt;3&gt;原始数据分析：在某些图像分析应用中，关闭白平衡和自增益可以使用原始的传感器数据进行分析，而不受相机的颜色处理和亮度调整影响。这可以提供更纯粹、更原始的数据，有助于一些特定图像处理和识别算法的优化。
（2）需要注意的是，关闭白平衡和自增益也可能导致一些挑战，比如图像中的颜色信息可能会出现较大的变化，而且在某些场景下可能需要更复杂的图像处理算法来应对不同光照条件下的挑战。因此，在图像识别应用中是否关闭白平衡和自增益需要根据具体的情况和应用场景进行权衡和决策。
发挥题思路 第一问 — 追踪 （1）我个人认为这个必须上PID了。我个人认为这个题目和OpenMV的追小球云台代码类似。
（2）基础题目我认为一个OpenMV就可以完成。而发挥题目需要两个OpenMV。这两个OpenMV一个放红色激光笔，一个放绿色激光笔。
（3）各位可以综合追小球云台的代码，以及我下面讲的：关于C站那位博主代码的注意事项 部分。
（4）追踪的绿色激光笔建议。
&lt;1&gt;变成灰度图，这样可以消除其他颜色的干扰，只观察红色。然后追踪。
&lt;2&gt;提高分辨率，较高的分辨率，能够提供更好的效果。
&lt;3&gt;使用多组颜色阈值，就像OpenMV多颜色识别详解的代码那样。让识别的颜色阈值变成多组。提高分辨效果。
第二问 — 追踪和走基础题3，4问 如果基础题做出来了，以及发挥题的追踪做出来了。那么就直接用基础题的红色激光笔走，然后发挥题追踪。这个和上面的代码应该是差不多的。
第三问 — 暂停键 这个我还是建议自己焊接一个按键，并联一个104的电容，进行硬件方面的按键消抖。然后自己写逻辑代码。
main.py （1）以下为官方的追小球云台代码，我增加了中文注释。
（2）因为GitHub是在外网，所以我直接复制过来了。但是总是有一些网友，硬要官方的GitHub链接。我也贴到了前言部分。
代码 import sensor, image, time from pid import PID from pyb import Servo #从内置pyb导入servo类，也就是舵机控制类 pan_servo=Servo(1) #定义两个舵机，对应P7引脚 tilt_servo=Servo(2) #定义两个舵机，对应P8引脚 pan_servo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a2991d5afcad00302866d1fefc9ff59b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-02T12:23:56+08:00" />
<meta property="article:modified_time" content="2023-09-02T12:23:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2023年电赛---运动目标控制与自动追踪系统（E题）发挥题思路</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><mark>如果有嵌入式企业需要招聘校园大使，湖南区域的日常实习，任何区域的暑假Linux驱动实习岗位，可C站直接私聊，或者邮件：zhangyixu02@gmail.com，此消息至2025年1月1日前均有效</mark></p> 
<h2><a id="_1"></a>前言</h2> 
<blockquote> 
 <p>（1）因为博客编辑字数超过1W字会导致MD编辑器非常卡顿。所以我将发挥题和基础题的思路拆开了。<br> （2）更新日记：<br> &lt;1&gt;2023年8月4日，9点20分。分离发挥题思路和基础题思路，增加了博主Huiyeee整体代码，增加关于红点被黑带吸收问题的调试方法<br> &lt;2&gt;2023年8月4日，15点55分。回答追小球代码中的目标值是那个。</p> 
</blockquote> 
<h2><a id="_7"></a>关于红点被黑带吸收问题</h2> 
<h3><a id="IDE_8"></a>让IDE上出现红点</h3> 
<blockquote> 
 <p>（1）很多人反馈，红点被黑色矩形框吸收了，识别不到。<br> （2）这边推荐的调试办法如下：<br> &lt;1&gt;首要目的是让PC端的IDE上人们肉眼能够看到红色激光。所以外面要适当调整下面初始化部分代码。<br> &lt;2&gt;我们可以将RGB565改成GRAYSCALE的灰度图。<br> &lt;3&gt;适当提高图像分辨率，将QQVGA改成其他图像画质。<br> &lt;4&gt;设置亮度，因为是从OpenART移植过来的，所以亮度不能是3000。使用OpenMV的同学请注意，应该是-3到+3.</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ae/bb/GArGSN5b_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>&lt;5&gt;曝光度可以按照另外一位博主的来。通过调整曝光度，可以控制图像的明暗程度，从而创造出不同的视觉效果。我们这里没有使用sensor.set_auto_exposure()函数设置曝光度，所以是默认打开了的。你们可以看看另外一位博主的思路和调整。<br> &lt;6&gt;我们图像识别要关闭白平衡和自增益。但是如果调节出来没结果。可以尝试打开看看有木有优化</p> 
</blockquote> 
<pre><code class="prism language-py"><span class="token comment"># 初始化摄像头</span>
sensor<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
sensor<span class="token punctuation">.</span>set_pixformat<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>RGB565<span class="token punctuation">)</span> <span class="token comment"># 设置图像色彩格式为RGB565格式</span>
sensor<span class="token punctuation">.</span>set_framesize<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>QQVGA<span class="token punctuation">)</span>  <span class="token comment"># 设置图像大小为160*120</span>
sensor<span class="token punctuation">.</span>set_auto_whitebal<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>      <span class="token comment"># 设置自动白平衡</span>
sensor<span class="token punctuation">.</span>set_brightness<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>         <span class="token comment"># 设置亮度为3000</span>
sensor<span class="token punctuation">.</span>skip_frames<span class="token punctuation">(</span>time <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span>       <span class="token comment"># 跳过帧</span>
</code></pre> 
<blockquote> 
 <p>（3）注意，这一阶段只需要调整摄像头的初始化！！！PC端IDE出现了红色斑点再开始处理！！！</p> 
</blockquote> 
<h3><a id="_30"></a>白平衡和自增益的作用</h3> 
<blockquote> 
 <p>（1）关闭白平衡和自增益可能适用于以下场景：<br> &lt;1&gt;保持色彩一致性：在某些图像识别应用中，特别是涉及色彩信息重要性较高的场景，关闭白平衡可以保持图像中的色彩一致性。白平衡会根据不同光源调整图像颜色，这可能导致相同对象在不同光照条件下的颜色出现差异，影响识别的准确性。<br> &lt;2&gt;特定光照条件下的优化：在一些特殊环境中，如低光照条件或强烈光线照射的情况下，关闭自增益可以避免图像过度曝光或欠曝光。这样做可以保留图像中更多细节，有助于图像识别算法更好地处理图像。<br> &lt;3&gt;原始数据分析：在某些图像分析应用中，关闭白平衡和自增益可以使用原始的传感器数据进行分析，而不受相机的颜色处理和亮度调整影响。这可以提供更纯粹、更原始的数据，有助于一些特定图像处理和识别算法的优化。<br> （2）需要注意的是，关闭白平衡和自增益也可能导致一些挑战，比如图像中的颜色信息可能会出现较大的变化，而且在某些场景下可能需要更复杂的图像处理算法来应对不同光照条件下的挑战。因此，在图像识别应用中是否关闭白平衡和自增益需要根据具体的情况和应用场景进行权衡和决策。</p> 
</blockquote> 
<h2><a id="_37"></a>发挥题思路</h2> 
<h3><a id="___39"></a>第一问 — 追踪</h3> 
<blockquote> 
 <p>（1）我个人认为这个必须上PID了。我个人认为这个题目和OpenMV的追小球云台代码类似。<br> （2）基础题目我认为一个OpenMV就可以完成。而发挥题目需要两个OpenMV。这两个OpenMV一个放红色激光笔，一个放绿色激光笔。<br> （3）各位可以综合<strong>追小球云台的代码</strong>，以及我下面讲的：<strong>关于C站那位博主代码的注意事项 部分</strong>。<br> （4）追踪的绿色激光笔建议。<br> &lt;1&gt;变成灰度图，这样可以消除其他颜色的干扰，只观察红色。然后追踪。<br> &lt;2&gt;提高分辨率，较高的分辨率，能够提供更好的效果。<br> &lt;3&gt;使用多组颜色阈值，就像<a href="https://blog.csdn.net/qq_63922192/article/details/127154993">OpenMV多颜色识别详解</a>的代码那样。让识别的颜色阈值变成多组。提高分辨效果。</p> 
</blockquote> 
<h3><a id="__34_48"></a>第二问 — 追踪和走基础题3，4问</h3> 
<blockquote> 
 <p>如果基础题做出来了，以及发挥题的追踪做出来了。那么就直接用基础题的红色激光笔走，然后发挥题追踪。这个和上面的代码应该是差不多的。</p> 
</blockquote> 
<h3><a id="___51"></a>第三问 — 暂停键</h3> 
<blockquote> 
 <p>这个我还是建议自己焊接一个按键，并联一个104的电容，进行硬件方面的按键消抖。然后自己写逻辑代码。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/a3/88/PScRpP3C_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="mainpy_56"></a>main.py</h2> 
<blockquote> 
 <p>（1）以下为官方的追小球云台代码，我增加了中文注释。<br> （2）因为GitHub是在外网，所以我直接复制过来了。但是总是有一些网友，硬要官方的GitHub链接。我也贴到了前言部分。</p> 
</blockquote> 
<h3><a id="_59"></a>代码</h3> 
<pre><code class="prism language-py"><span class="token keyword">import</span> sensor<span class="token punctuation">,</span> image<span class="token punctuation">,</span> time

<span class="token keyword">from</span> pid <span class="token keyword">import</span> PID
<span class="token keyword">from</span> pyb <span class="token keyword">import</span> Servo  <span class="token comment">#从内置pyb导入servo类，也就是舵机控制类</span>

pan_servo<span class="token operator">=</span>Servo<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">#定义两个舵机，对应P7引脚</span>
tilt_servo<span class="token operator">=</span>Servo<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">#定义两个舵机，对应P8引脚</span>

pan_servo<span class="token punctuation">.</span>calibration<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">2500</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span>
tilt_servo<span class="token punctuation">.</span>calibration<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">2500</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span>

red_threshold  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">)</span>  <span class="token comment">#设置红色阈值</span>

pan_pid <span class="token operator">=</span> PID<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.07</span><span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imax<span class="token operator">=</span><span class="token number">90</span><span class="token punctuation">)</span> <span class="token comment">#PID参数，只需要调整P量即可，设置P7引脚的PI值</span>
tilt_pid <span class="token operator">=</span> PID<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imax<span class="token operator">=</span><span class="token number">90</span><span class="token punctuation">)</span> <span class="token comment">#PID参数，只需要调整P量即可，设置P8引脚的PI值</span>
<span class="token comment">#pan_pid = PID(p=0.1, i=0, imax=90)#在线调试使用这个PID</span>
<span class="token comment">#tilt_pid = PID(p=0.1, i=0, imax=90)#在线调试使用这个PID</span>

sensor<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 初始化摄像头传感器</span>
sensor<span class="token punctuation">.</span>set_pixformat<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>RGB565<span class="token punctuation">)</span> <span class="token comment"># 使用 RGB565 彩图</span>
sensor<span class="token punctuation">.</span>set_framesize<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>QQVGA<span class="token punctuation">)</span> <span class="token comment"># 使用 QQVGA 分辨率</span>
sensor<span class="token punctuation">.</span>skip_frames<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">#跳过几帧，让新的设置生效。</span>
sensor<span class="token punctuation">.</span>set_auto_whitebal<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 因为是颜色识别，所以需要把白平衡关闭</span>
clock <span class="token operator">=</span> time<span class="token punctuation">.</span>clock<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 追踪帧率，影响不大</span>

<span class="token comment">#__________________________________________________________________</span>
<span class="token comment">#定义寻找最大色块的函数，因为图像中有多个色块，所以追踪最大的那个</span>
<span class="token keyword">def</span> <span class="token function">find_max</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    max_size<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">for</span> blob <span class="token keyword">in</span> blobs<span class="token punctuation">:</span>
        <span class="token keyword">if</span> blob<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>blob<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> max_size<span class="token punctuation">:</span>
            max_blob<span class="token operator">=</span>blob
            max_size <span class="token operator">=</span> blob<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>blob<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> max_blob

<span class="token comment">#__________________________________________________________________</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    clock<span class="token punctuation">.</span>tick<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 跟踪快照()之间经过的毫秒数。</span>
    img <span class="token operator">=</span> sensor<span class="token punctuation">.</span>snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 截取一张图片</span>

    blobs <span class="token operator">=</span> img<span class="token punctuation">.</span>find_blobs<span class="token punctuation">(</span><span class="token punctuation">[</span>red_threshold<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#识别红色阈值</span>
    <span class="token keyword">if</span> blobs<span class="token punctuation">:</span>   <span class="token comment">#如果找到红色色块</span>
        max_blob <span class="token operator">=</span> find_max<span class="token punctuation">(</span>blobs<span class="token punctuation">)</span>  <span class="token comment">#调用上面自定义函数，找到最大色块</span>
        pan_error <span class="token operator">=</span> max_blob<span class="token punctuation">.</span>cx<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>img<span class="token punctuation">.</span>width<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
        tilt_error <span class="token operator">=</span> max_blob<span class="token punctuation">.</span>cy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>img<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"pan_error: "</span><span class="token punctuation">,</span> pan_error<span class="token punctuation">)</span>

        img<span class="token punctuation">.</span>draw_rectangle<span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>rect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 在找到最大色块画一个矩形框</span>
        img<span class="token punctuation">.</span>draw_cross<span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>cx<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max_blob<span class="token punctuation">.</span>cy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># cx, cy</span>

        pan_output<span class="token operator">=</span>pan_pid<span class="token punctuation">.</span>get_pid<span class="token punctuation">(</span>pan_error<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
        tilt_output<span class="token operator">=</span>tilt_pid<span class="token punctuation">.</span>get_pid<span class="token punctuation">(</span>tilt_error<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#上面两个都说进行PID运算</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"pan_output"</span><span class="token punctuation">,</span>pan_output<span class="token punctuation">)</span>
        pan_servo<span class="token punctuation">.</span>angle<span class="token punctuation">(</span>pan_servo<span class="token punctuation">.</span>angle<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>pan_output<span class="token punctuation">)</span> <span class="token comment">#将最终值传入两个舵机中，追踪目标</span>
        tilt_servo<span class="token punctuation">.</span>angle<span class="token punctuation">(</span>tilt_servo<span class="token punctuation">.</span>angle<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>tilt_output<span class="token punctuation">)</span><span class="token comment"># 因为两个舵机方向和摆放位置不同，所以一个是+一个是-</span>

</code></pre> 
<h3><a id="_119"></a>舵机控制</h3> 
<h4><a id="_120"></a>舵机选择</h4> 
<blockquote> 
 <p>（1）Servo是舵机控制类。因为我们使用from pyb import Servo直接从pyd导入了servo类。所以可以直接写成Servo()。<br> （2）引脚对应关系：Servo(1)——P7，Servo(2)——P8，Servo(3)——P9。<br> （3）<br> &lt;1&gt;因此我们可以知道，pan_servo.calibration就是对P7进行相应的控制，因为pan_servo=Servo(1)。<br> &lt;2&gt;tilt_servo.calibration就是对P8控制，因为tilt_servo=Servo(2)</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/77/fc/uG1dDz7G_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_128"></a>舵机脉冲设置</h4> 
<blockquote> 
 <p>（1）pan_servo.calibration(500,2500,500) ， 这个其实就是设置舵机的脉宽的。因为我们知道，常见的舵机周期都是20ms，脉宽都是再500us到2500us之间。<br> （2）所以这里的第一个参数是500，第二个参数是2500。第三个参数是舵机0°位置，根据下图可以知道，也是500。最后两个值是可以填可不填的，个人不建议填写。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/c5/1d/AXD9Ha4w_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/44/62/JlYoxOzn_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="PID_135"></a>PID目标值是那个</h4> 
<blockquote> 
 <p>pan_servo.angle()是当前舵机角度,pan_output是通过PID计算出来的偏移角度。</p> 
</blockquote> 
<h3><a id="_137"></a>颜色阈值设置</h3> 
<blockquote> 
 <p>（1）因为我们要追踪红色，所以是使用red_threshold = (13, 49, 18, 61, 6, 47) 进行设置阈值。<br> （2）颜色阈值设置教程：<a href="https://blog.csdn.net/qq_63922192/article/details/127145498">OpenMV颜色阈值设置<br> </a></p> 
</blockquote> 
<h3><a id="PIDPI_141"></a>PID的P和I参数设置</h3> 
<blockquote> 
 <p>（1）注意，因为云台是比较稳定的，不要求高反应速度，<strong>所以我猜测只使用了PI</strong>，而没有使用PID。因此我们可以看到pan_pid和tilt_pid只有P和I两个参数。<br> （2）<mark>I的参数不需要进行调整！imax是用于积分限幅的，这个也别更改！</mark>，如果你的云台抖动厉害，说明P过大了，需要调小。<br> （3）如果你感觉你云台反应太慢，就需要调高P值。<br> （4）最佳的P值是，你云台有抖动的前一个值。这个才是P的最优值。但是我认为，P没必要太大，因为云台还是比较稳的。<br> （5）<mark>所以说，只需要调整P值，I值和imax值不需要进行调整！！！</mark></p> 
</blockquote> 
<h3><a id="_147"></a>帧率禁用</h3> 
<blockquote> 
 <p>（1）当OpenMV连接电脑端IDE的时候，运行帧率和不连接电脑端IDE是不一样的。因为我们连接上电脑端IDE的时候，OpenMV会向电脑端IDE传输数据，所以会导致帧率下降。<br> （2）帧率下降，会导致我们实际脱机跑的时候，PID参数和连接上电脑端IDE时候的PID参数不一样。<br> （3）所以我们需要点击电脑端右上角的禁用，或者是Disable。被禁用之后，我们的效果就是脱机之后真实运行效果。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ac/81/yIlPOSMf_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="pidpy_157"></a>pid.py</h2> 
<blockquote> 
 <p>（1）这里面的代码我们不需要管，就算PID的代码。<br> （2）<mark>再次强调，这里请别擅自更改，出现问题自己负责。</mark></p> 
</blockquote> 
<pre><code class="prism language-py"><span class="token keyword">from</span> pyb <span class="token keyword">import</span> millis
<span class="token keyword">from</span> math <span class="token keyword">import</span> pi<span class="token punctuation">,</span> isnan
 
<span class="token keyword">class</span> <span class="token class-name">PID</span><span class="token punctuation">:</span>
    _kp <span class="token operator">=</span> _ki <span class="token operator">=</span> _kd <span class="token operator">=</span> _integrator <span class="token operator">=</span> _imax <span class="token operator">=</span> <span class="token number">0</span>
    _last_error <span class="token operator">=</span> _last_derivative <span class="token operator">=</span> _last_t <span class="token operator">=</span> <span class="token number">0</span>
    _RC <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pi <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> d<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imax<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_kp <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_ki <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_kd <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_imax <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>imax<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_last_derivative <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'nan'</span><span class="token punctuation">)</span>
 
    <span class="token keyword">def</span> <span class="token function">get_pid</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> error<span class="token punctuation">,</span> scaler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tnow <span class="token operator">=</span> millis<span class="token punctuation">(</span><span class="token punctuation">)</span>
        dt <span class="token operator">=</span> tnow <span class="token operator">-</span> self<span class="token punctuation">.</span>_last_t
        output <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_last_t <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> dt <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">:</span>
            dt <span class="token operator">=</span> <span class="token number">0</span>
            self<span class="token punctuation">.</span>reset_I<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_last_t <span class="token operator">=</span> tnow
        delta_time <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        output <span class="token operator">+=</span> error <span class="token operator">*</span> self<span class="token punctuation">.</span>_kp
        <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_kd<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> dt <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> isnan<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_last_derivative<span class="token punctuation">)</span><span class="token punctuation">:</span>
                derivative <span class="token operator">=</span> <span class="token number">0</span>
                self<span class="token punctuation">.</span>_last_derivative <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                derivative <span class="token operator">=</span> <span class="token punctuation">(</span>error <span class="token operator">-</span> self<span class="token punctuation">.</span>_last_error<span class="token punctuation">)</span> <span class="token operator">/</span> delta_time
            derivative <span class="token operator">=</span> self<span class="token punctuation">.</span>_last_derivative <span class="token operator">+</span> \
                                     <span class="token punctuation">(</span><span class="token punctuation">(</span>delta_time <span class="token operator">/</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_RC <span class="token operator">+</span> delta_time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> \
                                        <span class="token punctuation">(</span>derivative <span class="token operator">-</span> self<span class="token punctuation">.</span>_last_derivative<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_last_error <span class="token operator">=</span> error
            self<span class="token punctuation">.</span>_last_derivative <span class="token operator">=</span> derivative
            output <span class="token operator">+=</span> self<span class="token punctuation">.</span>_kd <span class="token operator">*</span> derivative
        output <span class="token operator">*=</span> scaler
        <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_ki<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> dt <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_integrator <span class="token operator">+=</span> <span class="token punctuation">(</span>error <span class="token operator">*</span> self<span class="token punctuation">.</span>_ki<span class="token punctuation">)</span> <span class="token operator">*</span> scaler <span class="token operator">*</span> delta_time
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_integrator <span class="token operator">&lt;</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>_imax<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_integrator <span class="token operator">=</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>_imax
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_integrator <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>_imax<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_integrator <span class="token operator">=</span> self<span class="token punctuation">.</span>_imax
            output <span class="token operator">+=</span> self<span class="token punctuation">.</span>_integrator
        <span class="token keyword">return</span> output
    <span class="token keyword">def</span> <span class="token function">reset_I</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_integrator <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>_last_derivative <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'nan'</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="C_209"></a>关于C站那位博主代码的注意事项</h2> 
<h3><a id="_210"></a>代码</h3> 
<blockquote> 
 <p>原文链接 ： https://blog.csdn.net/weixin_52385589/article/details/126334744</p> 
</blockquote> 
<h4><a id="_212"></a>感光器初始化代码</h4> 
<pre><code class="prism language-py">sensor<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>set_auto_gain<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>set_pixformat<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>GRAYSCALE<span class="token punctuation">)</span> <span class="token comment"># or sensor.RGB565</span>
    sensor<span class="token punctuation">.</span>set_framesize<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>  QVGA<span class="token punctuation">)</span> <span class="token comment"># or sensor.QVGA (or others)</span>
    sensor<span class="token punctuation">.</span>skip_frames<span class="token punctuation">(</span>time<span class="token operator">=</span><span class="token number">900</span><span class="token punctuation">)</span> <span class="token comment"># Let new settings take affect.</span>
    sensor<span class="token punctuation">.</span>set_auto_exposure<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token comment">#在这里调节曝光度，调节完可以比较清晰地看清激光点</span>
    sensor<span class="token punctuation">.</span>set_auto_whitebal<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># turn this off.</span>
    sensor<span class="token punctuation">.</span>set_auto_gain<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 关闭增益（色块识别时必须要关）</span>

</code></pre> 
<h4><a id="_224"></a>识别激光点代码</h4> 
<pre><code class="prism language-py"><span class="token keyword">def</span> <span class="token function">color_blob</span><span class="token punctuation">(</span>threshold<span class="token punctuation">)</span><span class="token punctuation">:</span>

    blobs <span class="token operator">=</span> img<span class="token punctuation">.</span>find_blobs<span class="token punctuation">(</span>threshold<span class="token punctuation">,</span>x_stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> y_stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> area_threshold<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> pixels_threshold<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>merge<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>margin<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">1</span> <span class="token punctuation">:</span><span class="token comment">#有色块</span>
        <span class="token comment"># Draw a rect around the blob.</span>
        b <span class="token operator">=</span> blobs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#img.draw_rectangle(b[0:4]) # rect</span>
        cx <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
        cy <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#img.draw_rectangle(b[0:4]) # rect</span>
            cx <span class="token operator">=</span> blobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">+</span>cx
            cy <span class="token operator">=</span> blobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">+</span>cy
        cx<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>cx<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cy<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>cy<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">#img.draw_cross(cx, cy) # cx, cy</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cx<span class="token punctuation">,</span>cy<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cy<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">#表示没有找到</span>

</code></pre> 
<h4><a id="_248"></a>颜色阈值</h4> 
<pre><code class="prism language-py">threshold<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<h4><a id="_253"></a>整体代码</h4> 
<blockquote> 
 <p>（1）这个是那位博主的整体代码，感兴趣的可以拿过来用。<br> （2）<mark>版权归C站博主Huiyeee所有！用了代码的同学，一定要去<a href="https://blog.csdn.net/weixin_52385589?type=blog">Huiyeee</a>的博主下面感谢！！！</mark></p> 
</blockquote> 
<pre><code class="prism language-py"><span class="token keyword">def</span> <span class="token function">find_max</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    max_size<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">for</span> blob <span class="token keyword">in</span> blobs<span class="token punctuation">:</span>
        <span class="token keyword">if</span> blob<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>blob<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> max_size <span class="token punctuation">:</span>
            max_blob<span class="token operator">=</span>blob
            max_size <span class="token operator">=</span> blob<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>blob<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> max_blob


<span class="token keyword">def</span> <span class="token function">FindCR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    counts<span class="token operator">=</span><span class="token number">0</span>
    w_avg<span class="token operator">=</span><span class="token number">0</span>
    x_avg<span class="token operator">=</span><span class="token number">0</span>
    y_avg<span class="token operator">=</span><span class="token number">0</span>
    judge<span class="token operator">=</span><span class="token number">0</span>
    shape<span class="token operator">=</span><span class="token number">0</span>
    c_times<span class="token operator">=</span><span class="token number">0</span>
    r_times<span class="token operator">=</span><span class="token number">0</span>
    max_size<span class="token operator">=</span><span class="token number">0</span>
    cx<span class="token operator">=</span><span class="token number">0</span>
    cy<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>counts<span class="token operator">&lt;</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pin1<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        counts<span class="token operator">=</span>counts<span class="token operator">+</span><span class="token number">1</span>
        clock<span class="token punctuation">.</span>tick<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#返回以毫秒计的通电后的运行时间。</span>
        img <span class="token operator">=</span> sensor<span class="token punctuation">.</span>snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lens_corr<span class="token punctuation">(</span>strength <span class="token operator">=</span> <span class="token number">1.8</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token comment">#抓取一帧的图像并返回一个image对象</span>
        <span class="token comment">#img.find_blobs()查找图像中所有色块，并返回包含每个色块的色块对象列表</span>

        flag<span class="token operator">=</span><span class="token number">0</span>
        blobs<span class="token operator">=</span>img<span class="token punctuation">.</span>find_blobs<span class="token punctuation">(</span>thresholds<span class="token punctuation">,</span> pixels_threshold<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> area_threshold<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> merge<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> blobs<span class="token punctuation">:</span>
            max_blob<span class="token operator">=</span>find_max<span class="token punctuation">(</span>blobs<span class="token punctuation">)</span>
            <span class="token keyword">if</span> max_blob<span class="token punctuation">:</span>
                <span class="token keyword">if</span> judge<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">for</span> c <span class="token keyword">in</span> img<span class="token punctuation">.</span>find_circles<span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>rect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>threshold <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">,</span> x_margin <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> y_margin <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
                     r_margin <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> r_min <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> r_max <span class="token operator">=</span> <span class="token number">200</span> <span class="token punctuation">,</span> r_step <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> c<span class="token punctuation">.</span>magnitude<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">5000</span><span class="token punctuation">:</span>
                            c_times<span class="token operator">=</span>c_times<span class="token operator">+</span><span class="token number">1</span>
                            cx<span class="token operator">=</span>cx<span class="token operator">+</span>c<span class="token punctuation">.</span>x<span class="token punctuation">(</span><span class="token punctuation">)</span>
                            cy<span class="token operator">=</span>cy<span class="token operator">+</span>c<span class="token punctuation">.</span>y<span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token comment">#img.draw_circle(c.x(),c.y(),c.r(),(0,255,0))</span>
                        <span class="token keyword">if</span> c_times<span class="token operator">&gt;</span><span class="token number">5</span><span class="token punctuation">:</span>
                            judge<span class="token operator">=</span><span class="token number">1</span>
                            shape<span class="token operator">=</span><span class="token number">1</span>
                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"circle"</span><span class="token punctuation">)</span>
                            cx<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>cx<span class="token operator">/</span>c_times<span class="token punctuation">)</span>
                            cy<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>cy<span class="token operator">/</span>c_times<span class="token punctuation">)</span>
                            <span class="token keyword">break</span>
                    <span class="token keyword">for</span> r <span class="token keyword">in</span> img<span class="token punctuation">.</span>find_rects<span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>rect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>threshold <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        img<span class="token punctuation">.</span>draw_rectangle<span class="token punctuation">(</span>r<span class="token punctuation">.</span>x<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span>y<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span>w<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span>h<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> r<span class="token punctuation">.</span>magnitude<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">50000</span> <span class="token keyword">and</span> judge<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                            r_times<span class="token operator">=</span>r_times<span class="token operator">+</span><span class="token number">1</span>
                        <span class="token keyword">if</span> r_times<span class="token punctuation">:</span>
                            judge<span class="token operator">=</span><span class="token number">1</span>
                            shape<span class="token operator">=</span><span class="token number">0</span>
                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"rect"</span><span class="token punctuation">)</span>
                            <span class="token keyword">break</span>
                <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>w<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>max_blob<span class="token punctuation">.</span>h<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> shape<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
                        x_avg<span class="token operator">=</span>cx
                        y_avg<span class="token operator">=</span>cy
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        x_avg<span class="token operator">=</span><span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>x<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token operator">*</span>max_blob<span class="token punctuation">.</span>w<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>x_avg<span class="token punctuation">)</span><span class="token operator">+</span>max_blob<span class="token punctuation">.</span>cx<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        y_avg<span class="token operator">=</span><span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>y<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token operator">*</span>max_blob<span class="token punctuation">.</span>h<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>y_avg<span class="token punctuation">)</span><span class="token operator">+</span>max_blob<span class="token punctuation">.</span>cy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        max_size<span class="token operator">=</span>max_size<span class="token operator">+</span><span class="token number">2</span>
                    flag<span class="token operator">=</span><span class="token number">1</span>
                <span class="token comment">#if(max_blob.cx()-max_blob.x()&gt;w_avg):</span>
                    <span class="token comment">#w_avg=max_blob.cx()-max_blob.x()</span>
                <span class="token comment">#if(max_blob.w()-max_blob.cx()+max_blob.x())&gt;x_avg:</span>
                    <span class="token comment">#x_avg=max_blob.w()-max_blob.cx()+max_blob.x()</span>

                <span class="token comment">#if(max_blob.cy()-max_blob.y()&gt;w_avg):</span>
                    <span class="token comment">#w_avg=max_blob.cy()-max_blob.y()</span>
                <span class="token comment">#if(max_blob.w()-max_blob.cy()+max_blob.y())&gt;x_avg:</span>
                    <span class="token comment">#x_avg=max_blob.w()-max_blob.cy()+max_blob.y()</span>
                <span class="token keyword">if</span> max_blob<span class="token punctuation">.</span>w<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>w_avg<span class="token punctuation">:</span>
                    w_avg<span class="token operator">=</span>max_blob<span class="token punctuation">.</span>w<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> max_blob<span class="token punctuation">.</span>h<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>w_avg<span class="token punctuation">:</span>
                    w_avg<span class="token operator">=</span>max_blob<span class="token punctuation">.</span>h<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#a=math.sqrt((max_blob.cx()-max_blob.x())**2-(max_blob.cy()-max_blob.y())**2)</span>
                <span class="token comment">#if a&gt;w_avg:</span>
                    <span class="token comment">#w_avg=a</span>
                img<span class="token punctuation">.</span>draw_rectangle<span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>rect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#画矩形框 blob.rect() ---&gt; 返回一个矩形元组（可当作roi区域）</span>

                img<span class="token punctuation">.</span>draw_cross<span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>cx<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>max_blob<span class="token punctuation">.</span>cy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
            counts<span class="token operator">=</span>counts<span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> shape<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                img<span class="token punctuation">.</span>draw_cross<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>x_avg<span class="token operator">/</span>max_size<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>y_avg<span class="token operator">/</span>max_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#画十字 blob.cx(), blob.cy() ---&gt;返回中心点x和y坐标</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                img<span class="token punctuation">.</span>draw_cross<span class="token punctuation">(</span>x_avg<span class="token punctuation">,</span>y_avg<span class="token punctuation">)</span>
           <span class="token comment">#print(clock.fps())#clock.fps() ---&gt; 停止追踪运行时间，并返回当前FPS(必须先调用tick)。</span>
    <span class="token keyword">if</span> shape<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>x_avg<span class="token operator">/</span>max_size<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>y_avg<span class="token operator">/</span>max_size<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>w_avg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        data<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>x_avg<span class="token operator">/</span>max_size<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>y_avg<span class="token operator">/</span>max_size<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>w_avg<span class="token punctuation">)</span><span class="token punctuation">,</span>shape<span class="token punctuation">]</span>
    <span class="token keyword">elif</span> shape<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
        data<span class="token operator">=</span><span class="token punctuation">[</span>x_avg<span class="token punctuation">,</span>y_avg<span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>w_avg<span class="token punctuation">)</span><span class="token punctuation">,</span>shape<span class="token punctuation">]</span>

    <span class="token keyword">return</span> data




<span class="token keyword">def</span> <span class="token function">detect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sensor<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#初始化设置</span>
    sensor<span class="token punctuation">.</span>set_pixformat<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>RGB565<span class="token punctuation">)</span> <span class="token comment">#设置为彩色</span>
    sensor<span class="token punctuation">.</span>set_framesize<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>QVGA<span class="token punctuation">)</span> <span class="token comment">#设置清晰度</span>
    sensor<span class="token punctuation">.</span>skip_frames<span class="token punctuation">(</span>time <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token comment">#跳过前2000ms的图像</span>
    sensor<span class="token punctuation">.</span>set_auto_gain<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 关闭自动自动增益。默认开启的。</span>
    sensor<span class="token punctuation">.</span>set_auto_whitebal<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment">#关闭白平衡。在颜色识别中，一定要关闭白平衡。</span>
    clock <span class="token operator">=</span> time<span class="token punctuation">.</span>clock<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#创建一个clock便于计算FPS，看看到底卡不卡</span>

    judge<span class="token operator">=</span><span class="token number">0</span>
    r_time<span class="token operator">=</span><span class="token number">0</span>
    a_r<span class="token operator">=</span><span class="token number">0</span>
    a_c<span class="token operator">=</span><span class="token number">0</span>
    a_rt<span class="token operator">=</span><span class="token number">0</span>
    c_time<span class="token operator">=</span><span class="token number">0</span>
    rt_time<span class="token operator">=</span><span class="token number">0</span>
    row_data<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>judge<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#不断拍照</span>
        clock<span class="token punctuation">.</span>tick<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> sensor<span class="token punctuation">.</span>snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lens_corr<span class="token punctuation">(</span>strength <span class="token operator">=</span> <span class="token number">1.8</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

        blobs<span class="token operator">=</span>img<span class="token punctuation">.</span>find_blobs<span class="token punctuation">(</span>thresholds<span class="token punctuation">,</span>pixels_threshold<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>area_threshold<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token comment">#openmv自带的寻找色块函数。</span>
        <span class="token comment">#pixels_threshold是像素阈值，面积小于这个值的色块就忽略</span>
        <span class="token comment">#roi是感兴趣区域，只在这个区域内寻找色块</span>
        <span class="token comment">#are_threshold是面积阈值，如果色块被框起来的面积小于这个值，会被过滤掉</span>
            <span class="token comment">#print('该形状占空比为',blob.density())</span>
        <span class="token keyword">if</span> blobs<span class="token punctuation">:</span>
            max_blob<span class="token operator">=</span>find_max<span class="token punctuation">(</span>blobs<span class="token punctuation">)</span>
            <span class="token keyword">if</span> max_blob<span class="token punctuation">:</span>


            <span class="token comment">#print('该形状的面积为',area)</span>
             <span class="token comment">#density函数居然可以自动返回色块面积/外接矩形面积这个值，太神奇了，官方文档还是要多读！</span>
                <span class="token keyword">if</span> max_blob<span class="token punctuation">.</span>density<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0.78</span><span class="token punctuation">:</span><span class="token comment">#理论上矩形和他的外接矩形应该是完全重合</span>
            <span class="token comment">#但是测试时候发现总会有偏差，多次试验取的这个值。下面圆形和三角形亦然</span>

                    r_time<span class="token operator">=</span>r_time<span class="token operator">+</span><span class="token number">1</span>
                    <span class="token comment">#a_r=a_r+area</span>
                    <span class="token comment">#area=int(max_blob.x()*max_blob.y()*max_blob.density()*0.0185)</span>
                    img<span class="token punctuation">.</span>draw_rectangle<span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>rect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'长方形长'</span><span class="token punctuation">,</span>max_blob<span class="token punctuation">.</span>density<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> r_time<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">:</span>
                        <span class="token comment">#area=int(a_r/r_time)</span>
                        <span class="token comment">#print(area)</span>
                        judge<span class="token operator">=</span><span class="token number">1</span>
                        row_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"检测为长方形  "</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> max_blob<span class="token punctuation">.</span>density<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0.46</span><span class="token punctuation">:</span>

                    <span class="token comment">#area=int(max_blob.x()*max_blob.y()*max_blob.density()*0.0575)</span>
                    c_time<span class="token operator">=</span>c_time<span class="token operator">+</span><span class="token number">1</span>
                    <span class="token comment">#a_c=a_c+area</span>
                    img<span class="token punctuation">.</span>draw_circle<span class="token punctuation">(</span><span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>cx<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max_blob<span class="token punctuation">.</span>cy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>w<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>max_blob<span class="token punctuation">.</span>h<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'圆形半径'</span><span class="token punctuation">,</span>max_blob<span class="token punctuation">.</span>density<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> c_time<span class="token operator">&gt;</span><span class="token number">8</span><span class="token punctuation">:</span>
                        <span class="token comment">#area=int(a_c/c_time)</span>
                        <span class="token comment">#print(area)</span>
                        judge<span class="token operator">=</span><span class="token number">1</span>
                        row_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"检测为圆  "</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> max_blob<span class="token punctuation">.</span>density<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0.2</span><span class="token punctuation">:</span>
                    <span class="token comment">#area=int(max_blob.x()*max_blob.y()*max_blob.density()*0.0207)</span>
                    rt_time<span class="token operator">=</span>rt_time<span class="token operator">+</span><span class="token number">1</span>
                    <span class="token comment">#a_rt=a_rt+area</span>
                    img<span class="token punctuation">.</span>draw_cross<span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>cx<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max_blob<span class="token punctuation">.</span>cy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>max_blob<span class="token punctuation">.</span>density<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> rt_time<span class="token operator">&gt;</span><span class="token number">20</span><span class="token punctuation">:</span>
                        <span class="token comment">#area=int(a_rt/rt_time)</span>
                        <span class="token comment">#if c_time&gt;0:</span>
                            <span class="token comment">#area=area-10*c_time</span>
                        <span class="token comment">#print(area)</span>
                        judge<span class="token operator">=</span><span class="token number">1</span>
                        row_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">3</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"检测为三角型  "</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment">#基本上占空比小于0.4的都是干扰或者三角形，索性全忽略了。</span>
                    <span class="token keyword">continue</span>

                <span class="token comment">#row_data[1]=area</span>

    area<span class="token operator">=</span><span class="token number">0</span>
    count<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        clock<span class="token punctuation">.</span>tick<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> sensor<span class="token punctuation">.</span>snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lens_corr<span class="token punctuation">(</span>strength <span class="token operator">=</span> <span class="token number">1.8</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
        img<span class="token punctuation">.</span>binary<span class="token punctuation">(</span>thresholds<span class="token punctuation">)</span>
        img<span class="token punctuation">.</span>draw_rectangle<span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">)</span>
        x_init<span class="token operator">=</span><span class="token number">80</span>
        y_init<span class="token operator">=</span><span class="token number">40</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> img<span class="token punctuation">.</span>get_pixel<span class="token punctuation">(</span>i<span class="token operator">+</span>x_init<span class="token punctuation">,</span>j<span class="token operator">+</span>y_init<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">255</span><span class="token punctuation">:</span>
                    count<span class="token operator">=</span>count<span class="token operator">+</span><span class="token number">1</span>

        <span class="token keyword">break</span>
        <span class="token comment">#img.draw_rectangle(80,40,150,120)</span>
        <span class="token comment">#sta=img.get_statistics(thresholds, invert=False, roi=(80,40,150,120))</span>
        <span class="token comment">#area=area+(30-sta.mean())*1000</span>
        <span class="token comment">#counts=counts+1</span>
        <span class="token comment">#print(sta.mean())</span>
        <span class="token comment">#if(counts&gt;50):</span>
            <span class="token comment">#area=int(area/counts*0.0031495)</span>
            <span class="token comment">#print(area)</span>
            <span class="token comment">#break</span>
    row_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>count<span class="token operator">*</span><span class="token number">0.02329</span><span class="token operator">*</span><span class="token number">1.14946236559</span><span class="token punctuation">)</span>
    <span class="token comment">#</span>
    \

    <span class="token keyword">print</span><span class="token punctuation">(</span>row_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    data<span class="token operator">=</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span>row_data<span class="token punctuation">)</span>
    uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>u_start<span class="token punctuation">)</span>
    uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>u_over<span class="token punctuation">)</span>



<span class="token comment">#-------------------------------------------------------------------------</span>

<span class="token comment">#threshold=[(90, 100, -101, 87, -94, 84)]</span>
threshold<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">color_blob</span><span class="token punctuation">(</span>threshold<span class="token punctuation">)</span><span class="token punctuation">:</span>

    blobs <span class="token operator">=</span> img<span class="token punctuation">.</span>find_blobs<span class="token punctuation">(</span>threshold<span class="token punctuation">,</span>x_stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> y_stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> area_threshold<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> pixels_threshold<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>merge<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>margin<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">1</span> <span class="token punctuation">:</span>
        <span class="token comment"># Draw a rect around the blob.</span>
        b <span class="token operator">=</span> blobs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#img.draw_rectangle(b[0:4]) # rect</span>
        cx <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
        cy <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#img.draw_rectangle(b[0:4]) # rect</span>
            cx <span class="token operator">=</span> blobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">+</span>cx
            cy <span class="token operator">=</span> blobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">+</span>cy
        cx<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>cx<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cy<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>cy<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">#img.draw_cross(cx, cy) # cx, cy</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cx<span class="token punctuation">,</span>cy<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cy<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span>

<span class="token keyword">import</span> sensor<span class="token punctuation">,</span> image<span class="token punctuation">,</span> time <span class="token punctuation">,</span>math<span class="token punctuation">,</span>utime
<span class="token keyword">from</span> pyb <span class="token keyword">import</span> UART
<span class="token keyword">from</span> pyb <span class="token keyword">import</span> Pin
<span class="token keyword">from</span> pyb <span class="token keyword">import</span> ExtInt
<span class="token keyword">from</span> pyb <span class="token keyword">import</span> LED



uart <span class="token operator">=</span> UART<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">115200</span><span class="token punctuation">,</span> timeout_char<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span>  <span class="token comment"># i使用给定波特率初始化</span>
uart<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">,</span> bits<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> parity<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stop<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> timeout_char<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span>
u_start<span class="token operator">=</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xb3</span><span class="token punctuation">,</span><span class="token number">0xb3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
u_over<span class="token operator">=</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x0d</span><span class="token punctuation">,</span><span class="token number">0x0a</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
thresholds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment">#LAB阈值</span>
pin1 <span class="token operator">=</span> Pin<span class="token punctuation">(</span><span class="token string">'P1'</span><span class="token punctuation">,</span> Pin<span class="token punctuation">.</span>IN<span class="token punctuation">,</span> Pin<span class="token punctuation">.</span>PULL_UP<span class="token punctuation">)</span>
pin2 <span class="token operator">=</span> Pin<span class="token punctuation">(</span><span class="token string">'P2'</span><span class="token punctuation">,</span>Pin<span class="token punctuation">.</span>IN<span class="token punctuation">,</span>Pin<span class="token punctuation">.</span>PULL_UP<span class="token punctuation">)</span>


<span class="token comment">#extint = ExtInt(pin2, ExtInt.IRQ_FALLING, Pin.PULL_UP, callback_PIN2)</span>
<span class="token comment">#顺序：(L Min, L Max, A Min, A Max, B Min, B Max)</span>

clock <span class="token operator">=</span> time<span class="token punctuation">.</span>clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#定义时钟对象clock</span>



<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>pin1<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    row_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    sensor<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>set_pixformat<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>RGB565<span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>set_framesize<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>QVGA<span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>skip_frames<span class="token punctuation">(</span>time <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>set_auto_gain<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 关闭增益（色块识别时必须要关）</span>
    sensor<span class="token punctuation">.</span>set_auto_whitebal<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 关闭白平衡</span>
    LED<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pin1<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pin2<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        detect<span class="token punctuation">(</span><span class="token punctuation">)</span>

    row_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>row_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>row_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>row_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>FindCR<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pin1<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pin2<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        detect<span class="token punctuation">(</span><span class="token punctuation">)</span>
    LED<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>off<span class="token punctuation">(</span><span class="token punctuation">)</span>
    LED<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data<span class="token operator">=</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span>row_data<span class="token punctuation">)</span>
    uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>u_start<span class="token punctuation">)</span>
    uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>u_over<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>row_data<span class="token punctuation">)</span>
    LED<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>off<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pin1<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    sensor<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>set_auto_gain<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>set_pixformat<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>GRAYSCALE<span class="token punctuation">)</span> <span class="token comment"># or sensor.RGB565</span>
    sensor<span class="token punctuation">.</span>set_framesize<span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>  QVGA<span class="token punctuation">)</span> <span class="token comment"># or sensor.QVGA (or others)</span>
    sensor<span class="token punctuation">.</span>skip_frames<span class="token punctuation">(</span>time<span class="token operator">=</span><span class="token number">900</span><span class="token punctuation">)</span> <span class="token comment"># Let new settings take affect.</span>
    sensor<span class="token punctuation">.</span>set_auto_exposure<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    sensor<span class="token punctuation">.</span>set_auto_whitebal<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># turn this off.</span>
    sensor<span class="token punctuation">.</span>set_auto_gain<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 关闭增益（色块识别时必须要关）</span>
    times<span class="token operator">=</span><span class="token number">0</span>
    num<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    add<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pin1<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pin2<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            detect<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#EXPOSURE_TIME_SCALE = 1.01</span>
        <span class="token comment">#current_exposure_time_in_microseconds = sensor.get_exposure_us()</span>

        <span class="token comment"># 默认情况下启用自动曝光控制（AEC）。调用以下功能可禁用传感器自动曝光控制。</span>
        <span class="token comment"># 另外“exposure_us”参数在AEC被禁用后覆盖自动曝光值。</span>
        <span class="token comment">#sensor.set_auto_exposure(False, \</span>
            <span class="token comment">#exposure_us = int(current_exposure_time_in_microseconds * EXPOSURE_TIME_SCALE))</span>
        <span class="token comment">#roi=(int(row_data[0]-0.5*row_data[2]),int(row_data[1]-0.5*row_data[2]),row_data[2],row_data[2])</span>
        clock<span class="token punctuation">.</span>tick<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> sensor<span class="token punctuation">.</span>snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lens_corr<span class="token punctuation">(</span>strength <span class="token operator">=</span> <span class="token number">1.8</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token comment">#抓取一帧的图像并返回一个image对象</span>
        img<span class="token punctuation">.</span>draw_circle<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        img<span class="token punctuation">.</span>draw_cross<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> sensor<span class="token punctuation">.</span>snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lens_corr<span class="token punctuation">(</span>strength <span class="token operator">=</span> <span class="token number">1.8</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token comment">#抓取一帧的图像并返回一个image对象</span>
        row_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>row_data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span>color_blob<span class="token punctuation">(</span>threshold<span class="token punctuation">)</span>

        <span class="token keyword">if</span> row_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> times<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                num<span class="token punctuation">[</span>times<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>row_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>row_data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>row_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">-</span>num<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">10</span> <span class="token keyword">or</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>row_data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">-</span>num<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">:</span>

                    <span class="token keyword">continue</span> <span class="token comment">#丢弃数据</span>
            times<span class="token operator">=</span>times<span class="token operator">+</span><span class="token number">1</span>
            num<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>row_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>row_data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            <span class="token comment">#img.draw_cross(row_data[4],row_data[5])</span>
            data<span class="token operator">=</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span>row_data<span class="token punctuation">)</span>
            uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>u_start<span class="token punctuation">)</span>
            uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            uart<span class="token punctuation">.</span>write<span class="token punctuation">(</span>u_over<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>row_data<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span>pin2<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="_617"></a>代码部分解读</h3> 
<h4><a id="_618"></a>图像类型</h4> 
<blockquote> 
 <p>（1）sensor.set_pixformat设置的图像类型不同。<br> &lt;1&gt;我拿官方代码和上面贴出来的那个代码进行了对比，发现了一件事情。他的sensor.set_pixformat是设置成GRAYSCALE图像，而我们这里是设置成RGB565图像。<br> &lt;2&gt;将图像画质设置成GRAYSCALE好处在于，如果只有两个颜色，更容易进行分辨，而且每个像素所占空间也减少了，可以适当的增加分辨率。但是也有缺点，如果是多颜色识别就会出现问题。<br> &lt;3&gt;本题只有三种颜色，底板白色，追踪的绿点，被追踪的红点。因为只需要追踪一个颜色，所以各位可以尝试将 sensor.set_pixformat(sensor.RGB565) 改成 sensor.set_pixformat(sensor.GRAYSCALE)</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ae/fb/ROXVktlV_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_626"></a>图像分辨率</h4> 
<blockquote> 
 <p>（2）图像分辨率，sensor.set_framesize(sensor.QQVGA)<br> &lt;1&gt;官方例程的分辨率是QQVGA，像素点是160x120。而那个博客的分辨率是QVGA，像素点是 320x240。<br> &lt;2&gt;更高的分辨率，识别效果更好，但是分辨率也别无脑调高，否则颜色阈值方便会很难设置。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/69/04/4fPXQjJo_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_632"></a>跳过帧数</h4> 
<blockquote> 
 <p>（3）跳过帧数，sensor.skip_frames(10)<br> &lt;1&gt;这个就是给OpenMV初始化一个缓冲时间，他那边是设置的跳过900张图片。官方例程是跳过10个图片。<br> &lt;2&gt;这个选取看你自己，我感觉没必要900，太多了。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/e2/32/RRfXQOC6_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_638"></a>曝光度设置</h4> 
<blockquote> 
 <p>（4）sensor.set_auto_exposure(False, 1000)<br> &lt;1&gt;这个是用于设置曝光度的，曝光过度照片看起来会过亮，曝光不足图片看起来会太暗。<br> &lt;2&gt;官方例程没有调用这个函数，说明曝光是一直打开的。<br> &lt;3&gt;C站那位是设置的每1ms曝光一次。你们可以根据自己测试结果来设置。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/88/81/sRBVGW3W_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_645"></a>白平衡和自增益</h4> 
<blockquote> 
 <p>（5）sensor.set_auto_whitebal(False)和sensor.set_auto_gain(False)<br> &lt;1&gt;按理来说颜色识别的话，这两个都需要关闭的。C站另外那个博客就是都关闭了。但是官方只关闭了set_auto_whitebal()白平衡。<br> &lt;2&gt;我个人建议还是先都关闭</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/de/9e/4pdZ3rpI_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/6b/c1/VQjBudOl_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f2fa23a09436be088bb65bb133603882/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2023年电赛---运动目标控制与自动追踪系统（E题）OpenART mini的代码移植到OpenMV</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/556a03fc1a558b4b1ecb17d66b8c0b74/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">设置TOMCAT SESSIONID 字符长度和生成算法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>