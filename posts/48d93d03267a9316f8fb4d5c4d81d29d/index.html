<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[Onnx简化库深度剖析] OnnxSimplifier和OnnxOptimizer解读-(3) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[Onnx简化库深度剖析] OnnxSimplifier和OnnxOptimizer解读-(3)" />
<meta property="og:description" content=" [Onnx简化库深度剖析] OnnxSimplifier和OnnxOptimizer解读-(3) 简介 补充剩下的所有Pass的特性 具体的Pass实现和细节罗列（补充 PassPassNamePassTypePassEfficiencyPassOptimizationType描述EliminateNopMonotoneArgmaxeliminate_nop_monotone_argmaxNopPartialCompute消除掉那些正相关的激活函数到argmax函数上，减少计算EliminateNopPadeliminate_nop_padNopCompleteCompute消除pads=0的Pad算子EliminateNopConcateliminate_nop_concatNopCompleteMemory消除输入个数为1的Concat算子EliminateNopSpliteliminate_nop_splitNopCompleteMemory消除输出个数为1、input_dim[axis]=split[0]的Split算子EliminateNopExpandeliminate_nop_expandNopCompleteCompute消除expand_dim可以广播到input_dim的Expand算子EliminateShapeGathereliminate_shape_gatherFuseCompleteCompute融合掉indices=[indices_val,]、前面的节点是Shape的Gather算子EliminateSliceAfterShapeeliminate_slice_after_shapeFuseCompleteCompute融合掉前面的节点是Shape的Slice算子EliminateNopTransposeeliminate_nop_transposeNopCompleteCompute消除掉不起作用的transpose算子FuseAddBiasIntoConvfuse_add_bias_into_convFuseCompleteCompute融合掉前面的节点是Conv2d、且input[1]是常量可配合dim的Add算子FuseBNIntoConvfuse_bn_into_convFuseCompleteCompute融合BN算子到Conv2d上，同时修改Conv2d的权重FuseConsecutiveConcatsfuse_consecutive_concatsFusePartialCompute融合前面的axis相同的Concat到该Concat节点上FuseConsecutiveLogSoftmaxfuse_consecutive_log_softmaxFuseCompleteCompute融合softmax&#43;log成为LogSoftmax算子FuseConsecutiveReduceUnsqueezefuse_consecutive_reduce_unsqueezeFuseCompleteCompute当前面的Reduce算子的axes=Unsqueeze_axes、keepdims=0时，融合Unsqueeze算子到Reduce算子上FuseConsecutiveSqueezesfuse_consecutive_squeezesFuseCompleteCompute合并多个连续的Squeeze算子成为一个Squeeze算子FuseConsecutiveTransposesfuse_consecutive_transposesFuseCompleteCompute合并多个连续的Transpose算子成为一个Transpose算子FuseMatMulAddBiasIntoGemmfuse_matmul_add_bias_into_gemmFuseCompleteCompute合并MatMul&#43;Add成为一个Gemm算子FusePadIntoConvfuse_pad_into_convFuseCompleteCompute合并Pad&#43;Conv成为一个Conv算子,Pad操作合并到了Conv上FusePadIntoPoolfuse_pad_into_poolFuseCompleteCompute合并Pad&#43;AveragePool/MaxPool成为一个Pool算子FuseTransposeIntoGemmfuse_transpose_into_gemmFuseCompleteCompute融合前面的Transpose操作反转Gemm的transA/transB参数，从而融合掉transpose算子ReplaceEinsumWithMatmulreplace_einsum_with_matmulReplaceCompleteCompute满足条件的einsum变成matmul操作：&#34;bhij,bhjd-&gt;bhid&#34;变成matmul; &#34;bhid,bhjd-&gt;bhij&#34;变成transpose&#43;matmul操作LiftLexicalReferenceslift_lexical_referencesSeparateCompleteMemory待说明SplitInitsplit_initSeparateCompleteMemory待说明SplitPredictsplit_predictSeparateCompleteMemory待说明FuseConcatIntoReshapefuse_concat_into_reshapeFuseCompleteCompute融合reshape的shape输入的concat/cast算子，变成constant shape输入EliminateNopReshapeeliminate_nop_reshapeNopCompleteCompute消除掉reshape dim == input_dim的reshape算子EliminateOpWithUniteliminate_nop_with_unitNopCompleteCompute消除掉同0并的And、同1乘的Mul、同0或的Or、同0加的Add、减0的Sub、除1的Div、方1的Pow、 无效的ConcatEliminateCommonSubexpressioneliminate_common_subexpressionNopCompleteCompute消除掉那些属性/输入一致的节点，也就是公共子表达式FuseQKVfuse_qkvFuseCompleteCompute合并qkv计算的三个matmul为只有一个matmul: A = matmul(X, Q), B = matmul(X, K), C = matmul(X, V) ==&gt; A,B,C = split(matmul(X, concat(Q,K,V)))FuseConsecutiveUnsqueezesfuse_consecutive_unsqueezesFuseCompleteCompute融合连续的Unsqueezes算子EliminateDeadEndeliminate_deadendNopCompleteCompute移除掉output没有连接到其他节点的nodeEliminateIdentityeliminate_identityNopCompleteCompute移除掉Identity nodeEliminateShapeOpeliminate_shape_opFuseCompleteCompute融合掉可以直接获取input_shape的Shape算子FuseConsecutiveSlicesfuse_consecutive_slicesFuseCompleteMemory融合掉axes没有交集的连续的slice算子，合并为一个SliceEliminateUnusedInitializereliminate_unused_initializerNopCompleteMemory移除掉不被使用的initializerEliminateDuplicateInitializereliminate_duplicate_initializerNopCompleteMemory移除掉重复的initializerAdjustSliceAndMatmuladjust_slice_and_matmulReplaceCompleteCompute调整slice和matmul之间的顺序，以便优化：Y = Matmul(Slice(data, start, end, axes) ,rhs) ==&gt; Y = Slice(Matmul(data, rhs), start, end, axes)RewriteInputDtyperewrite_input_dtypeOtherCompleteNone重写input的类型从int64变成int32，从A=node1(INT64_INPUT) ==&gt; A=node1(Cast(INT32_INPUT, INT64)) …
总结 基本上目前所有的Pass已经被罗列出来了，后续会用实际的效果去加深大家的印象 " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/48d93d03267a9316f8fb4d5c4d81d29d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-12T16:00:28+08:00" />
<meta property="article:modified_time" content="2024-01-12T16:00:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[Onnx简化库深度剖析] OnnxSimplifier和OnnxOptimizer解读-(3)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Onnx_OnnxSimplifierOnnxOptimizer3_0"></a>[Onnx简化库深度剖析] OnnxSimplifier和OnnxOptimizer解读-(3)</h2> 
<h3><a id="_2"></a>简介</h3> 
<pre><code>补充剩下的所有Pass的特性
</code></pre> 
<h4><a id="Pass_5"></a>具体的Pass实现和细节罗列（补充</h4> 
<table><thead><tr><th>Pass</th><th>PassName</th><th>PassType</th><th>PassEfficiency</th><th>PassOptimizationType</th><th>描述</th></tr></thead><tbody><tr><td>EliminateNopMonotoneArgmax</td><td>eliminate_nop_monotone_argmax</td><td>Nop</td><td>Partial</td><td>Compute</td><td>消除掉那些正相关的激活函数到argmax函数上，减少计算</td></tr><tr><td>EliminateNopPad</td><td>eliminate_nop_pad</td><td>Nop</td><td>Complete</td><td>Compute</td><td>消除pads=0的Pad算子</td></tr><tr><td>EliminateNopConcat</td><td>eliminate_nop_concat</td><td>Nop</td><td>Complete</td><td>Memory</td><td>消除输入个数为1的Concat算子</td></tr><tr><td>EliminateNopSplit</td><td>eliminate_nop_split</td><td>Nop</td><td>Complete</td><td>Memory</td><td>消除输出个数为1、input_dim[axis]=split[0]的Split算子</td></tr><tr><td>EliminateNopExpand</td><td>eliminate_nop_expand</td><td>Nop</td><td>Complete</td><td>Compute</td><td>消除expand_dim可以广播到input_dim的Expand算子</td></tr><tr><td>EliminateShapeGather</td><td>eliminate_shape_gather</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合掉indices=[indices_val,]、前面的节点是Shape的Gather算子</td></tr><tr><td>EliminateSliceAfterShape</td><td>eliminate_slice_after_shape</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合掉前面的节点是Shape的Slice算子</td></tr><tr><td>EliminateNopTranspose</td><td>eliminate_nop_transpose</td><td>Nop</td><td>Complete</td><td>Compute</td><td>消除掉不起作用的transpose算子</td></tr><tr><td>FuseAddBiasIntoConv</td><td>fuse_add_bias_into_conv</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合掉前面的节点是Conv2d、且input[1]是常量可配合dim的Add算子</td></tr><tr><td>FuseBNIntoConv</td><td>fuse_bn_into_conv</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合BN算子到Conv2d上，同时修改Conv2d的权重</td></tr><tr><td>FuseConsecutiveConcats</td><td>fuse_consecutive_concats</td><td>Fuse</td><td>Partial</td><td>Compute</td><td>融合前面的axis相同的Concat到该Concat节点上</td></tr><tr><td>FuseConsecutiveLogSoftmax</td><td>fuse_consecutive_log_softmax</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合softmax+log成为LogSoftmax算子</td></tr><tr><td>FuseConsecutiveReduceUnsqueeze</td><td>fuse_consecutive_reduce_unsqueeze</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>当前面的Reduce算子的axes=Unsqueeze_axes、keepdims=0时，融合Unsqueeze算子到Reduce算子上</td></tr><tr><td>FuseConsecutiveSqueezes</td><td>fuse_consecutive_squeezes</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>合并多个连续的Squeeze算子成为一个Squeeze算子</td></tr><tr><td>FuseConsecutiveTransposes</td><td>fuse_consecutive_transposes</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>合并多个连续的Transpose算子成为一个Transpose算子</td></tr><tr><td>FuseMatMulAddBiasIntoGemm</td><td>fuse_matmul_add_bias_into_gemm</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>合并MatMul+Add成为一个Gemm算子</td></tr><tr><td>FusePadIntoConv</td><td>fuse_pad_into_conv</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>合并Pad+Conv成为一个Conv算子,Pad操作合并到了Conv上</td></tr><tr><td>FusePadIntoPool</td><td>fuse_pad_into_pool</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>合并Pad+AveragePool/MaxPool成为一个Pool算子</td></tr><tr><td>FuseTransposeIntoGemm</td><td>fuse_transpose_into_gemm</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合前面的Transpose操作反转Gemm的transA/transB参数，从而融合掉transpose算子</td></tr><tr><td>ReplaceEinsumWithMatmul</td><td>replace_einsum_with_matmul</td><td>Replace</td><td>Complete</td><td>Compute</td><td>满足条件的einsum变成matmul操作："bhij,bhjd-&gt;bhid"变成matmul; "bhid,bhjd-&gt;bhij"变成transpose+matmul操作</td></tr><tr><td>LiftLexicalReferences</td><td>lift_lexical_references</td><td>Separate</td><td>Complete</td><td>Memory</td><td>待说明</td></tr><tr><td>SplitInit</td><td>split_init</td><td>Separate</td><td>Complete</td><td>Memory</td><td>待说明</td></tr><tr><td>SplitPredict</td><td>split_predict</td><td>Separate</td><td>Complete</td><td>Memory</td><td>待说明</td></tr><tr><td>FuseConcatIntoReshape</td><td>fuse_concat_into_reshape</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合reshape的shape输入的concat/cast算子，变成constant shape输入</td></tr><tr><td>EliminateNopReshape</td><td>eliminate_nop_reshape</td><td>Nop</td><td>Complete</td><td>Compute</td><td>消除掉reshape dim == input_dim的reshape算子</td></tr><tr><td>EliminateOpWithUnit</td><td>eliminate_nop_with_unit</td><td>Nop</td><td>Complete</td><td>Compute</td><td>消除掉同0并的And、同1乘的Mul、同0或的Or、同0加的Add、减0的Sub、除1的Div、方1的Pow、 无效的Concat</td></tr><tr><td>EliminateCommonSubexpression</td><td>eliminate_common_subexpression</td><td>Nop</td><td>Complete</td><td>Compute</td><td>消除掉那些属性/输入一致的节点，也就是公共子表达式</td></tr><tr><td>FuseQKV</td><td>fuse_qkv</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>合并qkv计算的三个matmul为只有一个matmul: A = matmul(X, Q), B = matmul(X, K), C = matmul(X, V) ==&gt; A,B,C = split(matmul(X, concat(Q,K,V)))</td></tr><tr><td>FuseConsecutiveUnsqueezes</td><td>fuse_consecutive_unsqueezes</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合连续的Unsqueezes算子</td></tr><tr><td>EliminateDeadEnd</td><td>eliminate_deadend</td><td>Nop</td><td>Complete</td><td>Compute</td><td>移除掉output没有连接到其他节点的node</td></tr><tr><td>EliminateIdentity</td><td>eliminate_identity</td><td>Nop</td><td>Complete</td><td>Compute</td><td>移除掉Identity node</td></tr><tr><td>EliminateShapeOp</td><td>eliminate_shape_op</td><td>Fuse</td><td>Complete</td><td>Compute</td><td>融合掉可以直接获取input_shape的Shape算子</td></tr><tr><td>FuseConsecutiveSlices</td><td>fuse_consecutive_slices</td><td>Fuse</td><td>Complete</td><td>Memory</td><td>融合掉axes没有交集的连续的slice算子，合并为一个Slice</td></tr><tr><td>EliminateUnusedInitializer</td><td>eliminate_unused_initializer</td><td>Nop</td><td>Complete</td><td>Memory</td><td>移除掉不被使用的initializer</td></tr><tr><td>EliminateDuplicateInitializer</td><td>eliminate_duplicate_initializer</td><td>Nop</td><td>Complete</td><td>Memory</td><td>移除掉重复的initializer</td></tr><tr><td>AdjustSliceAndMatmul</td><td>adjust_slice_and_matmul</td><td>Replace</td><td>Complete</td><td>Compute</td><td>调整slice和matmul之间的顺序，以便优化：Y = Matmul(Slice(data, start, end, axes) ,rhs) ==&gt; Y = Slice(Matmul(data, rhs), start, end, axes)</td></tr><tr><td>RewriteInputDtype</td><td>rewrite_input_dtype</td><td>Other</td><td>Complete</td><td>None</td><td>重写input的类型从int64变成int32，从A=node1(INT64_INPUT) ==&gt; A=node1(Cast(INT32_INPUT, INT64))</td></tr></tbody></table> 
<p>…</p> 
<h3><a id="_50"></a>总结</h3> 
<pre><code>基本上目前所有的Pass已经被罗列出来了，后续会用实际的效果去加深大家的印象
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/278ddd8065d9f0a2c710fe9a5238801e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mixtral 8X7B MoE模型基于PAI的微调部署实践</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/af86310085e3d30ebd5c292baf76a40a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">代码随想录算法训练营第17天（需复习 |（二叉树4 110.平衡二叉树 257. 二叉树的所有路径 404.左叶子之和</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>