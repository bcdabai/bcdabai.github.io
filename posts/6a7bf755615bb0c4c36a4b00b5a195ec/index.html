<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>《Single Image Haze Removal Using Dark Channel Prior》去雾代码实现分析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="《Single Image Haze Removal Using Dark Channel Prior》去雾代码实现分析" />
<meta property="og:description" content="本文主要为了通过对代码进行分析，帮助更进一步了解《Single Image Haze Removal Using Dark Channel Prior》的操作步骤。
在看本篇文章前，需要对《Single Image Haze Removal Using Dark Channel Prior》有大致的了解。提供一个文章解析参考的连接：https://www.cnblogs.com/Imageshop/p/3281703.html
本文的代码分析也是基于上述文章中的代码资源进行分析的，本文主要在于结合代码梳理出更加清晰的思路，并且对代码进行了较为详细的注释。
一、主程序
首先在这给出主程序及其相关注释
clear clc close all kenlRatio = 0.01; minAtomsLight = 240; %设定的大气光的上限值 % image_name = &#39;test images\21.bmp&#39;; image_name = &#39;D:\1.png&#39;; %原图像 img=imread(image_name); %读取原始图片文件中的数据 figure,imshow(uint8(img)), title(&#39;src&#39;); %显示原始图像 并且显示标题 sz=size(img); %返回一个行向量sz，该行向量的第一个元素时矩阵的行数，第二个元素是矩阵的列数。 w=sz(2); %读取所提取矩阵的列数 h=sz(1); %读取所提取矩阵的行数 dc = zeros(h,w); %返回一个h×w的0矩阵给dc，实际上这个矩阵的size=原输入图像size for y=1:h %行遍历 for x=1:w %列遍历 dc(y,x) = min(img(y,x,:)); %对原图像的每一个像素求RGB3个通道中的最小亮度值,然后赋值给dc矩阵的y行x列 end end figure,imshow(uint8(dc)), title(&#39;Min(R,G,B)&#39;); %显示原图像的灰度图 krnlsz = floor(max([3, w*kenlRatio, h*kenlRatio])) %krnlsz为最小滤波窗口的边长尺寸大小 %kenlRatio是一个预设的值，求尺寸时拿kenlRatio和灰度图矩阵长和宽（即w和h）乘上这个预设值和3进行比较，选择最大数作为窗口尺寸 dc2 = minfilt2(dc, [krnlsz,krnlsz]); %对得到的灰度图进行最小值滤波获得暗通道图像 dc2(h,w)=0; %dc2矩阵的h行w列赋值0 figure,imshow(uint8(dc2)), title(&#39;After filter &#39;); %显示滤波后的图像 t = 255 - dc2; %下面4行对应公式11，即求出传输特性t（x)的估计值 figure,imshow(uint8(t)),title(&#39;t&#39;); %显示传输特性t的图像(原始的方法求t） t_d=double(t)/255; sum(sum(t_d))/(h*w) %t(x)表示的是x像素出的t的估计值，而此处将t_d的矩阵进行平均处理求出一个平均的t值 A = min([minAtomsLight, max(max(dc2))]) %根据论文提示的方法求A值，不过为了防止A过高，设置了一个上限值minAtomsLight %max(max(dc2))表示从暗通道图中按照亮度的大小取前0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6a7bf755615bb0c4c36a4b00b5a195ec/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-08T20:51:38+08:00" />
<meta property="article:modified_time" content="2020-05-08T20:51:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">《Single Image Haze Removal Using Dark Channel Prior》去雾代码实现分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文主要为了通过对代码进行分析，帮助更进一步了解《Single Image Haze Removal Using Dark Channel Prior》的操作步骤。</p> 
<p>在看本篇文章前，需要对《Single Image Haze Removal Using Dark Channel Prior》有大致的了解。提供一个文章解析参考的连接：<a href="https://www.cnblogs.com/Imageshop/p/3281703.html" rel="nofollow">https://www.cnblogs.com/Imageshop/p/3281703.html</a><br> 本文的代码分析也是基于上述文章中的代码资源进行分析的，本文主要在于结合代码梳理出更加清晰的思路，并且对代码进行了较为详细的注释。</p> 
<p><strong>一、主程序</strong><br> 首先在这给出主程序及其相关注释</p> 
<pre><code class="prism language-cpp">clear
clc
close all

kenlRatio <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>
minAtomsLight <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span>            <span class="token operator">%</span>设定的大气光的上限值
<span class="token operator">%</span> image_name <span class="token operator">=</span>  <span class="token string">'test images\21.bmp'</span><span class="token punctuation">;</span>
image_name <span class="token operator">=</span>  <span class="token string">'D:\1.png'</span><span class="token punctuation">;</span>       <span class="token operator">%</span>原图像
img<span class="token operator">=</span><span class="token function">imread</span><span class="token punctuation">(</span>image_name<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token operator">%</span>读取原始图片文件中的数据
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token operator">%</span>显示原始图像  并且显示标题 

sz<span class="token operator">=</span><span class="token function">size</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token operator">%</span>返回一个行向量sz，该行向量的第一个元素时矩阵的行数，第二个元素是矩阵的列数。
w<span class="token operator">=</span><span class="token function">sz</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">%</span>读取所提取矩阵的列数
h<span class="token operator">=</span><span class="token function">sz</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token operator">%</span>读取所提取矩阵的行数
dc <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">%</span>返回一个h×w的<span class="token number">0</span>矩阵给dc，实际上这个矩阵的size<span class="token operator">=</span>原输入图像size

<span class="token keyword">for</span> y<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span>h               <span class="token operator">%</span>行遍历          
    <span class="token keyword">for</span> x<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span>w           <span class="token operator">%</span>列遍历
        <span class="token function">dc</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">img</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">%</span>对原图像的每一个像素求RGB3个通道中的最小亮度值<span class="token punctuation">,</span>然后赋值给dc矩阵的y行x列
    end
end

figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>dc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'Min(R,G,B)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">%</span>显示原图像的灰度图

krnlsz <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> w<span class="token operator">*</span>kenlRatio<span class="token punctuation">,</span> h<span class="token operator">*</span>kenlRatio<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span>krnlsz为最小滤波窗口的边长尺寸大小
<span class="token operator">%</span>kenlRatio是一个预设的值，求尺寸时拿kenlRatio和灰度图矩阵长和宽（即w和h）乘上这个预设值和<span class="token number">3</span>进行比较，选择最大数作为窗口尺寸
dc2 <span class="token operator">=</span> <span class="token function">minfilt2</span><span class="token punctuation">(</span>dc<span class="token punctuation">,</span> <span class="token punctuation">[</span>krnlsz<span class="token punctuation">,</span>krnlsz<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">%</span>对得到的灰度图进行最小值滤波获得暗通道图像

<span class="token function">dc2</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>w<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>             <span class="token operator">%</span>dc2矩阵的h行w列赋值<span class="token number">0</span>
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>dc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'After filter '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">%</span>显示滤波后的图像
t <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">-</span> dc2<span class="token punctuation">;</span>          <span class="token operator">%</span>下面<span class="token number">4</span>行对应公式<span class="token number">11</span>，即求出传输特性t（x<span class="token punctuation">)</span>的估计值
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token operator">%</span>显示传输特性t的图像<span class="token punctuation">(</span>原始的方法求t）
t_d<span class="token operator">=</span><span class="token keyword">double</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">;</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>t_d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>h<span class="token operator">*</span>w<span class="token punctuation">)</span>     <span class="token operator">%</span><span class="token function">t</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>表示的是x像素出的t的估计值，而此处将t_d的矩阵进行平均处理求出一个平均的t值


A <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span>minAtomsLight<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>dc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span>根据论文提示的方法求A值，不过为了防止A过高，设置了一个上限值minAtomsLight
                                         <span class="token operator">%</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>dc2<span class="token punctuation">)</span><span class="token punctuation">)</span>表示从暗通道图中按照亮度的大小取前<span class="token number">0.1</span><span class="token operator">%</span>的像素。在这些位置中，在原始有雾图像I中寻找对应的具有最高亮度的点的值，作为A值
J <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>w<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token operator">%</span>生成一个<span class="token number">0</span>矩阵J 大小为h×w 此处的<span class="token number">3</span>表示rgb3个通道
img_d <span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">%</span>原始图像类型转换成<span class="token keyword">double</span>

<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span> <span class="token operator">%</span>根据公式<span class="token number">22</span>求出图像矩阵所有元素的R通道的值，下面两行为G和B的值
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span>
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span>

figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'J'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">%</span>显示去雾图像J


<span class="token operator">%</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">%</span>由于透射率图过于粗糙，而通过导向滤波的方式来获得较好的透射率图，下面是导向滤波计算t的方式
r <span class="token operator">=</span> krnlsz<span class="token operator">*</span><span class="token number">4</span>
eps <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">^</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">;</span>

<span class="token operator">%</span> filtered <span class="token operator">=</span> <span class="token function">guidedfilter_color</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> t_d<span class="token punctuation">,</span> r<span class="token punctuation">,</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span>
filtered <span class="token operator">=</span> <span class="token function">guidedfilter</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">(</span><span class="token function">rgb2gray</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> t_d<span class="token punctuation">,</span> r<span class="token punctuation">,</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span>导向滤波计算t

t_d <span class="token operator">=</span> filtered<span class="token punctuation">;</span><span class="token operator">%</span>导向滤波计算的值赋值给t_d矩阵
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span>t_d<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'filtered t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">%</span>显示导向滤波后求出的t值

<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span> <span class="token operator">%</span>根据公式<span class="token number">22</span>求出图像矩阵所有元素的R通道的值，下面两行为G和B的值
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span>
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span>

<span class="token function">imwrite</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'D:\11.bmp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span>将去雾后的图像数据写入到文件中
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'J_guild_filter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span>显示导向滤波后求出的去雾图像J</code></pre> 
<p><strong>二、主程序拆解分析</strong><br> 1.首先，根据文章我们可以得知：基于暗通道先验的思想，我们可以先求出t的预估值：<br> 在暗通道先验的原理下，求t预估值的公式转化为：<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/4e/88/ruDPNir0_o.png"><br> 对于一张确定的图，我们认为Ac大气光是一个定值。<br> 我们首先计算出原输入图像的灰度图，即括号内的部分minc Ic(y)。大概思路是对原图像的所有像素x求RGB通道中亮度最小的值，从而得到灰度图。</p> 
<pre><code class="prism language-cpp">image_name <span class="token operator">=</span>  <span class="token string">'D:\1.png'</span><span class="token punctuation">;</span>       <span class="token operator">%</span>原图像
img<span class="token operator">=</span><span class="token function">imread</span><span class="token punctuation">(</span>image_name<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token operator">%</span>读取原始图片文件中的数据
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token operator">%</span>显示原始图像  并且显示标题 
sz<span class="token operator">=</span><span class="token function">size</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token operator">%</span>返回一个行向量sz，该行向量的第一个元素时矩阵的行数，第二个元素是矩阵的列数。
w<span class="token operator">=</span><span class="token function">sz</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">%</span>读取所提取矩阵的列数
h<span class="token operator">=</span><span class="token function">sz</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token operator">%</span>读取所提取矩阵的行数
dc <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">%</span>返回一个h×w的<span class="token number">0</span>矩阵给dc，实际上这个矩阵的size<span class="token operator">=</span>原输入图像size
<span class="token keyword">for</span> y<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span>h               <span class="token operator">%</span>行遍历          
    <span class="token keyword">for</span> x<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span>w           <span class="token operator">%</span>列遍历
        <span class="token function">dc</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">img</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">%</span>对原图像的每一个像素求RGB3个通道中的最小亮度值<span class="token punctuation">,</span>然后赋值给dc矩阵的y行x列
    end
end
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>dc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'Min(R,G,B)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">%</span>显示原图像的灰度图</code></pre> 
<p>对于公式11减号后面内容的实现：对上面得到的灰度图像进行最小值滤波，minfilt2是一个最小值滤波的函数。</p> 
<pre><code class="prism language-cpp">kenlRatio <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>
krnlsz <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> w<span class="token operator">*</span>kenlRatio<span class="token punctuation">,</span> h<span class="token operator">*</span>kenlRatio<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span>krnlsz为最小滤波窗口的边长尺寸大小
<span class="token operator">%</span>kenlRatio是一个预设的值，求尺寸时拿kenlRatio和灰度图矩阵长和宽（即w和h）乘上这个预设值和<span class="token number">3</span>进行比较，选择最大数作为窗口尺寸
dc2 <span class="token operator">=</span> <span class="token function">minfilt2</span><span class="token punctuation">(</span>dc<span class="token punctuation">,</span> <span class="token punctuation">[</span>krnlsz<span class="token punctuation">,</span>krnlsz<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">%</span>对得到的灰度图进行最小值滤波获得暗通道图像</code></pre> 
<p>最后进行归一化、均值处理实现公式11的效果：</p> 
<pre><code class="prism language-cpp"><span class="token function">dc2</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>w<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>             <span class="token operator">%</span>dc2矩阵的h行w列赋值<span class="token number">0</span>
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>dc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'After filter '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">%</span>滤波后的图像结果
t <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">-</span> dc2<span class="token punctuation">;</span>          <span class="token operator">%</span>下面<span class="token number">4</span>行对应公式<span class="token number">11</span>，即求出传输特性t（x<span class="token punctuation">)</span>的估计值
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token operator">%</span>显示传输特性t的图像<span class="token punctuation">(</span>原始的方法求t）
t_d<span class="token operator">=</span><span class="token keyword">double</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">;</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>t_d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>h<span class="token operator">*</span>w<span class="token punctuation">)</span>     <span class="token operator">%</span><span class="token function">t</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>表示的是x像素出的t的估计值，而此处将t_d的矩阵进行平均处理求出一个平均的t值</code></pre> 
<p>2.预估了传输特性t值后，现在根据文章求出大气光A的估值。</p> 
<pre><code class="prism language-cpp">minAtomsLight <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span>            <span class="token operator">%</span>设定的大气光的上限值
A <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span>minAtomsLight<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>dc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span>根据论文提示的方法求A值，不过为了防止A过高，设置了一个上限值minAtomsLight</code></pre> 
<p>3.根据最终的求去雾图像J的公式来还原去雾图像，根据的公式如下：<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/2b/e3/oYtjUjjl_o.png"><br> 代码中的平均估值t_d替换的是公式中的max(t(x),t0)部分。</p> 
<pre><code class="prism language-cpp">J <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>w<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token operator">%</span>生成一个<span class="token number">0</span>矩阵J 大小为h×w 此处的<span class="token number">3</span>表示rgb3个通道
img_d <span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">%</span>原始图像类型转换成<span class="token keyword">double</span>
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span> <span class="token operator">%</span>根据公式<span class="token number">22</span>求出图像矩阵所有元素的R通道的值，下面两行为G和B的值
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span>
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span>
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'J'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">%</span>显示去雾图像J</code></pre> 
<p>4.由于透射率图过于粗糙，而通过导向滤波的方式来获得较好的透射率图，下面是导向滤波计算t的方式。</p> 
<pre><code class="prism language-cpp">r <span class="token operator">=</span> krnlsz<span class="token operator">*</span><span class="token number">4</span>
eps <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">^</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">;</span>
filtered <span class="token operator">=</span> <span class="token function">guidedfilter</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">(</span><span class="token function">rgb2gray</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> t_d<span class="token punctuation">,</span> r<span class="token punctuation">,</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span>导向滤波计算t
t_d <span class="token operator">=</span> filtered<span class="token punctuation">;</span><span class="token operator">%</span>导向滤波计算的值赋值给t_d矩阵
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span>t_d<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'filtered t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">%</span>显示导向滤波后求出的t值</code></pre> 
<p>5.利用导向滤波计算的t_d求出最后的去雾图像</p> 
<pre><code class="prism language-cpp"><span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span> <span class="token operator">%</span>根据公式<span class="token number">22</span>求出图像矩阵所有元素的R通道的值，下面两行为G和B的值
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span>
<span class="token function">J</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">img_d</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t_d<span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">/</span>t_d<span class="token punctuation">;</span>

<span class="token function">imwrite</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'D:\11.bmp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span>将去雾后的图像数据写入到文件中
figure<span class="token punctuation">,</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token function">uint8</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'J_guild_filter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span>显示导向滤波后求出的去雾图像J</code></pre> 
<p><strong>三、程序运行结果</strong><br> 1.显示原始输入图像<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/2c/05/89XulLWo_o.png"><br> 2.显示原始图像的灰度图<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/3b/c3/bjJkqV9d_o.png"><br> 3.显示对原始图像灰度图进行最小滤波后的结果<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/a5/54/7pPj76Ns_o.png"><br> 4.求出利用暗通道先验计算的t<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/6a/2c/FQ1GXDe3_o.png"><br> 5.根据求出的t和A计算出去雾图像J<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/22/44/uwlXBPzG_o.png"><br> 6.为了细化t，此处求导向滤波后的t<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/47/3b/1NKJA7Lq_o.png"><br> 7.利用导向滤波后求出的去雾图像<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/ef/6f/eGjK2hMB_o.png"><br> <strong>四、说明</strong><br> 这里值分析了主程序的思路，对于最小滤波和导向滤波的程序未分析，具体的代码见文章开头给出的链接。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2272bcd945c83350b305aa954dc2f6e6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python中的四种集合数据类型（列表，元组，集合，字典）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a97844306966ad02b20ea4cd10cc7bb0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">easyx的使用(c&#43;&#43;入门的图形设计)--画圆</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>