<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>游戏 AI 设计之 FSM 有限状态机 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="游戏 AI 设计之 FSM 有限状态机" />
<meta property="og:description" content="FSM 有限状态机 一、概述 有限状态机（finite-state machine，缩写：FSM）又称有限状态自动机（finite-state automaton，缩写：FSA），简称状态机，是表示有限个状态以及在这些状态之间的转移和动作等行为的数学计算模型。
从历史上来说，有限状态机是一个被数学家用来解决问题的严格形式化的设备。在人工智能变成中，我们可以建 FSM 理解为：
一个有限状态机是一个设备，或是一个设备模型，具有有限数量的状态，它可以在任何给定的时间根据输入进行操作，使得从一个状态变换到另一个状态，或者是促使一个输出或者一种行为的发生。一个有限状态机在任何瞬间只能处在一种状态。
二、分析 有限状态机，一般称作 FSM。常作为游戏 AI 设计的首选，尽管更专业的智能体结构越来越普及，但 FSM架构依然流行的原因如下
编程快速简单
有很多方法编码一个有限状态机，并且几乎乎所有的有限状态机实现都相当的简单。易于调试
因为一个游戏智能体的行为被分解成简单的易于管理的块，如果一个智能体开始变得行动怪异，会通过对每一个状态增加跟踪代码来调试它。用这种方法，人工智能程序员可以很容易跟踪错误行为出现前的事件序列，并且采取相应的行动。计算开销小
有限状态机几乎不占用珍贵的处理器时间，因为它们本质上遵守硬件编码的规则。除了 if-this-then-that 类型的思考处理之外，是不存在真正的“思考”的。直觉性
人们总是自然地把事物思考为处在一种或另一种状态。并且我们也常常提到我们自己处在这样那样的状态中。有多少次你“使自己进入一种状态”或者发现自己处于“头脑的正确状态”。当然人类并不是像有限状态机一样工作，但是有时候我们发现在这种方式下考虑我们的行为是有用的，比如你处于口渴状态，你就会想去喝水。相似地，将一个游戏智能体的行为分解成一系列状态并且创建需要的规则来操作它们是相当容易的。出于同样的原因，有限状态机能够使你很容易地与非程序员（例如与游戏制作人和关卡设计师）来讨论你的人工智能的设计，能够更好地进行设计概念的沟通和交流。灵活性
一个游戏智能体的有限状态机可以很容易地由程序员进行调整，来达到游戏设计者所要求的行为。同样通过增添新的状态和规则也很容易扩展智能体的行为的范围。此外，当你的人工智能技术提高了，你会发现有限状态机提供了一个坚固的支柱，使你可以用它来组合其他的技术，例如模糊逻辑和神经网络。 三、代码实现 下面我们实现一个简易的游戏状态机
Hero 在没有攻击目标的时候是 Idle（待机） 状态在发现怪物时会切换到 Attack（攻击） 状态没有攻击目标 切回 Idle 状态发现 Boss 或 自身血量低于 10 的时候 切换到 Escape （逃跑）状态
状态转换示意图 1、StateMachine _curState：当前状态，用于表示当前 Entity 所处的状态
_preState：保存 Entity 的上一个状态，方便回溯
_globalState ：这是一个特殊的状态，可与 _curState 共存，引进全局状态的原因是为了解决一种优先级高的状态，可以保证在任意时刻切换到指定状态。比如模拟人生的游戏里面，有个人正在工作，突然想要上厕所，那么需要打断当前的状态（使用 _preState 记录）并切换到上厕所状态。在上完厕所后，又继续恢复工作（恢复上一个状态）。
public class StateMachine { private Entity _entity = null; private State _globalState = null; // 全局状态 private State _preState = null; // 上一个状态 private State _curState = null; // 当前状态 public State CurState { get =&gt; _curState; } private Dictionary&lt;StateType, State&gt; _dicState = null; public void Init(Entity entity, List&lt;string&gt; listStateName) { _entity = entity; _dicState = new Dictionary&lt;StateType, State&gt;(); if (null !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/234590a30434959cce71deffe8915688/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-12T15:40:32+08:00" />
<meta property="article:modified_time" content="2022-03-12T15:40:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">游戏 AI 设计之 FSM 有限状态机</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="FSM__0"></a>FSM 有限状态机</h2> 
<h3><a id="_1"></a>一、概述</h3> 
<p>　　<strong>有限状态机</strong>（<strong>finite-state machine</strong>，缩写：<strong>FSM</strong>）又称<strong>有限状态自动机</strong>（<strong>finite-state automaton</strong>，缩写：<strong>FSA</strong>），简称<strong>状态机</strong>，是表示<strong>有限个状态</strong>以及在这些状态之间的<strong>转移</strong>和<strong>动作</strong>等行为的<strong>数学计算模型</strong>。<br> 　　从历史上来说，<strong>有限状态机</strong>是一个被<strong>数学家</strong>用来解决问题的<strong>严格形式化的设备</strong>。在人工智能变成中，我们可以建 FSM 理解为：<br> 　　一个有限状态机是一个<strong>设备</strong>，或是一个<strong>设备模型</strong>，具有<strong>有限数量的状态</strong>，它可以在任何给定的时间根据输入进行操作，使得从一个状态<strong>变换</strong>到另一个状态，或者是促使<strong>一个输出</strong>或者<strong>一种行为</strong>的发生。一个有限状态机在<strong>任何瞬间只能处在一种状态</strong>。</p> 
<h3><a id="_5"></a>二、分析</h3> 
<p>　　<strong>有限状态机</strong>，一般称作 <strong>FSM</strong>。常作为游戏 AI 设计的首选，尽管更专业的智能体结构越来越普及，但 FSM架构依然流行的原因如下</p> 
<ul><li><strong>编程快速简单</strong><br> 有很多方法编码一个有限状态机，并且几乎乎所有的有限状态机实现都相当的简单。</li><li><strong>易于调试</strong><br> 因为一个游戏智能体的行为被分解成简单的易于管理的块，如果一个智能体开始变得行动怪异，会通过对每一个状态增加跟踪代码来调试它。用这种方法，人工智能程序员可以很容易跟踪错误行为出现前的事件序列，并且采取相应的行动。</li><li><strong>计算开销小</strong><br> 有限状态机几乎不占用珍贵的处理器时间，因为它们本质上遵守硬件编码的规则。除了 <strong>if-this-then-that</strong> 类型的思考处理之外，是不存在真正的“<strong>思考</strong>”的。</li><li><strong>直觉性</strong><br> 人们总是自然地把事物思考为处在一种或另一种状态。并且我们也常常提到我们自己处在这样那样的状态中。有多少次你“使自己进入一种状态”或者发现自己处于“头脑的正确状态”。当然人类并不是像有限状态机一样工作，但是有时候我们发现在这种方式下考虑我们的行为是有用的，比如<strong>你处于口渴状态，你就会想去喝水</strong>。相似地，将一个游戏智能体的行为分解成一系列状态并且创建需要的规则来操作它们是相当容易的。出于同样的原因，有限状态机能够使你很容易地与非程序员（例如与游戏制作人和关卡设计师）来讨论你的人工智能的设计，能够更好地进行设计概念的沟通和交流。</li><li><strong>灵活性</strong><br> 一个游戏智能体的有限状态机可以很容易地由程序员进行调整，来达到游戏设计者所要求的行为。同样通过增添新的状态和规则也很容易扩展智能体的行为的范围。此外，当你的人工智能技术提高了，你会发现有限状态机提供了一个坚固的支柱，使你可以用它来组合其他的技术，例如模糊逻辑和神经网络。</li></ul> 
<h3><a id="_17"></a>三、代码实现</h3> 
<p>下面我们实现一个简易的游戏状态机</p> 
<ul><li>Hero 在没有攻击目标的时候是 Idle（待机） 状态</li><li>在发现怪物时会切换到 Attack（攻击） 状态</li><li>没有攻击目标 切回 Idle 状态</li><li>发现 Boss 或 自身血量低于 10 的时候 切换到 Escape （逃跑）状态<br> <img src="https://images2.imgbox.com/6b/80/1l7YBz5V_o.png" alt="状态装换示意图"></li></ul> 
<center> 
 <font color="#808080" size="2">状态转换示意图</font> 
</center> 
<h4><a id="1StateMachine_26"></a>1、StateMachine</h4> 
<p><code>_curState</code>：当前状态，用于表示当前 Entity 所处的状态<br> <code>_preState</code>：保存 Entity 的上一个状态，方便回溯<br> <code>_globalState</code> ：这是一个特殊的状态，可与 <code>_curState</code> 共存，引进全局状态的原因是为了解决一种<strong>优先级高的状态</strong>，可以保证在<strong>任意时刻切换到指定状态</strong>。比如模拟人生的游戏里面，有个人正在工作，突然想要<strong>上厕所</strong>，那么需要<strong>打断当前的状态</strong>（使用 <code>_preState</code> 记录）并切换到<strong>上厕所状态</strong>。在上完厕所后，又继续恢复工作（恢复上一个状态）。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateMachine</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Entity</span> _entity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">State</span> _globalState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 全局状态</span>
    <span class="token keyword">private</span> <span class="token class-name">State</span> _preState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 上一个状态</span>

    <span class="token keyword">private</span> <span class="token class-name">State</span> _curState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 当前状态</span>
    <span class="token keyword">public</span> <span class="token class-name">State</span> CurState <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _curState<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">private</span> Dictionary<span class="token operator">&lt;</span>StateType<span class="token punctuation">,</span> State<span class="token operator">&gt;</span> _dicState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token class-name">Entity</span> entity<span class="token punctuation">,</span> List<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> listStateName<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _entity <span class="token operator">=</span> entity<span class="token punctuation">;</span>
        _dicState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">Dictionary</span><span class="token punctuation">&lt;</span><span class="token class-name">StateType</span><span class="token punctuation">,</span> <span class="token class-name">State</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> listStateName<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> listStateName<span class="token punctuation">.</span>Count<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">string</span> className <span class="token operator">=</span> <span class="token string">"FSM.AI.States."</span> <span class="token operator">+</span> listStateName<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">Type</span> stateType <span class="token operator">=</span> Type<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">State</span> state <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>stateType<span class="token punctuation">)</span> <span class="token keyword">as</span> State<span class="token punctuation">;</span>
                state<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>_entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">AddState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">AddState</span><span class="token punctuation">(</span><span class="token class-name">State</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StateType</span> stateType <span class="token operator">=</span> state<span class="token punctuation">.</span>StateType<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_dicState<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>stateType<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _dicState<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>stateType<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">" State is already exist ! State : "</span> <span class="token operator">+</span> stateType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> _curState<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _curState<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> _globalState<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _globalState<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token class-name">StateType</span> state<span class="token punctuation">,</span> <span class="token keyword">object</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_dicState<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _preState <span class="token operator">=</span> _curState<span class="token punctuation">;</span>
            _curState <span class="token operator">=</span> _dicState<span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> _preState<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _preState<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            _curState<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">" State no exist ! "</span> <span class="token operator">+</span> _entity<span class="token punctuation">.</span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" State "</span> <span class="token operator">+</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OnMessage</span><span class="token punctuation">(</span><span class="token keyword">string</span> messageID<span class="token punctuation">,</span> <span class="token keyword">object</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2State_114"></a>2、State</h4> 
<p><code>Enter()</code>：进入状态时调用<br> <code>Execute()</code>：每次执行时调用<br> <code>Exit()</code>：退出状态时调用</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Entities<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> FSM<span class="token punctuation">.</span>AI<span class="token punctuation">.</span>States
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> StateType
    <span class="token punctuation">{<!-- --></span>
        Idle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>   <span class="token comment">// 待机</span>
        Attack <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 攻击</span>
        Escape <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 逃跑</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">State</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">protected</span> <span class="token class-name">Entity</span> _entity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token class-name">StateType</span> _stateType <span class="token operator">=</span> StateType<span class="token punctuation">.</span>Idle<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">StateType</span> StateType <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _stateType<span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token class-name">Entity</span> entity<span class="token punctuation">,</span> <span class="token keyword">object</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _entity <span class="token operator">=</span> entity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Enter</span><span class="token punctuation">(</span><span class="token keyword">object</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">OnMessage</span><span class="token punctuation">(</span><span class="token keyword">string</span> msgID<span class="token punctuation">,</span> <span class="token keyword">object</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3Hero__152"></a>3、Hero 相关状态</h4> 
<ul><li><code>HeroIdleState</code> 待机</li><li><code>HeroAttackState</code> 攻击</li><li><code>HeroEscapeState</code> 逃跑</li></ul> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Entities<span class="token punctuation">;</span>
<span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Manager<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> FSM<span class="token punctuation">.</span>AI<span class="token punctuation">.</span>States<span class="token punctuation">.</span>Hero
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeroIdleState</span> <span class="token punctuation">:</span> <span class="token class-name">State</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">int</span> ESC_HP <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">" {_entity.GetEntityType()} 待机中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 发现 BOSS 或者 血量小于 10 就逃跑</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_entity<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>hp <span class="token operator">&lt;</span> ESC_HP<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _entity<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span>StateType<span class="token punctuation">.</span>Escape<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            List<span class="token operator">&lt;</span>Entity<span class="token operator">&gt;</span> listMonster <span class="token operator">=</span> EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">GetMonsters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> listMonster<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>listMonster<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>it <span class="token operator">=</span><span class="token operator">&gt;</span> it<span class="token punctuation">.</span><span class="token function">GetEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EntityType<span class="token punctuation">.</span>Boss<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    _entity<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span>StateType<span class="token punctuation">.</span>Escape<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Entity</span> monster <span class="token operator">=</span> listMonster<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>it <span class="token operator">=</span><span class="token operator">&gt;</span> it<span class="token punctuation">.</span><span class="token function">GetEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EntityType<span class="token punctuation">.</span>Monster<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> monster <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>monster<span class="token punctuation">.</span><span class="token function">IsDeath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        _entity<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span>StateType<span class="token punctuation">.</span>Attack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeroAttackState</span> <span class="token punctuation">:</span> <span class="token class-name">State</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token class-name">Entity</span> entity<span class="token punctuation">,</span> <span class="token keyword">object</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _stateType <span class="token operator">=</span> StateType<span class="token punctuation">.</span>Attack<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            List<span class="token operator">&lt;</span>Entity<span class="token operator">&gt;</span> listMonster <span class="token operator">=</span> EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">GetMonsters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> listMonster<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Entity</span> monster <span class="token operator">=</span> listMonster<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>it <span class="token operator">=</span><span class="token operator">&gt;</span> it<span class="token punctuation">.</span><span class="token function">GetEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EntityType<span class="token punctuation">.</span>Monster<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> monster<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    _entity<span class="token punctuation">.</span><span class="token function">Attack</span><span class="token punctuation">(</span>monster<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    _entity<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span>StateType<span class="token punctuation">.</span>Idle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                _entity<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span>StateType<span class="token punctuation">.</span>Idle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeroEscapeState</span> <span class="token punctuation">:</span> <span class="token class-name">State</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token class-name">Entity</span> entity<span class="token punctuation">,</span> <span class="token keyword">object</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _stateType <span class="token operator">=</span> StateType<span class="token punctuation">.</span>Escape<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">" Hero：敌人太强了 ! 跑路 !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="4Entity_241"></a>4、Entity</h4> 
<p><code>GetEntityID()</code>：获取 Entity 的唯一 ID<br> <code>ChangeState()</code>：切换 Entity 状态<br> <code>OnUpdate()</code>：定时刷新 Entity 状态，在游戏中一般是每帧刷新，Demo 中使用 0.5s 刷新一次</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> FSM<span class="token punctuation">.</span>AI<span class="token punctuation">;</span>
<span class="token keyword">using</span> FSM<span class="token punctuation">.</span>AI<span class="token punctuation">.</span>States<span class="token punctuation">;</span>
<span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> FSM<span class="token punctuation">.</span>Entities
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> EntityType
    <span class="token punctuation">{<!-- --></span>
        Hero <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        Monster <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        Boss <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Entity</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">protected</span> <span class="token keyword">long</span> _iEntityIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token class-name">StateMachine</span> _stateMachine <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token class-name">EntityData</span> _data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">EntityData</span> Data <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _data<span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token keyword">object</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">string</span> <span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">StateType</span> <span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> _stateMachine <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span> <span class="token operator">!=</span> _stateMachine<span class="token punctuation">.</span>CurState<span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> _stateMachine<span class="token punctuation">.</span>CurState<span class="token punctuation">.</span>StateType<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> StateType<span class="token punctuation">.</span>Idle<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">EntityType</span> <span class="token function">GetEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token class-name">StateType</span> state<span class="token punctuation">,</span> <span class="token class-name">Object</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> _stateMachine<span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
                _stateMachine<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">OnUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> _stateMachine<span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
                _stateMachine<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Attack</span><span class="token punctuation">(</span><span class="token class-name">Entity</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">OnHurt</span><span class="token punctuation">(</span><span class="token keyword">int</span> deltaHp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">bool</span> <span class="token function">IsDeath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">OnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="5EntityManager_310"></a>5、EntityManager</h4> 
<p><code>EntityManager</code> 用于管理游戏中的所有 <code>Entity</code> ，包含 添加、移除 和 更新。亦可用于 Entity 间的互相通讯（下面的代码没有实现，只需简单添加 <code>OnMessager(string entityID, object data = null){ }</code>，即可）。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Entities<span class="token punctuation">;</span>
<span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Interface<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> FSM<span class="token punctuation">.</span>Manager
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EntityManager</span> <span class="token punctuation">:</span> <span class="token class-name">IManager</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> Lazy<span class="token operator">&lt;</span>EntityManager<span class="token operator">&gt;</span> _instance <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">Lazy</span><span class="token punctuation">&lt;</span><span class="token class-name">EntityManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">EntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">EntityManager</span> Instance
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">get</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _instance<span class="token punctuation">.</span>Value<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">long</span> _iEntityIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> EntityIndex <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token operator">++</span>_iEntityIndex<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

        <span class="token keyword">private</span> Dictionary<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> Entity<span class="token operator">&gt;</span> _dicEntity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> List<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> _listKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token function">EntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _dicEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">Dictionary</span><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _listKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">AddEntity</span><span class="token punctuation">(</span><span class="token class-name">Entity</span> entity<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">string</span> key <span class="token operator">=</span> entity<span class="token punctuation">.</span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_dicEntity<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _dicEntity<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _listKey<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Entity is exist id = "</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> _listKey<span class="token punctuation">.</span>Count<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">string</span> key <span class="token operator">=</span> _listKey<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">Entity</span> entity <span class="token operator">=</span> _dicEntity<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entity<span class="token punctuation">.</span><span class="token function">IsDeath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    entity<span class="token punctuation">.</span><span class="token function">OnUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 移除死亡的对象</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">IsDeath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    _listKey<span class="token punctuation">.</span><span class="token function">RemoveAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    len<span class="token operator">--</span><span class="token punctuation">;</span>
                    i<span class="token operator">--</span><span class="token punctuation">;</span>
                    _dicEntity<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RemoveEntity</span><span class="token punctuation">(</span><span class="token keyword">string</span> key<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_dicEntity<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Entity</span> entity <span class="token operator">=</span> _dicEntity<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
                entity<span class="token punctuation">.</span><span class="token function">OnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                _dicEntity<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _listKey<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Entity<span class="token operator">&gt;</span> <span class="token function">GetMonsters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            List<span class="token operator">&lt;</span>Entity<span class="token operator">&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> _listKey<span class="token punctuation">.</span>Count<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">string</span> key <span class="token operator">=</span> _listKey<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">Entity</span> entity <span class="token operator">=</span> _dicEntity<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">GetEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> EntityType<span class="token punctuation">.</span>Hero<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> list<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">Entity</span> <span class="token function">GetHero</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Entity</span> hero <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> _listKey<span class="token punctuation">.</span>Count<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">string</span> key <span class="token operator">=</span> _listKey<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">Entity</span> entity <span class="token operator">=</span> _dicEntity<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">GetEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EntityType<span class="token punctuation">.</span>Hero<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    hero <span class="token operator">=</span> entity<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> hero<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _dicEntity<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _listKey<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="6Demo_438"></a>6、Demo</h4> 
<p>Demo 流程：</p> 
<ul><li>创建 Hero 和 Monster</li><li>Hero 和 Monster 互相攻击</li><li>Monster 死亡后，Boss 登场</li><li>Hero 逃逸</li></ul> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Entities<span class="token punctuation">;</span>
<span class="token keyword">using</span> FSM<span class="token punctuation">.</span>Manager<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> FSM
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Add Hero</span>
            <span class="token class-name">Hero</span> hero <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InitData</span> initData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitData</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span>
                EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>EntityIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hero<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>initData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">AddEntity</span><span class="token punctuation">(</span>hero<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Add Monster</span>
            <span class="token class-name">Monster</span> monster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InitData</span> monsterInitData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitData</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
               EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>EntityIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            monster<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>monsterInitData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">AddEntity</span><span class="token punctuation">(</span>monster<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">bool</span> createBoss <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>hero<span class="token punctuation">.</span><span class="token function">IsDeath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>monster<span class="token punctuation">.</span><span class="token function">IsDeath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>createBoss<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    createBoss <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
                    <span class="token class-name">Boss</span> boss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">InitData</span> bossInitData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitData</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span>
                       EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>EntityIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    boss<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>bossInitData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    EntityManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">AddEntity</span><span class="token punctuation">(</span>boss<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">" 游戏结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/08/28/CFSw7anE_o.png" alt="运行结果"></p> 
<center> 
 <font color="#808080" size="2">运行结果</font> 
</center> 
<p></p> 
<p>参考资料：<br> [1] 游戏人工智能编程案例精粹（修订版）<br> [2] Finite-state machine：<a href="https://en.wikipedia.org/wiki/Finite-state_machine" rel="nofollow">https://en.wikipedia.org/wiki/Finite-state_machine</a></p> 
<p>欢迎关注个人公众号，实时推送最新博文！<br> <img src="https://images2.imgbox.com/13/ce/3zfBbAYn_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/010ca8b1438158344705628021898336/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CSS3的 transition属性、transform属性，怎么才能让他同时执行多个不同的过渡、动画（变换属性）效果</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/620aa4876ece46fc1f73eefb3cfac5d0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据结构基本概念</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>