<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Elasticsearch - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Elasticsearch" />
<meta property="og:description" content="1. 初识ElasticSearch 1.1 基于数据库查询的问题 查询效率低，模糊查询数据库不会使用索引查询的准确率不高 1.2 倒排索引 倒排索引：将文档进行分词，形成词条和id的对应关系即为反向索引。
以唐诗为例，所处包含“前”的诗句
正向索引：由《静夜思》–&gt;窗前明月光—&gt;“前”字
反向索引：“前”字–&gt;窗前明月光–&gt;《静夜思》
反向索引的实现就是对诗句进行分词，分成单个的词，由词推句，即为反向索引
“床前明月光”–&gt; 分词；将一段文本按照一定的规则，拆分为不同的词条（term）
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-eo4YB0Nr-1663903327650)(img/1580887683510.png)]
倒排索引中的Value通常是文档的唯一标识（ID）
1.3 ES存储和查询的原理 index（索引）：相当于mysql的库
映射：相当于mysql 的表结构
document(文档)：相当于mysql的表中的数据
数据库查询存在的问题：
性能低：使用模糊查询，左边有通配符，不会走索引，会全表扫描，性能低功能弱：如果以”华为手机“作为条件，查询不出来数据 Es使用倒排索引，对title 进行分词
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-tuoVuU8B-1663903327652)(img/1581143412491.png)]
使用“手机”作为关键字查询
生成的倒排索引中，词条会排序，形成一颗树形结构，提升词条的查询速度
使用“华为手机”作为关键字查询
华为：1,3
手机：1,2,3
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-apwYhX1D-1663903327652)(img/1581143489911.png)]
1.4 ES 概念详解 ES是一个基于Lucene的搜索服务器
ES是一个分布式、高扩展、高实时的搜索与数据分析引擎
ES基于RESTful web接口
Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎
官网：https://www.elastic.co/
应用场景
海量数据的查询/搜索日志数据分析实时数据分析 2. 安装ElasticSearch 下载地址：https://www.elastic.co/cn/downloads/elasticsearch
3. ElasticSearch核心概念 索引（index）
ElasticSearch存储数据的地方，可以理解成关系型数据库中的数据库概念。
映射（mapping）
mapping定义了每个字段的类型、字段所使用的分词器等。相当于关系型数据库中的表结构。
文档（document）
Elasticsearch中的最小数据单元，常以json格式显示。一个document相当于关系型数据库中的一行数据。
倒排索引
一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，对应一个包含它的文档id列表。
类型（type）
一种type就像一类表。如用户表、角色表等。在Elasticsearch7.X默认type为_doc
ES 5.x中一个index可以有多种type。 ES 6.x中一个index只能有一种type。 ES 7.x以后，将逐步移除type这个概念，现在的操作已经不再使用，默认_doc 4. 脚本操作ES 4.1 RESTful风格 REST（Representational State Transfer），表述性状态转移，是一组架构约束条件和原则。满足这些约束条件和原则的应用程序或设计就是RESTful。就是一种定义接口的规范。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/45e23a169652aaf95ce80da844f3df0d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-24T11:39:36+08:00" />
<meta property="article:modified_time" content="2022-10-24T11:39:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Elasticsearch</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_ElasticSearch_0"></a>1. 初识ElasticSearch</h3> 
<h4><a id="11__2"></a>1.1 基于数据库查询的问题</h4> 
<p><img src="https://images2.imgbox.com/8f/77/OkhD26BO_o.png" alt="在这里插入图片描述"></p> 
<ol><li>查询效率低，模糊查询数据库不会使用索引</li><li>查询的准确率不高</li></ol> 
<h4><a id="12__10"></a>1.2 倒排索引</h4> 
<p><strong>倒排索引</strong>：将文档进行分词，形成词条和id的对应关系即为反向索引。</p> 
<p>以唐诗为例，所处包含“前”的诗句</p> 
<p><u>正向索引：由《静夜思》–&gt;窗前明月光—&gt;“前”字</u></p> 
<p><u>反向索引：“前”字–&gt;窗前明月光–&gt;《静夜思》</u></p> 
<p>反向索引的实现就是对诗句进行分词，分成单个的词，由词推句，即为反向索引</p> 
<p>“床前明月光”–&gt; 分词；将一段文本按照一定的规则，拆分为不同的词条（term）</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-eo4YB0Nr-1663903327650)(img/1580887683510.png)]</p> 
<p>倒排索引中的Value通常是文档的唯一标识（ID）</p> 
<p><img src="https://images2.imgbox.com/23/39/U2Pc6MWo_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="13_ES_30"></a>1.3 ES存储和查询的原理</h4> 
<p><strong>index（索引）</strong>：相当于mysql的库</p> 
<p><strong>映射</strong>：相当于mysql 的表结构</p> 
<p><strong>document(文档)</strong>：相当于mysql的表中的数据</p> 
<p><strong>数据库查询存在的问题：</strong></p> 
<ol><li>性能低：使用模糊查询，左边有通配符，不会走索引，会全表扫描，性能低</li><li>功能弱：如果以”华为手机“作为条件，查询不出来数据</li></ol> 
<p>Es使用倒排索引，对title 进行分词</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-tuoVuU8B-1663903327652)(img/1581143412491.png)]</p> 
<ol><li> <p>使用“<u><mark>手机</mark></u>”作为关键字查询</p> <p>生成的倒排索引中，词条会排序，形成一颗树形结构，提升词条的查询速度</p> </li><li> <p>使用“<u><mark>华为手机</mark></u>”作为关键字查询</p> <p>华为：1,3</p> <p>手机：1,2,3</p> <p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-apwYhX1D-1663903327652)(img/1581143489911.png)]</p> </li></ol> 
<h4><a id="14_ES__63"></a>1.4 ES 概念详解</h4> 
<ul><li> <p>ES是一个基于Lucene的搜索服务器</p> </li><li> <p>ES是一个分布式、高扩展、高实时的搜索与数据分析引擎</p> </li><li> <p>ES基于RESTful web接口</p> </li><li> <p>Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎</p> </li><li> <p>官网：https://www.elastic.co/</p> </li></ul> 
<p><u><strong>应用场景</strong></u></p> 
<ol><li>海量数据的查询/搜索</li><li>日志数据分析</li><li>实时数据分析</li></ol> 
<h3><a id="2_ElasticSearch_81"></a>2. 安装ElasticSearch</h3> 
<p>下载地址：https://www.elastic.co/cn/downloads/elasticsearch</p> 
<h3><a id="3_ElasticSearch_85"></a>3. ElasticSearch核心概念</h3> 
<p><strong>索引（index）</strong></p> 
<p>ElasticSearch存储数据的地方，可以理解成关系型数据库中的数据库概念。</p> 
<p><strong>映射（mapping）</strong></p> 
<p>mapping定义了每个字段的类型、字段所使用的分词器等。相当于关系型数据库中的表结构。</p> 
<p><strong>文档（document）</strong></p> 
<p>Elasticsearch中的最小数据单元，常以json格式显示。一个document相当于关系型数据库中的一行数据。</p> 
<p><strong>倒排索引</strong></p> 
<p>一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，对应一个包含它的文档id列表。</p> 
<p><strong>类型（type）</strong></p> 
<p>一种type就像一类表。如用户表、角色表等。在Elasticsearch7.X默认type为_doc</p> 
<pre><code>ES 5.x中一个index可以有多种type。
ES 6.x中一个index只能有一种type。
ES 7.x以后，将逐步移除type这个概念，现在的操作已经不再使用，默认_doc
</code></pre> 
<h3><a id="4_ES_111"></a>4. 脚本操作ES</h3> 
<h4><a id="41_RESTful_113"></a>4.1 RESTful风格</h4> 
<ul><li> <p>REST（Representational State Transfer），表述性状态转移，是一组架构约束条件和原则。满足这些约束条件和原则的应用程序或设计就是RESTful。就是一种定义接口的规范。</p> </li><li> <p>基于HTTP。</p> </li><li> <p>使用XML格式定义或JSON格式定义。</p> </li><li> <p>每一个URI代表1种资源。</p> </li><li> <p>客户端使用GET、POST、PUT、DELETE 4个表示操作方式的动词对服务端资源进行操作：</p> 
  <ul><li>GET：用来获取资源</li><li>POST：用来新建资源（也可以用于更新资源）</li><li>PUT：用来更新资源</li><li>DELETE：用来删除资源</li></ul> </li></ul> 
<h4><a id="42__131"></a>4.2 操作索引</h4> 
<ul><li>添加索引</li></ul> 
<pre><code>PUT http://ip:端口/索引名称
</code></pre> 
<ul><li>查询索引</li></ul> 
<pre><code>GET http://ip:端口/索引名称               # 查询单个索引信息
GET http://ip:端口/索引名称1,索引名称2...  # 查询多个索引信息
GET http://ip:端口/_all                 # 查询所有索引信息
</code></pre> 
<ul><li>删除索引</li></ul> 
<pre><code>DELETE http://ip:端口/索引名称
</code></pre> 
<ul><li>关闭/打开索引</li></ul> 
<pre><code>POST http://ip:端口/索引名称/_close  # 关闭索引
POST http://ip:端口/索引名称/_open   # 打开索引
</code></pre> 
<h4><a id="43_ES_161"></a>4.3 ES数据类型</h4> 
<h5><a id="1_163"></a>1）简单数据类型</h5> 
<ul><li>字符串</li></ul> 
<pre><code class="prism language-text">text：会分词，不支持聚合					# 聚合：相当于mysql 中的sum（求和）
keyword：不会分词，将全部内容作为一个词条，支持聚合
</code></pre> 
<ul><li> <p>数值</p> </li><li> <p>布尔：boolean</p> </li><li> <p>二进制：binary</p> </li><li> <p>范围类型</p> </li></ul> 
<pre><code>integer_range, float_range, long_range, double_range, date_range 
</code></pre> 
<ul><li>日期:date</li></ul> 
<h5><a id="2_186"></a>2）复杂数据类型</h5> 
<ul><li> <p>数组：[ ] 数组类型的JSON对象</p> </li><li> <p>对象：{ } 单个JSON对象</p> </li></ul> 
<h4><a id="44__192"></a>4.4 操作映射</h4> 
<ul><li>添加映射</li></ul> 
<pre><code class="prism language-json"># 添加索引
<span class="token constant">PUT</span> person
# 查询索引 
<span class="token constant">GET</span> person
# 给索引添加映射
<span class="token constant">PUT</span> <span class="token operator">/</span>person<span class="token operator">/</span>_mapping
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"properties"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span><span class="token string">"text"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"age"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span><span class="token string">"integer"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>创建索引并添加映射</li></ul> 
<pre><code class="prism language-json">#创建索引并添加映射
<span class="token constant">PUT</span> <span class="token operator">/</span>person1
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"age"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
# 查询索引
<span class="token constant">GET</span> person1<span class="token operator">/</span>_mapping
</code></pre> 
<ul><li>添加字段</li></ul> 
<pre><code class="prism language-json">#添加字段
<span class="token constant">PUT</span> <span class="token operator">/</span>person1<span class="token operator">/</span>_mapping
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"address"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="45___250"></a>4.5 操作文档</h4> 
<ul><li>添加文档，指定id</li></ul> 
<pre><code class="prism language-json"># 添加文档
<span class="token constant">POST</span> <span class="token operator">/</span>person1<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">2</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token string">"张三"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"age"</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token string-property property">"address"</span><span class="token operator">:</span><span class="token string">"北京"</span>
<span class="token punctuation">}</span>

# 根据id查询文档
<span class="token constant">GET</span> <span class="token operator">/</span>person1<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
</code></pre> 
<ul><li>添加文档，不指定id</li></ul> 
<pre><code class="prism language-json">#添加文档，不指定id
<span class="token constant">POST</span> <span class="token operator">/</span>person1<span class="token operator">/</span>_doc<span class="token operator">/</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token string">"张三"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"age"</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token string-property property">"address"</span><span class="token operator">:</span><span class="token string">"北京"</span>
<span class="token punctuation">}</span>

#查询所有文档
<span class="token constant">GET</span> <span class="token operator">/</span>person1<span class="token operator">/</span>_search
</code></pre> 
<ul><li>删除文档</li></ul> 
<pre><code class="prism language-json">#删除指定id文档
<span class="token constant">DELETE</span> <span class="token operator">/</span>person1<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
</code></pre> 
<h3><a id="5__289"></a>5. 分词器</h3> 
<h4><a id="51__291"></a>5.1 分词器-介绍</h4> 
<ul><li> <p>IKAnalyzer是一个开源的，基于java语言开发的轻量级的中文分词工具包</p> </li><li> <p>是一个基于Maven构建的项目，具有60万字/秒的高速处理能力</p> </li><li> <p>支持用户词典扩展定义</p> </li><li> <p>下载地址：https://github.com/medcl/elasticsearch-analysis-ik/archive/v7.4.0.zip</p> </li></ul> 
<h4><a id="52_ik_301"></a>5.2 ik分词器安装</h4> 
<p>执行如下命令时如果出现 打包失败（501码）将maven镜像换成阿里云的</p> 
<pre><code>mvn package
</code></pre> 
<pre><code>vim /opt/apache-maven-3.1.1/conf/setting.xml
</code></pre> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirror</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>alimaven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>aliyun maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://maven.aliyun.com/nexus/content/groups/public/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>central<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirror</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="53_ik_322"></a>5.3 ik分词器使用</h4> 
<p>IK分词器有两种分词模式：ik_max_word和ik_smart模式。</p> 
<h5><a id="1ik_max_word_326"></a>1）ik_max_word</h5> 
<p>会将文本做最细粒度的拆分，比如会将“乒乓球明年总冠军”拆分为“乒乓球、乒乓、球、明年、总冠军、冠军。</p> 
<pre><code class="prism language-json">#方式一ik_max_word
<span class="token constant">GET</span> <span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"乒乓球明年总冠军"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ik_max_word分词器执行如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"tokens"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"乒乓球"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"乒乓"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"球"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_CHAR"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"明年"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"总冠军"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">4</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"冠军"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="2ik_smart_391"></a>2）ik_smart</h5> 
<p>会做最粗粒度的拆分，比如会将“乒乓球明年总冠军”拆分为乒乓球、明年、总冠军。</p> 
<pre><code class="prism language-json">#方式二ik_smart
<span class="token constant">GET</span> <span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"乒乓球明年总冠军"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ik_smart分词器执行如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"tokens"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"乒乓球"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"明年"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"总冠军"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>由此可见 使用ik_smart可以将文本"text": "乒乓球明年总冠军"分成了【乒乓球】【明年】【总冠军】</p> 
<p>这样看的话，这样的分词效果达到了我们的要求。</p> 
<h4><a id="54__439"></a>5.4 查询文档</h4> 
<h5><a id="1_441"></a>1）准备工作</h5> 
<ul><li>创建索引，添加映射，并指定分词器为ik分词器</li></ul> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> person2
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"address"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>添加文档</li></ul> 
<pre><code>POST /person2/_doc/1
{
  "name":"张三",
  "age":18,
  "address":"北京海淀区"
}

POST /person2/_doc/2
{
  "name":"李四",
  "age":18,
  "address":"北京朝阳区"
}

POST /person2/_doc/3
{
  "name":"王五",
  "age":18,
  "address":"北京昌平区"
}

</code></pre> 
<ul><li>查询映射</li></ul> 
<pre><code class="prism language-json"><span class="token constant">GET</span> person2
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-6IILwdxn-1663903327653)(img/1580879388109.png)]</p> 
<ul><li>查看分词效果</li></ul> 
<pre><code class="prism language-json"><span class="token constant">GET</span> _analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"北京海淀"</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2term_508"></a>2）term查询</h5> 
<p>​ <mark>term词条</mark>查询不会分析查询条件，只有当词条和查询字符串完全匹配时才匹配搜索。</p> 
<p>​ 查询person2中匹配到"北京"两字的词条</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>person2<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"address"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"北京"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3match_527"></a>3）match查询</h5> 
<p>​ <mark>match全文查询</mark>会分析查询条件，先将查询条件进行分词，然后查询，求并集</p> 
<p>​ 全文查询会分析查询条件，先将查询条件进行分词，然后查询，求并集</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>person2<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"address"</span><span class="token operator">:</span><span class="token string">"北京昌平"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6_JavaApiES_544"></a>6. JavaApi操作ES</h3> 
<h4><a id="61_SpringBootES_546"></a>6.1 SpringBoot整合ES</h4> 
<ol><li> <p>搭建SpringBoot工程</p> </li><li> <p>引入ElasticSearch相关坐标</p> </li></ol> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--引入es的坐标--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<ol start="3"><li>测试</li></ol> 
<p>配置ElasticSearchConfig</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"elasticsearch"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticsearchConfig</span>  <span class="token keyword">extends</span> <span class="token class-name">AbstractElasticsearchConfiguration</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token keyword">private</span> <span class="token class-name">String</span> host <span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> port <span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">elasticsearchClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RestClientBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RestHighLevelClient</span> restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span>
                <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> restHighLevelClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ElasticsearchRestTemplate</span> <span class="token function">elasticsearchRestTemplate</span><span class="token punctuation">(</span><span class="token class-name">RestHighLevelClient</span> elasticsearchClient<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchRestTemplate</span><span class="token punctuation">(</span>elasticsearchClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="62__588"></a>6.2 创建索引</h4> 
<ol><li>添加索引，删除索引</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
* &lt;p&gt;
* 测试 ElasticTemplate 的创建/删除
* &lt;/p&gt;

*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TemplateTest</span> <span class="token keyword">extends</span> <span class="token class-name">SpringBootDemoElasticsearchApplicationTests</span> <span class="token punctuation">{<!-- --></span>
   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">ElasticsearchTemplate</span> esTemplate<span class="token punctuation">;</span>

   <span class="token comment">/**
    * 测试 ElasticTemplate 创建 index
    */</span>
   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCreateIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// 创建索引，会根据Item类的@Document注解信息来创建</span>
       esTemplate<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 配置映射，会根据Item类中的id、Field等字段来自动完成映射</span>
       esTemplate<span class="token punctuation">.</span><span class="token function">putMapping</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 测试 ElasticTemplate 删除 index
    */</span>
   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDeleteIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       esTemplate<span class="token punctuation">.</span><span class="token function">deleteIndex</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="63_Person_624"></a>6.3 创建实体类Person</h4> 
<pre><code>/**
 * &lt;p&gt;
 * 用户实体类
 * &lt;/p&gt;
 *
 * @author yangkai.shen
 * 
 */
@Document(indexName = contact.INDEX_NAME, type = EsConsts.TYPE_NAME, shards = 1, replicas = 0)
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Person {
    /**
     * 主键
     */
    @Id
    private Long id;

    /**
     * 名字
     */
    @Field(type = FieldType.Keyword)
    private String name;

    /**
     * 国家
     */
    @Field(type = FieldType.Keyword)
    private String country;

    /**
     * 年龄
     */
    @Field(type = FieldType.Integer)
    private Integer age;

    /**
     * 生日
     */
    @Field(type = FieldType.Date)
    private Date birthday;

    /**
     * 介绍
     */
    @Field(type = FieldType.Text, analyzer = "ik_smart")
    private String remark;
}
</code></pre> 
<h4><a id="64_PersonDaoPersonRepositoryjava_675"></a>6.4 配置Person的Dao类，PersonRepository.java</h4> 
<pre><code>/**
 * &lt;p&gt;
 * 用户持久层
 * &lt;/p&gt;
  
 */
public interface PersonRepository extends ElasticsearchRepository&lt;Person, Long&gt; {

    /**
     * 根据年龄区间查询
     *
     * @param min 最小值
     * @param max 最大值
     * @return 满足条件的用户列表
     */
    List&lt;Person&gt; findByAgeBetween(Integer min, Integer max);
}
</code></pre> 
<h4><a id="65__697"></a>6.5 添加文档</h4> 
<p>1.添加文档</p> 
<pre><code class="prism language-java">     <span class="token comment">/**
     * 测试新增
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"刘备"</span><span class="token punctuation">,</span> <span class="token string">"蜀国"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"1990-01-02 03:04:05"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"刘备（161年－223年6月10日），即汉昭烈帝（221年－223年在位），又称先主，字玄德，东汉末年幽州涿郡涿县（今河北省涿州市）人，西汉中山靖王刘胜之后，三国时期蜀汉开国皇帝、政治家。\n刘备少年时拜卢植为师；早年颠沛流离，备尝艰辛，投靠过多个诸侯，曾参与镇压黄巾起义。先后率军救援北海相孔融、徐州牧陶谦等。陶谦病亡后，将徐州让与刘备。赤壁之战时，刘备与孙权联盟击败曹操，趁势夺取荆州。而后进取益州。于章武元年（221年）在成都称帝，国号汉，史称蜀或蜀汉。《三国志》评刘备的机权干略不及曹操，但其弘毅宽厚，知人待士，百折不挠，终成帝业。刘备也称自己做事“每与操反，事乃成尔”。\n章武三年（223年），刘备病逝于白帝城，终年六十三岁，谥号昭烈皇帝，庙号烈祖，葬惠陵。后世有众多文艺作品以其为主角，在成都武侯祠有昭烈庙为纪念。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> save <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【save】= {}"</span><span class="token punctuation">,</span> save<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="66__713"></a>6.6 修改、查询、删除文档</h4> 
<ol><li>修改文档：添加文档时，如果id存在则修改，id不存在则添加</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 修改文档：添加文档时，如果id存在则修改，id不存在则添加
 */</span>
 <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        repo<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>person <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            person<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">getRemark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n更新更新更新更新更新"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Person</span> save <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【save】= {}"</span><span class="token punctuation">,</span> save<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>根据id查询文档</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 根据id查询文档
 */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>根据id删除文档</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 根据id删除文档
 */</span>
  <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        repo<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<h4><a id="67_ElasticSearch_758"></a>6.7 ElasticSearch批量操作</h4> 
<h6><a id="_760"></a>查询所有</h6> 
<p>JavaAPI操作</p> 
<pre><code class="prism language-java"><span class="token comment">//查询所有</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> persons <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Person</span> person <span class="token operator">:</span> persons<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<h6><a id="_776"></a>批量新增</h6> 
<p>JavaAPI操作</p> 
<pre><code>    @Test
    public void saveList() {
        List&lt;Person&gt; personList = Lists.newArrayList();
        personList.add(new Person(2L, "曹操", "魏国", 20, DateUtil.parse("1988-01-02 03:04:05"), "曹操（155年－220年3月15日），字孟德，一名吉利，小字阿瞒，沛国谯县（今安徽亳州）人。东汉末年杰出的政治家、军事家、文学家、书法家，三国中曹魏政权的奠基人。\n曹操曾担任东汉丞相，后加封魏王，奠定了曹魏立国的基础。去世后谥号为武王。其子曹丕称帝后，追尊为武皇帝，庙号太祖。\n东汉末年，天下大乱，曹操以汉天子的名义征讨四方，对内消灭二袁、吕布、刘表、马超、韩遂等割据势力，对外降服南匈奴、乌桓、鲜卑等，统一了中国北方，并实行一系列政策恢复经济生产和社会秩序，扩大屯田、兴修水利、奖励农桑、重视手工业、安置流亡人口、实行“租调制”，从而使中原社会渐趋稳定、经济出现转机。黄河流域在曹操统治下，政治渐见清明，经济逐步恢复，阶级压迫稍有减轻，社会风气有所好转。曹操在汉朝的名义下所采取的一些措施具有积极作用。\n曹操军事上精通兵法，重贤爱才，为此不惜一切代价将看中的潜能分子收于麾下；生活上善诗歌，抒发自己的政治抱负，并反映汉末人民的苦难生活，气魄雄伟，慷慨悲凉；散文亦清峻整洁，开启并繁荣了建安文学，给后人留下了宝贵的精神财富，鲁迅评价其为“改造文章的祖师”。同时曹操也擅长书法，唐朝张怀瓘在《书断》将曹操的章草评为“妙品”。"));
        personList.add(new Person(3L, "孙权", "吴国", 19, DateUtil.parse("1989-01-02 03:04:05"), "孙权（182年－252年5月21日），字仲谋，吴郡富春（今浙江杭州富阳区）人。三国时代孙吴的建立者（229年－252年在位）。\n孙权的父亲孙坚和兄长孙策，在东汉末年群雄割据中打下了江东基业。建安五年（200年），孙策遇刺身亡，孙权继之掌事，成为一方诸侯。建安十三年（208年），与刘备建立孙刘联盟，并于赤壁之战中击败曹操，奠定三国鼎立的基础。建安二十四年（219年），孙权派吕蒙成功袭取刘备的荆州，使领土面积大大增加。\n黄武元年（222年），孙权被魏文帝曹丕册封为吴王，建立吴国。同年，在夷陵之战中大败刘备。黄龙元年（229年），在武昌正式称帝，国号吴，不久后迁都建业。孙权称帝后，设置农官，实行屯田，设置郡县，并继续剿抚山越，促进了江南经济的发展。在此基础上，他又多次派人出海。黄龙二年（230年），孙权派卫温、诸葛直抵达夷州。\n孙权晚年在继承人问题上反复无常，引致群下党争，朝局不稳。太元元年（252年）病逝，享年七十一岁，在位二十四年，谥号大皇帝，庙号太祖，葬于蒋陵。\n孙权亦善书，唐代张怀瓘在《书估》中将其书法列为第三等。"));
        personList.add(new Person(4L, "诸葛亮", "蜀国", 16, DateUtil.parse("1992-01-02 03:04:05"), "诸葛亮（181年-234年10月8日），字孔明，号卧龙，徐州琅琊阳都（今山东临沂市沂南县）人，三国时期蜀国丞相，杰出的政治家、军事家、外交家、文学家、书法家、发明家。\n早年随叔父诸葛玄到荆州，诸葛玄死后，诸葛亮就在襄阳隆中隐居。后刘备三顾茅庐请出诸葛亮，联孙抗曹，于赤壁之战大败曹军。形成三国鼎足之势，又夺占荆州。建安十六年（211年），攻取益州。继又击败曹军，夺得汉中。蜀章武元年（221年），刘备在成都建立蜀汉政权，诸葛亮被任命为丞相，主持朝政。蜀后主刘禅继位，诸葛亮被封为武乡侯，领益州牧。勤勉谨慎，大小政事必亲自处理，赏罚严明；与东吴联盟，改善和西南各族的关系；实行屯田政策，加强战备。前后六次北伐中原，多以粮尽无功。终因积劳成疾，于蜀建兴十二年（234年）病逝于五丈原（今陕西宝鸡岐山境内），享年54岁。刘禅追封其为忠武侯，后世常以武侯尊称诸葛亮。东晋政权因其军事才能特追封他为武兴王。\n诸葛亮散文代表作有《出师表》《诫子书》等。曾发明木牛流马、孔明灯等，并改造连弩，叫做诸葛连弩，可一弩十矢俱发。诸葛亮一生“鞠躬尽瘁、死而后已”，是中国传统文化中忠臣与智者的代表人物。"));
        Iterable&lt;Person&gt; people = repo.saveAll(personList);
        log.info("【people】= {}", people);
    }
</code></pre> 
<h6><a id="_792"></a>批量删除</h6> 
<p>JavaAPI操作</p> 
<pre><code>@Test
public void deleteAll(){
  repo.deleteAll(repo.findAll());
}
</code></pre> 
<h4><a id="68_termQuery_803"></a>6.8 termQuery-词条查询</h4> 
<p><mark>term查询不会对查询条件进行分词</mark></p> 
<h6><a id="1_807"></a>1）脚本操作</h6> 
<p>ElasticSearch两个数据类型</p> 
<pre><code>text：会分词，不支持聚合
keyword：不会分词，将全部内容作为一个词条，支持聚合
</code></pre> 
<p>查询title：ES对text数据分词</p> 
<pre><code>GET contact/_search
{
  "query": {
    "term": {
      "name": {
        "value": "曹操"
      }
    }
  }
}
</code></pre> 
<p>查询address：ES对keyword没有分词</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"country"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"魏国"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2JavaAPI_846"></a>2）JavaAPI操作</h6> 
<pre><code class="prism language-java">
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">advanceSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// QueryBuilders 提供了很多静态方法，可以实现大部分查询条件的封装</span>
        <span class="token class-name">MatchQueryBuilder</span> queryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"sunquan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【queryBuilder】= {}"</span><span class="token punctuation">,</span> queryBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        repo<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>person <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【person】= {}"</span><span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="69__859"></a>6.9 分页查询</h4> 
<pre><code>@Autowired
private PersonDao personDao;

@Test
public void findByPageable(){
    //设置排序(排序方式，正序还是倒序，排序的 id)
    Sort sort = Sort.by(Sort.Direction.DESC,"id");
    int currentPage=0;//当前页，第一页从 0 开始， 1 表示第二页
    int pageSize = 5;//每页显示多少条
    //设置查询分页
    PageRequest pageRequest = PageRequest.of(currentPage, pageSize,sort);
    //分页查询
    Page&lt;Person&gt; personPage = repo.findAll(pageRequest);
    for (Person person : personPage.getContent()) {
        System.out.println(person);
    }
}
</code></pre> 
<h4><a id="610termQuery_878"></a>6.10termQuery加分页</h4> 
<pre><code>  @Test
    public void customAdvanceSelect() {
        // 构造查询条件
        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
        // 添加基本的分词条件
        queryBuilder.withQuery(QueryBuilders.termQuery("remark", "donghan"));
        // 排序条件
        queryBuilder.withSort(SortBuilders.fieldSort("age").order(SortOrder.DESC));
        // 分页条件
        queryBuilder.withPageable(PageRequest.of(0, 2));
        Page&lt;Person&gt; people = repo.search(queryBuilder.build());
        log.info("【people】总条数 = {}", people.getTotalElements());
        log.info("【people】总页数 = {}", people.getTotalPages());
        people.forEach(person -&gt; log.info("【person】= {}，年龄 = {}", person.getName(), person.getAge()));
    }
</code></pre> 
<h4><a id="611_matchQuery_895"></a>6.11 matchQuery-分词查询</h4> 
<ol><li>会对查询条件进行分词。</li><li>然后将分词后的查询条件和词条进行等值匹配</li><li>默认取并集（OR）</li></ol> 
<h5><a id="1_901"></a>1）脚本操作</h5> 
<pre><code># match查询
GET contact/_search
{
  "query": {
    "match": {
      "name": "曹操"
    }
  },
  "size": 500
}
</code></pre> 
<h5><a id="2JavaAPI_916"></a>2）JavaAPI操作</h5> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">advanceSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// QueryBuilders 提供了很多静态方法，可以实现大部分查询条件的封装</span>
        <span class="token class-name">MatchQueryBuilder</span> queryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"曹操"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【queryBuilder】= {}"</span><span class="token punctuation">,</span> queryBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        repo<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>person <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【person】= {}"</span><span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>总结：</strong></p> 
<ul><li>term query：对查询条件不分词查询</li><li>match query：对查询条件分词查询</li></ul> 
<h4><a id="612__933"></a>6.12 模糊查询</h4> 
<h5><a id="1_935"></a>1）脚本操作</h5> 
<h6><a id="1_wildcard_937"></a>1. wildcard查询</h6> 
<p>wildcard查询：会对查询条件进行分词。还可以使用通配符 ?（任意单个字符） 和 * （0个或多个字符）</p> 
<pre><code>"*华*"  包含华字的
"华*"   华字后边多个字符
"华?"  华字后边多个字符
"*华"或"?华" 会引发全表（全索引）扫描 注意效率问题
</code></pre> 
<pre><code class="prism language-json"># wildcard 查询。查询条件分词，模糊查询
<span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"wildcard"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"孙*"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2__962"></a>2. 正则查询</h6> 
<pre><code>\W：匹配包括下划线的任何单词字符，等价于 [A-Z a-z 0-9_]   开头的反斜杠是转义符

+号多次出现

(.)*为任意字符
正则查询取决于正则表达式的效率
</code></pre> 
<pre><code class="prism language-json"><span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"regexp"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"\\w+(.)*"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h6><a id="3__985"></a>3. 前缀查询</h6> 
<p>对keyword类型支持比较好</p> 
<pre><code class="prism language-json"># 前缀查询 对keyword类型支持比较好
<span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"prefix"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"张"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2JavaAPI_1004"></a>2）JavaAPI操作</h5> 
<pre><code class="prism language-java"><span class="token comment">//模糊查询</span>
<span class="token class-name">WildcardQueryBuilder</span> query <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">wildcardQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"孙"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//正则查询</span>
<span class="token class-name">RegexpQueryBuilder</span> query <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">regexpQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"\\w+(.)*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//前缀查询</span>
<span class="token class-name">PrefixQueryBuilder</span> query <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">prefixQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"孙"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="613__1015"></a>6.13 范围&amp;排序查询</h4> 
<h5><a id="1_1017"></a>1）脚本操作</h5> 
<pre><code class="prism language-json"># 范围查询

<span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"age"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"gte"</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
        <span class="token string-property property">"lte"</span><span class="token operator">:</span> <span class="token number">19</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2JavaAPI_1042"></a>2）JavaAPI操作</h5> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * 测试普通查询，按生日倒序
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        repo<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Sort</span><span class="token punctuation">.</span><span class="token function">by</span><span class="token punctuation">(</span><span class="token class-name">Sort<span class="token punctuation">.</span>Direction</span><span class="token punctuation">.</span>DESC<span class="token punctuation">,</span> <span class="token string">"birthday"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>person <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{} 生日: {}"</span><span class="token punctuation">,</span> person<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">formatDateTime</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">getBirthday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token comment">/**
     * 自定义查询，根据年龄范围查询
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">customSelectRangeOfAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        repo<span class="token punctuation">.</span><span class="token function">findByAgeBetween</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>person <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{} 年龄: {}"</span><span class="token punctuation">,</span> person<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> person<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="614_queryString_1063"></a>6.14 queryString-查询</h4> 
<p>queryString：在多个字段中进行查询</p> 
<ul><li> <p>会对查询条件进行分词。</p> </li><li> <p>然后将分词后的查询条件和词条进行等值匹配</p> </li><li> <p>默认取并集（OR）</p> </li><li> <p>可以指定多个查询字段</p> </li></ul> 
<h6><a id="1_1075"></a>1）脚本操作</h6> 
<p><mark>query_string：识别query中的连接符（or 、and）</mark></p> 
<pre><code class="prism language-json"># queryString

<span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query_string"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"country"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
      <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"张三 AND 中国"</span>	# 字段中要同时包含张三和中国
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark>simple_query_string：不识别query中的连接符（or 、and），查询时会将 “华为”、“and”、“手机”分别进行查询</mark></p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"simple_query_string"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"country"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
      <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"张三 AND 中国"</span>	
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark>query_string：有default_operator连接符的脚本</mark></p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query_string"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"country"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"default_operator"</span><span class="token operator">:</span> <span class="token string">"AND"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h6><a id="2JavaAPI_1123"></a>2）JavaAPI操作</h6> 
<pre><code class="prism language-java"><span class="token class-name">QueryStringQueryBuilder</span> query <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">queryStringQuery</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">defaultOperator</span><span class="token punctuation">(</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>AND<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><mark>注意</mark></p> 
<blockquote> 
 <p>query中的<mark>or</mark>或<mark>and</mark>是在查询时是判断字段中是（or）或（and）包含查询条件</p> 
 <p>efault_operator的<mark>or</mark>和<mark>and</mark>是对结果进行 并集（or）、交集（and）</p> 
</blockquote> 
<h4><a id="615__1139"></a>6.15 布尔查询-脚本</h4> 
<p>boolQuery：对多个查询条件连接。</p> 
<ul><li> <p>must（and）：条件必须成立</p> </li><li> <p>must_not（not）：条件必须不成立</p> </li><li> <p>should（or）：条件可以成立</p> </li><li> <p>filter：条件必须成立，性能比must高。不会计算得分</p> </li></ul> 
<p>**得分：**值条件匹配度，匹配度越高，得分越高</p> 
<h5><a id="1_1153"></a>1）脚本操作</h5> 
<pre><code class="prism language-json"># boolquery
#must和filter配合使用时，must 默认数组形式
<span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"张三"</span>		# 查询名称为张三
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"filter"</span><span class="token operator">:</span><span class="token punctuation">[</span> 
        <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"country"</span><span class="token operator">:</span> <span class="token string">"中国"</span>		# 国家在上海
        <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"range"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>				
          <span class="token string-property property">"age"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>					# 年龄在<span class="token number">10</span><span class="token operator">-</span><span class="token number">50</span>之间
            <span class="token string-property property">"gte"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token string-property property">"lte"</span><span class="token operator">:</span> <span class="token number">50</span>
         <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
#filter 单独使用   filter可以是单个条件，也可多个条件（数组形式）
<span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"张三"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2JavaAPI_1209"></a>2）JavaAPI</h5> 
<p>布尔查询：boolQuery</p> 
<ol><li>询name名称为:张三</li><li>查询国家包含：中国</li><li>查询年龄在：10-50</li></ol> 
<p>must 、filter为连接方式</p> 
<p>term、match为不同的查询方式</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.构建boolQuery</span>
        <span class="token class-name">BoolQueryBuilder</span> query <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.构建各个查询条件</span>
        <span class="token comment">//2.1 查询name名称为:张三</span>
        <span class="token class-name">QueryBuilder</span> termQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>termQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.2. 查询国家包含：中国</span>
        <span class="token class-name">QueryBuilder</span> matchQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">,</span><span class="token string">"中国"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>matchQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.3 查询年龄在：10-50</span>
        <span class="token class-name">QueryBuilder</span> rangeQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RangeQueryBuilder</span><span class="token punctuation">)</span> rangeQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RangeQueryBuilder</span><span class="token punctuation">)</span> rangeQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>rangeQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> persons <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Person</span> person <span class="token operator">:</span> persons<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="616__1250"></a>6.16 高亮查询</h4> 
<p>高亮三要素：</p> 
<ul><li> <p>高亮字段</p> </li><li> <p>添加前缀标签</p> </li><li> <p>添加后缀标签</p> </li></ul> 
<p>默认前后缀 ：em</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>张三<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="1_1266"></a>1）脚本操作</h5> 
<pre><code class="prism language-json"><span class="token constant">GET</span> goods<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"张三"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;font color='red'&gt;"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/font&gt;"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2JavaAPI_1287"></a>2）JavaAPI操作</h5> 
<p>高亮查询操作步骤：</p> 
<ol><li> <p>设置高亮</p> </li><li> <p>将高亮的字段数据，替换原有数据</p> </li></ol> 
<pre><code class="prism language-java">   <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 构建查询条件</span>
        <span class="token class-name">NativeSearchQueryBuilder</span> queryBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加基本分词查询</span>
        <span class="token class-name">String</span> preTags <span class="token operator">=</span> <span class="token string">"&lt;strong&gt;"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> postTags <span class="token operator">=</span> <span class="token string">"&lt;/strong&gt;"</span><span class="token punctuation">;</span>
        <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span>preTags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置前缀</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span>postTags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置后缀</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置高亮字段</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">"张三"</span><span class="token punctuation">;</span>
        queryBuilder<span class="token punctuation">.</span><span class="token function">withQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryBuilder<span class="token punctuation">.</span><span class="token function">withHighlightBuilder</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">NativeSearchQuery</span> query <span class="token operator">=</span> queryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SearchHits</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> search <span class="token operator">=</span> elasticsearchRestTemplate<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> 			         <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> totalHits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"totalHits = "</span> <span class="token operator">+</span> totalHits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchHit</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">SearchHit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Person</span> content <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> firstname <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getHighlightField</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> firstname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="617__1330"></a>6.17 聚合查询-脚本</h4> 
<ul><li> <p>指标聚合：相当于MySQL的聚合函数。max、min、avg、sum等</p> </li><li> <p>桶聚合：相当于MySQL的 group by 操作。（不要对text类型的数据进行分组，会失败）</p> </li></ul> 
<h5><a id="1_1336"></a>1）脚本操作</h5> 
<pre><code class="prism language-json"># 聚合查询
# 指标聚合 聚合函数
<span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"张三"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"max_age"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"max"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"age"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-json"># 桶聚合  分组
<span class="token constant">GET</span> contact<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"张三"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"person_country"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"country"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">100</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2JavaAPI_1378"></a>2）JavaAPI</h5> 
<pre><code class="prism language-java">
    <span class="token comment">/**
     * 测试聚合，测试平均年龄
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">agg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 构造查询条件</span>
        <span class="token class-name">NativeSearchQueryBuilder</span> queryBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 不查询任何结果</span>
        queryBuilder<span class="token punctuation">.</span><span class="token function">withSourceFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FetchSourceFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 平均年龄</span>
        queryBuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">"avg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【queryBuilder】= {}"</span><span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> people <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> repo<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> avgAge <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InternalAvg</span><span class="token punctuation">)</span> people<span class="token punctuation">.</span><span class="token function">getAggregation</span><span class="token punctuation">(</span><span class="token string">"avg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【avgAge】= {}"</span><span class="token punctuation">,</span> avgAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 测试高级聚合查询，每个国家的人有几个，每个国家的平均年龄是多少
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">advanceAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 构造查询条件</span>
        <span class="token class-name">NativeSearchQueryBuilder</span> queryBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 不查询任何结果</span>
        queryBuilder<span class="token punctuation">.</span><span class="token function">withSourceFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FetchSourceFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. 添加一个新的聚合，聚合类型为terms，聚合名称为country，聚合字段为age</span>
        queryBuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">)</span>
                <span class="token comment">// 2. 在国家聚合桶内进行嵌套聚合，求平均年龄</span>
                <span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">"avg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【queryBuilder】= {}"</span><span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 查询</span>
        <span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> people <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> repo<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 解析</span>
        <span class="token comment">// 4.1. 从结果中取出名为 country 的那个聚合，因为是利用String类型字段来进行的term聚合，所以结果要强转为StringTerm类型</span>
        <span class="token class-name">StringTerms</span> country <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> people<span class="token punctuation">.</span><span class="token function">getAggregation</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2. 获取桶</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> country<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 4.3. 获取桶中的key，即国家名称  4.4. 获取桶中的文档数量</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{} 总共有 {} 人"</span><span class="token punctuation">,</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.5. 获取子聚合结果：</span>
            <span class="token class-name">InternalAvg</span> avg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InternalAvg</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"avg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"平均年龄：{}"</span><span class="token punctuation">,</span> avg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="7__1441"></a>7 重建索引</h3> 
<p>在项目开发过程中，如果需要更新索引，一般情况ES是不允许映射的已有字段进行修改（只能添加新的字段），此时可以通过新建索引再重新导入数据的方式进行。</p> 
<p>步骤可以共3步：</p> 
<pre><code>1. 新建索引
2. 导入数据
3. 创建别名，保证业务代码不用变更
</code></pre> 
<p>准备环境</p> 
<pre><code class="prism language-json"># <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>重建索引<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>

# 新建student_index_v1。索引名称必须全部小写

<span class="token constant">PUT</span> student_index_v1
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"birthday"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
#查看 student_index_v1 结构
<span class="token constant">GET</span> student_index_v1
#添加数据
<span class="token constant">PUT</span> student_index_v1<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"birthday"</span><span class="token operator">:</span><span class="token string">"1999-11-11"</span>
<span class="token punctuation">}</span>
#查看数据
<span class="token constant">GET</span> student_index_v1<span class="token operator">/</span>_search

#添加数据
<span class="token constant">PUT</span> student_index_v1<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"birthday"</span><span class="token operator">:</span><span class="token string">"1999年11月11日"</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol><li>重建索引</li><li>将student_index_v1数据拷贝到 student_index_v2</li></ol> 
<pre><code class="prism language-json"># 业务变更了，需要改变birthday字段的类型为text

# <span class="token number">1.</span> 创建新的索引 student_index_v2
# <span class="token number">2.</span> 将student_index_v1 数据拷贝到 student_index_v2

# 创建新的索引 student_index_v2
<span class="token constant">PUT</span> student_index_v2
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"birthday"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
# 将student_index_v1 数据拷贝到 student_index_v2
# _reindex 拷贝数据
<span class="token constant">POST</span> _reindex
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"source"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"student_index_v1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"dest"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"student_index_v2"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">GET</span> student_index_v2<span class="token operator">/</span>_search



<span class="token constant">PUT</span> student_index_v2<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">2</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"birthday"</span><span class="token operator">:</span><span class="token string">"1999年11月11日"</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li>创建索引库别名：</li></ol> 
<p>注意：DELETE student_index_v1 这一操作将删除student_index_v1索引库，并不是删除别名</p> 
<pre><code class="prism language-json"># 思考： 现在java代码中操作es，还是使用的实student_index_v1老的索引名称。
# <span class="token number">1.</span> 改代码（不推荐）
# <span class="token number">2.</span> 索引别名（推荐）

# 步骤：
# <span class="token number">0.</span> 先删除student_index_v1
# <span class="token number">1.</span> 给student_index_v2起个别名 student_index_v1



# 先删除student_index_v1
<span class="token constant">DELETE</span> student_index_v1 这一操作将删除student_index_v1索引库
# 索引库默认的别名与索引库同名，无法删除
# 给student_index_v1起个别名 student_index_v11
<span class="token constant">POST</span> student_index_v2<span class="token operator">/</span>_alias<span class="token operator">/</span>student_index_v11
#测试删除命令
<span class="token constant">POST</span> <span class="token operator">/</span>_aliases
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"remove"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"student_index_v1"</span><span class="token punctuation">,</span> <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"student_index_v11"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

# 给student_index_v2起个别名 student_index_v1
<span class="token constant">POST</span> student_index_v2<span class="token operator">/</span>_alias<span class="token operator">/</span>student_index_v1

#查询别名
<span class="token constant">GET</span> goods<span class="token operator">/</span>_alias<span class="token operator">/</span>

<span class="token constant">GET</span> student_index_v1<span class="token operator">/</span>_search
<span class="token constant">GET</span> student_index_v2<span class="token operator">/</span>_search
</code></pre> 
<p>index_v1/_doc/1<br> {<!-- --><br> “birthday”:“1999-11-11”<br> }<br> #查看数据<br> GET student_index_v1/_search</p> 
<p>#添加数据<br> PUT student_index_v1/_doc/1<br> {<!-- --><br> “birthday”:“1999年11月11日”<br> }</p> 
<pre><code>
1. 重建索引
2. 将student_index_v1数据拷贝到 student_index_v2

```json
# 业务变更了，需要改变birthday字段的类型为text

# 1. 创建新的索引 student_index_v2
# 2. 将student_index_v1 数据拷贝到 student_index_v2

# 创建新的索引 student_index_v2
PUT student_index_v2
{
  "mappings": {
    "properties": {
      "birthday":{
        "type": "text"
      }
    }
  }
}
# 将student_index_v1 数据拷贝到 student_index_v2
# _reindex 拷贝数据
POST _reindex
{
  "source": {
    "index": "student_index_v1"
  },
  "dest": {
    "index": "student_index_v2"
  }
}

GET student_index_v2/_search



PUT student_index_v2/_doc/2
{
  "birthday":"1999年11月11日"
}

</code></pre> 
<ol start="3"><li>创建索引库别名：</li></ol> 
<p>注意：DELETE student_index_v1 这一操作将删除student_index_v1索引库，并不是删除别名</p> 
<pre><code class="prism language-json"># 思考： 现在java代码中操作es，还是使用的实student_index_v1老的索引名称。
# <span class="token number">1.</span> 改代码（不推荐）
# <span class="token number">2.</span> 索引别名（推荐）

# 步骤：
# <span class="token number">0.</span> 先删除student_index_v1
# <span class="token number">1.</span> 给student_index_v2起个别名 student_index_v1



# 先删除student_index_v1
<span class="token constant">DELETE</span> student_index_v1 这一操作将删除student_index_v1索引库
# 索引库默认的别名与索引库同名，无法删除
# 给student_index_v1起个别名 student_index_v11
<span class="token constant">POST</span> student_index_v2<span class="token operator">/</span>_alias<span class="token operator">/</span>student_index_v11
#测试删除命令
<span class="token constant">POST</span> <span class="token operator">/</span>_aliases
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"remove"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"student_index_v1"</span><span class="token punctuation">,</span> <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"student_index_v11"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

# 给student_index_v2起个别名 student_index_v1
<span class="token constant">POST</span> student_index_v2<span class="token operator">/</span>_alias<span class="token operator">/</span>student_index_v1

#查询别名
<span class="token constant">GET</span> goods<span class="token operator">/</span>_alias<span class="token operator">/</span>

<span class="token constant">GET</span> student_index_v1<span class="token operator">/</span>_search
<span class="token constant">GET</span> student_index_v2<span class="token operator">/</span>_search
</code></pre> 
<p>github 源码地址：https://github.com/xkcoding/spring-boot-demo/tree/master/demo-elasticsearch</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ab694d696bcedf4341805811341bf81c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Visual Studio下载与安装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/add20721182a84f2e162c4658fe05a1e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何用c语言打印hello world</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>