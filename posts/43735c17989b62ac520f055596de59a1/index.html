<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s的初始及搭建 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s的初始及搭建" />
<meta property="og:description" content="(kubernetes)k8s 1.初识k8s 1.1.k8s是什么？ ​ kubernetes，简称K8s，是用8代替8个字符“ubernete”而成的缩写。是一个开源的，由go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful）,Kubernetes提供了应用部署，规划，更新，维护的一种机制。
k8s是一种容器的管理，规划，扩展的技术。
1.2.环境搭建 部署Kubernetes环境（集群）主要有多种方式:
minikube(用的不多)
minikube可以在本地运行Kubernetes的工具，minikube可以在个人计算机(包括 Windows ,macOS和Linux PC)上运行一个单节点Kubernetes集群，
以便您可以试用Kubernetes或进行日常开发工作，不可以用于生产。
网页内操作（一般用于测试代码）：https://kubernetes.io/zh/docs/tutorials/hello-minikube/
kind（用的不多）
Kind和minikube类似的工具，让你在本地计算机上运行Kubernetes,此工具需要安装并配置Docker ;
详细：https://kind.sigs.k8s.io/ （没有远程操作）
kubeadm(常用)
Kubeadm是一个K8s部署工具，提供kubeadm init和 kubeadm join两个操作命令，可以快速部署一个Kubernetes集群;可以用于生产
https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/
二进制包(适用于老手)
从Github下载发行版的二进制包，手动部署安装每个组件，组成Kubernetes集群，步骤比较繁琐,r但是能让你对各个组件有更清晰的认识
yum安装(版本太老)
通过yum安装Kubernetes的每个组件，组成Kubernetes集群，不过yum源里面的k8s版本已经比较老的，所以这种方式用得也比较少了
第三方工具
有一些大神封装了一些工具，利用这些工具进行k8s 环境的安装
花钱购买
直接购买类似阿里云这样的公有云平台k8s，一键搞定;
1.3.用kubeadm部署k8s kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具这工具能通过两条指令完成一个kubernetes集群的部署;
1、创建一个Master节点∶
kubeadm init 2、将Node节点加入到 Master集群中∶
$ kubeadm join &lt;Master 节点的IP和端口&gt; 配置要求：
(1)一台或多台机器，操作系统CentOS 7.x-86_x64
(2）硬件配置:内存2GB或2G&#43;，CPU 2核或CPU2核&#43;;( 3)集群内各个机器之间能相互通信;
(4）集群内各个机器可以访问外网，需要拉取镜像;( 5）禁止swap分区;
为了方便我们在xshell里开启全部会话： 查看 &gt; 攥写 &gt; 攥写 &gt; 左下方图标 &gt; 全部会话
这样，我们在底下编写命令，上面所有会话都执行。
对master和node都设置 #1.关闭防火墙 systemctl stop firewalld systemctl disable firewalld #或者设置空规则 systemctl stop firewalld &amp;&amp; systemctl disable firewalld yum -y install iptables-services &amp;&amp; systemctl start iptables &amp;&amp; systemctl enable iptables &amp;&amp; iptables -F &amp;&amp; service iptables save #关闭selinux setenforce 0 #临时 sed -i &#39;s/enforcing/disabled/ &#39; /etc/selinux/config #永久 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/43735c17989b62ac520f055596de59a1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-15T14:50:11+08:00" />
<meta property="article:modified_time" content="2021-10-15T14:50:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s的初始及搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="kubernetesk8s_2"></a>(kubernetes)k8s</h2> 
<h3><a id="1k8s_4"></a>1.初识k8s</h3> 
<h4><a id="11k8s_6"></a>1.1.k8s是什么？</h4> 
<p>​ kubernetes，简称K8s，是用8代替8个字符“ubernete”而成的缩写。是一个开源的，由go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful）,Kubernetes提供了应用部署，规划，更新，维护的一种机制。</p> 
<p>k8s是一种容器的管理，规划，扩展的技术。</p> 
<h4><a id="12_14"></a>1.2.环境搭建</h4> 
<p>部署Kubernetes环境（集群）主要有多种方式:</p> 
<blockquote> 
 <p>minikube(用的不多)</p> 
</blockquote> 
<p>minikube可以在本地运行Kubernetes的工具，minikube可以在个人计算机(包括 Windows ,macOS和Linux PC)上运行一个单节点Kubernetes集群，<br> 以便您可以试用Kubernetes或进行日常开发工作，不可以用于生产。</p> 
<p>网页内操作（一般用于测试代码）：https://kubernetes.io/zh/docs/tutorials/hello-minikube/</p> 
<blockquote> 
 <p>kind（用的不多）</p> 
</blockquote> 
<p>Kind和minikube类似的工具，让你在本地计算机上运行Kubernetes,此工具需要安装并配置Docker ;<br> 详细：https://kind.sigs.k8s.io/ （没有远程操作）</p> 
<blockquote> 
 <p>kubeadm(常用)</p> 
</blockquote> 
<p>Kubeadm是一个K8s部署工具，提供kubeadm init和 kubeadm join两个操作命令，可以快速部署一个Kubernetes集群;可以用于生产</p> 
<p>https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</p> 
<blockquote> 
 <p>二进制包(适用于老手)</p> 
</blockquote> 
<p>从Github下载发行版的二进制包，手动部署安装每个组件，组成Kubernetes集群，步骤比较繁琐,r但是能让你对各个组件有更清晰的认识</p> 
<blockquote> 
 <p>yum安装(版本太老)</p> 
</blockquote> 
<p>通过yum安装Kubernetes的每个组件，组成Kubernetes集群，不过yum源里面的k8s版本已经比较老的，所以这种方式用得也比较少了</p> 
<blockquote> 
 <p>第三方工具</p> 
</blockquote> 
<p>有一些大神封装了一些工具，利用这些工具进行k8s 环境的安装</p> 
<blockquote> 
 <p>花钱购买</p> 
</blockquote> 
<p>直接购买类似阿里云这样的公有云平台k8s，一键搞定;</p> 
<h4><a id="13kubeadmk8s_53"></a>1.3.用kubeadm部署k8s</h4> 
<p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具这工具能通过两条指令完成一个kubernetes集群的部署;<br> 1、创建一个Master节点∶</p> 
<pre><code>kubeadm init
</code></pre> 
<p>2、将Node节点加入到 Master集群中∶</p> 
<pre><code>$ kubeadm join &lt;Master 节点的IP和端口&gt;
</code></pre> 
<blockquote> 
 <p>配置要求：</p> 
</blockquote> 
<p>(1)一台或多台机器，操作系统CentOS 7.x-86_x64</p> 
<p>(2）硬件配置:内存2GB或2G+，CPU 2核或CPU2核+;( 3)集群内各个机器之间能相互通信;</p> 
<p>(4）集群内各个机器可以访问外网，需要拉取镜像;( 5）禁止swap分区;</p> 
<p>为了方便我们在xshell里开启全部会话： 查看 &gt; 攥写 &gt; 攥写 &gt; 左下方图标 &gt; 全部会话</p> 
<p>这样，我们在底下编写命令，上面所有会话都执行。</p> 
<pre><code class="prism language-shell">
对master和node都设置
<span class="token comment">#1.关闭防火墙</span>

systemctl stop firewalld

systemctl disable firewalld
<span class="token comment">#或者设置空规则</span>
systemctl stop firewalld <span class="token operator">&amp;&amp;</span> systemctl disable firewalld
yum -y <span class="token function">install</span> iptables-services <span class="token operator">&amp;&amp;</span> systemctl start iptables <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> iptables <span class="token operator">&amp;&amp;</span> iptables -F <span class="token operator">&amp;&amp;</span> <span class="token function">service</span> iptables save


<span class="token comment">#关闭selinux</span>
 
setenforce <span class="token number">0</span> <span class="token comment">#临时</span>
<span class="token function">sed</span> -i <span class="token string">'s/enforcing/disabled/ '</span> /etc/selinux/config <span class="token comment">#永久</span>
<span class="token number">1</span>.selinux这个是用来加强安全性的一个组件，挺复杂的，一般直接禁用
<span class="token number">2</span>.关闭selinux以允许容器访问宿主机的文件系统

<span class="token comment">#关闭swap ( k8s禁止虚拟内存以提高性能)</span>
<span class="token function">sed</span> -ri <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab <span class="token comment">#永久</span>
swapoff -a <span class="token comment">#临时</span>
注：
<span class="token number">1</span>.swap相当于“虚拟内存”。当物理内存不足时，拿出部分硬盘空间当SWAP分区（虚拟成内存）使用，从而解决内存容量不足的情况。
<span class="token number">2</span>.kubelet 在 <span class="token number">1.8</span> 版本以后强制要求 swap 必须关闭
<span class="token number">3</span>.free -m 命令可以查看交换区的空间大小，我们注释完再使用这个命令发现交换区swap还没关闭，因为需要重启才生效

<span class="token comment"># 	设置系统主机名以及Host文件</span>

hostnamectl set-hostname k8s-master01
hostnamectl set-hostname k8s-node01
hostnamectl set-hostname k8s-node02

<span class="token comment">#添加hosts</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
master主机ip k8smaster1
node主机ip   k8snode1
node主机ip   k8snode2
EOF</span>

<span class="token comment">#设置网桥参数</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF</span>
<span class="token comment">#生效</span>
sysctl --system  

<span class="token comment">#更新时间</span>
yum <span class="token function">install</span> ntpdate -y
ntpdate time.windows.com

</code></pre> 
<blockquote> 
 <p>安装</p> 
</blockquote> 
<p>所有服务器节点都需要安装docker/kubeadm/kubelet</p> 
<pre><code class="prism language-shell"><span class="token comment">#docker的安装</span>
<span class="token comment">#可选</span>
<span class="token comment">#改成阿里镜像</span>
yum <span class="token function">install</span> <span class="token function">wget</span> -y

<span class="token function">wget</span> https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
<span class="token comment">#安装新版本</span>
yum <span class="token function">install</span> docker-ce-19.03.13 -y

<span class="token comment">#配置开机自动启动</span>
systemctl <span class="token builtin class-name">enable</span> docker.service

<span class="token comment">#配置镜像加速</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/docker
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
{
  "registry-mirrors": ["https://hj6c4pxo.mirror.aliyuncs.com"] 
}
EOF</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart docker	

 
<span class="token comment">#搭建kubeadm	kubelete</span>

<span class="token comment">#添加k8s的阿里云yum源（使用阿里的下载源（快速））</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>

<span class="token comment">#安装 kubeadm，kubelet 和 kubectl</span>
 yum <span class="token function">install</span> kubelet-1.19.4 kubeadm-1.19.4 kubectl-1.19.4 -y
<span class="token comment">#开机自动启动</span>
systemctl <span class="token builtin class-name">enable</span> kubelet.service

<span class="token comment">#查看是否安装成功</span>
yum list installed <span class="token operator">|</span> <span class="token function">grep</span> kubelet
yum list installed <span class="token operator">|</span> <span class="token function">grep</span> kubeadm
yum list installed <span class="token operator">|</span> <span class="token function">grep</span> kubectl

查看安装的版本: kubelet --version
Kubelet:运行在qluster所有节点上，负责启动POD和容器<span class="token punctuation">;</span>
Kubeadm:用于初始化cluster <span class="token punctuation">;</span>
Kubectl （类似于redis-cli）: kubectl是kubenetes命令行工具，通过kubectl可以部署和管理应

<span class="token comment">#初始化master节点（在master主机上执行）</span>
kubeadm init --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.16.135 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.19.4 --service-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12 --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16


解释：192.168.16.135根据你的master节点的ip修改
说明︰service-cidr 的选取不能和PodCIDR及本机网络有重叠或者冲突，一般可以选择一个本机网络和PodCIDR都没有用到的私网地址段，比如PODCIDR使用 <span class="token number">10.244</span>.0.0/16，那么service cidr可以选择10.96.0.0/12，网络无重叠冲突即可<span class="token punctuation">;</span>

之后需要等一段时间 
<span class="token comment">#直到有这句话，证明你的master节点配置成功	</span>
Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>
-------------------------------------------------------------------------------------------------------
To start using your cluster, you need to run the following as a regular user:（你需要立即执行）

  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
-------------------------------------------------------------------------------------------------------
You should now deploy a pod network to the cluster.（不会的可以看文档）
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/
-------------------------------------------------------------------------------------------------------
Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:（把node节点添加进去的方式）

kubeadm <span class="token function">join</span> master节点ip:6443 --token 7ye4m8.ftwfagsf8l6sccdf <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:db03daf9b5b13abfd9173e50f1f13aaf6ac93b0e3e44115d185886826fa85395 
--------------------------------------------------------------------------------------------------------
<span class="token comment">#此时你需要再次执行（复制上面的）</span>
  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

<span class="token comment">#查看节点信息</span>
kubectl get nodes
<span class="token punctuation">[</span>root@k8smaster1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
NAME         STATUS     ROLES    AGE    VERSION
k8smaster1   NotReady   master   9m6s   v1.19.4


<span class="token comment">#把node节点加到master集群里（node里执行）（复制上面的）</span>
kubeadm <span class="token function">join</span> master节点ip:6443 --token 7ye4m8.ftwfagsf8l6sccdf <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:db03daf9b5b13abfd9173e50f1f13aaf6ac93b0e3e44115d185886826fa85395 
    
    
    
    
    
    
<span class="token comment">#部署网络插件，让master节点和弄node节点准备就绪</span>
<span class="token function">wget</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml


 <span class="token function">wget</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
--2021-10-15 <span class="token number">11</span>:55:10--  https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
正在解析主机 raw.githubusercontent.com <span class="token punctuation">(</span>raw.githubusercontent.com<span class="token punctuation">)</span><span class="token punctuation">..</span>. <span class="token number">185.199</span>.111.133, <span class="token number">185.199</span>.109.133, <span class="token number">185.199</span>.110.133, <span class="token punctuation">..</span>.
正在连接 raw.githubusercontent.com <span class="token punctuation">(</span>raw.githubusercontent.com<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">185.199</span>.111.133<span class="token operator">|</span>:443<span class="token punctuation">..</span>. 已连接。
已发出 HTTP 请求，正在等待回应<span class="token punctuation">..</span>. <span class="token number">200</span> OK
长度：5163 <span class="token punctuation">(</span><span class="token number">5</span>.0K<span class="token punctuation">)</span> <span class="token punctuation">[</span>text/plain<span class="token punctuation">]</span>
正在保存至: “kube-flannel.yml”

<span class="token number">100</span>%<span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token number">5,163</span>       <span class="token number">1</span>.77KB/s 用时 <span class="token number">2</span>.8s   

<span class="token number">2021</span>-10-15 <span class="token number">11</span>:55:14 <span class="token punctuation">(</span><span class="token number">1.77</span> KB/s<span class="token punctuation">)</span> - 已保存 “kube-flannel.yml” <span class="token punctuation">[</span><span class="token number">5163</span>/5163<span class="token punctuation">]</span><span class="token punctuation">)</span>




kubectl apply -f kube-flannel.yml

<span class="token punctuation">[</span>root@k8smaster1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f kube-flannel.yml</span>
podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds created

<span class="token comment">#查看组件是否在运行</span>
<span class="token punctuation">[</span>root@k8smaster1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>


</code></pre> 
<h5><a id="ready_282"></a>部署中出现的问题（没有ready）：</h5> 
<pre><code class="prism language-shell"><span class="token comment">#检查组件</span>
<span class="token punctuation">[</span>root@k8smaster1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>
NAME                                 READY   STATUS     RESTARTS   AGE
coredns-6d56c8448f-6l2c8             <span class="token number">0</span>/1     Pending    <span class="token number">0</span>          175m
coredns-6d56c8448f-ndsbt             <span class="token number">0</span>/1     Pending    <span class="token number">0</span>          175m
etcd-k8smaster1                      <span class="token number">1</span>/1     Running    <span class="token number">3</span>          176m
kube-apiserver-k8smaster1            <span class="token number">1</span>/1     Running    <span class="token number">3</span>          176m
kube-controller-manager-k8smaster1   <span class="token number">1</span>/1     Running    <span class="token number">6</span>          176m
kube-flannel-ds-7448j                <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          139m
kube-flannel-ds-chhcb                <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          139m
kube-flannel-ds-tl29j                <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          139m
kube-proxy-fg9l5                     <span class="token number">1</span>/1     Running    <span class="token number">3</span>          159m
kube-proxy-frjht                     <span class="token number">1</span>/1     Running    <span class="token number">3</span>          159m
kube-proxy-lzckf                     <span class="token number">1</span>/1     Running    <span class="token number">3</span>          175m
kube-scheduler-k8smaster1            <span class="token number">1</span>/1     Running    <span class="token number">4</span>          176m

<span class="token comment">#再应用下网络插件</span>
kubectl apply -f kube-flannel.yml

<span class="token comment">#就变成了</span>

<span class="token punctuation">[</span>root@k8smaster1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>
NAME                                 READY   STATUS                  RESTARTS   AGE
coredns-6d56c8448f-6l2c8             <span class="token number">0</span>/1     Pending                 <span class="token number">0</span>          179m
coredns-6d56c8448f-ndsbt             <span class="token number">0</span>/1     Pending                 <span class="token number">0</span>          179m
etcd-k8smaster1                      <span class="token number">1</span>/1     Running                 <span class="token number">3</span>          3h
kube-apiserver-k8smaster1            <span class="token number">1</span>/1     Running                 <span class="token number">3</span>          3h
kube-controller-manager-k8smaster1   <span class="token number">0</span>/1     Running                 <span class="token number">7</span>          3h
kube-flannel-ds-7448j                <span class="token number">0</span>/1     Init:ImagePullBackOff   <span class="token number">0</span>          143m
kube-flannel-ds-chhcb                <span class="token number">0</span>/1     Init:ImagePullBackOff   <span class="token number">0</span>          143m
kube-flannel-ds-tl29j                <span class="token number">0</span>/1     Init:ImagePullBackOff   <span class="token number">0</span>          143m
kube-proxy-fg9l5                     <span class="token number">1</span>/1     Running                 <span class="token number">3</span>          164m
kube-proxy-frjht                     <span class="token number">1</span>/1     Running                 <span class="token number">3</span>          164m
kube-proxy-lzckf                     <span class="token number">1</span>/1     Running                 <span class="token number">3</span>          179m
kube-scheduler-k8smaster1            <span class="token number">1</span>/1     Running                 <span class="token number">4</span>          3h
-----------------------------------------------------------------------------------------
<span class="token comment">#镜像拉取失败</span>
kube-flannel-ds-7448j                <span class="token number">0</span>/1     Init:ImagePullBackOff   <span class="token number">0</span>          143m
kube-flannel-ds-chhcb                <span class="token number">0</span>/1     Init:ImagePullBackOff   <span class="token number">0</span>          143m
kube-flannel-ds-tl29j                <span class="token number">0</span>/1     Init:ImagePullBackOff   <span class="token number">0</span>          143m

<span class="token comment">#再重新获取试试，实在不行用下面的方法</span>
kubectl apply -f kube-flannel.yml

</code></pre> 
<p>网上淘来的解决办法</p> 
<p>1.手动从网上下（用这个解决了）</p> 
<pre><code class="prism language-shell">按照搭建Kubernetes时官网给的命令

 kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

部署完成时查看

<span class="token punctuation">[</span>root@k8s-master01 flannel<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>
NAME                                   READY   STATUS                  RESTARTS   AGE
coredns-5c98db65d4-cr9lq               <span class="token number">0</span>/1     Pending                 <span class="token number">0</span>          74m
coredns-5c98db65d4-h4h8f               <span class="token number">0</span>/1     Pending                 <span class="token number">0</span>          74m
etcd-k8s-master01                      <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          73m
kube-apiserver-k8s-master01            <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          73m
kube-controller-manager-k8s-master01   <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          73m
kube-flannel-ds-amd64-cpzh6            <span class="token number">0</span>/1     Init:ImagePullBackOff   <span class="token number">0</span>          51m
kube-proxy-sb68t                       <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          74m

flannel状态为Init:ImagePullBackOff

原因
查看kube-flannel.yml文件时发现quay.io/coreos/flannel:v0.12.0-amd64

quay.io网站目前国内无法访问

下载flannel:v0.12.0-amd64导入到docker中

可以去https://github.com/coreos/flannel/releases官方仓库下载镜像



<span class="token punctuation">[</span>root@k8s-master01 tmp<span class="token punctuation">]</span><span class="token comment"># docker load &lt; flanneld-v0.12.0-amd64.docker</span>
256a7af3acb1: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">5</span>.844MB/5.844MB
d572e5d9d39b: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">10</span>.37MB/10.37MB
57c10be5852f: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">2</span>.249MB/2.249MB
7412f8eefb77: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">35</span>.26MB/35.26MB
05116c9ff7bf: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>   <span class="token number">5</span>.12kB/5.12kB
Loaded image: quay.io/coreos/flannel:v0.12.0-amd64
<span class="token punctuation">[</span>root@k8s-master01 tmp<span class="token punctuation">]</span><span class="token comment"># docker images</span>
REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE
quay.io/coreos/flannel               v0.12.0-amd64       4e9f801d2217        <span class="token number">4</span> months ago        <span class="token number">52</span>.8MB
k8s.gcr.io/kube-proxy                v1.15.1             89a062da739d        <span class="token number">12</span> months ago       <span class="token number">82</span>.4MB
k8s.gcr.io/kube-scheduler            v1.15.1             b0b3c4c404da        <span class="token number">12</span> months ago       <span class="token number">81</span>.1MB
k8s.gcr.io/kube-apiserver            v1.15.1             68c3eb07bfc3        <span class="token number">12</span> months ago       207MB
k8s.gcr.io/kube-controller-manager   v1.15.1             d75082f1d121        <span class="token number">12</span> months ago       159MB
k8s.gcr.io/coredns                   <span class="token number">1.3</span>.1               eb516548c180        <span class="token number">18</span> months ago       <span class="token number">40</span>.3MB
k8s.gcr.io/etcd                      <span class="token number">3.3</span>.10              2c4adeb21b4f        <span class="token number">20</span> months ago       258MB
k8s.gcr.io/pause                     <span class="token number">3.1</span>                 da86e6ba6ca1        <span class="token number">2</span> years ago         742kB



<span class="token punctuation">[</span>root@k8s-master01 tmp<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>
NAME                                   READY   STATUS    RESTARTS   AGE
coredns-5c98db65d4-cr9lq               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          104m
coredns-5c98db65d4-h4h8f               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          104m
etcd-k8s-master01                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          103m
kube-apiserver-k8s-master01            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          103m
kube-controller-manager-k8s-master01   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          102m
kube-flannel-ds-amd64-cpzh6            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          80m
kube-proxy-sb68t                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          104m
kube-scheduler-k8s-master01            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          103m
<span class="token punctuation">[</span>root@k8s-master01 tmp<span class="token punctuation">]</span><span class="token comment">#</span>

</code></pre> 
<p>2.单个拉取</p> 
<pre><code class="prism language-shell">问题
使用kubectl get nodes查看已加入的节点时，出现了Status为NotReady的情况。

root@master1:~<span class="token comment"># kubectl get nodes</span>
NAME      STATUS      ROLES    AGE    VERSION
master1   NotReady    master   152m   v1.18.1
worker1   NotReady    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   94m    v1.18.1

这种情况是因为有某些关键的 pod 没有运行起来，首先使用如下命令来看一下kube-system的 pod 状态：

kubectl get pod -n kube-system
<span class="token number">1</span>
NAME                              READY   STATUS             RESTARTS   AGE
coredns-bccdc95cf-792px           <span class="token number">1</span>/1     Pending            <span class="token number">0</span>          3h11m
coredns-bccdc95cf-bc76j           <span class="token number">1</span>/1     Pending            <span class="token number">0</span>          3h11m
etcd-master1                      <span class="token number">1</span>/1     Running            <span class="token number">2</span>          3h10m
kube-apiserver-master1            <span class="token number">1</span>/1     Running            <span class="token number">2</span>          3h11m
kube-controller-manager-master1   <span class="token number">1</span>/1     Running            <span class="token number">2</span>          3h10m
kube-flannel-ds-amd64-9trbq       <span class="token number">0</span>/1     ImagePullBackoff   <span class="token number">0</span>          133m
kube-flannel-ds-amd64-btt74       <span class="token number">0</span>/1     ImagePullBackoff   <span class="token number">0</span>          174m
kube-proxy-27zfk                  <span class="token number">1</span>/1     Pending            <span class="token number">2</span>          3h11m
kube-proxy-lx4gk                  <span class="token number">1</span>/1     Pending            <span class="token number">0</span>          133m
kube-scheduler-master1            <span class="token number">1</span>/1     Running            <span class="token number">2</span>          3h11m

<span class="token number">1</span>
如上，可以看到 pod kube-flannel 的状态是ImagePullBackoff，意思是镜像拉取失败了，所以我们需要手动去拉取这个镜像。这里可以看到某些 pod 运行了两个副本是因为我有两个节点存在了。

你也可以通过kubectl describe pod -n kube-system <span class="token operator">&lt;</span>服务名<span class="token operator">&gt;</span>来查看某个服务的详细情况，如果 pod 存在问题的话，你在使用该命令后在输出内容的最下面看到一个<span class="token punctuation">[</span>Event<span class="token punctuation">]</span>条目，如下：

root@master1:~<span class="token comment"># kubectl describe pod kube-flannel-ds-amd64-9trbq -n kube-system</span>

<span class="token punctuation">..</span>.

Events:
  Type     Reason                  Age                 From              Message
  ----     ------                  ----                ----              -------
  Normal   Killing                 29m                 kubelet, worker1  Stopping container kube-flannel
  Warning  FailedCreatePodSandBox  27m <span class="token punctuation">(</span>x12 over 29m<span class="token punctuation">)</span>  kubelet, worker1  Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to create a sandbox <span class="token keyword">for</span> pod <span class="token string">"kube-flannel-ds-amd64-9trbq"</span><span class="token builtin class-name">:</span> Error response from daemon: cgroup-parent <span class="token keyword">for</span> systemd cgroup should be a valid slice named as <span class="token string">"xxx.slice"</span>
  Normal   SandboxChanged          19m <span class="token punctuation">(</span>x48 over 29m<span class="token punctuation">)</span>  kubelet, worker1  Pod sandbox changed, it will be killed and re-created.
  Normal   Pulling                 42s                 kubelet, worker1  Pulling image <span class="token string">"quay.io/coreos/flannel:v0.11.0-amd64"</span>

<span class="token comment">#手动拉取镜像</span>

flannel的镜像可以使用如下命令拉到，如果你是其他镜像没拉到的话，百度一下就可以找到国内的镜像源地址了，这里记得把最后面的版本号修改成你自己的版本，具体的版本号可以用上面说的kubectl describe命令看到：

<span class="token comment">#拉取镜像：</span>

docker pull quay-mirror.qiniu.com/coreos/flannel:v0.11.0-amd64

等镜像拉取完了之后需要把镜像名改一下，改成 k8s 没有拉到的那个镜像名称，我这里贴的镜像名和版本和你的不一定一样，注意修改：

docker tag quay-mirror.qiniu.com/coreos/flannel:v0.11.0-amd64 quay.io/coreos/flannel:v0.11.0-amd64

修改完了之后过几分钟 k8s 会自动重试，等一下就可以发现不仅flannel正常了，其他的 pod 状态也都变成了Running，这时再看 node 状态就可以发现问题解决了：

<span class="token punctuation">[</span>kubeadm@server1 ~<span class="token punctuation">]</span>$ kubectl get nodes
NAME      STATUS   ROLES    AGE    VERSION
server1   Ready    master   150m   v1.18.1
server2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   150m   v1.18.1
server3   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   150m   v1.18.1

</code></pre> 
<h4><a id="_465"></a>结尾：部署完成</h4> 
<p>看到都 <code>Running</code>且所有master和node都ready时，部署完毕！</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8smaster1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>
NAME                                 READY   STATUS    RESTARTS   AGE
coredns-6d56c8448f-6l2c8             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h23m
coredns-6d56c8448f-ndsbt             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h23m
etcd-k8smaster1                      <span class="token number">1</span>/1     Running   <span class="token number">3</span>          3h23m
kube-apiserver-k8smaster1            <span class="token number">1</span>/1     Running   <span class="token number">3</span>          3h23m
kube-controller-manager-k8smaster1   <span class="token number">1</span>/1     Running   <span class="token number">8</span>          3h23m
kube-flannel-ds-lj52w                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-flannel-ds-qp9k5                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-flannel-ds-zrqzm                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-proxy-fg9l5                     <span class="token number">1</span>/1     Running   <span class="token number">3</span>          3h7m
kube-proxy-frjht                     <span class="token number">1</span>/1     Running   <span class="token number">3</span>          3h7m
kube-proxy-lzckf                     <span class="token number">1</span>/1     Running   <span class="token number">3</span>          3h23m
kube-scheduler-k8smaster1            <span class="token number">1</span>/1     Running   <span class="token number">4</span>          3h23m
<span class="token punctuation">[</span>root@k8smaster1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
NAME         STATUS   ROLES    AGE     VERSION
k8smaster1   Ready    master   3h29m   v1.19.4
k8snode1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3h13m   v1.19.4
k8snode2     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3h13m   v1.19.4

</code></pre> 
<h5><a id="kubeflannelyml_494"></a>扩展：kube-flannel.yml的配置</h5> 
<pre><code class="prism language-shell">---
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: psp.flannel.unprivileged
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default
    seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default
    apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default
    apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default
spec:
  privileged: <span class="token boolean">false</span>
  volumes:
  - configMap
  - secret
  - emptyDir
  - hostPath
  allowedHostPaths:
  - pathPrefix: <span class="token string">"/etc/cni/net.d"</span>
  - pathPrefix: <span class="token string">"/etc/kube-flannel"</span>
  - pathPrefix: <span class="token string">"/run/flannel"</span>
  readOnlyRootFilesystem: <span class="token boolean">false</span>
  <span class="token comment"># Users and groups</span>
  runAsUser:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  <span class="token comment"># Privilege Escalation</span>
  allowPrivilegeEscalation: <span class="token boolean">false</span>
  defaultAllowPrivilegeEscalation: <span class="token boolean">false</span>
  <span class="token comment"># Capabilities</span>
  allowedCapabilities: <span class="token punctuation">[</span><span class="token string">'NET_ADMIN'</span>, <span class="token string">'NET_RAW'</span><span class="token punctuation">]</span>
  defaultAddCapabilities: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  requiredDropCapabilities: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment"># Host namespaces</span>
  hostPID: <span class="token boolean">false</span>
  hostIPC: <span class="token boolean">false</span>
  hostNetwork: <span class="token boolean">true</span>
  hostPorts:
  - min: <span class="token number">0</span>
    max: <span class="token number">65535</span>
  <span class="token comment"># SELinux</span>
  seLinux:
    <span class="token comment"># SELinux is unused in CaaSP</span>
    rule: <span class="token string">'RunAsAny'</span>
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flannel
rules:
- apiGroups: <span class="token punctuation">[</span><span class="token string">'extensions'</span><span class="token punctuation">]</span>
  resources: <span class="token punctuation">[</span><span class="token string">'podsecuritypolicies'</span><span class="token punctuation">]</span>
  verbs: <span class="token punctuation">[</span><span class="token string">'use'</span><span class="token punctuation">]</span>
  resourceNames: <span class="token punctuation">[</span><span class="token string">'psp.flannel.unprivileged'</span><span class="token punctuation">]</span>
- apiGroups:
  - <span class="token string">""</span>
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - <span class="token string">""</span>
  resources:
  - nodes
  verbs:
  - list
  - <span class="token function">watch</span>
- apiGroups:
  - <span class="token string">""</span>
  resources:
  - nodes/status
  verbs:
  - patch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flannel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flannel
subjects:
- kind: ServiceAccount
  name: flannel
  namespace: kube-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flannel
  namespace: kube-system
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-flannel-cfg
  namespace: kube-system
  labels:
    tier: node
    app: flannel
data:
  cni-conf.json: <span class="token operator">|</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"cbr0"</span>,
      <span class="token string">"cniVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"0.3.1"</span>,
      <span class="token string">"plugins"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"flannel"</span>,
          <span class="token string">"delegate"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"hairpinMode"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"isDefaultGateway"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"portmap"</span>,
          <span class="token string">"capabilities"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"portMappings"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  net-conf.json: <span class="token operator">|</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"Network"</span><span class="token builtin class-name">:</span> <span class="token string">"10.244.0.0/16"</span>,
      <span class="token string">"Backend"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"vxlan"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-flannel-ds
  namespace: kube-system
  labels:
    tier: node
    app: flannel
spec:
  selector:
    matchLabels:
      app: flannel
  template:
    metadata:
      labels:
        tier: node
        app: flannel
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
      hostNetwork: <span class="token boolean">true</span>
      priorityClassName: system-node-critical
      tolerations:
      - operator: Exists
        effect: NoSchedule
      serviceAccountName: flannel
      initContainers:
      - name: install-cni
        image: quay.io/coreos/flannel:v0.13.0
        command:
        - <span class="token function">cp</span>
        args:
        - -f
        - /etc/kube-flannel/cni-conf.json
        - /etc/cni/net.d/10-flannel.conflist
        volumeMounts:
        - name: cni
          mountPath: /etc/cni/net.d
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
      containers:
      - name: kube-flannel
        image: quay.io/coreos/flannel:v0.13.0
        command:
        - /opt/bin/flanneld
        args:
        - --ip-masq
        - --kube-subnet-mgr
        resources:
          requests:
            cpu: <span class="token string">"100m"</span>
            memory: <span class="token string">"50Mi"</span>
          limits:
            cpu: <span class="token string">"100m"</span>
            memory: <span class="token string">"50Mi"</span>
        securityContext:
          privileged: <span class="token boolean">false</span>
          capabilities:
            add: <span class="token punctuation">[</span><span class="token string">"NET_ADMIN"</span>, <span class="token string">"NET_RAW"</span><span class="token punctuation">]</span>
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        - name: run
          mountPath: /run/flannel
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
      volumes:
      - name: run
        hostPath:
          path: /run/flannel
      - name: cni
        hostPath:
          path: /etc/cni/net.d
      - name: flannel-cfg
        configMap:
          name: kube-flannel-cfg


</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/704605c3194f28eb8524b21f02b38e84/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flutter 使用permission_handler 申请权限</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6a3f71e74350758b9288185d367c4e85/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何申请Office 365 E5开发者账号，开通OneDrive 5T空间教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>