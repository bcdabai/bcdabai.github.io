<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2.1设备树的规范（dts和dtb）——DTS格式 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2.1设备树的规范（dts和dtb）——DTS格式" />
<meta property="og:description" content="本节学习设备树的规范。
使用设备树时，需要编写dts文件，然后使用dtc编译dts文件，生成dtb文件。
所以本节分为两部分，第一部分讲解dts格式，第二部分讲解dtb格式。
首先看一下dts文件的布局。
DTS文件布局（layout）: /dts-v1/; // 表示DTS文件的版本 [memory reservations] // 保存的内存区域 格式为： /memreserve/ &lt;address&gt; &lt;length&gt;; / { [property definitions] [child nodes] }; 第一行 /dts-v1/; 表示的是DTS文件的版本。
第二行 [memory reservations] 表示保留的内存区域，假设有64MB内存，如果希望保留4MB内存，只提供60MB内存供内核使用，那么就可以设置这个选项，如果不设置则认为内核使用全部的内存。
接下来是 / { ... };，其中 / 是根，是设备树的起点。
对于每一个设备树，我们需要一些属性来描述这颗树，就是 [property definitions]；同样，一颗树有很多树干，很多分支，一颗设备树同样也有很多子节点，子节点中又可以包含子节点，就是 [child nodes]。
那么属性和设备节点是如何定义的呢？
属性 首先来看属性。
属性的格式有两种，一种是没有值的空属性，一种是有值的属性。
Property格式1: [label:] property-name = value; Property格式2(没有值): [label:] property-name; 下面就是有值的属性，除了特殊规定的属性，比如bootargs是用来设置启动指令，其他没有特殊规定的属性，属性名是可以自由定义的，比如pin，就是我们自己定义的属性。
属性值的写法有三种：
用尖括号括起来 &lt;xx xx xx ...&gt;，例如&lt;1 0x3 0x123&gt;，每个成员都是32bit数据，称为arrays of cells；用双引号括起来的字符串 &#34;...&#34;，例如上面bootargs的字符串；用中括号括起来的字节序列（byte string）[xx xx xx ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b3c3af5a991e2d339a74c543b03bb232/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-15T16:40:23+08:00" />
<meta property="article:modified_time" content="2023-02-15T16:40:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2.1设备树的规范（dts和dtb）——DTS格式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>本节学习<span style="color:#4da8ee;">设备树的规范</span>。</p> 
<p>使用设备树时，需要编写dts文件，然后使用dtc编译dts文件，生成<strong>dtb</strong>文件。</p> 
<p>所以本节分为两部分，<strong>第一部分讲解dts格式，第二部分讲解dtb格式</strong>。</p> 
<p>首先看一下dts文件的布局。</p> 
<pre><code>DTS文件布局（layout）:
/dts-v1/;                         // 表示DTS文件的版本
[memory reservations]             // 保存的内存区域 格式为： /memreserve/ &lt;address&gt; &lt;length&gt;;
/ {
    [property definitions]
    [child nodes]
};</code></pre> 
<p>第一行 /dts-v1/; 表示的是DTS文件的<strong>版本</strong>。</p> 
<p>第二行 [memory reservations] 表示保留的内存区域，假设有64MB内存，如果希望保留4MB内存，只提供60MB内存供内核使用，那么就可以设置这个选项，如果不设置则认为内核使用全部的内存。</p> 
<p>接下来是 / { ... };，其中 / 是<strong>根</strong>，是<strong>设备树的起点</strong>。</p> 
<p>对于每一个设备树，我们需要一些<strong>属性</strong>来描述这颗树，就是 <strong>[property definitions]</strong>；同样，一颗树有很多树干，很多分支，一颗设备树同样也有很多<strong>子节点</strong>，子节点中又可以包含子节点，就是 <strong>[child nodes]</strong>。</p> 
<p>那么<strong>属性</strong>和<strong>设备节点</strong>是如何定义的呢？</p> 
<h2>属性</h2> 
<p>首先来看属性。</p> 
<p>属性的格式有两种，一种是<strong>没有值的空属性</strong>，一种是<strong>有值的属性</strong>。</p> 
<pre><code>Property格式1:
[label:] property-name = value;

Property格式2(没有值):
[label:] property-name;</code></pre> 
<p>下面就是有值的属性，除了<strong>特殊规定的属性</strong>，比如bootargs是用来设置启动指令，其他没<strong>有特殊规定的属性</strong>，属性名是可以<strong>自由定义</strong>的，比如pin，就是我们自己定义的属性。</p> 
<p><img alt="" height="184" src="https://images2.imgbox.com/08/a8/xHROPQYB_o.png" width="989"></p> 
<p><strong>属性值</strong>的写法有<strong>三种</strong>：</p> 
<ol><li>用<strong>尖括号</strong>括起来 &lt;xx xx xx ...&gt;，例如&lt;1 0x3 0x123&gt;，每个成员都是<strong>32bit</strong>数据，称为<strong>arrays of cells</strong>；</li><li>用<strong>双引号</strong>括起来的字符串 "..."，例如上面bootargs的字符串；</li><li>用<strong>中括号</strong>括起来的字节序列（byte string）[xx xx xx ...]，使用16进制表示1个/多个byte，需要注意的是，byte string中，一个byte必须用<strong>2位16进制数</strong>来表示，例如[00 11 22]，其中00不能简写为0，但是<strong>byte之间的空格可以省略</strong>，也就是[00 11 22]和[001122]是一样的；</li></ol> 
<p><img alt="" height="90" src="https://images2.imgbox.com/b9/c6/l29ibeb2_o.png" width="674"></p> 
<p>value的取值类型只有上述三种，但是这三种取值类型可以叠加，不过一般不会这么做。</p> 
<pre><code>示例: 
a. Arrays of cells : cell就是一个32位的数据
interrupts = &lt;17 0xc&gt;;

b. 64bit数据使用2个cell来表示:
clock-frequency = &lt;0x00000001 0x00000000&gt;;

c. A null-terminated string (有结束符的字符串):
compatible = "simple-bus";

d. A bytestring(字节序列) :
local-mac-address = [00 00 12 34 56 78];  // 每个byte使用2个16进制数来表示
local-mac-address = [000012345678];       // 每个byte使用2个16进制数来表示

e. 可以是各种值的组合, 用逗号隔开:
compatible = "ns16550", "ns8250";
example = &lt;0xf00f0000 19&gt;, "a strange property format";
</code></pre> 
<h2>设备节点</h2> 
<p>下图就是设备树中节点的格式。</p> 
<p><img alt="" height="145" src="https://images2.imgbox.com/58/98/6GSB6oBh_o.png" width="480"></p> 
<p>第一行的 <strong>label 可加可不加</strong>，node-name是<strong>节点名字</strong>；@unit-address是<strong>地址</strong>，可以用来<strong>区分内存节点</strong>，比如memory@30000000和memory@0，分别表示起始地址为0x3000 0000和0的两块内存；</p> 
<pre><code>led {
    compatible = "jz2440_led";
	pin = &lt;S3C2410_GPF(5)&gt;;
};
</code></pre> 
<p>以之前写的led为例，其中led就是node-name。</p> 
<pre><code>memory@30000000 {  /* /memory/memory@30000000 */
	device_type = "memory";
	reg =  &lt;0x30000000 0x4000000&gt;;		
};

memory@0 {  /* /memory/memory@0 */
	device_type = "memory";
	reg =  &lt;0 4096&gt;;		
};
</code></pre> 
<p>memory@30000000和memory@0就是两块不同起始地址的内存空间。</p> 
<h2>注意事项</h2> 
<p>dts文件中有一些<strong>默认的属性名字</strong>，比如model，compatible，#address-cells，#size-cells，这些是<strong>根节点必须有的属性</strong>，它们代表的含义都是默认的，是事先约定好的。</p> 
<p><img alt="" height="467" src="https://images2.imgbox.com/52/04/QQoNzhqm_o.png" width="1050"></p> 
<p>它们的定义如下。</p> 
<p><img alt="" height="228" src="https://images2.imgbox.com/55/b4/LOnMSPxR_o.png" width="834"></p> 
<p><img alt="" height="388" src="https://images2.imgbox.com/32/ed/IuV1LlSN_o.png" width="820"></p> 
<p> <img alt="" height="497" src="https://images2.imgbox.com/c9/f8/jiKIqao0_o.png" width="987"></p> 
<h2> 举例</h2> 
<h3>override</h3> 
<p>设备树文件可以将一些<strong>公共的部分</strong>写为<strong>dtsi</strong>文件，dts文件可以包含dtsi文件，就像C文件包含h文件一样，语法格式也同<strong>C文件包含h文件一样</strong>。</p> 
<p>下面是一个dtsi文件。</p> 
<pre><code>// SPDX-License-Identifier: GPL-2.0
/*
 * SAMSUNG SMDK2440 board device tree source
 *
 * Copyright (c) 2018 weidongshan@qq.com
 * dtc -I dtb -O dts -o jz2440.dts jz2440.dtb
 */
 
#define S3C2410_GPA(_nr)	((0&lt;&lt;16) + (_nr))
#define S3C2410_GPB(_nr)	((1&lt;&lt;16) + (_nr))
#define S3C2410_GPC(_nr)	((2&lt;&lt;16) + (_nr))
#define S3C2410_GPD(_nr)	((3&lt;&lt;16) + (_nr))
#define S3C2410_GPE(_nr)	((4&lt;&lt;16) + (_nr))
#define S3C2410_GPF(_nr)	((5&lt;&lt;16) + (_nr))
#define S3C2410_GPG(_nr)	((6&lt;&lt;16) + (_nr))
#define S3C2410_GPH(_nr)	((7&lt;&lt;16) + (_nr))
#define S3C2410_GPJ(_nr)	((8&lt;&lt;16) + (_nr))
#define S3C2410_GPK(_nr)	((9&lt;&lt;16) + (_nr))
#define S3C2410_GPL(_nr)	((10&lt;&lt;16) + (_nr))
#define S3C2410_GPM(_nr)	((11&lt;&lt;16) + (_nr))

/dts-v1/;

/ {
	model = "SMDK24440";
	compatible = "samsung,smdk2440";

	#address-cells = &lt;1&gt;;
	#size-cells = &lt;1&gt;;
		
	memory {  /* /memory */
		device_type = "memory";
		reg =  &lt;0x30000000 0x4000000 0 4096&gt;;		
	};

	
/*
	cpus {
		cpu {
			compatible = "arm,arm926ej-s";
		};
	};
*/	
	chosen {
		bootargs = "noinitrd root=/dev/mtdblock4 rw init=/linuxrc console=ttySAC0,115200";
	};

	
	led {
		compatible = "jz2440_led";
		pin = &lt;S3C2410_GPF(5)&gt;;
	};
};

</code></pre> 
<p>然后在dts文件中包含这个dtsi文件， 只要添加一个#include "jz2440.dtsi"即可。</p> 
<pre><code>// SPDX-License-Identifier: GPL-2.0
/*
 * SAMSUNG SMDK2440 board device tree source
 *
 * Copyright (c) 2018 weidongshan@qq.com
 * dtc -I dtb -O dts -o jz2440.dts jz2440.dtb
 */
 
/dts-v1/;

#include "jz2440.dtsi"</code></pre> 
<p>在dtsi文件中led节点的pin属性为&lt;S3C2410_GPF(5)&gt;，如果要修改为&lt;S3C2410_GPF(6)&gt;但是不想改变dtsi文件，那么只需要在dts文件中重新定义led节点的pin属性即可。</p> 
<p><img alt="" height="84" src="https://images2.imgbox.com/57/13/BnR4LAil_o.png" width="376"></p> 
<p>增加led节点pin属性的设置，设置如下。也就是说，设置以最终的设置值为准。</p> 
<pre><code>// SPDX-License-Identifier: GPL-2.0
/*
 * SAMSUNG SMDK2440 board device tree source
 *
 * Copyright (c) 2018 weidongshan@qq.com
 * dtc -I dtb -O dts -o jz2440.dts jz2440.dtb
 */
 
/dts-v1/;

#include "jz2440.dtsi"

/ {
    led {
		pin = &lt;S3C2410_GPF(6)&gt;;
	};
};</code></pre> 
<p>将dts和dtsi文件复制到arch\arm\boot\dts目录下，设置编译工具链。</p> 
<pre><code>export PATH=/home/book/code/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabi/bin/:$PATH
</code></pre> 
<p>然后在根目录下执行make dtbs指令，编译dts文件，得到dtb文件。</p> 
<p><img alt="" height="689" src="https://images2.imgbox.com/b9/27/ePHatuT1_o.png" width="715"></p> 
<p>想要看编译后的dtb文件是否和我们设置的相同，可以使用dtc工具将dtb文件反编译成dts文件，看看反编译的dts文件是否符合上面的设置。</p> 
<p> 执行下面指令，将jz2440.dtb反编译得到一个tmp.dts文件。</p> 
<pre><code>./scripts/dtc/dtc -I dtb -O dts -o tmp.dts arch/arm/boot/dts/jz2440.dtb</code></pre> 
<p><img alt="" height="55" src="https://images2.imgbox.com/bc/63/EjaSSFBh_o.png" width="1069"></p> 
<p>dtc的说明如下。</p> 
<p><img alt="" height="851" src="https://images2.imgbox.com/47/cd/baDlaDQ2_o.png" width="819"></p> 
<p> 然后查看tmp.dts文件，可以看到led节点的pin属性被设置为了&lt;S3C2410_GPF(6)&gt;而不是&lt;S3C2410_GPF(5)&gt;。</p> 
<p><img alt="" height="341" src="https://images2.imgbox.com/3a/c2/MbFMh7RX_o.png" width="886"></p> 
<h3>LABEL</h3> 
<p>在之前，想要修改dtsi文件中的led节点，需要将led的整个路径写出，除了这个方法之外，还可以增加一个led节点的<strong>label</strong>，在dts文件中通过label来引用led节点。</p> 
<p>如下所示，其他部分不变，将led节点的label设置为LED。</p> 
<pre><code>LED: led {
	compatible = "jz2440_led";
	pin = &lt;S3C2410_GPF(5)&gt;;
};

</code></pre> 
<p>修改dts文件，引用led节点的标签LED，将pin属性设置为7。</p> 
<pre><code>// SPDX-License-Identifier: GPL-2.0
/*
 * SAMSUNG SMDK2440 board device tree source
 *
 * Copyright (c) 2018 weidongshan@qq.com
 * dtc -I dtb -O dts -o jz2440.dts jz2440.dtb
 */
 
/dts-v1/;

#include "jz2440.dtsi"
&amp;LED {
   pin = &lt;S3C2410_GPF(7)&gt;;
};
</code></pre> 
<p>重新编译dtb文件，然后反编译，得到新的tmp.dts文件。</p> 
<p>可以看到，led节点的pin属性被覆盖为了7。</p> 
<p><img alt="" height="341" src="https://images2.imgbox.com/0d/2e/57qyuCOM_o.png" width="903"></p> 
<p>最后，本节内容来自设备树的官方文档，可以从https://www.devicetree.org/specifications/下载到关于设备树知识的官方文档。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/751239c3346ba02149d936c9a8f78826/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">第三个bug：使用freemarker或者easypoi生成文档乱码问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8ce57f7adcc9c2cdf901c883fb6dd31f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用MathType编辑公式时报错“Error53找不到文件：MathPage.WLL”</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>