<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux学习之网络编程3（高并发服务器） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux学习之网络编程3（高并发服务器）" />
<meta property="og:description" content="写在前面 Linux网络编程我是看视频学的，Linux网络编程，看完这个视频大概网络编程的基础差不多就掌握了。这个系列是我看这个Linux网络编程视频写的笔记总结。
高并发服务器 问题： 根据上一个笔记，我们可以写出一个简单的服务端和客户端通信，但是我们发现一个问题——服务器只能连接一个客户端。然而在实际生活中，我们发现一个服务器连接的客户端远远不止一个，所以我们就要做一个高并发服务器。
解决方法： 回看之前的代码，之所以只能一对一通信，是因为服务器只有一次执行accept的机会，一旦建立连接成功，就会去进行通信处理业务，而其他想要建立连接的服务器就没办法建立连接。因此我们想到在Linux系统编程中学的进程和线程，我们可以让父进程（主线程）去监听，一定有客户端请求建立连接，我们就创建子进程（其他线程）去和客户端建立连接进行通信，父进程（主线程）继续监听。
多进程并发服务器 思路(步骤）： 前期准备工作： 先用socket()生成一个套接字lfd用来监听用bind()对第一步生成的套接字绑定地址结构（绑的是服务器的地址结构）用listen()函数设置lfd的监听上限，最大是128. 进入循环，accept与客户端建立连接，得到用于通信的套接字的文件描述符cfdfork()创建子进程对于父进程，由于父进程只是监听，不需要与客户端进行通信，所以我们就关闭cfd，注册信号捕捉函数，用来回收子进程，然后一直循环监听。对于子进程，由于子进程只是进行通信，不需要监听，所以我们就关闭lfd，然后就与客户端进行通信，处理业务。 源代码： #include&lt;stdio.h&gt; #include&lt;string.h&gt; #include&lt;ctype.h&gt; #include&lt;stdlib.h&gt; #include&lt;unistd.h&gt; #include&lt;sys/socket.h&gt; #include&lt;arpa/inet.h&gt;	#include&lt;signal.h&gt; #define PORT 6666 void sys_err(char* str) { perror(str); exit(-1); } void wait_child(int signum)	//信号捕捉，回收子进程 { while((waitpid(0,NULL,WNOHANG))&gt;0); //	if(waitpid(0,NULL,0)!=-1) //	printf(&#34;disconnect a client successfully\n&#34;); return; } int main() { struct sockaddr_in addr_s,addr_c; socklen_t addr_c_len=sizeof addr_c; int lfd,cfd,res,n; pid_t pid; struct sigaction act; char buf[BUFSIZ],client_IP[1024]; lfd=socket(AF_INET,SOCK_STREAM,0); if(lfd&lt;0) sys_err(&#34;socket error&#34;); addr_s.sin_family=AF_INET; addr_s." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a6a8fe6210c15302ceb80cc6e3eaf46b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-14T13:21:58+08:00" />
<meta property="article:modified_time" content="2024-01-14T13:21:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux学习之网络编程3（高并发服务器）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>写在前面</h3> 
<p>Linux网络编程我是看视频学的，<a href="https://www.bilibili.com/video/BV1iJ411S7UA/?p=79&amp;spm_id_from=333.1007.top_right_bar_window_history.content.click&amp;vd_source=3f806d18e0576cd0e3a9f200d67a10f6" rel="nofollow">Linux网络编程</a>，看完这个视频大概网络编程的基础差不多就掌握了。这个系列是我看这个Linux网络编程视频写的笔记总结。</p> 
<hr> 
<h3><a id="_4"></a>高并发服务器</h3> 
<h4><a id="_5"></a>问题：</h4> 
<p>根据<a href="https://blog.csdn.net/yourgrandfather_/article/details/135535927">上一个笔记</a>，我们可以写出一个简单的服务端和客户端通信，但是我们发现一个问题——服务器只能连接一个客户端。然而在实际生活中，我们发现一个服务器连接的客户端远远不止一个，所以我们就要做一个高并发服务器。</p> 
<h4><a id="_7"></a>解决方法：</h4> 
<p>回看之前的代码，之所以只能一对一通信，是因为服务器只有一次执行<code>accept</code>的机会，一旦建立连接成功，就会去进行通信处理业务，而其他想要建立连接的服务器就没办法建立连接。因此我们想到在Linux系统编程中学的进程和线程，我们可以让父进程（主线程）去监听，一定有客户端请求建立连接，我们就创建子进程（其他线程）去和客户端建立连接进行通信，父进程（主线程）继续监听。</p> 
<hr> 
<h3><a id="_11"></a>多进程并发服务器</h3> 
<h4><a id="_12"></a>思路(步骤）：</h4> 
<ol><li>前期准备工作： 
  <ul><li>先用<code>socket()</code>生成一个套接字<code>lfd</code>用来监听</li><li>用<code>bind()</code>对第一步生成的套接字绑定地址结构（绑的是服务器的地址结构）</li><li>用<code>listen()</code>函数设置<code>lfd</code>的监听上限，最大是128.</li></ul> </li><li>进入循环，<code>accept</code>与客户端建立连接，得到用于通信的套接字的文件描述符<code>cfd</code></li><li><code>fork()</code>创建子进程</li><li>对于父进程，由于父进程只是监听，不需要与客户端进行通信，所以我们就关闭<code>cfd</code>，注册信号捕捉函数，用来回收子进程，然后一直循环监听。</li><li>对于子进程，由于子进程只是进行通信，不需要监听，所以我们就关闭<code>lfd</code>，然后就与客户端进行通信，处理业务。</li></ol> 
<h4><a id="_22"></a>源代码：</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;ctype.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span>	</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token expression"><span class="token number">6666</span></span></span>

<span class="token keyword">void</span> <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">perror</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">wait_child</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span>		<span class="token comment">//信号捕捉，回收子进程</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>WNOHANG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//	if(waitpid(0,NULL,0)!=-1)</span>
<span class="token comment">//		printf("disconnect a client successfully\n");</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr_s<span class="token punctuation">,</span>addr_c<span class="token punctuation">;</span>
	<span class="token class-name">socklen_t</span> addr_c_len<span class="token operator">=</span><span class="token keyword">sizeof</span> addr_c<span class="token punctuation">;</span>
	<span class="token keyword">int</span> lfd<span class="token punctuation">,</span>cfd<span class="token punctuation">,</span>res<span class="token punctuation">,</span>n<span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">,</span>client_IP<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	lfd<span class="token operator">=</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>lfd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"socket error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	addr_s<span class="token punctuation">.</span>sin_family<span class="token operator">=</span>AF_INET<span class="token punctuation">;</span>
	addr_s<span class="token punctuation">.</span>sin_port<span class="token operator">=</span><span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	addr_s<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token operator">=</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	res<span class="token operator">=</span><span class="token function">bind</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr_s<span class="token punctuation">,</span><span class="token keyword">sizeof</span> addr_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"bind error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	res<span class="token operator">=</span><span class="token function">listen</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"listen error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cfd<span class="token operator">=</span><span class="token function">accept</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">socket</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr_c<span class="token punctuation">,</span><span class="token operator">&amp;</span>addr_c_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//创建子进程</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>			<span class="token comment">//子进程</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">close</span><span class="token punctuation">(</span>lfd<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//打印客户端的IP和端口号，可以省略</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"connect successfully,client IP:%s,port:%d\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span><span class="token operator">&amp;</span>addr_c<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span><span class="token operator">&amp;</span>client_IP<span class="token punctuation">,</span><span class="token keyword">sizeof</span> client_IP<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">ntohs</span><span class="token punctuation">(</span>addr_c<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">close</span><span class="token punctuation">(</span>cfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			act<span class="token punctuation">.</span>sa_handler<span class="token operator">=</span>wait_child<span class="token punctuation">;</span>
			<span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
			act<span class="token punctuation">.</span>sa_flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span><span class="token operator">&amp;</span>act<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>		<span class="token comment">//父进程</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			n<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>cfd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
				buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">toupper</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">write</span><span class="token punctuation">(</span>cfd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">close</span><span class="token punctuation">(</span>cfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>lfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_116"></a>效果</h4> 
<p><img src="https://images2.imgbox.com/d3/d0/KJdt2AiS_o.png" alt="1"></p> 
<hr> 
<h3><a id="_120"></a>多线程并发服务器</h3> 
<h4><a id="_121"></a>思路（步骤）：</h4> 
<ol><li>前期准备工作： 
  <ul><li>先用<code>socket()</code>生成一个套接字<code>lfd</code>用来监听</li><li>用<code>bind()</code>对第一步生成的套接字绑定地址结构（绑的是服务器的地址结构）</li><li>用<code>listen()</code>函数设置<code>lfd</code>的监听上限，最大是128.</li></ul> </li><li>进入循环，<code>accept</code>与客户端建立连接，得到用于通信的套接字的文件描述符<code>cfd</code></li><li>创建子线程</li><li>对于子线程，由于子线程只是进行通信，不需要监听，所以我们就关闭<code>lfd</code>，然后就与客户端进行通信，处理业务。</li><li>对于父进程，由于父线程只是监听，不需要与客户端进行通信，所以我们就关闭<code>cfd</code>，然后设置线程<code>pthread_detach()</code>分离或者使用<code>pthread_join()</code>回收子线程。</li></ol> 
<h4><a id="_131"></a>源代码</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;ctype.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token expression"><span class="token number">6666</span></span></span>

<span class="token keyword">void</span> <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">perror</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> cfd<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> arg<span class="token punctuation">,</span>n<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		n<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>cfd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"one client closed......\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">toupper</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">write</span><span class="token punctuation">(</span>cfd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>cfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
	
	

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr_s<span class="token punctuation">,</span>addr_c<span class="token punctuation">;</span>
	socklen_t addr_c_len<span class="token operator">=</span><span class="token keyword">sizeof</span> addr_c<span class="token punctuation">;</span>
	<span class="token keyword">char</span> c_IP<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> lfd<span class="token punctuation">,</span>cfd<span class="token punctuation">,</span>res<span class="token punctuation">;</span>
	pthread_t tid<span class="token punctuation">;</span>

	addr_s<span class="token punctuation">.</span>sin_family<span class="token operator">=</span>AF_INET<span class="token punctuation">;</span>
	addr_s<span class="token punctuation">.</span>sin_port<span class="token operator">=</span><span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	addr_s<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token operator">=</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>

	lfd<span class="token operator">=</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>lfd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"socket errro"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	res<span class="token operator">=</span><span class="token function">bind</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr_s<span class="token punctuation">,</span><span class="token keyword">sizeof</span> addr_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"bind error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	res<span class="token operator">=</span><span class="token function">listen</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"listen error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accepting connect........\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cfd<span class="token operator">=</span><span class="token function">accept</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span> addr_c<span class="token punctuation">,</span><span class="token operator">&amp;</span>addr_c_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>cfd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"accept error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"connect successfully,client ip:%s,port:%d\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span><span class="token operator">&amp;</span>addr_c<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span>c_IP<span class="token punctuation">,</span><span class="token keyword">sizeof</span> c_IP<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">ntohs</span><span class="token punctuation">(</span>addr_c<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		res<span class="token operator">=</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>fun<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>cfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"pthread create error:%s"</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">pthread_detach</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"pthread create error:%s"</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>lfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_218"></a>效果</h4> 
<p><img src="https://images2.imgbox.com/ba/1b/PU5TFMM2_o.png" alt="1"></p> 
<hr> 
<h3><a id="_222"></a>写在最后</h3> 
<p>个人亲身经验：我们学习的一系列Linux命令，一定要自己<strong>亲手去敲</strong>。不要只是看别人敲代码，不要只是停留在眼睛看，脑袋以为自己懂了，等你实际上手去敲会发现许许多多的这样那样的问题。毕竟“<strong>实践出真知</strong>”。</p> 
<hr> 
<blockquote> 
 <p>如果你觉得我写的题解还不错的，请各位<strong>王子公主</strong>移步到我的其他题解看看</p> 
 <ol><li><strong>数据结构与算法部分（还在更新中）：</strong></li></ol> 
 <ul><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135051716?spm=1001.2014.3001.5501"><em><strong>C++ STL总结 - 基于算法竞赛（强力推荐</strong></em>）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135103012?spm=1001.2014.3001.5501">动态规划——01背包问题</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135111459">动态规划——完全背包问题</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135125267">动态规划——多重背包问题</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135134277">动态规划——分组背包问题</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135150351">动态规划——最长上升子序列（LIS)</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135167817">二叉树的中序遍历（三种方法）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135183977">最长回文子串</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/134869064?spm=1001.2014.3001.5501">最短路算法——Dijkstra（C++实现）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/134935786?spm=1001.2014.3001.5501">最短路算法———Bellman_Ford算法（C++实现）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135004393?spm=1001.2014.3001.5501">最短路算法———SPFA算法（C++实现）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135026901?spm=1001.2014.3001.5501">最小生成树算法———prim算法（C++实现）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135039904?spm=1001.2014.3001.5501">最小生成树算法———Kruskal算法（C++实现）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135094296?spm=1001.2014.3001.5501">染色法判断二分图（C++实现）</a></li></ul> 
 <ol start="2"><li><strong>Linux部分（还在更新中）：</strong></li></ol> 
 <ul><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/134953315?spm=1001.2014.3001.5501">Linux学习之初识Linux</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/134956923?spm=1001.2014.3001.5501">Linux学习之命令行基础操作</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135189166">Linux学习之基础命令（适合小白）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135222868">Linux学习之权限管理和用户管理</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135275850">Linux学习之制作静态库和动态库</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135288190">Linux学习之makefile</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135324720">Linux学习之系统编程1（关于读写系统函数）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135338115">Linux学习之系统编程2（关于进程及其相关的函数）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135354402">Linux学习之系统编程3（进程及wait函数）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135383973">Linux学习之系统编程4(进程间通信）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135408188">Linux学习之系统编程5(信号）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135438595">Linux学习之系统编程6(线程）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135460669">Linux学习之系统编程7(线程同步/互斥锁/信号量/条件变量）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135501042">Linux学习之网络编程（纯理论）</a></li><li><a href="https://blog.csdn.net/yourgrandfather_/article/details/135535927">Linux学习之网络编程2（socket，简单C/S模型）</a></li></ul> 
</blockquote> 
<h3><a id="_258"></a>✨🎉总结</h3> 
<p>“种一颗树最好的是十年前,其次就是现在”<br> 所以,<br> “让我们一起努力吧,去奔赴更高更远的山海”<br> <img src="https://images2.imgbox.com/f9/06/UrPxVgU8_o.png" alt="在这里插入图片描述" width="400" height="250"><br> 如果有错误❌,欢迎指正哟😋</p> 
<p>🎉如果觉得收获满满,可以动动小手,点点赞👍,支持一下哟🎉</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/afe479eab41731609c5a28db058390f3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PLC-IoT 网关开发札记（2）：Xamarin Forms 工程获取App当前的版本号</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/09ded78763909808d9450520fe0f38a2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">windows安装conda环境，开发openai应用准备，运行第一个ai程序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>