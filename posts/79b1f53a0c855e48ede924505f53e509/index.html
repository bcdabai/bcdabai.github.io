<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微博URL短地址lua生成算法 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微博URL短地址lua生成算法" />
<meta property="og:description" content="短地址（Short URL），或 叫短网址、短链接等等 ，就是比较短的URL地址。 借助短地址，可以将原来冗长的网址替换成简短的网址，让使用者可以更容易分享链接。 在Web 2.0的今天，不得不说，这是一个潮流（我喜欢这句话，就 原封不动 从别人文章复制过来了）。 例如：http://t.cn/pQ8LLW 短地址，主要应用场景是微博。微博消息限制字数为140字，如果要发一些链接，这个网址可能占用一半字数了，所以短地址就应运而生。 短地址的生成算法有很多种，这里取其中一种做实现。无论哪种算法都不能避免重复，所以要结合数据库对网址和短地址做映射。 结合MD5的实现算法： 1. 将网址md5后生成32位串，分4段， 每段8字节 2. 对这四段循环处理，和0x3FFFFFFF与运算，即保留30位数据 3. 根据字母表长度取索引值，如a-zA-Z0-9，就有62位，取0x3D （下标从0开始） 4. 将前面的30位数据分成6段，每5位再和0x3D与运算，算得字母表下标，取到6位字符串 这种算法，会生成4个6位字符串。 lua版的算法如下： local md5 = require &#34;md5.core&#34; function md5.sumhexa(k) k = md5.sum(k) return (string.gsub(k, &#34;.&#34;, function (c) return string.format(&#34;%02x&#34;, string.byte(c)) end)) end local SHORT_BASE = { &#34;a&#34; , &#34;b&#34; , &#34;c&#34; , &#34;d&#34; , &#34;e&#34; , &#34;f&#34; , &#34;g&#34; , &#34;h&#34; , &#34;i&#34; , &#34;j&#34; , &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/79b1f53a0c855e48ede924505f53e509/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-08-26T11:03:00+08:00" />
<meta property="article:modified_time" content="2016-08-26T11:03:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微博URL短地址lua生成算法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <span style="font-family:'微软雅黑';font-size:14px;line-height:21px;">短地址（Short URL），或</span> 
<span style="font-family:'微软雅黑';font-size:14px;line-height:1.5;">叫短网址、短链接等等</span> 
<span style="font-family:'微软雅黑';font-size:14px;line-height:21px;">，就是比较短的URL地址。</span> 
<span style="font-family:'微软雅黑';font-size:14px;line-height:1.5;">借助<span style="line-height:1.5;">短地址</span>，可以将原来冗长的网址<span style="line-height:1.5;">替换成简短的网址</span>，让使用者可以更容易分享链接。</span> 
<span style="font-family:'微软雅黑';font-size:14px;line-height:21px;">在Web 2.0的今天，不得不说，这是一个潮流（我喜欢这句话，就</span> 
<span style="font-family:'微软雅黑';font-size:14px;line-height:1.5;">原封不动</span> 
<span style="font-family:'微软雅黑';font-size:14px;line-height:21px;">从别人文章复制过来了）。</span> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;">例如：http://t.cn/pQ8LLW</span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;"><br style="background-color:inherit;"></span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;">短地址，主要应用场景是微博。微博消息限制字数为140字，如果要发一些链接，这个网址可能占用一半字数了，所以短地址就应运而生。</span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;"><br style="background-color:inherit;"></span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;">
  短地址的生成算法有很多种，这里取其中一种做实现。无论哪种算法都不能避免重复，所以要结合数据库对网址和短地址做映射。 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <br style="background-color:inherit;"> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;">
  结合MD5的实现算法： 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;">1. 将网址md5后生成32位串，分4段， 每段8字节</span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;">2. 对这四段循环处理，和0x3FFFFFFF与运算，即保留30位数据</span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;">3. 根据字母表长度取索引值，如a-zA-Z0-9，就有62位，取0x3D （下标从0开始）</span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;">4. 将前面的30位数据分成6段，每5位再和<span style="line-height:1.5;">0x3D与运算，算得</span>字母表下标，取到6位字符串</span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;">这种算法，会生成4个6位字符串。</span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;"><br style="background-color:inherit;"></span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;">lua版的算法如下：</span> 
</div> 
<div style="font-family:'微软雅黑';font-size:14px;line-height:21px;"> 
 <span style="background-color:inherit;line-height:1.5;"></span> 
 <pre><code class="language-plain">local md5 = require "md5.core"
function md5.sumhexa(k)
	k = md5.sum(k)
	return (string.gsub(k, ".", function (c)
		return string.format("%02x", string.byte(c))
	end))
end

local SHORT_BASE = {
	"a" , "b" , "c" , "d" , "e" , "f" , "g" , "h" , "i" , "j" , "k" , "l" ,
	"m" , "n" , "o" , "p" , "q" , "r" , "s" , "t" , "u" , "v" , "w" , "x" ,
	"y" , "z" , "0" , "1" , "2" , "3" , "4" , "5" , "6" , "7" , "8" , "9" ,
	"A" , "B" , "C" , "D" , "E" , "F" , "G" , "H" , "I" , "J" , "K" , "L" ,
	"M" , "N" , "O" , "P" , "Q" , "R" , "S" , "T" , "U" , "V" , "W" , "X" ,
	"Y" , "Z"
}
local SHORT_PRE = "short_pre"

function short_url(str)
	local m = md5.sumhexa(SHORT_PRE..str)
	local ret = {}
	for k=0,3 do
			local sub = string.sub(m, k*8+1, k*8+8)
			local int =  0x3fffffff &amp; tonumber(sub, 16)
			local out = ''
			for j=1,6 do
					local v = ( 0x3d &amp; int) + 1
					out = out .. SHORT_BASE[v]
					int = int &gt;&gt; 5
			end
			table.insert(ret, out)
	end
	return ret
end

local ret = short_url("hello world")
for k,v in pairs(ret) do
	print("short_url", v)
end</code></pre> 
</div> 
<p>注意了，lua比较特殊，数组下标从1开始。结果如下：</p> 
<p><img src="https://images2.imgbox.com/38/ef/8eDbVKUi_o.png" alt=""><br></p> 
<p><br></p> 
<p>另外，再提供可让用户输入的短地址版本。就是只保留大写字母和数字，同时去掉了容易混淆的O0I1 。算法类似，可做激活码。</p> 
<p></p> 
<pre><code class="language-plain">local md5 = require "md5.core"
function md5.sumhexa(k)
	k = md5.sum(k)
	return (string.gsub(k, ".", function (c)
		return string.format("%02x", string.byte(c))
	end))
end

local SHORT_BASE = {
	'A','B','C','D','E','F','G','H',
	'J','K','L','M','N','P','Q','R',
	'S','T','U','V','W','X','Y','Z',
	'2','3','4','5','6','7','8','9',
}
local SHORT_PRE = "short_pre"

function short_url(str)
	local m = md5.sumhexa(SHORT_PRE..str)
	local ret = {}
	for k=0,3 do
			local sub = string.sub(m, k*8+1, k*8+8)
			local int =  0x3fffffff &amp; tonumber(sub, 16)
			local out = ''
			for j=1,6 do
					local v = ( 0x1f &amp; int) + 1
					out = out .. SHORT_BASE[v]
					int = int &gt;&gt; 5
			end
			table.insert(ret, out)
	end
	return ret
end

local ret = short_url("hello world")
for k,v in pairs(ret) do
	print("short_url", v)
end</code></pre>结果如下： 
<p><img src="https://images2.imgbox.com/71/6d/I3vNV2OS_o.png" alt=""><br><br></p> 
<p>参考：</p> 
<p>http://blog.csdn.net/mycwq/article/details/52326266<br></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a68fad09a5cbaf77b259d1cbe14de092/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">hibernate 多查询or的用法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7206705742435adef1a1e8d2a92897c2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">贪心算法----整数区间</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>