<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ç²¾é€šé«˜å¹¶å‘ä¸å¤šçº¿ç¨‹ï¼Œå´ä¸ä¼šç”¨ThreadLocalï¼Ÿ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ç²¾é€šé«˜å¹¶å‘ä¸å¤šçº¿ç¨‹ï¼Œå´ä¸ä¼šç”¨ThreadLocalï¼Ÿ" />
<meta property="og:description" content="å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªæ¸´æœ›åœ¨äº’è”ç½‘è¡Œä¸šåšåˆ°è”¡ä¸èœçš„å°èœã€‚å¯æŸ”å¯åˆšï¼Œç‚¹èµåˆ™æŸ”ï¼Œç™½å«–åˆ™åˆšï¼
æ­»é¬¼~çœ‹å®Œè®°å¾—ç»™æˆ‘æ¥ä¸ªä¸‰è¿å“¦ï¼
æœ¬æ–‡ä¸»è¦ä»‹ç» ThreadLocal çš„ä½¿ç”¨
å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å‚è€ƒ
å¦‚æœ‰å¸®åŠ©ï¼Œä¸å¿˜ ç‚¹èµ â¥
å¾®ä¿¡å…¬ä¼—å·å·²å¼€å¯ï¼Œå°èœè‰¯è®°ï¼Œæ²¡å…³æ³¨çš„åŒå­¦ä»¬è®°å¾—å…³æ³¨å“¦ï¼
ä¹‹å‰æˆ‘ä»¬æœ‰åœ¨å¹¶å‘ç³»åˆ—ä¸­æåˆ° ThreadLocal ç±»å’ŒåŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸‹ ThreadLocal ç©¶ç«Ÿæ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼
ThreadLocal ç®€ä»‹ æ¦‚å¿µ ThreadLocal ç±»æ˜¯ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚è¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆget å’Œ set æ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ã€‚ ThreadLocal å®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯ private static ç±»å‹çš„ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œä¸Šä¸‹æ–‡ã€‚
ä½œç”¨ ä¼ é€’æ•°æ® æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚å¯ä»¥é€šè¿‡ ThreadLocal åœ¨åŒä¸€çº¿ç¨‹ï¼Œä¸åŒç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡ã€‚
çº¿ç¨‹å¹¶å‘ é€‚ç”¨äºå¤šçº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹ã€‚
çº¿ç¨‹éš”ç¦» æ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šç›¸äº’å½±å“ã€‚
ThreadLocal å®æˆ˜ 1. å¸¸è§æ–¹æ³• ThreadLocal () æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡
void set (T value) è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡
T get () è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡
void remove () ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡
2. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ ThreadLocal é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ç»„å¹¶å‘æ¡ä»¶ä¸‹çš„ä»£ç åœºæ™¯ï¼š
@Data public class ThreadLocalTest { private String name; public static void main(String[] args) { ThreadLocalTest tmp = new ThreadLocalTest(); for (int i = 0; i &lt; 4; i&#43;&#43;) { Thread thread = new Thread(() -&gt; { tmp." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f81e7a686680d03d0d8fc531796687da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-08T17:02:04+08:00" />
<meta property="article:modified_time" content="2020-11-08T17:02:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ç²¾é€šé«˜å¹¶å‘ä¸å¤šçº¿ç¨‹ï¼Œå´ä¸ä¼šç”¨ThreadLocalï¼Ÿ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªæ¸´æœ›åœ¨äº’è”ç½‘è¡Œä¸šåšåˆ°è”¡ä¸èœçš„å°èœã€‚å¯æŸ”å¯åˆšï¼Œç‚¹èµåˆ™æŸ”ï¼Œç™½å«–åˆ™åˆšï¼<br> <strong>æ­»é¬¼~çœ‹å®Œè®°å¾—ç»™æˆ‘æ¥ä¸ªä¸‰è¿å“¦ï¼</strong></p> 
<p><img src="https://images2.imgbox.com/d5/19/LL2OrhfV_o.png" alt=""></p> 
<blockquote> 
 <p>æœ¬æ–‡ä¸»è¦ä»‹ç» <code>ThreadLocal çš„ä½¿ç”¨</code></p> 
 <p>å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å‚è€ƒ</p> 
 <p>å¦‚æœ‰å¸®åŠ©ï¼Œä¸å¿˜ <strong>ç‚¹èµ</strong> â¥</p> 
 <p>å¾®ä¿¡å…¬ä¼—å·å·²å¼€å¯ï¼Œ<strong>å°èœè‰¯è®°</strong>ï¼Œæ²¡å…³æ³¨çš„åŒå­¦ä»¬è®°å¾—å…³æ³¨å“¦ï¼</p> 
</blockquote> 
<p>ä¹‹å‰æˆ‘ä»¬æœ‰åœ¨å¹¶å‘ç³»åˆ—ä¸­æåˆ° <code>ThreadLocal</code> ç±»å’ŒåŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸‹ <code>ThreadLocal</code> ç©¶ç«Ÿæ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼</p> 
<h3><a id="ThreadLocal__18"></a>ThreadLocal ç®€ä»‹</h3> 
<h4><a id="_20"></a>æ¦‚å¿µ</h4> 
<p><strong>ThreadLocal</strong> ç±»æ˜¯ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚è¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆ<strong>get</strong> å’Œ <strong>set</strong> æ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ã€‚ <strong>ThreadLocal</strong> å®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯ <strong>private static</strong> ç±»å‹çš„ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œä¸Šä¸‹æ–‡ã€‚</p> 
<h4><a id="_24"></a>ä½œç”¨</h4> 
<ul><li><strong>ä¼ é€’æ•°æ®</strong></li></ul> 
<p>æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚å¯ä»¥é€šè¿‡ <strong>ThreadLocal</strong> åœ¨åŒä¸€çº¿ç¨‹ï¼Œä¸åŒç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡ã€‚</p> 
<ul><li><strong>çº¿ç¨‹å¹¶å‘</strong></li></ul> 
<p>é€‚ç”¨äºå¤šçº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹ã€‚</p> 
<ul><li><strong>çº¿ç¨‹éš”ç¦»</strong></li></ul> 
<p>æ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šç›¸äº’å½±å“ã€‚</p> 
<h3><a id="ThreadLocal__38"></a>ThreadLocal å®æˆ˜</h3> 
<h4><a id="1__40"></a>1. å¸¸è§æ–¹æ³•</h4> 
<ul><li><strong><code>ThreadLocal ()</code></strong></li></ul> 
<p><strong>æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡</strong></p> 
<ul><li><strong><code>void set (T value)</code></strong></li></ul> 
<p>è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</p> 
<ul><li><strong><code>T get ()</code></strong></li></ul> 
<p><strong>è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</strong></p> 
<ul><li><strong><code>void remove ()</code></strong></li></ul> 
<p><strong>ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</strong></p> 
<h4><a id="2__ThreadLocal_58"></a>2. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ ThreadLocal</h4> 
<p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ç»„å¹¶å‘æ¡ä»¶ä¸‹çš„ä»£ç åœºæ™¯ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ThreadLocalTest tmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Thread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                tmp<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                   <span class="token string">"\t æ‹¿åˆ°æ•°æ®ï¼š"</span> <span class="token operator">+</span> tmp<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Thread-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>æˆ‘ä»¬ç†æƒ³ä¸­çš„ä»£ç è¾“å‡ºç»“æœåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p> 
<pre><code class="prism language-java"><span class="token comment">/** OUTPUT **/</span>
Thread<span class="token operator">-</span><span class="token number">0</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">0</span>
Thread<span class="token operator">-</span><span class="token number">1</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">1</span>
Thread<span class="token operator">-</span><span class="token number">2</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">2</span>
Thread<span class="token operator">-</span><span class="token number">3</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">3</span>
</code></pre> 
<p>ä½†æ˜¯å®é™…ä¸Šè¾“å‡ºçš„ç»“æœå´æ˜¯è¿™æ ·çš„ï¼š</p> 
<pre><code class="prism language-java"><span class="token comment">/** OUTPUT **/</span>
Thread<span class="token operator">-</span><span class="token number">0</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">1</span>
Thread<span class="token operator">-</span><span class="token number">3</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">3</span>
Thread<span class="token operator">-</span><span class="token number">1</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">1</span>
Thread<span class="token operator">-</span><span class="token number">2</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">2</span>
</code></pre> 
<p>é¡ºåºä¹±äº†æ²¡æœ‰å…³ç³»ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <strong>Thread-0</strong> è¿™ä¸ªçº¿ç¨‹æ‹¿åˆ°çš„å€¼å´æ˜¯ <strong>Thread-1</strong></p> 
<p>ä»ç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªå˜é‡çš„æ—¶å€™ä¼šå‡ºç°å¼‚å¸¸ï¼Œè¿™æ˜¯å› ä¸ºçº¿ç¨‹é—´çš„æ•°æ®æ²¡æœ‰éš”ç¦»ï¼</p> 
<p>å¹¶å‘çº¿ç¨‹å‡ºç°çš„é—®é¢˜ï¼Ÿé‚£åŠ é”ä¸å°±å®Œäº‹äº†ï¼è¿™ä¸ªæ—¶å€™ä½ ä¸‰ä¸‹äº”é™¤äºŒçš„å†™ä¸‹äº†ä»¥ä¸‹ä»£ç ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ThreadLocalTest tmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Thread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    tmp<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
                                       <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> tmp<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Thread-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/** OUTPUT **/</span>
Thread<span class="token operator">-</span><span class="token number">2</span>	Thread<span class="token operator">-</span><span class="token number">2</span>
Thread<span class="token operator">-</span><span class="token number">3</span>	Thread<span class="token operator">-</span><span class="token number">3</span>
Thread<span class="token operator">-</span><span class="token number">1</span>	Thread<span class="token operator">-</span><span class="token number">1</span>
Thread<span class="token operator">-</span><span class="token number">0</span>	Thread<span class="token operator">-</span><span class="token number">0</span>
</code></pre> 
<p>ä»ç»“æœä¸Šçœ‹ï¼ŒåŠ é”å¥½åƒæ˜¯è§£å†³äº†ä¸Šè¿°é—®é¢˜ï¼Œä½†æ˜¯ <strong>synchronized</strong> å¸¸ç”¨äºå¤šçº¿ç¨‹æ•°æ®å…±äº«çš„é—®é¢˜ï¼Œè€Œéå¤šçº¿ç¨‹æ•°æ®éš”ç¦»çš„é—®é¢˜ã€‚è¿™é‡Œä½¿ç”¨ <strong>synchronized</strong> è™½ç„¶è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å¤šå°‘æœ‰äº›ä¸åˆé€‚ï¼Œå¹¶ä¸” <strong>synchronized</strong> å±äºé‡é‡çº§é”ï¼Œä¸ºäº†å®ç°å¤šçº¿ç¨‹æ•°æ®éš”ç¦»è´¸ç„¶çš„åŠ ä¸Š <strong>synchronized</strong>ï¼Œä¹Ÿä¼šå½±å“åˆ°æ€§èƒ½ã€‚</p> 
<p>åŠ é”çš„æ–¹æ³•ä¹Ÿè¢«å¦å®šäº†ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³ï¼Ÿä¸å¦‚ç”¨ <strong>ThreadLocal</strong> ç‰›åˆ€å°è¯•ä¸€ç•ªï¼š</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> ThreadLocal<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ThreadLocalTest tmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Thread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                tmp<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
                                   <span class="token string">"\t æ‹¿åˆ°æ•°æ®ï¼š"</span> <span class="token operator">+</span> tmp<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Thread-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>åœ¨æŸ¥çœ‹è¾“å‡ºç»“æœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä»£ç å‘ç”Ÿäº†é‚£äº›å˜åŒ–</p> 
<p>é¦–å…ˆå¤šäº†ä¸€ä¸ª <code>private static</code> ä¿®é¥°çš„ <strong>ThreadLocal</strong> ï¼Œç„¶ååœ¨ <code>setName</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯å¾€ <strong>ThreadLocal</strong> é‡Œé¢å­˜æ•°æ®ï¼Œåœ¨ <code>getName</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯åœ¨ <strong>ThreadLocal</strong> é‡Œé¢å–æ•°æ®ã€‚æ„Ÿè§‰æ“ä½œä¸Šä¹Ÿæ˜¯æŒºç®€å•çš„ï¼Œä½†æ˜¯è¿™æ ·çœŸçš„èƒ½åšåˆ°çº¿ç¨‹é—´çš„æ•°æ®éš”ç¦»å—ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€çœ‹ç»“æœï¼š</p> 
<pre><code class="prism language-java"><span class="token comment">/** OUTPUT **/</span>
Thread<span class="token operator">-</span><span class="token number">1</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">1</span>
Thread<span class="token operator">-</span><span class="token number">2</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">2</span>
Thread<span class="token operator">-</span><span class="token number">0</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">0</span>
Thread<span class="token operator">-</span><span class="token number">3</span>	 æ‹¿åˆ°æ•°æ®ï¼šThread<span class="token operator">-</span><span class="token number">3</span>
</code></pre> 
<p>ä»ç»“æœä¸Šå¯ä»¥çœ‹åˆ°æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½å–åˆ°å¯¹åº”çš„æ•°æ®ã€‚<strong>ThreadLocal</strong> ä¹Ÿå·²ç»è§£å†³äº†å¤šçº¿ç¨‹ä¹‹é—´æ•°æ®éš”ç¦»çš„é—®é¢˜ã€‚</p> 
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥å°ç»“ä¸€ä¸‹ï¼Œ<strong>ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ThreadLocalï¼Œä¸ synchronized çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</strong></p> 
<ul><li><strong>synchronized</strong></li></ul> 
<p><strong>åŸç†ï¼š</strong> åŒæ­¥æœºåˆ¶é‡‡ç”¨ â€œä»¥æ—¶é—´æ¢ç©ºé—´â€ çš„æ–¹å¼ï¼Œåªæä¾›äº†ä¸€ä»½å˜é‡ï¼Œè®©ä¸åŒçº¿ç¨‹æ’é˜Ÿè®¿é—®</p> 
<p><strong>ä¾§é‡ç‚¹ï¼š</strong> å¤šä¸ªçº¿ç¨‹ä¹‹é—´åŒæ­¥è®¿é—®èµ„æº</p> 
<ul><li><strong>ThreadLocal</strong></li></ul> 
<p><strong>åŸç†ï¼š</strong> ThreadLocal é‡‡ç”¨ â€œä»¥ç©ºé—´æ¢æ—¶é—´â€ çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡çš„å‰¯æœ¬ï¼Œä»è€Œå®ç°åŒæ—¶è®¿é—®è€Œäº’ä¸å¹²æ‰°</p> 
<p><strong>ä¾§é‡ç‚¹ï¼š</strong> å¤šçº¿ç¨‹ä¸­è®©æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»</p> 
<h4><a id="3__196"></a>3. å†…éƒ¨ç»“æ„</h4> 
<p>ä»ä¸Šé¢çš„æ¡ˆä¾‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <strong>ThreadLocal</strong> çš„ä¸¤ä¸ªä¸»è¦æ–¹æ³•åˆ†åˆ«æ˜¯ <code>set()</code> å’Œ <code>get()</code></p> 
<p>é‚£æˆ‘ä»¬ä¸å¦¨çŒœæƒ³ä¸€ä¸‹ï¼Œå¦‚æœè®©æˆ‘ä»¬æ¥è®¾è®¡ <strong>ThreadLocal</strong> ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è®¾è®¡ï¼Œæ˜¯å¦ä¼šæœ‰è¿™æ ·çš„æƒ³æ³•ï¼šæ¯ä¸ª <strong>ThreadLocal</strong> éƒ½åˆ›å»ºä¸€ä¸ª <strong>Map</strong>ï¼Œç„¶åç”¨çº¿ç¨‹ä½œä¸º <strong>Map</strong> çš„ <strong>key</strong>ï¼Œè¦å­˜å‚¨çš„å±€éƒ¨å˜é‡ä½œä¸º <strong>Map</strong> çš„ <strong>value</strong> ï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡éš”ç¦»çš„æ•ˆæœã€‚</p> 
<p><img src="https://images2.imgbox.com/20/a4/wHEOxfTH_o.png" alt=""></p> 
<p>è¿™ä¸ªæƒ³æ³•ä¹Ÿæ˜¯æ²¡é”™çš„ï¼Œæ—©æœŸçš„ <strong>ThreadLocal</strong> ä¾¿æ˜¯è¿™æ ·è®¾è®¡çš„ï¼Œä½†æ˜¯åœ¨ <strong>JDK 8</strong> ä¹‹åä¾¿æ›´æ”¹äº†è®¾è®¡ï¼Œå¦‚ä¸‹ï¼š</p> 
<p><img src="https://images2.imgbox.com/14/db/CkQhf2ga_o.png" alt=""></p> 
<p>è®¾è®¡è¿‡ç¨‹ï¼š</p> 
<ol><li> <p>æ¯ä¸ª <strong>Thread</strong> çº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª <strong>ThreadLocalMap</strong></p> </li><li> <p><strong>ThreadLocalMap</strong> ä¸­å­˜å‚¨ç€ä»¥ <strong>ThreadLocal</strong> å¯¹è±¡ä¸º <strong>key</strong> ï¼Œçº¿ç¨‹å˜é‡ä¸º <strong>value</strong></p> </li><li> <p><strong>Thread</strong> å†…éƒ¨çš„ <strong>Map</strong> æ˜¯ç”± <strong>ThreadLocal</strong> ç»´æŠ¤çš„ï¼Œç”± <strong>ThreadLocal</strong> è´Ÿè´£å‘ <strong>Map</strong> è®¾ç½®å’Œè·å–çº¿ç¨‹çš„å˜é‡å€¼</p> </li><li> <p>å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œè¿™æ ·å°±ä¼šå½¢æˆå‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°</p> </li></ol> 
<p><strong>æ³¨ï¼š</strong> æ¯ä¸ªçº¿ç¨‹éƒ½è¦æœ‰è‡ªå·±çš„ä¸€ä¸ª <strong>map</strong>ï¼Œä½†æ˜¯è¿™ä¸ªç±»å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ <strong>Java</strong> ç±»ï¼Œå¹¶æ²¡æœ‰å®ç° <strong>Map</strong> æ¥å£ï¼Œä½†æ˜¯å…·æœ‰ç±»ä¼¼ <strong>Map</strong> ç±»ä¼¼çš„åŠŸèƒ½ã€‚</p> 
<p><img src="https://images2.imgbox.com/65/2b/Lyg9nzWW_o.png" alt=""></p> 
<p>é€šè¿‡è¿™æ ·å®ç°çœ‹èµ·æ¥è²Œä¼¼ä¼šæ¯”ä¹‹å‰æˆ‘ä»¬çŒœæƒ³çš„æ›´åŠ å¤æ‚ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p> 
<ul><li>æ¯ä¸ª <strong>Map</strong> å­˜å‚¨çš„ <strong>Entry</strong> æ•°é‡å°±ä¼šå˜å°‘ï¼Œå› ä¸ºä¹‹å‰çš„å­˜å‚¨æ•°é‡ç”± <strong>Thread</strong> çš„æ•°é‡å†³å®šï¼Œç°åœ¨æ˜¯ç”± <strong>ThreadMap</strong> çš„æ•°é‡å†³å®šï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œ<strong>ThreadLocal</strong> çš„æ•°é‡è¦æ›´å°‘äº <strong>Thread</strong> çš„æ•°é‡ã€‚</li><li>å½“ <strong>Thread</strong> é”€æ¯ä¹‹åï¼Œå¯¹åº”çš„ <strong>ThreadLocalMap</strong> ä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œèƒ½å‡å°‘å†…å­˜çš„ä½¿ç”¨</li></ul> 
<h4><a id="4__225"></a>4. æºç åˆ†æ</h4> 
<p><img src="https://images2.imgbox.com/94/99/xgHHhtvL_o.png" alt=""></p> 
<p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ <strong>ThreadLocalMap</strong> ä¸­æœ‰å“ªäº›æˆå‘˜ï¼š</p> 
<p><img src="https://images2.imgbox.com/b8/78/M8uDNctx_o.png" alt=""></p> 
<p>å¦‚æœä½ çœ‹è¿‡ <strong>HashMap</strong> çš„æºç ï¼Œè‚¯å®šä¼šè§‰å¾—è¿™å‡ ä¸ªç‰¹åˆ«ç†Ÿæ‚‰ï¼Œå…¶ä¸­ï¼š</p> 
<ul><li><strong>INITIAL_CAPACITY</strong>ï¼šåˆå§‹å®¹é‡ï¼Œå¿…é¡»æ˜¯ 2 çš„æ•´æ¬¡å¹‚</li><li><strong>table</strong>ï¼šå­˜æ”¾æ•°æ®çš„<strong>table</strong></li><li><strong>size</strong>ï¼šæ•°ç»„ä¸­ <strong>entries</strong> çš„ä¸ªæ•°ï¼Œç”¨äºåˆ¤æ–­ <strong>table</strong> å½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼</li><li><strong>threshold</strong>ï¼šè¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™ä¼šè¿›è¡Œæ‰©å®¹</li></ul> 
<h5><a id="ThreadLocals_240"></a>ThreadLocals</h5> 
<p><strong>Thread</strong> ç±»ä¸­æœ‰ä¸ªç±»å‹ä¸º <strong>ThreadLocal.ThreadLocalMap</strong> ç±»å‹çš„å˜é‡ <strong>ThreadLocals</strong> ï¼Œè¿™ä¸ªå°±æ˜¯ç”¨æ¥ä¿å­˜æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚</p> 
<p><img src="https://images2.imgbox.com/bf/df/fPls9NpT_o.png" alt=""></p> 
<h5><a id="ThreadLocalMap_246"></a>ThreadLocalMap</h5> 
<p><strong>ThreadLocalMap</strong>æ˜¯<strong>ThreadLocal</strong>çš„å†…éƒ¨ç±»ï¼Œæ¯ä¸ªæ•°æ®ç”¨<strong>Entry</strong>ä¿å­˜ï¼Œå…¶ä¸­çš„<strong>Entry</strong>ç”¨ä¸€ä¸ªé”®å€¼å¯¹å­˜å‚¨ï¼Œé”®ä¸º<strong>ThreadLocal</strong>çš„å¼•ç”¨ã€‚</p> 
<p><img src="https://images2.imgbox.com/f8/e7/tLRTV4xq_o.png" alt=""></p> 
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <strong>Entry</strong> ç»§æ‰¿äº<strong>WeakReference</strong>ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœæ˜¯å¼ºå¼•ç”¨ï¼Œå³ä½¿æŠŠ <strong>ThreadLocal</strong> è®¾ç½®ä¸º <strong>null</strong>ï¼Œ<strong>GC</strong> ä¹Ÿä¸ä¼šå›æ”¶ï¼Œå› ä¸º <strong>ThreadLocalMap</strong> å¯¹å®ƒæœ‰å¼ºå¼•ç”¨ã€‚</p> 
<p>åœ¨æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª<strong>Entry</strong>ä»¥åŠ<strong>CurrentThread</strong>ä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œå§‹ç»ˆæœ‰å¼ºå¼•ç”¨é“¾ <strong>threadRef</strong> <code>-&gt;</code> <strong>currentThread</strong> <code>-&gt;</code> <strong>threadLocalMap</strong> <code>-&gt;</code> <strong>entry</strong>ï¼Œ<strong>Entry</strong>å°±ä¸ä¼šè¢«å›æ”¶ï¼ˆ<strong>Entry</strong>ä¸­åŒ…æ‹¬äº†<strong>ThreadLocal</strong>å®ä¾‹å’Œ<strong>value</strong>ï¼‰ï¼Œå¯¼è‡´<strong>Entry</strong>å†…å­˜æ³„æ¼ã€‚</p> 
<p><img src="https://images2.imgbox.com/e4/bd/OGGrTdyP_o.png" alt=""></p> 
<p>é‚£æ˜¯ä¸æ˜¯å°±æ˜¯è¯´å¦‚æœä½¿ç”¨äº†<strong>å¼±å¼•ç”¨</strong>ï¼Œå°±ä¸ä¼šé€ æˆ<strong>å†…å­˜æ³„éœ²</strong> å‘¢ï¼Œè¿™ä¹Ÿæ˜¯ä¸æ­£ç¡®çš„ã€‚</p> 
<p>å› ä¸ºå¦‚æœæˆ‘ä»¬æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤ <strong>Entry</strong> çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶ <strong>Entry</strong> ä¸­çš„ <strong>key == null</strong>ï¼Œè¿™ä¸ªæ—¶å€™æ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æŒ‡å‘ <strong>threaLocal</strong> å®ä¾‹ï¼Œæ‰€ä»¥ <strong>threadLocal</strong> å°±å¯ä»¥é¡ºåˆ©è¢« <strong>gc</strong> å›æ”¶ï¼Œä½†æ˜¯ <strong>value</strong> ä¸ä¼šè¢«å›æ”¶ï¼Œè€Œè¿™å—çš„ <strong>value</strong> æ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œå› æ­¤ä¼šå¯¼è‡´<strong>å†…å­˜æ³„éœ²</strong></p> 
<p><img src="https://images2.imgbox.com/b2/90/mtjZ0lrl_o.png" alt=""></p> 
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ <strong>ThreadLocalMap</strong> çš„å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š</p> 
<h5><a id="set__266"></a>set æ–¹æ³•</h5> 
<p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸‹æºç ï¼š</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>T value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span>
    Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span>
    ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­mapæ˜¯å¦å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        <span class="token comment">// å­˜åœ¨åˆ™è°ƒç”¨map.setè®¾ç½®æ­¤å®ä½“entry</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸å­˜åœ¨ThreadLocalMapå¯¹è±¡åˆ™è°ƒç”¨createMapè¿›è¡ŒThreadLocalMapå¯¹è±¡çš„åˆå§‹åŒ–</span>
        <span class="token comment">// å¹¶å°† t(å½“å‰çº¿ç¨‹)å’Œvalue(tå¯¹åº”çš„å€¼)ä½œä¸ºç¬¬ä¸€ä¸ªentryå­˜æ”¾è‡³ThreadLocalMapä¸­</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ThreadLocalMap <span class="token function">getMap</span><span class="token punctuation">(</span>Thread t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span>Thread t<span class="token punctuation">,</span> T firstValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//è¿™é‡Œçš„thisæ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„threadLocal</span>
    t<span class="token punctuation">.</span>threadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>æ‰§è¡Œæµç¨‹ï¼š</p> 
<ul><li> <p>é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ª <strong>map</strong></p> </li><li> <p>å¦‚æœè·å–çš„ <strong>map</strong> ä¸ä¸ºç©ºï¼Œåˆ™å°†å‚æ•°è®¾ç½®åˆ° <strong>map</strong> ä¸­ï¼ˆå½“å‰ <strong>ThreadLocal</strong> çš„å¼•ç”¨ä½œä¸º <strong>key</strong> ï¼‰</p> </li><li> <p>å¦‚æœ <strong>Map</strong> ä¸ºç©ºï¼Œåˆ™ç»™è¯¥çº¿ç¨‹åˆ›å»º <strong>map</strong> ï¼Œå¹¶è®¾ç½®åˆå§‹å€¼</p> </li></ul> 
<h5><a id="get__303"></a>get æ–¹æ³•</h5> 
<p>æºç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> T <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span>
    Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span>
    ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæ­¤mapå­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ä»¥å½“å‰çš„ThreadLocal ä¸º keyï¼Œè°ƒç”¨getEntryè·å–å¯¹åº”çš„å­˜å‚¨å®ä½“e</span>
        ThreadLocalMap<span class="token punctuation">.</span>Entry e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¯¹eè¿›è¡Œåˆ¤ç©º </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
            <span class="token comment">// è·å–å­˜å‚¨å®ä½“ e å¯¹åº”çš„ valueå€¼</span>
            <span class="token comment">// å³ä¸ºæˆ‘ä»¬æƒ³è¦çš„å½“å‰çº¿ç¨‹å¯¹åº”æ­¤ThreadLocalçš„å€¼</span>
            T result <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> T <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// è°ƒç”¨initialValueè·å–åˆå§‹åŒ–çš„å€¼</span>
    <span class="token comment">// æ­¤æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™, å¦‚æœä¸é‡å†™é»˜è®¤è¿”å›null</span>
    T value <span class="token operator">=</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span>
    Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span>
    ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­mapæ˜¯å¦å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        <span class="token comment">// å­˜åœ¨åˆ™è°ƒç”¨map.setè®¾ç½®æ­¤å®ä½“entry</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸å­˜åœ¨ThreadLocalMapå¯¹è±¡åˆ™è°ƒç”¨createMapè¿›è¡ŒThreadLocalMapå¯¹è±¡çš„åˆå§‹åŒ–</span>
        <span class="token comment">// å¹¶å°† t(å½“å‰çº¿ç¨‹)å’Œvalue(tå¯¹åº”çš„å€¼)ä½œä¸ºç¬¬ä¸€ä¸ªentryå­˜æ”¾è‡³ThreadLocalMapä¸­</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›è®¾ç½®çš„å€¼value</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>æ‰§è¡Œæµç¨‹ï¼š</p> 
<ul><li>é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œæ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ª <strong>map</strong></li><li>å¦‚æœè·å–çš„ <strong>map</strong> ä¸ä¸ºç©ºï¼Œåˆ™åœ¨ <strong>map</strong> ä¸­ä»¥ <strong>ThreadLocal</strong> çš„å¼•ç”¨ä½œä¸º <strong>key</strong> æ¥åœ¨ <strong>map</strong> ä¸­è·å–å¯¹åº”çš„ <strong>Entry entry</strong> ï¼Œå¦åˆ™è·³è½¬åˆ°<strong>ç¬¬å››æ­¥</strong></li><li>å¦‚æœ <strong>Entry entry</strong> ä¸ä¸ºç©º ï¼Œåˆ™è¿”å› <strong>entry.value</strong> ï¼Œå¦åˆ™è·³è½¬åˆ°<strong>ç¬¬å››æ­¥</strong></li><li><strong>map</strong> ä¸ºç©ºæˆ–è€… <strong>entry</strong> ä¸ºç©ºï¼Œåˆ™é€šè¿‡ <strong>initialValue</strong> å‡½æ•°è·å–åˆå§‹å€¼ <strong>value</strong> ï¼Œç„¶åç”¨ <strong>ThreadLocal</strong> çš„å¼•ç”¨å’Œ <strong>value</strong> ä½œä¸º <strong>firstKey</strong> å’Œ <strong>firstValue</strong> åˆ›å»ºä¸€ä¸ªæ–°çš„ <strong>map</strong></li></ul> 
<h5><a id="remove__357"></a>remove æ–¹æ³•</h5> 
<p>æºç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span>
    ThreadLocalMap m <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæ­¤mapå­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        <span class="token comment">// å­˜åœ¨åˆ™è°ƒç”¨map.remove</span>
        m<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ä»¥å½“å‰ThreadLocalä¸ºkeyåˆ é™¤å¯¹åº”çš„å®ä½“entry</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Entry e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         e <span class="token operator">!=</span> null<span class="token punctuation">;</span>
         e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>æ‰§è¡Œæµç¨‹ï¼š</p> 
<ul><li>é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ª <strong>map</strong></li><li>å¦‚æœè·å¾—çš„<strong>map</strong> ä¸ä¸ºç©ºï¼Œåˆ™ç§»é™¤å½“å‰ <strong>ThreadLocal</strong> å¯¹è±¡å¯¹åº”çš„ <strong>entry</strong></li></ul> 
<h5><a id="initialValue__392"></a>initialValue æ–¹æ³•</h5> 
<p>æºç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> T <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>åœ¨æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä»…ä»…ç®€å•çš„è¿”å›äº† <strong>null</strong> ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨çº¿ç¨‹ç¬¬ä¸€æ¬¡é€šè¿‡ <strong>get ()</strong> æ–¹æ³•è®¿é—®è¯¥çº¿ç¨‹çš„ <strong>ThreadLocal</strong> æ—¶è°ƒç”¨çš„ï¼Œåªæœ‰åœ¨çº¿ç¨‹å…ˆè°ƒç”¨äº† <strong>set ()</strong> æ–¹æ³•æ‰ä¸ä¼šè°ƒç”¨ <strong>initialValue ()</strong> æ–¹æ³•ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–¹æ³•æœ€å¤šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p> 
<p>å¦‚æœä»¬æƒ³è¦ <strong>ThreadLocal</strong> çº¿ç¨‹å±€éƒ¨å˜é‡æœ‰ä¸€ä¸ªé™¤ <strong>null</strong> ä»¥å¤–çš„åˆå§‹å€¼ï¼Œé‚£ä¹ˆå°±å¿…é¡»é€šè¿‡å­ç±»<strong>ç»§æ‰¿</strong> <strong>ThreadLocal</strong> æ¥é‡å†™æ­¤æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡åŒ¿åå†…éƒ¨ç±»å®ç°ã€‚</p> 
<p><strong>ã€ENDã€‘</strong></p> 
<p>è¿™ç¯‡ <strong>ThreadLocal</strong> å°±ä»‹ç»åˆ°è¿™é‡Œå•¦ï¼Œå¸Œæœ›è¯»åˆ°è¿™é‡Œçš„å°ä¼™ä¼´èƒ½å¤Ÿæœ‰æ‰€æ”¶è·ã€‚</p> 
<p>è·¯æ¼«æ¼«ï¼Œå°èœä¸ä½ ä¸€åŒæ±‚ç´¢ï¼</p> 
<p><img src="https://images2.imgbox.com/08/03/Vy26rU7h_o.png" alt="çœ‹å®Œä¸èµï¼Œéƒ½æ˜¯åè›‹"></p> 
<blockquote> 
 <p>ä»Šå¤©çš„ä½ å¤šåŠªåŠ›ä¸€ç‚¹ï¼Œæ˜å¤©çš„ä½ å°±èƒ½å°‘è¯´ä¸€å¥æ±‚äººçš„è¯ï¼</p> 
 <p><em>æˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªå’Œä½ ä¸€èµ·å­¦ä¹ çš„ç”·äººã€‚</em> <code>ğŸ’‹</code></p> 
 <p>å¾®ä¿¡å…¬ä¼—å·å·²å¼€å¯ï¼Œ<strong>å°èœè‰¯è®°</strong>ï¼Œæ²¡å…³æ³¨çš„åŒå­¦ä»¬è®°å¾—å…³æ³¨å“¦ï¼</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c59d5ade752266071f5fb2d583fdbc05/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Dockeré•œåƒä¸‹è½½åŠå®¹å™¨å¯åŠ¨</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2c4be00ca9f2670e8d0203328fcbf1f8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">æ¿€å…‰æ ·å¼ï¼ˆè“æ¡¥æ¯ï¼‰</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>