<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PCIe 链路训练状态机（LTSSM）基础 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PCIe 链路训练状态机（LTSSM）基础" />
<meta property="og:description" content="LTSSM：Link Training and Status State Machine
下图展示了 LTSSM 的顶层状态（顶层状态下包含子状态）：
LTSSM 包含 11 个顶层状态：Detect、Polling、Configuration、Recovery、L0、L0s、L1、L2、Hot Reset、Loopback 和 Disable。这些状态可以分为 5 类：
Link Training states（链路训练状态）Re-Training（Recovery）state（重训练状态）Software driven Power Management State（由软件控制的电源管理状态）Active-State Power Management（ASPM）states（动态电源管理状态）Other states（其他状态） 各种复位（Reset）之后，状态机的改变为：Detect =&gt; Polling =&gt; Configuration =&gt; L0。在 L0 状态下即可进行标准数据交互。
链路的 Re-Training 状态也称为 Recovery（恢复）状态。链路进入 Re-Training 状态的原因有多种，例如从低功耗链路状态（如 L1）退出、改变带宽（改变速率或者宽度）等。在该状态下，链路会根据需要重新执行一部分链路训练的流程，然后进入 L0 状态。
电源管理软件能将设备（Device）切换到低功耗设备状态（D1，D2，D3Hot 或者 D3Cold），这会导致链路进入对应的低功耗链路状态（L1 或者 L2）。
在某一时刻，如果没有数据在传输，那么 ASPM 硬件可以自动将硬件切换到功耗较低的 ASPM 状态（L0s 或者 ASPM L1）。
另外，软件还可以将链路设置为其它的一些特殊状态：Disabled，Loopback 或者 Hot Reset。
1. Detect 状态 当 PCIe 链路被复位或者数据链路层通过填写某些寄存器之后，LTSSM 将进入该状态。当前状态是 LTSSM 的初始状态。当 PCIe 链路进入该状态时，发送逻辑 TX 并不知道对端接收逻辑 RX 的存在，因此需要使用 Receiver Detect 识别逻辑判断对端接收逻辑 RX 是否可以正常共工作，之后才能进入其他状态。能切换到 Detect 状态的状态有：Polling，Configuration，Recovery，Disabled，External Loop back 和 Hot Reset。 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c425c9bad737b0a924514558eb16cd22/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-21T21:00:17+08:00" />
<meta property="article:modified_time" content="2021-04-21T21:00:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PCIe 链路训练状态机（LTSSM）基础</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>LTSSM：Link Training and Status State Machine</p> 
<p>下图展示了 LTSSM 的<strong>顶层状态</strong>（顶层状态下包含子状态）：</p> 
<p><img src="https://images2.imgbox.com/d5/8e/vzSNBu8t_o.png" alt="在这里插入图片描述"></p> 
<p>LTSSM 包含 11 个顶层状态：Detect、Polling、Configuration、Recovery、L0、L0s、L1、L2、Hot Reset、Loopback 和 Disable。这些状态可以分为 5 类：</p> 
<ul><li>Link Training states（链路训练状态）</li><li>Re-Training（Recovery）state（重训练状态）</li><li>Software driven Power Management State（由软件控制的电源管理状态）</li><li>Active-State Power Management（ASPM）states（动态电源管理状态）</li><li>Other states（其他状态）</li></ul> 
<p>各种复位（Reset）之后，状态机的改变为：Detect =&gt; Polling =&gt; Configuration =&gt; L0。在 L0 状态下即可进行标准数据交互。</p> 
<p>链路的 Re-Training 状态也称为 Recovery（恢复）状态。链路进入 Re-Training 状态的原因有多种，例如从低功耗链路状态（如 L1）退出、改变带宽（改变速率或者宽度）等。在该状态下，链路会根据需要重新执行一部分链路训练的流程，然后进入 L0 状态。</p> 
<p>电源管理软件能将设备（Device）切换到低功耗设备状态（D1，D2，D3<sub>Hot</sub> 或者 D3<sub>Cold</sub>），这会导致链路进入对应的低功耗链路状态（L1 或者 L2）。</p> 
<p>在某一时刻，如果没有数据在传输，那么 ASPM 硬件可以自动将硬件切换到功耗较低的 ASPM 状态（L0s 或者 ASPM L1）。</p> 
<p>另外，软件还可以将链路设置为其它的一些特殊状态：Disabled，Loopback 或者 Hot Reset。</p> 
<br> 
<h4><a id="1_Detect__38"></a>1. Detect 状态</h4> 
<ul><li>当 PCIe <strong>链路被复位</strong>或者<strong>数据链路层通过填写某些寄存器</strong>之后，LTSSM 将进入该状态。</li><li>当前状态是 LTSSM 的初始状态。</li><li>当 PCIe 链路进入该状态时，发送逻辑 TX 并不知道对端接收逻辑 RX 的存在，因此需要使用 Receiver Detect 识别逻辑判断对端接收逻辑 RX 是否可以正常共工作，之后才能进入其他状态。</li><li>能切换到 Detect 状态的状态有：Polling，Configuration，Recovery，Disabled，External Loop back 和 Hot Reset。</li></ul> 
<br> 
<h4><a id="2_Polling__49"></a>2. Polling 状态</h4> 
<p>当 PCIe 链路进入该状态时，将向对端发送 TS1 和 TS2 Ordered Sets（2.5 GT/s），并接收对端的 TS1 和 TS2 Ordered Sets（2.5 GT/s）。</p> 
<p>通过接收到的 TS1 和 TS2 序列，完成如下操作：</p> 
<ul><li>获取 Bit Lock</li><li>获取 Symbol Lock 或者 Block Lock</li><li>如果需要，纠正 lane polarity inversion（差分信号极性反转）</li><li>检测支持的速率</li></ul> 
<p>PCIe 链路处于该状态时，将进行 Loopback 测试，确定当前使用的 PCIe 链路可以正常工作。</p> 
<br> 
<h4><a id="3_Configuration__68"></a>3. Configuration 状态</h4> 
<p>发送逻辑 TX 和 接收逻辑 RX 继续以 2.5 GT/s 的速度交换 TS1 和 TS2 Ordered Sets，完成如下任务：</p> 
<ul><li>确定 Link Width</li><li>指定 Lane Number</li><li>根据需要，对 Lane reversal 进行检查并对其进行纠正</li><li>处理 Lane-to-Lane 时序的偏差</li></ul> 
<p>Configuration 状态下，scrambling 可以关闭，该状态可以切换到 Disabled 状态或者 Loopback 状态。<br> 在 TS1 和 TS2 中，还指定了 L0 状态切换到 L0s 状态所需要的 FTS Ordered Sets 的个数。</p> 
<br> 
<h4><a id="4_L0__86"></a>4. L0 状态</h4> 
<p>L0 状态是 PCIe 链路的正常工作状态。该状态下，PCIe 链路可以正常发送和接收 TLP、DLLP 和 Ordered Sets。如果需要切换到高于 2.5 GT/s 的速度传输，则需要进入 Recovery 状态进行链路重训练（Re-Training）。</p> 
<br> 
<h4><a id="5_Recovery__93"></a>5. Recovery 状态</h4> 
<p>PCIe 链路需要进行重训练（Re-Training）时会进入该状态，可能的原因有：</p> 
<ul><li>L0 状态出现错误</li><li>从 L1 状态切换到了 L0 状态</li><li>从 L0s 状态切换到了 L0 状态，但是使用 FTS 流程并没有将链路训练到可用状态</li></ul> 
<p>在 Recovery 状态，重新建立 Bit Lock 和 Symbol/Block Lock 的过程与 Polling 状态相似，但是要比 Polling 状态花的时间更短。</p> 
<br> 
<h4><a id="6_L0s__109"></a>6. L0s 状态</h4> 
<p>L0s 是 ASPM（Active State Power Management）机制提供的第 1 级低功耗状态，该状态可以在较短的时间内切换到 L0 状态。当设备要从 L0 状态切换到 L0s 状态时，需要向外发送 EIOS。当设备要从 L0s 状态切换到 L0 状态时，需要向外发送多个 FTS，从而快速获取 Bit Lock 和 Symbol/Block Lock。</p> 
<br> 
<h4><a id="7_L1__116"></a>7. L1 状态</h4> 
<p>L1 是 ASPM（Active State Power Management）机制提供的第 2 级低功耗状态，它的功耗比 L0s 低，但是需要更长的时间才能切换到 L0 状态。想要进入 L1 状态，位于 PCIe 总线两端的设备需要进行协商，然后同时进入 L1 状态。两种可能的方式如下：</p> 
<ul><li>ASPM 机制下硬件自动切换。当 Upstream Port 的硬件发现没有 TLP 或者 DLLP 需要再发送的时候，就会自动和 Downstream Port 进行协商进入 L1 状态。如果 Downstream Port 同意，则二者同时进入 L1 状态；如果 Downstream Port 拒绝，则 Upstream Port 会进入 L0s 状态。</li><li>电源管理软件通过命令将设备配置为低功耗状态（D1，D2，D3<sub>hot</sub>）。此时 Upstream Port 和 Downstream Port 上的设备同时进入 L1 状态。</li></ul> 
<br> 
<h4><a id="8_L2__128"></a>8. L2 状态</h4> 
<p>L2 状态是ASPM（Active State Power Management）机制提供的第 3 级低功耗状态，此时设备的主电源被关闭，从而达到更低的功耗。该状态下，几乎所有的逻辑都被关闭，只有一小部分使用 Vaux 供电的逻辑在工作，该部分逻辑可以用来发送 wakeup 事件。</p> 
<p>支持 wakeup 功能的 Upstream Port 能向外发送一个低频信号，该信号称为 Beacon。Downstream Port 将 Beacon 信号转发给 Root Complex。通过 Beacon 或者 WAKE# 引脚，设备可以要求系统恢复它的主电源供电。</p> 
<br> 
<h4><a id="9_Loopback__138"></a>9. Loopback 状态</h4> 
<p>该状态是用来测试的，但是协议并没有明确规定 Receiver 在该状态下做些什么。基本的操作很简单：设备 A 作为 Loopback Master，连续对外发送两个 TS1 Ordered Sets，并且 TS1 的 Training Control 区域的 Loopback 位需要设置为 1。设备 B 接收到连续两个 Loopback 位为 1 的 TS1 之后，就会进入 Loopback state，称为 Loopback Slave。Loopback Slave 会将收到的所有内容再发送给 Loopback Master，从而形成回环，验证链路的完整性。</p> 
<br> 
<h4><a id="10_Disable__145"></a>10. Disable 状态</h4> 
<p>系统软件可以通过设置寄存器，使 PCIe 链路进入 Disabled 状态。当 PCIe 链路的对端设备被拔出时，LTSSM 也需要进入该状态。</p> 
<p>该状态下，发送端设备处于 Electrical Idle 状态，接收端设备处于低阻抗状态。对于链接已经变得不可靠或者设备被意外移除时，这种状态很有必要。</p> 
<p>系统软件配置 Link Control register 的 Disable 位之后，该设备会对外发送 16 个 TS1 Ordered Sets，这些 TS1 的 Training Control 区域的 Disable Link 位需要设置为 1。接收设备在收到这 16 个 TS1 之后，进入 Disabled 状态。</p> 
<br> 
<h4><a id="11_Hot_Reset__158"></a>11. Hot Reset 状态</h4> 
<p>系统软件将 Bridge Control register 的 Secondary Bus Reset 位设置为 1 之后，Bridge 的 downstream port 会对外发送多个 TS1 Ordered Sets，这些 TS1 的 Training Control 区域 Hot Reset 位必须被设置为 1。接收设备收到连续 2 个这种 TS1 之后，必须对设备进行复位。</p> 
<p>当处理器系统进行 Hot Reset 操作时，PCIe 链路将进入 Recovery 状态，然后进入 Hot Reset 状态进行 PCIe 链路的重训练。</p> 
<br> 
<blockquote> 
 <p>参考资料：<br> [1] Mike Jackson &amp; Ravi Budruk，PCI Express Technology<br> [2] 王齐，PCI Express 体系结构导读</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d57abb2823023d9d9475bb401e3dde14/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">谷歌浏览器无法携带cookie</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c475eb36781adc6ee3376f789dc7ac43/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">E.03.25 Chinese Video Company Bilibili Eyes $2.8 Billion Hong Kong Share Sale</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>