<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 静态广播注册流程(广播2) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 静态广播注册流程(广播2)" />
<meta property="og:description" content="Android 静态广播注册流程 1. 静态广播注册的流程2. 在AndroidManifest静态注册广播3. AndroidManifest静态注册接受者的安装过程4. 总结 1. 静态广播注册的流程 上一篇文章讲了动态广播的注册(系统存储在mReceiverResolver中)，
这篇文章主要讲解静态广播的注册流程
=&gt; 解析包中的receiver
=&gt; 将receiver相关信息添加到mComponentResolver中
2. 在AndroidManifest静态注册广播 还是以亮屏SCREEN_ON和开机BOOT_COMPLETED静态广播为例子 //在AndroidManifest.xml中定义如下 &lt;receiver android:name=&#34;.MyReceiver&#34;&gt; &lt;intent-filter&gt; &lt;action android:name=&#34;android.intent.action.SCREEN_ON&#34; /&gt; &lt;action android:name=&#34;android.intent.action.BOOT_COMPLETED&#34; /&gt; &lt;/intent-filter&gt; &lt;/receiver&gt; //MyReceiver.java public class MyReceiver extends BroadcastReceiver { @Override public void onReceive(Context context, Intent intent) { Log.e(&#34;yunhen&#34;, &#34;MyReceiver static intent = &#34; &#43; intent.getAction()); } } 测试发现这个不管是亮屏SCREEN_ON还是开机BOOT_COMPLETED的广播都收不到，
BOOT_COMPLETED没有收到的日志如下(大概意思是少了一个RECEIVE_BOOT_COMPLETED权限定义)： 04-26 09:00:26.506 1337 1549 W BroadcastQueue: Permission Denial: receiving Intent { act=android.intent.action.BOOT_COMPLETED flg=0x89000010 (has extras) } to co" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/be8d7550dda127e1eb3a8bac44d1b826/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-10T20:23:31+08:00" />
<meta property="article:modified_time" content="2023-06-10T20:23:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 静态广播注册流程(广播2)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Android 静态广播注册流程</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1. 静态广播注册的流程</a></li><li><a href="#2_AndroidManifest_13" rel="nofollow">2. 在AndroidManifest静态注册广播</a></li><li><a href="#3_AndroidManifest_62" rel="nofollow">3. AndroidManifest静态注册接受者的安装过程</a></li><li><a href="#4__493" rel="nofollow">4. 总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__4"></a>1. 静态广播注册的流程</h2> 
<p>上一篇文章讲了动态广播的注册(系统存储在mReceiverResolver中)，<br> 这篇文章主要讲解静态广播的注册流程<br> =&gt; 解析包中的receiver<br> <img src="https://images2.imgbox.com/6a/66/tiAMUr4w_o.png" alt="在这里插入图片描述"><br> =&gt; 将receiver相关信息添加到mComponentResolver中<br> <img src="https://images2.imgbox.com/01/e2/7njzeviT_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2_AndroidManifest_13"></a>2. 在AndroidManifest静态注册广播</h2> 
<ol><li>还是以亮屏SCREEN_ON和开机BOOT_COMPLETED静态广播为例子</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//在AndroidManifest.xml中定义如下</span>
        <span class="token operator">&lt;</span>receiver android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".MyReceiver"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.SCREEN_ON"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.BOOT_COMPLETED"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>receiver<span class="token operator">&gt;</span>
<span class="token comment">//MyReceiver.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"yunhen"</span><span class="token punctuation">,</span> <span class="token string">"MyReceiver static intent = "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>测试发现这个不管是亮屏SCREEN_ON还是开机BOOT_COMPLETED的广播都收不到，<br> BOOT_COMPLETED没有收到的日志如下(大概意思是少了一个RECEIVE_BOOT_COMPLETED权限定义)：</li></ol> 
<blockquote> 
 <p>04-26 09:00:26.506 1337 1549 W BroadcastQueue: Permission Denial: receiving Intent { act=android.intent.action.BOOT_COMPLETED flg=0x89000010 (has extras) } to co<br> m.example.myapplication/.MyReceiver requires android.permission.RECEIVE_BOOT_COMPLETED due to sender null (uid 1000)</p> 
</blockquote> 
<p>那就补上RECEIVE_BOOT_COMPLETED权限：</p> 
<pre><code class="prism language-java"><span class="token comment">//在AndroidManifest.xml中定义如下</span>
    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>receiver android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".MyReceiver"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.SCREEN_ON"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.BOOT_COMPLETED"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>receiver<span class="token operator">&gt;</span>
</code></pre> 
<p>顺利收到BOOT_COMPLETED的广播：</p> 
<blockquote> 
 <p>04-26 09:45:26.198 7894 7894 E yunhen : MyReceiver static intent = android.intent.action.BOOT_COMPLETED</p> 
</blockquote> 
<ol start="3"><li> <p>不过SCREEN_ON，没有收到任何日志报错，就是没收到</p> </li><li> <p>我们带着这个例子的疑问，一起去代码里面找答案(下一篇广播发送才能找到答案)。<br> 本次先看静态广播是注册到系统的哪里去了</p> </li></ol> 
<h2><a id="3_AndroidManifest_62"></a>3. AndroidManifest静态注册接受者的安装过程</h2> 
<ol><li>先从安装过程中的processInstallRequestsAsync(PackageManagerService.java)处理安装请求开始讲起,<br> 处理安装请求=&gt;<br> 调用流程<br> -&gt;processInstallRequestsAsync(PackageManagerService.java) //处理安装请求<br> -&gt;installPackagesTracedLI //安装函数，加个installPackages的trace tag<br> -&gt;installPackagesLI //实际安装函数<br> -&gt;preparePackageLI //准备包的信息<br> -&gt;parsePackage(PackageParser2.java) //解析包的信息</li></ol> 
<pre><code class="prism language-java">PackageManagerService<span class="token punctuation">.</span>java
    <span class="token comment">// Queue up an async operation since the package installation may take a little while.</span>
    <span class="token comment">//处理安装请求</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processInstallRequestsAsync</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> success<span class="token punctuation">,</span>
            List<span class="token generics function"><span class="token punctuation">&lt;</span>InstallRequest<span class="token punctuation">&gt;</span></span> installRequests<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//...</span>
			<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">installPackagesTracedLI</span><span class="token punctuation">(</span>apkInstallRequests<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//安装函数，加个installPackages的trace tag</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installPackagesTracedLI</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>InstallRequest<span class="token punctuation">&gt;</span></span> requests<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"installPackages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">installPackagesLI</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//这个是安装应用的关键函数，实际安装函数</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installPackagesLI</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>InstallRequest<span class="token punctuation">&gt;</span></span> requests<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//...</span>
            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"installPackagesLI"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>InstallRequest request <span class="token operator">:</span> requests<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// TODO(b/109941548): remove this once we've pulled everything from it and into</span>
                <span class="token comment">//                    scan, reconcile or commit.</span>
                <span class="token keyword">final</span> PrepareResult prepareResult<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"preparePackage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//准备包的信息，如解析这个应用的内容</span>
                    prepareResult <span class="token operator">=</span>
                            <span class="token function">preparePackageLI</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">,</span> request<span class="token punctuation">.</span>installResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//准备包的信息</span>
    <span class="token keyword">private</span> PrepareResult <span class="token function">preparePackageLI</span><span class="token punctuation">(</span>InstallArgs args<span class="token punctuation">,</span> PackageInstalledInfo res<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PrepareFailure <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//通过args.installFlags获得如是否instantApp、fullApp、virtualPreload等应用</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> installFlags <span class="token operator">=</span> args<span class="token punctuation">.</span>installFlags<span class="token punctuation">;</span>
        <span class="token comment">//...</span>
        <span class="token comment">//注意默认是包含PARSE_CHATTY的tag的</span>
        <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parseFlags <span class="token operator">=</span> mDefParseFlags <span class="token operator">|</span> ParsingPackageUtils<span class="token punctuation">.</span>PARSE_CHATTY
                <span class="token operator">|</span> ParsingPackageUtils<span class="token punctuation">.</span>PARSE_ENFORCE_CODE
                <span class="token operator">|</span> <span class="token punctuation">(</span>onExternal <span class="token operator">?</span> ParsingPackageUtils<span class="token punctuation">.</span>PARSE_EXTERNAL_STORAGE <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"parsePackage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ParsedPackage parsedPackage<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>PackageParser2 pp <span class="token operator">=</span> mInjector<span class="token punctuation">.</span><span class="token function">getPreparingPackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//开始对包进行解析parsePackage</span>
            parsedPackage <span class="token operator">=</span> pp<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>tmpPackageFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            AndroidPackageUtils<span class="token punctuation">.</span><span class="token function">validatePackageDexMetadata</span><span class="token punctuation">(</span>parsedPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PrepareFailure</span><span class="token punctuation">(</span><span class="token string">"Failed parse during installPackageLI"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>包解析，获取相关receiver的组件放入ParsingPackageImpl的receivers中,<br> 我们记住<code>receivers是存放ParsedActivity</code><br> 调用流程<br> -&gt;parsePackage(PackageParser2.java) //V2版本的解析包的信息<br> -&gt;parsePackage(ParsingPackageUtils.java) //包解析的工具类<br> -&gt;parseClusterPackage //如果是目录，解析目录的簇群<br> -&gt;parseBaseApk //解析BaseApk(最基础的apk)<br> -&gt;parseBaseApkTags //解析AndroidManifest.xml的“application”相关tag<br> -&gt;parseBaseApplication //解析application<br> -&gt;addReceiver(ParsingPackageImpl.java) //将通过parseActivityOrReceiver获取的ParsedActivity放入receivers</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//PackageParser2.java</span>
    <span class="token comment">//V2版本的包解析代码</span>
    <span class="token keyword">public</span> ParsedPackage <span class="token function">parsePackage</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useCaches<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
        ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> parsingUtils<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

<span class="token comment">//ParsingPackageUtils.java</span>
    <span class="token comment">//解析包信息</span>
    <span class="token keyword">public</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> <span class="token function">parsePackage</span><span class="token punctuation">(</span>ParseInput input<span class="token punctuation">,</span> File packageFile<span class="token punctuation">,</span>
            <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageFile<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//目前大部分跑的是这里，如类似/data/app/vmdl1597983231.tmp的目录，里面包含***.apk</span>
            <span class="token keyword">return</span> <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">parseMonolithicPackage</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//解析包的簇群</span>
    <span class="token keyword">private</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>ParseInput input<span class="token punctuation">,</span> File packageDir<span class="token punctuation">,</span>
            <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//得到一些包的基本信息，如mBaseApkPath = "/data/app/vmdl1597983231.tmp/base.apk"</span>
        <span class="token comment">//parseClusterPackageLite-&gt;composePackageLiteFromApks-&gt;new PackageLite(找到".apk"结尾的)</span>
        <span class="token keyword">final</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>PackageLite<span class="token punctuation">&gt;</span></span> liteResult <span class="token operator">=</span>
                ApkLiteParseUtils<span class="token punctuation">.</span><span class="token function">parseClusterPackageLite</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> packageDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> File baseApk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span><span class="token function">getBaseApkPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//解析BaseApk</span>
            <span class="token keyword">final</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> baseApk<span class="token punctuation">,</span>
                    lite<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> assetLoader<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//解析BaseApk</span>
    <span class="token keyword">private</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>ParseInput input<span class="token punctuation">,</span> File apkFile<span class="token punctuation">,</span>
            String codePath<span class="token punctuation">,</span> SplitAssetLoader assetLoader<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
		<span class="token comment">//创建解析器parser，来解析ANDROID_MANIFEST_FILENAME = "AndroidManifest.xml"</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>XmlResourceParser parser <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">openXmlResourceParser</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span>
                ANDROID_MANIFEST_FILENAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> Resources res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> mDisplayMetrics<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//传入解析器parser，解析BaseApk</span>
            ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> apkPath<span class="token punctuation">,</span> codePath<span class="token punctuation">,</span> res<span class="token punctuation">,</span>
                    parser<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//传入解析器parser，解析BaseApk</span>
    <span class="token keyword">private</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>ParseInput input<span class="token punctuation">,</span> String apkPath<span class="token punctuation">,</span>
            String codePath<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span> XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
        <span class="token keyword">final</span> TypedArray manifestArray <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isCoreApp <span class="token operator">=</span>
                    parser<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"coreApp"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ParsingPackage pkg <span class="token operator">=</span> mCallback<span class="token punctuation">.</span><span class="token function">startParsingPackage</span><span class="token punctuation">(</span>
                    pkgName<span class="token punctuation">,</span> apkPath<span class="token punctuation">,</span> codePath<span class="token punctuation">,</span> manifestArray<span class="token punctuation">,</span> isCoreApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//解析apk中的各类TAG</span>
            <span class="token keyword">final</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span>
                    <span class="token function">parseBaseApkTags</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> manifestArray<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//解析apk中的各类TAG</span>
    <span class="token keyword">private</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> <span class="token function">parseBaseApkTags</span><span class="token punctuation">(</span>ParseInput input<span class="token punctuation">,</span> ParsingPackage pkg<span class="token punctuation">,</span>
            TypedArray sa<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span> XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>

            <span class="token comment">// &lt;application&gt; has special logic, so it's handled outside the general method</span>
            <span class="token comment">//如果tag是TAG_APPLICATION = "application"的话</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>TAG_APPLICATION<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    foundApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment">//则进行application的内容解析</span>
                    result <span class="token operator">=</span> <span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//解析"application"下的各个内容</span>
    <span class="token keyword">private</span> ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsingPackage<span class="token punctuation">&gt;</span></span> <span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>ParseInput input<span class="token punctuation">,</span>
            ParsingPackage pkg<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span> XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
            <span class="token keyword">final</span> ParseResult result<span class="token punctuation">;</span>
            String tagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">//Android四大组件解析的地方</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//activity和receiver的解析是一样的，它们比较类似</span>
                <span class="token keyword">case</span> <span class="token string">"activity"</span><span class="token operator">:</span>
                    isActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment">// fall-through</span>
                <span class="token keyword">case</span> <span class="token string">"receiver"</span><span class="token operator">:</span>
                    <span class="token comment">//activity和receiver的解析是一样的，它们比较类似</span>
					<span class="token comment">//parseActivityOrReceiver-&gt;parseActivityOrAlias中每一个"intent-filter"会对应一个ParsedIntentInfo，</span>
                    <span class="token comment">//并放入ParsedComponent(继承关系ParsedActivity/ParsedMainComponent/ParsedComponent)的intents</span>
                    <span class="token comment">//本例中解析出来的接收器如{ParsedActivity@38497} "Activity{8f994ed com.example.myapplication/.MyReceiver}"</span>
                    <span class="token comment">//ParsedActivity.intents.mActions包括"android.intent.action.SCREEN_ON"、"android.intent.action.BOOT_COMPLETED"</span>
                    ParseResult<span class="token generics function"><span class="token punctuation">&lt;</span>ParsedActivity<span class="token punctuation">&gt;</span></span> activityResult <span class="token operator">=</span>
                            ParsedActivityUtils<span class="token punctuation">.</span><span class="token function">parseActivityOrReceiver</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span>
                                    res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> sUseRoundIcon<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>activityResult<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        ParsedActivity activity <span class="token operator">=</span> activityResult<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>isActivity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            hasActivityOrder <span class="token operator">|=</span> <span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pkg<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//该receiver是否有设置android:order的tag，这个用的比较少，默认order是0</span>
							<span class="token comment">//对于一个包有多个receivers，order进行排序，按照order越大放在越前面</span>
                            hasReceiverOrder <span class="token operator">|=</span> <span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

							<span class="token comment">//将该ParsedActivity activity(receiver)放入ParsingPackageImpl的receivers</span>
                            pkg<span class="token punctuation">.</span><span class="token function">addReceiver</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    result <span class="token operator">=</span> activityResult<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token string">"service"</span><span class="token operator">:</span>
                    <span class="token comment">//...</span>
                <span class="token keyword">case</span> <span class="token string">"provider"</span><span class="token operator">:</span>
                    <span class="token comment">//...</span>
                <span class="token keyword">case</span> <span class="token string">"activity-alias"</span><span class="token operator">:</span>
                    <span class="token comment">//...</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    result <span class="token operator">=</span> <span class="token function">parseBaseAppChildTag</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> tagName<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token comment">//...</span>
        <span class="token comment">//按照android:order进行排序，order越大的receiver放在receivers列表的前面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasReceiverOrder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span><span class="token function">sortReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

<span class="token comment">//ParsingPackageImpl.java</span>
	<span class="token comment">//将该receiver放入ParsingPackageImpl的receivers，</span>
	<span class="token comment">//目前可以看到，包解析后receiver放入的地方是ParsingPackageImpl的receivers中</span>
    <span class="token keyword">public</span> ParsingPackageImpl <span class="token function">addReceiver</span><span class="token punctuation">(</span>ParsedActivity parsedReceiver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>receivers <span class="token operator">=</span> CollectionUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>receivers<span class="token punctuation">,</span> parsedReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addMimeGroupsFromComponent</span><span class="token punctuation">(</span>parsedReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li><code>将之前receiver解析的ParsedActivity全部放入mComponentResolver(ComponentResolver)的mReceivers中</code><br> mReceivers包含了所有安装应用的receiver，通过ComponentName就可以获得相应的ParsedActivity<br> mReceivers.mActivities.get(new ComponentName(“com.example.myapplication”, “com.example.myapplication.MyReceive”))<br> mComponentResolver是PackageManagerService的一个成员变量(也就是相当于将该receiver保存在系统的变量中)</li></ol> 
<p><code>同时将该组件的IntentFilter(intent-filter)/action添加到mComponentResolver(继承IntentResolver)的mFilters/mActionToFilter中</code></p> 
<p>具体流程如下=&gt;<br> (安装应用有很多阶段，前面说的是包解析，现在说的是将调和后的扫描结果保存到系统中)<br> -&gt;installPackagesLI(PackageManagerService.java) //安装函数<br> -&gt;commitPackagesLocked //将安装信息提交给系统<br> -&gt;commitReconciledScanResultLocked //提交已经协调好的扫描结果<br> -&gt;commitPackageSettings //提交到包信息里面<br> -&gt;mComponentResolver.addAllComponents //添加AndroidPackage pkg中的所有组件<br> -&gt;addReceiversLocked //Receiver组件的添加<br> -&gt;mReceivers.addActivity/addFilter //添加receiver到mComponentResolver的mReceivers，添加IntentFilter/action到mComponentResolver的mFilters/mActionToFilter等</p> 
<pre><code class="prism language-java"><span class="token comment">//PackageManagerService.java</span>
    <span class="token comment">//安装函数</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installPackagesLI</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>InstallRequest<span class="token punctuation">&gt;</span></span> requests<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//...</span>
                    <span class="token comment">//准备包的信息，如解析这个应用的内容</span>
                    prepareResult <span class="token operator">=</span>
                            <span class="token function">preparePackageLI</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">,</span> request<span class="token punctuation">.</span>installResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//...</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"commitPackages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    commitRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitRequest</span><span class="token punctuation">(</span>reconciledPackages<span class="token punctuation">,</span>
                            mUserManager<span class="token punctuation">.</span><span class="token function">getUserIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将安装信息提交给系统</span>
                    <span class="token function">commitPackagesLocked</span><span class="token punctuation">(</span>commitRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitPackagesLocked</span><span class="token punctuation">(</span><span class="token keyword">final</span> CommitRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO: remove any expected failures from this method; this should only be able to fail due</span>
        <span class="token comment">//       to unavoidable errors (I/O, etc.)</span>
        <span class="token comment">//本例安装request.reconciledPackages.size()是1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ReconciledPackage reconciledPkg <span class="token operator">:</span> request<span class="token punctuation">.</span>reconciledPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//...</span>
            <span class="token comment">//提交已经协调好的扫描结果</span>
            AndroidPackage pkg <span class="token operator">=</span> <span class="token function">commitReconciledScanResultLocked</span><span class="token punctuation">(</span>reconciledPkg<span class="token punctuation">,</span> request<span class="token punctuation">.</span>mAllUsers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> AndroidPackage <span class="token function">commitReconciledScanResultLocked</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@NonNull</span> ReconciledPackage reconciledPkg<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> allUsers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
        <span class="token comment">// Modify state for the given package setting</span>
        <span class="token comment">//提交到包信息里面，从上面可以知道(parseFlags &amp; ParsingPackageUtils.PARSE_CHATTY) != 0默认是true，也就是chatty是true</span>
        <span class="token function">commitPackageSettings</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> oldPkg<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> oldPkgSetting<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> ParsingPackageUtils<span class="token punctuation">.</span>PARSE_CHATTY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token comment">/*chatty*/</span><span class="token punctuation">,</span> reconciledPkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitPackageSettings</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> AndroidPackage pkg<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> AndroidPackage oldPkg<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> PackageSetting pkgSetting<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> PackageSetting oldPkgSetting<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> chatty<span class="token punctuation">,</span> ReconciledPackage reconciledPkg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
			<span class="token comment">//通过injector获得ComponentResolver</span>
			<span class="token comment">//mComponentResolver = injector.getComponentResolver();</span>
			<span class="token comment">//相当于new ComponentResolver(第一次调用才会new)获取的mInstance(ComponentResolver)实例</span>
			<span class="token comment">//通过组件解析器mComponentResolver添加pkg(PackageImpl实例)中的组件</span>
			<span class="token comment">//PackageImpl父类是ParsingPackageImpl(存放我们之前说的receivers的地方)，而且实现了AndroidPackage接口</span>
            mComponentResolver<span class="token punctuation">.</span><span class="token function">addAllComponents</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

<span class="token comment">//ComponentResolver.java</span>
    <span class="token comment">//添加AndroidPackage pkg中的所有组件</span>
    <span class="token keyword">void</span> <span class="token function">addAllComponents</span><span class="token punctuation">(</span>AndroidPackage pkg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> chatty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Pair<span class="token generics function"><span class="token punctuation">&lt;</span>ParsedActivity<span class="token punctuation">,</span> ParsedIntentInfo<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> newIntents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//Activity组件的添加</span>
            <span class="token function">addActivitiesLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> newIntents<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Receiver组件的添加</span>
            <span class="token function">addReceiversLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Provider组件的添加</span>
            <span class="token function">addProvidersLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Service组件的添加</span>
            <span class="token function">addServicesLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//状态改变通知到相关mObservers</span>
            <span class="token function">onChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//添加AndroidPackage pkg中的Receiver到mComponentResolver的mReceivers</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addReceiversLocked</span><span class="token punctuation">(</span>AndroidPackage pkg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> chatty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> receiversSize <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span><span class="token function">getReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        StringBuilder r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> receiversSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//逐个取出ParsingPackageImpl的receivers，如此处的MyReceiver</span>
            ParsedActivity a <span class="token operator">=</span> pkg<span class="token punctuation">.</span><span class="token function">getReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//添加mComponentResolver的mReceivers</span>
            mReceivers<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"receiver"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//DEBUG_PACKAGE_SCANNING这个PMS的调试开关，用于判断是否输出日志</span>
			<span class="token comment">//可以将全部pms debug相关的开关做成动态开关</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_PACKAGE_SCANNING <span class="token operator">&amp;&amp;</span> chatty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    r<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//输出相关添加Receivers的日志</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_PACKAGE_SCANNING <span class="token operator">&amp;&amp;</span> chatty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"  Receivers: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token string">"&lt;NONE&gt;"</span> <span class="token operator">:</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//mReceivers是ReceiverIntentResolver对象，其父类是ActivityIntentResolver</span>
	<span class="token comment">//添加ParsedActivity a到mActivities中</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addActivity</span><span class="token punctuation">(</span>ParsedActivity a<span class="token punctuation">,</span> String type<span class="token punctuation">,</span>
			List<span class="token operator">&lt;</span>Pair<span class="token generics function"><span class="token punctuation">&lt;</span>ParsedActivity<span class="token punctuation">,</span> ParsedIntentInfo<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> newIntents<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//其mActivities以ComponentName为key，保存着ParsedActivity(此处是MyReceiver)</span>
		mActivities<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getComponentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//DEBUG_SHOW_INFO这个是调试信息的开关，可以打开查看流程</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SHOW_INFO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"  "</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"    Class="</span> <span class="token operator">+</span> a<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//取得ParsedIntentInfo，这里只有1个intent-filter就对应1个ParsedIntentInfo</span>
		<span class="token comment">//如果写2个intent-filter，就会有2个ParsedIntentInfo(继承的IntentFilter)</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> intentsSize <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getIntents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> intentsSize<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			ParsedIntentInfo intent <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getIntents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>newIntents <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token string">"activity"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				newIntents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Pair<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SHOW_INFO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"    IntentFilter:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				intent<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">,</span> TAG<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"      "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//这个也是调试使用，末日是不输出的</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>intent<span class="token punctuation">.</span><span class="token function">debugCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"==&gt; For Activity "</span> <span class="token operator">+</span> a<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//Pair.create(a, intent)相当于new Pair&lt;ParsedActivity, ParsedIntentInfo&gt;(a, intent);</span>
			<span class="token comment">//添加到ComponentResolver(继承IntentResolver)的mFilters/mActionToFilter中</span>
			<span class="token function">addFilter</span><span class="token punctuation">(</span>Pair<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token comment">//IntentResolver.java</span>
    <span class="token comment">//添加IntentFilter</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFilter</span><span class="token punctuation">(</span>F f<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        IntentFilter intentFilter <span class="token operator">=</span> <span class="token function">getIntentFilter</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//localLOGV这些都是调试日志</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Adding filter: "</span> <span class="token operator">+</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            intentFilter<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>LOG_ID_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"      "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"    Building Lookup Maps:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//将Pair&lt;ParsedActivity, ParsedIntentInfo&gt;添加到mFilters</span>
        mFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//将mDataSchemes放入mSchemeToFilter</span>
        <span class="token keyword">int</span> numS <span class="token operator">=</span> <span class="token function">register_intent_filter</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> intentFilter<span class="token punctuation">.</span><span class="token function">schemesIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                mSchemeToFilter<span class="token punctuation">,</span> <span class="token string">"      Scheme: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numT <span class="token operator">=</span> <span class="token function">register_mime_types</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"      Type: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numS <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> numT <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//将mActions放入mActionToFilter, key是action，value是Pair&lt;ParsedActivity, ParsedIntentInfo&gt;的list</span>
            <span class="token comment">//如mActionToFilter.get("android.intent.action.BOOT_COMPLETED") = {Pair[316]@38034} </span>
            <span class="token comment">//107 = {Pair@38369} "Pair{Activity{7d26902 com.example.myapplication/.MyReceiver2} ParsedIntentInfo{a218213}}"</span>
            <span class="token comment">//108 = {Pair@38370} "Pair{Activity{3985c50 com.example.myapplication/.MyReceiver} ParsedIntentInfo{9dfde49}}"</span>
            <span class="token function">register_intent_filter</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> intentFilter<span class="token punctuation">.</span><span class="token function">actionsIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mActionToFilter<span class="token punctuation">,</span> <span class="token string">"      Action: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numT <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">register_intent_filter</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> intentFilter<span class="token punctuation">.</span><span class="token function">actionsIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mTypedActionToFilter<span class="token punctuation">,</span> <span class="token string">"      TypedAction: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="4__493"></a>4. 总结</h2> 
<ol><li>AndroidManifest.xml中的receiver解析成ParsedActivity, 存放在PackageImpl的receivers(PackageImpl父类是ParsingPackageImpl而且实现了AndroidPackage接口)</li><li>receivers最终会存放在mComponentResolver(PMS)的mReceivers中，mReceivers包含了所有安装应用的receiver，通过ComponentName就可以获得相应的ParsedActivity，如：<br> mReceivers.mActivities.get(new ComponentName(“com.example.myapplication”, “com.example.myapplication.MyReceive”))，既可以获得MyReceiver的ParsedActivity</li><li>receiver中的一个IntentFilter(intent-filter)对应一个ParsedIntentInfo，一个Pair&lt;ParsedActivity, ParsedIntentInfo&gt;</li><li>Pair&lt;ParsedActivity, ParsedIntentInfo&gt;被放入mComponentResolver的mFilters</li><li>mActions被放入mComponentResolver的mActionToFilter</li><li>部分静态广播注册需要权限，不是注册了就能收到。其实要接收广播还：涉及权限、进程优先级、flag标签等各类无法接收到广播的情况。<br> (系统一般是skip或者根本不发送给静态广播或者mComponentResolver解析时就跳过了)</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1747632d332c4674d514d189660d1537/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android 动态广播注册流程(广播1)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5004009e04f624707cf9b4d6b42e87bc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android进程的adj值</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>