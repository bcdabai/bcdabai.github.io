<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql 5.6 函数索引_解决Mysql 5.6 &#34;隐式转换&#34;导致的索引失效和数据不准确的问题... - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql 5.6 函数索引_解决Mysql 5.6 &#34;隐式转换&#34;导致的索引失效和数据不准确的问题..." />
<meta property="og:description" content="mysql视频教程栏目介绍解决Mysql 5.6索引失效和数据不准确问题
相关免费学习推荐：mysql视频教程
背景在一次进行SQl查询时，我试着对where条件中vachar类型的字段去掉单引号查询，这个时候发现这条本应该很快的语句竟然很慢。这个varchar字段有一个复合索引。其中的总条数有58989，甚至不加单引号查出来的数据不是我们想要的数据。
使用的是mysql 5.6版本，innoDB引擎 实际情况如下
下面我们来看一下执行的结果
在上面的描述中我们还得注意就是，你的where条件的字符串不加单引号必须是全数字。不然就会报错
还有可能查出来的数据不是我们想要的数据。如下图
分析从执行结果来看，使用了单引号的走了对应的索引。没有使用单引号的没有走索引，进行了全表扫描。
为什么会这样呢？ mysql的优化器怎么不直接进行类型转换呢？在SQL语句中单引号的引入也就是代表这个类型是字符串数据类型CHAR， VARCHAR， BINARY， VARBINARY， BLOB， TEXT， ENUM，和 SET。。
不加单引号也就代表这是一个字符串之外的类型，如int，bigDecimal类型等
如果给一串有字幕和特殊符号的字符串不加单引号，后果就是类型转换失败导致SQl不能执行。
如上图所述：1054 - Unknown column &#39;000w1993521&#39; in &#39;where clause&#39;, Time: 0.008000s
我们先来看一下一条SQL的执行过程
(网图)我们先得出结论：如果对索引字段做函数操作(本例是cast函数做了隐式的转换)，可能会破坏索引值的有序性，因此优化器就决定放弃走树搜索功能。(https://dev.mysql.com/doc/refman/5.7/en/cast-functions.html)
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-l5AwT0xu-1607244327891)(http://note.youdao.com/yws/res/23689/CE6F785994E6476D816B23787CE65217)]
意思也就是：请注意，如果您使用BINARY，CAST()或CONVERT()转换索引列，则MySQL可能无法有效使用索引。
查出来的数据不准确，也是因为隐式转换，转换后导致数值类型不一样，导致不等变为相等。
隐式转换
1. 产生条件
当操作符与不同类型的操作数一起使用时，会发生类型转换以使操作数兼容。则会发生转换隐式
发生隐式转换的条件：两个参数至少有一个是 NULL 时，比较的结果也是 NULL，例外是使用 &lt;=&gt; 对两个 NULL 做比较时会返回 1，这两种情况都不需要做类型转换
两个参数都是字符串，会按照字符串来比较，不做类型转换
两个参数都是整数，按照整数来比较，不做类型转换
十六进制的值和非数字做比较时，会被当做二进制串
有一个参数是 TIMESTAMP 或 DATETIME，并且另外一个参数是常量，常量会被转换为 timestamp
有一个参数是 decimal 类型，如果另外一个参数是 decimal 或者整数，会将整数转换为 decimal 后进行比较，如果另外一个参数是浮点数，则会把 decimal 转换为浮点数进行比较
所有其他情况下，两个参数都会被转换为浮点数再进行比较
2. 分析实际遇到的情况" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/afc2c7de92fefedee2edaac9fe71322a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-19T23:37:42+08:00" />
<meta property="article:modified_time" content="2021-01-19T23:37:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql 5.6 函数索引_解决Mysql 5.6 &#34;隐式转换&#34;导致的索引失效和数据不准确的问题...</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>mysql视频教程栏目介绍解决Mysql 5.6索引失效和数据不准确问题</p> 
 <p align="center"><img src="https://images2.imgbox.com/77/36/sZo25HfD_o.png" alt="60b1e6316a2806288487ce35ded87170.png">相关免费学习推荐：mysql视频教程</p> 
 <p>背景在一次进行SQl查询时，我试着对where条件中vachar类型的字段去掉单引号查询，这个时候发现这条本应该很快的语句竟然很慢。这个varchar字段有一个复合索引。其中的总条数有58989，甚至不加单引号查出来的数据不是我们想要的数据。</p> 
 <p>使用的是mysql 5.6版本，innoDB引擎 实际情况如下</p> 
 <p>下面我们来看一下执行的结果</p> 
 <p align="center"><img src="https://images2.imgbox.com/f6/a5/47bvbTzW_o.png" alt="bd31569cbd78c173e19d1b0e98d8b0d8.png"></p> 
 <p>在上面的描述中我们还得注意就是，你的where条件的字符串不加单引号必须是全数字。不然就会报错</p> 
 <p align="center"><img src="https://images2.imgbox.com/bf/41/85Mn7SQ5_o.png" alt="98a6b107e454cf6418ad73c1997d65ed.png"></p> 
 <p>还有可能查出来的数据不是我们想要的数据。如下图</p> 
 <p align="center"><img src="https://images2.imgbox.com/48/f0/IahENtBF_o.png" alt="7e7e1b610b3070600d09db497241a7f3.png"></p> 
 <p>分析从执行结果来看，使用了单引号的走了对应的索引。没有使用单引号的没有走索引，进行了全表扫描。</p> 
 <p>为什么会这样呢？ mysql的优化器怎么不直接进行类型转换呢？在SQL语句中单引号的引入也就是代表这个类型是字符串数据类型CHAR， VARCHAR， BINARY， VARBINARY， BLOB， TEXT， ENUM，和 SET。。</p> 
 <p>不加单引号也就代表这是一个字符串之外的类型，如int，bigDecimal类型等</p> 
 <p>如果给一串有字幕和特殊符号的字符串不加单引号，后果就是类型转换失败导致SQl不能执行。</p> 
 <p>如上图所述：1054 - Unknown column '000w1993521' in 'where clause', Time: 0.008000s</p> 
 <p>我们先来看一下一条SQL的执行过程</p> 
 <p align="center"><img src="https://images2.imgbox.com/20/28/KpeAfHFC_o.png" alt="3bf2abe8ec92e76677e13a31351bfd5c.png"></p> 
 <p>(网图)我们先得出结论：如果对索引字段做函数操作(本例是cast函数做了隐式的转换)，可能会破坏索引值的有序性，因此优化器就决定放弃走树搜索功能。(https://dev.mysql.com/doc/refman/5.7/en/cast-functions.html)</p> 
 <p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-l5AwT0xu-1607244327891)(http://note.youdao.com/yws/res/23689/CE6F785994E6476D816B23787CE65217)]</p> 
 <p>意思也就是：请注意，如果您使用BINARY，CAST()或CONVERT()转换索引列，则MySQL可能无法有效使用索引。</p> 
 <p>查出来的数据不准确，也是因为隐式转换，转换后导致数值类型不一样，导致不等变为相等。</p> 
 <p>隐式转换</p> 
 <p>1. 产生条件</p> 
 <p>当操作符与不同类型的操作数一起使用时，会发生类型转换以使操作数兼容。则会发生转换隐式</p> 
 <p>发生隐式转换的条件：两个参数至少有一个是 NULL 时，比较的结果也是 NULL，例外是使用 &lt;=&gt; 对两个 NULL 做比较时会返回 1，这两种情况都不需要做类型转换</p> 
 <p>两个参数都是字符串，会按照字符串来比较，不做类型转换</p> 
 <p>两个参数都是整数，按照整数来比较，不做类型转换</p> 
 <p>十六进制的值和非数字做比较时，会被当做二进制串</p> 
 <p>有一个参数是 TIMESTAMP 或 DATETIME，并且另外一个参数是常量，常量会被转换为 timestamp</p> 
 <p>有一个参数是 decimal 类型，如果另外一个参数是 decimal 或者整数，会将整数转换为 decimal 后进行比较，如果另外一个参数是浮点数，则会把 decimal 转换为浮点数进行比较</p> 
 <p>所有其他情况下，两个参数都会被转换为浮点数再进行比较</p> 
 <p>2. 分析实际遇到的情况</p> 
 <p>1.那我们也就清楚了，上面我提出的例子是整数和字符串的比较，那就属于其他情况了。那我们就先来分析一下索引失效的原因由于属于隐式转换的其他情况，所以对比值都得转换为浮点数进行比较</p> 
 <p>我们先将查询条件值进行转换为浮点数，再着将表的记录值也得进行转换，所以这个时候此前已经创建好的索引排序已经不能生效了。因为隐式转换(函数)已经改变了原来的值，所以说优化器在这里就直接不选用索引，直接使用全表扫描。</p> 
 <p>2.查询出不匹配的值(或者说是部分匹配的值)，如上面的查询结果。这真得看看源码了，这也就是MYsql的隐式转换规则。这里不就细分析了(因为没有查到相关的文档)</p> 
 <p>由于历史原因，需要兼容旧的设计，可以使用 MySQL 的类型转换函数 cast 和 convert，来明确的进行转换。</p> 
 <p>总结隐式转换和函数的使用会导致索引失效和select出的数据不准确</p> 
 <p>隐式转换的发生条件以及规则</p> 
 <p>隐式转换导致索引失效的具体原因，由于需要将对比值都要进行类型转换导致失效。</p> 
 <p>避免发生隐式类型转换，隐式转换的类型主要有字段类型不一致、in 参数包含多个类型、字符集类型或校对规则不一致等想了解更多编程学习，敬请关注php培训栏目！</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/28b28a144f3ca8f22aeb692019aaa8d4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python中魔术方法：关于__getattr__、__setattr__和__getattribute__中的关键点</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9cd83da31905abe8174349867b8d7b9c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Too many arguments to function call, expected 0, have 2</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>