<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>经典实例分割模型Mask RCNN原理与测试 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="经典实例分割模型Mask RCNN原理与测试" />
<meta property="og:description" content="一、Mask RCNN简介 区域卷积神经网络 RCNN（Region-Convolutional Neural Networks）为两阶段目标检测器。通过对图像生成候选区域，提取特征，判别特征类别并修正候选框位置。 RCNN系列目前包含两个代表模型：Faster RCNN，Mask RCNN。
Mask R-CNN是He Kaiming大神2017年的力作，其在进行目标检测的同时进行实例分割，取得了出色的效果。
Mask-RCNN使用Resnet101作为主干特征提取网络，也就是图中的CNN部分，其对输入的图像image要求其是正方形且宽高可以整除2的6次方，不足的将会在外侧添加灰色区域。
Resnet101主干特征提取（CNN） 一张图像image传入到 Resnet101(CNN) 之后，会对其进行特征提取，然后将图像长宽压缩两次、三次、四次、五次来构造特征金字塔，目的是为了实现特征多尺度融合。
也就是下图中的左侧部分，分别得到了C2、C3、C4、C5五种特征层（五种尺寸的图像）。
P5：对最小的C5(32,32)图像进行二维卷积，然后再次卷积作为一个有效特征层P5(32,32)（下方绿色框）P6：将P5(32,32)最大池化得到有效特征层P6(16,16)。P4：将C5(32,32)一次卷积的结果上采样得到(64,64)图像，与C4(64,64)进行Add运算，然后再次卷积得到另一个有效特征层P4。P3：将C4一次卷积结果上采样，并与C3进行Add运算，然后再次卷积得到有效特征层P3。P2：将C3一次卷积结果上采样，并与C2进行Add运算，再次卷积得到有效特征层P2。 提取到的P2、P3、P4、P5、P6五个有效特征层，就是Resent101的输出feature maps，可以用于接下来RPN建议网络获取建议框。
RPN区域建议网络（Region Proposal） 对有效特征层使用RPN建议网络（region proposal），获得许多建议框regions，这些建议框可能包含物体，可能没包含物体。不管包括没包括，接下来都会利用这些建议框截取P2~P5的图像，得到一个个可能存在目标的截取图像（P6不截取）。
ROI区域对齐（ROI Align） 对于所有建议框截取图像，RoI Align都会将其调整图像尺寸为一个正方形，便于后续特征的匹配操作。这样经过所有ROI Align后的建议框截取图像，
FC Layers 根据截取出的建议框图像，利用Classifier回归模型判断截取的区域是否有物体，然后利用Classifier预测框网络对有效特征层进行解码获得最终的预测框。
Mask语义分割网络 利用获取的最终预测框，再次在有效特征层P2~P5中截取目标图像（这次由于相当于进行了以便筛选，截取出的图像数量会少很多），将这次截取出的图像传给Mask语义分割网络进行语义分割。
二、Mask R-CNN实现过程 2.1 Resnet101-主干特征提取网络 ResNet101有两个基本的块，分别是Conv Block和Identity Block。其中Conv Block的输入和输出维度不同，不能持续串联，它的作用是改变网络的维度；Identity Block的输入维度和输出维度相同，可以串联，用于加深网络。
以coco数据集中输入的shape为例，输入的shape为1024x1024，shape变化如下：
我们取出长宽压缩了两次、三次、四次、五次的结果来进行下面特征金字塔结构的构造。
相关代码：
from keras.layers import ZeroPadding2D,Conv2D,MaxPooling2D,BatchNormalization,Activation,Add def identity_block(input_tensor, kernel_size, filters, stage, block, use_bias=True, train_bn=True): nb_filter1, nb_filter2, nb_filter3 = filters conv_name_base = &#39;res&#39; &#43; str(stage) &#43; block &#43; &#39;_branch&#39; bn_name_base = &#39;bn&#39; &#43; str(stage) &#43; block &#43; &#39;_branch&#39; x = Conv2D(nb_filter1, (1, 1), name=conv_name_base &#43; &#39;2a&#39;, use_bias=use_bias)(input_tensor) x = BatchNormalization(name=bn_name_base &#43; &#39;2a&#39;)(x, training=train_bn) x = Activation(&#39;relu&#39;)(x) x = Conv2D(nb_filter2, (kernel_size, kernel_size), padding=&#39;same&#39;, name=conv_name_base &#43; &#39;2b&#39;, use_bias=use_bias)(x) x = BatchNormalization(name=bn_name_base &#43; &#39;2b&#39;)(x, training=train_bn) x = Activation(&#39;relu&#39;)(x) x = Conv2D(nb_filter3, (1, 1), name=conv_name_base &#43; &#39;2c&#39;, use_bias=use_bias)(x) x = BatchNormalization(name=bn_name_base &#43; &#39;2c&#39;)(x, training=train_bn) x = Add()([x, input_tensor]) x = Activation(&#39;relu&#39;, name=&#39;res&#39; &#43; str(stage) &#43; block &#43; &#39;_out&#39;)(x) return x def conv_block(input_tensor, kernel_size, filters, stage, block, strides=(2, 2), use_bias=True, train_bn=True): nb_filter1, nb_filter2, nb_filter3 = filters conv_name_base = &#39;res&#39; &#43; str(stage) &#43; block &#43; &#39;_branch&#39; bn_name_base = &#39;bn&#39; &#43; str(stage) &#43; block &#43; &#39;_branch&#39; x = Conv2D(nb_filter1, (1, 1), strides=strides, name=conv_name_base &#43; &#39;2a&#39;, use_bias=use_bias)(input_tensor) x = BatchNormalization(name=bn_name_base &#43; &#39;2a&#39;)(x, training=train_bn) x = Activation(&#39;relu&#39;)(x) x = Conv2D(nb_filter2, (kernel_size, kernel_size), padding=&#39;same&#39;, name=conv_name_base &#43; &#39;2b&#39;, use_bias=use_bias)(x) x = BatchNormalization(name=bn_name_base &#43; &#39;2b&#39;)(x, training=train_bn) x = Activation(&#39;relu&#39;)(x) x = Conv2D(nb_filter3, (1, 1), name=conv_name_base &#43; &#39;2c&#39;, use_bias=use_bias)(x) x = BatchNormalization(name=bn_name_base &#43; &#39;2c&#39;)(x, training=train_bn) shortcut = Conv2D(nb_filter3, (1, 1), strides=strides, name=conv_name_base &#43; &#39;1&#39;, use_bias=use_bias)(input_tensor) shortcut = BatchNormalization(name=bn_name_base &#43; &#39;1&#39;)(shortcut, training=train_bn) x = Add()([x, shortcut]) x = Activation(&#39;relu&#39;, name=&#39;res&#39; &#43; str(stage) &#43; block &#43; &#39;_out&#39;)(x) return x def get_resnet(input_image,stage5=False, train_bn=True): # Stage 1 x = ZeroPadding2D((3, 3))(input_image) x = Conv2D(64, (7, 7), strides=(2, 2), name=&#39;conv1&#39;, use_bias=True)(x) x = BatchNormalization(name=&#39;bn_conv1&#39;)(x, training=train_bn) x = Activation(&#39;relu&#39;)(x) # Height/4,Width/4,64 C1 = x = MaxPooling2D((3, 3), strides=(2, 2), padding=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/39305b11443d6f3215c006416b443af0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-19T18:00:00+08:00" />
<meta property="article:modified_time" content="2022-07-19T18:00:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">经典实例分割模型Mask RCNN原理与测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Mask_RCNN_1"></a>一、Mask RCNN简介</h2> 
<p>区域卷积神经网络 RCNN（Region-Convolutional Neural Networks）为两阶段目标检测器。通过对图像生成候选区域，提取特征，判别特征类别并修正候选框位置。 RCNN系列目前包含两个代表模型：Faster RCNN，Mask RCNN。</p> 
<p>Mask R-CNN是He Kaiming大神2017年的力作，其在进行目标检测的同时进行实例分割，取得了出色的效果。</p> 
<p><img src="https://images2.imgbox.com/d5/d3/P1b6UstW_o.png" alt=""></p> 
<p>Mask-RCNN使用Resnet101作为主干特征提取网络，也就是图中的CNN部分，其对输入的图像image要求其是正方形且宽高可以整除2的6次方，不足的将会在外侧添加灰色区域。</p> 
<ol><li><strong>Resnet101主干特征提取（CNN）</strong></li></ol> 
<p>一张图像image传入到 <strong>Resnet101(CNN)</strong> 之后，会对其进行特征提取，然后将图像长宽压缩两次、三次、四次、五次来构造特征金字塔，目的是为了实现特征多尺度融合。</p> 
<p><img src="https://images2.imgbox.com/9c/fa/6RuDw1D4_o.png" alt=""></p> 
<p>也就是下图中的左侧部分，分别得到了C2、C3、C4、C5五种特征层（五种尺寸的图像）。</p> 
<p><img src="https://images2.imgbox.com/23/fc/YtCgF9fJ_o.png" alt=""></p> 
<ul><li>P5：对最小的C5(32,32)图像进行二维卷积，然后再次卷积作为一个有效特征层P5(32,32)（下方绿色框）</li><li>P6：将P5(32,32)最大池化得到有效特征层P6(16,16)。</li><li>P4：将C5(32,32)一次卷积的结果上采样得到(64,64)图像，与C4(64,64)进行Add运算，然后再次卷积得到另一个有效特征层P4。</li><li>P3：将C4一次卷积结果上采样，并与C3进行Add运算，然后再次卷积得到有效特征层P3。</li><li>P2：将C3一次卷积结果上采样，并与C2进行Add运算，再次卷积得到有效特征层P2。</li></ul> 
<p>提取到的P2、P3、P4、P5、P6五个有效特征层，就是Resent101的输出feature maps，可以用于接下来RPN建议网络获取建议框。</p> 
<ol start="2"><li><strong>RPN区域建议网络（Region Proposal）</strong></li></ol> 
<p>对有效特征层使用RPN建议网络（region proposal），获得许多建议框regions，这些建议框可能包含物体，可能没包含物体。不管包括没包括，接下来都会利用这些建议框截取P2~P5的图像，得到一个个可能存在目标的截取图像（P6不截取）。</p> 
<ol start="3"><li><strong>ROI区域对齐（ROI Align）</strong></li></ol> 
<p>对于所有建议框截取图像，RoI Align都会将其调整图像尺寸为一个正方形，便于后续特征的匹配操作。这样经过所有ROI Align后的建议框截取图像，</p> 
<ol start="4"><li><strong>FC Layers</strong></li></ol> 
<p>根据截取出的建议框图像，利用Classifier回归模型判断截取的区域是否有物体，然后利用Classifier预测框网络对有效特征层进行解码获得最终的预测框。</p> 
<ol start="5"><li><strong>Mask语义分割网络</strong></li></ol> 
<p>利用获取的最终预测框，再次在有效特征层P2~P5中截取目标图像（这次由于相当于进行了以便筛选，截取出的图像数量会少很多），将这次截取出的图像传给Mask语义分割网络进行语义分割。</p> 
<h2><a id="Mask_RCNN_51"></a>二、Mask R-CNN实现过程</h2> 
<h3><a id="21_Resnet101_53"></a>2.1 Resnet101-主干特征提取网络</h3> 
<p>ResNet101有两个基本的块，分别是<code>Conv Block</code>和<code>Identity Block</code>。其中<code>Conv Block</code>的输入和输出维度不同，不能持续串联，它的作用是改变网络的维度；<code>Identity Block</code>的输入维度和输出维度相同，可以串联，用于加深网络。</p> 
<p><img src="https://images2.imgbox.com/74/0a/UFIzhZ8u_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/46/21/Pya3cV59_o.png" alt=""></p> 
<p>以coco数据集中输入的shape为例，输入的shape为1024x1024，shape变化如下：</p> 
<p><img src="https://images2.imgbox.com/c4/fb/X9wzFEjG_o.png" alt=""></p> 
<p>我们取出长宽压缩了两次、三次、四次、五次的结果来进行下面特征金字塔结构的构造。</p> 
<p>相关代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> ZeroPadding2D<span class="token punctuation">,</span>Conv2D<span class="token punctuation">,</span>MaxPooling2D<span class="token punctuation">,</span>BatchNormalization<span class="token punctuation">,</span>Activation<span class="token punctuation">,</span>Add


<span class="token keyword">def</span> <span class="token function">identity_block</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> stage<span class="token punctuation">,</span> block<span class="token punctuation">,</span>
                   use_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    nb_filter1<span class="token punctuation">,</span> nb_filter2<span class="token punctuation">,</span> nb_filter3 <span class="token operator">=</span> filters
    conv_name_base <span class="token operator">=</span> <span class="token string">'res'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token operator">+</span> block <span class="token operator">+</span> <span class="token string">'_branch'</span>
    bn_name_base <span class="token operator">=</span> <span class="token string">'bn'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token operator">+</span> block <span class="token operator">+</span> <span class="token string">'_branch'</span>

    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>nb_filter1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span>conv_name_base <span class="token operator">+</span> <span class="token string">'2a'</span><span class="token punctuation">,</span>
                  use_bias<span class="token operator">=</span>use_bias<span class="token punctuation">)</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span>name<span class="token operator">=</span>bn_name_base <span class="token operator">+</span> <span class="token string">'2a'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>nb_filter2<span class="token punctuation">,</span> <span class="token punctuation">(</span>kernel_size<span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span>
                  name<span class="token operator">=</span>conv_name_base <span class="token operator">+</span> <span class="token string">'2b'</span><span class="token punctuation">,</span> use_bias<span class="token operator">=</span>use_bias<span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span>name<span class="token operator">=</span>bn_name_base <span class="token operator">+</span> <span class="token string">'2b'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>nb_filter3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span>conv_name_base <span class="token operator">+</span> <span class="token string">'2c'</span><span class="token punctuation">,</span>
                  use_bias<span class="token operator">=</span>use_bias<span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span>name<span class="token operator">=</span>bn_name_base <span class="token operator">+</span> <span class="token string">'2c'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> input_tensor<span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'res'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token operator">+</span> block <span class="token operator">+</span> <span class="token string">'_out'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">conv_block</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> stage<span class="token punctuation">,</span> block<span class="token punctuation">,</span>
               strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> use_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    nb_filter1<span class="token punctuation">,</span> nb_filter2<span class="token punctuation">,</span> nb_filter3 <span class="token operator">=</span> filters
    conv_name_base <span class="token operator">=</span> <span class="token string">'res'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token operator">+</span> block <span class="token operator">+</span> <span class="token string">'_branch'</span>
    bn_name_base <span class="token operator">=</span> <span class="token string">'bn'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token operator">+</span> block <span class="token operator">+</span> <span class="token string">'_branch'</span>

    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>nb_filter1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span>strides<span class="token punctuation">,</span>
                  name<span class="token operator">=</span>conv_name_base <span class="token operator">+</span> <span class="token string">'2a'</span><span class="token punctuation">,</span> use_bias<span class="token operator">=</span>use_bias<span class="token punctuation">)</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span>name<span class="token operator">=</span>bn_name_base <span class="token operator">+</span> <span class="token string">'2a'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>nb_filter2<span class="token punctuation">,</span> <span class="token punctuation">(</span>kernel_size<span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span>
                  name<span class="token operator">=</span>conv_name_base <span class="token operator">+</span> <span class="token string">'2b'</span><span class="token punctuation">,</span> use_bias<span class="token operator">=</span>use_bias<span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span>name<span class="token operator">=</span>bn_name_base <span class="token operator">+</span> <span class="token string">'2b'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>nb_filter3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span>conv_name_base <span class="token operator">+</span>
                  <span class="token string">'2c'</span><span class="token punctuation">,</span> use_bias<span class="token operator">=</span>use_bias<span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span>name<span class="token operator">=</span>bn_name_base <span class="token operator">+</span> <span class="token string">'2c'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>

    shortcut <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>nb_filter3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span>strides<span class="token punctuation">,</span>
                         name<span class="token operator">=</span>conv_name_base <span class="token operator">+</span> <span class="token string">'1'</span><span class="token punctuation">,</span> use_bias<span class="token operator">=</span>use_bias<span class="token punctuation">)</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
    shortcut <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span>name<span class="token operator">=</span>bn_name_base <span class="token operator">+</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>shortcut<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> shortcut<span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'res'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token operator">+</span> block <span class="token operator">+</span> <span class="token string">'_out'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">get_resnet</span><span class="token punctuation">(</span>input_image<span class="token punctuation">,</span>stage5<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Stage 1</span>
    x <span class="token operator">=</span> ZeroPadding2D<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>input_image<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'conv1'</span><span class="token punctuation">,</span> use_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'bn_conv1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment"># Height/4,Width/4,64</span>
    C1 <span class="token operator">=</span> x <span class="token operator">=</span> MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"same"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment"># Stage 2</span>
    x <span class="token operator">=</span> conv_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    <span class="token comment"># Height/4,Width/4,256</span>
    C2 <span class="token operator">=</span> x <span class="token operator">=</span> identity_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    <span class="token comment"># Stage 3</span>
    x <span class="token operator">=</span> conv_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> identity_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    <span class="token comment"># Height/8,Width/8,512</span>
    C3 <span class="token operator">=</span> x <span class="token operator">=</span> identity_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'d'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    <span class="token comment"># Stage 4</span>
    x <span class="token operator">=</span> conv_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    block_count <span class="token operator">=</span> <span class="token number">22</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>block_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> identity_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">98</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    <span class="token comment"># Height/16,Width/16,1024</span>
    C4 <span class="token operator">=</span> x
    <span class="token comment"># Stage 5</span>
    <span class="token keyword">if</span> stage5<span class="token punctuation">:</span>
        x <span class="token operator">=</span> conv_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
        x <span class="token operator">=</span> identity_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
        <span class="token comment"># Height/32,Width/32,2048</span>
        C5 <span class="token operator">=</span> x <span class="token operator">=</span> identity_block<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stage<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> block<span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        C5 <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> C4<span class="token punctuation">,</span> C5<span class="token punctuation">]</span>

</code></pre> 
<p>关于残差神经网络，可以参考此文章：<a href="https://zhuanlan.zhihu.com/p/349717627" rel="nofollow">ResNet：残差神经网络</a></p> 
<h3><a id="22_Feature_PyramidFPN_170"></a>2.2 Feature Pyramid-FPN构建特征金字塔</h3> 
<p>上文经过主干特征提取后可以得到长宽压缩了两次C2、三次C3、四次C4、五次C5的结果，用这些结果进行特征金字塔的构造，主要是为了得到P2~P6五个有效特征层。</p> 
<p><img src="https://images2.imgbox.com/55/54/VbsLsWGE_o.png" alt=""></p> 
<p>具体过程为：</p> 
<ul><li>P5：对【C5】进行一次256通道的卷积，再进行一次256通道的卷积，得到P5。</li><li>P6：将P5进行最大池化得到P6。</li><li>P4：将【C5一次卷积的结果】进行上采样，再与【C4进行256通道卷积的结果】的进行Add运算，再进行一次256通道的卷积，得到P4。</li><li>P3、P2过程类似P4。</li></ul> 
<p>提取到的P2、P3、P4、P5、P6可以作为RPN网络的有效特征层，利用RPN建议框网络对有效特征层进行下一步的操作，对先验框进行解码获得建议框。</p> 
<p>提取到的P2、P3、P4、P5可以作为Classifier和Mask网络的有效特征层，利用Classifier预测框网络对有效特征层进行下一步的操作，对建议框解码获得最终预测框；利用Mask语义分割网络对有效特征层进行下一步的操作，获得每一个预测框内部的语义分割结果。</p> 
<p>具体代码</p> 
<pre><code class="prism language-python"><span class="token comment"># 获得Resnet里的压缩程度不同的一些层</span>
_<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> C4<span class="token punctuation">,</span> C5 <span class="token operator">=</span> get_resnet<span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> stage5<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>config<span class="token punctuation">.</span>TRAIN_BN<span class="token punctuation">)</span>

<span class="token comment"># 组合成特征金字塔的结构</span>
<span class="token comment"># P5长宽共压缩了5次</span>
<span class="token comment"># Height/32,Width/32,256</span>
P5 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fpn_c5p5'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C5<span class="token punctuation">)</span>
<span class="token comment"># P4长宽共压缩了4次</span>
<span class="token comment"># Height/16,Width/16,256</span>
P4 <span class="token operator">=</span> Add<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fpn_p4add"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    UpSampling2D<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p5upsampled"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fpn_c4p4'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># P4长宽共压缩了3次</span>
<span class="token comment"># Height/8,Width/8,256</span>
P3 <span class="token operator">=</span> Add<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fpn_p3add"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    UpSampling2D<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p4upsampled"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P4<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fpn_c3p3'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># P4长宽共压缩了2次</span>
<span class="token comment"># Height/4,Width/4,256</span>
P2 <span class="token operator">=</span> Add<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fpn_p2add"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    UpSampling2D<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p3upsampled"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P3<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fpn_c2p2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
<span class="token comment"># 各自进行一次256通道的卷积，此时P2、P3、P4、P5通道数相同</span>
<span class="token comment"># Height/4,Width/4,256</span>
P2 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"SAME"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p2"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P2<span class="token punctuation">)</span>
<span class="token comment"># Height/8,Width/8,256</span>
P3 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"SAME"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p3"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
<span class="token comment"># Height/16,Width/16,256</span>
P4 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"SAME"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p4"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
<span class="token comment"># Height/32,Width/32,256</span>
P5 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"SAME"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p5"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
<span class="token comment"># 在建议框网络里面还有一个P6用于获取建议框</span>
<span class="token comment"># Height/64,Width/64,256</span>
P6 <span class="token operator">=</span> MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p6"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5<span class="token punctuation">)</span>

<span class="token comment"># P2, P3, P4, P5, P6可以用于获取建议框</span>
rpn_feature_maps <span class="token operator">=</span> <span class="token punctuation">[</span>P2<span class="token punctuation">,</span> P3<span class="token punctuation">,</span> P4<span class="token punctuation">,</span> P5<span class="token punctuation">,</span> P6<span class="token punctuation">]</span>
<span class="token comment"># P2, P3, P4, P5用于获取mask信息</span>
mrcnn_feature_maps <span class="token operator">=</span> <span class="token punctuation">[</span>P2<span class="token punctuation">,</span> P3<span class="token punctuation">,</span> P4<span class="token punctuation">,</span> P5<span class="token punctuation">]</span>

</code></pre> 
<h3><a id="23_RPN_233"></a>2.3 构建RPN建议网络模型</h3> 
<p>RPN建议网络的模型</p> 
<ul><li>首先进行一次3x3的通道为512的卷积</li><li>然后分别进行一次<code>anchors_per_location x 2</code>的卷积和<code>anchors_per_location x 4</code>的卷积。 
  <ul><li><code>anchors_per_location x 2</code>的卷积用于预测<strong>公共特征层上 每一个网格点上 每一个预测框</strong>内部是否包含物体。</li><li><code>anchors_per_location x 4</code>的卷积用于预测<strong>公共特征层上 每一个网格点上 每一个先验框</strong>的变化情况。</li></ul> </li></ul> 
<p>例如输入图片的shape是1024x1024x3时，公共特征层的shape就是256x256x256、128x128x256、64x64x256、32x32x256、16x16x256。这些公共特征层上的每一个点，映射到原始图片上就是间隔不同的网格点，每个网格默认存在3(anchors_per_location)个先验框，这些先验框有不同的大小。</p> 
<p><img src="https://images2.imgbox.com/34/33/KwALMwD7_o.png" alt=""></p> 
<p><strong>anchors_per_location x 4的卷积</strong>的结果会对这些先验框进行调整，获得一个新的框。<br> <strong>anchors_per_location x 2的卷积</strong>会判断上述获得的新框是否包含物体。</p> 
<p>到这里我们可以获得了一些有用的框，这些框会利用<strong>anchors_per_location x 2的卷积</strong>判断是否存在物体。</p> 
<p>实现代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#------------------------------------#</span>
<span class="token comment">#   五个不同大小的特征层会传入到</span>
<span class="token comment">#   RPN当中，获得建议框</span>
<span class="token comment">#------------------------------------#</span>

<span class="token keyword">def</span> <span class="token function">rpn_graph</span><span class="token punctuation">(</span>feature_map<span class="token punctuation">,</span> anchors_per_location<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#------------------------------------#</span>
    <span class="token comment">#   利用一个3x3卷积进行特征整合，基础的层</span>
    <span class="token comment">#------------------------------------#</span>
    shared <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'rpn_conv_shared'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>feature_map<span class="token punctuation">)</span>
    
    <span class="token comment">#------------------------------------#</span>
    <span class="token comment">#   batch_size, num_anchors, 2</span>
    <span class="token comment">#   代表这个先验框是否包含物体</span>
    <span class="token comment">#   anchor_per_location的默认值是3</span>
    <span class="token comment">#   意味着特征层对图像进行网格的划分后，每个网格上先验框的数量是3</span>
    <span class="token comment">#------------------------------------#</span>
    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>anchors_per_location <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'valid'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'rpn_class_raw'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>shared<span class="token punctuation">)</span>

    <span class="token comment"># reshape到最后一个维度是2的维度，是一个分类网络，有非常多先验框</span>
    rpn_class_logits <span class="token operator">=</span> Reshape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    rpn_probs <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">"softmax"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"rpn_class_xxx"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>rpn_class_logits<span class="token punctuation">)</span>

    <span class="token comment">#------------------------------------#</span>
    <span class="token comment">#   batch_size, num_anchors, 4</span>
    <span class="token comment">#   这个先验框的调整参数</span>
    <span class="token comment">#------------------------------------#</span>
    x <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>anchors_per_location <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'rpn_bbox_pred'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>shared<span class="token punctuation">)</span>
    rpn_bbox <span class="token operator">=</span> Reshape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token comment"># 输出包括：</span>
    <span class="token comment"># 先验框是否真实的包含物体</span>
    <span class="token comment"># bbox先验框的调整参数</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>rpn_class_logits<span class="token punctuation">,</span> rpn_probs<span class="token punctuation">,</span> rpn_bbox<span class="token punctuation">]</span>


<span class="token comment">#------------------------------------#</span>
<span class="token comment">#   建立建议框网络模型</span>
<span class="token comment">#   RPN模型</span>
<span class="token comment">#------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">build_rpn_model</span><span class="token punctuation">(</span>anchors_per_location<span class="token punctuation">,</span> depth<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 输入的长和宽都是None，代表输入的有效特征层大小是变化的，256、64等都可以</span>
    <span class="token comment"># 输入的depth是256</span>
    input_feature_map <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> depth<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"input_rpn_feature_map"</span><span class="token punctuation">)</span>
    <span class="token comment"># 将输入的图像传入到rpn_graph中</span>
    outputs <span class="token operator">=</span> rpn_graph<span class="token punctuation">(</span>input_feature_map<span class="token punctuation">,</span> anchors_per_location<span class="token punctuation">)</span>
    <span class="token keyword">return</span> Model<span class="token punctuation">(</span><span class="token punctuation">[</span>input_feature_map<span class="token punctuation">]</span><span class="token punctuation">,</span> outputs<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"rpn_model"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="24_Anchors_305"></a>2.4 Anchors先验框的获取</h3> 
<p><strong>先验框就是图像上的一定的区域，这些区域是人为规定好的</strong>，这些区域可能包含物体，可能不包含物体，我们网络的预测结果就会判断哪些先验框是包含物体的，然后对先验框进行调整。</p> 
<p>在MaskRCNN中，建议框网络的预测结果就会对这些先验框进行调整，获得建议框，并判断哪些先验框是包含物体的。</p> 
<p>本节介绍如何获得<strong>先验框</strong>。</p> 
<pre><code class="prism language-python"><span class="token comment">#----------------------------------------------------------#</span>
<span class="token comment">#  Anchors</span>
<span class="token comment">#----------------------------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">generate_anchors</span><span class="token punctuation">(</span>scales<span class="token punctuation">,</span> ratios<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> feature_stride<span class="token punctuation">,</span> anchor_stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment">#   获得所有框的长度和比例的组合</span>
    <span class="token comment">#   相当于在每一个网格点上获得了两个长方形(1:2)、(2:1)和一个正方形</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    scales<span class="token punctuation">,</span> ratios <span class="token operator">=</span> np<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>scales<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>ratios<span class="token punctuation">)</span><span class="token punctuation">)</span>
    scales <span class="token operator">=</span> scales<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ratios <span class="token operator">=</span> ratios<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
    heights <span class="token operator">=</span> scales <span class="token operator">/</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>ratios<span class="token punctuation">)</span>
    widths <span class="token operator">=</span> scales <span class="token operator">*</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>ratios<span class="token punctuation">)</span>
  
    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment">#   生成网格中心</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    shifts_y <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anchor_stride<span class="token punctuation">)</span> <span class="token operator">*</span> feature_stride
    shifts_x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anchor_stride<span class="token punctuation">)</span> <span class="token operator">*</span> feature_stride
    shifts_x<span class="token punctuation">,</span> shifts_y <span class="token operator">=</span> np<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>shifts_x<span class="token punctuation">,</span> shifts_y<span class="token punctuation">)</span>

    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment">#   获得先验框的中心和宽高</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    box_widths<span class="token punctuation">,</span> box_centers_x <span class="token operator">=</span> np<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>widths<span class="token punctuation">,</span> shifts_x<span class="token punctuation">)</span>
    box_heights<span class="token punctuation">,</span> box_centers_y <span class="token operator">=</span> np<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>heights<span class="token punctuation">,</span> shifts_y<span class="token punctuation">)</span>
  
    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment">#   更变格式</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment"># 对先验框的中心堆叠，然后reshape，reshape后的结果代表每一个先验框的中心坐标</span>
    box_centers <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>box_centers_y<span class="token punctuation">,</span> box_centers_x<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 对先验框的高和宽堆叠，然后reshape，reshape后的结果代表每一个先验框的高和宽</span>
    box_sizes <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>box_heights<span class="token punctuation">,</span> box_widths<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  
    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment">#   计算出(y1, x1, y2, x2)</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>box_centers <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> box_sizes<span class="token punctuation">,</span> box_centers <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> box_sizes<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> boxes


<span class="token comment"># 生成特征金字塔先验框</span>
<span class="token keyword">def</span> <span class="token function">generate_pyramid_anchors</span><span class="token punctuation">(</span>scales<span class="token punctuation">,</span> ratios<span class="token punctuation">,</span> feature_shapes<span class="token punctuation">,</span> feature_strides<span class="token punctuation">,</span>  anchor_stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    生成不同特征层的anchors，并利用concatenate进行堆叠
    """</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment">#   Anchors</span>
    <span class="token comment">#   [anchor_count, (y1, x1, y2, x2)]</span>
    <span class="token comment">#   P2对应的scale是32</span>
    <span class="token comment">#   P3对应的scale是64</span>
    <span class="token comment">#   P4对应的scale是128</span>
    <span class="token comment">#   P5对应的scale是256</span>
    <span class="token comment">#   P6对应的scale是512</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 对scales进行for循环，是传入的anchor_scales，是32、64、128、256、512</span>
    <span class="token comment"># 对应不同特征层上先验框的基础大小，再在此基础上获得调整，获得不同长宽大小的先验框</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>scales<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ratio的值是0.5、1、2，对应每个网格点上三个先验框</span>
        <span class="token comment"># feature_shapes就是获得的每一个有效特征层的大小，代表我们要将图片分割成多少网格</span>
        <span class="token comment"># feature_strides对应backbone_strides，是4、8、16、32、64</span>
        <span class="token comment"># anchor_stride的值为1</span>
        anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>generate_anchors<span class="token punctuation">(</span>scales<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> ratios<span class="token punctuation">,</span> feature_shapes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> feature_strides<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> anchor_stride<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">compute_backbone_shapes</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> image_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>image_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> stride<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>image_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> stride<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> stride <span class="token keyword">in</span> config<span class="token punctuation">.</span>BACKBONE_STRIDES<span class="token punctuation">]</span><span class="token punctuation">)</span>
    

<span class="token comment"># 利用下面的函数获取先验框</span>
<span class="token keyword">def</span> <span class="token function">get_anchors</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> image_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 计算主干特征提取网络获得的有效特征层的shape</span>
    <span class="token comment"># 为了事先放置先验框，我们需要知道网格大小，因此需要先获得有效特征层的shape</span>
    backbone_shapes <span class="token operator">=</span> compute_backbone_shapes<span class="token punctuation">(</span>config<span class="token punctuation">,</span> image_shape<span class="token punctuation">)</span>
    anchor_cache <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>image_shape<span class="token punctuation">)</span> <span class="token keyword">in</span> anchor_cache<span class="token punctuation">:</span>
        <span class="token comment"># 将backbone_shapes传入下面的函数</span>
        <span class="token comment"># 生成特征金字塔的先验框</span>
        a <span class="token operator">=</span> generate_pyramid_anchors<span class="token punctuation">(</span>
            config<span class="token punctuation">.</span>RPN_ANCHOR_SCALES<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>RPN_ANCHOR_RATIOS<span class="token punctuation">,</span>
            backbone_shapes<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>BACKBONE_STRIDES<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>RPN_ANCHOR_STRIDE<span class="token punctuation">)</span>
        anchor_cache<span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>image_shape<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> norm_boxes<span class="token punctuation">(</span>a<span class="token punctuation">,</span> image_shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> anchor_cache<span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>image_shape<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="25__407"></a>2.5 先验框调整获得建议框</h3> 
<p>利用<code>ProposalLayer</code>对先验框解码获取建议框。</p> 
<pre><code class="prism language-python">    <span class="token comment">#------------------------------------------------------------------#</span>
    <span class="token comment">#   对先验框进行解码，获得先验框解码后的建议框的坐标</span>
    <span class="token comment">#   rpn_rois            : Batch_size, proposal_count, 4</span>
    <span class="token comment">#------------------------------------------------------------------#</span>

    proposal_count <span class="token operator">=</span> config<span class="token punctuation">.</span>POST_NMS_ROIS_TRAINING
    rpn_rois <span class="token operator">=</span> ProposalLayer<span class="token punctuation">(</span>proposal_count<span class="token operator">=</span>proposal_count<span class="token punctuation">,</span> nms_threshold<span class="token operator">=</span>config<span class="token punctuation">.</span>RPN_NMS_THRESHOLD<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"ROI"</span><span class="token punctuation">,</span> config<span class="token operator">=</span>config<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>rpn_class<span class="token punctuation">,</span> rpn_bbox<span class="token punctuation">,</span> anchors<span class="token punctuation">]</span><span class="token punctuation">)</span>
    active_class_ids <span class="token operator">=</span> Lambda<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> parse_image_meta_graph<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"active_class_ids"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>input_image_meta<span class="token punctuation">)</span>
</code></pre> 
<p>输入参数有三个分别是<code>rpn_class</code>、<code>rpn_bbox</code>、<code>anchors</code>，这里的<code>rpn_class</code>代表所有先验框是否包含物体的置信度，<code>rpn_bbox</code>代表所有先验框的调整参数，<code>anchors</code>之前获得的所有先验框。</p> 
<p>其中<code>ProposalLayer</code>的具体代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#----------------------------------------------------------#</span>
<span class="token comment">#   Proposal Layer</span>
<span class="token comment">#   该部分代码用于将先验框转化成建议框</span>
<span class="token comment">#----------------------------------------------------------#</span>

<span class="token keyword">class</span> <span class="token class-name">ProposalLayer</span><span class="token punctuation">(</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposal_count<span class="token punctuation">,</span> nms_threshold<span class="token punctuation">,</span> config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ProposalLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
        self<span class="token punctuation">.</span>proposal_count <span class="token operator">=</span> proposal_count
        self<span class="token punctuation">.</span>nms_threshold <span class="token operator">=</span> nms_threshold

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   输入的inputs有三个内容</span>
        <span class="token comment">#   inputs[0]   rpn_class   : Batch_size, num_anchors, 2</span>
        <span class="token comment">#   inputs[1]   rpn_bbox    : Batch_size, num_anchors, 4</span>
        <span class="token comment">#   inputs[2]   anchors     : Batch_size, num_anchors, 4</span>
        <span class="token comment">#----------------------------------------------------------#</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   获得先验框内部是否有物体[Batch_size, num_anchors, 1]</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        scores <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
  
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   获得先验框的调整参数[batch, num_rois, 4]</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        deltas <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   获得先验框的坐标</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        anchors <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   RPN_BBOX_STD_DEV[0.1 0.1 0.2 0.2] 改变数量级</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        deltas <span class="token operator">=</span> deltas <span class="token operator">*</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RPN_BBOX_STD_DEV<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   筛选出得分前6000个的框</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        pre_nms_limit <span class="token operator">=</span> tf<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PRE_NMS_LIMIT<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   获得这些框的索引</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        ix <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>top_k<span class="token punctuation">(</span>scores<span class="token punctuation">,</span> pre_nms_limit<span class="token punctuation">,</span> <span class="token builtin">sorted</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"top_anchors"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>indices

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   获得先验框、及其得分与调整参数</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        scores <span class="token operator">=</span> batch_slice<span class="token punctuation">(</span><span class="token punctuation">[</span>scores<span class="token punctuation">,</span> ix<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">)</span>
        deltas <span class="token operator">=</span> batch_slice<span class="token punctuation">(</span><span class="token punctuation">[</span>deltas<span class="token punctuation">,</span> ix<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">)</span>
        pre_nms_anchors <span class="token operator">=</span> batch_slice<span class="token punctuation">(</span><span class="token punctuation">[</span>anchors<span class="token punctuation">,</span> ix<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> x<span class="token punctuation">:</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>a<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">,</span> names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"pre_nms_anchors"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   [batch, pre_nms_limit, (y1, x1, y2, x2)]</span>
        <span class="token comment">#   对先验框进行解码</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        boxes <span class="token operator">=</span> batch_slice<span class="token punctuation">(</span><span class="token punctuation">[</span>pre_nms_anchors<span class="token punctuation">,</span> deltas<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> apply_box_deltas_graph<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">,</span> names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"refined_anchors"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   [batch, pre_nms_limit, (y1, x1, y2, x2)]</span>
        <span class="token comment">#   防止超出图片范围</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        window <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        boxes <span class="token operator">=</span> batch_slice<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> clip_boxes_graph<span class="token punctuation">(</span>x<span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">,</span> names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"refined_anchors_clipped"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  
        <span class="token comment">#---------------------------------------------------------#</span>
        <span class="token comment">#   在非极大抑制后</span>
        <span class="token comment">#   获得一个shape为[batch, NMS_ROIS, 4]的proposals</span>
        <span class="token comment">#---------------------------------------------------------#</span>
        <span class="token keyword">def</span> <span class="token function">nms</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> scores<span class="token punctuation">)</span><span class="token punctuation">:</span>
            indices <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>non_max_suppression<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> self<span class="token punctuation">.</span>proposal_count<span class="token punctuation">,</span> self<span class="token punctuation">.</span>nms_threshold<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"rpn_non_max_suppression"</span><span class="token punctuation">)</span>
            proposals <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> indices<span class="token punctuation">)</span>
            padding <span class="token operator">=</span> tf<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>self<span class="token punctuation">.</span>proposal_count <span class="token operator">-</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>proposals<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            proposals <span class="token operator">=</span> tf<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> padding<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> proposals
        proposals <span class="token operator">=</span> batch_slice<span class="token punctuation">(</span><span class="token punctuation">[</span>boxes<span class="token punctuation">,</span> scores<span class="token punctuation">]</span><span class="token punctuation">,</span> nms<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">)</span>
        <span class="token keyword">return</span> proposals

    <span class="token keyword">def</span> <span class="token function">compute_output_shape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>proposal_count<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
</code></pre> 
<p>其中利用到了下面的函数对建议框的位置和长宽进行调整</p> 
<pre><code class="prism language-python"><span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   利用先验框调整参数调整先验框，获得建议框的坐标</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">apply_box_deltas_graph</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> deltas<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#---------------------------------------#</span>
    <span class="token comment">#   计算先验框的中心和宽高</span>
    <span class="token comment">#---------------------------------------#</span>
    height <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    width <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    center_y <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> height
    center_x <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> width

    <span class="token comment">#---------------------------------------#</span>
    <span class="token comment">#   计算出调整后的先验框的中心和宽高</span>
    <span class="token comment">#---------------------------------------#</span>
    center_y <span class="token operator">+=</span> deltas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> height
    center_x <span class="token operator">+=</span> deltas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> width
    height <span class="token operator">*=</span> tf<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>deltas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    width <span class="token operator">*=</span> tf<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>deltas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">#---------------------------------------#</span>
    <span class="token comment">#   计算左上角和右下角的点的坐标</span>
    <span class="token comment">#---------------------------------------#</span>
    y1 <span class="token operator">=</span> center_y <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> height
    x1 <span class="token operator">=</span> center_x <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> width
    y2 <span class="token operator">=</span> y1 <span class="token operator">+</span> height
    x2 <span class="token operator">=</span> x1 <span class="token operator">+</span> width

    result <span class="token operator">=</span> tf<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"apply_box_deltas_out"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
</code></pre> 
<h3><a id="26__550"></a>2.6 利用建议框对共享特征层进行截取</h3> 
<p>ROI Align层的作用就是根据建议框对不同的特征层进行截取。主要代码如下，其功能就是根据建议框的大小，判断建议框属于哪一个特征层，然后利用建议框对对应的特征层进行截取。</p> 
<pre><code class="prism language-python">    <span class="token comment">#---------------------------------------------------------------#</span>
    <span class="token comment">#   ROI Pooling，利用建议框在特征层上进行截取</span>
    <span class="token comment">#   x   : [batch, num_rois, POOL_SIZE, POOL_SIZE, channels]</span>
    <span class="token comment">#   pool_size 是对共享特征层截取后resize后的局部特征层的大小</span>
    <span class="token comment">#   rois是初步筛选后的建议框</span>
    <span class="token comment">#   image_meta是保存了图片的必要信息</span>
    <span class="token comment">#   feature_maps共享特征层</span>
    <span class="token comment">#---------------------------------------------------------------#</span>
    x <span class="token operator">=</span> PyramidROIAlign<span class="token punctuation">(</span><span class="token punctuation">[</span>pool_size<span class="token punctuation">,</span> pool_size<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"roi_align_classifier"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>rois<span class="token punctuation">,</span> image_meta<span class="token punctuation">]</span> <span class="token operator">+</span> feature_maps<span class="token punctuation">)</span>
</code></pre> 
<p>其中<code>PyramidROIAlign</code>函数的定义如下：</p> 
<p>首先获取建议框的坐标、图片信息、特征层。然后根据建议框的大小，判断建议框属于哪一个特征层（较大的特征层比如256x256的，网格划分密集，每一个建议框大小比较小，以此判断）。利用循环对于P2~P5五个特征层进行截取。</p> 
<pre><code class="prism language-python"><span class="token comment">#----------------------------------------------------------#</span>
<span class="token comment">#   ROIAlign Layer</span>
<span class="token comment">#   利用建议框在特征层上截取内容</span>
<span class="token comment">#----------------------------------------------------------#</span>
<span class="token keyword">class</span> <span class="token class-name">PyramidROIAlign</span><span class="token punctuation">(</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pool_shape<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PyramidROIAlign<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool_shape <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>pool_shape<span class="token punctuation">)</span>
  
    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   获得建议框的坐标</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        boxes <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   image_meta包含了一些必要的图片信息</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        image_meta <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   取出所有的特征层[batch, height, width, channels]</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        feature_maps <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   获得建议框的宽高</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        h <span class="token operator">=</span> y2 <span class="token operator">-</span> y1
        w <span class="token operator">=</span> x2 <span class="token operator">-</span> x1
  
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   获得输入进来的图像的大小，对image的内容进行分割</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        image_shape <span class="token operator">=</span> parse_image_meta_graph<span class="token punctuation">(</span>image_meta<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'image_shape'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   通过建议框的大小找到这个建议框属于哪个特征层，第一层256划分区域多建议框较小32</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        image_area <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>image_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> image_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        roi_level <span class="token operator">=</span> log2_graph<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>h <span class="token operator">*</span> w<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">224.0</span> <span class="token operator">/</span> tf<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>image_area<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        roi_level <span class="token operator">=</span> tf<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">+</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>tf<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>roi_level<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># roi_level是每张图片里每个建议框对应的特征层是哪个</span>
        roi_level <span class="token operator">=</span> tf<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>roi_level<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

        pooled <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        box_to_level <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 分别在P2-P5中进行截取</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> level <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#-----------------------------------------------#</span>
            <span class="token comment">#   找到每个特征层对应的建议框</span>
            <span class="token comment">#   level_boxes存放所有属于该特征层的建议框</span>
            <span class="token comment">#-----------------------------------------------#</span>
            ix <span class="token operator">=</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>roi_level<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">)</span>
            level_boxes <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather_nd<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> ix<span class="token punctuation">)</span>
            box_to_level<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ix<span class="token punctuation">)</span>
  
            <span class="token comment">#-----------------------------------------------#</span>
            <span class="token comment">#    获得这些建议框所属的图片</span>
            <span class="token comment">#-----------------------------------------------#</span>
            box_indices <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>ix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>

            <span class="token comment"># 停止梯度下降</span>
            level_boxes <span class="token operator">=</span> tf<span class="token punctuation">.</span>stop_gradient<span class="token punctuation">(</span>level_boxes<span class="token punctuation">)</span>
            box_indices <span class="token operator">=</span> tf<span class="token punctuation">.</span>stop_gradient<span class="token punctuation">(</span>box_indices<span class="token punctuation">)</span>

            <span class="token comment">#--------------------------------------------------------------------------#</span>
            <span class="token comment">#   利用建议框对特征层进行截取  </span>
            <span class="token comment">#   [batch * num_boxes, pool_height, pool_width, channels]</span>
            <span class="token comment">#   box_indices表示是截取哪张图片里的特征层</span>
            <span class="token comment">#--------------------------------------------------------------------------#</span>
            pooled<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>crop_and_resize<span class="token punctuation">(</span>
                feature_maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> level_boxes<span class="token punctuation">,</span> box_indices<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pool_shape<span class="token punctuation">,</span>
                method<span class="token operator">=</span><span class="token string">"bilinear"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        pooled <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>pooled<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">#--------------------------------------------------------------------------#</span>
        <span class="token comment">#   将顺序和所属的图片进行堆叠</span>
        <span class="token comment">#--------------------------------------------------------------------------#</span>
        box_to_level <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>box_to_level<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        box_range <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>tf<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>box_to_level<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        box_to_level <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>box_to_level<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">,</span> box_range<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
  
        <span class="token comment"># box_to_level[:, 0]表示第几张图</span>
        <span class="token comment"># box_to_level[:, 1]表示第几张图里的第几个框</span>
        sorting_tensor <span class="token operator">=</span> box_to_level<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100000</span> <span class="token operator">+</span> box_to_level<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment"># 进行排序，将同一张图里的某一些聚集在一起</span>
        ix <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>top_k<span class="token punctuation">(</span>sorting_tensor<span class="token punctuation">,</span> k<span class="token operator">=</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>
            box_to_level<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>indices<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment"># 按顺序获得图片的索引</span>
        ix <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>box_to_level<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ix<span class="token punctuation">)</span>
        pooled <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>pooled<span class="token punctuation">,</span> ix<span class="token punctuation">)</span>

        <span class="token comment">#--------------------------------------------------------------------------#</span>
        <span class="token comment">#   重新reshape为如下</span>
        <span class="token comment">#   [batch, num_rois, POOL_SIZE, POOL_SIZE, channels]</span>
        <span class="token comment">#--------------------------------------------------------------------------#</span>
        shape <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>pooled<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        pooled <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>pooled<span class="token punctuation">,</span> shape<span class="token punctuation">)</span>
        <span class="token keyword">return</span> pooled
</code></pre> 
<h3><a id="27__673"></a>2.7 局部公用特征层到预测结果</h3> 
<p>如何利用调整后的局部特征层获得预测结果</p> 
<pre><code class="prism language-python">    mrcnn_class_logits<span class="token punctuation">,</span> mrcnn_class<span class="token punctuation">,</span> mrcnn_bbox <span class="token operator">=</span>\

        fpn_classifier_graph<span class="token punctuation">(</span>rpn_rois<span class="token punctuation">,</span> mrcnn_feature_maps<span class="token punctuation">,</span> input_image_meta<span class="token punctuation">,</span>

                                config<span class="token punctuation">.</span>POOL_SIZE<span class="token punctuation">,</span> config<span class="token punctuation">.</span>NUM_CLASSES<span class="token punctuation">,</span>

                                train_bn<span class="token operator">=</span>config<span class="token punctuation">.</span>TRAIN_BN<span class="token punctuation">,</span>

                                fc_layers_size<span class="token operator">=</span>config<span class="token punctuation">.</span>FPN_CLASSIF_FC_LAYERS_SIZE<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment">#------------------------------------#</span>
<span class="token comment">#   建立classifier模型，该函数主要实现目标检测功能</span>
<span class="token comment">#   这个模型的预测结果会调整建议框</span>
<span class="token comment">#   获得最终的预测框</span>
<span class="token comment">#------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">fpn_classifier_graph</span><span class="token punctuation">(</span>rois<span class="token punctuation">,</span> feature_maps<span class="token punctuation">,</span> image_meta<span class="token punctuation">,</span>
                         pool_size<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> train_bn<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                         fc_layers_size<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#---------------------------------------------------------------#</span>
    <span class="token comment">#   ROI Pooling，利用建议框在特征层上进行截取</span>
    <span class="token comment">#   x   : [batch, num_rois, POOL_SIZE, POOL_SIZE, channels]，调整后的局部特征层</span>
    <span class="token comment">#   pool_size 是对共享特征层截取后resize后的局部特征层的大小</span>
    <span class="token comment">#   rois是初步筛选后的建议框</span>
    <span class="token comment">#   image_meta是保存了图片的必要信息</span>
    <span class="token comment">#   feature_maps共享特征层</span>
    <span class="token comment">#---------------------------------------------------------------#</span>
    x <span class="token operator">=</span> PyramidROIAlign<span class="token punctuation">(</span><span class="token punctuation">[</span>pool_size<span class="token punctuation">,</span> pool_size<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"roi_align_classifier"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>rois<span class="token punctuation">,</span> image_meta<span class="token punctuation">]</span> <span class="token operator">+</span> feature_maps<span class="token punctuation">)</span>

    <span class="token comment">#------------------------------------------------------------------#</span>
    <span class="token comment">#   利用卷积进行特征整合，首先进行7x7的卷积，相当于两次全连接</span>
    <span class="token comment">#   x   : [batch, num_rois, 1, 1, fc_layers_size]</span>
    <span class="token comment">#------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span>fc_layers_size<span class="token punctuation">,</span> <span class="token punctuation">(</span>pool_size<span class="token punctuation">,</span> pool_size<span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  name<span class="token operator">=</span><span class="token string">"mrcnn_class_conv1"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mrcnn_class_bn1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment">#------------------------------------------------------------------#</span>
    <span class="token comment">#   x   : [batch, num_rois, 1, 1, fc_layers_size]</span>
    <span class="token comment">#------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span>fc_layers_size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_class_conv2"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mrcnn_class_bn2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token comment">#------------------------------------------------------------------#</span>
    <span class="token comment">#   x   : [batch, num_rois, fc_layers_size]</span>
    <span class="token comment">#------------------------------------------------------------------#</span>
    shared <span class="token operator">=</span> Lambda<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> K<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>K<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  name<span class="token operator">=</span><span class="token string">"pool_squeeze"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token comment">#------------------------------------------------------------------#</span>
    <span class="token comment">#   Classifier head</span>
    <span class="token comment">#   这个的预测结果代表这个先验框内部的物体的种类</span>
    <span class="token comment">#   mrcnn_probs   : [batch, num_rois, num_classes]，每一张图片里，每一个先验框里面，物体的种类</span>
    <span class="token comment">#------------------------------------------------------------------#</span>
    mrcnn_class_logits <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mrcnn_class_logits'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>shared<span class="token punctuation">)</span>
    mrcnn_probs <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Activation<span class="token punctuation">(</span><span class="token string">"softmax"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_class"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mrcnn_class_logits<span class="token punctuation">)</span>

    <span class="token comment">#------------------------------------------------------------------#</span>
    <span class="token comment">#   BBox head</span>
    <span class="token comment">#   这个的预测结果会对先验框进行调整</span>
    <span class="token comment">#   mrcnn_bbox : [batch, num_rois, num_classes, 4]</span>
    <span class="token comment">#------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span>num_classes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mrcnn_bbox_fc'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>shared<span class="token punctuation">)</span>
    mrcnn_bbox <span class="token operator">=</span> Reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_bbox"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token keyword">return</span> mrcnn_class_logits<span class="token punctuation">,</span> mrcnn_probs<span class="token punctuation">,</span> mrcnn_bbox


<span class="token comment">#----------------------------------------------#</span>
<span class="token comment">#   建立mask模型</span>
<span class="token comment">#   这个模型会利用预测框对特征层进行ROIAlign</span>
<span class="token comment">#   根据截取下来的特征层进行语义分割</span>
<span class="token comment">#----------------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">build_fpn_mask_graph</span><span class="token punctuation">(</span>rois<span class="token punctuation">,</span> feature_maps<span class="token punctuation">,</span> image_meta<span class="token punctuation">,</span>
                         pool_size<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> train_bn<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   ROI Pooling，利用预测框在特征层上进行截取</span>
    <span class="token comment">#   x   : batch, num_rois, MASK_POOL_SIZE, MASK_POOL_SIZE, channels</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> PyramidROIAlign<span class="token punctuation">(</span><span class="token punctuation">[</span>pool_size<span class="token punctuation">,</span> pool_size<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"roi_align_mask"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>rois<span class="token punctuation">,</span> image_meta<span class="token punctuation">]</span> <span class="token operator">+</span> feature_maps<span class="token punctuation">)</span>

    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   x   : batch, num_rois, MASK_POOL_SIZE, MASK_POOL_SIZE, 256</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"same"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_mask_conv1"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mrcnn_mask_bn1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   x   : batch, num_rois, MASK_POOL_SIZE, MASK_POOL_SIZE, 256</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"same"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_mask_conv2"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mrcnn_mask_bn2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   x   : batch, num_rois, MASK_POOL_SIZE, MASK_POOL_SIZE, 256</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"same"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_mask_conv3"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mrcnn_mask_bn3'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   x   : batch, num_rois, MASK_POOL_SIZE, MASK_POOL_SIZE, 256</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"same"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_mask_conv4"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mrcnn_mask_bn4'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> training<span class="token operator">=</span>train_bn<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   x   : batch, num_rois, 2xMASK_POOL_SIZE, 2xMASK_POOL_SIZE, 256</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Conv2DTranspose<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">"relu"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_mask_deconv"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   反卷积后再次进行一个1x1卷积调整通道，</span>
    <span class="token comment">#   使其最终数量为numclasses，代表分的类</span>
    <span class="token comment">#   x   : batch, num_rois, 2xMASK_POOL_SIZE, 2xMASK_POOL_SIZE, numclasses</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span>num_classes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">"sigmoid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_mask"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> x
</code></pre> 
<h3><a id="28__802"></a>2.8 建议框调整获得预测框</h3> 
<pre><code class="prism language-python">    <span class="token comment">#------------------------------------------------------------#</span>
    <span class="token comment">#   detections          : Batch_size, num_detections, 6</span>
    <span class="token comment">#   detection_boxes     : Batch_size, num_detections, 4</span>
    <span class="token comment">#------------------------------------------------------------#</span>
    detections <span class="token operator">=</span> DetectionLayer<span class="token punctuation">(</span>config<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mrcnn_detection"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>rpn_rois<span class="token punctuation">,</span> mrcnn_class<span class="token punctuation">,</span> mrcnn_bbox<span class="token punctuation">,</span> input_image_meta<span class="token punctuation">]</span><span class="token punctuation">)</span>
    detection_boxes <span class="token operator">=</span> Lambda<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>detections<span class="token punctuation">)</span>
</code></pre> 
<p>我们的工作都发生在<code>DetectionLayer</code>四个参数分别是rpn_rois建议框、mrcnn_class建议内部物体的置信度、mrcnn_bbox建议框的调整参数、input_image_meta输入图片的基本信息。</p> 
<p>其中<code>DetectionLayer</code>的定义如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#----------------------------------------------------------#</span>
<span class="token comment">#   Detection Layer</span>
<span class="token comment">#   利用classifier的预测结果对建议框进行调整获得预测框</span>
<span class="token comment">#----------------------------------------------------------#</span>
<span class="token keyword">class</span> <span class="token class-name">DetectionLayer</span><span class="token punctuation">(</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DetectionLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#------------------------------------------------------------------#</span>
        <span class="token comment">#   获得的inputs</span>
        <span class="token comment">#   rpn_rois            : Batch_size, proposal_count, 4</span>
        <span class="token comment">#   mrcnn_class         : Batch_size, num_rois, num_classes</span>
        <span class="token comment">#   mrcnn_bbox          : Batch_size, num_rois, num_classes, </span>
        <span class="token comment">#------------------------------------------------------------------#</span>
        rois <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        mrcnn_class <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        mrcnn_bbox <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        image_meta <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

        <span class="token comment">#------------------------------------------------------------------#</span>
        <span class="token comment">#   找到window的小数形式，指出原始的图片在调整后（加灰条）图片中的位置</span>
        <span class="token comment">#------------------------------------------------------------------#</span>
        m <span class="token operator">=</span> parse_image_meta_graph<span class="token punctuation">(</span>image_meta<span class="token punctuation">)</span>
        image_shape <span class="token operator">=</span> m<span class="token punctuation">[</span><span class="token string">'image_shape'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        window <span class="token operator">=</span> norm_boxes_graph<span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token string">'window'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> image_shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment">#------------------------------------------------------------------#</span>
        <span class="token comment">#   对每一张图的结果进行解码</span>
        <span class="token comment">#------------------------------------------------------------------#</span>
        detections_batch <span class="token operator">=</span> batch_slice<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>rois<span class="token punctuation">,</span> mrcnn_class<span class="token punctuation">,</span> mrcnn_bbox<span class="token punctuation">,</span> window<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> z<span class="token punctuation">:</span> refine_detections_graph<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> z<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">)</span>

        <span class="token comment">#------------------------------------------------------------#</span>
        <span class="token comment">#   最终输出的shape为</span>
        <span class="token comment">#   Batch_size, num_detections, 6] </span>
        <span class="token comment">#------------------------------------------------------------#</span>
        <span class="token keyword">return</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>
            detections_batch<span class="token punctuation">,</span>
            <span class="token punctuation">[</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>BATCH_SIZE<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DETECTION_MAX_INSTANCES<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_863"></a>三、创建自己的数据集</h2> 
<h3><a id="31_labelme_865"></a>3.1 安装labelme</h3> 
<p>打开cmd窗口，输入<code>activate tensorflow2</code>激活自己的anaconda环境。</p> 
<p>然后安装labelme</p> 
<pre><code class="prism language-shell">pip <span class="token function">install</span> labelme
</code></pre> 
<p>安装完成后直接在命令行输入<code>labelme</code>即可打开。</p> 
<p>使用label进行标注</p> 
<h3><a id="32__879"></a>3.2 开始训练</h3> 
<p>运行<code>json_to_dataset.py</code>将标注的json图像转换为数据集。</p> 
<p>在<code>dataset.py</code>中的<code>load_shapes</code>中添加自己的分类，同时在最后的循环中也添加自己的分类。</p> 
<p>在<code>train.py</code>的<code>ShapesConfig</code>修改图片大小，<code>IMAGE_MIN_DIM</code>和<code>IMAGE_MAX_DIM</code>两个图片大小可以一样，<code>NUM_CLASSES</code>后面的数字是分的类</p> 
<blockquote> 
 <p>本博客文章首先发布于个人博客网站：<a href="https://www.mahaofei.com/" rel="nofollow">https://www.mahaofei.com/</a>，欢迎大家访问。</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b9f228d83c7a2881a42a93f461c80358/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【自动化办公】python批量替换word中的内容</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/396dac5e817f4444b3dd098b174d4407/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">初学者必看Markdown 使用指南</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>