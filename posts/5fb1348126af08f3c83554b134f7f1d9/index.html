<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>线上个别机器访问公网地址时出现tcp请求超时或无响应处理方案 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="线上个别机器访问公网地址时出现tcp请求超时或无响应处理方案" />
<meta property="og:description" content="问题描述： 线上环境有多个实例，分别在不同的机房。正常情况下没问题，但每当同机房下，添加新的实例服务器后，在这台新的实例上就会偶发出现请求超时或无响应的情况。并发量越大，出现的概率越高。ping正常。curl或正常http请求时，就会偶发出现该问题。
故障定位 首先，梳理网络流程。服务器在访问公网地址时，会经过nat网关转换到公网的地址，然后再去访问目标地址。
其次，分别在服务器，nat服务器，目标服务器通过tcpdump抓包。通过分析出现问题时的数据包发现，服务器，nat服务器都是只有发送的syn包，而没有收到目标服务返回的ack确认包。由于没有收到ack确认包，服务器一直重试发送syn包。
最后，通过调研内核参数，发现参数net.ipv4.tcp_timestamps用来校验同源公网Ip的时间戳。经过nat之后，如果前面相同的端口被使用过，且时间戳大于这个链接发出的syn中的时间戳，服务器上就会忽略掉这个syn，不返会syn-ack消息，表现为用户无法正常完成tcp 3次握手，导致连接超时或无响应。 在业务闲时，如果用户nat的端口没有被使用过时，就可以正常打开；业务忙时，nat端口重复使用的频率高，很难分到没有被使用的端口，从而产生这种问题。 解决方案 net.ipv4.tcp_timestamps 默认值为1，即开启时间戳的校验。并且只有客户端服务和服务端都开启时，才会出现该问题。
于是，将服务端的net.ipv4.tcp_timestamps设置为0后，解决该问题。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5fb1348126af08f3c83554b134f7f1d9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-06T14:31:55+08:00" />
<meta property="article:modified_time" content="2020-05-06T14:31:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">线上个别机器访问公网地址时出现tcp请求超时或无响应处理方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h6>问题描述：</h6> 
<p>线上环境有多个实例，分别在不同的机房。正常情况下没问题，但每当同机房下，添加新的实例服务器后，在这台新的实例上就会偶发出现请求超时或无响应的情况。并发量越大，出现的概率越高。ping正常。curl或正常http请求时，就会偶发出现该问题。</p> 
<h6>故障定位</h6> 
<p>首先，梳理网络流程。服务器在访问公网地址时，会经过nat网关转换到公网的地址，然后再去访问目标地址。</p> 
<p>其次，分别在服务器，nat服务器，目标服务器通过tcpdump抓包。通过分析出现问题时的数据包发现，服务器，nat服务器都是只有发送的syn包，而没有收到目标服务返回的ack确认包。由于没有收到ack确认包，服务器一直重试发送syn包。</p> 
<p>最后，通过调研内核参数，发现参数net.ipv4.tcp_timestamps用来校验同源公网Ip的时间戳。经过nat之后，如果前面相同的端口被使用过，且时间戳大于这个链接发出的syn中的时间戳，服务器上就会忽略掉这个syn，不返会syn-ack消息，表现为用户无法正常完成tcp 3次握手，导致连接超时或无响应。 <br> 在业务闲时，如果用户nat的端口没有被使用过时，就可以正常打开；业务忙时，nat端口重复使用的频率高，很难分到没有被使用的端口，从而产生这种问题。 </p> 
<h6>解决方案</h6> 
<p></p> 
<p>net.ipv4.tcp_timestamps 默认值为1，即开启时间戳的校验。并且只有客户端服务和服务端都开启时，才会出现该问题。</p> 
<p>于是，将服务端的net.ipv4.tcp_timestamps设置为0后，解决该问题。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fe39d1d995e2c6f667d59d4231b013c3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">浙大PTA 7-4 列出叶结点 (20point(s))</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6eb996549524b44f8b5b73059ef05a71/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IEEE接收之后上传latex论文和eps图片</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>