<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>解决使用FastJson将Redis中的对象进行反序列化时出现报错的问题 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="解决使用FastJson将Redis中的对象进行反序列化时出现报错的问题" />
<meta property="og:description" content="目录
一、问题的引入
二、问题的思考过程 三、问题的解决
四、总结
1、问题引入
在我学习springsecurity框架时，发现了这么一个报错，如下图所示：
报错信息很明显，大概意思就是UserLogin这种类型不支持反序列化，通过debug也很明显的知道是从Redis中将对象反序列出来时，出现了问题，因为无法执行到59行（这里浅说一下debug小技巧：这其实也是一种很好的排错手段，通过在一个区域内设置多个断点，逐次跳跃断点，当到某一个断点就已经出现报错了，就明白，错误区间一定是上一个好的断点到最后这个断点之间，另外如果是想快速跳跃到某段代码，可以采用打多个断点的方式，即使是相邻行的代码，也可以打上多个断点，因为你一行一行的执行时，可能还会深入源码，而这样的话就能真正的依次执行我们的代码了）。
二、问题的思考过程
既然这里很明确的告诉我是反序列化出现了问题，那么我就着重于序列化这里，既然我这又是从Redis中获取对象时出了问题，那么问题可能就出现在Redis的序列化配置上面，由于这个Redis序列化配置我也是第一次接触，还是看网课视频才了解到的，这些配置也是cv了老师的代码，所以也没怎么多想，后面是我实在没办法了，询问网上的大佬，才发现我的配置确实是有一点问题的，缺失了一点配置。
三、问题的解决 其实啊，仔细比对老师和网友的代码就可以发现，老师的代码其实是缺少ObjectMapper的配置的，而Object Mapper就是Jackson对象映射器(Object Mapper)可以把JSON解析为用户自定义类对象, 或者解析为JSON内置的树模型的对象，简单来说就是Jackson提供的一个类，用于转换json与Java对象的，所以在我的代码中，正是缺少了这一配置，因此无法进行反序列化，补上Object Mapper配置即可，附上之前的代码，以及加上Object Mapper配置的代码如下：
序列化器FastJsonJsonRedisSerializer的配置： 之前的：
public class FastJsonRedisSerializer&lt;T&gt; implements RedisSerializer&lt;T&gt; { public static final Charset DEFAULT_CHARSET = Charset.forName(&#34;UTF-8&#34;); private Class&lt;T&gt; clazz; static { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); } public FastJsonRedisSerializer(Class&lt;T&gt; clazz) { super(); this.clazz = clazz; } @Override public byte[] serialize(T t) throws SerializationException { if (t == null) { return new byte[0]; } return JSON.toJSONString(t, SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET); } @Override public T deserialize(byte[] bytes) throws SerializationException { if (bytes == null || bytes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a1372506697f75754bab42d49fccca16/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-30T01:31:38+08:00" />
<meta property="article:modified_time" content="2023-03-30T01:31:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">解决使用FastJson将Redis中的对象进行反序列化时出现报错的问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%C2%A0%E6%A0%87%E9%A2%98%E4%B8%80%EF%BC%9A%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5-toc" style="margin-left:80px;"><a href="#%C2%A0%E6%A0%87%E9%A2%98%E4%B8%80%EF%BC%9A%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5" rel="nofollow">一、问题的引入</a></p> 
<p id="%E4%BA%8C%E3%80%81%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%80%83%E8%BF%87%E7%A8%8B-toc" style="margin-left:80px;"><a href="#%E4%BA%8C%E3%80%81%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%80%83%E8%BF%87%E7%A8%8B" rel="nofollow">二、问题的思考过程</a> </p> 
<p id="%E4%B8%89%E3%80%81%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3-toc" style="margin-left:80px;"><a href="#%E4%B8%89%E3%80%81%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3" rel="nofollow">三、问题的解决</a></p> 
<p id="%E5%9B%9B%E3%80%81%E6%80%BB%E7%BB%93-toc" style="margin-left:80px;"><a href="#%E5%9B%9B%E3%80%81%E6%80%BB%E7%BB%93" rel="nofollow">四、总结</a></p> 
<hr id="hr-toc"> 
<p></p> 
<blockquote> 
 <p><span style="color:#fe2c24;"><span style="background-color:#ffd900;">1、问题引入</span></span></p> 
</blockquote> 
<p>在我学习springsecurity框架时，发现了这么一个报错，如下图所示：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/87/b2/BcVM3os2_o.png"></p> 
<p> 报错信息很明显，大概意思就是UserLogin这种类型不支持反序列化，通过debug也很明显的知道是从Redis中将对象反序列出来时，出现了问题，因为无法执行到59行（<span style="color:#fe2c24;"><s>这里浅说一下debug小技巧</s>：</span><span style="color:#a2e043;">这其实也是一种很好的排错手段，通过在一个区域内设置多个断点，逐次跳跃断点，当到某一个断点就已经出现报错了，就明白，错误区间一定是上一个好的断点到最后这个断点之间，另外如果是想快速跳跃到某段代码，可以采用打多个断点的方式，即使是相邻行的代码，也可以打上多个断点，因为你一行一行的执行时，可能还会深入源码，而这样的话就能真正的依次执行我们的代码了</span>）。</p> 
<blockquote> 
 <p><span style="color:#fe2c24;"><span style="background-color:#ffd900;">二、问题的思考过程</span></span></p> 
</blockquote> 
<p>既然这里很明确的告诉我是反序列化出现了问题，那么我就着重于序列化这里，既然我这又是从Redis中获取对象时出了问题，那么问题可能就出现在Redis的序列化配置上面，由于这个Redis序列化配置我也是第一次接触，还是看网课视频才了解到的，这些配置也是cv了老师的代码，所以也没怎么多想，后面是我实在没办法了，询问网上的大佬，才发现我的配置确实是有一点问题的，缺失了一点配置。</p> 
<blockquote> 
 <p><span style="color:#fe2c24;"><span style="background-color:#ffd900;">三、问题的解决 </span></span></p> 
</blockquote> 
<p>其实啊，仔细比对老师和网友的代码就可以发现，老师的代码其实是缺少ObjectMapper的配置的，而Object Mapper就是<code>Jackson对象映射器(Object Mapper)</code>可以把JSON解析为用户自定义类对象, 或者解析为JSON内置的树模型的对象，简单来说就是Jackson提供的一个类，用于转换json与Java对象的，所以在我的代码中，正是缺少了这一配置，因此无法进行反序列化，补上Object Mapper配置即可，附上之前的代码，以及加上Object Mapper配置的代码如下：</p> 
<pre><strong><span style="color:#fe2c24;">序列化器FastJsonJsonRedisSerializer的配置：</span></strong></pre> 
<p>之前的：</p> 
<pre><code class="language-java">public class FastJsonRedisSerializer&lt;T&gt; implements RedisSerializer&lt;T&gt;
{

    public static final Charset DEFAULT_CHARSET = Charset.forName("UTF-8");

    private Class&lt;T&gt; clazz;

    static
    {
        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
    }

    public FastJsonRedisSerializer(Class&lt;T&gt; clazz)
    {
        super();
        this.clazz = clazz;
    }

    @Override
    public byte[] serialize(T t) throws SerializationException
    {
        if (t == null)
        {
            return new byte[0];
        }
        return JSON.toJSONString(t, SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);
    }

    @Override
    public T deserialize(byte[] bytes) throws SerializationException
    {
        if (bytes == null || bytes.length &lt;= 0)
        {
            return null;
        }
        String str = new String(bytes, DEFAULT_CHARSET);

        return JSON.parseObject(str, clazz);
    }


    protected JavaType getJavaType(Class&lt;?&gt; clazz)
    {
        return TypeFactory.defaultInstance().constructType(clazz);
    }
}</code></pre> 
<p>之后的：</p> 
<pre><code class="language-java">public class FastJson2JsonRedisSerializer&lt;T&gt; implements RedisSerializer&lt;T&gt;
{
    @SuppressWarnings("unused")
    private ObjectMapper objectMapper = new ObjectMapper();

    public static final Charset DEFAULT_CHARSET = Charset.forName("UTF-8");

    private Class&lt;T&gt; clazz;

    static
    {
        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
    }

    public FastJson2JsonRedisSerializer(Class&lt;T&gt; clazz)
    {
        super();
        this.clazz = clazz;
    }

    @Override
    public byte[] serialize(T t) throws SerializationException
    {
        if (t == null)
        {
            return new byte[0];
        }
        return JSON.toJSONString(t, SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);
    }

    @Override
    public T deserialize(byte[] bytes) throws SerializationException
    {
        if (bytes == null || bytes.length &lt;= 0)
        {
            return null;
        }
        String str = new String(bytes, DEFAULT_CHARSET);

        return JSON.parseObject(str, clazz);
    }

    public void setObjectMapper(ObjectMapper objectMapper)
    {
        Assert.notNull(objectMapper, "'objectMapper' must not be null");
        this.objectMapper = objectMapper;
    }

    protected JavaType getJavaType(Class&lt;?&gt; clazz)
    {
        return TypeFactory.defaultInstance().constructType(clazz);
    }
}</code></pre> 
<p><u><span style="color:#fe2c24;">唯一的变化就是之后加上了这个：</span></u></p> 
<pre><code class="language-java">  public void setObjectMapper(ObjectMapper objectMapper)
    {
        Assert.notNull(objectMapper, "'objectMapper' must not be null");
        this.objectMapper = objectMapper;
    }</code></pre> 
<p><span style="color:#fe2c24;">Redis配置类：</span></p> 
<p>之前的：</p> 
<pre><code class="language-java">    @Bean
    @SuppressWarnings(value = { "unchecked", "rawtypes" })
    public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory connectionFactory)
    {
        RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;();
        template.setConnectionFactory(connectionFactory);

        FastJsonRedisSerializer serializer = new FastJsonRedisSerializer(Object.class);
//        FastJsonRedisSerializer&lt;Object&gt; serializer = new FastJsonRedisSerializer&lt;&gt;(Object.class);
        // 使用StringRedisSerializer来序列化和反序列化redis的key值
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);

        // Hash的key也采用StringRedisSerializer的序列化方式
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);

        template.afterPropertiesSet();
        return template;
    }</code></pre> 
<p>之后的：</p> 
<pre><code class="language-java">@Bean
        @SuppressWarnings(value = { "unchecked", "rawtypes" })
        public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory connectionFactory)
        {
            RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;();
            template.setConnectionFactory(connectionFactory);

            FastJson2JsonRedisSerializer serializer = new FastJson2JsonRedisSerializer(Object.class);

            ObjectMapper mapper = new ObjectMapper();
            mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
            mapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);
            serializer.setObjectMapper(mapper);

            // 使用StringRedisSerializer来序列化和反序列化redis的key值
            template.setKeySerializer(new StringRedisSerializer());
            template.setValueSerializer(serializer);

            // Hash的key也采用StringRedisSerializer的序列化方式
            template.setHashKeySerializer(new StringRedisSerializer());
            template.setHashValueSerializer(serializer);

            template.afterPropertiesSet();
            return template;
        }</code></pre> 
<p><u><span style="color:#fe2c24;">其实无非也就是在原有的基础上增加了这部分代码：</span></u></p> 
<pre><code class="language-java">     ObjectMapper mapper = new ObjectMapper();
            mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
            mapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);
            serializer.setObjectMapper(mapper);</code></pre> 
<p>对这两个类添加上对应的object mapper配置之后程序就能正常运行了。</p> 
<blockquote> 
 <p><span style="color:#fe2c24;"><span style="background-color:#ffd900;">四、总结：</span></span></p> 
</blockquote> 
<p>一、技巧方面：</p> 
<p>1.当你cv老师的代码，结果还是出现报错时，不要一味的相信老师，老师也许也可能有错，在这里，我就是犯了这个错误，老是很困惑，为什么我和老师的代码就是一样的，为什么老师没问题，而我却出现报错，所以说勇敢的质疑吧！</p> 
<p>2.当出现错误时，尽可能的采用debug这一强大工具来排错，掌握debug技巧，在本次排错中，学会了使用打连续断点的方式来解决debug无法一行一行执行我自己写的代码，而去深层执行源码的问题</p> 
<p>3.当遇到问题时，善于从网上找答案，实在找不到解决方案时，在向网友寻求帮助</p> 
<p>二、知识方面：</p> 
<p>就一点，那就是知道使用FastJson框架对Redis中数据进行序列化与反序列化操作时，出现报错时，可能是未配置object mapper的缘故，只需在<strong><span style="color:#fe2c24;">序列化器FastJsonJsonRedisSerializer和</span></strong><span style="color:#fe2c24;">Redis配置类</span><span style="color:#0d0016;">添加上对应的配置即可</span></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6a64c93292f5beea5f5c04a5436fc9b1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java类的继承</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/91bc2d64eedc8bb0f772ba629223596a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ajax异步请求，获取本地json数据</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>