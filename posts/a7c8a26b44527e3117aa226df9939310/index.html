<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hive中的炸裂、窗口函数及示例 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Hive中的炸裂、窗口函数及示例" />
<meta property="og:description" content="一、炸裂函数 针对一行数据，输出多行数据，主要用于map，array这种的
根据一个例子来看：
friends 是一个array数组students 是一个mapaddress是一个struct 1）explode函数 explode函数以array类型数据输入，然后对数组中的数据进行迭代，返回多行结果，一行一个数组元素值。
作用于array：
arrayCol ：array字段的名称colName1 ：array字段的别名，随便起 -- 语法是这样 select explode(arrayCol) as colName1 from tablename 举例：
select explode(friends) from teacher 作用于map：
mapcol ：map字段名称key1：key的别名 随便起value1：value的别名 随便起 select explode(mapcol) as (key1,value1) from tablename; 举例：
select explode(students) from teacher 2）posexplode函数 相对于 返回多行结果，一行一个数组元素值。会返回元素在集合中的位置
区别：
posexplode只能用于array，而explode可以用于array，mapposexplode还会返回元素在集合中的位置 select posexplode(friends) from teacher 3）Lateral View 通常与UDTF配合使用，Lateral View可以将UDTF应用到源表的每行数据，将每行数据转换为一行或者多行，并将源表中每行的输出结果与该行连接起来，形成一个虚拟表。
那么，解决的问题到底是什么？
也不用Lateral View ，返回的字段也只能是炸裂的字段，不能进行其他任何操作
sql语法：
⚠️lateral view 一定要在udtf函数的前面⚠️虚拟表别名一定要加，不然会报错 select [col1,col2,col3……] from 表名 lateral view udtf(expression) 虚拟表别名 举例：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a7c8a26b44527e3117aa226df9939310/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-24T20:07:47+08:00" />
<meta property="article:modified_time" content="2022-12-24T20:07:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hive中的炸裂、窗口函数及示例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>一、炸裂函数</h2> 
<h4><a id="_1"></a></h4> 
<blockquote> 
 <p><strong>针对一行数据，输出多行数据</strong>，主要用于<strong>map，array</strong>这种的</p> 
</blockquote> 
<p>根据一个例子来看：</p> 
<ul><li>friends 是一个array数组</li><li>students 是一个map</li><li>address是一个struct</li></ul> 
<p><img src="https://images2.imgbox.com/f3/82/DD0itkmu_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1explode_14"></a><strong>1）explode函数</strong></h3> 
<blockquote> 
 <p>explode函数以array类型数据输入，然后对数组中的数据进行迭代，返回多行结果，一行一个数组元素值。</p> 
</blockquote> 
<p><strong>作用于array：</strong></p> 
<ul><li>arrayCol ：array字段的名称</li><li>colName1 ：array字段的别名，随便起</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">-- 语法是这样</span>
<span class="token keyword">select</span> explode<span class="token punctuation">(</span>arrayCol<span class="token punctuation">)</span> <span class="token keyword">as</span> colName1 <span class="token keyword">from</span> tablename
</code></pre> 
<p>举例：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> explode<span class="token punctuation">(</span>friends<span class="token punctuation">)</span> <span class="token keyword">from</span> teacher
</code></pre> 
<center> 
 <img src="https://images2.imgbox.com/3f/c0/uKn6bjHB_o.png" width="50%"> 
</center> 
<p><strong>作用于map：</strong></p> 
<ul><li>mapcol ：map字段名称</li><li>key1：key的别名 随便起</li><li>value1：value的别名 随便起</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> explode<span class="token punctuation">(</span>mapcol<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>key1<span class="token punctuation">,</span>value1<span class="token punctuation">)</span> <span class="token keyword">from</span> tablename<span class="token punctuation">;</span>
</code></pre> 
<p><strong>举例：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> explode<span class="token punctuation">(</span>students<span class="token punctuation">)</span>  <span class="token keyword">from</span> teacher 
</code></pre> 
<center> 
 <img src="https://images2.imgbox.com/6f/92/JHq2qtc7_o.png" width="50%"> 
</center> 
<h3><a id="2posexplode_56"></a><strong>2）posexplode函数</strong></h3> 
<blockquote> 
 <p>相对于 返回多行结果，一行一个数组元素值。<strong>会返回元素在集合中的位置</strong></p> 
 <p><strong>区别</strong>：</p> 
 <ul><li><strong>posexplode只能用于array，而explode可以用于array，map</strong></li><li><strong>posexplode还会返回元素在集合中的位置</strong></li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> posexplode<span class="token punctuation">(</span>friends<span class="token punctuation">)</span>  <span class="token keyword">from</span> teacher 
</code></pre> 
<center> 
 <img src="https://images2.imgbox.com/f1/2b/X1Pxmbb0_o.png" width="50%"> 
</center> 
<h3><a id="3Lateral_View_73"></a><strong>3）Lateral View</strong></h3> 
<blockquote> 
 <p>通常与UDTF配合使用，Lateral View可以将UDTF应用到源表的每行数据，将每行数据转换为一行或者多行，并将源表中每行的输出结果与该行连接起来，形成一个虚拟表。</p> 
 <p>那么，解决的问题到底是什么？</p> 
 <p><img src="https://images2.imgbox.com/49/5a/5fxfRxdP_o.png" alt="在这里插入图片描述"><br> <strong>也不用Lateral View ，返回的字段也只能是炸裂的字段，不能进行其他任何操作</strong></p> 
</blockquote> 
<p><strong>sql语法：</strong></p> 
<ul><li>⚠️lateral view 一定要在udtf函数的前面</li><li>⚠️虚拟表别名一定要加，不然会报错</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token punctuation">[</span>col1<span class="token punctuation">,</span>col2<span class="token punctuation">,</span>col3……<span class="token punctuation">]</span> <span class="token keyword">from</span> 表名 
lateral <span class="token keyword">view</span> udtf<span class="token punctuation">(</span>expression<span class="token punctuation">)</span> 虚拟表别名 

</code></pre> 
<p>举例：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> name<span class="token punctuation">,</span>friends<span class="token punctuation">,</span>address  <span class="token keyword">from</span> teacher lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>friends<span class="token punctuation">)</span> p1 
</code></pre> 
<p><img src="https://images2.imgbox.com/31/da/yLHykm3M_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4udtflateral_view_103"></a><strong>4）udtf+lateral view的举例：</strong></h3> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> movie_info<span class="token punctuation">(</span>
    movie string<span class="token punctuation">,</span>     <span class="token comment">--电影名称</span>
    category string   <span class="token comment">--电影分类</span>
<span class="token punctuation">)</span> 
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">"\t"</span><span class="token punctuation">;</span>


<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> movie_info
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">"《疑犯追踪》"</span><span class="token punctuation">,</span> <span class="token string">"悬疑,动作,科幻,剧情"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">"《Lie to me》"</span><span class="token punctuation">,</span> <span class="token string">"悬疑,警匪,动作,心理,剧情"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">"《战狼2》"</span><span class="token punctuation">,</span> <span class="token string">"战争,动作,灾难"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>先看原来的数据：</p> 
<center> 
 <img src="https://images2.imgbox.com/70/3b/kC6JU0eN_o.png" width="70%"> 
</center> 
<p>需求是：</p> 
<center> 
 <img src="https://images2.imgbox.com/a3/28/B8CkwIIO_o.png" width="20%"> 
</center> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> cate<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">from</span>
<span class="token punctuation">(</span> <span class="token keyword">select</span> movie<span class="token punctuation">,</span> cate <span class="token keyword">from</span>
 <span class="token punctuation">(</span><span class="token keyword">select</span> movie<span class="token punctuation">,</span>split<span class="token punctuation">(</span>category<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">)</span> cates <span class="token keyword">from</span> movie_info<span class="token punctuation">)</span>
 t1 lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>cates<span class="token punctuation">)</span> tmp <span class="token keyword">as</span> cate
<span class="token punctuation">)</span>t2
<span class="token keyword">group</span> <span class="token keyword">by</span> cate<span class="token punctuation">;</span>

</code></pre> 
<h2><a id="_142"></a>二、窗口函数</h2> 
<blockquote> 
 <p><strong>每行数据都能作为一个窗口，每个窗口都会进行范围的计算操作</strong>，并将计算结果返回当前行的一个新的字段。<br> 可以是聚合（sum max min）等等操作，也可以是其他函数操作。<br> ⭐️常用窗口可划分为如下几类：<strong>聚合函数、跨行取值函数、排名函数。</strong></p> 
 <center> 
  <img src="https://images2.imgbox.com/63/15/pwRu5Amz_o.png" width="70%"> 
 </center> 
 <p>举例：定义窗口函数<strong>基于行</strong>，使用聚合函数(sum)的，窗口的规则是字段A <strong>负无穷到当前行</strong>。计算过程是怎么样的？</p> 
 <p>首先对字段A从小到大进行排序。</p> 
 <p>1.按照排序后的一行一行作为窗口，从第一行开始，第一行的字段A最小，发现自己是最小的，那就当前行做为第一个窗口，计算结果只有本身，结果返回给第一行。</p> 
 <p>2.从第二行开始继续寻找，负无穷到当前行的，第二个窗口包含第一行、第二行数据，做范围内运算，sum=第一行的字段A+第二行的字段A，结果返回给第二行。</p> 
 <p>第三个窗口，包含第一行、第二行、第三行数据，那么计算sum=第一行字段A+第二行字段A+第三行字段A。</p> 
 <p>以此类推。。。。</p> 
 <p>最后一行的返回的计算结果一定是所有行字段A的总和</p> 
 <p>那这跟直接sql写sum（）+group by 有什么区别吗？</p> 
 <p><strong>⭐️区别在于，每行数据都会参与到计算中来，同时得到窗口计算的结果，我们直接写sql语句调用sum（）只会返回最终结果，相当于只有最后一个窗口的值。</strong></p> 
</blockquote> 
<h3><a id="1_between_and_170"></a>⭐️1）窗口规则 between and：</h3> 
<blockquote> 
 <p>between相当重要的原因是按照什么样的规则定义窗口。</p> 
</blockquote> 
<ul><li>unbounded preceding 表示负无穷</li><li><strong>current row 基于行的方式表示当前行，基于值的方式表示当前值</strong></li><li>unbounded following 表示正无穷</li><li>[num] preceding 基于行的方式 表示当前行的前几行，基于值的方式 表示当前值减去num</li><li>[num] following 基于值的方式 表示当前行的后几行，基于值的方式表示当前值加上num</li></ul> 
<p>⚠️ and 前后要注意sql的写法</p> 
<ul><li>如果前面写，current row，后面不允许写[num] preceding</li><li>如果使用基于值的方式，使用 preceding[num]或者[num] following，<strong>一定要保证划分窗口的字段属于数字类型</strong><img src="https://images2.imgbox.com/66/5c/YNP1OQXR_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="2_185"></a><strong>2）基于行</strong></h3> 
<p>举例：</p> 
<ul><li>between unbounded preceding and cureent now <strong>表示负无穷到当前行 做为一个窗口</strong></li><li>order_id为1的发现order_date 小于自己的没有，只有自己，所以第一个窗口只包含当前行</li><li>ordr_id为2的先查找，order_date小于等于当前行的，发现order_id为1的算一个，所以第二个窗口包含两行，是order_id为1的以及order_id为2的。 做窗口内的范围内运算（由于是sum，则相加）=20+10</li><li>ordr_id为3=10+20+10</li><li>以此类推。。。</li></ul> 
<center> 
 <img src="https://images2.imgbox.com/49/fd/u1Rx6uN9_o.png"> 
</center> 
<h3><a id="3_199"></a><strong>3）基于值</strong></h3> 
<blockquote> 
 <p><strong>跟基于行最大的区别是什么？</strong></p> 
 <blockquote> 
  <p><strong>between规则应用的不一样</strong></p> 
  <p>同样都是between unbounded preceding and cureent now</p> 
  <p><strong>基于行的含义是负无穷到当前行，而基于值的含义是负无穷到当前值</strong></p> 
  <p>也就说基于行 会以自己的行 为终点，<strong>但是基于值 会 查找某个字段 小于等于自己的，自己的行不一定是终点。</strong></p> 
 </blockquote> 
 <p>如下图所示：</p> 
 <p>order_id为1的查找order_date小于等于自己的，只有本身，total_amount为自己</p> 
 <p>order_id为2的查找order_date小于等于自己的，有order_id为1,order_id为2,order_id为3，total_amount为10+20+10</p> 
 <p>order_id为3的查找order_date小于等于自己的，有order_id为1,order_id为2,order_id为3，total_amount为10+20+10</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ca/5e/LBqfe70Q_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_228"></a><strong>4）分区：</strong></h3> 
<blockquote> 
 <p>如果不开分区，那么窗口的计数从整个数据的开始到结尾</p> 
 <p>如果开了分区，那么一个分区内窗口计数从分区头到分区尾</p> 
 <p><strong>说白了，第二个分区的实际数据即使在表的中间，也有可能属于第一个窗口</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/c3/2f/PK4DyxWD_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-QPCIFxTX-1671867534186)(image-20221223183034924.png)]"></p> 
<h3><a id="5_238"></a><strong>5）基本语法：</strong></h3> 
<h4><a id="_240"></a><strong>基于行的语法：</strong></h4> 
<ul><li> <p>字段1，字段2 不用说了，就是显示的字段</p> </li><li> <p>⭐️ sum(字段3) 是基于窗口做什么操作，这个表示是<strong>基于每个窗口对 sum3字段做求和操作</strong></p> </li><li> <p>⭐️ over()表示是什么样的窗口</p> <p>字段2：针对字段2进行划分窗口</p> <p>rows：表示基于行</p> <p>between unbounded preceding and current row：<strong>表示负无穷到最后一行</strong></p> </li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 字段<span class="token number">1</span>，字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>字段<span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span>字段<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 新字段<span class="token number">1</span> 
</code></pre> 
<h4><a id="_261"></a><strong>基于值的语法：</strong></h4> 
<ul><li>range：表示基于值</li><li>unbounded preceding and unbounded following: <strong>表示负无穷到正无穷</strong></li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 字段<span class="token number">1</span>，字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>字段<span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span>字段<span class="token number">2</span> range <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">unbounded</span> <span class="token keyword">following</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 新字段<span class="token number">1</span> 
</code></pre> 
<h4><a id="_273"></a><strong>加分区:</strong></h4> 
<blockquote> 
 <p>跟基于行 基于值没有关系</p> 
</blockquote> 
<ul><li>partition by 字段1 <strong>表示针对字段1做分区</strong></li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 字段<span class="token number">1</span>，字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>字段<span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 字段<span class="token number">1</span> 字段<span class="token number">2</span> range <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 新字段<span class="token number">1</span> 
</code></pre> 
<h3><a id="6_288"></a><strong>6）缺省下情况：</strong></h3> 
<ul><li>就什么都不加，over（字段）相当于 <strong>基于行做窗口，范围是负无穷到正无穷,相当于所有字段作为一个窗口</strong></li><li>over(order by 字段) 排序后<strong>基于值做窗口，范围是负无穷到当前行</strong></li><li>⭐️无论基于行还是基于值， <strong>不加order by，没有任何意义（因为你都不知道上一行和下一行的值有没有关联）,做范围内计算也是白瞎</strong></li></ul> 
<p><img src="https://images2.imgbox.com/d5/75/twApUJpQ_o.png" alt=""></p> 
<h3><a id="7_299"></a>7)聚合函数</h3> 
<blockquote> 
 <p>支持以下几种，不再多阐述<br> max<br> min<br> sum<br> avg<br> count</p> 
</blockquote> 
<h3><a id="8_308"></a><strong>8)跨行取值函数</strong></h3> 
<blockquote> 
 <p>分别包括：</p> 
 <p><strong>lag和lead(不支持自定义窗口)：</strong></p> 
 <ul><li> <p>lag(): 按照 所在行的偏移量 取 前面的第几行</p> </li><li> <p>lead(): 按照 所在行的偏移量 取 后面的第几行</p> </li></ul> 
 <p><strong>first_value和last_value(支持自定义窗口)：</strong></p> 
 <ul><li>first_value()：当前窗口内所有行数据中的最小值</li><li>last_value(): 当前窗口内所有行数据中的最大值</li></ul> 
 <p>⚠️要注意，lag和lead不能使用自定义窗口，因为已经规定好了具体某一行与当前行作为一个窗口，不能再定义是负无穷到正无穷这样自定义的规则。</p> 
</blockquote> 
<p><strong>lag和lead：</strong></p> 
<p><strong>语法：</strong></p> 
<ul><li> <p>lag() :</p> 
  <ul><li> <p>字段3：结果字段</p> </li><li> <p>1: 取当前行前面的前1行</p> </li><li> <p>‘1970-01-01’：当前所在行数取不够前面的行，取默认行（比如取前5行，但是当前行数是第四行，就取值为(‘1970-01-01’）的所在行</p> </li></ul> </li><li> <p>lead :</p> <p>同上</p> </li></ul> 
<p><strong>语法如下：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 字段<span class="token number">1</span>，字段<span class="token number">2</span>，字段<span class="token number">3</span>
lag<span class="token punctuation">(</span>字段<span class="token number">3</span>，向前的具体行数，<span class="token string">'默认值'</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> 别名<span class="token number">1</span><span class="token punctuation">,</span>
lead<span class="token punctuation">(</span>字段<span class="token number">3</span>，向后的具体行数，<span class="token string">'默认值'</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> 别名<span class="token number">2</span><span class="token punctuation">,</span>
<span class="token keyword">from</span> <span class="token keyword">table</span>

</code></pre> 
<p><strong>举例：</strong></p> 
<ul><li> <p>现在要获取当前订单的上一个订单的时间跟下一个订单的时间（统计一下时间间隔）</p> </li><li> <p>可以看到，lag根据order_date做一个跨行，先按照时间排序(over order by )后</p> <p>取前面的一行，跟后面的一行，分别做为last_date 和 next_date 字段<br> <img src="https://images2.imgbox.com/66/04/gXUyw1To_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<p><strong>first_value和last_value：</strong></p> 
<p>语法：</p> 
<ul><li>first_value(字段3,FALSE) 字段3表示具体取哪个字段的值，false表示允许null的值作为结果，如果窗口内某一行是null值，结果就是null</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 字段<span class="token number">1</span>，字段<span class="token number">2</span>，字段<span class="token number">3</span>
first_value<span class="token punctuation">(</span>字段<span class="token number">3</span><span class="token punctuation">,</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 字段<span class="token number">3</span><span class="token punctuation">)</span> last_date<span class="token punctuation">,</span>
last_value<span class="token punctuation">(</span>字段<span class="token number">3</span><span class="token punctuation">,</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 字段<span class="token number">3</span><span class="token punctuation">)</span> next_date
<span class="token keyword">from</span> table_name
</code></pre> 
<p>举例：</p> 
<ul><li>获取每个用户订单的最早的下单时间(first_date)<br> 那么就可以先以用户id分区，如下的user_id的就包含三个窗口，每个窗口最小值就是2022-01-01，所以得出user_id所有的订单中最早的日期是2022-01-01<br> <img src="https://images2.imgbox.com/ff/c4/hF87rinu_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="9_382"></a>9)排名函数</h3> 
<blockquote> 
 <p>rank（） 对某个值做个排名</p> 
 <p>dense_rank() <strong>如果相同的值，给一样的名次</strong></p> 
 <p>row_number() <strong>如果相同的值，按照插入表的顺序分名次</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/98/f6/WXD5QI1g_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_393"></a>三、综合案例</h2> 
<h3><a id="1_394"></a><strong>1.数据准备</strong></h3> 
<p><strong>1）表结构</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td></tr><tr><td><strong>2</strong></td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td></tr><tr><td><strong>3</strong></td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td></tr><tr><td><strong>4</strong></td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td></tr><tr><td><strong>5</strong></td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td></tr></tbody></table> 
<p><strong>2）建表语句</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> order_info
<span class="token punctuation">(</span>
  order_id   string<span class="token punctuation">,</span> <span class="token comment">--订单id</span>
  user_id   string<span class="token punctuation">,</span> <span class="token comment">-- 用户id</span>
  user_name  string<span class="token punctuation">,</span> <span class="token comment">-- 用户姓名</span>
  order_date  string<span class="token punctuation">,</span> <span class="token comment">-- 下单日期</span>
  order_amount <span class="token keyword">int</span>   <span class="token comment">-- 订单金额</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> order_info

<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'1001'</span><span class="token punctuation">,</span> <span class="token string">'小元'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-01'</span><span class="token punctuation">,</span> <span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'1002'</span><span class="token punctuation">,</span> <span class="token string">'小海'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-02'</span><span class="token punctuation">,</span> <span class="token string">'15'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'1001'</span><span class="token punctuation">,</span> <span class="token string">'小元'</span><span class="token punctuation">,</span> <span class="token string">'2022-02-03'</span><span class="token punctuation">,</span> <span class="token string">'23'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'1002'</span><span class="token punctuation">,</span> <span class="token string">'小海'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-04'</span><span class="token punctuation">,</span> <span class="token string">'29'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'1001'</span><span class="token punctuation">,</span> <span class="token string">'小元'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-05'</span><span class="token punctuation">,</span> <span class="token string">'46'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'1001'</span><span class="token punctuation">,</span> <span class="token string">'小元'</span><span class="token punctuation">,</span> <span class="token string">'2022-04-06'</span><span class="token punctuation">,</span> <span class="token string">'42'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'1002'</span><span class="token punctuation">,</span> <span class="token string">'小海'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-07'</span><span class="token punctuation">,</span> <span class="token string">'50'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">,</span> <span class="token string">'1001'</span><span class="token punctuation">,</span> <span class="token string">'小元'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-08'</span><span class="token punctuation">,</span> <span class="token string">'50'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">,</span> <span class="token string">'1003'</span><span class="token punctuation">,</span> <span class="token string">'小辉'</span><span class="token punctuation">,</span> <span class="token string">'2022-04-08'</span><span class="token punctuation">,</span> <span class="token string">'62'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span> <span class="token string">'1003'</span><span class="token punctuation">,</span> <span class="token string">'小辉'</span><span class="token punctuation">,</span> <span class="token string">'2022-04-09'</span><span class="token punctuation">,</span> <span class="token string">'62'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">,</span> <span class="token string">'1004'</span><span class="token punctuation">,</span> <span class="token string">'小猛'</span><span class="token punctuation">,</span> <span class="token string">'2022-05-10'</span><span class="token punctuation">,</span> <span class="token string">'12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token string">'1003'</span><span class="token punctuation">,</span> <span class="token string">'小辉'</span><span class="token punctuation">,</span> <span class="token string">'2022-04-11'</span><span class="token punctuation">,</span> <span class="token string">'75'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'13'</span><span class="token punctuation">,</span> <span class="token string">'1004'</span><span class="token punctuation">,</span> <span class="token string">'小猛'</span><span class="token punctuation">,</span> <span class="token string">'2022-06-12'</span><span class="token punctuation">,</span> <span class="token string">'80'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'14'</span><span class="token punctuation">,</span> <span class="token string">'1003'</span><span class="token punctuation">,</span> <span class="token string">'小辉'</span><span class="token punctuation">,</span> <span class="token string">'2022-04-13'</span><span class="token punctuation">,</span> <span class="token string">'94'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="2__437"></a><strong>2.</strong> <strong>需求</strong></h3> 
<p><strong>1）统计每个用户截至每次下单的累积下单总额</strong></p> 
<p>期望结果：</p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>sum_so_far</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>10</td></tr><tr><td><strong>5</strong></td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>56</td></tr><tr><td><strong>8</strong></td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>106</td></tr><tr><td><strong>3</strong></td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>129</td></tr><tr><td><strong>6</strong></td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>171</td></tr><tr><td><strong>2</strong></td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>15</td></tr><tr><td><strong>4</strong></td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>44</td></tr><tr><td><strong>7</strong></td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>94</td></tr><tr><td><strong>9</strong></td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>62</td></tr><tr><td><strong>10</strong></td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>124</td></tr><tr><td><strong>12</strong></td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>199</td></tr><tr><td><strong>14</strong></td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>293</td></tr><tr><td><strong>11</strong></td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>12</td></tr><tr><td><strong>13</strong></td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>92</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> order_id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span>order_date<span class="token punctuation">,</span>order_amount<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span> 
<span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> order_date 
     <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> sum_so_far

<span class="token keyword">from</span> order_info<span class="token punctuation">;</span>
</code></pre> 
<p><strong>2）统计每个用户截至每次下单的当月累积下单总额</strong></p> 
<p><strong>(1)期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>sum_so_far</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>10</td></tr><tr><td><strong>5</strong></td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>56</td></tr><tr><td><strong>8</strong></td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>106</td></tr><tr><td><strong>3</strong></td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>23</td></tr><tr><td><strong>6</strong></td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>42</td></tr><tr><td><strong>2</strong></td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>15</td></tr><tr><td><strong>4</strong></td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>44</td></tr><tr><td><strong>7</strong></td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>94</td></tr><tr><td><strong>9</strong></td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>62</td></tr><tr><td><strong>10</strong></td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>124</td></tr><tr><td><strong>12</strong></td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>199</td></tr><tr><td><strong>14</strong></td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>293</td></tr><tr><td><strong>11</strong></td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>12</td></tr><tr><td><strong>13</strong></td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>80</td></tr></tbody></table> 
<p><strong>(2)需求实现</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span>
   order_id<span class="token punctuation">,</span>
   user_id<span class="token punctuation">,</span>
   user_name<span class="token punctuation">,</span>
   order_date<span class="token punctuation">,</span>
   order_amount<span class="token punctuation">,</span>
   <span class="token function">sum</span><span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>substring<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> order_date <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> sum_so_far
 <span class="token keyword">from</span> order_info<span class="token punctuation">;</span>
</code></pre> 
<p><strong>3）统计每个用户每次下单距离上次下单相隔的天数（首次下单按0天算）</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>diff</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>0</td></tr><tr><td><strong>5</strong></td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>4</td></tr><tr><td><strong>8</strong></td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>3</td></tr><tr><td><strong>3</strong></td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>26</td></tr><tr><td><strong>6</strong></td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>62</td></tr><tr><td><strong>2</strong></td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>0</td></tr><tr><td><strong>4</strong></td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>2</td></tr><tr><td><strong>7</strong></td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>3</td></tr><tr><td><strong>9</strong></td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>0</td></tr><tr><td><strong>10</strong></td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>1</td></tr><tr><td><strong>12</strong></td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>2</td></tr><tr><td><strong>14</strong></td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>2</td></tr><tr><td><strong>11</strong></td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>0</td></tr><tr><td><strong>13</strong></td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>33</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> order_id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>user_name<span class="token punctuation">,</span>order_date<span class="token punctuation">,</span>order_amount<span class="token punctuation">,</span>
 nvl<span class="token punctuation">(</span>datediff<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span>last_order_date<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> diff
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
  <span class="token keyword">select</span> order_id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span>order_date<span class="token punctuation">,</span> order_amount<span class="token punctuation">,</span>
lag<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> order_date<span class="token punctuation">)</span> last_order_date
  <span class="token keyword">from</span> order_info
<span class="token punctuation">)</span>t1
</code></pre> 
<p><strong>4）查询所有下单记录以及每个用户的每个下单记录所在月份的首末次下单日期</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>first_date</th><th>last_date</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>2022-01-01</td><td>2022-01-08</td></tr><tr><td><strong>5</strong></td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>2022-01-01</td><td>2022-01-08</td></tr><tr><td><strong>8</strong></td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>2022-01-01</td><td>2022-01-08</td></tr><tr><td><strong>3</strong></td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>2022-02-03</td><td>2022-02-03</td></tr><tr><td><strong>6</strong></td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>2022-04-06</td><td>2022-04-06</td></tr><tr><td><strong>2</strong></td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>2022-01-02</td><td>2022-01-07</td></tr><tr><td><strong>4</strong></td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>2022-01-02</td><td>2022-01-07</td></tr><tr><td><strong>7</strong></td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>2022-01-02</td><td>2022-01-07</td></tr><tr><td><strong>9</strong></td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>2022-04-08</td><td>2022-04-13</td></tr><tr><td><strong>10</strong></td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>2022-04-08</td><td>2022-04-13</td></tr><tr><td><strong>12</strong></td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>2022-04-08</td><td>2022-04-13</td></tr><tr><td><strong>14</strong></td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>2022-04-08</td><td>2022-04-13</td></tr><tr><td><strong>11</strong></td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>2022-05-10</td><td>2022-05-10</td></tr><tr><td><strong>13</strong></td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>2022-06-12</td><td>2022-06-12</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> order_id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>user_name<span class="token punctuation">,</span>order_date<span class="token punctuation">,</span>order_amount<span class="token punctuation">,</span>
first_value<span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>substring<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> order_date<span class="token punctuation">)</span> first_date<span class="token punctuation">,</span>
last_value<span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>substring<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> order_date <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">unbounded</span> <span class="token keyword">following</span><span class="token punctuation">)</span> last_date
<span class="token keyword">from</span> order_info<span class="token punctuation">;</span>
</code></pre> 
<p><strong>5）为每个用户的所有下单记录按照订单金额进行排名</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>rk</th><th>drk</th><th>rn</th></tr></thead><tbody><tr><td><strong>8</strong></td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>1</td><td>1</td><td>1</td></tr><tr><td><strong>5</strong></td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>2</td><td>2</td><td>2</td></tr><tr><td><strong>6</strong></td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>3</td><td>3</td><td>3</td></tr><tr><td><strong>3</strong></td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>4</td><td>4</td><td>4</td></tr><tr><td><strong>1</strong></td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>5</td><td>5</td><td>5</td></tr><tr><td><strong>7</strong></td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>1</td><td>1</td><td>1</td></tr><tr><td><strong>4</strong></td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>2</td><td>2</td><td>2</td></tr><tr><td><strong>2</strong></td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>3</td><td>3</td><td>3</td></tr><tr><td><strong>14</strong></td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>1</td><td>1</td><td>1</td></tr><tr><td><strong>12</strong></td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>2</td><td>2</td><td>2</td></tr><tr><td><strong>9</strong></td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>3</td><td>3</td><td>3</td></tr><tr><td><strong>10</strong></td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>3</td><td>3</td><td>4</td></tr><tr><td><strong>13</strong></td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>1</td><td>1</td><td>1</td></tr><tr><td><strong>11</strong></td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>2</td><td>2</td><td>2</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> order_id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>user_name<span class="token punctuation">,</span>order_date<span class="token punctuation">,</span>order_amount<span class="token punctuation">,</span>
   rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> order_amount <span class="token keyword">desc</span><span class="token punctuation">)</span> rk<span class="token punctuation">,</span>
   dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> order_amount <span class="token keyword">desc</span><span class="token punctuation">)</span> drk<span class="token punctuation">,</span>
   row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> order_amount <span class="token keyword">desc</span><span class="token punctuation">)</span> rn
 <span class="token keyword">from</span> order_info<span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/767e718b20ad93dcfd4783167d879253/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">操作系统：文件管理和磁盘存储器管理 期末练习题（附有答案和解析）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b972fc6157c9333eb6151fa7dfc3762f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java复习笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>