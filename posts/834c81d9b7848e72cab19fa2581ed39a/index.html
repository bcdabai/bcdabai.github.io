<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>6.830 / 6.814: Syllabus 2021 - MIT Lab 2 - SimpleDB Operators - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="6.830 / 6.814: Syllabus 2021 - MIT Lab 2 - SimpleDB Operators" />
<meta property="og:description" content="文章目录 1.参考链接：2.SimpleDB Architecture and Implementation Guide2.1Filter and Join2.2 Aggregates2.3HeapFile Mutability2.4. Insertion and deletion2.5. Page eviction 在此实验中，您将为SimpleDB编写一组运算符，以实现表修改（例如，插入和删除记录），选择，连接和聚合。 这些将构建在实验1中写入的基础之上，为您提供一个可以在多个表上执行简单查询的数据库系统。
此外，我们忽略了实验中的缓冲池管理问题：我们没有处理引用多个页面时出现的问题。 在Lab 2中，您将设计一个驱动策略来从缓冲池中刷新陈旧页面。
您无需在此实验中实现事务或锁定。
1.参考链接： 1.1 课程链接：http://db.lcs.mit.edu/6.830/assign.php
1.2 lab2链接：https://github.com/MIT-DB-Class/simple-db-hw-2021/blob/master/lab2.md
1.3 HearmingBear Lab2链接：https://blog.csdn.net/hjw199666/article/details/103590963
1.4 我的仓库地址：https://gitee.com/zhou-zhiqiang/db-class
2.SimpleDB Architecture and Implementation Guide 2.1Filter and Join Filter: This operator only returns tuples that satisfy a Predicate that is specified as part of its constructor. Hence, it filters out any tuples that do not match the predicate." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/834c81d9b7848e72cab19fa2581ed39a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-09T17:54:08+08:00" />
<meta property="article:modified_time" content="2021-07-09T17:54:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">6.830 / 6.814: Syllabus 2021 - MIT Lab 2 - SimpleDB Operators</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#1_8" rel="nofollow">1.参考链接：</a></li><li><a href="#2SimpleDB_Architecture_and_Implementation_Guide_14" rel="nofollow">2.SimpleDB Architecture and Implementation Guide</a></li><li><ul><li><a href="#21Filter_and_Join_15" rel="nofollow">2.1Filter and Join</a></li><li><a href="#22_Aggregates_558" rel="nofollow">2.2 Aggregates</a></li><li><a href="#23HeapFile_Mutability_1149" rel="nofollow">2.3HeapFile Mutability</a></li><li><a href="#24_Insertion_and_deletion_1866" rel="nofollow">2.4. Insertion and deletion</a></li><li><a href="#25_Page_eviction_2152" rel="nofollow">2.5. Page eviction</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>在此实验中，您将为SimpleDB编写一组运算符，以实现表修改（例如，插入和删除记录），选择，连接和聚合。 这些将构建在实验1中写入的基础之上，为您提供一个可以在多个表上执行简单查询的数据库系统。</p> 
<p>此外，我们忽略了实验中的缓冲池管理问题：我们没有处理引用多个页面时出现的问题。 在Lab 2中，您将设计一个驱动策略来从缓冲池中刷新陈旧页面。<br> 您无需在此实验中实现事务或锁定。</p> 
<h4><a id="1_8"></a>1.参考链接：</h4> 
<p>1.1 课程链接：<a href="http://db.lcs.mit.edu/6.830/assign.php" rel="nofollow">http://db.lcs.mit.edu/6.830/assign.php</a><br> 1.2 lab2链接：<a href="https://github.com/MIT-DB-Class/simple-db-hw-2021/blob/master/lab2.md">https://github.com/MIT-DB-Class/simple-db-hw-2021/blob/master/lab2.md</a><br> 1.3 HearmingBear Lab2链接：<a href="https://blog.csdn.net/hjw199666/article/details/103590963">https://blog.csdn.net/hjw199666/article/details/103590963</a><br> 1.4 我的仓库地址：<a href="https://gitee.com/zhou-zhiqiang/db-class" rel="nofollow">https://gitee.com/zhou-zhiqiang/db-class</a></p> 
<h4><a id="2SimpleDB_Architecture_and_Implementation_Guide_14"></a>2.SimpleDB Architecture and Implementation Guide</h4> 
<h5><a id="21Filter_and_Join_15"></a>2.1Filter and Join</h5> 
<p>Filter: This operator only returns tuples that satisfy a Predicate that is specified as part of its constructor. Hence, it filters out any tuples that do not match the predicate.<br> Filter：此操作符只返回满足Predicate的tuples，该tuples被指定为其构造函数的一部分。 因此，它过滤出与Predicate不匹配的任何tuples。</p> 
<p>Join: This operator joins tuples from its two children according to a JoinPredicate that is passed in as part of its constructor.<br> Join：此操作符根据JoinPredicate连接两个tuples。</p> 
<p>Exercise1.</p> 
<pre><code class="prism language-bash">src/java/simpledb/execution/Predicate.java
src/java/simpledb/execution/JoinPredicate.java
src/java/simpledb/execution/Filter.java
src/java/simpledb/execution/Join.java
</code></pre> 
<p>src/java/simpledb/execution/Predicate.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Predicate compares tuples to a specified Field value.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Predicate</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">/** Constants used for return codes in Field.compare */</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Op</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
        EQUALS<span class="token punctuation">,</span> GREATER_THAN<span class="token punctuation">,</span> LESS_THAN<span class="token punctuation">,</span> LESS_THAN_OR_EQ<span class="token punctuation">,</span> GREATER_THAN_OR_EQ<span class="token punctuation">,</span> LIKE<span class="token punctuation">,</span> NOT_EQUALS<span class="token punctuation">;</span>

        <span class="token comment">/**
         * Interface to access operations by integer value for command-line
         * convenience.
         * 
         * @param i
         *            a valid integer Op index
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Op</span> <span class="token function">getOp</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> EQUALS<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"="</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> GREATER_THAN<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"&gt;"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> LESS_THAN<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"&lt;"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> LESS_THAN_OR_EQ<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"&lt;="</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> GREATER_THAN_OR_EQ<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"&gt;="</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> LIKE<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"LIKE"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> NOT_EQUALS<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"&lt;&gt;"</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"impossible to reach here"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> field<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Op</span> op<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Field</span> operand<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Constructor.
     * 
     * @param field
     *            field number of passed in tuples to compare against.
     * @param op
     *            operation to use for comparison
     * @param operand
     *            field value to compare passed in tuples to
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Predicate</span><span class="token punctuation">(</span><span class="token keyword">int</span> field<span class="token punctuation">,</span> <span class="token class-name">Op</span> op<span class="token punctuation">,</span> <span class="token class-name">Field</span> operand<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field <span class="token operator">=</span> field<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>op <span class="token operator">=</span> op<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>operand <span class="token operator">=</span> operand<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the field number
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the operator
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Op</span> <span class="token function">getOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> op<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @return the operand
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Field</span> <span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> operand<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Compares the field number of t specified in the constructor to the
     * operand field specified in the constructor using the operator specific in
     * the constructor. The comparison can be made through Field's compare
     * method.
     * 
     * @param t
     *            The tuple to compare against
     * @return true if the comparison is true, false otherwise.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span>operand<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns something useful, like "f = field_id op = op_string operand =
     * operand_string"
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"f = %d op = %s operand = %s"</span><span class="token punctuation">,</span>field<span class="token punctuation">,</span>op<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>operand<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>字段及含义</p> 
<table><thead><tr><th>type</th><th>name</th><th>description</th></tr></thead><tbody><tr><td>int</td><td>field</td><td>field id</td></tr><tr><td>Op</td><td>op</td><td>操作符</td></tr><tr><td>Field</td><td>oprand</td><td>比较的field</td></tr></tbody></table> 
<p><strong>Op：</strong></p> 
<pre><code class="prism language-bash">实现了Serializable接口的枚举类型。
<span class="token operator">|</span> EQUALS <span class="token operator">|</span> GREATER_THAN <span class="token operator">|</span> LESS_THAN <span class="token operator">|</span> LESS_THAN_OR_EQ <span class="token operator">|</span> GREATER_THAN_OR_EQ <span class="token operator">|</span> LIKE <span class="token operator">|</span> NOT_EQUALS <span class="token operator">|</span>
<span class="token operator">|</span> :----: <span class="token operator">|</span> :----------: <span class="token operator">|</span> :-------: <span class="token operator">|</span> :-------------: <span class="token operator">|</span> :----------------: <span class="token operator">|</span> ---- <span class="token operator">|</span> :--------: <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token operator">=</span>    <span class="token operator">|</span>      <span class="token operator">&gt;</span>       <span class="token operator">|</span>     <span class="token operator">&lt;</span>     <span class="token operator">|</span>       <span class="token operator">&lt;</span><span class="token operator">=</span>        <span class="token operator">|</span>         <span class="token operator">&gt;</span><span class="token operator">=</span>         <span class="token operator">|</span> like <span class="token operator">|</span>     <span class="token operator">!=</span>     <span class="token operator">|</span>
提供了getOp、toString方法。
</code></pre> 
<p><strong>Predicate：</strong></p> 
<pre><code class="prism language-bash">构造器，字段id、操作、比较字段的数。
</code></pre> 
<p><strong>filter：</strong></p> 
<pre><code class="prism language-bash">获取需要比较元组field对应的值，与当前构造器的oprand比较，通过op操作符。
</code></pre> 
<p><strong>getField、getOp、getOperand、toString：</strong></p> 
<pre><code class="prism language-bash"> 略
</code></pre> 
<p>src/java/simpledb/execution/JoinPredicate.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * JoinPredicate compares fields of two tuples using a predicate. JoinPredicate
 * is most likely used by the Join operator.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JoinPredicate</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> field1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> field2<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> op<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor -- create a new predicate over two fields of two tuples.
     * 
     * @param field1
     *            The field index into the first tuple in the predicate
     * @param field2
     *            The field index into the second tuple in the predicate
     * @param op
     *            The operation to apply (as defined in Predicate.Op); either
     *            Predicate.Op.GREATER_THAN, Predicate.Op.LESS_THAN,
     *            Predicate.Op.EQUAL, Predicate.Op.GREATER_THAN_OR_EQ, or
     *            Predicate.Op.LESS_THAN_OR_EQ
     * @see Predicate
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">JoinPredicate</span><span class="token punctuation">(</span><span class="token keyword">int</span> field1<span class="token punctuation">,</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> field2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field1 <span class="token operator">=</span> field1<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>op <span class="token operator">=</span> op<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field2 <span class="token operator">=</span> field2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Apply the predicate to the two specified tuples. The comparison can be
     * made through Field's compare method.
     * 
     * @return true if the tuples satisfy the predicate.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> t1<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> t1<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>field1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> t2<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>field2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getField1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> field1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getField2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> field2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> <span class="token function">getOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> op<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>属性定义：<br> field1是第一个tuple的field id，field2是第二个tuple的field id，它们直接通过op操作过滤不符合条件的元组。<br> 关键方法：<br> filter：过滤掉不符合条件的元组。<br> 类似mysql的join…on后的on<br> <img src="https://images2.imgbox.com/2b/3d/YHsXTlY0_o.png" alt="在这里插入图片描述"><br> src/java/simpledb/execution/Filter.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Filter is an operator that implements a relational select.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Filter</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Predicate</span> p<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Constructor accepts a predicate to apply and a child operator to read
     * tuples to filter from.
     * 
     * @param p
     *            The predicate to filter tuples with
     * @param child
     *            The child operator
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Filter</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> p<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Predicate</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        child<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        child<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * AbstractDbIterator.readNext implementation. Iterates over tuples from the
     * child operator, applying the predicate to them and returning those that
     * pass the predicate (i.e. for which the Predicate.filter() returns true.)
     * 
     * @return The next tuple that passes the filter, or null if there are no
     *         more tuples
     * @see Predicate#filter
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Tuple</span> t <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>属性定义：<br> 定义了一个predicate过滤tuple，以及一个child表示要过滤元组的迭代器对象。<br> 关键方法：<br> fetchNext：如果child含有符合predicate过滤条件的tuple，则返回，否则返回null。<br> 例如满足过滤条件的元组，将会参与join操作。<br> <img src="https://images2.imgbox.com/30/34/hnZ0mMfa_o.png" alt="在这里插入图片描述"><br> src/java/simpledb/execution/Join.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The Join operator implements the relational join operation.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Join</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">JoinPredicate</span> p<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child2<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor. Accepts two children to join and the predicate to join them
     * on
     * 
     * @param p
     *            The predicate to use to join the children
     * @param child1
     *            Iterator for the left(outer) relation to join
     * @param child2
     *            Iterator for the right(inner) relation to join
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Join</span><span class="token punctuation">(</span><span class="token class-name">JoinPredicate</span> p<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child1<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child1 <span class="token operator">=</span> child1<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child2 <span class="token operator">=</span> child2<span class="token punctuation">;</span>
        t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JoinPredicate</span> <span class="token function">getJoinPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return
     *       the field name of join field1. Should be quantified by
     *       alias or table name.
     * */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getJoinField1Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> child1<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getField1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return
     *       the field name of join field2. Should be quantified by
     *       alias or table name.
     * */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getJoinField2Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> child2<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getField2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @see TupleDesc#merge(TupleDesc, TupleDesc) for possible
     *      implementation logic.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>child2<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        child1<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child2<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child1<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        child1<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child2<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the next tuple generated by the join, or null if there are no
     * more tuples. Logically, this is the next tuple in r1 cross r2 that
     * satisfies the join predicate. There are many possible implementations;
     * the simplest is a nested loops join.
     * &lt;p&gt;
     * Note that the tuples returned from this particular implementation of Join
     * are simply the concatenation of joining tuples from the left and right
     * relation. Therefore, if an equality predicate is used there will be two
     * copies of the join attribute in the results. (Removing such duplicate
     * columns can be done with an additional projection operator if needed.)
     * &lt;p&gt;
     * For example, if one tuple is {1,2,3} and the other tuple is {1,5,6},
     * joined on equality of the first column, then this returns {1,2,3,1,5,6}.
     * 
     * @return The next matching tuple.
     * @see JoinPredicate#filter
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                t <span class="token operator">=</span> child1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>child2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Tuple</span> t2 <span class="token operator">=</span> child2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span>t2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">TupleDesc</span> td1 <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TupleDesc</span> td2 <span class="token operator">=</span> t2<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TupleDesc</span> newTd <span class="token operator">=</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>td1<span class="token punctuation">,</span>td2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Tuple</span> newTuple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>newTd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newTuple<span class="token punctuation">.</span><span class="token function">setRecordId</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> td1<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        newTuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>t<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> td2<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        newTuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>i<span class="token operator">+</span>j<span class="token punctuation">,</span>t2<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        child2<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> newTuple<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            child2<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>child1<span class="token punctuation">,</span>child2<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        child1 <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        child2 <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>属性定义：<br> 定义了JoinPredicate对象p用于过滤tuple，child1作为第一个表的迭代器对象，child2作为第二个表的迭代器对象，以及临时变量t保存第一个表的tuple。<br> 关键方法：<br> fetchNext：遍历第二个表的tuple，查看符合filter条件的tuple，拼接成为一个新的tuple并返回，第二个回到起点。<br> 类似mysql<br> <img src="https://images2.imgbox.com/ea/f5/sHoLkIYj_o.png" alt="在这里插入图片描述"></p> 
<p>ant runtest -Dtest=PredicateTest<br> ant runtest -Dtest=JoinPredicateTest<br> ant runtest -Dtest=FilterTest<br> ant runtest -Dtest=JoinTest<br> 这些单元测试都BUILD SUCCESSFUL。<br> ant runsystest -Dtest=FilterTest<br> ant runsystest -Dtest=JoinTest<br> 这些系统测试都BUILD SUCCESSFUL。</p> 
<h5><a id="22_Aggregates_558"></a>2.2 Aggregates</h5> 
<pre><code class="prism language-java">src<span class="token operator">/</span>java<span class="token operator">/</span>simpledb<span class="token operator">/</span>execution<span class="token operator">/</span><span class="token class-name">IntegerAggregator</span><span class="token punctuation">.</span>java
src<span class="token operator">/</span>java<span class="token operator">/</span>simpledb<span class="token operator">/</span>execution<span class="token operator">/</span><span class="token class-name">StringAggregator</span><span class="token punctuation">.</span>java
src<span class="token operator">/</span>java<span class="token operator">/</span>simpledb<span class="token operator">/</span>execution<span class="token operator">/</span><span class="token class-name">Aggregate</span><span class="token punctuation">.</span>java
</code></pre> 
<p>src/java/simpledb/execution/IntegerAggregator.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">IntField</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Knows how to compute some aggregate over a set of IntFields.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntegerAggregator</span> <span class="token keyword">implements</span> <span class="token class-name">Aggregator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> gbfield<span class="token punctuation">;</span><span class="token comment">// group-by field</span>
    <span class="token keyword">private</span> <span class="token class-name">Type</span> gbfieldtype<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> afield<span class="token punctuation">;</span> <span class="token comment">//agregate field</span>
    <span class="token keyword">private</span> <span class="token class-name">Op</span> what<span class="token punctuation">;</span>

    <span class="token comment">/**
     * @return SUM,MIN,MAX,COUNT
     * **/</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> groupMap<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> countMap<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> avgMap<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Aggregate constructor
     * 
     * @param gbfield
     *            the 0-based index of the group-by field in the tuple, or
     *            NO_GROUPING if there is no grouping
     * @param gbfieldtype
     *            the type of the group by field (e.g., Type.INT_TYPE), or null
     *            if there is no grouping
     * @param afield
     *            the 0-based index of the aggregate field in the tuple
     * @param what
     *            the aggregation operator
     */</span>

    <span class="token keyword">public</span> <span class="token class-name">IntegerAggregator</span><span class="token punctuation">(</span><span class="token keyword">int</span> gbfield<span class="token punctuation">,</span> <span class="token class-name">Type</span> gbfieldtype<span class="token punctuation">,</span> <span class="token keyword">int</span> afield<span class="token punctuation">,</span> <span class="token class-name">Op</span> what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gbfield <span class="token operator">=</span> gbfield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gbfieldtype <span class="token operator">=</span> gbfieldtype<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>afield <span class="token operator">=</span> afield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>what <span class="token operator">=</span> what<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>countMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>avgMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Merge a new tuple into the aggregate, grouping as indicated in the
     * constructor
     * 
     * @param tup
     *            the Tuple containing an aggregate field and a group-by field
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mergeTupleIntoGroup</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> tup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token class-name">IntField</span> afield <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span> tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> gbfield <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gbfield <span class="token operator">==</span> NO_GROUPING <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> newVaule <span class="token operator">=</span> afield<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//IntField.getValue()</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>gbfield <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> gbfield<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">this</span><span class="token punctuation">.</span>gbfieldtype<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//compare</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Given tuple has wrong type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> MIN<span class="token operator">:</span>
                <span class="token comment">/**
                 * Places the current new tuple in the aggregate tuple
                 * */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">,</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> MAX<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">,</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> SUM<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token operator">+</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> COUNT<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> SC_AVG<span class="token operator">:</span>
                <span class="token class-name">IntField</span> countFiled <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>gbfield <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    countFiled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span> tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    countFiled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span> tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> countValue <span class="token operator">=</span> countFiled<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>countMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span>countValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span> <span class="token operator">+</span> newVaule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>countMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>countMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span> <span class="token operator">+</span> countValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> AVG<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>avgMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    l<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>avgMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>avgMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    l<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newVaule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Aggregate not supported!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a OpIterator over group aggregate results.
     * 
     * @return a OpIterator whose tuples are the pair (groupVal, aggregateVal)
     *         if using group, or a single (aggregateVal) if no grouping. The
     *         aggregateVal is determined by the type of aggregate specified in
     *         the constructor.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IntAggIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntAggIterator</span> <span class="token keyword">extends</span> <span class="token class-name">AggregateIterator</span><span class="token punctuation">{<!-- --></span>

        <span class="token keyword">private</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> avgIt<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> isAvg<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> isSCAvg<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> isSumCount<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">IntAggIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>groupMap<span class="token punctuation">,</span> gbfieldtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isAvg <span class="token operator">=</span> what<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>AVG<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isSCAvg <span class="token operator">=</span> what<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>SC_AVG<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isSumCount <span class="token operator">=</span> what<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>SUM_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSumCount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>itgbfieldtype<span class="token punctuation">,</span><span class="token class-name">Type</span><span class="token punctuation">.</span>INT_TYPE<span class="token punctuation">,</span><span class="token class-name">Type</span><span class="token punctuation">.</span>INT_TYPE<span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"groupVal"</span><span class="token punctuation">,</span><span class="token string">"sumVal"</span><span class="token punctuation">,</span><span class="token string">"countVal"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAvg <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isSumCount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>avgIt <span class="token operator">=</span> avgMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>avgIt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAvg <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isSumCount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> avgIt<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Tuple</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchElementException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Tuple</span> rtn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAvg <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isSumCount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> avgOrSumCountEntry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>avgIt<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Field</span> avgOrSumCountField <span class="token operator">=</span> avgOrSumCountEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> avgOrSumCountList <span class="token operator">=</span> avgOrSumCountEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAvg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sumList</span><span class="token punctuation">(</span>avgOrSumCountList<span class="token punctuation">)</span> <span class="token operator">/</span> avgOrSumCountList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFields</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span>value<span class="token punctuation">,</span>avgOrSumCountField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> rtn<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFields</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span><span class="token function">sumList</span><span class="token punctuation">(</span>avgOrSumCountList<span class="token punctuation">)</span><span class="token punctuation">,</span>avgOrSumCountField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>avgOrSumCountField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        rtn<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span>avgOrSumCountList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        rtn<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span>avgOrSumCountList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isSCAvg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Field</span> f <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFields</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> countMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> rtn<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAvg <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isSumCount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>avgIt <span class="token operator">=</span> avgMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>avgIt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">sumList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> l<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">:</span>l<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>属性定义：<br> 定义了gbfield表示group-by field id，gbfieldtype表示相应类型，afield表示agregate field id，what表示聚合类型有MIN, MAX, SUM, AVG, COUNT。<br> groupMap保存聚合的大部分情况，countMap保存每个分组的数目，avgMap保存需要统计平均值的value。<br> 关键方法：<br> mergeTupleIntoGroup：合并tuple到group中，包括MIN, MAX, SUM, AVG, COUNT,SC_AVG操作。<br> iterator：返回一个IntAggIterator对象，包含聚合结果的迭代器。</p> 
<p>src/java/simpledb/execution/StringAggregator.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">StringField</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Knows how to compute some aggregate over a set of StringFields.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringAggregator</span> <span class="token keyword">implements</span> <span class="token class-name">Aggregator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> gbfield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Type</span> gbfieldtype<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> afield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Op</span> what<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> groupMap<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Aggregate constructor
     * @param gbfield the 0-based index of the group-by field in the tuple, or NO_GROUPING if there is no grouping
     * @param gbfieldtype the type of the group by field (e.g., Type.INT_TYPE), or null if there is no grouping
     * @param afield the 0-based index of the aggregate field in the tuple
     * @param what aggregation operator to use -- only supports COUNT
     * @throws IllegalArgumentException if what != COUNT
     */</span>

    <span class="token keyword">public</span> <span class="token class-name">StringAggregator</span><span class="token punctuation">(</span><span class="token keyword">int</span> gbfield<span class="token punctuation">,</span> <span class="token class-name">Type</span> gbfieldtype<span class="token punctuation">,</span> <span class="token keyword">int</span> afield<span class="token punctuation">,</span> <span class="token class-name">Op</span> what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>what<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>COUNT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Only COUNT is supported for String fields!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gbfield <span class="token operator">=</span> gbfield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gbfieldtype <span class="token operator">=</span> gbfieldtype<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>afield <span class="token operator">=</span> afield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>what <span class="token operator">=</span> what<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Merge a new tuple into the aggregate, grouping as indicated in the constructor
     * @param tup the Tuple containing an aggregate field and a group-by field
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mergeTupleIntoGroup</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> tup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token class-name">StringField</span> afield <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringField</span><span class="token punctuation">)</span> tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> gbfield <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gbfield <span class="token operator">==</span> NO_GROUPING <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//group by field</span>
        <span class="token class-name">String</span> newValue <span class="token operator">=</span> afield<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//aggregate field</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>gbfield <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> gbfield<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gbfieldtype<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Given tuple has wrong type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a OpIterator over group aggregate results.
     *
     * @return a OpIterator whose tuples are the pair (groupVal,
     *   aggregateVal) if using group, or a single (aggregateVal) if no
     *   grouping. The aggregateVal is determined by the type of
     *   aggregate specified in the constructor.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AggregateIterator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupMap<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>gbfieldtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p><strong>属性定义：</strong><br> 定义了gbfield表示group-by field id，gbfieldtype表示相应类型，afield表示agregate field id，what表示聚合类型有COUNT。<br> groupMap保存聚合的COUNT情况<br> <strong>关键方法：</strong><br> mergeTupleIntoGroup：合并tuple到group中，包括COUNT操作。<br> iterator：返回一个AggregateIterator对象，包含聚合结果的迭代器。</p> 
<p>src/java/simpledb/execution/Aggregate.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">NoSuchElementException</span><span class="token punctuation">;</span>


<span class="token comment">/**
 * The Aggregation operator that computes an aggregate (e.g., sum, avg, max,
 * min). Note that we only support aggregates over a single column, grouped by a
 * single column.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Aggregate</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> afield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> gfield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span> aop<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Aggregator</span> aggregator<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> it<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Constructor.
     * &lt;p&gt;
     * Implementation hint: depending on the type of afield, you will want to
     * construct an {@link IntegerAggregator} or {@link StringAggregator} to help
     * you with your implementation of readNext().
     *
     * @param child  The OpIterator that is feeding us tuples.
     * @param afield The column over which we are computing an aggregate.
     * @param gfield The column over which we are grouping the result, or -1 if
     *               there is no grouping
     * @param aop    The aggregation operator to use
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Aggregate</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> afield<span class="token punctuation">,</span> <span class="token keyword">int</span> gfield<span class="token punctuation">,</span> <span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span> aop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>afield <span class="token operator">=</span> afield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gfield <span class="token operator">=</span> gfield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aop <span class="token operator">=</span> aop<span class="token punctuation">;</span>
        <span class="token class-name">Type</span> gfieldtype <span class="token operator">=</span> gfield <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gfield<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//group by field type</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span>STRING_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>aggregator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringAggregator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gfield<span class="token punctuation">,</span>gfieldtype<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>aop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>aggregator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntegerAggregator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gfield<span class="token punctuation">,</span>gfieldtype<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>aop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aggregator<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">&gt;</span></span> types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>gfieldtype <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            types<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>gfieldtype<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//group by field type</span>
            names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//field name</span>
        <span class="token punctuation">}</span>
        types<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aop<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span>SUM_COUNT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            types<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span>INT_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"COUNT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>names<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return If this aggregate is accompanied by a groupby, return the groupby
     * field index in the &lt;b&gt;INPUT&lt;/b&gt; tuples. If not, return
     * {@link Aggregator#NO_GROUPING}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">groupField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gfield<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return If this aggregate is accompanied by a group by, return the name
     * of the groupby field in the &lt;b&gt;OUTPUT&lt;/b&gt; tuples. If not, return
     * null;
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">groupFieldName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>td<span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the aggregate field
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">aggregateField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return return the name of the aggregate field in the &lt;b&gt;OUTPUT&lt;/b&gt;
     * tuples
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">aggregateFieldName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gfield <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>td<span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>td<span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return return the aggregate operator
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span> <span class="token function">aggregateOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">nameOfAggregatorOp</span><span class="token punctuation">(</span><span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span> aop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> aop<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>aggregator<span class="token punctuation">.</span><span class="token function">mergeTupleIntoGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>it<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the next tuple. If there is a group by field, then the first
     * field is the field by which we are grouping, and the second field is the
     * result of computing the aggregate. If there is no group by field, then
     * the result tuple should contain one field representing the result of the
     * aggregate. Should return null if there are no more tuples.
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>it<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the TupleDesc of this Aggregate. If there is no group by field,
     * this will have one field - the aggregate column. If there is a group by
     * field, the first field will be the group by field, and the second will be
     * the aggregate value column.
     * &lt;p&gt;
     * The name of an aggregate column should be informative. For example:
     * "aggName(aop) (child_td.getFieldName(afield))" where aop and afield are
     * given in the constructor, and child_td is the TupleDesc of the child
     * iterator.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>it<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">&gt;</span></span> types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Type</span> gfieldtype <span class="token operator">=</span> gfield <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>gfield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>gfieldtype <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            types<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>gfieldtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
            names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>gfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        types<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aop<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span>SUM_COUNT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            types<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span>INT_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"COUNT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>names<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>属性定义：<br> private OpIterator child; //提供tuple的迭代器<br> private int afield;//被聚合字段<br> private int gfield;//聚合字段<br> private Aggregator.Op aop;//聚合操作，如count<br> private Aggregator aggregator;//聚合器<br> private OpIterator it;//聚合器的迭代器<br> private TupleDesc td;//保存聚合、被聚合字段的元组描述<br> 关键方法：<br> open：聚合每个结果到aggregator<br> fetchNext：依次取结果。</p> 
<p>ant runtest -Dtest=IntegerAggregatorTest<br> ant runtest -Dtest=StringAggregatorTest<br> ant runtest -Dtest=FilterTest 和 ant runtest -Dtest=AggregateTest<br> 这些单元测试都BUILD SUCCESSFUL。</p> 
<p>ant runsystest -Dtest=AggregateTest<br> 这些系统测试BUILD SUCCESSFUL。</p> 
<h5><a id="23HeapFile_Mutability_1149"></a>2.3HeapFile Mutability</h5> 
<p>src/java/simpledb/storage/HeapPage.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Catalog</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">NoSuchElementException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Each instance of HeapPage stores data for one page of HeapFiles and
 * implements the Page interface that is used by BufferPool.
 *
 * @see HeapFile
 * @see BufferPool
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapPage</span> <span class="token keyword">implements</span> <span class="token class-name">Page</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">final</span> <span class="token class-name">HeapPageId</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Tuple</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tuples<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> numSlots<span class="token punctuation">;</span>

    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldData<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Byte</span> oldDataLock<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * the transaction id which changed the page to dirty
     * */</span>
    <span class="token keyword">private</span> <span class="token class-name">TransactionId</span> dirtyId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> dirty<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Create a HeapPage from a set of bytes of data read from disk.
     * The format of a HeapPage is a set of header bytes indicating
     * the slots of the page that are in use, some number of tuple slots.
     *  Specifically, the number of tuples is equal to: &lt;p&gt;
     *          floor((BufferPool.getPageSize()*8) / (tuple size * 8 + 1))
     * &lt;p&gt; where tuple size is the size of tuples in this
     * database table, which can be determined via {@link Catalog#getTupleDesc}.
     * The number of 8-bit header words is equal to:
     * &lt;p&gt;
     *      ceiling(no. tuple slots / 8)
     * &lt;p&gt;
     * @see Database#getCatalog
     * @see Catalog#getTupleDesc
     * @see BufferPool#getPageSize()
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeapPage</span><span class="token punctuation">(</span><span class="token class-name">HeapPageId</span> id<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numSlots <span class="token operator">=</span> <span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataInputStream</span> dis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// allocate and read the header slots of this page</span>
        header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token function">getHeaderSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>header<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            header<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> dis<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        tuples <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">[</span>numSlots<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// allocate and read the actual records of this page</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>tuples<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">readNextTuple</span><span class="token punctuation">(</span>dis<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Retrieve the number of tuples on this page.
        @return the number of tuples on this page
    */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Computes the number of bytes in the header of a page in a HeapFile with each tuple occupying tupleSize bytes
     * @return the number of bytes in the header of a page in a HeapFile with each tuple occupying tupleSize bytes
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getHeaderSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/** Return a view of this page before it was modified
        -- used by recovery */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeapPage</span> <span class="token function">getBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldDataRef <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>oldDataLock<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                oldDataRef <span class="token operator">=</span> oldData<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapPage</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>oldDataRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//should never happen -- we parsed it OK before!</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>oldDataLock<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        oldData <span class="token operator">=</span> <span class="token function">getPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the PageId associated with this page.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeapPageId</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Suck up tuples from the source file.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Tuple</span> <span class="token function">readNextTuple</span><span class="token punctuation">(</span><span class="token class-name">DataInputStream</span> dis<span class="token punctuation">,</span> <span class="token keyword">int</span> slotId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchElementException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// if associated bit is not set, read forward to the next tuple, and</span>
        <span class="token comment">// return null.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>slotId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    dis<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"error reading empty tuple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// read fields in the tuple</span>
        <span class="token class-name">Tuple</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RecordId</span> rid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordId</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> slotId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setRecordId</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Field</span> f <span class="token operator">=</span> td<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"parsing error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Generates a byte array representing the contents of this page.
     * Used to serialize this page to disk.
     * &lt;p&gt;
     * The invariant here is that it should be possible to pass the byte
     * array generated by getPageData to the HeapPage constructor and
     * have it produce an identical HeapPage object.
     *
     * @see #HeapPage
     * @return A byte array correspond to the bytes of this page.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataOutputStream</span> dos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// create the header of the page</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">byte</span> b <span class="token operator">:</span> header<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                dos<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// this really shouldn't happen</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// create the tuples</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>tuples<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">// empty slot</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        dos<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// non-empty slot</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Field</span> f <span class="token operator">=</span> tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    f<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>dos<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// padding</span>
        <span class="token keyword">int</span> zerolen <span class="token operator">=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span>length <span class="token operator">+</span> td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> tuples<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//- numSlots * td.getSize();</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> zeroes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>zerolen<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            dos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>zeroes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> zerolen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            dos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Static method to generate a byte array corresponding to an empty
     * HeapPage.
     * Used to add new, empty pages to the file. Passing the results of
     * this method to the HeapPage constructor will create a HeapPage with
     * no valid tuples in it.
     *
     * @return The returned ByteArray.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createEmptyPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//all 0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the specified tuple from the page; the corresponding header bit should be updated to reflect
     *   that it is no longer stored on any page.
     * @throws DbException if this tuple is not on this page, or tuple slot is
     *         already empty.
     * @param t The tuple to delete
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">"tuple does not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> tid <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTupleNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tid <span class="token operator">&gt;=</span> numSlots <span class="token operator">||</span> tuples<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">"tuple does not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">"the slot is already empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//        else {<!-- --></span>
<span class="token comment">//            markSlotUsed(tid,false);</span>
<span class="token comment">//            tuples[tid] = null;</span>
<span class="token comment">//        }</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tuples<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tuples<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token function">markSlotUsed</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">"tuple does not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Adds the specified tuple to the page;  the tuple should be updated to reflect
     *  that it is now stored on this page.
     * @throws DbException if the page is full (no empty slots) or tupledesc
     *         is mismatch.
     * @param t The tuple to add.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getNumEmptySlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">"page is full or tuple descriptor does not match"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSlots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">markSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">setRecordId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RecordId</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Marks this page as dirty/not dirty and record that transaction
     * that did the dirtying
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> dirty<span class="token punctuation">,</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
	<span class="token comment">// not necessary for lab1</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> dirty<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dirtyId <span class="token operator">=</span> tid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the tid of the transaction that last dirtied this page, or null if the page is not dirty
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionId</span> <span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
	<span class="token comment">// Not necessary for lab1</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dirtyId <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the number of empty slots on this page.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumEmptySlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSlots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">++</span>cnt<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns true if associated slot on this page is filled.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSlotUsed</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> quot <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> remainder <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bitidx <span class="token operator">=</span> header<span class="token punctuation">[</span>quot<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bit <span class="token operator">=</span> <span class="token punctuation">(</span>bitidx <span class="token operator">&gt;&gt;</span> remainder<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bit <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Abstraction to fill or clear a slot on this page.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">markSlotUsed</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token keyword">byte</span> b <span class="token operator">=</span> header<span class="token punctuation">[</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floorDiv</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span> mask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            header<span class="token punctuation">[</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floorDiv</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>b <span class="token operator">|</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            header<span class="token punctuation">[</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floorDiv</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span>mask<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return an iterator over all tuples on this page (calling remove on this iterator throws an UnsupportedOperationException)
     * (note that this iterator shouldn't return tuples in empty slots!)
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> filleTuples <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSlots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                filleTuples<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> filleTuples<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


</code></pre> 
<p>变量定义：<br> final HeapPageId pid;//页面ID值<br> final TupleDesc td;//元组描述<br> final byte[] header;<br> final Tuple[] tuples;<br> final int numSlots;<br> byte[] oldData;<br> private final Byte oldDataLock= (byte) 0;<br> private TransactionId dirtyId;<br> private boolean dirty;<br> 关键方法：<br> readNextTuple：从DataInputStream中读取某个槽的元组<br> getPageData：生成表示此页面内容的字节数组。用于将此页面序列化到磁盘。<br> deleteTuple：tuples相应位置为null，且设置槽为false。<br> insertTuple：设置tuples相应位置为t，且槽为true<br> markDirty：标记页面是否为脏，并记录事务id。<br> iterator：迭代整个页的元组。</p> 
<p>src/java/simpledb/storage/HeapFile.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Permissions</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">NoSuchElementException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * HeapFile is an implementation of a DbFile that stores a collection of tuples
 * in no particular order. Tuples are stored on pages, each of which is a fixed
 * size, and the file is simply a collection of those pages. HeapFile works
 * closely with HeapPage. The format of HeapPages is described in the HeapPage
 * constructor.
 * 
 * @see HeapPage#HeapPage
 * @author Sam Madden
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapFile</span> <span class="token keyword">implements</span> <span class="token class-name">DbFile</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">File</span> file<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructs a heap file backed by the specified file.
     * 
     * @param f
     *            the file that stores the on-disk backing store for this heap
     *            file.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeapFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> f<span class="token punctuation">,</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> f<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the File backing this HeapFile on disk.
     * 
     * @return the File backing this HeapFile on disk.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> file<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns an ID uniquely identifying this HeapFile. Implementation note:
     * you will need to generate this tableid somewhere to ensure that each
     * HeapFile has a "unique id," and that you always return the same value for
     * a particular HeapFile. We suggest hashing the absolute file name of the
     * file underlying the heapfile, i.e. f.getAbsoluteFile().hashCode().
     * 
     * @return an ID uniquely identifying this HeapFile.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">getAbsoluteFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the TupleDesc of the table stored in this DbFile.
     * 
     * @return TupleDesc of this DbFile.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token class-name">Page</span> <span class="token function">readPage</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> tableId <span class="token operator">=</span> pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pgNo <span class="token operator">=</span> pid<span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RandomAccessFile</span> f <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pgNo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> f<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"table %d page %d is invalid"</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>pgNo <span class="token operator">*</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> read <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">!=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"table %d page %d read %d bytes"</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">,</span> read<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">HeapPageId</span> id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapPage</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"table %d page %d is invalid"</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writePage</span><span class="token punctuation">(</span><span class="token class-name">Page</span> page<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token keyword">int</span> pgNo <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pgNo <span class="token operator">&gt;</span> <span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> pgSize <span class="token operator">=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RandomAccessFile</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span><span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>pgNo<span class="token operator">*</span>pgSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the number of pages in this HeapFile.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> <span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> pageList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">HeapPage</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HeapPage</span><span class="token punctuation">)</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Permissions</span><span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getNumEmptySlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            p<span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> pageList<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">BufferedOutputStream</span> bw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> emptyData <span class="token operator">=</span> <span class="token class-name">HeapPage</span><span class="token punctuation">.</span><span class="token function">createEmptyPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>emptyData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HeapPage</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HeapPage</span><span class="token punctuation">)</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Permissions</span><span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pageList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>

        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> pageList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HeapPage</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HeapPage</span><span class="token punctuation">)</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>
                t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Permissions</span><span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">deleteTuple</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pageList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token class-name">DbFileIterator</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapFileIterator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeapFileIterator</span> <span class="token keyword">implements</span> <span class="token class-name">DbFileIterator</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HeapFile</span> heapFile<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> it<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> whichPage<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">HeapFileIterator</span><span class="token punctuation">(</span><span class="token class-name">HeapFile</span> file<span class="token punctuation">,</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heapFile <span class="token operator">=</span> file<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> tid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
            whichPage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            it <span class="token operator">=</span> <span class="token function">getPageTuples</span><span class="token punctuation">(</span>whichPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPageTuples</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNumber<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pageNumber <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pageNumber <span class="token operator">&lt;</span> heapFile<span class="token punctuation">.</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">HeapPageId</span> pid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span>heapFile<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pageNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">HeapPage</span> page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HeapPage</span><span class="token punctuation">)</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>pid<span class="token punctuation">,</span><span class="token class-name">Permissions</span><span class="token punctuation">.</span>READ_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> page<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"heapfile %d does not contain page %d!"</span><span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span>heapFile<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>whichPage <span class="token operator">&lt;</span> <span class="token punctuation">(</span>heapFile<span class="token punctuation">.</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    whichPage<span class="token operator">++</span><span class="token punctuation">;</span>
                    it <span class="token operator">=</span> <span class="token function">getPageTuples</span><span class="token punctuation">(</span>whichPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>whichPage <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>heapFile<span class="token punctuation">.</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Tuple</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchElementException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            it <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>变量定义：<br> private final File file;//保存tuple的文件<br> private final TupleDesc td;<br> 关键方法：<br> readPage、writePage：读或写页面到文件<br> insertTuple、deleteTuple：插入tuple或删除tuple到page，其中page从bufferpool获取</p> 
<p>src/java/simpledb/storage/BufferPool.java</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token keyword">int</span> tableId<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">DbFile</span> f <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateBufferPool</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Remove the specified tuple from the buffer pool.
     * Will acquire a write lock on the page the tuple is removed from and any
     * other pages that are updated. May block if the lock(s) cannot be acquired.
     *
     * Marks any pages that were dirtied by the operation as dirty by calling
     * their markDirty bit, and adds versions of any pages that have 
     * been dirtied to the cache (replacing any existing versions of those pages) so 
     * that future requests see up-to-date pages. 
     *
     * @param tid the transaction deleting the tuple.
     * @param t the tuple to delete
     */</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">DbFile</span> f <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateBufferPool</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">deleteTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateBufferPool</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> pagelist<span class="token punctuation">,</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Page</span> p<span class="token operator">:</span>pagelist<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            p<span class="token punctuation">.</span><span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// update bufferpool</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pageStore<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> numPages<span class="token punctuation">)</span>
                <span class="token function">evictPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pageStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>ant runtest -Dtest=HeapPageWriteTest<br> ant runtest -Dtest=HeapFileWriteTest<br> ant runtest -Dtest=BufferPoolWriteTest<br> 都BUILD SUCCESSFUL。</p> 
<h5><a id="24_Insertion_and_deletion_1866"></a>2.4. Insertion and deletion</h5> 
<p>src/java/simpledb/execution/Insert.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">BufferPool</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">IntField</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Inserts tuples read from the child operator into the tableId specified in the
 * constructor
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Insert</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> tableId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">;</span>

    <span class="token comment">/**
     * helper for fetchNext
     * */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> counter<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> called<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor.
     *
     * @param t
     *            The transaction running the insert.
     * @param child
     *            The child operator from which to read tuples to be inserted.
     * @param tableId
     *            The table in which to insert tuples.
     * @throws DbException
     *             if TupleDesc of child differs from table into which we are to
     *             insert.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Insert</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> t<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> tableId<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">"TupleDesc does not match!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tableId <span class="token operator">=</span> tableId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Type</span><span class="token punctuation">.</span>INT_TYPE<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"number of inserted tuples"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Inserts tuples read from child into the tableId specified by the
     * constructor. It returns a one field tuple containing the number of
     * inserted records. Inserts should be passed through BufferPool. An
     * instances of BufferPool is available via Database.getBufferPool(). Note
     * that insert DOES NOT need check to see if a particular tuple is a
     * duplicate before inserting it.
     *
     * @return A 1-field tuple containing the number of inserted records, or
     *         null if called more than once.
     * @see Database#getBufferPool
     * @see BufferPool#insertTuple
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>called<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Tuple</span> t <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tid<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>tableId<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Tuple</span> tu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tu<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tu<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>方法定义：<br> private TransactionId tid;//事务id<br> private OpIterator child;//要插入tuple迭代器<br> private int tableId;//表id<br> private final TupleDesc td;//元组描述<br> private int counter;//计数器<br> private boolean called;//<br> 关键方法：<br> fetchNext：调用bufferpool去insert元组。</p> 
<p><img src="https://images2.imgbox.com/96/ce/D24lJotn_o.png" alt="在这里插入图片描述"></p> 
<p>src/java/simpledb/execution/Delete.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">BufferPool</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">IntField</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The delete operator. Delete reads tuples from its child operator and removes
 * them from the table they belong to.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Delete</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> counter<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> called<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor specifying the transaction that this delete belongs to as
     * well as the child to read from.
     * 
     * @param t
     *            The transaction this delete runs in
     * @param child
     *            The child operator from which to read tuples for deletion
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Delete</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> t<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Type</span><span class="token punctuation">.</span>INT_TYPE<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"number of deleted tuples"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Deletes tuples as they are read from the child operator. Deletes are
     * processed via the buffer pool (which can be accessed via the
     * Database.getBufferPool() method.
     * 
     * @return A 1-field tuple containing the number of deleted records.
     * @see Database#getBufferPool
     * @see BufferPool#deleteTuple
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>called<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Tuple</span> t <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tid<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Tuple</span> tu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tu<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tu<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>变量定义：<br> private TransactionId tid;//事务id<br> private OpIterator child;//要插入tuple迭代器<br> private int tableId;//表id<br> private final TupleDesc td;//元组描述<br> private int counter;//计数器<br> private boolean called;//<br> 关键方法：<br> fetchNext：调用bufferpool去delete元组。</p> 
<p>ant runtest -Dtest=InsertTest<br> 单元测试 BUILD SUCCESSFUL。<br> ant runsystest -Dtest=InsertTest<br> ant runsystest -Dtest=DeleteTest<br> 系统测试BUILD SUCCESSFUL。</p> 
<h5><a id="25_Page_eviction_2152"></a>2.5. Page eviction</h5> 
<p>src/java/simpledb/storage/BufferPool.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Permissions</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * BufferPool manages the reading and writing of pages into memory from
 * disk. Access methods call into it to retrieve pages, and it fetches
 * pages from the appropriate location.
 * &lt;p&gt;
 * The BufferPool is also responsible for locking;  when a transaction fetches
 * a page, BufferPool checks that the transaction has the appropriate
 * locks to read/write the page.
 * 
 * @Threadsafe, all fields are final
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BufferPool</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/** Bytes per page, including header. */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PAGE_SIZE <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> pageSize <span class="token operator">=</span> DEFAULT_PAGE_SIZE<span class="token punctuation">;</span>
    
    <span class="token comment">/** Default number of pages passed to the constructor. This is used by
    other classes. BufferPool should use the numPages argument to the
    constructor instead. */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PAGES <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> numPages<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> pageStore<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Creates a BufferPool that caches up to numPages pages.
     *
     * @param numPages maximum number of pages in this buffer pool.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BufferPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> numPages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numPages <span class="token operator">=</span> numPages<span class="token punctuation">;</span>
        pageStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> pageSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// THIS FUNCTION SHOULD ONLY BE USED FOR TESTING!!</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setPageSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token class-name">BufferPool</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// THIS FUNCTION SHOULD ONLY BE USED FOR TESTING!!</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">resetPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token class-name">BufferPool</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> DEFAULT_PAGE_SIZE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Retrieve the specified page with the associated permissions.
     * Will acquire a lock and may block if that lock is held by another
     * transaction.
     * &lt;p&gt;
     * The retrieved page should be looked up in the buffer pool.  If it
     * is present, it should be returned.  If it is not present, it should
     * be added to the buffer pool and returned.  If there is insufficient
     * space in the buffer pool, a page should be evicted and the new page
     * should be added in its place.
     *
     * @param tid the ID of the transaction requesting the page
     * @param pid the ID of the requested page
     * @param perm the requested permissions on the page
     */</span>
    <span class="token keyword">public</span>  <span class="token class-name">Page</span> <span class="token function">getPage</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">PageId</span> pid<span class="token punctuation">,</span> <span class="token class-name">Permissions</span> perm<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pageStore<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pageStore<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> numPages<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">evictPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Page</span> page <span class="token operator">=</span> dbFile<span class="token punctuation">.</span><span class="token function">readPage</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pageStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pageStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Releases the lock on a page.
     * Calling this is very risky, and may result in wrong behavior. Think hard
     * about who needs to call this and why, and why they can run the risk of
     * calling it.
     *
     * @param tid the ID of the transaction requesting the unlock
     * @param pid the ID of the page to unlock
     */</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">unsafeReleasePage</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">PageId</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Release all locks associated with a given transaction.
     *
     * @param tid the ID of the transaction requesting the unlock
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transactionComplete</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Return true if the specified transaction has a lock on the specified page */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">holdsLock</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">PageId</span> p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Commit or abort a given transaction; release all locks associated to
     * the transaction.
     *
     * @param tid the ID of the transaction requesting the unlock
     * @param commit a flag indicating whether we should commit or abort
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transactionComplete</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> commit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Add a tuple to the specified table on behalf of transaction tid.  Will
     * acquire a write lock on the page the tuple is added to and any other 
     * pages that are updated (Lock acquisition is not needed for lab2). 
     * May block if the lock(s) cannot be acquired.
     * 
     * Marks any pages that were dirtied by the operation as dirty by calling
     * their markDirty bit, and adds versions of any pages that have 
     * been dirtied to the cache (replacing any existing versions of those pages) so 
     * that future requests see up-to-date pages. 
     *
     * @param tid the transaction adding the tuple
     * @param tableId the table to add the tuple to
     * @param t the tuple to add
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token keyword">int</span> tableId<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">DbFile</span> f <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateBufferPool</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">/**
     * Remove the specified tuple from the buffer pool.
     * Will acquire a write lock on the page the tuple is removed from and any
     * other pages that are updated. May block if the lock(s) cannot be acquired.
     *
     * Marks any pages that were dirtied by the operation as dirty by calling
     * their markDirty bit, and adds versions of any pages that have 
     * been dirtied to the cache (replacing any existing versions of those pages) so 
     * that future requests see up-to-date pages. 
     *
     * @param tid the transaction deleting the tuple.
     * @param t the tuple to delete
     */</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">DbFile</span> f <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateBufferPool</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">deleteTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateBufferPool</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> pageList<span class="token punctuation">,</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Page</span> p<span class="token operator">:</span>pageList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            p<span class="token punctuation">.</span><span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pageStore<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> numPages<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">evictPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pageStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Flush all dirty pages to disk.
     * NB: Be careful using this routine -- it writes dirty data to disk so will
     *     break simpledb if running in NO STEAL mode.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">flushAllPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Page</span> p<span class="token operator">:</span>pageStore<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">flushPage</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Remove the specific page id from the buffer pool.
        Needed by the recovery manager to ensure that the
        buffer pool doesn't keep a rolled back page in its
        cache.
        
        Also used by B+ tree files to ensure that deleted pages
        are removed from the cache so they can be reused safely
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">discardPage</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        pageStore<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Flushes a certain page to disk
     * @param pid an ID indicating the page to flush
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span>  <span class="token keyword">void</span> <span class="token function">flushPage</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> pid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">Page</span> p <span class="token operator">=</span> pageStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TransactionId</span> tid <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tid <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getLogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logWrite</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>p<span class="token punctuation">.</span><span class="token function">getBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getLogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writePage</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Write all pages of the specified transaction to disk.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span>  <span class="token keyword">void</span> <span class="token function">flushPages</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Discards a page from the buffer pool.
     * Flushes the page to disk to ensure dirty pages are updated on disk.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span>  <span class="token keyword">void</span> <span class="token function">evictPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">PageId</span> pid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pageStore<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">flushPage</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">discardPage</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>变量定义：<br> private static final int DEFAULT_PAGE_SIZE = 4096;//默认页大小<br> private static int pageSize = DEFAULT_PAGE_SIZE;//默认页大小<br> public static final int DEFAULT_PAGES = 50;//默认页数目<br> private final int numPages;//实际页数目<br> private final ConcurrentHashMap&lt;Integer,Page&gt; pageStore;//页map<br> 关键方法：<br> flushPage：刷新页面到磁盘，把脏页刷新。<br> evictPage：淘汰缓冲池里的页面。</p> 
<p>ant runsystest -Dtest=EvictionTest<br> 系统测试BUILD SUCCESSFUL。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5c590246ec15aa9a72a12c9fc63c6569/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PostgreSQL pg_hba.conf 文件简析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0548d2a29a95f152705cae3fd6982d8d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机管理员密码忘记了怎么恢复,新版tplink(tplogin.cn)管理员密码忘记了怎么办？...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>