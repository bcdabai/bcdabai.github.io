<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>V4L2系列 之 初识V4L2 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="V4L2系列 之 初识V4L2" />
<meta property="og:description" content="目录 前言一、发展历史二、主要功能三、编程开发1、采集方式2、操作流程（编程步骤） 前言 由于进行linux音视频开发，通常会涉及到音频以及摄像头视频驱动，所以对V4L2以及ALSA驱动框架进行学习，并整理相关的笔记和大家分享！
一、发展历史 V4L2是Video for linux2的简称,为linux中关于视频设备的内核驱动。在Linux中，视频设备是设备文件，可以像访问普通文件一样对其进行读写，摄像头在/dev/video*下，如果只有一个视频设备，通常为/dev/video0。
V4L2在设计时，是要支持很多广泛的设备的，它们之中只有一部分在本质上是真正的视频设备。
V4L2有一段历史了。大约在1998的秋天，它的光芒第一次出现在Bill Dirks 的眼中。
经过长足的发展，它于2002年11 月，发布2.5.46 时，融入了内核主干之中。然而直到今天，仍有一部分内核驱动不支持新的API，这种新旧API 的转换工作仍在进行。
同时，V4L2 API也在发展，并在2.6.18 版本中进行了一些重大的改变。支持V4L2的应用依旧相对较少。V4L2在设计时，是要支持很多广泛的设备的，它们之中只有一部分在本质上是真正的视频设备，可以支持多种设备,它可以有以下几种接口:
1. 视频采集接口(video capture interface):这种应用的设备可以是高频头或者摄像头. V4L2的最初设计就是应用于这种功能的. 2. 视频输出接口(video output interface):可以驱动计算机的外围视频图像设备--像 可以输出电视信号格式的设备. 3. 直接传输视频接口(video overlay interface):它的主要工作是把从视频采集设备 采集过来的信号直接输出到输出设备之上,而不用经过系统的CPU. 4. 视频间隔消隐信号接口(VBI interface):它可以使应用可以访问传输消隐期的视频信号. 5. 收音机接口(radio interface):可用来处理从AM或FM高频头设备接收来的音频流. 二、主要功能 使程序有发现设备和操作设备的能力,它主要是用一系列的回调函数来实现这些功能。像设置摄像头的频率、帧频、视频压缩格式和图像参数等等。当然也可以用于其他多媒体的开发，如音频等。
但是此框架只能运行在Linux操作系统之上。
三、编程开发 v4L2是针对uvc免驱usb设备的编程框架 ，主要用于采集usb摄像头等， 基本开发步骤如下：
1、采集方式 打开视频设备后，可以设置该视频设备的属性，例如裁剪、缩放等。这一步是可选的。在Linux编程中，一般使用ioctl函数来对设备的I/O通道进行管理：
extern int ioctl (int __fd, unsigned long int __request, …) __THROW; __fd：设备的ID，例如刚才用open函数打开视频通道后返回的cameraFd； __request：具体的命令标志符。 在进行V4L2开发中，一般会用到以下的命令标志符： VIDIOC_REQBUFS：分配内存 VIDIOC_QUERYBUF：把VIDIOC_REQBUFS中分配的数据缓存转换成物理地址 VIDIOC_QUERYCAP：查询驱动功能 VIDIOC_ENUM_FMT：获取当前驱动支持的视频格式 VIDIOC_S_FMT：设置当前驱动的频捕获格式 VIDIOC_G_FMT：读取当前驱动的频捕获格式 VIDIOC_TRY_FMT：验证当前驱动的显示格式 VIDIOC_CROPCAP：查询驱动的修剪能力 VIDIOC_S_CROP：设置视频信号的边框 VIDIOC_G_CROP：读取视频信号的边框 VIDIOC_QBUF：把数据放回缓存队列 VIDIOC_DQBUF：把数据从缓存中读取出来 VIDIOC_STREAMON：开始视频显示函数 VIDIOC_STREAMOFF：结束视频显示函数 VIDIOC_QUERYSTD：检查当前视频设备支持的标准，例如PAL或NTSC。 这些IO调用，有些是必须的，有些是可选择的。 2、操作流程（编程步骤） 参考学习：https://blog." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1754b77071b907e643a8132f7b3c0f64/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-10T00:03:41+08:00" />
<meta property="article:modified_time" content="2023-04-10T00:03:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">V4L2系列 之 初识V4L2</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_3" rel="nofollow">一、发展历史</a></li><li><a href="#_25" rel="nofollow">二、主要功能</a></li><li><a href="#_29" rel="nofollow">三、编程开发</a></li><li><ul><li><a href="#1_31" rel="nofollow">1、采集方式</a></li><li><a href="#2_56" rel="nofollow">2、操作流程（编程步骤）</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p><code>由于进行linux音视频开发，通常会涉及到音频以及摄像头视频驱动，所以对V4L2以及ALSA驱动框架进行学习，并整理相关的笔记和大家分享！</code></p> 
<h2><a id="_3"></a>一、发展历史</h2> 
<p>  <strong>V4L2</strong>是<mark>Video for linux2</mark>的简称,为<strong>linux中关于视频设备的内核驱动</strong>。在Linux中，视频设备是设备文件，可以像访问普通文件一样对其进行读写，摄像头在/dev/video*下，如果只有一个视频设备，通常为/dev/video0。</p> 
<p>  V4L2在设计时，是要支持很多广泛的设备的，它们之中<strong>只有一部分在本质上是真正的视频设备</strong>。</p> 
<p>  V4L2有一段历史了。大约在1998的秋天，它的光芒第一次出现在Bill Dirks 的眼中。<br>   经过长足的发展，它于2002年11 月，发布2.5.46 时，融入了内核主干之中。然而直到今天，仍有一部分内核驱动不支持新的API，这种新旧API 的转换工作仍在进行。<br>   同时，V4L2 API也在发展，并在2.6.18 版本中进行了一些重大的改变。支持V4L2的应用依旧相对较少。V4L2在设计时，是要支持很多广泛的设备的，它们之中只有一部分在本质上是真正的视频设备，可以支持多种设备,它可以有以下几种接口:</p> 
<pre><code class="prism language-c"><span class="token number">1.</span> 视频采集接口<span class="token punctuation">(</span>video capture interface<span class="token punctuation">)</span><span class="token operator">:</span>这种应用的设备可以是高频头或者摄像头<span class="token punctuation">.</span>
	V4L2的最初设计就是应用于这种功能的<span class="token punctuation">.</span>
	
<span class="token number">2.</span> 视频输出接口<span class="token punctuation">(</span>video output interface<span class="token punctuation">)</span><span class="token operator">:</span>可以驱动计算机的外围视频图像设备<span class="token operator">--</span>像
	可以输出电视信号格式的设备<span class="token punctuation">.</span>

<span class="token number">3.</span> 直接传输视频接口<span class="token punctuation">(</span>video overlay interface<span class="token punctuation">)</span><span class="token operator">:</span>它的主要工作是把从视频采集设备
	采集过来的信号直接输出到输出设备之上<span class="token punctuation">,</span>而不用经过系统的CPU<span class="token punctuation">.</span>

<span class="token number">4.</span> 视频间隔消隐信号接口<span class="token punctuation">(</span>VBI interface<span class="token punctuation">)</span><span class="token operator">:</span>它可以使应用可以访问传输消隐期的视频信号<span class="token punctuation">.</span>

<span class="token number">5.</span> 收音机接口<span class="token punctuation">(</span>radio interface<span class="token punctuation">)</span><span class="token operator">:</span>可用来处理从AM或FM高频头设备接收来的音频流<span class="token punctuation">.</span>
</code></pre> 
<h2><a id="_25"></a>二、主要功能</h2> 
<p>  <code>使程序有发现设备和操作设备的能力,它主要是用一系列的回调函数来实现这些功能。</code>像设置摄像头的频率、帧频、视频压缩格式和图像参数等等。当然也可以用于其他多媒体的开发，如音频等。</p> 
<p>  但是<mark>此框架只能运行在Linux操作系统之上。</mark></p> 
<h2><a id="_29"></a>三、编程开发</h2> 
<p>  <strong>v4L2是针对uvc免驱usb设备的编程框架 ，主要用于采集usb摄像头等，</strong> 基本开发步骤如下：</p> 
<h3><a id="1_31"></a>1、采集方式</h3> 
<p>  打开视频设备后，可以设置该视频设备的属性，例如裁剪、缩放等。这一步是可选的。在Linux编程中，一般使用ioctl函数来对设备的I/O通道进行管理：</p> 
<pre><code class="prism language-c"><span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">ioctl</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> __request<span class="token punctuation">,</span> …<span class="token punctuation">)</span> __THROW<span class="token punctuation">;</span>
__fd：设备的ID，例如刚才用open函数打开视频通道后返回的cameraFd；
__request：具体的命令标志符。
在进行V4L2开发中，一般会用到以下的命令标志符：
VIDIOC_REQBUFS：分配内存
VIDIOC_QUERYBUF：把VIDIOC_REQBUFS中分配的数据缓存转换成物理地址
VIDIOC_QUERYCAP：查询驱动功能
VIDIOC_ENUM_FMT：获取当前驱动支持的视频格式
VIDIOC_S_FMT：设置当前驱动的频捕获格式
VIDIOC_G_FMT：读取当前驱动的频捕获格式
VIDIOC_TRY_FMT：验证当前驱动的显示格式
VIDIOC_CROPCAP：查询驱动的修剪能力
VIDIOC_S_CROP：设置视频信号的边框
VIDIOC_G_CROP：读取视频信号的边框
VIDIOC_QBUF：把数据放回缓存队列
VIDIOC_DQBUF：把数据从缓存中读取出来
VIDIOC_STREAMON：开始视频显示函数
VIDIOC_STREAMOFF：结束视频显示函数
VIDIOC_QUERYSTD：检查当前视频设备支持的标准，例如PAL或NTSC。
这些IO调用，有些是必须的，有些是可选择的。
</code></pre> 
<h3><a id="2_56"></a>2、操作流程（编程步骤）</h3> 
<pre><code class="prism language-c">参考学习：https<span class="token operator">:</span><span class="token comment">//blog.csdn.net/u010783226/article/details/122260974</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">1.</span> 打开设备文件。
<span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>”<span class="token operator">/</span>dev<span class="token operator">/</span>video0″<span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">2.</span> 取得设备的capability，看看设备具有什么功能，比如是否具有视频输入<span class="token punctuation">,</span>或者音频输入
输出等。VIDIOC_QUERYCAP<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">v4l2_capability</span>

<span class="token keyword">struct</span> <span class="token class-name">v4l2_capability</span> <span class="token punctuation">{<!-- --></span>
    __u8    driver<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* i.e. "bttv" */</span>
    __u8    card<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* i.e. "Hauppauge WinTV" */</span>
    __u8    bus_info<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* "PCI:" + pci_name(pci_dev) */</span>
    __u32   version<span class="token punctuation">;</span>        <span class="token comment">/* should use KERNEL_VERSION() */</span>
    __u32    capabilities<span class="token punctuation">;</span>    <span class="token comment">/* Device capabilities */</span>
    __u32    reserved<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
其中最重要的是capabilities字段，这个字段标记着v4l2设备的功能，capabilities有
以下部分标记位
ID                              描述符
V4L2_CAP_VIDEO_CAPTURE    设备支持捕获功能
V4L2_CAP_VIDEO_OUTPUT     设备支持输出功能
V4L2_CAP_VIDEO_OVERLAY    设备支持预览功能
V4L2_CAP_STREAMING        设备支持流读写
V4L2_CAP_READWRITE        设备支持read、write方式读写
我们可以通过这样子去判断设备的功能
<span class="token keyword">if</span><span class="token punctuation">(</span>cap<span class="token punctuation">.</span>capabilities <span class="token operator">&amp;</span> V4L2_CAP_VIDEO_CAPTURE<span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"v4l2 dev support capture\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>cap<span class="token punctuation">.</span>capabilities <span class="token operator">&amp;</span> V4L2_CAP_VIDEO_OUTPUT<span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"v4l2 dev support output\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>cap<span class="token punctuation">.</span>capabilities <span class="token operator">&amp;</span> V4L2_CAP_VIDEO_OVERLAY<span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"v4l2 dev support overlay\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>cap<span class="token punctuation">.</span>capabilities <span class="token operator">&amp;</span> V4L2_CAP_STREAMING<span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"v4l2 dev support streaming\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>cap<span class="token punctuation">.</span>capabilities <span class="token operator">&amp;</span> V4L2_CAP_READWRITE<span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"v4l2 dev support read write\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
v4l2_std_id std<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
	ret<span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_QUERYSTD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>std<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">switch</span> <span class="token punctuation">(</span>std<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> V4L2_STD_NTSC<span class="token operator">:</span>
	<span class="token comment">//……</span>
	<span class="token keyword">case</span> V4L2_STD_PAL<span class="token operator">:</span>
	<span class="token comment">//……</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">v4l2_capability</span> cap<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_QUERYCAP<span class="token punctuation">,</span> cap<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ERR(%s):VIDIOC_QUERYCAP failed\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">3.</span> 选择视频输入，一个视频设备可以有多个视频输入。
VIDIOC_S_INPUT<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">v4l2_input</span>
一个设备可能有多个输入，比如：在芯片上，摄像头控制器和摄像头接口是分离的，需要选择哪一个摄像头接口作为摄像头控制器的输入源

当然，并不是所有的设备都需要设置输入，比如：uvc摄像头，一般只有一个输入，默认就会选择，不需要设置

下面介绍如何设置输入设备

（<span class="token number">1</span>）枚举输入设备
下面这段程序枚举了该设备所有的输入源，并打印输入源的名称
<span class="token keyword">struct</span> <span class="token class-name">v4l2_input</span> input<span class="token punctuation">;</span>

input<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_ENUMINPUT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input:%s\n"</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>input<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

（<span class="token number">2</span>）设置输入设备
<span class="token keyword">struct</span> <span class="token class-name">v4l2_input</span> input<span class="token punctuation">;</span>

input<span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span> <span class="token comment">//指定输入设备</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_S_INPUT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ERR(%s):VIDIOC_S_INPUT failed\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">4.</span> 设置视频的制式和帧格式，制式包括PAL，NTSC，帧的格式个包括宽度和高度等。
VIDIOC_S_STD<span class="token punctuation">,</span>VIDIOC_S_FMT<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">v4l2_std_id</span><span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">v4l2_format</span>
<span class="token keyword">struct</span> <span class="token class-name">v4l2_format</span> fmt<span class="token punctuation">;</span>
<span class="token comment">/*
v4l2_format 结构如下：
struct v4l2_format
{
	enum v4l2_buf_type type; // 数据流类型，必须永远是V4L2_BUF_TYPE_VIDEO_CAPTURE
	union
	{
	struct v4l2_pix_format pix;
	struct v4l2_window win;
	struct v4l2_vbi_format vbi;
	__u8 raw_data[200];
	} fmt;
};
struct v4l2_pix_format
{
	__u32 width; // 宽，必须是16 的倍数
	__u32 height; // 高，必须是16 的倍数
	__u32 pixelformat; // 视频数据存储类型，例如是YUV 4 ：2 ：2 还是RGB
	enum v4l2_field field;
	__u32 bytesperline;
	__u32 sizeimage;
	enum v4l2_colorspace colorspace;
	__u32 priv;
};
*/</span>
样例：
<span class="token function">memset</span> <span class="token punctuation">(</span> <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fmt<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
fmt<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>
fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span>
fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>pixelformat <span class="token operator">=</span> V4L2_PIX_FMT_JPEG<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_S_FMT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fmt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span>）
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"set format failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//return 0;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">5.</span> 向驱动申请帧缓冲，一般不超过<span class="token number">5</span>个。<span class="token keyword">struct</span> <span class="token class-name">v4l2_requestbuffers</span>
<span class="token keyword">struct</span> <span class="token class-name">v4l2_requestbuffers</span>
<span class="token punctuation">{<!-- --></span>
	__u32 count<span class="token punctuation">;</span> <span class="token comment">// 缓存数量，也就是说在缓存队列里保持多少张照片</span>
	<span class="token keyword">enum</span> <span class="token class-name">v4l2_buf_type</span> type<span class="token punctuation">;</span> <span class="token comment">// 数据流类型，必须永远是V4L2_BUF_TYPE_VIDEO_CAPTURE</span>
	<span class="token keyword">enum</span> <span class="token class-name">v4l2_memory</span> memory<span class="token punctuation">;</span> <span class="token comment">// V4L2_MEMORY_MMAP 或 V4L2_MEMORY_USERPTR</span>
	__u32 reserved<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

样例：
<span class="token keyword">struct</span> <span class="token class-name">v4l2_requestbuffers</span> req<span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
req<span class="token punctuation">.</span>memory <span class="token operator">=</span> V4L2_MEMORY_MMAP<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>VIDIOC_REQBUFS<span class="token punctuation">,</span><span class="token operator">&amp;</span>req<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"VIDIOC_REQBUFS error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//return -1;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">6.</span>申请物理内存
将申请到的帧缓冲映射到用户空间，这样就可以直接操作采集到的帧了，而不必去复制。
将申请到的帧缓冲全部入队列，以便存放采集到的数据<span class="token punctuation">.</span>VIDIOC_QBUF<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">v4l2_buffer</span>

VideoBuffer<span class="token operator">*</span> buffers <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span> req<span class="token punctuation">.</span>count<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>VideoBuffer<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof(VideoBuffer) is %d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>VideoBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">v4l2_buffer</span> buf<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>numBufs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> numBufs <span class="token operator">&lt;</span> req<span class="token punctuation">.</span>count<span class="token punctuation">;</span> numBufs<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">memset</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	buf<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
	buf<span class="token punctuation">.</span>memory <span class="token operator">=</span> V4L2_MEMORY_MMAP<span class="token punctuation">;</span>
	buf<span class="token punctuation">.</span>index <span class="token operator">=</span> numBufs<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_QUERYBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"VIDIOC_QUERYBUF error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//return -1;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf len is %d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//内存映射</span>
	buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">=</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
	buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> buf<span class="token punctuation">.</span>m<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>
	buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token function">mmap</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">,</span>PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> buf<span class="token punctuation">.</span>m<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffers.length = %d,buffers.offset = %d ,buffers.start[0] = %d\n"</span><span class="token punctuation">,</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>offset<span class="token punctuation">,</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf2 len is %d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"buffers error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//return -1;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_QBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"VIDIOC_QBUF error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//return -1;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">7.</span> 开始视频的采集。
<span class="token keyword">enum</span> <span class="token class-name">v4l2_buf_type</span> type<span class="token punctuation">;</span>
type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_STREAMON<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"VIDIOC_STREAMON error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// return -1;</span>
<span class="token punctuation">}</span>

出队列以取得已采集数据的帧缓冲，取得原始采集数据。VIDIOC_DQBUF<span class="token punctuation">,</span> 将缓冲重新
入队列尾<span class="token punctuation">,</span>这样可以循环采集。VIDIOC_QBUF
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_DQBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"VIDIOC_DQBUF failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//return -1;</span>
<span class="token punctuation">}</span>
buf<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
buf<span class="token punctuation">.</span>memory <span class="token operator">=</span> V4L2_MEMORY_MMAP<span class="token punctuation">;</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptcur <span class="token operator">=</span> buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf.bytesused = %d \n"</span><span class="token punctuation">,</span>buf<span class="token punctuation">.</span>bytesused<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i1<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i1<span class="token operator">&lt;</span>buf<span class="token punctuation">.</span>bytesused<span class="token punctuation">;</span> i1<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">[</span>i1<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x000000FF</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">[</span>i1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x000000C4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Huffman table finded! \nbuf.bytesused = %d\nFFC4 = %d \n"</span><span class="token punctuation">,</span>buf<span class="token punctuation">.</span>bytesused<span class="token punctuation">,</span>i1<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>i1 <span class="token operator">==</span> buf<span class="token punctuation">.</span>bytesused<span class="token punctuation">)</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"huffman table don't exist! \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>buf<span class="token punctuation">.</span>bytesused<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x000000FF</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x000000D8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
	ptcur<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i=%d,FF=%02x,D8=%02x\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>buffers<span class="token punctuation">[</span>numBufs<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> imagesize <span class="token operator">=</span>buf<span class="token punctuation">.</span>bytesused <span class="token operator">-</span> i<span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf.bytesused = %d \n"</span><span class="token punctuation">,</span>buf<span class="token punctuation">.</span>bytesused<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"imagesize = %d \n"</span><span class="token punctuation">,</span>imagesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">8.</span> 停止视频的采集。VIDIOC_STREAMOFF
<span class="token keyword">enum</span> <span class="token class-name">v4l2_buf_type</span> type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VIDIOC_STREAMOFF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ERR(%s):VIDIOC_STREAMOFF failed\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token number">9.</span> <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>关闭视频设备，munmap解除内存映射，释放资源。
</code></pre> 
<p>  <em><mark>了解V4L2的来源以及基本操作后，下一篇文章将介绍V4L2的驱动框架，敬请期待.</mark></em></p> 
<p><em><strong>本文内容主要来自百度百科以及韦东山老师的课程笔记，如有侵权，联系删除！欢迎各位在评论区指导交流！！！</strong></em></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9138dcffb26ffc4d9af0f8e93d446e3c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">matlab学习之Bode图</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4d6e2ce10107c27768341ca8be208876/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【爱思助手】iPhone虚拟定位打卡</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>