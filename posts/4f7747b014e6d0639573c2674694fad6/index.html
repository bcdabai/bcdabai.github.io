<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker使用入门 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="docker使用入门" />
<meta property="og:description" content="参考资料 初级指导： Docker overview | Docker Documentation 名词解释 镜像（Image）：Docker 镜像（Image），就相当于是一个 root 文件系统。比如官方镜像 ubuntu:16.04 就包含了完整的一套 Ubuntu16.04 最小系统的 root 文件系统。容器（Container）：镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。仓库（Repository）：仓库可看成一个代码控制中心，用来保存镜像。主机： 一个物理或者虚拟的机器用于执行 Docker 守护进程和容器。Docker Registry： Docker 仓库用来保存镜像，可以理解为代码控制中的代码仓库。Docker Hub(https://hub.docker.com) 提供了庞大的镜像集合供使用PGP： Pretty Good Privacy 是一套用于消息加密、验证的应用程序. PGP 本身是商业应用程序；对应的开源软件为 GPG（GnuPG）GPG: GNU Privacy Guard, 也是一种加密软件，它是 PGP 加密软件的开源替代程序. 在docker中主要用于容器的加密？volume: 卷Flask： 是一个Python编写的Web 微框架，让我们可以使用Python语言快速实现一个网站或Web服务bind mount： linux命令，将一个目录挂载到另一个CI / CD: Continuous Integrate, Continuous Deploy 持续集成和持续交付Dockerfile: 是一个用来构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。Compose: 您可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。 比Dockerfile集成度更高。或者说前者用来启动程序，后者用来生成镜像overlay: 相当于创建一个虚拟网络，将主机，多个容器，甚至多个docker daemon均覆盖进来，彼此之间均可以通信CNM: Container Network Modelbridge: 早期的交换机雏形，交换机可以认为是多个bridge的集合。转发二层帧，起到信号放大的作用。网卡相当于是一个网桥/交换机，两者在一个网段内。arp和ping均可以通过automatic service discovery： 类似于DNS服务，使得 ping -c 2 alpine2 这样的操作可以实现kvm: Kernel-based Virtual Machine,是一种内建于linux中的开源虚拟化技术QEMU： 一种通用的开源计算机仿真器和虚拟器 安装 docker desktop 以下安装方法针对ubuntu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4f7747b014e6d0639573c2674694fad6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-08T09:22:49+08:00" />
<meta property="article:modified_time" content="2022-09-08T09:22:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker使用入门</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>参考资料</h2> 
<ol><li>初级指导： <a href="https://docs.docker.com/get-started/overview/" rel="nofollow">Docker overview | Docker Documentation</a></li><li></ol> 
<h2><a id="_5"></a>名词解释</h2> 
<ul><li><strong>镜像（Image）</strong>：Docker 镜像（Image），就相当于是一个 root 文件系统。比如官方镜像 ubuntu:16.04 就包含了完整的一套 Ubuntu16.04 最小系统的 root 文件系统。</li><li><strong>容器（Container）</strong>：镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。</li><li><strong>仓库（Repository）</strong>：仓库可看成一个代码控制中心，用来保存镜像。</li><li>主机： 一个物理或者虚拟的机器用于执行 Docker 守护进程和容器。</li><li>Docker Registry： Docker 仓库用来保存镜像，可以理解为代码控制中的代码仓库。Docker Hub(<a href="https://hub.docker.com/" rel="nofollow">https://hub.docker.com</a>) 提供了庞大的镜像集合供使用</li><li>PGP： Pretty Good Privacy 是一套用于消息加密、验证的应用程序. <strong>PGP 本身是商业应用程序</strong>；对应的开源软件为 GPG（GnuPG）</li><li>GPG: GNU Privacy Guard, 也是一种加密软件，它是 PGP 加密软件的开源替代程序. 在docker中主要用于容器的加密？</li><li>volume: 卷</li><li>Flask： 是一个Python编写的Web 微框架，让我们可以使用Python语言快速实现一个网站或Web服务</li><li>bind mount： linux命令，将一个目录挂载到另一个</li><li>CI / CD: Continuous Integrate, Continuous Deploy 持续集成和持续交付</li><li>Dockerfile: 是一个用来构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。</li><li>Compose: 您可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。 比Dockerfile集成度更高。或者说前者用来启动程序，后者用来生成镜像</li><li>overlay: 相当于创建一个虚拟网络，将主机，多个容器，甚至多个docker daemon均覆盖进来，彼此之间均可以通信</li><li>CNM: Container Network Model</li><li>bridge: 早期的交换机雏形，交换机可以认为是多个bridge的集合。转发二层帧，起到信号放大的作用。网卡相当于是一个网桥/交换机，两者在一个网段内。arp和ping均可以通过</li><li><strong>automatic service discovery</strong>： 类似于DNS服务，使得 ping -c 2 alpine2 这样的操作可以实现</li><li>kvm: Kernel-based Virtual Machine,是一种内建于linux中的开源虚拟化技术</li><li>QEMU： 一种通用的开源计算机仿真器和虚拟器</li></ul> 
<h2><a id="_31"></a>安装</h2> 
<h3><a id="docker_desktop_33"></a>docker desktop</h3> 
<p>以下安装方法针对ubuntu</p> 
<h4><a id="_37"></a>系统准备</h4> 
<p>在虚拟机上使用docker需要安装kvm</p> 
<pre><code class="prism language-bash">modprobe kvm
modprobe kvm_intel  
lsmod <span class="token operator">|</span> <span class="token function">grep</span> kvm
<span class="token function">ls</span> -al /dev/kvm
<span class="token function">sudo</span> <span class="token function">usermod</span> -aG kvm <span class="token environment constant">$USER</span>   <span class="token comment"># 添加用户态权限</span>

</code></pre> 
<p>安装新版qemu，文档要求5.2以上</p> 
<pre><code class="prism language-bash"><span class="token function">wget</span> https://download.qemu.org/qemu-7.1.0-rc3.tar.xz
<span class="token function">tar</span> xvJf qemu-7.1.0-rc3.tar.xz
<span class="token builtin class-name">cd</span> qemu-7.1.0-rc3
./configure
<span class="token function">make</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>

</code></pre> 
<p>configure需要安装ninja</p> 
<pre><code>sudo apt install re2c
git clone https://gitee.com/hclink_ai/ninja.git

cd ninja
python3 configure.py --bootstrap 

sudo cp ./ninja  /usr/bin
ninja --version
</code></pre> 
<p>文件共享</p> 
<pre><code class="prism language-bash"> <span class="token function">grep</span> <span class="token string">"<span class="token environment constant">$USER</span>"</span> /etc/subuid <span class="token operator">&gt;&gt;</span> /dev/null <span class="token number">2</span><span class="token operator">&amp;&gt;</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token punctuation">(</span>echo <span class="token string">"<span class="token environment constant">$USER</span>:100000:65536"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/subuid<span class="token punctuation">)</span>
 <span class="token function">grep</span> <span class="token string">"<span class="token environment constant">$USER</span>"</span> /etc/subgid <span class="token operator">&gt;&gt;</span> /dev/null <span class="token number">2</span><span class="token operator">&amp;&gt;</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token punctuation">(</span>echo <span class="token string">"<span class="token environment constant">$USER</span>:100000:65536"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/subgid<span class="token punctuation">)</span>
 
 <span class="token builtin class-name">echo</span> <span class="token environment constant">$USER</span>
 <span class="token function">cat</span> /etc/subuid
 <span class="token function">cat</span> /etc/subgid
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> add-apt-repository ppa:jacob/virtualisation
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> libvirt-clients libvirt-daemon bridge-utils 
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> grub-common
grub2-editenv - <span class="token builtin class-name">set</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>grub2-editenv - list <span class="token operator">|</span> <span class="token function">grep</span> kernelopts<span class="token variable">)</span></span> intel_iommu=on"</span>   <span class="token comment"># 开启IOMMU</span>

<span class="token function">sudo</span> <span class="token function">chmod</span> a+rw /var/lib/docker

$ <span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">docker</span> stop
$ <span class="token function">sudo</span> systemctl disable docker.service
$ <span class="token function">sudo</span> systemctl disable docker.socket
</code></pre> 
<h4><a id="_106"></a>开始安装</h4> 
<p>安装前首先要清理原有的老文件</p> 
<pre><code class="prism language-bash"> <span class="token function">sudo</span> <span class="token function">apt</span> remove docker-desktop
 <span class="token function">rm</span> -r <span class="token environment constant">$HOME</span>/.docker/desktop
 <span class="token function">sudo</span> <span class="token function">rm</span> /usr/local/bin/com.docker.cli
 <span class="token function">sudo</span> <span class="token function">apt</span> purge docker-desktop
</code></pre> 
<p>如果没有gnome，需要先安装</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gnome-terminal
</code></pre> 
<p>开始安装Docker</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token comment"># 依赖</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ca-certificates <span class="token function">curl</span> gnupg lsb-release
<span class="token comment"># GPG key</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/apt/keyrings
<span class="token function">curl</span> -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg
<span class="token comment"># 设置repository</span>
<span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>
<span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">&gt;</span> /dev/null
<span class="token comment"># 安装engine</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> docker-ce docker-ce-cli containerd.io docker-compose-plugin
<span class="token comment"># 需要update之后才行，比较大，有500多M</span>
<span class="token comment"># 也可以通过deb安装 Docker Desktop</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ./docker-desktop-<span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>-<span class="token operator">&lt;</span>arch<span class="token operator">&gt;</span>.deb
<span class="token comment"># 80多M</span>
</code></pre> 
<p>生成凭据,否则无法登录</p> 
<pre><code class="prism language-bash">gpg --generate-key
pass init 7865BA9185AFA2C26C5B505669FC4F36530097C2

</code></pre> 
<p>注册</p> 
<p>登录</p> 
<p>验证</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> compose version
<span class="token function">docker</span> --version
<span class="token function">docker</span> version
</code></pre> 
<p>加入用户组</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token comment"># 正常会显示权限错误，此时需要加入组</span>
<span class="token function">sudo</span> gpasswd -a <span class="token environment constant">$USER</span> <span class="token function">docker</span> 
newgrp <span class="token function">docker</span>
</code></pre> 
<h3><a id="docker_engine_177"></a>docker engine</h3> 
<p>可以使用脚本自动化安装</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> -sSL https://get.docker.com/ <span class="token operator">|</span> <span class="token function">sh</span>
</code></pre> 
<p>一般安装</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> remove <span class="token function">docker</span> docker-engine docker.io containerd runc
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ca-certificates <span class="token function">curl</span> gnupg lsb-release
<span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/apt/keyrings

 <span class="token function">curl</span> -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg
 
<span class="token builtin class-name">echo</span> <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">&gt;</span> /dev/null
  
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> docker-ce docker-ce-cli containerd.io <span class="token function">docker-compose</span>
 
</code></pre> 
<h3><a id="_204"></a>换源</h3> 
<p>阿里云的加速器：https://help.aliyun.com/document_detail/60750.html</p> 
<p>网易加速器：http://hub-mirror.c.163.com</p> 
<p>官方中国加速器：https://registry.docker-cn.com</p> 
<p>ustc 的镜像：https://docker.mirrors.ustc.edu.cn</p> 
<p>在 settings-&gt; Docker Engine 中加入以下配置即可</p> 
<pre><code class="prism language-json"><span class="token string-property property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"http://hub-mirror.c.163.com"</span>
  <span class="token punctuation">]</span>
</code></pre> 
<p>如果是docker engine，换源方法如下</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /etc/docker
<span class="token function">vim</span> daemon.json
<span class="token comment"># 添加源</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">"https://hub-mirror.c.163.com"</span>,
    <span class="token string">"https://ghcr.io"</span>,
    <span class="token string">"https://mirror.baidubce.com"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token function">service</span> <span class="token function">docker</span> restart


</code></pre> 
<h2><a id="_245"></a>使用</h2> 
<h3><a id="_247"></a>常用方法</h3> 
<h4><a id="_249"></a>查看类</h4> 
<pre><code class="prism language-bash"><span class="token function">docker</span> images      <span class="token comment"># 查看镜像</span>
<span class="token function">docker</span> <span class="token function">ps</span>          <span class="token comment"># 查看容器</span>
<span class="token function">docker</span> <span class="token function">ps</span> -a       <span class="token comment"># 查看容器详细信息</span>
<span class="token function">docker</span> --help      <span class="token comment"># 查看帮助</span>
<span class="token function">docker</span> -v          <span class="token comment"># 查看版本</span>
<span class="token function">docker</span> attach xx   <span class="token comment"># 查看xx容器运行情况</span>
</code></pre> 
<h4><a id="_260"></a>运行类</h4> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run xx     <span class="token comment"># 运行xx镜像</span>
<span class="token function">docker</span> run xx <span class="token operator">&amp;&amp;</span> python3 hello.py -yy zz <span class="token comment"># 运行xx镜像并启动容器中的程序,后面可以加入命令行参数zz</span>
<span class="token function">docker</span> run xx python3 hello.py     <span class="token comment"># 同上</span>
<span class="token function">docker</span> run -dit xx <span class="token comment"># 以互动方式后台运行镜像</span>
<span class="token function">docker</span> start xx   <span class="token comment"># 运行xx容器</span>
<span class="token function">docker</span> stop  xx
<span class="token function">docker</span> restart xx
</code></pre> 
<h4><a id="_272"></a>管理类</h4> 
<pre><code class="prism language-bash">systemctl start <span class="token function">docker</span>   <span class="token comment"># 启动守护程序</span>
systemctl stop <span class="token function">docker</span>
systemctl restart <span class="token function">docker</span>

<span class="token function">docker</span> system prune <span class="token comment"># 删除停止的容器，无用的网络，清缓存，删除无用的镜像</span>
<span class="token function">docker</span> <span class="token function">rm</span> xx        <span class="token comment"># 删除指定容器，支持简写前几位进行模糊匹配</span>
<span class="token function">docker</span> rmi xx       <span class="token comment"># 删除指定镜像</span>

<span class="token function">docker</span> build -t xx <span class="token builtin class-name">.</span>  <span class="token comment"># 在当前文件夹选择Dockerfile进行镜像构建，镜像名为xx</span>
<span class="token function">sudo</span> <span class="token function">docker</span> login -u xxx -p xxx  <span class="token comment"># 上传前需要先登录</span>
<span class="token function">sudo</span> <span class="token function">docker</span> tag storm moonfish/storm:v1.1 <span class="token comment"># 上传前要先重命名，格式为  账号/镜像名：版本号</span>
<span class="token function">sudo</span> <span class="token function">docker</span> push moonfish/baikal:v1  <span class="token comment"># 上传</span>
<span class="token function">sudo</span> <span class="token function">docker</span> pull moonfish/baikal:v1  <span class="token comment"># 下载</span>

</code></pre> 
<h3><a id="_293"></a>命令行参数</h3> 
<h4><a id="docker_build_295"></a>docker build</h4> 
<p>–network=host 相当于虚拟机中的host only选项，主机和容器共享网卡，名字也相同。</p> 
<p>如果不输入参数，那么docker会自动构建一个桥接网络，容器会连接至虚拟网卡 docker0， 地址为127.17.0.1; 而容器会自动被赋予一个127网段的地址</p> 
<h4><a id="docker_run_301"></a>docker run</h4> 
<ul><li><strong>-a stdin:</strong> 指定标准输入输出内容类型，可选 STDIN/STDOUT/STDERR 三项；</li><li><strong>-d:</strong> 后台运行容器，并返回容器ID；</li><li><strong>-i:</strong> 以交互模式运行容器，通常与 -t 同时使用；</li><li><strong>-P:</strong> 随机端口映射，容器内部端口<strong>随机</strong>映射到主机的端口</li><li><strong>-p:</strong> 指定端口映射，格式为：<strong>主机(宿主)端口:容器端口</strong></li><li><strong>-t:</strong> 为容器重新分配一个伪输入终端，通常与 -i 同时使用；提示符会变为#号</li><li><strong>–name=“nginx-lb”:</strong> 为容器指定一个名称；</li><li><strong>–dns 8.8.8.8:</strong> 指定容器使用的DNS服务器，默认和宿主一致；</li><li><strong>-e username=“ritchie”:</strong> 设置环境变量</li><li><strong>–env-file=[]:</strong> 从指定文件读入环境变量；</li><li>**-m 😗*设置容器使用内存最大值；</li><li><strong>–link=[]:</strong> 添加链接到另一个容器；</li><li><strong>–volume , -v:</strong> 绑定一个卷</li></ul> 
<h4><a id="docker_exec_317"></a>docker exec</h4> 
<ul><li>-d: Detached Mode: 后台运行</li><li>-e: 设置环境变量</li><li>-i: 展示容器输入信息<code>STDIN</code></li><li>–privileged: 为命令提供一些扩展权限</li><li>-t: 命令行交互模式</li><li>-u: 设置用户名(format: &lt;name|uid&gt;[:&lt;group|gid&gt;])</li><li>-w: 指定容器内的目录</li></ul> 
<h4><a id="docker_network_327"></a>docker network</h4> 
<p>docker的网络管理调用的是iptable</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> network create -d bridge my-bridge-network  <span class="token comment"># 建立一个自定义的网络，指定为bridge模式；还可以为overlay模式</span>
<span class="token function">docker</span> network create -d overlay my-multihost-network  <span class="token comment"># overlay模式，多个容器之间可以放入同一个网段，有docker统一管理</span>
sysctl net.ipv4.conf.all.forwarding<span class="token operator">=</span><span class="token number">1</span>   <span class="token comment"># 让自定义网络能够与外界通信</span>
<span class="token function">sudo</span> iptables -P FORWARD ACCEPT  <span class="token comment"># iptables 放通</span>
</code></pre> 
<h4><a id="other_338"></a>other</h4> 
<pre><code class="prism language-bash"><span class="token function">docker</span> create --name my-nginx --network my-net --publish <span class="token number">8080</span>:80 nginx <span class="token comment"># 通过nginx镜像创建容器，指定名称，指定网络，指定端口映射</span>
<span class="token function">docker</span> network connect my-net my-nginx  <span class="token comment"># 连接正在运行的容器与指定网络</span>
</code></pre> 
<h3><a id="_347"></a>镜像制作</h3> 
<h4><a id="python_349"></a>python</h4> 
<h5><a id="_351"></a>代码</h5> 
<p>python依赖</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /path/to/python-docker
pip3 <span class="token function">install</span> Flask
pip3 freeze <span class="token operator">|</span> <span class="token function">grep</span> Flask <span class="token operator">&gt;&gt;</span> requirements.txt
</code></pre> 
<p>requirements.txt</p> 
<pre><code>scapy==2.4.5
pika==1.3.0
nmap==0.0.1
</code></pre> 
<p>Dockerfile</p> 
<pre><code class="prism language-dockerfile"># syntax=docker/dockerfile:1
FROM python:3.8-slim-buster
WORKDIR /app
COPY requirements.txt requirements.txt
RUN pip3 install -r requirements.txt
COPY . .

</code></pre> 
<pre><code class="prism language-dockerfile">FROM ubuntu:20.04
WORKDIR /app
RUN ["mkdir", "-p", "/var/log/stormEngine"]
RUN ["apt", "update"]
RUN ["apt", "-y", "install", "ethtool", "tcpreplay", "iputils-ping"]
COPY . /app
</code></pre> 
<pre><code class="prism language-dockerfile">FROM ubuntu:20.04
WORKDIR /app
COPY . /app

ENV TZ=Asia/Shanghai \
    DEBIAN_FRONTEND=noninteractive

RUN mkdir -p /var/log/stormEngine \
    &amp;&amp; apt update \
    &amp;&amp; apt install -y tzdata net-tools ethtool tcpreplay iputils-ping\
    &amp;&amp; ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime \
    &amp;&amp; echo ${TZ} &gt; /etc/timezone \
    &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata \
    &amp;&amp; rm -rf /var/lib/apt/lists/* 
</code></pre> 
<h5><a id="build_407"></a>build</h5> 
<pre><code class="prism language-bash"><span class="token function">docker</span> build --tag hello <span class="token builtin class-name">.</span>
<span class="token function">docker</span> build -t hello <span class="token builtin class-name">.</span>
</code></pre> 
<h5><a id="run_414"></a>run</h5> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run hello
</code></pre> 
<h5><a id="push_420"></a>push</h5> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> tag storm moonfish/storm:v1.1
<span class="token function">sudo</span> <span class="token function">docker</span> login -u moonfish -p xxx
<span class="token function">sudo</span> <span class="token function">docker</span> push moonfish/storm:v1.1
</code></pre> 
<h4><a id="java_430"></a>java</h4> 
<h5><a id="jdk_432"></a>jdk安装</h5> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">wget</span> https://download.oracle.com/java/18/latest/jdk-18_linux-x64_bin.tar.gz

<span class="token function">sudo</span> <span class="token function">vi</span> /etc/profile
<span class="token comment"># 添加以下3行</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/home/ubuntu/Programm/openjdk-18.0.2.1_linux-x64_bin/jdk-18.0.2.1
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/lib
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JAVA_HOME</span>/lib:<span class="token environment constant">$PATH</span>

<span class="token builtin class-name">source</span> /etc/profile 
</code></pre> 
<p>或者</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openjdk-18-jre-headless  <span class="token comment"># version 18~36ea-1</span>
</code></pre> 
<h5><a id="_452"></a>代码</h5> 
<p>将代码打包为jar包,需要在pom.xml文件中加入插件，以下代码可以同时生成胖包和瘦包</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- thin jar --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-jar-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>addClasspath</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>addClasspath</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classpathPrefix</span><span class="token punctuation">&gt;</span></span>lib/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classpathPrefix</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span>main.MainApp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- add dependencies this jar --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-dependency-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>copy-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>copy-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>outputDirectory</span><span class="token punctuation">&gt;</span></span>${project.build.directory}/lib<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>outputDirectory</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- fat jar --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span>main.MainApp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--这里改成自己的主类位置--&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code>FROM amazoncorretto:17.0.4-alpine3.15
WORKDIR /app
COPY . /app
ENV PATH=$PATH:$JAVA_HOME/bin
ENV JRE_HOME=${JAVA_HOME}/jre
ENV CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib

</code></pre> 
<pre><code class="prism language-dockerfile">FROM eclipse-temurin:11-jre-jammy
WORKDIR /app
COPY . /app
RUN ["mkdir", "-p", "/app/data"]
RUN ["mkdir", "-p", "/data/pcap_files"]
RUN ["cp", "/app/libpcap.so.1.9.1", "/usr/lib/x86_64-linux-gnu"]
</code></pre> 
<p>加入libpcap.so.1.9.1</p> 
<pre><code class="prism language-dockerfile">FROM eclipse-temurin:11-jre-jammy
WORKDIR /app
COPY . /app
ENV TZ=Asia/Shanghai \
    DEBIAN_FRONTEND=noninteractive
RUN mkdir -p /app/data /data/pcap_files \
    &amp;&amp; cp /app/libpcap.so.1.9.1 /usr/lib/x86_64-linux-gnu \
    &amp;&amp; apt update \
    &amp;&amp; apt install -y tzdata \
    &amp;&amp; ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime \
    &amp;&amp; echo ${TZ} &gt; /etc/timezone \
    &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata \
    &amp;&amp; rm -rf /var/lib/apt/lists/* 
</code></pre> 
<h4><a id="C_562"></a>C</h4> 
<p>需要将所有依赖的库都拷贝到/app目录下，系统会自动优先链接,以下命令可以查看</p> 
<pre><code class="prism language-bash">lld baikal
</code></pre> 
<h5><a id="_570"></a>代码</h5> 
<pre><code class="prism language-dockerfile">FROM ubuntu:16.04
WORKDIR /app
COPY . /app
ENV TZ=Asia/Shanghai \
    DEBIAN_FRONTEND=noninteractive
RUN mkdir -p /usr/local/baikal /data/pcap_files \
    &amp;&amp; apt update \
    &amp;&amp; apt install -y tzdata \
    &amp;&amp; ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime \
    &amp;&amp; echo ${TZ} &gt; /etc/timezone \
    &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata \
    &amp;&amp; rm -rf /var/lib/apt/lists/* 
</code></pre> 
<h3><a id="_589"></a>多阶段构建</h3> 
<h2><a id="_597"></a>备注</h2> 
<ol><li> <p>A 2018 analysis found that a typical Docker use case involves running eight containers per host</p> </li><li> <p>需要开启nested virtualization，否则docker desktop无法使用<br> 方法： 虚拟机设置-&gt;硬件-&gt;处理器-&gt;虚拟化 IntelVT-x/EPT<br> 另外</p> <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> libvirt-clients libvirt-daemon qemu
<span class="token function">sudo</span> add-apt-repository ppa:jacob/virtualisation
</code></pre> </li><li> <p>image是镜像,位置在/var/lib/docker,里面有（没有镜像,）容器和分层,都存储在这里； 镜像位置是：setting-&gt;advanced-&gt;disk image location中可以查看和修改</p> </li><li> <p>and the volume’s contents exist outside the lifecycle of a given container.</p> </li><li> <p>C语言如果使用静态编译，那么就不需要向容器中拷贝依赖库了，镜像也会变得非常小。构建时只需要 From scratch即可</p> </li><li> <p>如果是C的helloworld 镜像必须添加CMD，否则无法运行。 因为镜像中没哟bash程序</p> </li><li> <p>“#” prompt 默认是root权限</p> </li><li> <p>若无特殊配置，不同host之间的容器无法通信； 除非使用overlay模式</p> </li><li> <p>File sharing 可以在IDE中修改源代码，在容器中测试</p> </li><li> <p>linux下docker desktop 会出现各种问题，最好用命令行操作</p> </li><li> <p>发布镜像时， 需要重命名为<strong>dockerhub用户名/镜像名</strong>，然后再push</p> </li><li> <p>desktop 和 docker engine的配置并不通用, bug太多，无法使用</p> </li><li> <p>时区修改</p> <pre><code class="prism language-dockerfile">ENV TZ=Asia/Shanghai \
    DEBIAN_FRONTEND=noninteractive

RUN apt update \
    &amp;&amp; apt install -y tzdata \
    &amp;&amp; ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime \
    &amp;&amp; echo ${TZ} &gt; /etc/timezone \
    &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata \
    &amp;&amp; rm -rf /var/lib/apt/lists/*
</code></pre> </li><li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9727be5c6fcba0f061ac5a6f5ca3e677/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">电量计量芯片HLWＷ8110的前端电路设计与误差分析校正</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bb037b989e3fef99244d5eacc55aea6f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring的@Autowired注解原理分析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>