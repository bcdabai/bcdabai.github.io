<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>树莓派综合项目2：智能小车（三）无线电遥控 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="树莓派综合项目2：智能小车（三）无线电遥控" />
<meta property="og:description" content="一、介绍 阅读本篇文章前建议先参考前期文章：
树莓派基础实验34：L298N模块驱动直流电机实验
树莓派综合项目2：智能小车（一）四轮驱动
树莓派综合项目2：智能小车（二）tkinter图形界面控制
《智能小车（一）四轮驱动》中，实现了代码输入对四个电机的简单控制。《智能小车（二）tkinter图形界面控制》中，实现了本地图形界面控制小车的前进后退、转向和原地转圈。
本实验中将使用无线电遥控设备控制小车的前进后退、转向和原地转圈。使用传统无线电通信设备通信仍然是非常重要的通信方式，比如无线电台、对讲机，航模、车模、船模遥控等等。与手机移动网络、WIFI连接相比，无线电连接有它独特的优势，遥控距离远，实时性好，操作灵活，不受网络信号限制。
其它基础内容可以参考文集：树莓派基础实验。
二、组件 ★Raspberry Pi 3 B&#43;全套*1
★睿思凯Frsky XM&#43; 迷你接收机*1
★电平反向器模块*1
★睿思凯Frsky Taranis X9D PLUS SE2019遥控器*1
★L298N扩展板模块*1
★智能小车底板模块*1
★减速电机和车轮*4
★跳线若干
三、实验原理 本实验中使用的遥控系统可以自行选择其它品牌的产品，如国产的天地飞还不错。
这里的遥控器就是像电视机遥控器、空调遥控器一样可以不用接触到被控设备，而通过一个手持器件，使用无线电与被控设备进行通信，从而达到对设备的控制。
遥控器想到达到与小车通信的功能需要有两部分配合完成。即：发射器（遥控器）与接收机。遥控器上的控制杆转为无线电波发送给接收机，而接收机通过接收无线电波，读取遥控器上控制杆的读数，并转为数字信号发送到树莓派中。
接收机输出两种信号，一种是模拟信号PWM，一种是SBUS数字信号。
由于每一路遥控器通道都需要一个PWM采集器进行采集，但是对于树莓派来说不可能使用多个定时器来采集多个通道的PWM，这对于树莓派的GPIO端口资源来说十分浪费，因此我采用的就是SBUS信号，可以在一个管脚中传输多路控制信号。
S-BUS其实是一种串口通信协议，采用100000的波特率，数据位点8bits，停止位点2bits，偶效验，即8E2的串口通信。使用树莓派的串口GPIO（TXD/RXD）中的RXD端口接收接收机的SBUS输出信号，解析出每路通道的控制信号，进而控制小车行进。
但是S-BUS采用的是反向电平传输，也就是说，在S-BUS的发送端高低电平是反向的，协议中的所有高电平都被转换成低电平，协议中的所有低电平都被转换成高电平。所以在S-BUS的接收端需要增加一个高低电平反向器来进行电平反转。
关于解析无线电接收机PWM、SBUS信号的更详细内容，请参考树莓派基础实验39：解析无线电接收机PWM、SBUS信号。
四、实验步骤 第1步： 连接电路。在树莓派综合项目2：智能小车（一）四轮驱动中的接线基础上，接入电平反向器、无线电接收机。
树莓派（name）树莓派（BOARD）L298N小车扩展板GPIO.011ENAGPIO.213IN1GPIO.315IN2GPIO.112ENBGPIO.416IN3GPIO.518IN4GNDGND电池组供电负极 关于这里树莓派GND、L298N小车扩展板的电池组供电负极相连，是特殊情况下的情况，经测试发现：
如果树莓派用的是充电头供电，而L298N扩展板用的是电池组供电，这两个负极必须相连，否则马达不动。
如果树莓派用的是L298N扩展板接出来的5V供电，即两者同一个电源，则这里不用连接。
L298N小车扩展板电池组树莓派电压表头马达电池&#43;（-）电池&#43;（-）5V供电电源接口&#43;（-）&#43;（-）T1（L后）&#43;（-）T2（L前）&#43;（-）T3（R前）&#43;（-）T4（R后）&#43;（-） 树莓派（name）树莓派（BOARD）电平反向器无线电接收机A6SBUS_OUTRXD10B63.3V1VCC0V9GND5V2VCC0V14GND 这里也要注意，由于树莓派的GPIO只能接收3.3V的最高输入，所以电平反相器的电源也只能使用3.3V，若反向后接收的信号需要是5V，则电平反相器的电源就使用5V。
这里我将18650电池组换成了航模使用的格氏ACE锂电池（3S/11.1V/2200MAH/40C），电压更高，能给树莓派提供更稳定的电源，动力性也更好，效果非常不错。
第2步： 编写电机的驱动程序，文件名为motor_4w.py。与树莓派综合项目2：智能小车（一）四轮驱动中的程序完全相同。
该车的行进控制与履带车的行进控制类似：
前进和后退很简单，左右两边的方向都朝前或朝后，速度一致；
原地顺时针旋转时，左边轮子前进，右边轮子后退，速度一致；
原地逆时针旋转时，左边轮子后退，右边轮子前进，速度一致；
偏左前进时，左右两边的方向都朝前，左轮速度比右轮速度慢一点；
偏右前进时，左右两边的方向都朝前，左轮速度比右轮速度快一点；
偏左后退时，左右两边的方向都朝后，左轮速度比右轮速度慢一点；
偏右后退时，左右两边的方向都朝后，左轮速度比右轮速度快一点；
motor_4w.py：
#!/usr/bin/env python #-*- coding: utf-8 -*- #本模块只含SMPcar()一个类，用于树莓派对电机信号的控制 #通过GPIO输出信号，直接对某个电机的转动方向、速度进行控制 import RPi.GPIO as GPIO class SMPcar(): &#39;&#39;&#39;控制小车四轮动作的类&#39;&#39;&#39; ENA = 11 #使能信号A，左边两轮 IN1 = 13 #信号输入1 IN2 = 15 #信号输入2 ENB = 12 #使能信号B，右边两轮 IN3 = 16 #信号输入3 IN4 = 18 #信号输入4 GPIO." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a00c18e42ef801306dbca40a5996ef98/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-15T16:46:00+08:00" />
<meta property="article:modified_time" content="2021-05-15T16:46:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">树莓派综合项目2：智能小车（三）无线电遥控</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、介绍</h3> 
<p>  阅读本篇文章前建议先参考前期文章：<br>   <a href="https://blog.csdn.net/chinacqzgp/article/details/110918345">树莓派基础实验34：L298N模块驱动直流电机实验</a><br>   <a href="https://blog.csdn.net/chinacqzgp/article/details/114156024">树莓派综合项目2：智能小车（一）四轮驱动</a><br>   <a href="https://blog.csdn.net/chinacqzgp/article/details/114261057">树莓派综合项目2：智能小车（二）tkinter图形界面控制</a><br>   《智能小车（一）四轮驱动》中，实现了代码输入对四个电机的简单控制。《智能小车（二）tkinter图形界面控制》中，实现了本地图形界面控制小车的前进后退、转向和原地转圈。</p> 
<p>  本实验中将使用无线电遥控设备控制小车的前进后退、转向和原地转圈。使用传统无线电通信设备通信仍然是非常重要的通信方式，比如无线电台、对讲机，航模、车模、船模遥控等等。与手机移动网络、WIFI连接相比，无线电连接有它独特的优势，遥控距离远，实时性好，操作灵活，不受网络信号限制。</p> 
<p>  其它基础内容可以参考文集：<a href="https://blog.csdn.net/chinacqzgp/category_9946036.html">树莓派基础实验</a>。</p> 
<h3><a id="_14"></a>二、组件</h3> 
<p>★Raspberry Pi 3 B+全套*1</p> 
<p>★睿思凯Frsky XM+ 迷你接收机*1</p> 
<p>★电平反向器模块*1</p> 
<p>★睿思凯Frsky Taranis X9D PLUS SE2019遥控器*1</p> 
<p>★L298N扩展板模块*1</p> 
<p>★智能小车底板模块*1</p> 
<p>★减速电机和车轮*4</p> 
<p>★跳线若干</p> 
<h3><a id="_33"></a>三、实验原理</h3> 
<p>本实验中使用的遥控系统可以自行选择其它品牌的产品，如国产的天地飞还不错。</p> 
<p><img src="https://images2.imgbox.com/a5/24/Lxuol8Tg_o.png" alt="睿思凯Frsky Taranis X9D PLUS SE2019遥控器"><br> 这里的遥控器就是像电视机遥控器、空调遥控器一样可以不用接触到被控设备，而通过一个手持器件，使用无线电与被控设备进行通信，从而达到对设备的控制。</p> 
<p>遥控器想到达到与小车通信的功能需要有两部分配合完成。即：发射器（遥控器）与接收机。遥控器上的控制杆转为无线电波发送给接收机，而接收机通过接收无线电波，读取遥控器上控制杆的读数，并转为数字信号发送到树莓派中。</p> 
<p>接收机输出两种信号，一种是模拟信号PWM，一种是SBUS数字信号。</p> 
<p><img src="https://images2.imgbox.com/c6/45/DpWlU8db_o.png" alt="Frsky XM+接收机"></p> 
<p><img src="https://images2.imgbox.com/54/b2/SioZ1BWy_o.png" alt="Frsky XM+ 参数"></p> 
<p>由于每一路遥控器通道都需要一个PWM采集器进行采集，但是对于树莓派来说不可能使用多个定时器来采集多个通道的PWM，这对于树莓派的GPIO端口资源来说十分浪费，因此我采用的就是SBUS信号，可以在一个管脚中传输多路控制信号。</p> 
<p>S-BUS其实是一种串口通信协议，采用100000的波特率，数据位点8bits，停止位点2bits，偶效验，即8E2的串口通信。使用树莓派的串口GPIO（TXD/RXD）中的RXD端口接收接收机的SBUS输出信号，解析出每路通道的控制信号，进而控制小车行进。</p> 
<p>但是S-BUS采用的是反向电平传输，也就是说，在S-BUS的发送端高低电平是反向的，协议中的所有高电平都被转换成低电平，协议中的所有低电平都被转换成高电平。所以在S-BUS的接收端需要增加一个高低电平反向器来进行电平反转。<br> <img src="https://images2.imgbox.com/d9/9b/MZS85rHQ_o.png" alt="电平反相器"></p> 
<p>关于解析无线电接收机PWM、SBUS信号的更详细内容，请参考<a href="https://blog.csdn.net/chinacqzgp/article/details/116664101">树莓派基础实验39：解析无线电接收机PWM、SBUS信号</a>。</p> 
<h3><a id="_59"></a>四、实验步骤</h3> 
<p>  <strong>第1步：</strong> 连接电路。在<a href="https://blog.csdn.net/chinacqzgp/article/details/114156024">树莓派综合项目2：智能小车（一）四轮驱动</a>中的接线基础上，接入电平反向器、无线电接收机。</p> 
<table><thead><tr><th align="center">树莓派（name）</th><th align="center">树莓派（BOARD）</th><th align="center">L298N小车扩展板</th></tr></thead><tbody><tr><td align="center">GPIO.0</td><td align="center">11</td><td align="center">ENA</td></tr><tr><td align="center">GPIO.2</td><td align="center">13</td><td align="center">IN1</td></tr><tr><td align="center">GPIO.3</td><td align="center">15</td><td align="center">IN2</td></tr><tr><td align="center">GPIO.1</td><td align="center">12</td><td align="center">ENB</td></tr><tr><td align="center">GPIO.4</td><td align="center">16</td><td align="center">IN3</td></tr><tr><td align="center">GPIO.5</td><td align="center">18</td><td align="center">IN4</td></tr><tr><td align="center">GND</td><td align="center">GND</td><td align="center">电池组供电负极</td></tr></tbody></table> 
<blockquote> 
 <p>关于这里树莓派GND、L298N小车扩展板的电池组供电负极相连，是特殊情况下的情况，经测试发现：<br> 如果树莓派用的是充电头供电，而L298N扩展板用的是电池组供电，这两个负极必须相连，否则马达不动。<br> 如果树莓派用的是L298N扩展板接出来的5V供电，即两者同一个电源，则这里不用连接。</p> 
</blockquote> 
<table><thead><tr><th align="center">L298N小车扩展板</th><th align="center">电池组</th><th align="center">树莓派</th><th align="center">电压表头</th><th align="center">马达</th></tr></thead><tbody><tr><td align="center">电池+（-）</td><td align="center">电池+（-）</td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">5V供电</td><td align="center"></td><td align="center">电源接口</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">+（-）</td><td align="center"></td><td align="center"></td><td align="center">+（-）</td><td align="center"></td></tr><tr><td align="center">T1（L后）</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">+（-）</td></tr><tr><td align="center">T2（L前）</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">+（-）</td></tr><tr><td align="center">T3（R前）</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">+（-）</td></tr><tr><td align="center">T4（R后）</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">+（-）</td></tr></tbody></table> 
<table><thead><tr><th align="center">树莓派（name）</th><th align="center">树莓派（BOARD）</th><th align="center">电平反向器</th><th align="center">无线电接收机</th></tr></thead><tbody><tr><td align="center"></td><td align="center"></td><td align="center">A6</td><td align="center">SBUS_OUT</td></tr><tr><td align="center">RXD</td><td align="center">10</td><td align="center">B6</td><td align="center"></td></tr><tr><td align="center">3.3V</td><td align="center">1</td><td align="center">VCC</td><td align="center"></td></tr><tr><td align="center">0V</td><td align="center">9</td><td align="center">GND</td><td align="center"></td></tr><tr><td align="center">5V</td><td align="center">2</td><td align="center"></td><td align="center">VCC</td></tr><tr><td align="center">0V</td><td align="center">14</td><td align="center"></td><td align="center">GND</td></tr></tbody></table> 
<blockquote> 
 <p>这里也要注意，由于树莓派的GPIO只能接收3.3V的最高输入，所以电平反相器的电源也只能使用3.3V，若反向后接收的信号需要是5V，则电平反相器的电源就使用5V。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/25/ec/k3hqzMDB_o.png" alt="智能遥控小车电路图"></p> 
<p><img src="https://images2.imgbox.com/e9/95/QGM1olMu_o.png" alt="树莓派智能小车"></p> 
<p>这里我将18650电池组换成了航模使用的格氏ACE锂电池（3S/11.1V/2200MAH/40C），电压更高，能给树莓派提供更稳定的电源，动力性也更好，效果非常不错。</p> 
<p>  <strong>第2步：</strong> 编写电机的驱动程序，文件名为motor_4w.py。与<a href="https://www.jianshu.com/p/712fa968e9d6" rel="nofollow">树莓派综合项目2：智能小车（一）四轮驱动</a>中的程序完全相同。</p> 
<p>  该车的行进控制与履带车的行进控制类似：</p> 
<blockquote> 
 <p>前进和后退很简单，左右两边的方向都朝前或朝后，速度一致；<br> 原地顺时针旋转时，左边轮子前进，右边轮子后退，速度一致；<br> 原地逆时针旋转时，左边轮子后退，右边轮子前进，速度一致；<br> 偏左前进时，左右两边的方向都朝前，左轮速度比右轮速度慢一点；<br> 偏右前进时，左右两边的方向都朝前，左轮速度比右轮速度快一点；<br> 偏左后退时，左右两边的方向都朝后，左轮速度比右轮速度慢一点；<br> 偏右后退时，左右两边的方向都朝后，左轮速度比右轮速度快一点；</p> 
</blockquote> 
<p>motor_4w.py：</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#-*- coding: utf-8 -*-</span>
<span class="token comment">#本模块只含SMPcar()一个类，用于树莓派对电机信号的控制</span>
<span class="token comment">#通过GPIO输出信号，直接对某个电机的转动方向、速度进行控制</span>

<span class="token keyword">import</span> RPi<span class="token punctuation">.</span>GPIO <span class="token keyword">as</span> GPIO

<span class="token keyword">class</span> <span class="token class-name">SMPcar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''控制小车四轮动作的类'''</span>
    ENA <span class="token operator">=</span> <span class="token number">11</span>  <span class="token comment">#使能信号A，左边两轮</span>
    IN1 <span class="token operator">=</span> <span class="token number">13</span>  <span class="token comment">#信号输入1</span>
    IN2 <span class="token operator">=</span> <span class="token number">15</span>  <span class="token comment">#信号输入2</span>
    ENB <span class="token operator">=</span> <span class="token number">12</span>  <span class="token comment">#使能信号B，右边两轮</span>
    IN3 <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment">#信号输入3</span>
    IN4 <span class="token operator">=</span> <span class="token number">18</span>  <span class="token comment">#信号输入4</span>

    GPIO<span class="token punctuation">.</span>setwarnings<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment">#关闭警告</span>

    <span class="token keyword">def</span> <span class="token function">setGPIO</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''初始化引脚'''</span>
        GPIO<span class="token punctuation">.</span>setmode<span class="token punctuation">(</span>GPIO<span class="token punctuation">.</span>BOARD<span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>SMPcar<span class="token punctuation">.</span>ENA<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>SMPcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>SMPcar<span class="token punctuation">.</span>IN2<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
        
        GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>SMPcar<span class="token punctuation">.</span>ENB<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>SMPcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>SMPcar<span class="token punctuation">.</span>IN4<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">pwm</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>pwm<span class="token punctuation">)</span><span class="token punctuation">:</span> 
        <span class="token triple-quoted-string string">'''初始化PWM（脉宽调制），返回PWM对象'''</span>
        EN_pwm <span class="token operator">=</span> GPIO<span class="token punctuation">.</span>PWM<span class="token punctuation">(</span>pwm<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
        EN_pwm<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> EN_pwm

    <span class="token keyword">def</span> <span class="token function">changespeed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>pwm<span class="token punctuation">,</span>speed<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''通过改变占空比改变马达转速'''</span>
        pwm<span class="token punctuation">.</span>ChangeDutyCycle<span class="token punctuation">(</span>speed<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">clockwise</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in1_pin<span class="token punctuation">,</span>in2_pin<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''马达顺时针转的信号'''</span>
        GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span>in1_pin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span>in2_pin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
 
    <span class="token keyword">def</span> <span class="token function">counter_clockwise</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in1_pin<span class="token punctuation">,</span>in2_pin<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''马达逆时针转的信号'''</span>
        GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span>in1_pin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span>in2_pin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">stop_car</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in1_pin<span class="token punctuation">,</span>in2_pin<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''马达制动的信号'''</span>
        GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span>in1_pin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span>in2_pin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token comment">#使能信号为低电平，或者高电平（占空比设为100，IN1和IN2都为0或1时）马达制动</span>
        
    <span class="token keyword">def</span> <span class="token function">destroy</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''结束程序时清空GPIO状态'''</span>
        A<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        B<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        GPIO<span class="token punctuation">.</span>cleanup<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># Release resource</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>     <span class="token comment"># 本模块单独测试时运行使用</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        smpcar <span class="token operator">=</span> SMPcar<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#创建树莓派小车对象</span>
        smpcar<span class="token punctuation">.</span>setGPIO<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#初始化引脚</span>

        ENA_pwm<span class="token operator">=</span>smpcar<span class="token punctuation">.</span>pwm<span class="token punctuation">(</span>smpcar<span class="token punctuation">.</span>ENA<span class="token punctuation">)</span> <span class="token comment">#初始化使能信号PWM，A为左边车轮</span>
        ENB_pwm<span class="token operator">=</span>smpcar<span class="token punctuation">.</span>pwm<span class="token punctuation">(</span>smpcar<span class="token punctuation">.</span>ENB<span class="token punctuation">)</span> <span class="token comment">#初始化使能信号PWM，B为右边车轮</span>
        
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">'''通过输入的命令改变马达转动'''</span>
            cmd <span class="token operator">=</span> <span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token string">"Command, E.g. ff30ff30 :"</span><span class="token punctuation">)</span>
            direction <span class="token operator">=</span> cmd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">#只输入字母b时，小车刹车</span>
            A_direction <span class="token operator">=</span> cmd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">#字符串0/1两位为控制A（左边车轮）方向信号</span>
            B_direction <span class="token operator">=</span> cmd<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token comment">#4/5位为控制B（右边车轮）方向信号</span>
        
            A_speed <span class="token operator">=</span> cmd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment">#字符串2/3两位为控制A（左边车轮）速度信号</span>
            B_speed <span class="token operator">=</span> cmd<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token comment">#字符串6/7两位为控制B（右边车轮）速度信号</span>
            <span class="token keyword">print</span> <span class="token punctuation">(</span>A_direction<span class="token punctuation">,</span>B_direction<span class="token punctuation">,</span>A_speed<span class="token punctuation">,</span>B_speed<span class="token punctuation">)</span> <span class="token comment">#测试用</span>
        
            <span class="token keyword">if</span> A_direction <span class="token operator">==</span> <span class="token string">"ff"</span><span class="token punctuation">:</span> <span class="token comment">#控制A（左边车轮）顺时针信号</span>
                smpcar<span class="token punctuation">.</span>clockwise<span class="token punctuation">(</span>smpcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span>smpcar<span class="token punctuation">.</span>IN2<span class="token punctuation">)</span>
            <span class="token keyword">if</span> A_direction <span class="token operator">==</span> <span class="token string">"00"</span><span class="token punctuation">:</span> <span class="token comment">#控制A（左边车轮）逆时针信号</span>
                smpcar<span class="token punctuation">.</span>counter_clockwise<span class="token punctuation">(</span>smpcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span>smpcar<span class="token punctuation">.</span>IN2<span class="token punctuation">)</span>
            <span class="token keyword">if</span> B_direction <span class="token operator">==</span> <span class="token string">"ff"</span><span class="token punctuation">:</span> <span class="token comment">#控制B（右边车轮）顺时针信号</span>
                smpcar<span class="token punctuation">.</span>clockwise<span class="token punctuation">(</span>smpcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span>smpcar<span class="token punctuation">.</span>IN4<span class="token punctuation">)</span>
            <span class="token keyword">if</span> B_direction <span class="token operator">==</span> <span class="token string">"00"</span><span class="token punctuation">:</span> <span class="token comment">#控制B（右边车轮）逆时针信号</span>
                smpcar<span class="token punctuation">.</span>counter_clockwise<span class="token punctuation">(</span>smpcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span>smpcar<span class="token punctuation">.</span>IN4<span class="token punctuation">)</span>

            <span class="token keyword">if</span> direction <span class="token operator">==</span> <span class="token string">"b"</span><span class="token punctuation">:</span> <span class="token comment">#小车刹车，IN1和IN2都为0，马达制动</span>
                smpcar<span class="token punctuation">.</span>stop_car<span class="token punctuation">(</span>smpcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span>smpcar<span class="token punctuation">.</span>IN2<span class="token punctuation">)</span>
                smpcar<span class="token punctuation">.</span>stop_car<span class="token punctuation">(</span>smpcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span>smpcar<span class="token punctuation">.</span>IN4<span class="token punctuation">)</span>
                <span class="token keyword">continue</span> <span class="token comment">#跳出本次循环</span>

            <span class="token comment"># 通过输入的两位数字设置占空比，改变马达转速</span>
            smpcar<span class="token punctuation">.</span>changespeed<span class="token punctuation">(</span>ENA_pwm<span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>A_speed<span class="token punctuation">)</span><span class="token punctuation">)</span>
            smpcar<span class="token punctuation">.</span>changespeed<span class="token punctuation">(</span>ENB_pwm<span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>B_speed<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>  <span class="token comment"># When 'Ctrl+C' is pressed, the child program destroy() will be  executed.</span>
        smpcar<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span>ENA_pwm<span class="token punctuation">,</span>ENB_pwm<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        smpcar<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span>ENA_pwm<span class="token punctuation">,</span>ENB_pwm<span class="token punctuation">)</span>

</code></pre> 
<p>  <strong>第3步：</strong> 小车行进控制模块，文件名为moving_control.py，设计小车的移动行为，方向控制分为：原地左转弯、原地右转弯、直线前进、直线后退、刹车，而向前左偏移开进或右偏移开进等，由左右两边不同的速度（油门）来控制。<br> moving_control.py:</p> 
<pre><code class="prism language-python"><span class="token comment">#-*- coding: utf-8 -*-</span>
<span class="token comment">#本模块只含MovingControl()一个类，针对遥控器的控制方式，设计小车的移动行为</span>
<span class="token comment">#方向控制分为：原地左转弯、原地右转弯、直线前进、直线后退、刹车</span>
<span class="token comment">#而向前左偏移开进或右偏移开进等，由左右两边不同的速度（油门）来控制</span>

<span class="token keyword">class</span> <span class="token class-name">MovingControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> smpcar<span class="token punctuation">,</span>pwm1<span class="token punctuation">,</span>pwm2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>smpcar<span class="token operator">=</span>smpcar
        self<span class="token punctuation">.</span>ENA_pwm<span class="token operator">=</span>pwm1
        self<span class="token punctuation">.</span>ENB_pwm<span class="token operator">=</span>pwm2
        self<span class="token punctuation">.</span>rudder_value <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>acc_value <span class="token operator">=</span> <span class="token number">0</span>
        
    <span class="token keyword">def</span> <span class="token function">accelerator</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>rate_left<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>rate_right<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''速度（油门）控制'''</span>
		<span class="token comment">#rate_left为向左偏移行进时，降低左边轮的速度</span>
		<span class="token comment">#rate_right为向右偏移行进时，降低右边轮的速度</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>changespeed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ENA_pwm<span class="token punctuation">,</span>self<span class="token punctuation">.</span>acc_value <span class="token operator">*</span> rate_left<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>changespeed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ENB_pwm<span class="token punctuation">,</span>self<span class="token punctuation">.</span>acc_value <span class="token operator">*</span> rate_right<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">leftTurn</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''原地左转弯'''</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>counter_clockwise<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN2<span class="token punctuation">)</span> <span class="token comment">#左边车轮后退</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>clockwise<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN4<span class="token punctuation">)</span> <span class="token comment">#右边车轮前进</span>
        
    <span class="token keyword">def</span> <span class="token function">rightTurn</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''原地右转弯'''</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>clockwise<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN2<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>counter_clockwise<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN4<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''直线前进'''</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>clockwise<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN2<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>clockwise<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN4<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">reverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''直线后退'''</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>counter_clockwise<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN2<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>counter_clockwise<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN4<span class="token punctuation">)</span>
       
    <span class="token keyword">def</span> <span class="token function">brake</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''刹车'''</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>stop_car<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN1<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN2<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>stop_car<span class="token punctuation">(</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN3<span class="token punctuation">,</span>self<span class="token punctuation">.</span>smpcar<span class="token punctuation">.</span>IN4<span class="token punctuation">)</span>

</code></pre> 
<p>  <strong>第4步：</strong> 编写SBUS信号接收解析模块，文件名为sbus_receiver_pi.py，与<a href="https://www.jianshu.com/p/8b8ce1da7551" rel="nofollow">树莓派基础实验39：解析无线电接收机PWM、SBUS信号</a>中的Python2程序有所不同，下面的程序在Python3中运行，并标注了两者的不同之处。<br> sbus_receiver_pi.py：</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#-*- coding: utf-8 -*-</span>
<span class="token comment">#本模块只含SBUSReceiver()一个类，用于获取和解析遥控器接收机的SBUS输出信号</span>
<span class="token comment">#并能返回每个通道的数值，遥控器的failsafe信号状态，每次获得数据帧的长度和这次数据的延迟时间</span>

<span class="token comment">#import array #python2运行时需要，array模块是python中实现的一种高效的数组存储类型</span>
<span class="token keyword">import</span> serial <span class="token comment">#serial模块封装了对串行端口的访问</span>
<span class="token comment">#import binascii #python2运行时需要，binascii模块包含很多在二进制和ASCII编码的二进制表示转换的方法</span>
<span class="token comment">#import codecs #python2运行时需要，Python中专门用作编码转换的模块</span>
<span class="token keyword">import</span> time

<span class="token keyword">class</span> <span class="token class-name">SBUSReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> _uart_port<span class="token operator">=</span><span class="token string">'/dev/ttyAMA0'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment">#初始化树莓派串口参数</span>
        self<span class="token punctuation">.</span>ser <span class="token operator">=</span> serial<span class="token punctuation">.</span>Serial<span class="token punctuation">(</span>
            port<span class="token operator">=</span>_uart_port<span class="token punctuation">,</span>            <span class="token comment">#树莓派的硬件串口/dev/ttyAMA0</span>
            baudrate <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">,</span>          <span class="token comment">#波特率为100k</span>
            parity<span class="token operator">=</span>serial<span class="token punctuation">.</span>PARITY_EVEN<span class="token punctuation">,</span>  <span class="token comment">#偶校验</span>
            stopbits<span class="token operator">=</span>serial<span class="token punctuation">.</span>STOPBITS_TWO<span class="token punctuation">,</span><span class="token comment">#2个停止位</span>
            bytesize<span class="token operator">=</span>serial<span class="token punctuation">.</span>EIGHTBITS<span class="token punctuation">,</span>   <span class="token comment">#8个数据位</span>
            timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 常数</span>
		<span class="token comment">#这里注意：Python2 与Python3 的编码方式是不同的</span>
        <span class="token comment">#self.START_BYTE = b'\x0f'   #python2运行时用这句，起始字节为0x0f</span>
		<span class="token comment">#self.END_BYTE = b'\x00'     #python2运行时用这句，结束字节为0x00</span>
        self<span class="token punctuation">.</span>START_BYTE <span class="token operator">=</span> <span class="token number">0x0f</span>  <span class="token comment">#python3运行时用这句，起始字节为0x0f</span>
        self<span class="token punctuation">.</span>END_BYTE <span class="token operator">=</span> <span class="token number">0x00</span>    <span class="token comment">#python3运行时用这句，结束字节为0x00</span>
        self<span class="token punctuation">.</span>SBUS_FRAME_LEN <span class="token operator">=</span> <span class="token number">25</span>    <span class="token comment">#SBUS帧有25个字节</span>
        self<span class="token punctuation">.</span>SBUS_NUM_CHAN <span class="token operator">=</span> <span class="token number">18</span>     <span class="token comment">#18个通道</span>
        self<span class="token punctuation">.</span>OUT_OF_SYNC_THD <span class="token operator">=</span> <span class="token number">10</span>
        self<span class="token punctuation">.</span>SBUS_NUM_CHANNELS <span class="token operator">=</span> <span class="token number">18</span> <span class="token comment">#18个通道</span>
        self<span class="token punctuation">.</span>SBUS_SIGNAL_OK <span class="token operator">=</span> <span class="token number">0</span>     <span class="token comment">#信号正常为0</span>
        self<span class="token punctuation">.</span>SBUS_SIGNAL_LOST <span class="token operator">=</span> <span class="token number">1</span>       <span class="token comment">#信号丢失为1</span>
        self<span class="token punctuation">.</span>SBUS_SIGNAL_FAILSAFE <span class="token operator">=</span> <span class="token number">2</span>   <span class="token comment">#输出failsafe信号时为2</span>

        <span class="token comment"># 堆栈变量初始化</span>
        self<span class="token punctuation">.</span>isReady <span class="token operator">=</span> <span class="token boolean">True</span>
        self<span class="token punctuation">.</span>lastFrameTime <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>sbusBuff <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 用于同步的单个字节</span>
		
        <span class="token comment">#bytearray(n) 方法返回一个长度为n的初始化数组；</span>
	<span class="token triple-quoted-string string">'''这里Python2与Python3存储数据的编码格式会不同'''</span>
        self<span class="token punctuation">.</span>sbusFrame <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>  <span class="token comment"># 单个SBUS数据帧，25个字节</span>
		
		<span class="token comment"># 接收到的各频道值，前面的Python2中使用了数组</span>
        <span class="token comment">#self.sbusChannels = array.array('H', [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0])  </span>
		<span class="token comment">#array.array(typecode,[initializer]) --typecode:元素类型代码；initializer:初始化器，若数组为空，则省略初始化器</span>
		<span class="token comment"># 接收到的各频道值，Python3中这里也可以使用列表</span>
        self<span class="token punctuation">.</span>sbusChannels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>failSafeStatus <span class="token operator">=</span> self<span class="token punctuation">.</span>SBUS_SIGNAL_FAILSAFE

    <span class="token keyword">def</span> <span class="token function">get_rx_channels</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        用于读取最后的SBUS通道值
        返回:由18个无符号短元素组成的数组，包含16个标准通道值+ 2个数字(ch17和18)
        """</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>sbusChannels

    <span class="token keyword">def</span> <span class="token function">get_rx_channel</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_ch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        用于读取最后的SBUS某一特定通道的值
        num_ch: 要读取的某个通道的通道序号
        返回:某一通道的值
        """</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span>num_ch<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">get_failsafe_status</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        用于获取最后的FAILSAFE状态
        返回: FAILSAFE状态值
        """</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>failSafeStatus

    <span class="token keyword">def</span> <span class="token function">decode_frame</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        对每帧数据进行解码，每个通道的值在两个或三个不同的字节之间，要读取出来很麻烦
        不过futaba已经发布了下面的解码代码
        """</span>
        <span class="token keyword">def</span> <span class="token function">toInt</span><span class="token punctuation">(</span>_from<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#encode() 方法以指定的编码格式编码字符串。</span>
            <span class="token comment">#int() 函数用于将一个字符串或数字转换为整型。</span>
            
            <span class="token comment">#return int(codecs.encode(_from, 'hex'), 16) #Python2中要使用这句，转换编码格式</span>
            <span class="token keyword">return</span> _from      <span class="token comment">#Python3中要使用这句，即不用转换编码格式</span>
            
        <span class="token comment">#CH1 = [data2]的低3位 + [data1]的8位（678+12345678 = 678,12345678）</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span>                                   <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">#CH2 = [data3]的低6位 + [data2]的高5位（345678+12345 = 345678,12345 ）</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">3</span>   <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span>                                   <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">#CH3 = [data5]的低1位 + [data4]的8位 + [data3]的高2位（8+12345678+12 = 8,12345678,12）</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span>   <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span> <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>     <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span>   <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span>                                   <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span>   <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span>                                   <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span>   <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span> <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span>      <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span>   <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span>                                  <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">5</span>  <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>                                  <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span>                                  <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">3</span>  <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span>                                  <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span>  <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span>  <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span>                                  <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span>  <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span>                                  <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span>  <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span>     <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span>  <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span>                                  <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">5</span>  <span class="token operator">|</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>                                  <span class="token operator">&amp;</span> <span class="token number">0x07FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">#17频道，第24字节的最低一位</span>
        <span class="token keyword">if</span> toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span> <span class="token number">0x0001</span> <span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2047</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment">#18频道，第24字节的低第二位，所以要右移一位</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0001</span> <span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2047</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>sbusChannels<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment">#帧丢失位为1时，第24字节的低第三位，与0x04进行与运算</span>
        self<span class="token punctuation">.</span>failSafeStatus <span class="token operator">=</span> self<span class="token punctuation">.</span>SBUS_SIGNAL_OK
        <span class="token keyword">if</span> toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>failSafeStatus <span class="token operator">=</span> self<span class="token punctuation">.</span>SBUS_SIGNAL_LOST
        <span class="token comment">#故障保护激活位为1时，第24字节的低第四位，与0x08进行与运算   </span>
        <span class="token keyword">if</span> toInt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sbusFrame<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>failSafeStatus <span class="token operator">=</span> self<span class="token punctuation">.</span>SBUS_SIGNAL_FAILSAFE


    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        我们需要至少2帧大小，以确保找到一个完整的帧
        所以我们取出所有的缓存（清空它），读取全部数据，直到捕获新的数据
        首先找到END BYTE并向后查找SBUS_FRAME_LEN，看看它是否是START BYTE
        """</span>

        <span class="token comment">#我们是否有足够的数据在缓冲区和有没有线程在后台?</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>ser<span class="token punctuation">.</span>inWaiting<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>SBUS_FRAME_LEN<span class="token operator">*</span><span class="token number">2</span> <span class="token operator">and</span> self<span class="token punctuation">.</span>isReady<span class="token punctuation">:</span> <span class="token comment">#inWaiting()返回接收缓存中的字节数</span>
            self<span class="token punctuation">.</span>isReady <span class="token operator">=</span> <span class="token boolean">False</span>    <span class="token comment">#表明有线程在运行，isReady = False</span>
            
            <span class="token comment"># 读取所有临时帧数据</span>
            tempFrame <span class="token operator">=</span> self<span class="token punctuation">.</span>ser<span class="token punctuation">.</span>read<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ser<span class="token punctuation">.</span>inWaiting<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 在缓冲区帧的每个字符中，我们寻找结束字节</span>
            <span class="token keyword">for</span> end <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>SBUS_FRAME_LEN<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment">#寻找结束字节，从后向前查找</span>
                <span class="token keyword">if</span> tempFrame<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>tempFrame<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>end<span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>END_BYTE <span class="token punctuation">:</span>
                    <span class="token comment">#从最后的命中点减去SBUS_FRAME_LEN寻找起始字节</span>
                    <span class="token keyword">if</span> tempFrame<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>tempFrame<span class="token punctuation">)</span><span class="token operator">-</span>end<span class="token operator">-</span>self<span class="token punctuation">.</span>SBUS_FRAME_LEN<span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>START_BYTE <span class="token punctuation">:</span>
                        <span class="token comment"># 如果相等，则帧数据正确，数据以8E2包到达，因此它已经被校验过</span>
                        <span class="token comment"># 从临时帧数据中取出刚验证正确的一段正确帧数据</span>
                        lastUpdate <span class="token operator">=</span> tempFrame<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>tempFrame<span class="token punctuation">)</span><span class="token operator">-</span>end<span class="token operator">-</span>self<span class="token punctuation">.</span>SBUS_FRAME_LEN<span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>tempFrame<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>end<span class="token punctuation">]</span>
                        <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>sbusFrame <span class="token operator">==</span> lastUpdate<span class="token punctuation">:</span> <span class="token comment">#相等即表示没有操作，不用再次解码</span>
                            self<span class="token punctuation">.</span>sbusFrame <span class="token operator">=</span> lastUpdate
                            self<span class="token punctuation">.</span>decode_frame<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#调用解码函数</span>

                        self<span class="token punctuation">.</span>lastFrameTime <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 跟踪最近的更新时间</span>
                        self<span class="token punctuation">.</span>isReady <span class="token operator">=</span> <span class="token boolean">True</span>
                        <span class="token keyword">break</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    sbus <span class="token operator">=</span> SBUSReceiver<span class="token punctuation">(</span><span class="token string">'/dev/ttyAMA0'</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">)</span>

        <span class="token comment"># X8R的SBUS信号是间隔6ms发送一次，一次持续发送3ms；</span>
        <span class="token comment"># 不要调用sbus.update()太快，如果sbus.ser.inWaiting()&gt;50,且增长很多，可以调用sbus.update()快点，即time.sleep()延迟短点；</span>
        <span class="token comment"># 如果sbus.ser.inWaiting()&lt;50,可以调用sbus.update()慢点，即time.sleep()延迟长点；</span>
        sbus<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">#在您的代码中，您可以调用sbus.get_rx_channels()来获取所有数据，或者调用sbus.get_rx_channels()[n]来获取第n个通道的值；</span>
        <span class="token comment">#或get_rx_channel(self, num_ch)来获得第num_ch个通道的值；</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>sbus<span class="token punctuation">.</span>get_failsafe_status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sbus<span class="token punctuation">.</span>get_rx_channels<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>sbus<span class="token punctuation">.</span>ser<span class="token punctuation">.</span>inWaiting<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>sbus<span class="token punctuation">.</span>lastFrameTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">#str() 函数将对象转化为适于人阅读的形式，将指定的值转换为字符串。</span>
        <span class="token comment">#zfill() 方法返回指定长度的字符串，原字符串右对齐，前面填充0。</span>
        <span class="token comment">#(time.time()-sbus.lastFrameTime)用于展示得到最近这次数据的延迟</span>

</code></pre> 
<p>  <strong>第5步：</strong> 编写树莓派智能小车的主程序，文件名为smartcar.py，将这4个Python文件放入一个文件夹后，只运行本文件就可以了。<br> smartcar.py：</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#-*- coding: utf-8 -*-</span>
<span class="token comment">#本模块为树莓派小车的主程序</span>
<span class="token keyword">from</span> motor_4w <span class="token keyword">import</span> SMPcar
<span class="token keyword">from</span> sbus_receiver_pi <span class="token keyword">import</span> SBUSReceiver
<span class="token keyword">from</span> moving_control <span class="token keyword">import</span> MovingControl
<span class="token keyword">import</span> time

<span class="token keyword">try</span><span class="token punctuation">:</span>
    sbus_receiver <span class="token operator">=</span> SBUSReceiver<span class="token punctuation">(</span><span class="token string">'/dev/ttyAMA0'</span><span class="token punctuation">)</span> <span class="token comment">#初始化实例</span>
    smp_car <span class="token operator">=</span> SMPcar<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#初始化实例</span>
    smp_car<span class="token punctuation">.</span>setGPIO<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#初始化引脚</span>
    
    ENA_pwm <span class="token operator">=</span> smp_car<span class="token punctuation">.</span>pwm<span class="token punctuation">(</span>smp_car<span class="token punctuation">.</span>ENA<span class="token punctuation">)</span> <span class="token comment">#初始化使能信号PWM，A为左边车轮</span>
    ENB_pwm <span class="token operator">=</span> smp_car<span class="token punctuation">.</span>pwm<span class="token punctuation">(</span>smp_car<span class="token punctuation">.</span>ENB<span class="token punctuation">)</span> <span class="token comment">#初始化使能信号PWM，B为右边车轮</span>
    
    smartcar <span class="token operator">=</span> MovingControl<span class="token punctuation">(</span>smp_car<span class="token punctuation">,</span>ENA_pwm<span class="token punctuation">,</span>ENB_pwm<span class="token punctuation">)</span>  <span class="token comment">##初始化实例</span>
    
    acc_value_sbus <span class="token operator">=</span> <span class="token number">172</span>  <span class="token comment">#3通道，即油门的值，最低时为172</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">)</span>
        sbus_receiver<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#获取一个完整的帧数据</span>
            
        aileron_value <span class="token operator">=</span> sbus_receiver<span class="token punctuation">.</span>get_rx_channel<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#1通道为副翼通道，这里控制车原地转向</span>
        elevator_value <span class="token operator">=</span> sbus_receiver<span class="token punctuation">.</span>get_rx_channel<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#2通道为升降舵通道，这里控制车前进后退</span>
        smartcar<span class="token punctuation">.</span>rudder_value <span class="token operator">=</span> sbus_receiver<span class="token punctuation">.</span>get_rx_channel<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#4通道为方向舵通道，这里控制车左右偏移行进</span>
            
        <span class="token keyword">if</span> sbus_receiver<span class="token punctuation">.</span>get_rx_channel<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            acc_value_sbus <span class="token operator">=</span> sbus_receiver<span class="token punctuation">.</span>get_rx_channel<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">#3通道为油门通道，这里控制车速度</span>
		<span class="token comment">#将172~1811的油门通道值转换为0~100的占空比信号，</span>
        smartcar<span class="token punctuation">.</span>acc_value <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token punctuation">(</span>acc_value_sbus<span class="token operator">-</span><span class="token number">172</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1811</span><span class="token operator">-</span><span class="token number">172</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           
        <span class="token keyword">if</span> <span class="token number">970</span> <span class="token operator">&lt;</span> smartcar<span class="token punctuation">.</span>rudder_value <span class="token operator">&lt;</span> <span class="token number">1100</span><span class="token punctuation">:</span> <span class="token comment">#没有左右偏移时，中间值为992，但遥控器微调时会有上下浮动</span>
            smartcar<span class="token punctuation">.</span>accelerator<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> smartcar<span class="token punctuation">.</span>rudder_value <span class="token operator">&gt;=</span><span class="token number">1100</span><span class="token punctuation">:</span>      <span class="token comment">#向右偏移行进时</span>
            rate_right <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1811.0</span> <span class="token operator">-</span> smartcar<span class="token punctuation">.</span>rudder_value<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1811</span><span class="token operator">-</span><span class="token number">1100</span><span class="token punctuation">)</span> 
			<span class="token comment">#最大值一般为1811，这里使用浮点类型，所以一定要使用1811.0</span>
            smartcar<span class="token punctuation">.</span>accelerator<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>rate_right<span class="token punctuation">)</span>
            
        <span class="token keyword">elif</span> smartcar<span class="token punctuation">.</span>rudder_value <span class="token operator">&lt;=</span><span class="token number">970</span><span class="token punctuation">:</span>       <span class="token comment">#向左偏移行进时</span>
            rate_left <span class="token operator">=</span> <span class="token punctuation">(</span>smartcar<span class="token punctuation">.</span>rudder_value <span class="token operator">-</span> <span class="token number">172.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">970</span><span class="token operator">-</span><span class="token number">172</span><span class="token punctuation">)</span>  
			<span class="token comment">#最小值为172，这里使用浮点类型，所以一定要使用172.0</span>
            smartcar<span class="token punctuation">.</span>accelerator<span class="token punctuation">(</span>rate_left<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>elevator_value<span class="token punctuation">,</span>smartcar<span class="token punctuation">.</span>acc_value<span class="token punctuation">,</span>aileron_value<span class="token punctuation">,</span>smartcar<span class="token punctuation">.</span>rudder_value<span class="token punctuation">)</span><span class="token comment">#测试数据用</span>
            
        <span class="token keyword">if</span> aileron_value <span class="token operator">&gt;=</span> <span class="token number">1100</span><span class="token punctuation">:</span>  <span class="token comment">#原地左转弯</span>
            smartcar<span class="token punctuation">.</span>leftTurn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> aileron_value <span class="token operator">&lt;=</span> <span class="token number">970</span><span class="token punctuation">:</span> <span class="token comment">#原地右转弯</span>
            smartcar<span class="token punctuation">.</span>rightTurn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token punctuation">:</span> 
            smartcar<span class="token punctuation">.</span>brake<span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">#停车</span>
                
        <span class="token keyword">if</span> elevator_value <span class="token operator">&gt;=</span><span class="token number">1100</span><span class="token punctuation">:</span>  <span class="token comment">#前进</span>
            smartcar<span class="token punctuation">.</span>forward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> elevator_value <span class="token operator">&lt;=</span><span class="token number">970</span><span class="token punctuation">:</span> <span class="token comment">#后退</span>
            smartcar<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
                                   <span class="token comment">#循环最后，这里不能再用停车了</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>  
    smp_car<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span>ENA_pwm<span class="token punctuation">,</span>ENB_pwm<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    smp_car<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span>ENA_pwm<span class="token punctuation">,</span>ENB_pwm<span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/5d/db/PFOgb8Qs_o.gif" alt=""></p> 
<p>操控演示视频：<br> https://www.bilibili.com/video/BV1Q5411L75a/</p> 
<p>最近太忙，这篇文章拖了很久才完成，当中克服了一个个不懂的技术难点和BUG，不过终于实现了遥控小车的想法，成功将无线电遥控和树莓派结合起来。</p> 
<p>辛苦是值得的，学到不少东西，后面将陆续把各种传感器加入进来，实现智能化。</p> 
<p>这个项目的代码90%是我原创瞎写的，有需要参考的同学可以下载：<br> <a href="https://download.csdn.net/download/chinacqzgp/15467387">树莓派智能小车项目python源代码下载</a><br> <img src="https://images2.imgbox.com/5f/c1/AKxK6wtY_o.png" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/414a999bf3c102c387e1c08d5721b24e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">@Autowired注解位置、@Autowired与@Resource的区别与注入流程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e7a19aa4dd39ebd670d3cdd7150cd0ee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">微信小程序使用async 语法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>