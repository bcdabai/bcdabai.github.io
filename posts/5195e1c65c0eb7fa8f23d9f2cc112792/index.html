<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ES基础知识总结含SQL、DSL、GOLANG - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ES基础知识总结含SQL、DSL、GOLANG" />
<meta property="og:description" content="一、简介 Elasticsearch是一个基于Lucene的全文搜索和分析引擎，Lucene Core是一个完全用Java编写的高性能、全功能搜索引擎库。
它可以快速地存储、实时搜索和分析大量数据。
它可以扩展到上百台服务器，处理PB级数据。PB = 2^50 Byte， 在数值上约等于1000个TB。 人类功能记忆容量约1.25TB， 也意味着800个人类记忆相当于1PB。
二、认知 1、Lucene Lucene，封装好了各种建立倒排索引、匹配索引进行搜索的各种算法。我们可以引入Lucene，基于它的API进行开发。
ElasticSearch就在Lucene的基础上实现的，对Lucene进行了良好的封装，简化开发，并提供了很多高级功能
ElasticSearch生态
ElasticSearch 为快速检索和分析大数据而生，目前已形成丰富的生态。
成熟的ELK体系：
Elasticsearch： 位于Elastic堆栈核心的分布式搜索和分析引擎Logstash &#43; Beats：收集、聚合、丰富数据，存储到Elasticsearch中Kibana： 以交互方式探索、可视化、共享对数据的见解，并管理和监视堆栈 2、倒排索引 索引：通过key来寻找value。与之相反，就是倒排索引
Elasticsearch使用倒排索引的结构，适用于快速的全文搜索。一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。
正排索引： 书的目录
倒排索引： 词典中单词的索引页
查询包含“关键搜索”的文档的过程
通过倒排索引获得“关键搜索”对应的文档id列表通过正排索引查询文档id列表的完整内容返回最终结果 For instance
Doc 1 : no your po no your work
Doc 2 : enjoy your team work
Doc 3 : enjoy challenge with your team
为了创建索引，ES引擎通过分词器将每个文件的内容拆成单独的词（词条/term），再将这些词条创建成不含重复词条的排序列表，然后列出每个词条出现在哪个文档：
termDoc 1Doc 2Doc 3no✅po✅work✅✅enjoy✅✅your✅✅✅team✅✅With✅challenge✅ 这种结构由文档中所有不重复的词的列表构成，对于其中每个词都有至少一个文档与之关联。这种由属性值来确定记录的位置的结构就是倒排索引，带有倒排索引的文件被称为倒排文件
核心概念：
词条（term）：索引中最小的存储和查询单元。词典（Term Dictionary）：字典，是词条的组合。倒排表（Post list） 一个文档通常由多个词组成，倒排表记录了某个词在那些文档出现过以及出现的位置。每条记录称为一个倒排项（Posting）。记录了文档编号、词频等信息。 倒排文件（Inverted File） 所有单词的倒排列表按顺序存储在磁盘的某个文件中，即为倒排文件词典在内存中； 倒排文件在磁盘中 3、基本概念 field 字段， （类似Mysql中的一个字段） Document 文档，一条数据，用json格式表示一个Document包含多个field， json中的key即field Type 类型，一个Document分组，（类似于Mysql中的table）一个Type包含多个Document，同一个Type中的Document所拥有的field可以不同，但最好保持一致 Index 索引，（类似Mysql中的database）一个Index包含多个Type。默认情况下，Document中所有的field都会被索引，这些field才会被搜索到 shard 分片可以将一个Index中的数据切分为多个shard，然后存储到多台服务器上，以增大一个Index可以存储的数据量，加速检索能力，提升系统性能 replica 副本与shard存储的数据是相同的，起到备份作用当shard发生故障时，可以从replica中读取数据，保证系统不受影响 Node 节点单个Elasticsearch实例，一台机器可以有多个节点节点名称默认随机分配 Cluster 集群一组Elasticsearch实例默认集群名称为 elasticsearch Elasticsearch名称ElasticSearch概念数据库Index索引库Type类型表Document文档行field字段列 Document文档 Json Object，由字段（field）组成" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5195e1c65c0eb7fa8f23d9f2cc112792/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-12T17:22:58+08:00" />
<meta property="article:modified_time" content="2023-05-12T17:22:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ES基础知识总结含SQL、DSL、GOLANG</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/24/05/dwW7jsMY_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="_7"></a>一、简介</h2> 
<p>Elasticsearch是一个基于Lucene的全文搜索和分析引擎，<code>Lucene Core</code>是一个完全用Java编写的高性能、全功能搜索引擎库。</p> 
<p>它可以快速地存储、实时搜索和分析大量数据。</p> 
<p>它可以扩展到上百台服务器，处理PB级数据。PB = 2^50 Byte， 在数值上约等于1000个TB。 人类功能记忆容量约1.25TB， 也意味着800个人类记忆相当于1PB。</p> 
<h2><a id="_17"></a>二、认知</h2> 
<h3><a id="1Lucene_21"></a>1、Lucene</h3> 
<p>Lucene，封装好了各种建立倒排索引、匹配索引进行搜索的各种算法。我们可以引入Lucene，基于它的API进行开发。</p> 
<p>ElasticSearch就在Lucene的基础上实现的，对Lucene进行了良好的封装，简化开发，并提供了很多高级功能</p> 
<p><strong>ElasticSearch生态</strong></p> 
<p>ElasticSearch 为快速检索和分析大数据而生，目前已形成丰富的生态。<img src="https://images2.imgbox.com/49/e0/MmFQ2PHl_o.png" alt="在这里插入图片描述"></p> 
<p>成熟的ELK体系：</p> 
<ul><li><code>Elasticsearch</code>： 位于Elastic堆栈核心的分布式搜索和分析引擎</li><li><code>Logstash</code> + <code>Beats</code>：收集、聚合、丰富数据，存储到Elasticsearch中</li><li><code>Kibana</code>： 以交互方式探索、可视化、共享对数据的见解，并管理和监视堆栈</li></ul> 
<h3><a id="2_43"></a>2、倒排索引</h3> 
<p>索引：通过key来寻找value。与之相反，就是倒排索引</p> 
<p>Elasticsearch使用<u>倒排索引</u>的结构，适用于快速的全文搜索。一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。</p> 
<p>正排索引： 书的目录<br> 倒排索引： 词典中单词的索引页</p> 
<p><strong>查询包含“关键搜索”的文档的过程</strong></p> 
<ol><li>通过倒排索引获得“关键搜索”对应的文档id列表</li><li>通过正排索引查询文档id列表的完整内容</li><li>返回最终结果</li></ol> 
<p><em>For instance</em></p> 
<blockquote> 
 <p>Doc 1 : no your po no your work</p> 
 <p>Doc 2 : enjoy your team work</p> 
 <p>Doc 3 : enjoy challenge with your team</p> 
</blockquote> 
<p>为了创建索引，ES引擎通过分词器将每个文件的内容拆成单独的词（词条/term），再将这些词条创建成不含重复词条的排序列表，然后列出每个词条出现在哪个文档：</p> 
<table><thead><tr><th>term</th><th>Doc 1</th><th>Doc 2</th><th>Doc 3</th></tr></thead><tbody><tr><td>no</td><td>✅</td><td></td><td></td></tr><tr><td>po</td><td>✅</td><td></td><td></td></tr><tr><td>work</td><td>✅</td><td>✅</td><td></td></tr><tr><td>enjoy</td><td></td><td>✅</td><td>✅</td></tr><tr><td>your</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>team</td><td></td><td>✅</td><td>✅</td></tr><tr><td>With</td><td></td><td></td><td>✅</td></tr><tr><td>challenge</td><td></td><td></td><td>✅</td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/a0/44/7inpa24u_o.png" alt="在这里插入图片描述"></p> 
<p>这种结构由文档中所有不重复的词的列表构成，对于其中每个词都有至少一个文档与之关联。<strong>这种由属性值来确定记录的位置的结构就是倒排索引</strong>，带有倒排索引的文件被称为倒排文件</p> 
<p>核心概念：</p> 
<ul><li>词条（term）：索引中最小的存储和查询单元。</li><li>词典（Term Dictionary）：字典，是词条的组合。</li><li>倒排表（Post list） 
  <ul><li>一个文档通常由多个词组成，倒排表记录了某个词在那些文档出现过以及出现的位置。</li><li>每条记录称为一个倒排项（Posting）。</li><li>记录了文档编号、词频等信息。</li></ul> </li><li>倒排文件（Inverted File） 
  <ul><li>所有单词的倒排列表按顺序存储在磁盘的某个文件中，即为倒排文件</li><li>词典在内存中； 倒排文件在磁盘中</li></ul> </li></ul> 
<h3><a id="3_107"></a>3、基本概念</h3> 
<ul><li>field 
  <ul><li><code>字段</code>， （类似Mysql中的一个字段）</li></ul> </li><li>Document 
  <ul><li><code>文档</code>，一条数据，用json格式表示</li><li>一个Document包含多个field， json中的<code>key</code>即field</li></ul> </li><li>Type 
  <ul><li><code>类型</code>，一个Document分组，（类似于Mysql中的table）</li><li>一个Type包含多个Document，同一个Type中的Document所拥有的field可以不同，但最好保持一致</li></ul> </li><li>Index 
  <ul><li><code>索引</code>，（类似Mysql中的database）</li><li>一个Index包含多个Type。</li><li>默认情况下，Document中所有的field都会被索引，这些field才会被搜索到</li></ul> </li><li>shard 
  <ul><li><code>分片</code></li><li>可以将一个Index中的数据切分为多个shard，然后存储到多台服务器上，以增大一个Index可以存储的数据量，加速检索能力，提升系统性能</li></ul> </li><li>replica 
  <ul><li><code>副本</code></li><li>与shard存储的数据是相同的，起到备份作用</li><li>当shard发生故障时，可以从replica中读取数据，保证系统不受影响</li></ul> </li><li>Node 
  <ul><li><code>节点</code></li><li>单个Elasticsearch实例，一台机器可以有多个节点</li><li>节点名称默认随机分配</li></ul> </li><li>Cluster 
  <ul><li><code>集群</code></li><li>一组Elasticsearch实例</li><li>默认集群名称为 <code>elasticsearch</code></li></ul> </li></ul> 
<table><thead><tr><th>Elasticsearch名称</th><th>ElasticSearch概念</th><th>数据库</th></tr></thead><tbody><tr><td>Index</td><td>索引</td><td>库</td></tr><tr><td>Type</td><td>类型</td><td>表</td></tr><tr><td>Document</td><td>文档</td><td>行</td></tr><tr><td>field</td><td>字段</td><td>列</td></tr></tbody></table> 
<h5><a id="Document_146"></a>Document文档</h5> 
<p>Json Object，由字段（field）组成<br> <strong>每个文档有一个唯一id标志</strong></p> 
<ul><li>自行指定</li><li>es生成</li></ul> 
<p><strong>Document MetaData</strong> 元数据，用于标注文档的相关信息</p> 
<ul><li>_index： 文档所在的索引名</li><li>_type： 文档所在的类型名</li><li>_id： 文档唯一id</li><li>uid： 组合id， 由type和id组成</li><li>_source： 文档的原始json数据，可从这里获取每个字段的内容</li><li>_all： 整合所有字段内容到该字段，默认禁用</li></ul> 
<h5><a id="_162"></a>数据类型</h5> 
<ul><li>核心数据类型 
  <ul><li>字符串类型：text、keyword</li><li>数值类型： long、integer、short、byte、double、float、half_float、scaled_float</li><li>日期类型： date</li><li>布尔类型： boolean</li><li>二进制类型： binary</li><li>范围类型： integer_range、float_range、long_range、double_range、date_range</li></ul> </li><li>复杂数据类型 
  <ul><li>数组类型： array</li><li>对象类型： object</li><li>嵌套类型： nested object</li></ul> </li><li>地理位置数据类型 
  <ul><li>geo_point</li><li>geo_shape</li></ul> </li><li>专用类型 
  <ul><li>记录ip地址： ip</li><li>实现自动补全： completion</li><li>记录分词数：token_count</li><li>记录字符串hash值： murmur3</li></ul> </li></ul> 
<h2><a id="eskibana_187"></a>三、es与kibana安装</h2> 
<pre><code class="prism language-shell">
version: <span class="token string">'3.1'</span>
services:
  elasticsearch:
    image: elasticsearch:7.13.3
    container_name: elasticsearch
    privileged: <span class="token boolean">true</span>
    environment:
      - <span class="token string">"cluster.name=elasticsearch"</span> <span class="token comment">#设置集群名称为elasticsearch</span>
      - <span class="token string">"discovery.type=single-node"</span> <span class="token comment">#以单一节点模式启动</span>
      - <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx1096m"</span> <span class="token comment">#设置使用jvm内存大小</span>
      - bootstrap.memory_lock<span class="token operator">=</span>true
    volumes:
      - ./es/plugins:/usr/local/dockercompose/elasticsearch/plugins <span class="token comment">#插件文件挂载</span>
      - ./es/data:/usr/local/dockercompose/elasticsearch/data:rw <span class="token comment">#数据文件挂载</span>
      - ./es/logs:/usr/local/dockercompose/elasticsearch/logs:rw
    ports:
      - <span class="token number">9200</span>:9200
      - <span class="token number">9300</span>:9300
    deploy:
     resources:
        limits:
           cpus: <span class="token string">"2"</span>
           memory: 1000M
        reservations:
           memory: 200M
  kibana:
    image: kibana:7.13.3
    container_name: kibana
    depends_on:
      - elasticsearch <span class="token comment">#kibana在elasticsearch启动之后再启动</span>
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200 <span class="token comment">#设置访问elasticsearch的地址</span>
      I18N_LOCALE: zh-CN
    ports:
      - <span class="token number">5601</span>:5601

</code></pre> 
<p>将上述代码写入<code>docker-compose.yml</code> ，后运行即可拉起es、kibana服务：</p> 
<pre><code class="prism language-shell"><span class="token function">docker-compose</span> up -d
</code></pre> 
<p>访问kibana主页： <u> http://localhost:5601/app/home#/ </u></p> 
<h2><a id="kibanaelasticsearch_236"></a>四、kibana对elasticsearch管理</h2> 
<p>kibana中的Dev Tools开发者工具可以对es数据进行CRUD管理</p> 
<table><thead><tr><th>method方法</th><th>url地址</th><th>描述</th></tr></thead><tbody><tr><td>PUT</td><td>/索引名称/类型名称/文档id</td><td>创建文档（指定id）</td></tr><tr><td>POST</td><td>/索引名称/类型名称</td><td>创建文档（随机id）</td></tr><tr><td>POST</td><td>/索引名称/类型名称/文档id/_update</td><td>修改文档</td></tr><tr><td>DELETE</td><td>/索引名称/类型名称/文档id</td><td>删除文档</td></tr><tr><td>GET</td><td>/索引名称/类型名称/文档id</td><td>通过id查询文档</td></tr><tr><td>POST</td><td>/索引名称/类型名称/_search</td><td>查询所有数据</td></tr></tbody></table> 
<pre><code class="prism language-shell">
PUT /tool_index/
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"number_of_shards"</span>:10,  
      <span class="token string">"number_of_replicas"</span>:0
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /tool_index/_settings

PUT /tool_index/tools/20230326214500
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"ijie"</span>,
  <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token number">22</span>,
  <span class="token string">"grade"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
  <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token string">"coding"</span>
<span class="token punctuation">}</span>

POST /tool_index/_doc
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"erran_new"</span>,
  <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token number">24</span>,
  <span class="token string">"grade"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
  <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token string">"code"</span>
<span class="token punctuation">}</span>

GET /tool_index/tools/_search

GET /tool_index/tools/_search?q<span class="token operator">=</span>name:erran

GET /tool_index/tools/_search 
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"name.keyword"</span><span class="token builtin class-name">:</span> <span class="token string">"erran"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"name"</span>, <span class="token string">"grade"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

POST /tool_index/tools/20230326213100/_update
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"grade"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /tool_index/tools/20230326214500
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"people"</span><span class="token builtin class-name">:</span> <span class="token string">"ijie"</span>
<span class="token punctuation">}</span>

DELETE /tool_index/tools/20230326214500

DELETE tool_index

</code></pre> 
<p>⚠️⚠️⚠️：</p> 
<ul><li>创建索引后，插入的第一个数据的类型至关重要，如果指定为特殊类型，则后续插入的默认类型会变成该指定特殊类型；后续插入的其他特殊类型会报错！！【Rejecting mapping update to [tool_index] as the final mapping would have more than 1 type: [tools, demo】</li><li>更新时 
  <ul><li>PUT操作，写几个字段便会将数据更新为几个字段</li><li>POST操作， 只修改指定字段的值</li></ul> </li><li>字段匹配时，使用’field’ 或’field.keyword’皆可</li><li>在devcloud部署时，会存在高危服务内网风险，解决方案：【增加访问控制措施】 
  <ul><li>iptables限制访问来源</li><li>nginx： <code>server {listen 9200 default_server;server_name _;location / {proxy_set_header Host $host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_pass http://localhost:9200;#Basic字符串就是使用你的用户名(admin),密码(12345)编码后的值#注意:在进行Basic加密的时候要使用如下格式如:admin:123456的base64编码 注意中间有个冒号proxy_set_header Authorization "Basic 这里是basic认证的密码";}}</code></li><li>通过es的Search Guard插件来设置api Basic鉴权：<code>https://docs.search-guard.com/latest/http-basic-authorization</code></li></ul> </li></ul> 
<h2><a id="_325"></a>五、查询场景</h2> 
<p><img src="https://images2.imgbox.com/6e/73/S2wvETcj_o.png" alt="在这里插入图片描述"></p> 
<p>测试数据：</p> 
<ul><li>索引：person</li><li>类型：_doc</li></ul> 
<table><thead><tr><th align="center">name</th><th align="center">age</th><th align="center">sex</th><th align="center">grade</th><th align="center">hobby</th><th align="center">Weight</th></tr></thead><tbody><tr><td align="center">John</td><td align="center">24</td><td align="center">男</td><td align="center">2</td><td align="center">code</td><td align="center"></td></tr><tr><td align="center">Alis</td><td align="center">24</td><td align="center">女</td><td align="center">1</td><td align="center">movie</td><td align="center"></td></tr><tr><td align="center">Jack</td><td align="center">22</td><td align="center">男</td><td align="center">1</td><td align="center">code</td><td align="center"></td></tr><tr><td align="center">Rookie</td><td align="center">23</td><td align="center">男</td><td align="center">4</td><td align="center">read</td><td align="center">sixty kilo grams</td></tr><tr><td align="center">Jam</td><td align="center">25</td><td align="center">女</td><td align="center">3</td><td align="center">eat</td><td align="center">fifty-kilo-grams</td></tr></tbody></table> 
<p><strong>下面使用github中Olivere框架，其封装了若干查询方法，简单上手</strong></p> 
<h3><a id="_349"></a>语句查询</h3> 
<h4><a id="_351"></a>词条查询</h4> 
<h5><a id="term_353"></a>单值查询-term</h5> 
<p>即筛选出一个字段等于特定值的所有记录</p> 
<p>SQL：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> person <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'Rookie'</span><span class="token punctuation">;</span>
</code></pre> 
<p>ES：</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "query": {
    "term": {
      "name": "Rookie"
    }
  }
}
</code></pre> 
<p>ES查询结果（取hits.hits[]）：</p> 
<pre><code class="prism language-elm">      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "rIpjQYcBtP47ROwdblh9",
        "_score" : 0.2876821,
        "_source" : {
          "name" : "Rookie",
          "age" : 23,
          "sex" : "男",
          "grade" : 4,
          "hobby" : "read"
        }
      }
</code></pre> 
<p>Golang:</p> 
<pre><code class="prism language-go">	client<span class="token punctuation">,</span> err <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">SetURL</span><span class="token punctuation">(</span><span class="token string">"http://xxxx:9200"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		elastic<span class="token punctuation">.</span><span class="token function">SetSniff</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		elastic<span class="token punctuation">.</span><span class="token function">SetHealthcheck</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		elastic<span class="token punctuation">.</span><span class="token function">SetBasicAuth</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewTermQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Rookie"</span><span class="token punctuation">)</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Index</span><span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Query</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> req<span class="token punctuation">.</span>Hits<span class="token punctuation">.</span>Hits <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">var</span> tmp <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>结果：</p> 
<p><img src="https://images2.imgbox.com/e7/ac/KooKwtel_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="terms_428"></a>多值查询-terms</h5> 
<p>类似于IN查询</p> 
<p>SQL：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> persons <span class="token keyword">where</span> age <span class="token operator">in</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>ES：</p> 
<pre><code>GET /person/_search
{
  "query": {
    "terms": {
      "age": [23,24]
    }
  }
}
</code></pre> 
<p>ES结果：</p> 
<pre><code class="prism language-elm">      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "rIpjQYcBtP47ROwdblh9",
        "_score" : 1.0,
        "_source" : {
          "name" : "Rookie",
          "age" : 23,
          "sex" : "男",
          "grade" : 4,
          "hobby" : "read"
        }
      },
      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "n4phQYcBtP47ROwd1Vha",
        "_score" : 1.0,
        "_source" : {
          "name" : "Alis",
          "age" : 24,
          "sex" : "女",
          "grade" : 1,
          "hobby" : "movie"
        }
      },
      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "vIlfQYcBzqYw9eGTVRry",
        "_score" : 1.0,
        "_source" : {
          "name" : "John",
          "age" : 24,
          "sex" : "男",
          "grade" : 2,
          "hobby" : "code"
        }
      }
</code></pre> 
<p>Golang：</p> 
<pre><code class="prism language-go">	q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewTermsQuery</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Index</span><span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Query</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>结果：</p> 
<p><img src="https://images2.imgbox.com/25/21/nUNiLXCP_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="range_513"></a>范围查询-range</h5> 
<p>即查询某字段在特定区间的记录</p> 
<p>SQL：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> pesons <span class="token keyword">where</span> age <span class="token operator">between</span> <span class="token number">21</span> <span class="token operator">and</span> <span class="token number">23</span><span class="token punctuation">;</span>
</code></pre> 
<p>ES：</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "query": {
    "range": {
      "age": {
        "gte": 21,
        "lte": 23
      }
    }
  }
}
</code></pre> 
<p>ES结果：</p> 
<pre><code class="prism language-elm">      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "rIpjQYcBtP47ROwdblh9",
        "_score" : 1.0,
        "_source" : {
          "name" : "Rookie",
          "age" : 23,
          "sex" : "男",
          "grade" : 4,
          "hobby" : "read"
        }
      },
      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "DYliQYcBzqYw9eGTqht2",
        "_score" : 1.0,
        "_source" : {
          "name" : "Jack",
          "age" : 22,
          "sex" : "男",
          "grade" : 1,
          "hobby" : "code"
        }
      }
</code></pre> 
<p>Golang：</p> 
<pre><code class="prism language-go">	q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewRangeQuery</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lte</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Index</span><span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Query</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：</p> 
<p><img src="https://images2.imgbox.com/ab/65/LG0zBSBq_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="wildcard_587"></a>通配符查询-wildcard</h5> 
<p>与前缀查询类似，都属于模糊查询的范畴，但通配符显然功能更强</p> 
<p>SQL：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> persons <span class="token keyword">where</span> hobby <span class="token operator">like</span> <span class="token string">'%o%'</span><span class="token punctuation">;</span>
</code></pre> 
<p>ES：</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "query": {
    "wildcard": {
      "hobby": "*o*"
    }
  }
}
</code></pre> 
<p>ES结果：</p> 
<pre><code class="prism language-elm">      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "n4phQYcBtP47ROwd1Vha",
        "_score" : 1.0,
        "_source" : {
          "name" : "Alis",
          "age" : 24,
          "sex" : "女",
          "grade" : 1,
          "hobby" : "movie"
        }
      },
      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "vIlfQYcBzqYw9eGTVRry",
        "_score" : 1.0,
        "_source" : {
          "name" : "John",
          "age" : 24,
          "sex" : "男",
          "grade" : 2,
          "hobby" : "code"
        }
      },
      {
        "_index" : "person",
        "_type" : "_doc",
        "_id" : "DYliQYcBzqYw9eGTqht2",
        "_score" : 1.0,
        "_source" : {
          "name" : "Jack",
          "age" : 22,
          "sex" : "男",
          "grade" : 1,
          "hobby" : "code"
        }
      }
</code></pre> 
<p>Golang：</p> 
<pre><code class="prism language-go">q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewWildcardQuery</span><span class="token punctuation">(</span><span class="token string">"hobby"</span><span class="token punctuation">,</span> <span class="token string">"*o*"</span><span class="token punctuation">)</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Index</span><span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Query</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：</p> 
<p><img src="https://images2.imgbox.com/ca/90/3K7v1GIt_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_671"></a>匹配查询</h4> 
<p><strong>Match query</strong>， 返回与提供的文本、数字、日期或布尔值匹配的文档，并在匹配之前分析提供的文本。</p> 
<p><code>match</code> 查询是执行全文搜索的标准查询，包括模糊匹配的选项。</p> 
<p>以匹配weight=“fifty-kilo-grams”为例：</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "query": {
    "match": {
      "weight": {
        "query": "fifty-kilo-grams"
      }
    }
  }
}
</code></pre> 
<p><code>match</code> 用到的参数</p> 
<ul><li>query（必填） 
  <ul><li>需要查找的text、number、boolean、date等</li></ul> </li><li>analyzer（可选，字符串） 
  <ul><li>可用于将query值中的text转换为tokens。</li><li>默认为</li><li>如果没有映射分析器，则使用索引的默认分析器</li></ul> </li><li>auto_generate_synonyms_phrase_query（可选，布尔值） 
  <ul><li>默认为true，自动为muti-term synonyms创建<code>match phrase</code></li></ul> </li><li>fuzziness（可选，字符串） 
  <ul><li>允许匹配的最大编辑距离</li></ul> </li><li>max_expansions（可选，整数） 
  <ul><li>查询将terms最大数值，默认为50</li></ul> </li><li>prefix_length（可选，整数） 
  <ul><li>fuzzy match模糊匹配保留不变的<em>起始</em>字符，默认为0</li></ul> </li><li>fuzzy_transpositions（可选，布尔值） 
  <ul><li>默认为true，模糊匹配包括两个相邻字符的换位(ab-&gt;ba)</li></ul> </li><li>fuzzy_rewrite（可选，字符串） 
  <ul><li>用于重写查询的方法</li><li>若fuzziness != 0, 则查询默认使用fuzzy_write方法。<code>top_terms_blended_freqs_${max_expansions}</code></li></ul> </li><li>lenient（可选，布尔值） 
  <ul><li>默认为false， 若为true，则忽略格式错误，例如为text字段提供number类型</li></ul> </li><li>operator（可选，字符串） 
  <ul><li>用于查询中的布尔逻辑，有效值为<code>OR(默认)</code>、<code>AND</code></li></ul> </li><li>minimum_should_match（可选，字符串） 
  <ul><li>要返回的文档必须匹配的最小子句数</li></ul> </li><li>zero_terms_query（可选，字符串） 
  <ul><li>当analyzer删除索引tokens时（例如使用<code>stop</code>filter)，是否不返回任何结果</li><li>有效值为<code>none(默认)</code>、<code>all</code></li></ul> </li></ul> 
<p>简单查询可以简化匹配语法：</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "query": {
    "match": {
      "weight": "fifty-kilo-grams"
    }
  }
}
</code></pre> 
<p>模糊匹配：</p> 
<p>可以使用<code>fuzziness</code>来模糊匹配字段, "AUTO"会根据词项的长度来产生可编辑距离,默认值是AUTO:3,6</p> 
<ul><li> <p>0…2</p> <p>单词长度为 0 到 2 之间时必须要精确匹配，这其实很好理解，单词长度太短是没有相似度可言的，例如 ‘a’ 和 ‘b’</p> </li><li> <p>3…5</p> </li></ul> 
<p>​ 单词长度 3 到 5 个字母时，最大编辑距离为 1</p> 
<ul><li>&gt;5</li></ul> 
<p>​ 单词长度大于 5 个字母时，最大编辑距离为 2</p> 
<p>可以使用<code>prefix_length</code>、<code>max_expansions</code>来控制模糊过程</p> 
<p>可以使用<code>fuzzy_rewrite</code>来允许控制查询将如何被重写</p> 
<p>可以使用<code>fuzzy_transpositions</code>来控制是否允许模糊换位(ab-&gt;ba)</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "query": {
    "match": {
      "weight": {
        "query": "2fifty-kilo-grams1",
        "fuzziness": "AUTO"
      }
    }
  }
}
</code></pre> 
<p><strong>关于text、keyword</strong></p> 
<p>首先查看索引下的proporties：</p> 
<pre><code class="prism language-elm">GET /person/_mapping

"properties" : {
  "age" : {
    "type" : "long"
  },
  "grade" : {
    "type" : "long"
  },
  "hobby" : {
    "type" : "keyword"
  },
  "name" : {
    "type" : "keyword"
  },
  "sex" : {
    "type" : "keyword"
  },
  "weight" : {
    "type" : "keyword"
  }
}
</code></pre> 
<p>新建一个text类型的<code>new_field</code>，并设置<code>new_field.keyword</code>为keyword类型</p> 
<pre><code class="prism language-elm">PUT /person/_mapping
{
  "properties": {
    "new_field": {
      "type": "text",
      "fields": {
        "keyword": {
          "type": "keyword",
          "ignore_above": 256
        }
      }
    }
  }
}
</code></pre> 
<p>给Rookie添加属性：</p> 
<pre><code class="prism language-elm">POST /person/_doc/rIpjQYcBtP47ROwdblh9
{
  "name": "Rookie",
  "age": 23,
  "sex": "男",
  "grade": 4,
  "hobby": "read",
  "weight": "sixty kilogram",
  "new_field": "sixty kilo grams, sixty kilogram, 60 千克"
}
POST /person/_doc/vYplQYcBtP47ROwdc1gz
{
  "name": "Jam",
  "age": 25,
  "sex": "女",
  "grade": 3,
  "hobby": "eat",
  "weight": "fifty-kilo-grams",
  "new_field": "60"
}
</code></pre> 
<p><img src="https://images2.imgbox.com/b5/e7/aLfYXemK_o.png" alt="在这里插入图片描述"></p> 
<p>之后进行相关的text、keyword查询：</p> 
<p><em><u>term——match——match_phrase</u></em></p> 
<p>match_phrase_prefix(只用于text)</p> 
<p>match_all(固定用法： <code>"match_all": {}</code>) 查询所有</p> 
<p>使用analyze查看分词</p> 
<pre><code class="prism language-elm">GET /person/_analyze
{
  "text":"sixty kilo grams, sixty kilogram, 60 千克"
}
</code></pre> 
<p><strong>keyword</strong>： 只支持完整内容</p> 
<table><thead><tr><th><strong>text</strong></th><th>term</th><th>match</th><th>match_phrase</th></tr></thead><tbody><tr><td>分词器分词</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>分词器多个分词</td><td>❌</td><td>✅</td><td>✅</td></tr><tr><td>完整内容</td><td>❌</td><td>✅</td><td>✅</td></tr><tr><td>中文短语</td><td>❌</td><td>✅</td><td>✅</td></tr></tbody></table> 
<p>match与match_phrase的区别：</p> 
<ul><li>match返回匹配到的所有文档</li><li>match_phrase返回顺序一致的、匹配到的所有文档</li></ul> 
<p>For instance</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span> <span class="token string-property property">"id"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string-property property">"content"</span><span class="token operator">:</span><span class="token string">"关注我,系统学编程"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"id"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token string-property property">"content"</span><span class="token operator">:</span><span class="token string">"系统学编程,关注我"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"id"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token string-property property">"content"</span><span class="token operator">:</span><span class="token string">"系统编程,关注我"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"id"</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token string-property property">"content"</span><span class="token operator">:</span><span class="token string">"关注我,间隔系统学编程"</span> <span class="token punctuation">}</span>
</code></pre> 
<p>查询 <code>关注我，系统学</code></p> 
<ul><li>match返回所有文档，因为使用“ik_smart”分词后，Token【关注、我、系统学】，包含Token即返回</li><li>match_phrase只返回id=1，包含Token且顺序一致</li><li>match_phrase添加<code>slop</code>参数——Token之间的位置距离容差值， id=4的Token【关注、我、间隔、系统学】，因此若添加slop=1，则返回文档1、文档4</li></ul> 
<pre><code class="prism language-go">q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchQuery</span><span class="token punctuation">(</span><span class="token string">"new_field"</span><span class="token punctuation">,</span> <span class="token string">"60"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Operator</span><span class="token punctuation">(</span><span class="token string">"and"</span><span class="token punctuation">)</span>
	<span class="token comment">//map[age:23 grade:4 hobby:read name:Rookie new_field:sixty kilo grams, sixty kilogram, 60 千克 sex:男 weight:sixty kilogram, 60kg,千克]</span>
q2 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchPhraseQuery</span><span class="token punctuation">(</span><span class="token string">"new_field"</span><span class="token punctuation">,</span> <span class="token string">"千克"</span><span class="token punctuation">)</span>
	<span class="token comment">//map[age:25 grade:3 hobby:eat name:Jam new_field:60 sex:女 weight:fifty-kilo-grams]</span>
	<span class="token comment">//map[age:23 grade:4 hobby:read name:Rookie new_field:sixty kilo grams, sixty kilogram, 60 千克 sex:男 weight:sixty kilogram, 60kg,千克]</span>

<span class="token keyword">type</span> MatchQuery <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	name                <span class="token builtin">string</span>    		<span class="token comment">// key</span>
	text                <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>		<span class="token comment">// value</span>
  operator            <span class="token builtin">string</span> 				<span class="token comment">// or(默认)/and 使用and时，需要查询字段包含query中的所有分词</span>
	analyzer            <span class="token builtin">string</span>
	boost               <span class="token operator">*</span><span class="token builtin">float64</span>			<span class="token comment">// 权重</span>
  fuzziness           <span class="token builtin">string</span>				<span class="token comment">// AUTO(默认) 可编辑最大距离</span>
	prefixLength        <span class="token operator">*</span><span class="token builtin">int</span>					<span class="token comment">// 未模糊的初始字符数</span>
	maxExpansions       <span class="token operator">*</span><span class="token builtin">int</span>					<span class="token comment">// 结果返回term的数量限制</span>
	minimumShouldMatch  <span class="token builtin">string</span>
	fuzzyRewrite        <span class="token builtin">string</span>
	lenient             <span class="token operator">*</span><span class="token builtin">bool</span>					<span class="token comment">// 忽略数据类型不匹配</span>
	fuzzyTranspositions <span class="token operator">*</span><span class="token builtin">bool</span>
  zeroTermsQuery      <span class="token builtin">string</span>				<span class="token comment">// none(默认)/all 使用all时 忽略analyzer限制，效果与match_all相似</span>
  cutoffFrequency     <span class="token operator">*</span><span class="token builtin">float64</span>			<span class="token comment">// 分数(0.02)表示频率，正整数(3)表示出现次数 </span>
	queryName           <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> MatchPhraseQuery <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	name           <span class="token builtin">string</span>							<span class="token comment">// key</span>
	value          <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>				<span class="token comment">// value</span>
	analyzer       <span class="token builtin">string</span>
	slop           <span class="token operator">*</span><span class="token builtin">int</span>								<span class="token comment">//分词词项最大移动次数</span>
	boost          <span class="token operator">*</span><span class="token builtin">float64</span>
	queryName      <span class="token builtin">string</span>
	zeroTermsQuery <span class="token builtin">string</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-elm">
GET /person/_search
{
  "query": {
    "multi_match": {
      "query": "sixty 60",
      "fields": ["weight", "new_field"]
    }
  }
}

GET /person/_search
{
  "query": {
    "dis_max": {
      "queries": [
        { "match": { "weight": "sixty 60" }},
        { "match": { "new_field": "sixty 60" }}
      ]
    }
  }
}
</code></pre> 
<p><strong>Multi-match query</strong></p> 
<p>the <code>multi_match</code> builds on the <code>match</code> query to allow multi-field queries</p> 
<p>先来看multi_match的type参数，内部执行查询的方式取决于type：</p> 
<ul><li>best_fields：(默认)查找匹配任意field的文档，并根据_score来使用最佳field</li><li>most_fields：查找匹配任意field的文档并结合每个字段的_score</li><li>cross_fields：将field视为analyzer的一个大的field，在<strong>任意</strong>field中查找每一个单词</li><li>phrase：使用<code>match_phrase</code>查询每一个field并根据_score来使用最佳field</li><li>phrase_prefix：使用<code>match_phrase_prefix</code>查询每一个field并根据_score来使用最佳field</li><li>bool_prefix：创建<code>match_bool_prefix</code>查询每一个field并结合每个field的_score</li></ul> 
<pre><code class="prism language-go">q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMultiMatchQuery</span><span class="token punctuation">(</span><span class="token string">"sixty 60"</span><span class="token punctuation">,</span> <span class="token string">"weight"</span><span class="token punctuation">,</span> <span class="token string">"new_field"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Operator</span><span class="token punctuation">(</span><span class="token string">"and"</span><span class="token punctuation">)</span>
<span class="token comment">// map[age:23 grade:4 hobby:read name:Rookie new_field:sixty kilo grams, sixty kilogram, 60 千克 sex:男 weight:sixty kilogram, 60kg,千克]</span>
q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMultiMatchQuery</span><span class="token punctuation">(</span><span class="token string">"sixty 60"</span><span class="token punctuation">,</span> <span class="token string">"weight"</span><span class="token punctuation">,</span> <span class="token string">"new_field"</span><span class="token punctuation">)</span>
<span class="token comment">// map[age:23 grade:4 hobby:read name:Rookie new_field:sixty kilo grams, sixty kilogram, 60 千克 sex:男 weight:sixty kilogram, 60kg,千克]</span>
<span class="token comment">// map[age:25 grade:3 hobby:eat name:Jam new_field:60 sex:女 weight:fifty-kilo-grams]</span>
</code></pre> 
<h4><a id="_995"></a>复合查询</h4> 
<p>实际应用中，需要过滤多个值/字段，这样的多条件等值查询，则需要使用组合过滤器</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> sex<span class="token operator">=</span><span class="token string">'女'</span> <span class="token operator">AND</span> age<span class="token operator">&gt;=</span><span class="token number">23</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-elm">GET /person/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "sex": {
              "value": "女"
            }
          }
        },
        {
          "range": {
            "age": {
              "gte": 23
            }
          }
        }
      ]
    }
  }
}
</code></pre> 
<p>golang:</p> 
<pre><code class="prism language-go">query1 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewTermQuery</span><span class="token punctuation">(</span><span class="token string">"sex"</span><span class="token punctuation">,</span> <span class="token string">"女"</span><span class="token punctuation">)</span>
	query2 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewRangeQuery</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span>
	q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewBoolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>query1<span class="token punctuation">,</span> query2<span class="token punctuation">)</span>
<span class="token comment">// map[age:25 grade:3 hobby:eat name:Jam new_field:60 sex:女 weight:fifty-kilo-grams]</span>
<span class="token comment">// map[age:24 grade:1 hobby:movie name:Alis sex:女]</span>
</code></pre> 
<p>布尔过滤器（bool filter）属于复合过滤器（compound filter）的一种，可以接受多个其他的过滤器作为参数，并将这些过滤器结合成各种布尔逻辑组合</p> 
<p><strong>Bool query</strong></p> 
<pre><code class="prism language-go"><span class="token comment">// Creates a new bool query.</span>
<span class="token keyword">func</span> <span class="token function">NewBoolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>BoolQuery <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>BoolQuery<span class="token punctuation">{<!-- --></span>
		mustClauses<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Query<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		mustNotClauses<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Query<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		filterClauses<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Query<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		shouldClauses<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Query<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>must</code>: 所有的语句都必须匹配，与 ‘=’ 等价</li><li><code>must_not</code>: 所有的语句都不能匹配，与 ‘!=’ 或 not in 等价</li><li><code>should</code>: 至少有n个语句要匹配，n由参数控制(在olivere框架中会自动匹配个数，已封装好)</li><li><code>filter</code>: 子句查询忽略评分、考虑缓存 
  <ul><li>主要快在两个方面：对结果进行缓存；避免了计算分值</li></ul> </li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> persons
<span class="token keyword">where</span> 
	sex <span class="token operator">=</span> <span class="token string">'男'</span>
<span class="token operator">and</span>
	age <span class="token operator">between</span> <span class="token number">22</span> <span class="token operator">and</span> <span class="token number">25</span>
<span class="token operator">and</span> 
	grade <span class="token operator">!=</span> <span class="token number">1</span>
<span class="token operator">and</span> 
	<span class="token punctuation">(</span>hobby <span class="token operator">=</span> <span class="token string">'code'</span> <span class="token operator">OR</span> weight <span class="token operator">=</span> <span class="token string">'sixty kilogram, 60kg,千克'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-elm">GET /person/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "sex": {
              "value": "男"
            }
          }
        },
        {
          "range": {
            "age": {
              "gte": 22,
              "lte": 25
            }
          }
        }
      ],
      "must_not": [
        {
          "match": {
            "grade": 1
          }
        }
      ],
      "should": [
        {
          "match": {
            "hobby": "code"
          }
        },
        {
          "match_phrase": {
            "weight": "sixty kilogram"
          }
        },
        {
          "match_phrase": {
            "weight": "60kg"
          }
        },
        {
          "match_phrase": {
            "weight": "千克"
          }
        }
      ]
    }
  }
}
</code></pre> 
<p><strong>使用filter加速</strong></p> 
<pre><code class="prism language-go">	query1 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewTermQuery</span><span class="token punctuation">(</span><span class="token string">"sex"</span><span class="token punctuation">,</span> <span class="token string">"男"</span><span class="token punctuation">)</span>
	query2 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewRangeQuery</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lte</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>
	query3 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchQuery</span><span class="token punctuation">(</span><span class="token string">"grade"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	query4 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchQuery</span><span class="token punctuation">(</span><span class="token string">"hobby"</span><span class="token punctuation">,</span> <span class="token string">"code"</span><span class="token punctuation">)</span>
	query5 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchPhraseQuery</span><span class="token punctuation">(</span><span class="token string">"weight"</span><span class="token punctuation">,</span> <span class="token string">"sixty kilogram"</span><span class="token punctuation">)</span>
	query6 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchPhraseQuery</span><span class="token punctuation">(</span><span class="token string">"weight"</span><span class="token punctuation">,</span> <span class="token string">"60kg"</span><span class="token punctuation">)</span>
	query7 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchPhraseQuery</span><span class="token punctuation">(</span><span class="token string">"weight"</span><span class="token punctuation">,</span> <span class="token string">"千克"</span><span class="token punctuation">)</span>
	query <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewBoolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Must</span><span class="token punctuation">(</span>query1<span class="token punctuation">,</span> query2<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">MustNot</span><span class="token punctuation">(</span>query3<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Should</span><span class="token punctuation">(</span>query4<span class="token punctuation">,</span> query5<span class="token punctuation">,</span> query6<span class="token punctuation">,</span> query7<span class="token punctuation">)</span>
	q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewBoolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_1156"></a>聚合查询</h3> 
<h4><a id="_1158"></a>统计</h4> 
<p>查询最大、最小、平均年龄</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "aggs": {
    "max_age": {
      "max": {
        "field": "age"
      }
    },
    "min_age": {
      "min": {
        "field": "age"
      }
    },
    "avg_age": {
      "avg": {
        "field": "age"
      }
    }
  }
}
</code></pre> 
<pre><code class="prism language-go">  aggs <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMaxAggregation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span>
	q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Index</span><span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Query</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Aggregation</span><span class="token punctuation">(</span><span class="token string">"max_age"</span><span class="token punctuation">,</span> aggs<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 结果在req.Aggregations中 </span>
<span class="token comment">// 调用Aggregations对象的方法来获取想要的聚合结果</span>
  aggResult<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> req<span class="token punctuation">.</span>Aggregations<span class="token punctuation">.</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token string">"max_age"</span><span class="token punctuation">)</span>
	maxAge <span class="token operator">:=</span> <span class="token operator">*</span>aggResult<span class="token punctuation">.</span>Value
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Max age: %d\n"</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Max age: 25</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/75/ac/A2TO6Due_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_1207"></a>去重查询</h4> 
<p>查询一共多少种爱好</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "aggs": {
    "hobby_count": {
      "cardinality": {
        "field": "hobby"
      }
    }
  }
}
</code></pre> 
<pre><code class="prism language-go">	aggs <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewCardinalityAggregation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token string">"hobby"</span><span class="token punctuation">)</span>
	q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Index</span><span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Query</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Aggregation</span><span class="token punctuation">(</span><span class="token string">"hobby_count"</span><span class="token punctuation">,</span> aggs<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//hobby count : 4</span>
</code></pre> 
<h4><a id="_1235"></a>分组</h4> 
<p>查询每个性别的人数</p> 
<pre><code class="prism language-elm">GET /person/_search
{
  "aggs": {
    "count": {
      "terms": {
        "field": "sex",
        "size": 10
      }
    }
  }
}
//   "aggregations" : {
//    "count" : {
//      "doc_count_error_upper_bound" : 0,
//      "sum_other_doc_count" : 0,
//      "buckets" : [
//        {
//          "key" : "男",
//         "doc_count" : 3
//        },
//        {
//          "key" : "女",
//         "doc_count" : 2
//        }
//      ]
//    }
//  }
</code></pre> 
<pre><code class="prism language-go">  aggs <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewTermsAggregation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token string">"sex"</span><span class="token punctuation">)</span>
	q <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Index</span><span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Query</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Aggregation</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">,</span> aggs<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  aggResult<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> req<span class="token punctuation">.</span>Aggregations<span class="token punctuation">.</span><span class="token function">Terms</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> aggResult<span class="token punctuation">.</span>Buckets <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v--%d\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> v<span class="token punctuation">.</span>DocCount<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token comment">//男--3</span>
<span class="token comment">//女--2</span>
</code></pre> 
<p>Warning⚠️：Elasticsearch 不支持对 <code>text</code> 类型的字段进行聚合操作。</p> 
<ul><li><code>text</code> 类型的字段被分词器处理成了多个词项（terms）</li><li>聚合操作需要对每个文档的每个词项进行处理，这样会导致性能问题和内存消耗</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a963d3c5f6b6b9d955544038a1845f09/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Shiro】SimpleAuthenticationInfo如何验证password</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dfafea3dce4b5e8de35ad9da7d8f35d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux中设置定时任务</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>