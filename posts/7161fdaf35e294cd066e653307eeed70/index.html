<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>æ¯•ä¸šè®¾è®¡ : åŸºäºæ·±åº¦å­¦ä¹ çš„å£ç½©ä½©æˆ´æ£€æµ‹ã€å…¨ç½‘æœ€è¯¦ç»†ã€‘ - opencv å·ç§¯ç¥ç»ç½‘ç»œ æœºå™¨è§†è§‰ æ·±åº¦å­¦ä¹  - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="æ¯•ä¸šè®¾è®¡ : åŸºäºæ·±åº¦å­¦ä¹ çš„å£ç½©ä½©æˆ´æ£€æµ‹ã€å…¨ç½‘æœ€è¯¦ç»†ã€‘ - opencv å·ç§¯ç¥ç»ç½‘ç»œ æœºå™¨è§†è§‰ æ·±åº¦å­¦ä¹ " />
<meta property="og:description" content="æ–‡ç« ç›®å½• ğŸš© 0 ç®€ä»‹ğŸš©1 è¯¾é¢˜èƒŒæ™¯ğŸš© 2 å£ç½©ä½©æˆ´ç®—æ³•å®ç°2.1 YOLO æ¨¡å‹æ¦‚è§ˆ2.2 YOLOv32.3 YOLO å£ç½©ä½©æˆ´æ£€æµ‹å®ç°æ•°æ®é›† 2.4 å®ç°ä»£ç 2.5 æ£€æµ‹æ•ˆæœ ğŸš© 3 å£ç½©ä½©æˆ´æ£€æµ‹ç®—æ³•è¯„ä»·æŒ‡æ ‡3.1 å‡†ç¡®ç‡ï¼ˆAccuracyï¼‰3.2 ç²¾ç¡®ç‡(Precision)å’Œå¬å›ç‡(Recall)3.3 å¹³å‡ç²¾åº¦(Average precision AP) ğŸš© 4 æœ€å ğŸš© 0 ç®€ä»‹ ä»Šå¤©å­¦é•¿å‘å¤§å®¶ä»‹ç»ä¸€ä¸ªæœºå™¨è§†è§‰çš„æ¯•è®¾é¡¹ç›®
åŸºäºæ·±åº¦å­¦ä¹ çš„å£ç½©ä½©æˆ´æ£€æµ‹ã€å…¨ç½‘æœ€è¯¦ç»†ã€‘ - opencv å·ç§¯ç¥ç»ç½‘ç»œ æœºå™¨è§†è§‰ æ·±åº¦å­¦ä¹ 
ğŸš©1 è¯¾é¢˜èƒŒæ™¯ ä»2019å¹´æœ«å¼€å§‹ï¼Œæ–°å‹å† çŠ¶ç—…æ¯’è‚ºç‚ï¼ˆCOVID-19ï¼‰åœ¨æˆ‘å›½å…¨é¢çˆ†å‘å¹¶è¿…é€Ÿä¼ æ’­ï¼ŒåŒæ—¶å›½å®¶å«ç”Ÿå¥åº·å§”å‘˜ä¼šä¹Ÿç§¯æå“åº”å¯†åˆ‡å…³æ³¨å…¨å›½ç–«æƒ…çš„åŠ¨æ€å˜åŒ–å¹¶ä¸”å‘å¸ƒäº†ç›¸å…³çš„é¢„é˜²æŒ‡å—ï¼Œå¼ºè°ƒä¸ªäººå‡ºè¡Œéœ€è¦åšå¥½å®‰å…¨æªæ–½ï¼Œåœ¨å…¬å…±åœºåˆå¿…é¡»ä¸¥æ ¼æŒ‰ç…§è¦æ±‚ä½©æˆ´å£ç½©ã€‚è‡ªä»æ–°å‹å† çŠ¶ç—…æ¯’è”“å»¶ä»¥æ¥ï¼Œå„è¡Œå„ä¸šéƒ½å—åˆ°äº†å·¨å¤§çš„å†²å‡»ï¼Œä¸¥é‡å½±å“åˆ°äººä»¬æ­£å¸¸ç”Ÿäº§å’Œç”Ÿæ´»ã€‚
æ–°å‹å† çŠ¶ç—…æ¯’å…·æœ‰å¾ˆå¼ºçš„ä¼ æ’­å’Œç”Ÿå­˜èƒ½åŠ›ï¼Œåªè¦æ¡ä»¶åˆé€‚èƒ½å­˜æ´»äº”å¤©ä¹‹ä¹…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å”¾æ¶²ï¼Œé£æ²«ç­‰å¤šç§æ–¹å¼è¿›è¡Œä¼ æ’­ï¼Œä¸ºæœ‰æ•ˆçš„å‡å°‘ç—…æ¯’çš„ä¼ æ’­ä½©æˆ´å£ç½©æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŠæ³•ã€‚å°½ç®¡è¿™ä¸€æ—¶æœŸå›½å¤–çš„å½¢åŠ¿ä¸å®¹ä¹è§‚ï¼Œä½†æ˜¯åœ¨å…¨å›½ä¸Šä¸‹é½å¿ƒåŠªåŠ›ä¹‹ä¸‹æˆ‘å›½çš„é˜²ç–«å–å¾—äº†é˜¶æ®µæ€§æˆåŠŸï¼Œå„è¡Œä¸šéƒ½åœ¨ç§¯æå¤è‹ï¼Œç®¡ç†ä¹Ÿéšä¹‹å˜åŒ–è¿›å…¥åˆ°å¸¸æ€åŒ–é˜¶æ®µã€‚åœ¨è¿™ä¸€é˜¶æ®µå¤å·¥å¤äº§ä¹Ÿæ˜¯å¤§åŠ¿æ‰€è¶‹ï¼Œå£ç½©å‡ºè¡Œä¹Ÿæˆä¸ºäº†ä¸€ç§å¸¸æ€ã€‚æ­£ç¡®ä½©æˆ´å£ç½©èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘é£æ²«ä¼ æŸ“çš„é£é™©ï¼Œç‰¹åˆ«æ˜¯åœ¨å…¬å…±åœºæ‰€ï¼Œè¿™ç§ä¸¾æªå°¤ä¸ºé‡è¦ã€‚ä½†æ˜¯ï¼Œä»ç„¶è¿˜éœ€è¦æé«˜å…¬ä¼—å¯¹ä¸»åŠ¨ä½©æˆ´å£ç½©çš„è§‚å¿µï¼Œåœ¨å¸¸æ€åŒ–ç®¡ç†ä¸‹äººä»¬çš„é˜²èŒƒæ„è¯†è¶Šæ¥è¶Šè–„å¼±ï¼Œå£ç½©éšæ„ä½©æˆ´æˆ–è€…ä¸ä½©æˆ´çš„æƒ…å†µå±¡è§ä¸é²œã€‚
å› æ­¤ï¼Œåœ¨è¿™æœŸé—´ï¼Œæœ‰æ„è¯†åœ°æˆ´å£ç½©ä¸ä»…ä»…æ˜¯æ¯ä¸ªå…¬æ°‘çš„å…¬å…±é“å¾·è¿˜æ˜¯è‡ªæˆ‘ä¿®å…»çš„è¡¨ç°ã€‚è¿™ä¸ä½†éœ€è¦ä¸ªäººç§¯æé…åˆï¼Œè€Œä¸”è¿˜éœ€è¦æŸäº›ç›‘ç®¡ä»¥åŠæœ‰æ•ˆçš„æ²»ç†æ–¹æ³•ã€‚
ğŸš© 2 å£ç½©ä½©æˆ´ç®—æ³•å®ç° 2.1 YOLO æ¨¡å‹æ¦‚è§ˆ YOLO çš„ç¼©å†™æ˜¯ You only look onceã€‚YOLO æ¨¡å‹å¯ä»¥ç›´æ¥æ ¹æ®å›¾ç‰‡è¾“å‡ºåŒ…å«å¯¹è±¡çš„åŒºåŸŸä¸åŒºåŸŸå¯¹åº”çš„åˆ†ç±»ï¼Œä¸€æ­¥åˆ°ä½ï¼Œä¸åƒ RCNN ç³»åˆ—çš„æ¨¡å‹éœ€è¦å…ˆè®¡ç®—åŒ…å«å¯¹è±¡çš„åŒºåŸŸï¼Œå†æ ¹æ®åŒºåŸŸåˆ¤æ–­å¯¹åº”çš„åˆ†ç±»ï¼ŒYOLO æ¨¡å‹çš„é€Ÿåº¦æ¯” RCNN ç³»åˆ—çš„æ¨¡å‹è¦å¿«å¾ˆå¤šã€‚
YOLO æ¨¡å‹çš„ç»“æ„å¦‚ä¸‹ï¼š
æ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹ç†Ÿæ‚‰ï¼Ÿçœ‹ä¸Šå»å°±åƒ Faster-RCNN çš„åŒºåŸŸç”Ÿæˆç½‘ç»œ (RPN) å•Šã€‚çš„ç¡®ï¼ŒYOLO æ¨¡å‹åŸç†ä¸Šå°±æ˜¯å¯»æ‰¾åŒºåŸŸçš„åŒæ—¶åˆ¤æ–­åŒºåŸŸåŒ…å«çš„å¯¹è±¡åˆ†ç±»ï¼ŒYOLO æ¨¡å‹ä¸åŒºåŸŸç”Ÿæˆç½‘ç»œæœ‰ä»¥ä¸‹çš„ä¸åŒï¼š
YOLO æ¨¡å‹ä¼šè¾“å‡ºå„ä¸ªåŒºåŸŸæ˜¯å¦åŒ…å«å¯¹è±¡ä¸­å¿ƒï¼Œè€Œä¸æ˜¯åŒ…å«å¯¹è±¡çš„ä¸€éƒ¨åˆ†YOLO æ¨¡å‹ä¼šåŒæ—¶è¾“å‡ºå¯¹è±¡åˆ†ç±»YOLO æ¨¡å‹è¾“å‡ºçš„åŒºåŸŸåç§»ä¼šæ ¹æ®å¯¹è±¡ä¸­å¿ƒç‚¹è®¡ç®—ï¼Œå…·ä½“ç®—æ³•åœ¨ä¸‹é¢è¯´æ˜ YOLO æ¨¡å‹ä¸ Faster-RCNN çš„åŒºåŸŸç”Ÿæˆç½‘ç»œæœ€å¤§çš„ä¸åŒæ˜¯ä¼šåˆ¤æ–­å„ä¸ªåŒºåŸŸæ˜¯å¦åŒ…å«å¯¹è±¡ä¸­å¿ƒï¼Œå¦‚ä¸‹å›¾ä¸­ç‹—è„¸è¦†ç›–äº†å››ä¸ªåŒºåŸŸï¼Œä½†åªæœ‰å·¦ä¸‹è§’çš„åŒºåŸŸåŒ…å«äº†ç‹—è„¸çš„ä¸­å¿ƒï¼ŒYOLO æ¨¡å‹åº”è¯¥åªåˆ¤æ–­è¿™ä¸ªåŒºåŸŸåŒ…å«å¯¹è±¡ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7161fdaf35e294cd066e653307eeed70/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-01T09:14:48+08:00" />
<meta property="article:modified_time" content="2022-11-01T09:14:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">æ¯•ä¸šè®¾è®¡ : åŸºäºæ·±åº¦å­¦ä¹ çš„å£ç½©ä½©æˆ´æ£€æµ‹ã€å…¨ç½‘æœ€è¯¦ç»†ã€‘ - opencv å·ç§¯ç¥ç»ç½‘ç»œ æœºå™¨è§†è§‰ æ·±åº¦å­¦ä¹ </h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>æ–‡ç« ç›®å½•</h4> 
 <ul><li><a href="#_0__2" rel="nofollow">ğŸš© 0 ç®€ä»‹</a></li><li><a href="#1__10" rel="nofollow">ğŸš©1 è¯¾é¢˜èƒŒæ™¯</a></li><li><a href="#_2__23" rel="nofollow">ğŸš© 2 å£ç½©ä½©æˆ´ç®—æ³•å®ç°</a></li><li><ul><li><a href="#21_YOLO__25" rel="nofollow">2.1 YOLO æ¨¡å‹æ¦‚è§ˆ</a></li><li><a href="#22_YOLOv3_71" rel="nofollow">2.2 YOLOv3</a></li><li><a href="#23_YOLO__79" rel="nofollow">2.3 YOLO å£ç½©ä½©æˆ´æ£€æµ‹å®ç°</a></li><li><ul><li><a href="#_84" rel="nofollow">æ•°æ®é›†</a></li></ul> 
   </li><li><a href="#24__95" rel="nofollow">2.4 å®ç°ä»£ç </a></li><li><a href="#25__969" rel="nofollow">2.5 æ£€æµ‹æ•ˆæœ</a></li></ul> 
  </li><li><a href="#_3__989" rel="nofollow">ğŸš© 3 å£ç½©ä½©æˆ´æ£€æµ‹ç®—æ³•è¯„ä»·æŒ‡æ ‡</a></li><li><ul><li><a href="#31_Accuracy_998" rel="nofollow">3.1 å‡†ç¡®ç‡ï¼ˆAccuracyï¼‰</a></li><li><a href="#32_PrecisionRecall_1005" rel="nofollow">3.2 ç²¾ç¡®ç‡(Precision)å’Œå¬å›ç‡(Recall)</a></li><li><a href="#33_Average_precision_AP_1015" rel="nofollow">3.3 å¹³å‡ç²¾åº¦(Average precision AP)</a></li></ul> 
  </li><li><a href="#_4__1026" rel="nofollow">ğŸš© 4 æœ€å</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_0__2"></a>ğŸš© 0 ç®€ä»‹</h2> 
<p>ä»Šå¤©å­¦é•¿å‘å¤§å®¶ä»‹ç»ä¸€ä¸ªæœºå™¨è§†è§‰çš„æ¯•è®¾é¡¹ç›®</p> 
<p><strong>åŸºäºæ·±åº¦å­¦ä¹ çš„å£ç½©ä½©æˆ´æ£€æµ‹ã€å…¨ç½‘æœ€è¯¦ç»†ã€‘ - opencv å·ç§¯ç¥ç»ç½‘ç»œ æœºå™¨è§†è§‰ æ·±åº¦å­¦ä¹ </strong></p> 
<h2><a id="1__10"></a>ğŸš©1 è¯¾é¢˜èƒŒæ™¯</h2> 
<p>ä»2019å¹´æœ«å¼€å§‹ï¼Œæ–°å‹å† çŠ¶ç—…æ¯’è‚ºç‚ï¼ˆCOVID-19ï¼‰åœ¨æˆ‘å›½å…¨é¢çˆ†å‘å¹¶è¿…é€Ÿä¼ æ’­ï¼ŒåŒæ—¶å›½å®¶å«ç”Ÿå¥åº·å§”å‘˜ä¼šä¹Ÿç§¯æå“åº”å¯†åˆ‡å…³æ³¨å…¨å›½ç–«æƒ…çš„åŠ¨æ€å˜åŒ–å¹¶ä¸”å‘å¸ƒäº†ç›¸å…³çš„é¢„é˜²æŒ‡å—ï¼Œå¼ºè°ƒä¸ªäººå‡ºè¡Œéœ€è¦åšå¥½å®‰å…¨æªæ–½ï¼Œåœ¨å…¬å…±åœºåˆå¿…é¡»ä¸¥æ ¼æŒ‰ç…§è¦æ±‚ä½©æˆ´å£ç½©ã€‚è‡ªä»æ–°å‹å† çŠ¶ç—…æ¯’è”“å»¶ä»¥æ¥ï¼Œå„è¡Œå„ä¸šéƒ½å—åˆ°äº†å·¨å¤§çš„å†²å‡»ï¼Œä¸¥é‡å½±å“åˆ°äººä»¬æ­£å¸¸ç”Ÿäº§å’Œç”Ÿæ´»ã€‚</p> 
<p>æ–°å‹å† çŠ¶ç—…æ¯’å…·æœ‰å¾ˆå¼ºçš„ä¼ æ’­å’Œç”Ÿå­˜èƒ½åŠ›ï¼Œåªè¦æ¡ä»¶åˆé€‚èƒ½å­˜æ´»äº”å¤©ä¹‹ä¹…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å”¾æ¶²ï¼Œé£æ²«ç­‰å¤šç§æ–¹å¼è¿›è¡Œä¼ æ’­ï¼Œä¸ºæœ‰æ•ˆçš„å‡å°‘ç—…æ¯’çš„ä¼ æ’­ä½©æˆ´å£ç½©æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŠæ³•ã€‚å°½ç®¡è¿™ä¸€æ—¶æœŸå›½å¤–çš„å½¢åŠ¿ä¸å®¹ä¹è§‚ï¼Œä½†æ˜¯åœ¨å…¨å›½ä¸Šä¸‹é½å¿ƒåŠªåŠ›ä¹‹ä¸‹æˆ‘å›½çš„é˜²ç–«å–å¾—äº†é˜¶æ®µæ€§æˆåŠŸï¼Œå„è¡Œä¸šéƒ½åœ¨ç§¯æå¤è‹ï¼Œç®¡ç†ä¹Ÿéšä¹‹å˜åŒ–è¿›å…¥åˆ°å¸¸æ€åŒ–é˜¶æ®µã€‚åœ¨è¿™ä¸€é˜¶æ®µå¤å·¥å¤äº§ä¹Ÿæ˜¯å¤§åŠ¿æ‰€è¶‹ï¼Œå£ç½©å‡ºè¡Œä¹Ÿæˆä¸ºäº†ä¸€ç§å¸¸æ€ã€‚æ­£ç¡®ä½©æˆ´å£ç½©èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘é£æ²«ä¼ æŸ“çš„é£é™©ï¼Œç‰¹åˆ«æ˜¯åœ¨å…¬å…±åœºæ‰€ï¼Œè¿™ç§ä¸¾æªå°¤ä¸ºé‡è¦ã€‚ä½†æ˜¯ï¼Œä»ç„¶è¿˜éœ€è¦æé«˜å…¬ä¼—å¯¹ä¸»åŠ¨ä½©æˆ´å£ç½©çš„è§‚å¿µï¼Œåœ¨å¸¸æ€åŒ–ç®¡ç†ä¸‹äººä»¬çš„é˜²èŒƒæ„è¯†è¶Šæ¥è¶Šè–„å¼±ï¼Œå£ç½©éšæ„ä½©æˆ´æˆ–è€…ä¸ä½©æˆ´çš„æƒ…å†µå±¡è§ä¸é²œã€‚</p> 
<p>å› æ­¤ï¼Œåœ¨è¿™æœŸé—´ï¼Œæœ‰æ„è¯†åœ°æˆ´å£ç½©ä¸ä»…ä»…æ˜¯æ¯ä¸ªå…¬æ°‘çš„å…¬å…±é“å¾·è¿˜æ˜¯è‡ªæˆ‘ä¿®å…»çš„è¡¨ç°ã€‚è¿™ä¸ä½†éœ€è¦ä¸ªäººç§¯æé…åˆï¼Œè€Œä¸”è¿˜éœ€è¦æŸäº›ç›‘ç®¡ä»¥åŠæœ‰æ•ˆçš„æ²»ç†æ–¹æ³•ã€‚</p> 
<p><img src="https://images2.imgbox.com/47/9f/VUUqn4HE_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h2><a id="_2__23"></a>ğŸš© 2 å£ç½©ä½©æˆ´ç®—æ³•å®ç°</h2> 
<h3><a id="21_YOLO__25"></a>2.1 YOLO æ¨¡å‹æ¦‚è§ˆ</h3> 
<p>YOLO çš„ç¼©å†™æ˜¯ You only look onceã€‚YOLO æ¨¡å‹å¯ä»¥ç›´æ¥æ ¹æ®å›¾ç‰‡è¾“å‡ºåŒ…å«å¯¹è±¡çš„åŒºåŸŸä¸åŒºåŸŸå¯¹åº”çš„åˆ†ç±»ï¼Œä¸€æ­¥åˆ°ä½ï¼Œä¸åƒ RCNN ç³»åˆ—çš„æ¨¡å‹éœ€è¦å…ˆè®¡ç®—åŒ…å«å¯¹è±¡çš„åŒºåŸŸï¼Œå†æ ¹æ®åŒºåŸŸåˆ¤æ–­å¯¹åº”çš„åˆ†ç±»ï¼ŒYOLO æ¨¡å‹çš„é€Ÿåº¦æ¯” RCNN ç³»åˆ—çš„æ¨¡å‹è¦å¿«å¾ˆå¤šã€‚</p> 
<p>YOLO æ¨¡å‹çš„ç»“æ„å¦‚ä¸‹ï¼š</p> 
<p><img src="https://images2.imgbox.com/de/63/fyqqNb3v_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹ç†Ÿæ‚‰ï¼Ÿçœ‹ä¸Šå»å°±åƒ Faster-RCNN çš„åŒºåŸŸç”Ÿæˆç½‘ç»œ (RPN) å•Šã€‚çš„ç¡®ï¼ŒYOLO æ¨¡å‹åŸç†ä¸Šå°±æ˜¯å¯»æ‰¾åŒºåŸŸçš„åŒæ—¶åˆ¤æ–­åŒºåŸŸåŒ…å«çš„å¯¹è±¡åˆ†ç±»ï¼ŒYOLO æ¨¡å‹ä¸åŒºåŸŸç”Ÿæˆç½‘ç»œæœ‰ä»¥ä¸‹çš„ä¸åŒï¼š</p> 
<ul><li>YOLO æ¨¡å‹ä¼šè¾“å‡ºå„ä¸ªåŒºåŸŸæ˜¯å¦åŒ…å«å¯¹è±¡ä¸­å¿ƒï¼Œè€Œä¸æ˜¯åŒ…å«å¯¹è±¡çš„ä¸€éƒ¨åˆ†</li><li>YOLO æ¨¡å‹ä¼šåŒæ—¶è¾“å‡ºå¯¹è±¡åˆ†ç±»</li><li>YOLO æ¨¡å‹è¾“å‡ºçš„åŒºåŸŸåç§»ä¼šæ ¹æ®å¯¹è±¡ä¸­å¿ƒç‚¹è®¡ç®—ï¼Œå…·ä½“ç®—æ³•åœ¨ä¸‹é¢è¯´æ˜</li></ul> 
<p>YOLO æ¨¡å‹ä¸ Faster-RCNN çš„åŒºåŸŸç”Ÿæˆç½‘ç»œæœ€å¤§çš„ä¸åŒæ˜¯ä¼šåˆ¤æ–­å„ä¸ªåŒºåŸŸæ˜¯å¦åŒ…å«å¯¹è±¡ä¸­å¿ƒï¼Œå¦‚ä¸‹å›¾ä¸­ç‹—è„¸è¦†ç›–äº†å››ä¸ªåŒºåŸŸï¼Œä½†åªæœ‰å·¦ä¸‹è§’çš„åŒºåŸŸåŒ…å«äº†ç‹—è„¸çš„ä¸­å¿ƒï¼ŒYOLO æ¨¡å‹åº”è¯¥åªåˆ¤æ–­è¿™ä¸ªåŒºåŸŸåŒ…å«å¯¹è±¡ã€‚</p> 
<p><img src="https://images2.imgbox.com/a1/28/2qobSXf5_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>å½“ç„¶ï¼Œå¦‚æœå¯¹è±¡ä¸­å¿ƒéå¸¸æ¥è¿‘åŒºåŸŸçš„è¾¹ç•Œï¼Œé‚£ä¹ˆåˆ¤æ–­èµ·æ¥å°†ä¼šå¾ˆå›°éš¾ï¼ŒYOLO æ¨¡å‹åœ¨è®­ç»ƒçš„æ—¶å€™ä¼šå¿½ç•¥å¯¹è±¡é‡å ç‡é«˜äºä¸€å®šæ°´å¹³çš„åŒºåŸŸï¼Œå…·ä½“å¯ä»¥å‚è€ƒåé¢ç»™å‡ºçš„ä»£ç ã€‚</p> 
<p>YOLO æ¨¡å‹ä¼šé’ˆå¯¹å„ä¸ªåŒºåŸŸè¾“å‡ºä»¥ä¸‹çš„ç»“æœï¼Œè¿™é‡Œå‡è®¾æœ‰ä¸‰ä¸ªåˆ†ç±»ï¼š</p> 
<ul><li>æ˜¯å¦åŒ…å«å¯¹è±¡ä¸­å¿ƒ (æ˜¯ä¸º 1, å¦ä¸º 0)</li><li>åŒºåŸŸåç§» x</li><li>åŒºåŸŸåç§» y</li><li>åŒºåŸŸåç§» w</li><li>åŒºåŸŸåç§» h</li><li>åˆ†ç±» 1 çš„å¯èƒ½æ€§ (0 ~ 1)</li><li>åˆ†ç±» 2 çš„å¯èƒ½æ€§ (0 ~ 1)</li><li>åˆ†ç±» 3 çš„å¯èƒ½æ€§ (0 ~ 1)</li></ul> 
<p><strong>è¾“å‡ºç»“æœçš„ç»´åº¦æ˜¯ æ‰¹æ¬¡å¤§å°, åŒºåŸŸæ•°é‡, 5 + åˆ†ç±»æ•°é‡ã€‚</strong></p> 
<p>åŒºåŸŸåç§»ç”¨äºè°ƒæ•´è¾“å‡ºçš„åŒºåŸŸèŒƒå›´ï¼Œä¾‹å¦‚ä¸Šå›¾ä¸­ç‹—è„¸çš„ä¸­å¿ƒç‚¹å¤§çº¦åœ¨åŒºåŸŸçš„å³ä¸Šè§’ï¼Œå¦‚æœæŠŠåŒºåŸŸå·¦ä¸Šè§’çœ‹ä½œ (0, 0)ï¼Œå³ä¸‹è§’çœ‹ä½œ (1, 1)ï¼Œé‚£ä¹ˆç‹—è„¸ä¸­å¿ƒç‚¹åº”è¯¥åœ¨ (0.95, 0.1) çš„ä½ç½®ï¼Œè€Œç‹—è„¸å¤§å°ç›¸å¯¹äºåŒºåŸŸé•¿å®½å¤§æ¦‚æ˜¯ (1.3, 1.5) å€ï¼Œç”Ÿæˆè®­ç»ƒæ•°æ®çš„æ—¶å€™ä¼šæ ¹æ®è¿™ 4 ä¸ªå€¼è®¡ç®—åŒºåŸŸåç§»ï¼Œå…·ä½“è®¡ç®—ä»£ç åœ¨ä¸‹é¢ç»™å‡ºã€‚</p> 
<p><img src="https://images2.imgbox.com/7d/7e/Ix6W0czN_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šæƒ³ï¼ŒYOLO æ¨¡å‹çœ‹èµ·æ¥å¾ˆç®€å•å•Šï¼Œæˆ‘å¯ä»¥ä¸¢æ‰æ“è›‹çš„ Faster-RCNN æ¨¡å‹äº†ğŸ¤¢ã€‚</p> 
<p>ä¸ï¼Œæ²¡é‚£ä¹ˆç®€å•ï¼Œä»¥ä¸Šä»‹ç»çš„åªæ˜¯ YOLOv1 æ¨¡å‹ï¼ŒYOLOv1 æ¨¡å‹çš„ç²¾åº¦éå¸¸ä½ï¼Œåé¢ä¸ºäº†æ”¹è¿›è¯†åˆ«ç²¾åº¦è¿˜å‘å±•å‡º YOLOv2, YOLOv3, YOLOv4, YOLOv5 æ¨¡å‹ğŸ˜®ï¼Œå­¦é•¿ä¸‹é¢ä¼šç»™å‡º YOLOv3 æ¨¡å‹çš„å®ç°ã€‚Y</p> 
<p><strong>OLOv4 å’Œ YOLOv5 æ¨¡å‹ä¸»è¦æ”¹è¿›äº†æå–ç‰¹å¾ç”¨çš„ CNN æ¨¡å‹ (ä¹Ÿç§°éª¨å¹²ç½‘ç»œ Backbone Network)ï¼ŒåŸå§‹çš„ YOLO æ¨¡å‹ä½¿ç”¨äº† C è¯­è¨€ç¼–å†™çš„ Darknet ä½œä¸ºéª¨å¹²ç½‘ç»œï¼Œè€Œè¿™ç¯‡ä½¿ç”¨ Resnet ä½œä¸ºéª¨å¹²ç½‘ç»œï¼Œæ‰€ä»¥ä»Šå¤©å­¦é•¿åªä»‹ç»åˆ° YOLOv3ã€‚</strong></p> 
<h3><a id="22_YOLOv3_71"></a>2.2 YOLOv3</h3> 
<p>YOLOv3 å¼•å…¥äº†å¤šå°ºåº¦æ£€æµ‹æœºåˆ¶ (Multi-Scale Detection)ï¼Œè¿™ä¸ªæœºåˆ¶å¯ä»¥è¯´æ˜¯ YOLO æ¨¡å‹çš„ç²¾åï¼Œå¼•å…¥è¿™ä¸ªæœºåˆ¶ä¹‹å‰ YOLO æ¨¡å‹çš„ç²¾åº¦å¾ˆä¸ç†æƒ³ï¼Œè€Œå¼•å…¥ä¹‹å YOLO æ¨¡å‹è¾¾åˆ°äº†æ¥è¿‘ Faster-RCNN çš„ç²¾åº¦ï¼Œå¹¶ä¸”é€Ÿåº¦è¿˜æ˜¯æ¯” Faster-RCNN è¦å¿«ã€‚</p> 
<p>å¤šå°ºåº¦æ£€æµ‹æœºåˆ¶ç®€å•çš„æ¥è¯´å°±æ˜¯æŒ‰ä¸åŒçš„å°ºåº¦åˆ’åˆ†åŒºåŸŸï¼Œç„¶åå†æ£€æµ‹è¿™äº›ä¸åŒå¤§å°çš„åŒºåŸŸæ˜¯å¦åŒ…å«å¯¹è±¡ï¼Œæ£€æµ‹çš„æ—¶å€™å¤§åŒºåŸŸçš„ç‰¹å¾ä¼šæ··åˆåˆ°å°åŒºåŸŸä¸­ï¼Œä½¿å¾—å°åŒºåŸŸåˆ¤æ–­æ—¶æ‹¥æœ‰ä¸€å®šç¨‹åº¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p> 
<p><img src="https://images2.imgbox.com/6b/d7/maMELDKX_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="23_YOLO__79"></a>2.3 YOLO å£ç½©ä½©æˆ´æ£€æµ‹å®ç°</h3> 
<p><strong>æ¥ä¸‹æ¥å­¦é•¿å¸¦å¤§å®¶ç”¨ YOLO æ¨¡å‹æŠŠæ²¡å¸¦å£ç½©çš„å®¶ä¼™æŠ“å‡ºæ¥å§ã€‚</strong></p> 
<h4><a id="_84"></a>æ•°æ®é›†</h4> 
<p><img src="https://images2.imgbox.com/24/c4/bGpZXgcS_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> å­¦é•¿çš„è¿™ä¸ªæ•°æ®é›†åŒ…å«äº† 8535 å¼ å›¾ç‰‡ (éƒ¨åˆ†å›¾ç‰‡æ²¡æœ‰ä½¿ç”¨)ï¼Œå…¶ä¸­å„ä¸ªåˆ†ç±»çš„æ•°é‡å¦‚ä¸‹ï¼š</p> 
<ul><li>æˆ´å£ç½©çš„åŒºåŸŸ (with_mask): 3232 ä¸ª</li><li>ä¸æˆ´å£ç½©çš„åŒºåŸŸ (without_mask): 717 ä¸ª</li><li>å¸¦äº†å£ç½©ä½†å§¿åŠ¿ä¸æ­£ç¡®çš„åŒºåŸŸ (mask_weared_incorrect): 123 ä¸ª</li></ul> 
<p>å› ä¸ºå¸¦äº†å£ç½©ä½†å§¿åŠ¿ä¸æ­£ç¡®çš„æ ·æœ¬æ•°é‡å¾ˆå°‘ï¼Œæ‰€ä»¥éƒ½å½’åˆ°æˆ´å£ç½©é‡Œé¢å»ğŸ˜ ã€‚</p> 
<h3><a id="24__95"></a>2.4 å®ç°ä»£ç </h3> 
<p><strong>ä½¿ç”¨è¿™ä¸ªæ•°æ®é›†è®­ç»ƒï¼Œå¹¶ä¸”è®­ç»ƒæˆåŠŸä»¥åä½¿ç”¨æ¨¡å‹è¯†åˆ«å›¾ç‰‡æˆ–è§†é¢‘çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</strong></p> 
<pre><code class="prism language-python">
<span class="token comment"># ä½œè€…ï¼šä¸¹æˆå­¦é•¿ï¼Œq746876041</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> gzip
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> random
<span class="token keyword">import</span> numpy
<span class="token keyword">import</span> math
<span class="token keyword">import</span> pandas
<span class="token keyword">import</span> json
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageDraw
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageFont
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token keyword">from</span> collections <span class="token keyword">import</span> deque
<span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>cElementTree <span class="token keyword">as</span> ET

<span class="token comment"># ç¼©æ”¾å›¾ç‰‡çš„å¤§å°</span>
IMAGE_SIZE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">)</span>
<span class="token comment"># è®­ç»ƒä½¿ç”¨çš„æ•°æ®é›†è·¯å¾„</span>
DATASET_1_IMAGE_DIR <span class="token operator">=</span> <span class="token string">"./archive/images"</span>
DATASET_1_ANNOTATION_DIR <span class="token operator">=</span> <span class="token string">"./archive/annotations"</span>
DATASET_2_IMAGE_DIR <span class="token operator">=</span> <span class="token string">"./784145_1347673_bundle_archive/train/image_data"</span>
DATASET_2_BOX_CSV_PATH <span class="token operator">=</span> <span class="token string">"./784145_1347673_bundle_archive/train/bbox_train.csv"</span>
<span class="token comment"># åˆ†ç±»åˆ—è¡¨</span>
<span class="token comment"># YOLO åŸåˆ™ä¸Šä¸éœ€è¦ other åˆ†ç±»ï¼Œä½†å®æµ‹ä¸­æ·»åŠ è¿™ä¸ªåˆ†ç±»æœ‰åŠ©äºæå‡æ ‡ç­¾åˆ†ç±»çš„ç²¾ç¡®åº¦</span>
CLASSES <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"other"</span><span class="token punctuation">,</span> <span class="token string">"with_mask"</span><span class="token punctuation">,</span> <span class="token string">"without_mask"</span> <span class="token punctuation">]</span>
CLASSES_MAPPING <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> c<span class="token punctuation">:</span> index <span class="token keyword">for</span> index<span class="token punctuation">,</span> c <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>CLASSES<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token comment"># åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹è±¡ä½¿ç”¨çš„åŒºåŸŸé‡å ç‡çš„é˜ˆå€¼ (å¦å¤–è¦æ±‚å¯¹è±¡ä¸­å¿ƒåœ¨åŒºåŸŸå†…)</span>
IOU_POSITIVE_THRESHOLD <span class="token operator">=</span> <span class="token number">0.30</span>
IOU_NEGATIVE_THRESHOLD <span class="token operator">=</span> <span class="token number">0.30</span>

<span class="token comment"># ç”¨äºå¯ç”¨ GPU æ”¯æŒ</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">BasicBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ResNet ä½¿ç”¨çš„åŸºç¡€å—"""</span>
    expansion <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># å®šä¹‰è¿™ä¸ªå—çš„å®é™…å‡ºé€šé“æ˜¯ channels_out çš„å‡ å€ï¼Œè¿™é‡Œçš„å®ç°å›ºå®šæ˜¯ä¸€å€</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channels_in<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># ç”Ÿæˆ 3x3 çš„å·ç§¯å±‚</span>
        <span class="token comment"># å¤„ç†é—´éš” stride = 1 æ—¶ï¼Œè¾“å‡ºçš„é•¿å®½ä¼šç­‰äºè¾“å…¥çš„é•¿å®½ï¼Œä¾‹å¦‚ (32-3+2)//1+1 == 32</span>
        <span class="token comment"># å¤„ç†é—´éš” stride = 2 æ—¶ï¼Œè¾“å‡ºçš„é•¿å®½ä¼šç­‰äºè¾“å…¥çš„é•¿å®½çš„ä¸€åŠï¼Œä¾‹å¦‚ (32-3+2)//2+1 == 16</span>
        <span class="token comment"># æ­¤å¤– resnet çš„ 3x3 å·ç§¯å±‚ä¸ä½¿ç”¨åç§»å€¼ bias</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels_in<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>channels_out<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># å†å®šä¹‰ä¸€ä¸ªè®©è¾“å‡ºå’Œè¾“å…¥ç»´åº¦ç›¸åŒçš„ 3x3 å·ç§¯å±‚</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels_out<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>channels_out<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># è®©åŸå§‹è¾“å…¥å’Œè¾“å‡ºç›¸åŠ çš„æ—¶å€™ï¼Œéœ€è¦ç»´åº¦ä¸€è‡´ï¼Œå¦‚æœç»´åº¦ä¸ä¸€è‡´åˆ™éœ€è¦æ•´åˆ</span>
        self<span class="token punctuation">.</span>identity <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> stride <span class="token operator">!=</span> <span class="token number">1</span> <span class="token keyword">or</span> channels_in <span class="token operator">!=</span> channels_out <span class="token operator">*</span> self<span class="token punctuation">.</span>expansion<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>identity <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels_in<span class="token punctuation">,</span> channels_out <span class="token operator">*</span> self<span class="token punctuation">.</span>expansion<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>channels_out <span class="token operator">*</span> self<span class="token punctuation">.</span>expansion<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># x =&gt; conv1 =&gt; relu =&gt; conv2 =&gt; + =&gt; relu</span>
        <span class="token comment"># |                              ^</span>
        <span class="token comment"># |==============================|</span>
        tmp <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        tmp <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        tmp <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
        tmp <span class="token operator">+=</span> self<span class="token punctuation">.</span>identity<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        y <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> y

<span class="token keyword">class</span> <span class="token class-name">MyModel</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""YOLO (åŸºäº ResNet çš„å˜ç§)"""</span>
    Anchors <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># é”šç‚¹åˆ—è¡¨ï¼ŒåŒ…å« é”šç‚¹æ•°é‡ * å½¢çŠ¶æ•°é‡ çš„èŒƒå›´</span>
    AnchorSpans <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token comment"># å°ºåº¦åˆ—è¡¨ï¼Œå€¼ä¸ºé”šç‚¹ä¹‹é—´çš„è·ç¦»</span>
    AnchorAspects <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># é”šç‚¹å¯¹åº”åŒºåŸŸçš„é•¿å®½æ¯”ä¾‹åˆ—è¡¨</span>
    AnchorOutputs <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>CLASSES<span class="token punctuation">)</span> <span class="token comment"># æ¯ä¸ªé”šç‚¹èŒƒå›´å¯¹åº”çš„è¾“å‡ºæ•°é‡ï¼Œæ˜¯å¦å¯¹è±¡ä¸­å¿ƒ (1) + åŒºåŸŸåç§» (4) + åˆ†ç±»æ•°é‡</span>
    AnchorTotalOutputs <span class="token operator">=</span> AnchorOutputs <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>AnchorAspects<span class="token punctuation">)</span> <span class="token comment"># æ¯ä¸ªé”šç‚¹å¯¹åº”çš„è¾“å‡ºæ•°é‡</span>
    ObjScoreThreshold <span class="token operator">=</span> <span class="token number">0.9</span> <span class="token comment"># è®¤ä¸ºæ˜¯å¯¹è±¡ä¸­å¿ƒæ‰€éœ€è¦çš„æœ€å°åˆ†æ•°</span>
    IOUMergeThreshold <span class="token operator">=</span> <span class="token number">0.3</span> <span class="token comment"># åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆå¹¶é‡å åŒºåŸŸçš„é‡å ç‡é˜ˆå€¼</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># æŠ½å–å›¾ç‰‡ç‰¹å¾çš„ ResNet</span>
        <span class="token comment"># å› ä¸ºé”šç‚¹è·ç¦»æœ‰ä¸‰ä¸ªï¼Œè¿™é‡Œæœ€åä¼šè¾“å‡ºå„ä¸ªé”šç‚¹è·ç¦»å¯¹åº”çš„ç‰¹å¾</span>
        self<span class="token punctuation">.</span>previous_channels_out <span class="token operator">=</span> <span class="token number">4</span>
        self<span class="token punctuation">.</span>resnet_models <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>
            nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># æ ¹æ®å„ä¸ªé”šç‚¹è·ç¦»å¯¹åº”çš„ç‰¹å¾é¢„æµ‹è¾“å‡ºçš„å·ç§¯å±‚</span>
        <span class="token comment"># å¤§çš„é”šç‚¹è·ç¦»æŠ½å–çš„ç‰¹å¾ä¼šåˆå¹¶åˆ°å°çš„é”šç‚¹è·ç¦»æŠ½å–çš„ç‰¹å¾</span>
        <span class="token comment"># è¿™é‡Œçš„ä¸‰ä¸ªå­æ¨¡å‹æ„ä¹‰åˆ†åˆ«æ˜¯:</span>
        <span class="token comment"># - è®¡ç®—ç”¨äºåˆå¹¶çš„ç‰¹å¾</span>
        <span class="token comment"># - æ”¾å¤§ç‰¹å¾</span>
        <span class="token comment"># - è®¡ç®—æœ€ç»ˆçš„é¢„æµ‹è¾“å‡º</span>
        self<span class="token punctuation">.</span>yolo_detectors <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>
            nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span> <span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">(</span>scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"nearest"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> MyModel<span class="token punctuation">.</span>AnchorTotalOutputs<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>resnet_models<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># å¤„ç†ç»“æœèŒƒå›´çš„å‡½æ•°</span>
        self<span class="token punctuation">.</span>sigmoid <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_make_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> block_type<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""åˆ›å»º resnet ä½¿ç”¨çš„å±‚"""</span>
        blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># æ·»åŠ ç¬¬ä¸€ä¸ªå—</span>
        blocks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block_type<span class="token punctuation">(</span>self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>previous_channels_out <span class="token operator">=</span> channels_out <span class="token operator">*</span> block_type<span class="token punctuation">.</span>expansion
        <span class="token comment"># æ·»åŠ å‰©ä½™çš„å—ï¼Œå‰©ä½™çš„å—å›ºå®šå¤„ç†é—´éš”ä¸º 1ï¼Œä¸ä¼šæ”¹å˜é•¿å®½</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_blocks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            blocks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block_type<span class="token punctuation">(</span>self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">,</span> self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>previous_channels_out <span class="token operator">*=</span> block_type<span class="token punctuation">.</span>expansion
        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>blocks<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">_generate_anchors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ¹æ®é”šç‚¹å’Œå½¢çŠ¶ç”Ÿæˆé”šç‚¹èŒƒå›´åˆ—è¡¨"""</span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> IMAGE_SIZE
        anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> span <span class="token keyword">in</span> MyModel<span class="token punctuation">.</span>AnchorSpans<span class="token punctuation">:</span>
            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> span<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> span<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    xcenter<span class="token punctuation">,</span> ycenter <span class="token operator">=</span> x <span class="token operator">+</span> span <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">+</span> span <span class="token operator">/</span> <span class="token number">2</span>
                    <span class="token keyword">for</span> ratio <span class="token keyword">in</span> MyModel<span class="token punctuation">.</span>AnchorAspects<span class="token punctuation">:</span>
                        ww <span class="token operator">=</span> span <span class="token operator">*</span> ratio<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                        hh <span class="token operator">=</span> span <span class="token operator">*</span> ratio<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                        xx <span class="token operator">=</span> xcenter <span class="token operator">-</span> ww <span class="token operator">/</span> <span class="token number">2</span>
                        yy <span class="token operator">=</span> ycenter <span class="token operator">-</span> hh <span class="token operator">/</span> <span class="token number">2</span>
                        xx <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        yy <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>yy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        ww <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>ww<span class="token punctuation">)</span><span class="token punctuation">,</span> w <span class="token operator">-</span> xx<span class="token punctuation">)</span>
                        hh <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>hh<span class="token punctuation">)</span><span class="token punctuation">,</span> h <span class="token operator">-</span> yy<span class="token punctuation">)</span>
                        anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>xx<span class="token punctuation">,</span> yy<span class="token punctuation">,</span> ww<span class="token punctuation">,</span> hh<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> anchors

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># æŠ½å–å„ä¸ªé”šç‚¹è·ç¦»å¯¹åº”çš„ç‰¹å¾</span>
        <span class="token comment"># ç»´åº¦åˆ†åˆ«æ˜¯:</span>
        <span class="token comment"># torch.Size([16, 256, 16, 12])</span>
        <span class="token comment"># torch.Size([16, 256, 8, 6])</span>
        <span class="token comment"># torch.Size([16, 256, 4, 3])</span>
        features_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        resnet_input <span class="token operator">=</span> x
        <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>resnet_models<span class="token punctuation">:</span>
            resnet_input <span class="token operator">=</span> m<span class="token punctuation">(</span>resnet_input<span class="token punctuation">)</span>
            features_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>resnet_input<span class="token punctuation">)</span>
        <span class="token comment"># æ ¹æ®ç‰¹å¾é¢„æµ‹è¾“å‡º</span>
        <span class="token comment"># ç»´åº¦åˆ†åˆ«æ˜¯:</span>
        <span class="token comment"># torch.Size([16, 16, 4, 3])</span>
        <span class="token comment"># torch.Size([16, 16, 8, 6])</span>
        <span class="token comment"># torch.Size([16, 16, 16, 12])</span>
        <span class="token comment"># 16 æ˜¯ (5 + åˆ†ç±»3) * å½¢çŠ¶2</span>
        previous_upsampled_feature <span class="token operator">=</span> <span class="token boolean">None</span>
        outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> feature <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span>features_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> previous_upsampled_feature <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># åˆå¹¶å¤§çš„é”šç‚¹è·ç¦»æŠ½å–çš„ç‰¹å¾åˆ°å°çš„é”šç‚¹è·ç¦»æŠ½å–çš„ç‰¹å¾</span>
                feature <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>feature<span class="token punctuation">,</span> previous_upsampled_feature<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token comment"># è®¡ç®—ç”¨äºåˆå¹¶çš„ç‰¹å¾</span>
            hidden <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_detectors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span>
            <span class="token comment"># æ”¾å¤§ç‰¹å¾ (ç”¨äºä¸‹ä¸€æ¬¡å¤„ç†æ—¶åˆå¹¶)</span>
            upsampled <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_detectors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
            <span class="token comment"># è®¡ç®—æœ€ç»ˆçš„é¢„æµ‹è¾“å‡º</span>
            output <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_detectors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
            previous_upsampled_feature <span class="token operator">=</span> upsampled
            outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token comment"># è¿æ¥æ‰€æœ‰è¾“å‡º</span>
        <span class="token comment"># æ³¨æ„é¡ºåºéœ€è¦ä¸ Anchors ä¸€è‡´</span>
        outputs_flatten <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> output <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> output<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            output <span class="token operator">=</span> output<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> MyModel<span class="token punctuation">.</span>AnchorOutputs<span class="token punctuation">)</span>
            outputs_flatten<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        outputs_all <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>outputs_flatten<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># æ˜¯å¦å¯¹è±¡ä¸­å¿ƒåº”è¯¥åœ¨ 0 ~ 1 ä¹‹é—´ï¼Œä½¿ç”¨ sigmoid å¤„ç†</span>
        outputs_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>outputs_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># åˆ†ç±»åº”è¯¥åœ¨ 0 ~ 1 ä¹‹é—´ï¼Œä½¿ç”¨ sigmoid å¤„ç†</span>
        outputs_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>outputs_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> outputs_all

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">loss_function</span><span class="token punctuation">(</span>predicted<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""YOLO ä½¿ç”¨çš„å¤šä»»åŠ¡æŸå¤±è®¡ç®—å™¨"""</span>
        result_tensor<span class="token punctuation">,</span> result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks <span class="token operator">=</span> actual
        objectness_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        offsets_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        labels_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>result_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            mask_positive <span class="token operator">=</span> result_isobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span>
            mask_negative <span class="token operator">=</span> result_nonobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span>
            <span class="token comment"># è®¡ç®—æ˜¯å¦å¯¹è±¡ä¸­å¿ƒçš„æŸå¤±ï¼Œåˆ†åˆ«é’ˆå¯¹æ­£è´Ÿæ ·æœ¬è®¡ç®—</span>
            <span class="token comment"># å› ä¸ºå¤§éƒ¨åˆ†åŒºåŸŸä¸åŒ…å«å¯¹è±¡ä¸­å¿ƒï¼Œè¿™é‡Œå‡å°‘è´Ÿæ ·æœ¬çš„æŸå¤±å¯¹è°ƒæ•´å‚æ•°çš„å½±å“</span>
            objectness_loss_positive <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            objectness_loss_negative <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_negative<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_negative<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
            objectness_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>objectness_loss_positive<span class="token punctuation">)</span>
            objectness_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>objectness_loss_negative<span class="token punctuation">)</span>
            <span class="token comment"># è®¡ç®—åŒºåŸŸåç§»çš„æŸå¤±ï¼Œåªé’ˆå¯¹æ­£æ ·æœ¬è®¡ç®—</span>
            offsets_loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            offsets_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>offsets_loss<span class="token punctuation">)</span>
            <span class="token comment"># è®¡ç®—æ ‡ç­¾åˆ†ç±»çš„æŸå¤±ï¼Œåˆ†åˆ«é’ˆå¯¹æ­£è´Ÿæ ·æœ¬è®¡ç®—</span>
            labels_loss_positive <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>binary_cross_entropy<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            labels_loss_negative <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>binary_cross_entropy<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_negative<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_negative<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
            labels_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_loss_positive<span class="token punctuation">)</span>
            labels_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_loss_negative<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> <span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>objectness_losses<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>offsets_losses<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>labels_losses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> loss

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">calc_accuracy</span><span class="token punctuation">(</span>actual<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""YOLO ä½¿ç”¨çš„æ­£ç¡®ç‡è®¡ç®—å™¨ï¼Œè¿™é‡Œåªè®¡ç®—æ˜¯å¦å¯¹è±¡ä¸­å¿ƒä¸æ ‡ç­¾åˆ†ç±»çš„æ­£ç¡®ç‡ï¼ŒåŒºåŸŸåç§»ä¸è®¡ç®—"""</span>
        result_tensor<span class="token punctuation">,</span> result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks <span class="token operator">=</span> actual
        <span class="token comment"># è®¡ç®—æ˜¯å¦å¯¹è±¡ä¸­å¿ƒçš„æ­£ç¡®ç‡ï¼Œæ­£æ ·æœ¬å’Œè´Ÿæ ·æœ¬çš„æ­£ç¡®ç‡åˆ†åˆ«è®¡ç®—å†å¹³å‡</span>
        a <span class="token operator">=</span> result_tensor<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
        p <span class="token operator">=</span> predicted<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> MyModel<span class="token punctuation">.</span>ObjScoreThreshold
        obj_acc_positive <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.00001</span><span class="token punctuation">)</span>
        obj_acc_negative <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.00001</span><span class="token punctuation">)</span>
        obj_acc <span class="token operator">=</span> <span class="token punctuation">(</span>obj_acc_positive <span class="token operator">+</span> obj_acc_negative<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token comment"># è®¡ç®—æ ‡ç­¾åˆ†ç±»çš„æ­£ç¡®ç‡</span>
        cls_total <span class="token operator">=</span> <span class="token number">0</span>
        cls_correct <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>result_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            mask <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>result_isobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> result_nonobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            actual_classes <span class="token operator">=</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>indices
            predicted_classes <span class="token operator">=</span> predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>indices
            cls_total <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
            cls_correct <span class="token operator">+=</span> <span class="token punctuation">(</span>actual_classes <span class="token operator">==</span> predicted_classes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cls_acc <span class="token operator">=</span> cls_correct <span class="token operator">/</span> cls_total
        <span class="token keyword">return</span> obj_acc<span class="token punctuation">,</span> cls_acc

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">convert_predicted_result</span><span class="token punctuation">(</span>predicted<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è½¬æ¢é¢„æµ‹ç»“æœåˆ° (æ ‡ç­¾, åŒºåŸŸ, å¯¹è±¡ä¸­å¿ƒåˆ†æ•°, æ ‡ç­¾è¯†åˆ«åˆ†æ•°) çš„åˆ—è¡¨ï¼Œé‡å åŒºåŸŸä½¿ç”¨ NMS ç®—æ³•åˆå¹¶"""</span>
        <span class="token comment"># è®°å½•é‡å çš„ç»“æœåŒºåŸŸ, ç»“æœæ˜¯ [ [(æ ‡ç­¾, åŒºåŸŸ, RPN åˆ†æ•°, æ ‡ç­¾è¯†åˆ«åˆ†æ•°)], ... ]</span>
        final_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> anchor<span class="token punctuation">,</span> tensor <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">.</span>Anchors<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span><span class="token punctuation">:</span>
            obj_score <span class="token operator">=</span> tensor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> obj_score <span class="token operator">&lt;=</span> MyModel<span class="token punctuation">.</span>ObjScoreThreshold<span class="token punctuation">:</span>
                <span class="token comment"># è¦æ±‚å¯¹è±¡ä¸­å¿ƒåˆ†æ•°è¶…è¿‡ä¸€å®šå€¼</span>
                <span class="token keyword">continue</span>
            offset <span class="token operator">=</span> tensor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
            offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># ä¸­å¿ƒç‚¹ x çš„åç§»åº”è¯¥åœ¨ 0 ~ 1 ä¹‹é—´</span>
            offset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>offset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># ä¸­å¿ƒç‚¹ y çš„åç§»åº”è¯¥åœ¨ 0 ~ 1 ä¹‹é—´</span>
            box <span class="token operator">=</span> adjust_box_by_offset<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> offset<span class="token punctuation">)</span>
            label_max <span class="token operator">=</span> tensor<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            cls_score <span class="token operator">=</span> label_max<span class="token punctuation">.</span>values<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            label <span class="token operator">=</span> label_max<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> label <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token comment"># è·³è¿‡éå¯¹è±¡åˆ†ç±»</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>final_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                exists_results <span class="token operator">=</span> final_result<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>calc_iou<span class="token punctuation">(</span>box<span class="token punctuation">,</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> MyModel<span class="token punctuation">.</span>IOUMergeThreshold <span class="token keyword">for</span> r <span class="token keyword">in</span> exists_results<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    exists_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                final_result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># åˆå¹¶é‡å çš„ç»“æœåŒºåŸŸ (ä½¿ç”¨ å¯¹è±¡ä¸­å¿ƒåˆ†æ•° * æ ‡ç­¾è¯†åˆ«åˆ†æ•° æœ€é«˜çš„åŒºåŸŸä¸ºç»“æœåŒºåŸŸ)</span>
        <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>final_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            exists_results <span class="token operator">=</span> final_result<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
            exists_results<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>r<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            final_result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> exists_results<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> final_result

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">fix_predicted_result_from_history</span><span class="token punctuation">(</span>cls_result<span class="token punctuation">,</span> history_results<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ¹æ®å†å²ç»“æœå‡å°‘é¢„æµ‹ç»“æœä¸­çš„è¯¯åˆ¤ï¼Œé€‚ç”¨äºè§†é¢‘è¯†åˆ«ï¼Œhistory_results åº”ä¸ºæŒ‡å®šäº† maxlen çš„ deque"""</span>
        <span class="token comment"># è¦æ±‚å†å²ç»“æœä¸­ 50% ä»¥ä¸Šå­˜åœ¨ç±»ä¼¼åŒºåŸŸï¼Œå¹¶ä¸”é€‰å–å†å²ç»“æœä¸­æœ€å¤šçš„åˆ†ç±»</span>
        history_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls_result<span class="token punctuation">)</span>
        final_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>history_results<span class="token punctuation">)</span> <span class="token operator">&lt;</span> history_results<span class="token punctuation">.</span>maxlen<span class="token punctuation">:</span>
            <span class="token comment"># å†å²ç»“æœä¸è¶³ï¼Œä¸è¿”å›ä»»ä½•è¯†åˆ«ç»“æœ</span>
            <span class="token keyword">return</span> final_result
        <span class="token keyword">for</span> label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> rpn_score<span class="token punctuation">,</span> cls_score <span class="token keyword">in</span> cls_result<span class="token punctuation">:</span>
            <span class="token comment"># æŸ¥æ‰¾å†å²ä¸­çš„è¿‘ä¼¼åŒºåŸŸ</span>
            similar_results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> history_result <span class="token keyword">in</span> history_results<span class="token punctuation">:</span>
                history_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>calc_iou<span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> history_result<span class="token punctuation">]</span>
                history_result<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> history_result <span class="token keyword">and</span> history_result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> MyModel<span class="token punctuation">.</span>IOUMergeThreshold<span class="token punctuation">:</span>
                    similar_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>history_result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># åˆ¤æ–­è¿‘ä¼¼åŒºåŸŸæ•°é‡æ˜¯å¦è¿‡åŠ</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>similar_results<span class="token punctuation">)</span> <span class="token operator">&lt;</span> history_results<span class="token punctuation">.</span>maxlen <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment"># é€‰å–å†å²ç»“æœä¸­æœ€å¤šçš„åˆ†ç±»</span>
            cls_groups <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> r <span class="token keyword">in</span> similar_results<span class="token punctuation">:</span>
                cls_groups<span class="token punctuation">[</span>r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            most_common <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>cls_groups<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token comment"># æ·»åŠ æœ€å¤šçš„åˆ†ç±»ä¸­çš„æœ€æ–°çš„ç»“æœ</span>
            final_result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>most_common<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> final_result

MyModel<span class="token punctuation">.</span>Anchors <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>_generate_anchors<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">save_tensor</span><span class="token punctuation">(</span>tensor<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä¿å­˜ tensor å¯¹è±¡åˆ°æ–‡ä»¶"""</span>
    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>tensor<span class="token punctuation">,</span> gzip<span class="token punctuation">.</span>GzipFile<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">load_tensor</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä»æ–‡ä»¶è¯»å– tensor å¯¹è±¡"""</span>
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>gzip<span class="token punctuation">.</span>GzipFile<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">calc_resize_parameters</span><span class="token punctuation">(</span>sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""è®¡ç®—ç¼©æ”¾å›¾ç‰‡çš„å‚æ•°"""</span>
    sw_new<span class="token punctuation">,</span> sh_new <span class="token operator">=</span> sw<span class="token punctuation">,</span> sh
    dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> IMAGE_SIZE
    pad_w<span class="token punctuation">,</span> pad_h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">if</span> sw <span class="token operator">/</span> sh <span class="token operator">&lt;</span> dw <span class="token operator">/</span> dh<span class="token punctuation">:</span>
        sw_new <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>dw <span class="token operator">/</span> dh <span class="token operator">*</span> sh<span class="token punctuation">)</span>
        pad_w <span class="token operator">=</span> <span class="token punctuation">(</span>sw_new <span class="token operator">-</span> sw<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span> <span class="token comment"># å¡«å……å·¦å³</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        sh_new <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>dh <span class="token operator">/</span> dw <span class="token operator">*</span> sw<span class="token punctuation">)</span>
        pad_h <span class="token operator">=</span> <span class="token punctuation">(</span>sh_new <span class="token operator">-</span> sh<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span> <span class="token comment"># å¡«å……ä¸Šä¸‹</span>
    <span class="token keyword">return</span> sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h

<span class="token keyword">def</span> <span class="token function">resize_image</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ç¼©æ”¾å›¾ç‰‡ï¼Œæ¯”ä¾‹ä¸ä¸€è‡´æ—¶å¡«å……"""</span>
    sw<span class="token punctuation">,</span> sh <span class="token operator">=</span> img<span class="token punctuation">.</span>size
    sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h <span class="token operator">=</span> calc_resize_parameters<span class="token punctuation">(</span>sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
    img_new <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">)</span><span class="token punctuation">)</span>
    img_new<span class="token punctuation">.</span>paste<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>pad_w<span class="token punctuation">,</span> pad_h<span class="token punctuation">)</span><span class="token punctuation">)</span>
    img_new <span class="token operator">=</span> img_new<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_new

<span class="token keyword">def</span> <span class="token function">image_to_tensor</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""è½¬æ¢å›¾ç‰‡å¯¹è±¡åˆ° tensor å¯¹è±¡"""</span>
    arr <span class="token operator">=</span> numpy<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
    t <span class="token operator">=</span> t<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># è½¬æ¢ç»´åº¦ H,W,C åˆ° C,W,H</span>
    t <span class="token operator">=</span> t <span class="token operator">/</span> <span class="token number">255.0</span> <span class="token comment"># æ­£è§„åŒ–æ•°å€¼ä½¿å¾—èŒƒå›´åœ¨ 0 ~ 1</span>
    <span class="token keyword">return</span> t

<span class="token keyword">def</span> <span class="token function">map_box_to_resized_image</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æŠŠåŸå§‹åŒºåŸŸè½¬æ¢åˆ°ç¼©æ”¾åçš„å›¾ç‰‡å¯¹åº”çš„åŒºåŸŸ"""</span>
    x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> box
    sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h <span class="token operator">=</span> calc_resize_parameters<span class="token punctuation">(</span>sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
    scale <span class="token operator">=</span> IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> sw_new
    x <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> pad_w<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> pad_h<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    <span class="token keyword">if</span> x <span class="token operator">+</span> w <span class="token operator">&gt;</span> IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> y <span class="token operator">+</span> h <span class="token operator">&gt;</span> IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">or</span> w <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> h <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">return</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h

<span class="token keyword">def</span> <span class="token function">map_box_to_original_image</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æŠŠç¼©æ”¾åå›¾ç‰‡å¯¹åº”çš„åŒºåŸŸè½¬æ¢åˆ°ç¼©æ”¾å‰çš„åŸå§‹åŒºåŸŸ"""</span>
    x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> box
    sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h <span class="token operator">=</span> calc_resize_parameters<span class="token punctuation">(</span>sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
    scale <span class="token operator">=</span> IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> sw_new
    x <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x <span class="token operator">/</span> scale <span class="token operator">-</span> pad_w<span class="token punctuation">)</span>
    y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">/</span> scale <span class="token operator">-</span> pad_h<span class="token punctuation">)</span>
    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">/</span> scale<span class="token punctuation">)</span>
    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">/</span> scale<span class="token punctuation">)</span>
    <span class="token keyword">if</span> x <span class="token operator">+</span> w <span class="token operator">&gt;</span> sw <span class="token keyword">or</span> y <span class="token operator">+</span> h <span class="token operator">&gt;</span> sh <span class="token keyword">or</span> x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> w <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> h <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">return</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h

<span class="token keyword">def</span> <span class="token function">calc_iou</span><span class="token punctuation">(</span>rect1<span class="token punctuation">,</span> rect2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""è®¡ç®—ä¸¤ä¸ªåŒºåŸŸé‡å éƒ¨åˆ† / åˆå¹¶éƒ¨åˆ†çš„æ¯”ç‡ (intersection over union)"""</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> w1<span class="token punctuation">,</span> h1 <span class="token operator">=</span> rect1
    x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> h2 <span class="token operator">=</span> rect2
    xi <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>
    yi <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>y1<span class="token punctuation">,</span> y2<span class="token punctuation">)</span>
    wi <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>x1<span class="token operator">+</span>w1<span class="token punctuation">,</span> x2<span class="token operator">+</span>w2<span class="token punctuation">)</span> <span class="token operator">-</span> xi
    hi <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>y1<span class="token operator">+</span>h1<span class="token punctuation">,</span> y2<span class="token operator">+</span>h2<span class="token punctuation">)</span> <span class="token operator">-</span> yi
    <span class="token keyword">if</span> wi <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> hi <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment"># æœ‰é‡å éƒ¨åˆ†</span>
        area_overlap <span class="token operator">=</span> wi<span class="token operator">*</span>hi
        area_all <span class="token operator">=</span> w1<span class="token operator">*</span>h1 <span class="token operator">+</span> w2<span class="token operator">*</span>h2 <span class="token operator">-</span> area_overlap
        iou <span class="token operator">=</span> area_overlap <span class="token operator">/</span> area_all
    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># æ²¡æœ‰é‡å éƒ¨åˆ†</span>
        iou <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> iou

<span class="token keyword">def</span> <span class="token function">calc_box_offset</span><span class="token punctuation">(</span>candidate_box<span class="token punctuation">,</span> true_box<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""è®¡ç®—å€™é€‰åŒºåŸŸä¸å®é™…åŒºåŸŸçš„åç§»å€¼ï¼Œè¦æ±‚å®é™…åŒºåŸŸçš„ä¸­å¿ƒç‚¹å¿…é¡»åœ¨å€™é€‰åŒºåŸŸä¸­"""</span>
    <span class="token comment"># è®¡ç®—å®é™…åŒºåŸŸçš„ä¸­å¿ƒç‚¹åœ¨å€™é€‰åŒºåŸŸä¸­çš„ä½ç½®ï¼ŒèŒƒå›´ä¼šåœ¨ 0 ~ 1 ä¹‹é—´</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> w1<span class="token punctuation">,</span> h1 <span class="token operator">=</span> candidate_box
    x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> h2 <span class="token operator">=</span> true_box
    x_offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x2 <span class="token operator">+</span> w2 <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">/</span> w1
    y_offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y2 <span class="token operator">+</span> h2 <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> y1<span class="token punctuation">)</span> <span class="token operator">/</span> h1
    <span class="token comment"># è®¡ç®—å®é™…åŒºåŸŸé•¿å®½ç›¸å¯¹äºå€™é€‰åŒºåŸŸé•¿å®½çš„æ¯”ä¾‹ï¼Œä½¿ç”¨ log å‡å°‘è¿‡å¤§çš„å€¼</span>
    w_offset <span class="token operator">=</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>w2 <span class="token operator">/</span> w1<span class="token punctuation">)</span>
    h_offset <span class="token operator">=</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>h2 <span class="token operator">/</span> h1<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x_offset<span class="token punctuation">,</span> y_offset<span class="token punctuation">,</span> w_offset<span class="token punctuation">,</span> h_offset<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">adjust_box_by_offset</span><span class="token punctuation">(</span>candidate_box<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ ¹æ®åç§»å€¼è°ƒæ•´å€™é€‰åŒºåŸŸ"""</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> w1<span class="token punctuation">,</span> h1 <span class="token operator">=</span> candidate_box
    x_offset<span class="token punctuation">,</span> y_offset<span class="token punctuation">,</span> w_offset<span class="token punctuation">,</span> h_offset <span class="token operator">=</span> offset
    w2 <span class="token operator">=</span> math<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>w_offset<span class="token punctuation">)</span> <span class="token operator">*</span> w1
    h2 <span class="token operator">=</span> math<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>h_offset<span class="token punctuation">)</span> <span class="token operator">*</span> h1
    x2 <span class="token operator">=</span> x1 <span class="token operator">+</span> w1 <span class="token operator">*</span> x_offset <span class="token operator">-</span> w2 <span class="token operator">//</span> <span class="token number">2</span>
    y2 <span class="token operator">=</span> y1 <span class="token operator">+</span> h1 <span class="token operator">*</span> y_offset <span class="token operator">-</span> h2 <span class="token operator">//</span> <span class="token number">2</span>
    x2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  x2<span class="token punctuation">)</span>
    y2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  y2<span class="token punctuation">)</span>
    w2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>x2<span class="token punctuation">,</span> w2<span class="token punctuation">)</span>
    h2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>y2<span class="token punctuation">,</span> h2<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> h2<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">prepare_save_batch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> image_tensors<span class="token punctuation">,</span> result_tensors<span class="token punctuation">,</span> result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å‡†å¤‡è®­ç»ƒ - ä¿å­˜å•ä¸ªæ‰¹æ¬¡çš„æ•°æ®"""</span>
    <span class="token comment"># æŒ‰ç´¢å¼•å€¼åˆ—è¡¨ç”Ÿæˆè¾“å…¥å’Œè¾“å‡º tensor å¯¹è±¡çš„å‡½æ•°</span>
    <span class="token keyword">def</span> <span class="token function">split_dataset</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token punctuation">:</span>
        indices_list <span class="token operator">=</span> indices<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        image_tensors_splited <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>image_tensors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> indices_list<span class="token punctuation">]</span><span class="token punctuation">)</span>
        result_tensors_splited <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>result_tensors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> indices_list<span class="token punctuation">]</span><span class="token punctuation">)</span>
        result_isobject_masks_splited <span class="token operator">=</span> <span class="token punctuation">[</span>result_isobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> indices_list<span class="token punctuation">]</span>
        result_nonobject_masks_splited <span class="token operator">=</span> <span class="token punctuation">[</span>result_nonobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> indices_list<span class="token punctuation">]</span>
        <span class="token keyword">return</span> image_tensors_splited<span class="token punctuation">,</span> <span class="token punctuation">(</span>
            result_tensors_splited<span class="token punctuation">,</span> result_isobject_masks_splited<span class="token punctuation">,</span> result_nonobject_masks_splited<span class="token punctuation">)</span>

    <span class="token comment"># åˆ‡åˆ†è®­ç»ƒé›† (80%)ï¼ŒéªŒè¯é›† (10%) å’Œæµ‹è¯•é›† (10%)</span>
    random_indices <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>image_tensors<span class="token punctuation">)</span><span class="token punctuation">)</span>
    training_indices <span class="token operator">=</span> random_indices<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>random_indices<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    validating_indices <span class="token operator">=</span> random_indices<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>random_indices<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>random_indices<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    testing_indices <span class="token operator">=</span> random_indices<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>random_indices<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    training_set <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>training_indices<span class="token punctuation">)</span>
    validating_set <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>validating_indices<span class="token punctuation">)</span>
    testing_set <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>testing_indices<span class="token punctuation">)</span>

    <span class="token comment"># ä¿å­˜åˆ°ç¡¬ç›˜</span>
    save_tensor<span class="token punctuation">(</span>training_set<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"data/training_set.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span><span class="token punctuation">)</span>
    save_tensor<span class="token punctuation">(</span>validating_set<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"data/validating_set.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span><span class="token punctuation">)</span>
    save_tensor<span class="token punctuation">(</span>testing_set<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"data/testing_set.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"batch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string"> saved"</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å‡†å¤‡è®­ç»ƒ"""</span>
    <span class="token comment"># æ•°æ®é›†è½¬æ¢åˆ° tensor ä»¥åä¼šä¿å­˜åœ¨ data æ–‡ä»¶å¤¹ä¸‹</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span>

    <span class="token comment"># åŠ è½½å›¾ç‰‡å’Œå›¾ç‰‡å¯¹åº”çš„åŒºåŸŸä¸åˆ†ç±»åˆ—è¡¨</span>
    <span class="token comment"># { (è·¯å¾„, æ˜¯å¦å·¦å³ç¿»è½¬): [ åŒºåŸŸä¸åˆ†ç±», åŒºåŸŸä¸åˆ†ç±», .. ] }</span>
    <span class="token comment"># åŒä¸€å¼ å›¾ç‰‡å·¦å³ç¿»è½¬å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°æ®ï¼Œè®©æ•°æ®é‡ç¿»å€</span>
    box_map <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>DATASET_1_IMAGE_DIR<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ä»ç¬¬ä¸€ä¸ªæ•°æ®é›†åŠ è½½</span>
        xml_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATASET_1_ANNOTATION_DIR<span class="token punctuation">,</span> filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".xml"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>ElementTree<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token operator">=</span>xml_path<span class="token punctuation">)</span>
        objects <span class="token operator">=</span> tree<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATASET_1_IMAGE_DIR<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> objects<span class="token punctuation">:</span>
            class_name <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
            x1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"bndbox/xmin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            x2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"bndbox/xmax"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"bndbox/ymin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            y2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"bndbox/ymax"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            <span class="token keyword">if</span> class_name <span class="token operator">==</span> <span class="token string">"mask_weared_incorrect"</span><span class="token punctuation">:</span>
                <span class="token comment"># ä½©æˆ´å£ç½©ä¸æ­£ç¡®çš„æ ·æœ¬æ•°é‡å¤ªå°‘ (åªæœ‰ 123)ï¼Œæ¨¡å‹æ— æ³•å­¦ä¹ ï¼Œè¿™é‡Œå…¨åˆå¹¶åˆ°æˆ´å£ç½©çš„æ ·æœ¬</span>
                class_name <span class="token operator">=</span> <span class="token string">"with_mask"</span>
            box_map<span class="token punctuation">[</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> y2<span class="token operator">-</span>y1<span class="token punctuation">,</span> CLASSES_MAPPING<span class="token punctuation">[</span>class_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            box_map<span class="token punctuation">[</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> y2<span class="token operator">-</span>y1<span class="token punctuation">,</span> CLASSES_MAPPING<span class="token punctuation">[</span>class_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df <span class="token operator">=</span> pandas<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>DATASET_2_BOX_CSV_PATH<span class="token punctuation">)</span>
    <span class="token keyword">for</span> row <span class="token keyword">in</span> df<span class="token punctuation">.</span>values<span class="token punctuation">:</span>
        <span class="token comment"># ä»ç¬¬äºŒä¸ªæ•°æ®é›†åŠ è½½ï¼Œè¿™ä¸ªæ•°æ®é›†åªåŒ…å«æ²¡æœ‰å¸¦å£ç½©çš„å›¾ç‰‡</span>
        filename<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span>
        path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATASET_2_IMAGE_DIR<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        box_map<span class="token punctuation">[</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> y2<span class="token operator">-</span>y1<span class="token punctuation">,</span> CLASSES_MAPPING<span class="token punctuation">[</span><span class="token string">"without_mask"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        box_map<span class="token punctuation">[</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> y2<span class="token operator">-</span>y1<span class="token punctuation">,</span> CLASSES_MAPPING<span class="token punctuation">[</span><span class="token string">"without_mask"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># æ‰“ä¹±æ•°æ®é›† (å› ä¸ºç¬¬äºŒä¸ªæ•°æ®é›†åªæœ‰ä¸æˆ´å£ç½©çš„å›¾ç‰‡)</span>
    box_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>box_map<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>box_list<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"found </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>box_list<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> images"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># ä¿å­˜å›¾ç‰‡å’Œå›¾ç‰‡å¯¹åº”çš„åˆ†ç±»ä¸åŒºåŸŸåˆ—è¡¨</span>
    batch_size <span class="token operator">=</span> <span class="token number">20</span>
    batch <span class="token operator">=</span> <span class="token number">0</span>
    image_tensors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># å›¾ç‰‡åˆ—è¡¨</span>
    result_tensors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># å›¾ç‰‡å¯¹åº”çš„è¾“å‡ºç»“æœåˆ—è¡¨ï¼ŒåŒ…å« [ æ˜¯å¦å¯¹è±¡ä¸­å¿ƒ, åŒºåŸŸåç§», å„ä¸ªåˆ†ç±»çš„å¯èƒ½æ€§ ]</span>
    result_isobject_masks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># å„ä¸ªå›¾ç‰‡çš„åŒ…å«å¯¹è±¡çš„åŒºåŸŸåœ¨ Anchors ä¸­çš„ç´¢å¼•</span>
    result_nonobject_masks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># å„ä¸ªå›¾ç‰‡ä¸åŒ…å«å¯¹è±¡çš„åŒºåŸŸåœ¨ Anchors ä¸­çš„ç´¢å¼• (é‡å ç‡ä½äºé˜ˆå€¼çš„åŒºåŸŸ)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> flip<span class="token punctuation">)</span><span class="token punctuation">,</span> original_boxes_labels <span class="token keyword">in</span> box_list<span class="token punctuation">:</span>
        <span class="token keyword">with</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span> <span class="token keyword">as</span> img_original<span class="token punctuation">:</span> <span class="token comment"># åŠ è½½åŸå§‹å›¾ç‰‡</span>
            sw<span class="token punctuation">,</span> sh <span class="token operator">=</span> img_original<span class="token punctuation">.</span>size <span class="token comment"># åŸå§‹å›¾ç‰‡å¤§å°</span>
            <span class="token keyword">if</span> flip<span class="token punctuation">:</span>
                img <span class="token operator">=</span> resize_image<span class="token punctuation">(</span>img_original<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>Image<span class="token punctuation">.</span>FLIP_LEFT_RIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># ç¿»è½¬ç„¶åç¼©æ”¾å›¾ç‰‡</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                img <span class="token operator">=</span> resize_image<span class="token punctuation">(</span>img_original<span class="token punctuation">)</span> <span class="token comment"># ç¼©æ”¾å›¾ç‰‡</span>
            image_tensors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>image_to_tensor<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># æ·»åŠ å›¾ç‰‡åˆ°åˆ—è¡¨</span>
        <span class="token comment"># ç”Ÿæˆè¾“å‡ºç»“æœçš„ tensor</span>
        result_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">.</span>Anchors<span class="token punctuation">)</span><span class="token punctuation">,</span> MyModel<span class="token punctuation">.</span>AnchorOutputs<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
        result_tensor<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># é»˜è®¤åˆ†ç±»ä¸º other</span>
        result_tensors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result_tensor<span class="token punctuation">)</span>
        <span class="token comment"># åŒ…å«å¯¹è±¡çš„åŒºåŸŸåœ¨ Anchors ä¸­çš„ç´¢å¼•</span>
        result_isobject_mask <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        result_isobject_masks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result_isobject_mask<span class="token punctuation">)</span>
        <span class="token comment"># ä¸åŒ…å«å¯¹è±¡çš„åŒºåŸŸåœ¨ Anchors ä¸­çš„ç´¢å¼•</span>
        result_nonobject_mask <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        result_nonobject_masks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result_nonobject_mask<span class="token punctuation">)</span>
        <span class="token comment"># æ ¹æ®çœŸå®åŒºåŸŸå®šä½æ‰€å±çš„é”šç‚¹ï¼Œç„¶åè®¾ç½®è¾“å‡ºç»“æœ</span>
        negative_mapping <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">.</span>Anchors<span class="token punctuation">)</span>
        <span class="token keyword">for</span> box_label <span class="token keyword">in</span> original_boxes_labels<span class="token punctuation">:</span>
            x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> label <span class="token operator">=</span> box_label
            <span class="token keyword">if</span> flip<span class="token punctuation">:</span> <span class="token comment"># ç¿»è½¬åæ ‡</span>
                x <span class="token operator">=</span> sw <span class="token operator">-</span> x <span class="token operator">-</span> w
            x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> map_box_to_resized_image<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span> <span class="token comment"># ç¼©æ”¾å®é™…åŒºåŸŸ</span>
            <span class="token keyword">if</span> w <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token keyword">or</span> h <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span> <span class="token comment"># ç¼©æ”¾ååŒºåŸŸè¿‡å°</span>
            <span class="token comment"># æ£€æŸ¥è®¡ç®—æ˜¯å¦æœ‰é—®é¢˜</span>
            <span class="token comment"># child_img = img.copy().crop((x, y, x+w, y+h))</span>
            <span class="token comment"># child_img.save(f"{os.path.basename(image_path)}_{x}_{y}_{w}_{h}_{label}.png")</span>
            <span class="token comment"># å®šä½æ‰€å±çš„é”šç‚¹</span>
            <span class="token comment"># è¦æ±‚:</span>
            <span class="token comment"># - ä¸­å¿ƒç‚¹è½åœ¨é”šç‚¹å¯¹åº”çš„åŒºåŸŸä¸­</span>
            <span class="token comment"># - é‡å ç‡è¶…è¿‡ä¸€å®šå€¼</span>
            x_center <span class="token operator">=</span> x <span class="token operator">+</span> w <span class="token operator">//</span> <span class="token number">2</span>
            y_center <span class="token operator">=</span> y <span class="token operator">+</span> h <span class="token operator">//</span> <span class="token number">2</span>
            matched_anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> index<span class="token punctuation">,</span> anchor <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">.</span>Anchors<span class="token punctuation">)</span><span class="token punctuation">:</span>
                ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> aw<span class="token punctuation">,</span> ah <span class="token operator">=</span> anchor
                is_center <span class="token operator">=</span> <span class="token punctuation">(</span>x_center <span class="token operator">&gt;=</span> ax <span class="token keyword">and</span> x_center <span class="token operator">&lt;</span> ax <span class="token operator">+</span> aw <span class="token keyword">and</span>
                    y_center <span class="token operator">&gt;=</span> ay <span class="token keyword">and</span> y_center <span class="token operator">&lt;</span> ay <span class="token operator">+</span> ah<span class="token punctuation">)</span>
                iou <span class="token operator">=</span> calc_iou<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> is_center <span class="token keyword">and</span> iou <span class="token operator">&gt;</span> IOU_POSITIVE_THRESHOLD<span class="token punctuation">:</span>
                    matched_anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># åŒºåŸŸåŒ…å«å¯¹è±¡ä¸­å¿ƒå¹¶ä¸”é‡å ç‡è¶…è¿‡ä¸€å®šå€¼</span>
                    negative_mapping<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">elif</span> iou <span class="token operator">&gt;</span> IOU_NEGATIVE_THRESHOLD<span class="token punctuation">:</span>
                    negative_mapping<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># åŒºåŸŸä¸æŸä¸ªå¯¹è±¡é‡å ç‡è¶…è¿‡ä¸€å®šå€¼ï¼Œä¸åº”è¯¥å½“ä½œè´Ÿæ ·æœ¬</span>
            <span class="token keyword">for</span> matched_index<span class="token punctuation">,</span> matched_box <span class="token keyword">in</span> matched_anchors<span class="token punctuation">:</span>
                <span class="token comment"># è®¡ç®—åŒºåŸŸåç§»</span>
                offset <span class="token operator">=</span> calc_box_offset<span class="token punctuation">(</span>matched_box<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment"># ä¿®æ”¹è¾“å‡ºç»“æœçš„ tensor</span>
                result_tensor<span class="token punctuation">[</span>matched_index<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">(</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment"># æ˜¯å¦å¯¹è±¡ä¸­å¿ƒ</span>
                    <span class="token operator">*</span>offset<span class="token punctuation">,</span> <span class="token comment"># åŒºåŸŸåç§»</span>
                    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>c <span class="token operator">==</span> label<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>CLASSES<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># å¯¹åº”åˆ†ç±»</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
                <span class="token comment"># æ·»åŠ ç´¢å¼•å€¼</span>
                <span class="token comment"># æ³¨æ„å¦‚æœä¸¤ä¸ªå¯¹è±¡åŒæ—¶å®šä½åˆ°ç›¸åŒçš„é”šç‚¹ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«è¯†åˆ«ï¼Œè¿™é‡Œåé¢çš„å¯¹è±¡ä¼šè¦†ç›–å‰é¢çš„å¯¹è±¡</span>
                <span class="token keyword">if</span> matched_index <span class="token keyword">not</span> <span class="token keyword">in</span> result_isobject_mask<span class="token punctuation">:</span>
                    result_isobject_mask<span class="token punctuation">.</span>append<span class="token punctuation">(</span>matched_index<span class="token punctuation">)</span>
        <span class="token comment"># æ²¡æœ‰æ‰¾åˆ°å¯è¯†åˆ«çš„å¯¹è±¡æ—¶è·³è¿‡å›¾ç‰‡</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> result_isobject_mask<span class="token punctuation">:</span>
            image_tensors<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_tensors<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_isobject_masks<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_nonobject_masks<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token comment"># æ·»åŠ ä¸åŒ…å«å¯¹è±¡çš„åŒºåŸŸåœ¨ Anchors ä¸­çš„ç´¢å¼•</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>negative_mapping<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> value<span class="token punctuation">:</span>
                result_nonobject_mask<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index<span class="token punctuation">)</span>
        <span class="token comment"># æ’åºç´¢å¼•åˆ—è¡¨</span>
        result_isobject_mask<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># ä¿å­˜æ‰¹æ¬¡</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_tensors<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> batch_size<span class="token punctuation">:</span>
            prepare_save_batch<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> image_tensors<span class="token punctuation">,</span> result_tensors<span class="token punctuation">,</span>
                result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks<span class="token punctuation">)</span>
            image_tensors<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_tensors<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_isobject_masks<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_nonobject_masks<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            batch <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token comment"># ä¿å­˜å‰©ä½™çš„æ‰¹æ¬¡</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_tensors<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        prepare_save_batch<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> image_tensors<span class="token punctuation">,</span> result_tensors<span class="token punctuation">,</span>
            result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¼€å§‹è®­ç»ƒ"""</span>
    <span class="token comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span>
    model <span class="token operator">=</span> MyModel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># åˆ›å»ºå¤šä»»åŠ¡æŸå¤±è®¡ç®—å™¨</span>
    loss_function <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>loss_function

    <span class="token comment"># åˆ›å»ºå‚æ•°è°ƒæ•´å™¨</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># è®°å½•è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„æ­£ç¡®ç‡å˜åŒ–</span>
    training_obj_accuracy_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    training_cls_accuracy_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    validating_obj_accuracy_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    validating_cls_accuracy_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># è®°å½•æœ€é«˜çš„éªŒè¯é›†æ­£ç¡®ç‡</span>
    validating_obj_accuracy_highest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    validating_cls_accuracy_highest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    validating_accuracy_highest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    validating_accuracy_highest_epoch <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment"># è¯»å–æ‰¹æ¬¡çš„å·¥å…·å‡½æ•°</span>
    <span class="token keyword">def</span> <span class="token function">read_batches</span><span class="token punctuation">(</span>base_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> batch <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>base_path<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            x<span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> mask1<span class="token punctuation">,</span> mask2<span class="token punctuation">)</span> <span class="token operator">=</span> load_tensor<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
            <span class="token keyword">yield</span> x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> mask1<span class="token punctuation">,</span> mask2<span class="token punctuation">)</span>

    <span class="token comment"># è®¡ç®—æ­£ç¡®ç‡çš„å·¥å…·å‡½æ•°</span>
    calc_accuracy <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>calc_accuracy

    <span class="token comment"># å¼€å§‹è®­ç»ƒè¿‡ç¨‹</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"epoch: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># æ ¹æ®è®­ç»ƒé›†è®­ç»ƒå¹¶ä¿®æ”¹å‚æ•°</span>
        <span class="token comment"># åˆ‡æ¢æ¨¡å‹åˆ°è®­ç»ƒæ¨¡å¼ï¼Œå°†ä¼šå¯ç”¨è‡ªåŠ¨å¾®åˆ†ï¼Œæ‰¹æ¬¡æ­£è§„åŒ– (BatchNorm) ä¸ Dropout</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        training_obj_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        training_cls_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> batch_index<span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>read_batches<span class="token punctuation">(</span><span class="token string">"data/training_set"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># åˆ’åˆ†è¾“å…¥å’Œè¾“å‡º</span>
            batch_x<span class="token punctuation">,</span> batch_y <span class="token operator">=</span> batch
            <span class="token comment"># è®¡ç®—é¢„æµ‹å€¼</span>
            predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>
            <span class="token comment"># è®¡ç®—æŸå¤±</span>
            loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>predicted<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span>
            <span class="token comment"># ä»æŸå¤±è‡ªåŠ¨å¾®åˆ†æ±‚å¯¼å‡½æ•°å€¼</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># ä½¿ç”¨å‚æ•°è°ƒæ•´å™¨è°ƒæ•´å‚æ•°</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># æ¸…ç©ºå¯¼å‡½æ•°å€¼</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># è®°å½•è¿™ä¸€ä¸ªæ‰¹æ¬¡çš„æ­£ç¡®ç‡ï¼Œtorch.no_grad ä»£è¡¨ä¸´æ—¶ç¦ç”¨è‡ªåŠ¨å¾®åˆ†åŠŸèƒ½</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                training_batch_obj_accuracy<span class="token punctuation">,</span> training_batch_cls_accuracy <span class="token operator">=</span> calc_accuracy<span class="token punctuation">(</span>batch_y<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span>
            <span class="token comment"># è¾“å‡ºæ‰¹æ¬¡æ­£ç¡®ç‡</span>
            training_obj_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>training_batch_obj_accuracy<span class="token punctuation">)</span>
            training_cls_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>training_batch_cls_accuracy<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"epoch: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">, batch: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_index<span class="token punctuation">}</span></span><span class="token string">: "</span></span> <span class="token operator">+</span>
                <span class="token string-interpolation"><span class="token string">f"batch obj accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>training_batch_obj_accuracy<span class="token punctuation">}</span></span><span class="token string">, cls accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>training_batch_cls_accuracy<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        training_obj_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>training_obj_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>training_obj_accuracy_list<span class="token punctuation">)</span>
        training_cls_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>training_cls_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>training_cls_accuracy_list<span class="token punctuation">)</span>
        training_obj_accuracy_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>training_obj_accuracy<span class="token punctuation">)</span>
        training_cls_accuracy_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>training_cls_accuracy<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"training obj accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>training_obj_accuracy<span class="token punctuation">}</span></span><span class="token string">, cls accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>training_cls_accuracy<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># æ£€æŸ¥éªŒè¯é›†</span>
        <span class="token comment"># åˆ‡æ¢æ¨¡å‹åˆ°éªŒè¯æ¨¡å¼ï¼Œå°†ä¼šç¦ç”¨è‡ªåŠ¨å¾®åˆ†ï¼Œæ‰¹æ¬¡æ­£è§„åŒ– (BatchNorm) ä¸ Dropout</span>
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        validating_obj_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        validating_cls_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> batch <span class="token keyword">in</span> read_batches<span class="token punctuation">(</span><span class="token string">"data/validating_set"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            batch_x<span class="token punctuation">,</span> batch_y <span class="token operator">=</span> batch
            predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>
            validating_batch_obj_accuracy<span class="token punctuation">,</span> validating_batch_cls_accuracy <span class="token operator">=</span> calc_accuracy<span class="token punctuation">(</span>batch_y<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span>
            validating_obj_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>validating_batch_obj_accuracy<span class="token punctuation">)</span>
            validating_cls_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>validating_batch_cls_accuracy<span class="token punctuation">)</span>
            <span class="token comment"># é‡Šæ”¾ predicted å ç”¨çš„æ˜¾å­˜é¿å…æ˜¾å­˜ä¸è¶³çš„é”™è¯¯</span>
            predicted <span class="token operator">=</span> <span class="token boolean">None</span>
        validating_obj_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>validating_obj_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>validating_obj_accuracy_list<span class="token punctuation">)</span>
        validating_cls_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>validating_cls_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>validating_cls_accuracy_list<span class="token punctuation">)</span>
        validating_obj_accuracy_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>validating_obj_accuracy<span class="token punctuation">)</span>
        validating_cls_accuracy_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>validating_cls_accuracy<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"validating obj accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_obj_accuracy<span class="token punctuation">}</span></span><span class="token string">, cls accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_cls_accuracy<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># è®°å½•æœ€é«˜çš„éªŒè¯é›†æ­£ç¡®ç‡ä¸å½“æ—¶çš„æ¨¡å‹çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨ 20 æ¬¡è®­ç»ƒåä»ç„¶æ²¡æœ‰åˆ·æ–°è®°å½•</span>
        validating_accuracy <span class="token operator">=</span> validating_obj_accuracy <span class="token operator">*</span> validating_cls_accuracy
        <span class="token keyword">if</span> validating_accuracy <span class="token operator">&gt;</span> validating_accuracy_highest<span class="token punctuation">:</span>
            validating_obj_accuracy_highest <span class="token operator">=</span> validating_obj_accuracy
            validating_cls_accuracy_highest <span class="token operator">=</span> validating_cls_accuracy
            validating_accuracy_highest <span class="token operator">=</span> validating_accuracy
            validating_accuracy_highest_epoch <span class="token operator">=</span> epoch
            save_tensor<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"model.pt"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"highest validating accuracy updated"</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> epoch <span class="token operator">-</span> validating_accuracy_highest_epoch <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
            <span class="token comment"># åœ¨ 20 æ¬¡è®­ç»ƒåä»ç„¶æ²¡æœ‰åˆ·æ–°è®°å½•ï¼Œç»“æŸè®­ç»ƒ</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"stop training because highest validating accuracy not updated in 20 epoches"</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>

    <span class="token comment"># ä½¿ç”¨è¾¾åˆ°æœ€é«˜æ­£ç¡®ç‡æ—¶çš„æ¨¡å‹çŠ¶æ€</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"highest obj validating accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_obj_accuracy_highest<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"from epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_accuracy_highest_epoch<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"highest cls validating accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_cls_accuracy_highest<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"from epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_accuracy_highest_epoch<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>load_tensor<span class="token punctuation">(</span><span class="token string">"model.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># æ£€æŸ¥æµ‹è¯•é›†</span>
    testing_obj_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    testing_cls_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> batch <span class="token keyword">in</span> read_batches<span class="token punctuation">(</span><span class="token string">"data/testing_set"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_x<span class="token punctuation">,</span> batch_y <span class="token operator">=</span> batch
        predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>
        testing_batch_obj_accuracy<span class="token punctuation">,</span> testing_batch_cls_accuracy <span class="token operator">=</span> calc_accuracy<span class="token punctuation">(</span>batch_y<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span>
        testing_obj_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>testing_batch_obj_accuracy<span class="token punctuation">)</span>
        testing_cls_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>testing_batch_cls_accuracy<span class="token punctuation">)</span>
    testing_obj_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>testing_obj_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>testing_obj_accuracy_list<span class="token punctuation">)</span>
    testing_cls_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>testing_cls_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>testing_cls_accuracy_list<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"testing obj accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>testing_obj_accuracy<span class="token punctuation">}</span></span><span class="token string">, cls accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>testing_cls_accuracy<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># æ˜¾ç¤ºè®­ç»ƒé›†å’ŒéªŒè¯é›†çš„æ­£ç¡®ç‡å˜åŒ–</span>
    pyplot<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>training_obj_accuracy_history<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"training_obj_accuracy"</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>training_cls_accuracy_history<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"training_cls_accuracy"</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>validating_obj_accuracy_history<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"validating_obj_accuracy"</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>validating_cls_accuracy_history<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"validating_cls_accuracy"</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">eval_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¯†åˆ«å›¾ç‰‡"""</span>
    <span class="token comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹ï¼ŒåŠ è½½è®­ç»ƒå¥½çš„çŠ¶æ€ï¼Œç„¶ååˆ‡æ¢åˆ°éªŒè¯æ¨¡å¼</span>
    model <span class="token operator">=</span> MyModel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>load_tensor<span class="token punctuation">(</span><span class="token string">"model.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># è¯¢é—®å›¾ç‰‡è·¯å¾„ï¼Œå¹¶æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½æ˜¯äººè„¸çš„åŒºåŸŸ</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            image_path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Image path: "</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> image_path<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment"># æ„å»ºè¾“å…¥</span>
            <span class="token keyword">with</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span> <span class="token keyword">as</span> img_original<span class="token punctuation">:</span> <span class="token comment"># åŠ è½½åŸå§‹å›¾ç‰‡</span>
                sw<span class="token punctuation">,</span> sh <span class="token operator">=</span> img_original<span class="token punctuation">.</span>size <span class="token comment"># åŸå§‹å›¾ç‰‡å¤§å°</span>
                img <span class="token operator">=</span> resize_image<span class="token punctuation">(</span>img_original<span class="token punctuation">)</span> <span class="token comment"># ç¼©æ”¾å›¾ç‰‡</span>
                img_output <span class="token operator">=</span> img_original<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># å¤åˆ¶å›¾ç‰‡ï¼Œç”¨äºåé¢æ·»åŠ æ ‡è®°</span>
                tensor_in <span class="token operator">=</span> image_to_tensor<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token comment"># é¢„æµ‹è¾“å‡º</span>
            predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>tensor_in<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            final_result <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>convert_predicted_result<span class="token punctuation">(</span>predicted<span class="token punctuation">)</span>
            <span class="token comment"># æ ‡è®°åœ¨å›¾ç‰‡ä¸Š</span>
            draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img_output<span class="token punctuation">)</span>
            <span class="token keyword">for</span> label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score <span class="token keyword">in</span> final_result<span class="token punctuation">:</span>
                x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> map_box_to_original_image<span class="token punctuation">(</span>box<span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
                score <span class="token operator">=</span> obj_score <span class="token operator">*</span> cls_score
                color <span class="token operator">=</span> <span class="token string">"#00FF00"</span> <span class="token keyword">if</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"with_mask"</span> <span class="token keyword">else</span> <span class="token string">"#FF0000"</span>
                draw<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token operator">+</span>w<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> outline<span class="token operator">=</span>color<span class="token punctuation">)</span>
                draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">)</span>
                draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score<span class="token punctuation">)</span>
            img_output<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"img_output.png"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"saved to img_output.png"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"error:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">eval_video</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¯†åˆ«è§†é¢‘"""</span>
    <span class="token comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹ï¼ŒåŠ è½½è®­ç»ƒå¥½çš„çŠ¶æ€ï¼Œç„¶ååˆ‡æ¢åˆ°éªŒè¯æ¨¡å¼</span>
    model <span class="token operator">=</span> MyModel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>load_tensor<span class="token punctuation">(</span><span class="token string">"model.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># è¯¢é—®è§†é¢‘è·¯å¾„ï¼Œç»™å¯èƒ½æ˜¯äººè„¸çš„åŒºåŸŸæ·»åŠ æ ‡è®°å¹¶ä¿å­˜æ–°è§†é¢‘</span>
    <span class="token keyword">import</span> cv2
    font <span class="token operator">=</span> ImageFont<span class="token punctuation">.</span>truetype<span class="token punctuation">(</span><span class="token string">"FreeMonoBold.ttf"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            video_path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Video path: "</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> video_path<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment"># è¯»å–è¾“å…¥è§†é¢‘</span>
            video <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span>
            <span class="token comment"># è·å–æ¯ç§’çš„å¸§æ•°</span>
            fps <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FPS<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># è·å–è§†é¢‘é•¿å®½</span>
            size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># åˆ›å»ºè¾“å‡ºè§†é¢‘</span>
            video_output_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span><span class="token punctuation">,</span>
                os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".output.avi"</span><span class="token punctuation">)</span>
            result <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>video_output_path<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>VideoWriter_fourcc<span class="token punctuation">(</span><span class="token operator">*</span><span class="token string">"XVID"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fps<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
            <span class="token comment"># ç”¨äºå‡å°‘è¯¯åˆ¤çš„å†å²ç»“æœ</span>
            history_results <span class="token operator">=</span> deque<span class="token punctuation">(</span>maxlen <span class="token operator">=</span> fps <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token comment"># é€å¸§å¤„ç†</span>
            count <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> video<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> ret<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
                <span class="token comment"># opencv ä½¿ç”¨çš„æ˜¯ BGR, Pillow ä½¿ç”¨çš„æ˜¯ RGB, éœ€è¦è½¬æ¢é€šé“é¡ºåº</span>
                frame_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
                <span class="token comment"># æ„å»ºè¾“å…¥</span>
                img_original <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>frame_rgb<span class="token punctuation">)</span> <span class="token comment"># åŠ è½½åŸå§‹å›¾ç‰‡</span>
                sw<span class="token punctuation">,</span> sh <span class="token operator">=</span> img_original<span class="token punctuation">.</span>size <span class="token comment"># åŸå§‹å›¾ç‰‡å¤§å°</span>
                img <span class="token operator">=</span> resize_image<span class="token punctuation">(</span>img_original<span class="token punctuation">)</span> <span class="token comment"># ç¼©æ”¾å›¾ç‰‡</span>
                img_output <span class="token operator">=</span> img_original<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># å¤åˆ¶å›¾ç‰‡ï¼Œç”¨äºåé¢æ·»åŠ æ ‡è®°</span>
                tensor_in <span class="token operator">=</span> image_to_tensor<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                <span class="token comment"># é¢„æµ‹è¾“å‡º</span>
                predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>tensor_in<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                cls_result <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>convert_predicted_result<span class="token punctuation">(</span>predicted<span class="token punctuation">)</span>
                <span class="token comment"># æ ¹æ®å†å²ç»“æœå‡å°‘è¯¯åˆ¤</span>
                final_result <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>fix_predicted_result_from_history<span class="token punctuation">(</span>cls_result<span class="token punctuation">,</span> history_results<span class="token punctuation">)</span>
                <span class="token comment"># æ ‡è®°åœ¨å›¾ç‰‡ä¸Š</span>
                draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img_output<span class="token punctuation">)</span>
                <span class="token keyword">for</span> label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score <span class="token keyword">in</span> final_result<span class="token punctuation">:</span>
                    x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> map_box_to_original_image<span class="token punctuation">(</span>box<span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
                    score <span class="token operator">=</span> obj_score <span class="token operator">*</span> cls_score
                    color <span class="token operator">=</span> <span class="token string">"#00FF00"</span> <span class="token keyword">if</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"with_mask"</span> <span class="token keyword">else</span> <span class="token string">"#FF0000"</span>
                    draw<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token operator">+</span>w<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> outline<span class="token operator">=</span>color<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
                    draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
                    draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
                <span class="token comment"># å†™å…¥å¸§åˆ°è¾“å‡ºè§†é¢‘</span>
                frame_rgb_annotated <span class="token operator">=</span> numpy<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>img_output<span class="token punctuation">)</span>
                frame_bgr_annotated <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame_rgb_annotated<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2BGR<span class="token punctuation">)</span>
                result<span class="token punctuation">.</span>write<span class="token punctuation">(</span>frame_bgr_annotated<span class="token punctuation">)</span>
                count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">if</span> count <span class="token operator">%</span> fps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"handled </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>count<span class="token operator">//</span>fps<span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span>
            video<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"saved to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>video_output_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">raise</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"error:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä¸»å‡½æ•°"""</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Please run: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> prepare|train|eval"</span></span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># ç»™éšæœºæ•°ç”Ÿæˆå™¨åˆ†é…ä¸€ä¸ªåˆå§‹å€¼ï¼Œä½¿å¾—æ¯æ¬¡è¿è¡Œéƒ½å¯ä»¥ç”Ÿæˆç›¸åŒçš„éšæœºæ•°</span>
    <span class="token comment"># è¿™æ˜¯ä¸ºäº†è®©è¿‡ç¨‹å¯é‡ç°ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä¸è¿™æ ·åš</span>
    random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>random<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># æ ¹æ®å‘½ä»¤è¡Œå‚æ•°é€‰æ‹©æ“ä½œ</span>
    operation <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> operation <span class="token operator">==</span> <span class="token string">"prepare"</span><span class="token punctuation">:</span>
        prepare<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> operation <span class="token operator">==</span> <span class="token string">"train"</span><span class="token punctuation">:</span>
        train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> operation <span class="token operator">==</span> <span class="token string">"eval"</span><span class="token punctuation">:</span>
        eval_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> operation <span class="token operator">==</span> <span class="token string">"eval-video"</span><span class="token punctuation">:</span>
        eval_video<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Unsupported operation: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>operation<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="25__969"></a>2.5 æ£€æµ‹æ•ˆæœ</h3> 
<p><strong>æ£€æµ‹æ•ˆæœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ•ˆæœè¿˜æ˜¯å¾ˆå¥½çš„</strong><br> <img src="https://images2.imgbox.com/06/f9/iOBswaMy_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p><img src="https://images2.imgbox.com/ea/3f/VHXOY1bw_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/9d/0f/kGfhfQVO_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p><strong>å®æ—¶æ£€æµ‹æ•ˆæœ</strong></p> 
<p><img src="https://images2.imgbox.com/17/e0/WFBapK8J_o.gif" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h2><a id="_3__989"></a>ğŸš© 3 å£ç½©ä½©æˆ´æ£€æµ‹ç®—æ³•è¯„ä»·æŒ‡æ ‡</h2> 
<p>ç›®å‰ï¼Œ å£ç½©ä½©æˆ´è¯†åˆ«çš„ç ”ç©¶å·²ç»æˆä¸ºçƒ­ç‚¹ï¼Œ ç®—æ³•ä¹Ÿæ˜¯è¶Šæ¥è¶Šå¤šï¼Œ æ‰€ä»¥è¦åˆ¤æ–­ç®—æ³•çš„å¥½åè¿˜éœ€è¦ä¸€äº›æŒ‡æ ‡ä½œä¸ºå‚è€ƒ [36]ã€‚ å¤§éƒ¨åˆ†çš„è¯„ä»·æŒ‡æ ‡éƒ½æ¥è‡ªå¯¹æ··æ·†çŸ©é˜µï¼ˆconfusion matrixï¼‰ çš„è®¡ç®—ã€‚</p> 
<p>å…¶ä¸­ Pï¼ˆPositiveï¼‰ è¡¨ç¤ºé¢„æµ‹å€¼ä¸ºæ­£ä¾‹ã€‚ Nï¼ˆNegativeï¼‰è¡¨ç¤ºé¢„æµ‹å€¼ä¸ºåä¾‹ã€‚ Tï¼ˆTrueï¼‰ è¡¨ç¤ºçœŸå®å€¼ä¸é¢„æµ‹å€¼ç›¸åŒã€‚ é¢„æµ‹å€¼ä¸çœŸå®å€¼ç›¸åè®°ä¸º Fï¼ˆFalse ã€‚</p> 
<p>TP è¡¨ç¤ºçœŸå®å€¼æ˜¯æ­£æ ·æœ¬æˆ–è€…è¯´é¢„æµ‹å€¼ä¸ºæ­£æ ·æœ¬ï¼Œ çœŸå®å€¼å’Œé¢„æµ‹å€¼ç›¸åŒã€‚ TN åˆ™ä¸ºçœŸå®å€¼ä¸ºè´Ÿæ ·æœ¬æˆ–è€…è¯´é¢„æµ‹å€¼ä¸ºè´Ÿæ ·æœ¬ï¼Œ å¹¶ä¸”çœŸå®å€¼å’Œé¢„æµ‹å€¼ç›¸åŒã€‚ FP åˆ™ä¸ºçœŸå®å€¼ä¸ºè´Ÿæ ·æœ¬æˆ–è€…è¯´é¢„æµ‹å€¼ä¸ºæ­£æ ·æœ¬ï¼Œ çœŸå®å€¼å’Œé¢„æµ‹å€¼ä¸ä¸€æ ·ã€‚ FN åˆ™ä¸ºçœŸå®å€¼ä¸ºæ­£æ ·æœ¬æˆ–è€…è¯´é¢„æµ‹å€¼ä¸ºè´Ÿæ ·æœ¬ï¼Œ å¹¶ä¸”çœŸå®å€¼å’Œé¢„æµ‹å€¼ä¸ä¸€æ ·ã€‚</p> 
<h3><a id="31_Accuracy_998"></a>3.1 å‡†ç¡®ç‡ï¼ˆAccuracyï¼‰</h3> 
<p>è¡¨ç¤ºçš„æ˜¯æ¨¡å‹åœ¨æ£€æµ‹æ—¶åˆ¤æ–­ä¸ºæ­£æ ·æœ¬ä¸æ‰€æœ‰æ ·æœ¬çš„æ¯”ä¾‹ï¼Œå‡†ç¡®ç‡é€šå¸¸ç”¨æ¥è¯„ä»·æ•´ä¸ªæ¨¡å‹çš„å‡†ç¡®ç¨‹åº¦ï¼Œ ä¸”ä¸ä¼šåŒ…å«å¤ªå¤šä¿¡æ¯ï¼Œ å› æ­¤ä¸å¯èƒ½å¯¹æ¨¡å‹çš„æ€§èƒ½è¿›è¡Œç»¼åˆè¯„ä»·</p> 
<p><img src="https://images2.imgbox.com/a3/40/FMWu0XLi_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="32_PrecisionRecall_1005"></a>3.2 ç²¾ç¡®ç‡(Precision)å’Œå¬å›ç‡(Recall)</h3> 
<p>ç²¾ç¡®ç‡è¡¨ç¤ºçš„æ˜¯é¢„æµ‹ä¸ºæ­£æ ·æœ¬ä¸­çœŸæ­£æ­£æ ·æœ¬æ‰€å çš„æ¯”ä¾‹ï¼Œ å®ƒåæ˜ çš„æ˜¯é¢„æµ‹ç»“æœå‡†ç¡®ä¸å¦ã€‚ ç²¾ç¡®ç‡çš„è®¡ç®—å…¬å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/cc/99/EeHeve7I_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>å¬å›ç‡è¡¨æ˜æ ·æœ¬ä¸­æ­£ä¾‹è¢«é¢„æµ‹æ­£ç¡®çš„å¤šå°‘ï¼Œ å¬å›ç‡ä¸»è¦çœ‹çš„æ˜¯é¢„æµ‹çš„ç»“æœæ˜¯å¦å…¨é¢ã€‚ å¬å›ç‡çš„è®¡ç®—å…¬å¼å¦‚ï¼ˆ2-3ï¼‰ æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/77/d0/EjFyREK5_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="33_Average_precision_AP_1015"></a>3.3 å¹³å‡ç²¾åº¦(Average precision AP)</h3> 
<p>è¡¨ç¤ºæ¯ä¸ªç±»æ£€æµ‹å¥½åçš„ç»“æœã€‚ å¬å›ç‡è¢«å½“ä½œæ¨ªåæ ‡ï¼Œ ç²¾ç¡®ç‡è¢«å½“ä½œçºµåæ ‡ï¼Œ è¡¨ç¤º P-R æ›²çº¿ä¸‹æ–¹çš„é¢ç§¯ï¼Œ AP å€¼è¶Šé«˜è¡¨æ˜æ¨¡å‹çš„å¹³å‡å‡†ç¡®ç‡è¶Šé«˜ã€‚ AP çš„è®¡ç®—å…¬å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/42/94/D90Ww3vw_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h2><a id="_4__1026"></a>ğŸš© 4 æœ€å</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b2f5eab0f500f4151789bc6c95586255/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">-bash: vim: command not found(å¿«é€Ÿè§£å†³)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/66280b263a50cab9ac3868d6bea80b44/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">DIRECT_IO é…ç½®å‚æ•°ï¼ˆUNIXï¼‰</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>