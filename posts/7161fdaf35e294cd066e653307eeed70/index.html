<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>毕业设计 : 基于深度学习的口罩佩戴检测【全网最详细】 - opencv 卷积神经网络 机器视觉 深度学习 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="毕业设计 : 基于深度学习的口罩佩戴检测【全网最详细】 - opencv 卷积神经网络 机器视觉 深度学习" />
<meta property="og:description" content="文章目录 🚩 0 简介🚩1 课题背景🚩 2 口罩佩戴算法实现2.1 YOLO 模型概览2.2 YOLOv32.3 YOLO 口罩佩戴检测实现数据集 2.4 实现代码2.5 检测效果 🚩 3 口罩佩戴检测算法评价指标3.1 准确率（Accuracy）3.2 精确率(Precision)和召回率(Recall)3.3 平均精度(Average precision AP) 🚩 4 最后 🚩 0 简介 今天学长向大家介绍一个机器视觉的毕设项目
基于深度学习的口罩佩戴检测【全网最详细】 - opencv 卷积神经网络 机器视觉 深度学习
🚩1 课题背景 从2019年末开始，新型冠状病毒肺炎（COVID-19）在我国全面爆发并迅速传播，同时国家卫生健康委员会也积极响应密切关注全国疫情的动态变化并且发布了相关的预防指南，强调个人出行需要做好安全措施，在公共场合必须严格按照要求佩戴口罩。自从新型冠状病毒蔓延以来，各行各业都受到了巨大的冲击，严重影响到人们正常生产和生活。
新型冠状病毒具有很强的传播和生存能力，只要条件合适能存活五天之久，并且可以通过唾液，飞沫等多种方式进行传播，为有效的减少病毒的传播佩戴口罩是一个很好的办法。尽管这一时期国外的形势不容乐观，但是在全国上下齐心努力之下我国的防疫取得了阶段性成功，各行业都在积极复苏，管理也随之变化进入到常态化阶段。在这一阶段复工复产也是大势所趋，口罩出行也成为了一种常态。正确佩戴口罩能够有效减少飞沫传染的风险，特别是在公共场所，这种举措尤为重要。但是，仍然还需要提高公众对主动佩戴口罩的观念，在常态化管理下人们的防范意识越来越薄弱，口罩随意佩戴或者不佩戴的情况屡见不鲜。
因此，在这期间，有意识地戴口罩不仅仅是每个公民的公共道德还是自我修养的表现。这不但需要个人积极配合，而且还需要某些监管以及有效的治理方法。
🚩 2 口罩佩戴算法实现 2.1 YOLO 模型概览 YOLO 的缩写是 You only look once。YOLO 模型可以直接根据图片输出包含对象的区域与区域对应的分类，一步到位，不像 RCNN 系列的模型需要先计算包含对象的区域，再根据区域判断对应的分类，YOLO 模型的速度比 RCNN 系列的模型要快很多。
YOLO 模型的结构如下：
是不是觉得有点熟悉？看上去就像 Faster-RCNN 的区域生成网络 (RPN) 啊。的确，YOLO 模型原理上就是寻找区域的同时判断区域包含的对象分类，YOLO 模型与区域生成网络有以下的不同：
YOLO 模型会输出各个区域是否包含对象中心，而不是包含对象的一部分YOLO 模型会同时输出对象分类YOLO 模型输出的区域偏移会根据对象中心点计算，具体算法在下面说明 YOLO 模型与 Faster-RCNN 的区域生成网络最大的不同是会判断各个区域是否包含对象中心，如下图中狗脸覆盖了四个区域，但只有左下角的区域包含了狗脸的中心，YOLO 模型应该只判断这个区域包含对象。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7161fdaf35e294cd066e653307eeed70/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-01T09:14:48+08:00" />
<meta property="article:modified_time" content="2022-11-01T09:14:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">毕业设计 : 基于深度学习的口罩佩戴检测【全网最详细】 - opencv 卷积神经网络 机器视觉 深度学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_0__2" rel="nofollow">🚩 0 简介</a></li><li><a href="#1__10" rel="nofollow">🚩1 课题背景</a></li><li><a href="#_2__23" rel="nofollow">🚩 2 口罩佩戴算法实现</a></li><li><ul><li><a href="#21_YOLO__25" rel="nofollow">2.1 YOLO 模型概览</a></li><li><a href="#22_YOLOv3_71" rel="nofollow">2.2 YOLOv3</a></li><li><a href="#23_YOLO__79" rel="nofollow">2.3 YOLO 口罩佩戴检测实现</a></li><li><ul><li><a href="#_84" rel="nofollow">数据集</a></li></ul> 
   </li><li><a href="#24__95" rel="nofollow">2.4 实现代码</a></li><li><a href="#25__969" rel="nofollow">2.5 检测效果</a></li></ul> 
  </li><li><a href="#_3__989" rel="nofollow">🚩 3 口罩佩戴检测算法评价指标</a></li><li><ul><li><a href="#31_Accuracy_998" rel="nofollow">3.1 准确率（Accuracy）</a></li><li><a href="#32_PrecisionRecall_1005" rel="nofollow">3.2 精确率(Precision)和召回率(Recall)</a></li><li><a href="#33_Average_precision_AP_1015" rel="nofollow">3.3 平均精度(Average precision AP)</a></li></ul> 
  </li><li><a href="#_4__1026" rel="nofollow">🚩 4 最后</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_0__2"></a>🚩 0 简介</h2> 
<p>今天学长向大家介绍一个机器视觉的毕设项目</p> 
<p><strong>基于深度学习的口罩佩戴检测【全网最详细】 - opencv 卷积神经网络 机器视觉 深度学习</strong></p> 
<h2><a id="1__10"></a>🚩1 课题背景</h2> 
<p>从2019年末开始，新型冠状病毒肺炎（COVID-19）在我国全面爆发并迅速传播，同时国家卫生健康委员会也积极响应密切关注全国疫情的动态变化并且发布了相关的预防指南，强调个人出行需要做好安全措施，在公共场合必须严格按照要求佩戴口罩。自从新型冠状病毒蔓延以来，各行各业都受到了巨大的冲击，严重影响到人们正常生产和生活。</p> 
<p>新型冠状病毒具有很强的传播和生存能力，只要条件合适能存活五天之久，并且可以通过唾液，飞沫等多种方式进行传播，为有效的减少病毒的传播佩戴口罩是一个很好的办法。尽管这一时期国外的形势不容乐观，但是在全国上下齐心努力之下我国的防疫取得了阶段性成功，各行业都在积极复苏，管理也随之变化进入到常态化阶段。在这一阶段复工复产也是大势所趋，口罩出行也成为了一种常态。正确佩戴口罩能够有效减少飞沫传染的风险，特别是在公共场所，这种举措尤为重要。但是，仍然还需要提高公众对主动佩戴口罩的观念，在常态化管理下人们的防范意识越来越薄弱，口罩随意佩戴或者不佩戴的情况屡见不鲜。</p> 
<p>因此，在这期间，有意识地戴口罩不仅仅是每个公民的公共道德还是自我修养的表现。这不但需要个人积极配合，而且还需要某些监管以及有效的治理方法。</p> 
<p><img src="https://images2.imgbox.com/47/9f/VUUqn4HE_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_2__23"></a>🚩 2 口罩佩戴算法实现</h2> 
<h3><a id="21_YOLO__25"></a>2.1 YOLO 模型概览</h3> 
<p>YOLO 的缩写是 You only look once。YOLO 模型可以直接根据图片输出包含对象的区域与区域对应的分类，一步到位，不像 RCNN 系列的模型需要先计算包含对象的区域，再根据区域判断对应的分类，YOLO 模型的速度比 RCNN 系列的模型要快很多。</p> 
<p>YOLO 模型的结构如下：</p> 
<p><img src="https://images2.imgbox.com/de/63/fyqqNb3v_o.png" alt="在这里插入图片描述"><br> 是不是觉得有点熟悉？看上去就像 Faster-RCNN 的区域生成网络 (RPN) 啊。的确，YOLO 模型原理上就是寻找区域的同时判断区域包含的对象分类，YOLO 模型与区域生成网络有以下的不同：</p> 
<ul><li>YOLO 模型会输出各个区域是否包含对象中心，而不是包含对象的一部分</li><li>YOLO 模型会同时输出对象分类</li><li>YOLO 模型输出的区域偏移会根据对象中心点计算，具体算法在下面说明</li></ul> 
<p>YOLO 模型与 Faster-RCNN 的区域生成网络最大的不同是会判断各个区域是否包含对象中心，如下图中狗脸覆盖了四个区域，但只有左下角的区域包含了狗脸的中心，YOLO 模型应该只判断这个区域包含对象。</p> 
<p><img src="https://images2.imgbox.com/a1/28/2qobSXf5_o.png" alt="在这里插入图片描述"></p> 
<p>当然，如果对象中心非常接近区域的边界，那么判断起来将会很困难，YOLO 模型在训练的时候会忽略对象重叠率高于一定水平的区域，具体可以参考后面给出的代码。</p> 
<p>YOLO 模型会针对各个区域输出以下的结果，这里假设有三个分类：</p> 
<ul><li>是否包含对象中心 (是为 1, 否为 0)</li><li>区域偏移 x</li><li>区域偏移 y</li><li>区域偏移 w</li><li>区域偏移 h</li><li>分类 1 的可能性 (0 ~ 1)</li><li>分类 2 的可能性 (0 ~ 1)</li><li>分类 3 的可能性 (0 ~ 1)</li></ul> 
<p><strong>输出结果的维度是 批次大小, 区域数量, 5 + 分类数量。</strong></p> 
<p>区域偏移用于调整输出的区域范围，例如上图中狗脸的中心点大约在区域的右上角，如果把区域左上角看作 (0, 0)，右下角看作 (1, 1)，那么狗脸中心点应该在 (0.95, 0.1) 的位置，而狗脸大小相对于区域长宽大概是 (1.3, 1.5) 倍，生成训练数据的时候会根据这 4 个值计算区域偏移，具体计算代码在下面给出。</p> 
<p><img src="https://images2.imgbox.com/7d/7e/Ix6W0czN_o.png" alt="在这里插入图片描述"></p> 
<p>看到这里你可能会想，YOLO 模型看起来很简单啊，我可以丢掉操蛋的 Faster-RCNN 模型了🤢。</p> 
<p>不，没那么简单，以上介绍的只是 YOLOv1 模型，YOLOv1 模型的精度非常低，后面为了改进识别精度还发展出 YOLOv2, YOLOv3, YOLOv4, YOLOv5 模型😮，学长下面会给出 YOLOv3 模型的实现。Y</p> 
<p><strong>OLOv4 和 YOLOv5 模型主要改进了提取特征用的 CNN 模型 (也称骨干网络 Backbone Network)，原始的 YOLO 模型使用了 C 语言编写的 Darknet 作为骨干网络，而这篇使用 Resnet 作为骨干网络，所以今天学长只介绍到 YOLOv3。</strong></p> 
<h3><a id="22_YOLOv3_71"></a>2.2 YOLOv3</h3> 
<p>YOLOv3 引入了多尺度检测机制 (Multi-Scale Detection)，这个机制可以说是 YOLO 模型的精华，引入这个机制之前 YOLO 模型的精度很不理想，而引入之后 YOLO 模型达到了接近 Faster-RCNN 的精度，并且速度还是比 Faster-RCNN 要快。</p> 
<p>多尺度检测机制简单的来说就是按不同的尺度划分区域，然后再检测这些不同大小的区域是否包含对象，检测的时候大区域的特征会混合到小区域中，使得小区域判断时拥有一定程度的上下文信息。</p> 
<p><img src="https://images2.imgbox.com/6b/d7/maMELDKX_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_YOLO__79"></a>2.3 YOLO 口罩佩戴检测实现</h3> 
<p><strong>接下来学长带大家用 YOLO 模型把没带口罩的家伙抓出来吧。</strong></p> 
<h4><a id="_84"></a>数据集</h4> 
<p><img src="https://images2.imgbox.com/24/c4/bGpZXgcS_o.png" alt="在这里插入图片描述"><br> 学长的这个数据集包含了 8535 张图片 (部分图片没有使用)，其中各个分类的数量如下：</p> 
<ul><li>戴口罩的区域 (with_mask): 3232 个</li><li>不戴口罩的区域 (without_mask): 717 个</li><li>带了口罩但姿势不正确的区域 (mask_weared_incorrect): 123 个</li></ul> 
<p>因为带了口罩但姿势不正确的样本数量很少，所以都归到戴口罩里面去😠。</p> 
<h3><a id="24__95"></a>2.4 实现代码</h3> 
<p><strong>使用这个数据集训练，并且训练成功以后使用模型识别图片或视频的完整代码如下：</strong></p> 
<pre><code class="prism language-python">
<span class="token comment"># 作者：丹成学长，q746876041</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> gzip
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> random
<span class="token keyword">import</span> numpy
<span class="token keyword">import</span> math
<span class="token keyword">import</span> pandas
<span class="token keyword">import</span> json
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageDraw
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageFont
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token keyword">from</span> collections <span class="token keyword">import</span> deque
<span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>cElementTree <span class="token keyword">as</span> ET

<span class="token comment"># 缩放图片的大小</span>
IMAGE_SIZE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">)</span>
<span class="token comment"># 训练使用的数据集路径</span>
DATASET_1_IMAGE_DIR <span class="token operator">=</span> <span class="token string">"./archive/images"</span>
DATASET_1_ANNOTATION_DIR <span class="token operator">=</span> <span class="token string">"./archive/annotations"</span>
DATASET_2_IMAGE_DIR <span class="token operator">=</span> <span class="token string">"./784145_1347673_bundle_archive/train/image_data"</span>
DATASET_2_BOX_CSV_PATH <span class="token operator">=</span> <span class="token string">"./784145_1347673_bundle_archive/train/bbox_train.csv"</span>
<span class="token comment"># 分类列表</span>
<span class="token comment"># YOLO 原则上不需要 other 分类，但实测中添加这个分类有助于提升标签分类的精确度</span>
CLASSES <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"other"</span><span class="token punctuation">,</span> <span class="token string">"with_mask"</span><span class="token punctuation">,</span> <span class="token string">"without_mask"</span> <span class="token punctuation">]</span>
CLASSES_MAPPING <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> c<span class="token punctuation">:</span> index <span class="token keyword">for</span> index<span class="token punctuation">,</span> c <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>CLASSES<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token comment"># 判断是否存在对象使用的区域重叠率的阈值 (另外要求对象中心在区域内)</span>
IOU_POSITIVE_THRESHOLD <span class="token operator">=</span> <span class="token number">0.30</span>
IOU_NEGATIVE_THRESHOLD <span class="token operator">=</span> <span class="token number">0.30</span>

<span class="token comment"># 用于启用 GPU 支持</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">BasicBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ResNet 使用的基础块"""</span>
    expansion <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># 定义这个块的实际出通道是 channels_out 的几倍，这里的实现固定是一倍</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channels_in<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 生成 3x3 的卷积层</span>
        <span class="token comment"># 处理间隔 stride = 1 时，输出的长宽会等于输入的长宽，例如 (32-3+2)//1+1 == 32</span>
        <span class="token comment"># 处理间隔 stride = 2 时，输出的长宽会等于输入的长宽的一半，例如 (32-3+2)//2+1 == 16</span>
        <span class="token comment"># 此外 resnet 的 3x3 卷积层不使用偏移值 bias</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels_in<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>channels_out<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 再定义一个让输出和输入维度相同的 3x3 卷积层</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels_out<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>channels_out<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 让原始输入和输出相加的时候，需要维度一致，如果维度不一致则需要整合</span>
        self<span class="token punctuation">.</span>identity <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> stride <span class="token operator">!=</span> <span class="token number">1</span> <span class="token keyword">or</span> channels_in <span class="token operator">!=</span> channels_out <span class="token operator">*</span> self<span class="token punctuation">.</span>expansion<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>identity <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels_in<span class="token punctuation">,</span> channels_out <span class="token operator">*</span> self<span class="token punctuation">.</span>expansion<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>channels_out <span class="token operator">*</span> self<span class="token punctuation">.</span>expansion<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># x =&gt; conv1 =&gt; relu =&gt; conv2 =&gt; + =&gt; relu</span>
        <span class="token comment"># |                              ^</span>
        <span class="token comment"># |==============================|</span>
        tmp <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        tmp <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        tmp <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
        tmp <span class="token operator">+=</span> self<span class="token punctuation">.</span>identity<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        y <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> y

<span class="token keyword">class</span> <span class="token class-name">MyModel</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""YOLO (基于 ResNet 的变种)"""</span>
    Anchors <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># 锚点列表，包含 锚点数量 * 形状数量 的范围</span>
    AnchorSpans <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token comment"># 尺度列表，值为锚点之间的距离</span>
    AnchorAspects <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 锚点对应区域的长宽比例列表</span>
    AnchorOutputs <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>CLASSES<span class="token punctuation">)</span> <span class="token comment"># 每个锚点范围对应的输出数量，是否对象中心 (1) + 区域偏移 (4) + 分类数量</span>
    AnchorTotalOutputs <span class="token operator">=</span> AnchorOutputs <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>AnchorAspects<span class="token punctuation">)</span> <span class="token comment"># 每个锚点对应的输出数量</span>
    ObjScoreThreshold <span class="token operator">=</span> <span class="token number">0.9</span> <span class="token comment"># 认为是对象中心所需要的最小分数</span>
    IOUMergeThreshold <span class="token operator">=</span> <span class="token number">0.3</span> <span class="token comment"># 判断是否应该合并重叠区域的重叠率阈值</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 抽取图片特征的 ResNet</span>
        <span class="token comment"># 因为锚点距离有三个，这里最后会输出各个锚点距离对应的特征</span>
        self<span class="token punctuation">.</span>previous_channels_out <span class="token operator">=</span> <span class="token number">4</span>
        self<span class="token punctuation">.</span>resnet_models <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>
            nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> channels_out<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_blocks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 根据各个锚点距离对应的特征预测输出的卷积层</span>
        <span class="token comment"># 大的锚点距离抽取的特征会合并到小的锚点距离抽取的特征</span>
        <span class="token comment"># 这里的三个子模型意义分别是:</span>
        <span class="token comment"># - 计算用于合并的特征</span>
        <span class="token comment"># - 放大特征</span>
        <span class="token comment"># - 计算最终的预测输出</span>
        self<span class="token punctuation">.</span>yolo_detectors <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>
            nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span> <span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">(</span>scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"nearest"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> MyModel<span class="token punctuation">.</span>AnchorTotalOutputs<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>resnet_models<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 处理结果范围的函数</span>
        self<span class="token punctuation">.</span>sigmoid <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_make_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> block_type<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""创建 resnet 使用的层"""</span>
        blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 添加第一个块</span>
        blocks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block_type<span class="token punctuation">(</span>self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">,</span> channels_out<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>previous_channels_out <span class="token operator">=</span> channels_out <span class="token operator">*</span> block_type<span class="token punctuation">.</span>expansion
        <span class="token comment"># 添加剩余的块，剩余的块固定处理间隔为 1，不会改变长宽</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_blocks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            blocks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block_type<span class="token punctuation">(</span>self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">,</span> self<span class="token punctuation">.</span>previous_channels_out<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>previous_channels_out <span class="token operator">*=</span> block_type<span class="token punctuation">.</span>expansion
        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>blocks<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">_generate_anchors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""根据锚点和形状生成锚点范围列表"""</span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> IMAGE_SIZE
        anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> span <span class="token keyword">in</span> MyModel<span class="token punctuation">.</span>AnchorSpans<span class="token punctuation">:</span>
            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> span<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> span<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    xcenter<span class="token punctuation">,</span> ycenter <span class="token operator">=</span> x <span class="token operator">+</span> span <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">+</span> span <span class="token operator">/</span> <span class="token number">2</span>
                    <span class="token keyword">for</span> ratio <span class="token keyword">in</span> MyModel<span class="token punctuation">.</span>AnchorAspects<span class="token punctuation">:</span>
                        ww <span class="token operator">=</span> span <span class="token operator">*</span> ratio<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                        hh <span class="token operator">=</span> span <span class="token operator">*</span> ratio<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                        xx <span class="token operator">=</span> xcenter <span class="token operator">-</span> ww <span class="token operator">/</span> <span class="token number">2</span>
                        yy <span class="token operator">=</span> ycenter <span class="token operator">-</span> hh <span class="token operator">/</span> <span class="token number">2</span>
                        xx <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        yy <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>yy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        ww <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>ww<span class="token punctuation">)</span><span class="token punctuation">,</span> w <span class="token operator">-</span> xx<span class="token punctuation">)</span>
                        hh <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>hh<span class="token punctuation">)</span><span class="token punctuation">,</span> h <span class="token operator">-</span> yy<span class="token punctuation">)</span>
                        anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>xx<span class="token punctuation">,</span> yy<span class="token punctuation">,</span> ww<span class="token punctuation">,</span> hh<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> anchors

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 抽取各个锚点距离对应的特征</span>
        <span class="token comment"># 维度分别是:</span>
        <span class="token comment"># torch.Size([16, 256, 16, 12])</span>
        <span class="token comment"># torch.Size([16, 256, 8, 6])</span>
        <span class="token comment"># torch.Size([16, 256, 4, 3])</span>
        features_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        resnet_input <span class="token operator">=</span> x
        <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>resnet_models<span class="token punctuation">:</span>
            resnet_input <span class="token operator">=</span> m<span class="token punctuation">(</span>resnet_input<span class="token punctuation">)</span>
            features_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>resnet_input<span class="token punctuation">)</span>
        <span class="token comment"># 根据特征预测输出</span>
        <span class="token comment"># 维度分别是:</span>
        <span class="token comment"># torch.Size([16, 16, 4, 3])</span>
        <span class="token comment"># torch.Size([16, 16, 8, 6])</span>
        <span class="token comment"># torch.Size([16, 16, 16, 12])</span>
        <span class="token comment"># 16 是 (5 + 分类3) * 形状2</span>
        previous_upsampled_feature <span class="token operator">=</span> <span class="token boolean">None</span>
        outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> feature <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span>features_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> previous_upsampled_feature <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># 合并大的锚点距离抽取的特征到小的锚点距离抽取的特征</span>
                feature <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>feature<span class="token punctuation">,</span> previous_upsampled_feature<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token comment"># 计算用于合并的特征</span>
            hidden <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_detectors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span>
            <span class="token comment"># 放大特征 (用于下一次处理时合并)</span>
            upsampled <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_detectors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
            <span class="token comment"># 计算最终的预测输出</span>
            output <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_detectors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
            previous_upsampled_feature <span class="token operator">=</span> upsampled
            outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token comment"># 连接所有输出</span>
        <span class="token comment"># 注意顺序需要与 Anchors 一致</span>
        outputs_flatten <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> output <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> output<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            output <span class="token operator">=</span> output<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> MyModel<span class="token punctuation">.</span>AnchorOutputs<span class="token punctuation">)</span>
            outputs_flatten<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        outputs_all <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>outputs_flatten<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 是否对象中心应该在 0 ~ 1 之间，使用 sigmoid 处理</span>
        outputs_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>outputs_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 分类应该在 0 ~ 1 之间，使用 sigmoid 处理</span>
        outputs_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>outputs_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> outputs_all

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">loss_function</span><span class="token punctuation">(</span>predicted<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""YOLO 使用的多任务损失计算器"""</span>
        result_tensor<span class="token punctuation">,</span> result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks <span class="token operator">=</span> actual
        objectness_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        offsets_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        labels_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>result_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            mask_positive <span class="token operator">=</span> result_isobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span>
            mask_negative <span class="token operator">=</span> result_nonobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span>
            <span class="token comment"># 计算是否对象中心的损失，分别针对正负样本计算</span>
            <span class="token comment"># 因为大部分区域不包含对象中心，这里减少负样本的损失对调整参数的影响</span>
            objectness_loss_positive <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            objectness_loss_negative <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_negative<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_negative<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
            objectness_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>objectness_loss_positive<span class="token punctuation">)</span>
            objectness_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>objectness_loss_negative<span class="token punctuation">)</span>
            <span class="token comment"># 计算区域偏移的损失，只针对正样本计算</span>
            offsets_loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            offsets_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>offsets_loss<span class="token punctuation">)</span>
            <span class="token comment"># 计算标签分类的损失，分别针对正负样本计算</span>
            labels_loss_positive <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>binary_cross_entropy<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_positive<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            labels_loss_negative <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>binary_cross_entropy<span class="token punctuation">(</span>
                predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_negative<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask_negative<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
            labels_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_loss_positive<span class="token punctuation">)</span>
            labels_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_loss_negative<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> <span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>objectness_losses<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>offsets_losses<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>labels_losses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> loss

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">calc_accuracy</span><span class="token punctuation">(</span>actual<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""YOLO 使用的正确率计算器，这里只计算是否对象中心与标签分类的正确率，区域偏移不计算"""</span>
        result_tensor<span class="token punctuation">,</span> result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks <span class="token operator">=</span> actual
        <span class="token comment"># 计算是否对象中心的正确率，正样本和负样本的正确率分别计算再平均</span>
        a <span class="token operator">=</span> result_tensor<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
        p <span class="token operator">=</span> predicted<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> MyModel<span class="token punctuation">.</span>ObjScoreThreshold
        obj_acc_positive <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.00001</span><span class="token punctuation">)</span>
        obj_acc_negative <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.00001</span><span class="token punctuation">)</span>
        obj_acc <span class="token operator">=</span> <span class="token punctuation">(</span>obj_acc_positive <span class="token operator">+</span> obj_acc_negative<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token comment"># 计算标签分类的正确率</span>
        cls_total <span class="token operator">=</span> <span class="token number">0</span>
        cls_correct <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>result_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            mask <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>result_isobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> result_nonobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            actual_classes <span class="token operator">=</span> result_tensor<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>indices
            predicted_classes <span class="token operator">=</span> predicted<span class="token punctuation">[</span>x<span class="token punctuation">,</span>mask<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>indices
            cls_total <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
            cls_correct <span class="token operator">+=</span> <span class="token punctuation">(</span>actual_classes <span class="token operator">==</span> predicted_classes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cls_acc <span class="token operator">=</span> cls_correct <span class="token operator">/</span> cls_total
        <span class="token keyword">return</span> obj_acc<span class="token punctuation">,</span> cls_acc

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">convert_predicted_result</span><span class="token punctuation">(</span>predicted<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""转换预测结果到 (标签, 区域, 对象中心分数, 标签识别分数) 的列表，重叠区域使用 NMS 算法合并"""</span>
        <span class="token comment"># 记录重叠的结果区域, 结果是 [ [(标签, 区域, RPN 分数, 标签识别分数)], ... ]</span>
        final_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> anchor<span class="token punctuation">,</span> tensor <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">.</span>Anchors<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span><span class="token punctuation">:</span>
            obj_score <span class="token operator">=</span> tensor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> obj_score <span class="token operator">&lt;=</span> MyModel<span class="token punctuation">.</span>ObjScoreThreshold<span class="token punctuation">:</span>
                <span class="token comment"># 要求对象中心分数超过一定值</span>
                <span class="token keyword">continue</span>
            offset <span class="token operator">=</span> tensor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
            offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 中心点 x 的偏移应该在 0 ~ 1 之间</span>
            offset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>offset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 中心点 y 的偏移应该在 0 ~ 1 之间</span>
            box <span class="token operator">=</span> adjust_box_by_offset<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> offset<span class="token punctuation">)</span>
            label_max <span class="token operator">=</span> tensor<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            cls_score <span class="token operator">=</span> label_max<span class="token punctuation">.</span>values<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            label <span class="token operator">=</span> label_max<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> label <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token comment"># 跳过非对象分类</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>final_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                exists_results <span class="token operator">=</span> final_result<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>calc_iou<span class="token punctuation">(</span>box<span class="token punctuation">,</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> MyModel<span class="token punctuation">.</span>IOUMergeThreshold <span class="token keyword">for</span> r <span class="token keyword">in</span> exists_results<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    exists_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                final_result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 合并重叠的结果区域 (使用 对象中心分数 * 标签识别分数 最高的区域为结果区域)</span>
        <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>final_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            exists_results <span class="token operator">=</span> final_result<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
            exists_results<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>r<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            final_result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> exists_results<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> final_result

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">fix_predicted_result_from_history</span><span class="token punctuation">(</span>cls_result<span class="token punctuation">,</span> history_results<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""根据历史结果减少预测结果中的误判，适用于视频识别，history_results 应为指定了 maxlen 的 deque"""</span>
        <span class="token comment"># 要求历史结果中 50% 以上存在类似区域，并且选取历史结果中最多的分类</span>
        history_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls_result<span class="token punctuation">)</span>
        final_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>history_results<span class="token punctuation">)</span> <span class="token operator">&lt;</span> history_results<span class="token punctuation">.</span>maxlen<span class="token punctuation">:</span>
            <span class="token comment"># 历史结果不足，不返回任何识别结果</span>
            <span class="token keyword">return</span> final_result
        <span class="token keyword">for</span> label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> rpn_score<span class="token punctuation">,</span> cls_score <span class="token keyword">in</span> cls_result<span class="token punctuation">:</span>
            <span class="token comment"># 查找历史中的近似区域</span>
            similar_results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> history_result <span class="token keyword">in</span> history_results<span class="token punctuation">:</span>
                history_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>calc_iou<span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> history_result<span class="token punctuation">]</span>
                history_result<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> history_result <span class="token keyword">and</span> history_result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> MyModel<span class="token punctuation">.</span>IOUMergeThreshold<span class="token punctuation">:</span>
                    similar_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>history_result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 判断近似区域数量是否过半</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>similar_results<span class="token punctuation">)</span> <span class="token operator">&lt;</span> history_results<span class="token punctuation">.</span>maxlen <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment"># 选取历史结果中最多的分类</span>
            cls_groups <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> r <span class="token keyword">in</span> similar_results<span class="token punctuation">:</span>
                cls_groups<span class="token punctuation">[</span>r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            most_common <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>cls_groups<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token comment"># 添加最多的分类中的最新的结果</span>
            final_result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>most_common<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> final_result

MyModel<span class="token punctuation">.</span>Anchors <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>_generate_anchors<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">save_tensor</span><span class="token punctuation">(</span>tensor<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""保存 tensor 对象到文件"""</span>
    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>tensor<span class="token punctuation">,</span> gzip<span class="token punctuation">.</span>GzipFile<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">load_tensor</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""从文件读取 tensor 对象"""</span>
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>gzip<span class="token punctuation">.</span>GzipFile<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">calc_resize_parameters</span><span class="token punctuation">(</span>sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""计算缩放图片的参数"""</span>
    sw_new<span class="token punctuation">,</span> sh_new <span class="token operator">=</span> sw<span class="token punctuation">,</span> sh
    dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> IMAGE_SIZE
    pad_w<span class="token punctuation">,</span> pad_h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">if</span> sw <span class="token operator">/</span> sh <span class="token operator">&lt;</span> dw <span class="token operator">/</span> dh<span class="token punctuation">:</span>
        sw_new <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>dw <span class="token operator">/</span> dh <span class="token operator">*</span> sh<span class="token punctuation">)</span>
        pad_w <span class="token operator">=</span> <span class="token punctuation">(</span>sw_new <span class="token operator">-</span> sw<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span> <span class="token comment"># 填充左右</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        sh_new <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>dh <span class="token operator">/</span> dw <span class="token operator">*</span> sw<span class="token punctuation">)</span>
        pad_h <span class="token operator">=</span> <span class="token punctuation">(</span>sh_new <span class="token operator">-</span> sh<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span> <span class="token comment"># 填充上下</span>
    <span class="token keyword">return</span> sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h

<span class="token keyword">def</span> <span class="token function">resize_image</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""缩放图片，比例不一致时填充"""</span>
    sw<span class="token punctuation">,</span> sh <span class="token operator">=</span> img<span class="token punctuation">.</span>size
    sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h <span class="token operator">=</span> calc_resize_parameters<span class="token punctuation">(</span>sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
    img_new <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">)</span><span class="token punctuation">)</span>
    img_new<span class="token punctuation">.</span>paste<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>pad_w<span class="token punctuation">,</span> pad_h<span class="token punctuation">)</span><span class="token punctuation">)</span>
    img_new <span class="token operator">=</span> img_new<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_new

<span class="token keyword">def</span> <span class="token function">image_to_tensor</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""转换图片对象到 tensor 对象"""</span>
    arr <span class="token operator">=</span> numpy<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
    t <span class="token operator">=</span> t<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 转换维度 H,W,C 到 C,W,H</span>
    t <span class="token operator">=</span> t <span class="token operator">/</span> <span class="token number">255.0</span> <span class="token comment"># 正规化数值使得范围在 0 ~ 1</span>
    <span class="token keyword">return</span> t

<span class="token keyword">def</span> <span class="token function">map_box_to_resized_image</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""把原始区域转换到缩放后的图片对应的区域"""</span>
    x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> box
    sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h <span class="token operator">=</span> calc_resize_parameters<span class="token punctuation">(</span>sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
    scale <span class="token operator">=</span> IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> sw_new
    x <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> pad_w<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> pad_h<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    <span class="token keyword">if</span> x <span class="token operator">+</span> w <span class="token operator">&gt;</span> IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> y <span class="token operator">+</span> h <span class="token operator">&gt;</span> IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">or</span> w <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> h <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">return</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h

<span class="token keyword">def</span> <span class="token function">map_box_to_original_image</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""把缩放后图片对应的区域转换到缩放前的原始区域"""</span>
    x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> box
    sw_new<span class="token punctuation">,</span> sh_new<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h <span class="token operator">=</span> calc_resize_parameters<span class="token punctuation">(</span>sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
    scale <span class="token operator">=</span> IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> sw_new
    x <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x <span class="token operator">/</span> scale <span class="token operator">-</span> pad_w<span class="token punctuation">)</span>
    y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">/</span> scale <span class="token operator">-</span> pad_h<span class="token punctuation">)</span>
    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">/</span> scale<span class="token punctuation">)</span>
    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">/</span> scale<span class="token punctuation">)</span>
    <span class="token keyword">if</span> x <span class="token operator">+</span> w <span class="token operator">&gt;</span> sw <span class="token keyword">or</span> y <span class="token operator">+</span> h <span class="token operator">&gt;</span> sh <span class="token keyword">or</span> x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> w <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> h <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">return</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h

<span class="token keyword">def</span> <span class="token function">calc_iou</span><span class="token punctuation">(</span>rect1<span class="token punctuation">,</span> rect2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""计算两个区域重叠部分 / 合并部分的比率 (intersection over union)"""</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> w1<span class="token punctuation">,</span> h1 <span class="token operator">=</span> rect1
    x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> h2 <span class="token operator">=</span> rect2
    xi <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>
    yi <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>y1<span class="token punctuation">,</span> y2<span class="token punctuation">)</span>
    wi <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>x1<span class="token operator">+</span>w1<span class="token punctuation">,</span> x2<span class="token operator">+</span>w2<span class="token punctuation">)</span> <span class="token operator">-</span> xi
    hi <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>y1<span class="token operator">+</span>h1<span class="token punctuation">,</span> y2<span class="token operator">+</span>h2<span class="token punctuation">)</span> <span class="token operator">-</span> yi
    <span class="token keyword">if</span> wi <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> hi <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment"># 有重叠部分</span>
        area_overlap <span class="token operator">=</span> wi<span class="token operator">*</span>hi
        area_all <span class="token operator">=</span> w1<span class="token operator">*</span>h1 <span class="token operator">+</span> w2<span class="token operator">*</span>h2 <span class="token operator">-</span> area_overlap
        iou <span class="token operator">=</span> area_overlap <span class="token operator">/</span> area_all
    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># 没有重叠部分</span>
        iou <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> iou

<span class="token keyword">def</span> <span class="token function">calc_box_offset</span><span class="token punctuation">(</span>candidate_box<span class="token punctuation">,</span> true_box<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""计算候选区域与实际区域的偏移值，要求实际区域的中心点必须在候选区域中"""</span>
    <span class="token comment"># 计算实际区域的中心点在候选区域中的位置，范围会在 0 ~ 1 之间</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> w1<span class="token punctuation">,</span> h1 <span class="token operator">=</span> candidate_box
    x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> h2 <span class="token operator">=</span> true_box
    x_offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x2 <span class="token operator">+</span> w2 <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">/</span> w1
    y_offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y2 <span class="token operator">+</span> h2 <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> y1<span class="token punctuation">)</span> <span class="token operator">/</span> h1
    <span class="token comment"># 计算实际区域长宽相对于候选区域长宽的比例，使用 log 减少过大的值</span>
    w_offset <span class="token operator">=</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>w2 <span class="token operator">/</span> w1<span class="token punctuation">)</span>
    h_offset <span class="token operator">=</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>h2 <span class="token operator">/</span> h1<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x_offset<span class="token punctuation">,</span> y_offset<span class="token punctuation">,</span> w_offset<span class="token punctuation">,</span> h_offset<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">adjust_box_by_offset</span><span class="token punctuation">(</span>candidate_box<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""根据偏移值调整候选区域"""</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> w1<span class="token punctuation">,</span> h1 <span class="token operator">=</span> candidate_box
    x_offset<span class="token punctuation">,</span> y_offset<span class="token punctuation">,</span> w_offset<span class="token punctuation">,</span> h_offset <span class="token operator">=</span> offset
    w2 <span class="token operator">=</span> math<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>w_offset<span class="token punctuation">)</span> <span class="token operator">*</span> w1
    h2 <span class="token operator">=</span> math<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>h_offset<span class="token punctuation">)</span> <span class="token operator">*</span> h1
    x2 <span class="token operator">=</span> x1 <span class="token operator">+</span> w1 <span class="token operator">*</span> x_offset <span class="token operator">-</span> w2 <span class="token operator">//</span> <span class="token number">2</span>
    y2 <span class="token operator">=</span> y1 <span class="token operator">+</span> h1 <span class="token operator">*</span> y_offset <span class="token operator">-</span> h2 <span class="token operator">//</span> <span class="token number">2</span>
    x2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  x2<span class="token punctuation">)</span>
    y2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  y2<span class="token punctuation">)</span>
    w2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>x2<span class="token punctuation">,</span> w2<span class="token punctuation">)</span>
    h2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>IMAGE_SIZE<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>y2<span class="token punctuation">,</span> h2<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> h2<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">prepare_save_batch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> image_tensors<span class="token punctuation">,</span> result_tensors<span class="token punctuation">,</span> result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""准备训练 - 保存单个批次的数据"""</span>
    <span class="token comment"># 按索引值列表生成输入和输出 tensor 对象的函数</span>
    <span class="token keyword">def</span> <span class="token function">split_dataset</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token punctuation">:</span>
        indices_list <span class="token operator">=</span> indices<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        image_tensors_splited <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>image_tensors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> indices_list<span class="token punctuation">]</span><span class="token punctuation">)</span>
        result_tensors_splited <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>result_tensors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> indices_list<span class="token punctuation">]</span><span class="token punctuation">)</span>
        result_isobject_masks_splited <span class="token operator">=</span> <span class="token punctuation">[</span>result_isobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> indices_list<span class="token punctuation">]</span>
        result_nonobject_masks_splited <span class="token operator">=</span> <span class="token punctuation">[</span>result_nonobject_masks<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> indices_list<span class="token punctuation">]</span>
        <span class="token keyword">return</span> image_tensors_splited<span class="token punctuation">,</span> <span class="token punctuation">(</span>
            result_tensors_splited<span class="token punctuation">,</span> result_isobject_masks_splited<span class="token punctuation">,</span> result_nonobject_masks_splited<span class="token punctuation">)</span>

    <span class="token comment"># 切分训练集 (80%)，验证集 (10%) 和测试集 (10%)</span>
    random_indices <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>image_tensors<span class="token punctuation">)</span><span class="token punctuation">)</span>
    training_indices <span class="token operator">=</span> random_indices<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>random_indices<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    validating_indices <span class="token operator">=</span> random_indices<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>random_indices<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>random_indices<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    testing_indices <span class="token operator">=</span> random_indices<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>random_indices<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    training_set <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>training_indices<span class="token punctuation">)</span>
    validating_set <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>validating_indices<span class="token punctuation">)</span>
    testing_set <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>testing_indices<span class="token punctuation">)</span>

    <span class="token comment"># 保存到硬盘</span>
    save_tensor<span class="token punctuation">(</span>training_set<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"data/training_set.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span><span class="token punctuation">)</span>
    save_tensor<span class="token punctuation">(</span>validating_set<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"data/validating_set.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span><span class="token punctuation">)</span>
    save_tensor<span class="token punctuation">(</span>testing_set<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"data/testing_set.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"batch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string"> saved"</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""准备训练"""</span>
    <span class="token comment"># 数据集转换到 tensor 以后会保存在 data 文件夹下</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span>

    <span class="token comment"># 加载图片和图片对应的区域与分类列表</span>
    <span class="token comment"># { (路径, 是否左右翻转): [ 区域与分类, 区域与分类, .. ] }</span>
    <span class="token comment"># 同一张图片左右翻转可以生成一个新的数据，让数据量翻倍</span>
    box_map <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>DATASET_1_IMAGE_DIR<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 从第一个数据集加载</span>
        xml_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATASET_1_ANNOTATION_DIR<span class="token punctuation">,</span> filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".xml"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>ElementTree<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token operator">=</span>xml_path<span class="token punctuation">)</span>
        objects <span class="token operator">=</span> tree<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATASET_1_IMAGE_DIR<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> objects<span class="token punctuation">:</span>
            class_name <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
            x1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"bndbox/xmin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            x2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"bndbox/xmax"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"bndbox/ymin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            y2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"bndbox/ymax"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            <span class="token keyword">if</span> class_name <span class="token operator">==</span> <span class="token string">"mask_weared_incorrect"</span><span class="token punctuation">:</span>
                <span class="token comment"># 佩戴口罩不正确的样本数量太少 (只有 123)，模型无法学习，这里全合并到戴口罩的样本</span>
                class_name <span class="token operator">=</span> <span class="token string">"with_mask"</span>
            box_map<span class="token punctuation">[</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> y2<span class="token operator">-</span>y1<span class="token punctuation">,</span> CLASSES_MAPPING<span class="token punctuation">[</span>class_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            box_map<span class="token punctuation">[</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> y2<span class="token operator">-</span>y1<span class="token punctuation">,</span> CLASSES_MAPPING<span class="token punctuation">[</span>class_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df <span class="token operator">=</span> pandas<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>DATASET_2_BOX_CSV_PATH<span class="token punctuation">)</span>
    <span class="token keyword">for</span> row <span class="token keyword">in</span> df<span class="token punctuation">.</span>values<span class="token punctuation">:</span>
        <span class="token comment"># 从第二个数据集加载，这个数据集只包含没有带口罩的图片</span>
        filename<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span>
        path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATASET_2_IMAGE_DIR<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        box_map<span class="token punctuation">[</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> y2<span class="token operator">-</span>y1<span class="token punctuation">,</span> CLASSES_MAPPING<span class="token punctuation">[</span><span class="token string">"without_mask"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        box_map<span class="token punctuation">[</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> y2<span class="token operator">-</span>y1<span class="token punctuation">,</span> CLASSES_MAPPING<span class="token punctuation">[</span><span class="token string">"without_mask"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 打乱数据集 (因为第二个数据集只有不戴口罩的图片)</span>
    box_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>box_map<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>box_list<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"found </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>box_list<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> images"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 保存图片和图片对应的分类与区域列表</span>
    batch_size <span class="token operator">=</span> <span class="token number">20</span>
    batch <span class="token operator">=</span> <span class="token number">0</span>
    image_tensors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 图片列表</span>
    result_tensors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 图片对应的输出结果列表，包含 [ 是否对象中心, 区域偏移, 各个分类的可能性 ]</span>
    result_isobject_masks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 各个图片的包含对象的区域在 Anchors 中的索引</span>
    result_nonobject_masks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 各个图片不包含对象的区域在 Anchors 中的索引 (重叠率低于阈值的区域)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> flip<span class="token punctuation">)</span><span class="token punctuation">,</span> original_boxes_labels <span class="token keyword">in</span> box_list<span class="token punctuation">:</span>
        <span class="token keyword">with</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span> <span class="token keyword">as</span> img_original<span class="token punctuation">:</span> <span class="token comment"># 加载原始图片</span>
            sw<span class="token punctuation">,</span> sh <span class="token operator">=</span> img_original<span class="token punctuation">.</span>size <span class="token comment"># 原始图片大小</span>
            <span class="token keyword">if</span> flip<span class="token punctuation">:</span>
                img <span class="token operator">=</span> resize_image<span class="token punctuation">(</span>img_original<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>Image<span class="token punctuation">.</span>FLIP_LEFT_RIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 翻转然后缩放图片</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                img <span class="token operator">=</span> resize_image<span class="token punctuation">(</span>img_original<span class="token punctuation">)</span> <span class="token comment"># 缩放图片</span>
            image_tensors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>image_to_tensor<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 添加图片到列表</span>
        <span class="token comment"># 生成输出结果的 tensor</span>
        result_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">.</span>Anchors<span class="token punctuation">)</span><span class="token punctuation">,</span> MyModel<span class="token punctuation">.</span>AnchorOutputs<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
        result_tensor<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># 默认分类为 other</span>
        result_tensors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result_tensor<span class="token punctuation">)</span>
        <span class="token comment"># 包含对象的区域在 Anchors 中的索引</span>
        result_isobject_mask <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        result_isobject_masks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result_isobject_mask<span class="token punctuation">)</span>
        <span class="token comment"># 不包含对象的区域在 Anchors 中的索引</span>
        result_nonobject_mask <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        result_nonobject_masks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result_nonobject_mask<span class="token punctuation">)</span>
        <span class="token comment"># 根据真实区域定位所属的锚点，然后设置输出结果</span>
        negative_mapping <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">.</span>Anchors<span class="token punctuation">)</span>
        <span class="token keyword">for</span> box_label <span class="token keyword">in</span> original_boxes_labels<span class="token punctuation">:</span>
            x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> label <span class="token operator">=</span> box_label
            <span class="token keyword">if</span> flip<span class="token punctuation">:</span> <span class="token comment"># 翻转坐标</span>
                x <span class="token operator">=</span> sw <span class="token operator">-</span> x <span class="token operator">-</span> w
            x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> map_box_to_resized_image<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span> <span class="token comment"># 缩放实际区域</span>
            <span class="token keyword">if</span> w <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token keyword">or</span> h <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span> <span class="token comment"># 缩放后区域过小</span>
            <span class="token comment"># 检查计算是否有问题</span>
            <span class="token comment"># child_img = img.copy().crop((x, y, x+w, y+h))</span>
            <span class="token comment"># child_img.save(f"{os.path.basename(image_path)}_{x}_{y}_{w}_{h}_{label}.png")</span>
            <span class="token comment"># 定位所属的锚点</span>
            <span class="token comment"># 要求:</span>
            <span class="token comment"># - 中心点落在锚点对应的区域中</span>
            <span class="token comment"># - 重叠率超过一定值</span>
            x_center <span class="token operator">=</span> x <span class="token operator">+</span> w <span class="token operator">//</span> <span class="token number">2</span>
            y_center <span class="token operator">=</span> y <span class="token operator">+</span> h <span class="token operator">//</span> <span class="token number">2</span>
            matched_anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> index<span class="token punctuation">,</span> anchor <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">.</span>Anchors<span class="token punctuation">)</span><span class="token punctuation">:</span>
                ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> aw<span class="token punctuation">,</span> ah <span class="token operator">=</span> anchor
                is_center <span class="token operator">=</span> <span class="token punctuation">(</span>x_center <span class="token operator">&gt;=</span> ax <span class="token keyword">and</span> x_center <span class="token operator">&lt;</span> ax <span class="token operator">+</span> aw <span class="token keyword">and</span>
                    y_center <span class="token operator">&gt;=</span> ay <span class="token keyword">and</span> y_center <span class="token operator">&lt;</span> ay <span class="token operator">+</span> ah<span class="token punctuation">)</span>
                iou <span class="token operator">=</span> calc_iou<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> is_center <span class="token keyword">and</span> iou <span class="token operator">&gt;</span> IOU_POSITIVE_THRESHOLD<span class="token punctuation">:</span>
                    matched_anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 区域包含对象中心并且重叠率超过一定值</span>
                    negative_mapping<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">elif</span> iou <span class="token operator">&gt;</span> IOU_NEGATIVE_THRESHOLD<span class="token punctuation">:</span>
                    negative_mapping<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># 区域与某个对象重叠率超过一定值，不应该当作负样本</span>
            <span class="token keyword">for</span> matched_index<span class="token punctuation">,</span> matched_box <span class="token keyword">in</span> matched_anchors<span class="token punctuation">:</span>
                <span class="token comment"># 计算区域偏移</span>
                offset <span class="token operator">=</span> calc_box_offset<span class="token punctuation">(</span>matched_box<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment"># 修改输出结果的 tensor</span>
                result_tensor<span class="token punctuation">[</span>matched_index<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">(</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment"># 是否对象中心</span>
                    <span class="token operator">*</span>offset<span class="token punctuation">,</span> <span class="token comment"># 区域偏移</span>
                    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>c <span class="token operator">==</span> label<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>CLASSES<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># 对应分类</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
                <span class="token comment"># 添加索引值</span>
                <span class="token comment"># 注意如果两个对象同时定位到相同的锚点，那么只有一个对象可以被识别，这里后面的对象会覆盖前面的对象</span>
                <span class="token keyword">if</span> matched_index <span class="token keyword">not</span> <span class="token keyword">in</span> result_isobject_mask<span class="token punctuation">:</span>
                    result_isobject_mask<span class="token punctuation">.</span>append<span class="token punctuation">(</span>matched_index<span class="token punctuation">)</span>
        <span class="token comment"># 没有找到可识别的对象时跳过图片</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> result_isobject_mask<span class="token punctuation">:</span>
            image_tensors<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_tensors<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_isobject_masks<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_nonobject_masks<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token comment"># 添加不包含对象的区域在 Anchors 中的索引</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>negative_mapping<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> value<span class="token punctuation">:</span>
                result_nonobject_mask<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index<span class="token punctuation">)</span>
        <span class="token comment"># 排序索引列表</span>
        result_isobject_mask<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 保存批次</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_tensors<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> batch_size<span class="token punctuation">:</span>
            prepare_save_batch<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> image_tensors<span class="token punctuation">,</span> result_tensors<span class="token punctuation">,</span>
                result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks<span class="token punctuation">)</span>
            image_tensors<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_tensors<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_isobject_masks<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result_nonobject_masks<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            batch <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token comment"># 保存剩余的批次</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_tensors<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        prepare_save_batch<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> image_tensors<span class="token punctuation">,</span> result_tensors<span class="token punctuation">,</span>
            result_isobject_masks<span class="token punctuation">,</span> result_nonobject_masks<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""开始训练"""</span>
    <span class="token comment"># 创建模型实例</span>
    model <span class="token operator">=</span> MyModel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># 创建多任务损失计算器</span>
    loss_function <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>loss_function

    <span class="token comment"># 创建参数调整器</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 记录训练集和验证集的正确率变化</span>
    training_obj_accuracy_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    training_cls_accuracy_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    validating_obj_accuracy_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    validating_cls_accuracy_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># 记录最高的验证集正确率</span>
    validating_obj_accuracy_highest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    validating_cls_accuracy_highest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    validating_accuracy_highest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    validating_accuracy_highest_epoch <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment"># 读取批次的工具函数</span>
    <span class="token keyword">def</span> <span class="token function">read_batches</span><span class="token punctuation">(</span>base_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> batch <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>base_path<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            x<span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> mask1<span class="token punctuation">,</span> mask2<span class="token punctuation">)</span> <span class="token operator">=</span> load_tensor<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
            <span class="token keyword">yield</span> x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> mask1<span class="token punctuation">,</span> mask2<span class="token punctuation">)</span>

    <span class="token comment"># 计算正确率的工具函数</span>
    calc_accuracy <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>calc_accuracy

    <span class="token comment"># 开始训练过程</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"epoch: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 根据训练集训练并修改参数</span>
        <span class="token comment"># 切换模型到训练模式，将会启用自动微分，批次正规化 (BatchNorm) 与 Dropout</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        training_obj_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        training_cls_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> batch_index<span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>read_batches<span class="token punctuation">(</span><span class="token string">"data/training_set"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 划分输入和输出</span>
            batch_x<span class="token punctuation">,</span> batch_y <span class="token operator">=</span> batch
            <span class="token comment"># 计算预测值</span>
            predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>
            <span class="token comment"># 计算损失</span>
            loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>predicted<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span>
            <span class="token comment"># 从损失自动微分求导函数值</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 使用参数调整器调整参数</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 清空导函数值</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 记录这一个批次的正确率，torch.no_grad 代表临时禁用自动微分功能</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                training_batch_obj_accuracy<span class="token punctuation">,</span> training_batch_cls_accuracy <span class="token operator">=</span> calc_accuracy<span class="token punctuation">(</span>batch_y<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span>
            <span class="token comment"># 输出批次正确率</span>
            training_obj_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>training_batch_obj_accuracy<span class="token punctuation">)</span>
            training_cls_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>training_batch_cls_accuracy<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"epoch: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">, batch: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_index<span class="token punctuation">}</span></span><span class="token string">: "</span></span> <span class="token operator">+</span>
                <span class="token string-interpolation"><span class="token string">f"batch obj accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>training_batch_obj_accuracy<span class="token punctuation">}</span></span><span class="token string">, cls accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>training_batch_cls_accuracy<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        training_obj_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>training_obj_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>training_obj_accuracy_list<span class="token punctuation">)</span>
        training_cls_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>training_cls_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>training_cls_accuracy_list<span class="token punctuation">)</span>
        training_obj_accuracy_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>training_obj_accuracy<span class="token punctuation">)</span>
        training_cls_accuracy_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>training_cls_accuracy<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"training obj accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>training_obj_accuracy<span class="token punctuation">}</span></span><span class="token string">, cls accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>training_cls_accuracy<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 检查验证集</span>
        <span class="token comment"># 切换模型到验证模式，将会禁用自动微分，批次正规化 (BatchNorm) 与 Dropout</span>
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        validating_obj_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        validating_cls_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> batch <span class="token keyword">in</span> read_batches<span class="token punctuation">(</span><span class="token string">"data/validating_set"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            batch_x<span class="token punctuation">,</span> batch_y <span class="token operator">=</span> batch
            predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>
            validating_batch_obj_accuracy<span class="token punctuation">,</span> validating_batch_cls_accuracy <span class="token operator">=</span> calc_accuracy<span class="token punctuation">(</span>batch_y<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span>
            validating_obj_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>validating_batch_obj_accuracy<span class="token punctuation">)</span>
            validating_cls_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>validating_batch_cls_accuracy<span class="token punctuation">)</span>
            <span class="token comment"># 释放 predicted 占用的显存避免显存不足的错误</span>
            predicted <span class="token operator">=</span> <span class="token boolean">None</span>
        validating_obj_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>validating_obj_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>validating_obj_accuracy_list<span class="token punctuation">)</span>
        validating_cls_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>validating_cls_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>validating_cls_accuracy_list<span class="token punctuation">)</span>
        validating_obj_accuracy_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>validating_obj_accuracy<span class="token punctuation">)</span>
        validating_cls_accuracy_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>validating_cls_accuracy<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"validating obj accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_obj_accuracy<span class="token punctuation">}</span></span><span class="token string">, cls accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_cls_accuracy<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 记录最高的验证集正确率与当时的模型状态，判断是否在 20 次训练后仍然没有刷新记录</span>
        validating_accuracy <span class="token operator">=</span> validating_obj_accuracy <span class="token operator">*</span> validating_cls_accuracy
        <span class="token keyword">if</span> validating_accuracy <span class="token operator">&gt;</span> validating_accuracy_highest<span class="token punctuation">:</span>
            validating_obj_accuracy_highest <span class="token operator">=</span> validating_obj_accuracy
            validating_cls_accuracy_highest <span class="token operator">=</span> validating_cls_accuracy
            validating_accuracy_highest <span class="token operator">=</span> validating_accuracy
            validating_accuracy_highest_epoch <span class="token operator">=</span> epoch
            save_tensor<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"model.pt"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"highest validating accuracy updated"</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> epoch <span class="token operator">-</span> validating_accuracy_highest_epoch <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
            <span class="token comment"># 在 20 次训练后仍然没有刷新记录，结束训练</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"stop training because highest validating accuracy not updated in 20 epoches"</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>

    <span class="token comment"># 使用达到最高正确率时的模型状态</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"highest obj validating accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_obj_accuracy_highest<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"from epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_accuracy_highest_epoch<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"highest cls validating accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_cls_accuracy_highest<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"from epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validating_accuracy_highest_epoch<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>load_tensor<span class="token punctuation">(</span><span class="token string">"model.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 检查测试集</span>
    testing_obj_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    testing_cls_accuracy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> batch <span class="token keyword">in</span> read_batches<span class="token punctuation">(</span><span class="token string">"data/testing_set"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_x<span class="token punctuation">,</span> batch_y <span class="token operator">=</span> batch
        predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>
        testing_batch_obj_accuracy<span class="token punctuation">,</span> testing_batch_cls_accuracy <span class="token operator">=</span> calc_accuracy<span class="token punctuation">(</span>batch_y<span class="token punctuation">,</span> predicted<span class="token punctuation">)</span>
        testing_obj_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>testing_batch_obj_accuracy<span class="token punctuation">)</span>
        testing_cls_accuracy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>testing_batch_cls_accuracy<span class="token punctuation">)</span>
    testing_obj_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>testing_obj_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>testing_obj_accuracy_list<span class="token punctuation">)</span>
    testing_cls_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>testing_cls_accuracy_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>testing_cls_accuracy_list<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"testing obj accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>testing_obj_accuracy<span class="token punctuation">}</span></span><span class="token string">, cls accuracy: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>testing_cls_accuracy<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 显示训练集和验证集的正确率变化</span>
    pyplot<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>training_obj_accuracy_history<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"training_obj_accuracy"</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>training_cls_accuracy_history<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"training_cls_accuracy"</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>validating_obj_accuracy_history<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"validating_obj_accuracy"</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>validating_cls_accuracy_history<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"validating_cls_accuracy"</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pyplot<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">eval_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""使用训练好的模型识别图片"""</span>
    <span class="token comment"># 创建模型实例，加载训练好的状态，然后切换到验证模式</span>
    model <span class="token operator">=</span> MyModel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>load_tensor<span class="token punctuation">(</span><span class="token string">"model.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 询问图片路径，并显示所有可能是人脸的区域</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            image_path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Image path: "</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> image_path<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment"># 构建输入</span>
            <span class="token keyword">with</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span> <span class="token keyword">as</span> img_original<span class="token punctuation">:</span> <span class="token comment"># 加载原始图片</span>
                sw<span class="token punctuation">,</span> sh <span class="token operator">=</span> img_original<span class="token punctuation">.</span>size <span class="token comment"># 原始图片大小</span>
                img <span class="token operator">=</span> resize_image<span class="token punctuation">(</span>img_original<span class="token punctuation">)</span> <span class="token comment"># 缩放图片</span>
                img_output <span class="token operator">=</span> img_original<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 复制图片，用于后面添加标记</span>
                tensor_in <span class="token operator">=</span> image_to_tensor<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token comment"># 预测输出</span>
            predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>tensor_in<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            final_result <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>convert_predicted_result<span class="token punctuation">(</span>predicted<span class="token punctuation">)</span>
            <span class="token comment"># 标记在图片上</span>
            draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img_output<span class="token punctuation">)</span>
            <span class="token keyword">for</span> label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score <span class="token keyword">in</span> final_result<span class="token punctuation">:</span>
                x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> map_box_to_original_image<span class="token punctuation">(</span>box<span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
                score <span class="token operator">=</span> obj_score <span class="token operator">*</span> cls_score
                color <span class="token operator">=</span> <span class="token string">"#00FF00"</span> <span class="token keyword">if</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"with_mask"</span> <span class="token keyword">else</span> <span class="token string">"#FF0000"</span>
                draw<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token operator">+</span>w<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> outline<span class="token operator">=</span>color<span class="token punctuation">)</span>
                draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">)</span>
                draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score<span class="token punctuation">)</span>
            img_output<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"img_output.png"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"saved to img_output.png"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"error:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">eval_video</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""使用训练好的模型识别视频"""</span>
    <span class="token comment"># 创建模型实例，加载训练好的状态，然后切换到验证模式</span>
    model <span class="token operator">=</span> MyModel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>load_tensor<span class="token punctuation">(</span><span class="token string">"model.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 询问视频路径，给可能是人脸的区域添加标记并保存新视频</span>
    <span class="token keyword">import</span> cv2
    font <span class="token operator">=</span> ImageFont<span class="token punctuation">.</span>truetype<span class="token punctuation">(</span><span class="token string">"FreeMonoBold.ttf"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            video_path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Video path: "</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> video_path<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment"># 读取输入视频</span>
            video <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span>
            <span class="token comment"># 获取每秒的帧数</span>
            fps <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FPS<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 获取视频长宽</span>
            size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 创建输出视频</span>
            video_output_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span><span class="token punctuation">,</span>
                os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".output.avi"</span><span class="token punctuation">)</span>
            result <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>video_output_path<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>VideoWriter_fourcc<span class="token punctuation">(</span><span class="token operator">*</span><span class="token string">"XVID"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fps<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
            <span class="token comment"># 用于减少误判的历史结果</span>
            history_results <span class="token operator">=</span> deque<span class="token punctuation">(</span>maxlen <span class="token operator">=</span> fps <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token comment"># 逐帧处理</span>
            count <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> video<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> ret<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
                <span class="token comment"># opencv 使用的是 BGR, Pillow 使用的是 RGB, 需要转换通道顺序</span>
                frame_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
                <span class="token comment"># 构建输入</span>
                img_original <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>frame_rgb<span class="token punctuation">)</span> <span class="token comment"># 加载原始图片</span>
                sw<span class="token punctuation">,</span> sh <span class="token operator">=</span> img_original<span class="token punctuation">.</span>size <span class="token comment"># 原始图片大小</span>
                img <span class="token operator">=</span> resize_image<span class="token punctuation">(</span>img_original<span class="token punctuation">)</span> <span class="token comment"># 缩放图片</span>
                img_output <span class="token operator">=</span> img_original<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 复制图片，用于后面添加标记</span>
                tensor_in <span class="token operator">=</span> image_to_tensor<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                <span class="token comment"># 预测输出</span>
                predicted <span class="token operator">=</span> model<span class="token punctuation">(</span>tensor_in<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                cls_result <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>convert_predicted_result<span class="token punctuation">(</span>predicted<span class="token punctuation">)</span>
                <span class="token comment"># 根据历史结果减少误判</span>
                final_result <span class="token operator">=</span> MyModel<span class="token punctuation">.</span>fix_predicted_result_from_history<span class="token punctuation">(</span>cls_result<span class="token punctuation">,</span> history_results<span class="token punctuation">)</span>
                <span class="token comment"># 标记在图片上</span>
                draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img_output<span class="token punctuation">)</span>
                <span class="token keyword">for</span> label<span class="token punctuation">,</span> box<span class="token punctuation">,</span> obj_score<span class="token punctuation">,</span> cls_score <span class="token keyword">in</span> final_result<span class="token punctuation">:</span>
                    x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> map_box_to_original_image<span class="token punctuation">(</span>box<span class="token punctuation">,</span> sw<span class="token punctuation">,</span> sh<span class="token punctuation">)</span>
                    score <span class="token operator">=</span> obj_score <span class="token operator">*</span> cls_score
                    color <span class="token operator">=</span> <span class="token string">"#00FF00"</span> <span class="token keyword">if</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"with_mask"</span> <span class="token keyword">else</span> <span class="token string">"#FF0000"</span>
                    draw<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token operator">+</span>w<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> outline<span class="token operator">=</span>color<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
                    draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CLASSES<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
                    draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
                <span class="token comment"># 写入帧到输出视频</span>
                frame_rgb_annotated <span class="token operator">=</span> numpy<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>img_output<span class="token punctuation">)</span>
                frame_bgr_annotated <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame_rgb_annotated<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2BGR<span class="token punctuation">)</span>
                result<span class="token punctuation">.</span>write<span class="token punctuation">(</span>frame_bgr_annotated<span class="token punctuation">)</span>
                count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">if</span> count <span class="token operator">%</span> fps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"handled </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>count<span class="token operator">//</span>fps<span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span>
            video<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            result<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"saved to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>video_output_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">raise</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"error:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""主函数"""</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Please run: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> prepare|train|eval"</span></span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 给随机数生成器分配一个初始值，使得每次运行都可以生成相同的随机数</span>
    <span class="token comment"># 这是为了让过程可重现，你也可以选择不这样做</span>
    random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>random<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># 根据命令行参数选择操作</span>
    operation <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> operation <span class="token operator">==</span> <span class="token string">"prepare"</span><span class="token punctuation">:</span>
        prepare<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> operation <span class="token operator">==</span> <span class="token string">"train"</span><span class="token punctuation">:</span>
        train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> operation <span class="token operator">==</span> <span class="token string">"eval"</span><span class="token punctuation">:</span>
        eval_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> operation <span class="token operator">==</span> <span class="token string">"eval-video"</span><span class="token punctuation">:</span>
        eval_video<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Unsupported operation: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>operation<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="25__969"></a>2.5 检测效果</h3> 
<p><strong>检测效果如下，可以看到效果还是很好的</strong><br> <img src="https://images2.imgbox.com/06/f9/iOBswaMy_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ea/3f/VHXOY1bw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9d/0f/kGfhfQVO_o.png" alt="在这里插入图片描述"></p> 
<p><strong>实时检测效果</strong></p> 
<p><img src="https://images2.imgbox.com/17/e0/WFBapK8J_o.gif" alt="在这里插入图片描述"></p> 
<h2><a id="_3__989"></a>🚩 3 口罩佩戴检测算法评价指标</h2> 
<p>目前， 口罩佩戴识别的研究已经成为热点， 算法也是越来越多， 所以要判断算法的好坏还需要一些指标作为参考 [36]。 大部分的评价指标都来自对混淆矩阵（confusion matrix） 的计算。</p> 
<p>其中 P（Positive） 表示预测值为正例。 N（Negative）表示预测值为反例。 T（True） 表示真实值与预测值相同。 预测值与真实值相反记为 F（False 。</p> 
<p>TP 表示真实值是正样本或者说预测值为正样本， 真实值和预测值相同。 TN 则为真实值为负样本或者说预测值为负样本， 并且真实值和预测值相同。 FP 则为真实值为负样本或者说预测值为正样本， 真实值和预测值不一样。 FN 则为真实值为正样本或者说预测值为负样本， 并且真实值和预测值不一样。</p> 
<h3><a id="31_Accuracy_998"></a>3.1 准确率（Accuracy）</h3> 
<p>表示的是模型在检测时判断为正样本与所有样本的比例，准确率通常用来评价整个模型的准确程度， 且不会包含太多信息， 因此不可能对模型的性能进行综合评价</p> 
<p><img src="https://images2.imgbox.com/a3/40/FMWu0XLi_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32_PrecisionRecall_1005"></a>3.2 精确率(Precision)和召回率(Recall)</h3> 
<p>精确率表示的是预测为正样本中真正正样本所占的比例， 它反映的是预测结果准确与否。 精确率的计算公式如下所示：</p> 
<p><img src="https://images2.imgbox.com/cc/99/EeHeve7I_o.png" alt="在这里插入图片描述"></p> 
<p>召回率表明样本中正例被预测正确的多少， 召回率主要看的是预测的结果是否全面。 召回率的计算公式如（2-3） 所示：</p> 
<p><img src="https://images2.imgbox.com/77/d0/EjFyREK5_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33_Average_precision_AP_1015"></a>3.3 平均精度(Average precision AP)</h3> 
<p>表示每个类检测好坏的结果。 召回率被当作横坐标， 精确率被当作纵坐标， 表示 P-R 曲线下方的面积， AP 值越高表明模型的平均准确率越高。 AP 的计算公式如下所示：</p> 
<p><img src="https://images2.imgbox.com/42/94/D90Ww3vw_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_4__1026"></a>🚩 4 最后</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b2f5eab0f500f4151789bc6c95586255/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">-bash: vim: command not found(快速解决)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/66280b263a50cab9ac3868d6bea80b44/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">DIRECT_IO 配置参数（UNIX）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>