<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>满足你一切需求的 MMYOLO/MMDet 可视化 (一) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="满足你一切需求的 MMYOLO/MMDet 可视化 (一)" />
<meta property="og:description" content="可视化在深度学习时代算是核心需求，借助可视化功能，研究者可以快速定位分析模型以及排查问题。在 OpenMMLab 2.0 时代，MMEngine 对常用的可视化需求进行了设计和实现，其具备如下功能：
提供丰富的开箱即用可视化功能，能够满足大部分计算机视觉可视化任务高扩展性，可视化功能多样化，能够通过简单扩展实现定制需求能够在训练和测试流程的任意点位进行可视化OpenMMLab 各个算法库具有统一可视化接口，利于用户理解和维护 系列文章概览 我们将开启可视化分析系列文章，结合 MMYOLO 中的 YOLOv5 算法，对 MMEngine 和 MMDetection 3.x 中实现的可视化功能进行全面解析。通过本系列文章你将能快速掌握常用的可视化使用方法和如何扩展等功能。
整个可视化分析系列文章一共分成 3 个部分，分别对应 Dataset 和测试过程中的可视化、训练过程中的可视化以及其余相关脚本可视化。其目录主结构为：
(1) 第一篇
MMEngine 可视化器和可视化后端介绍
Dataset 输出可视化
可视化 Dataset 输出可视化绘制结果保存到 WandB 模型测试中的可视化
GT 和预测分开可视化GT 和预测叠加可视化可视化绘制结果保存到 Tensorboard可视化 NMS 前后结果并将结果保存到 Tensorboard可视化注意力模块并用 WandB 保存为表格格式 (2) 第二篇
模型训练中的可视化
训练 loss 和评估指标等标量可视化追加自定义标量并存储到 WandBYOLOv5 训练中正样本可视化分析配置文件存储和可视化Tensorboard 模型结构图可视化参数梯度分布可视化 扩展可视化器和可视化后端
(3) 第三篇
图片推理结果可视化，包括大图推理特征图可视化Grad-Based CAM 和 Grad-Free CAM 可视化COCO 数据集标注可视化数据集分布可视化 由于 MMYOLO 中的可视化器是直接引用的 MMDetection 3.x 中，所以本文所述内容完全适用于 MMDetection 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c5b271a5d3745a6cadce85824042f325/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-09T13:40:25+08:00" />
<meta property="article:modified_time" content="2023-01-09T13:40:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">满足你一切需求的 MMYOLO/MMDet 可视化 (一)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>可视化在深度学习时代算是核心需求，借助可视化功能，研究者可以快速定位分析模型以及排查问题。在 OpenMMLab 2.0 时代，MMEngine 对常用的可视化需求进行了设计和实现，其具备如下功能：</p> 
<ul><li><strong>提供丰富的开箱即用可视化功能，能够满足大部分计算机视觉可视化任务</strong></li><li><strong>高扩展性，可视化功能多样化，能够通过简单扩展实现定制需求</strong></li><li><strong>能够在训练和测试流程的任意点位进行可视化</strong></li><li><strong>OpenMMLab 各个算法库具有统一可视化接口，利于用户理解和维护</strong></li></ul> 
<h2><a id="_8"></a>系列文章概览</h2> 
<p><strong>我们将开启可视化分析系列文章，结合 MMYOLO 中的 YOLOv5 算法，对 MMEngine 和 MMDetection 3.x 中实现的可视化功能进行全面解析。通过本系列文章你将能快速掌握常用的可视化使用方法和如何扩展等功能。</strong></p> 
<p>整个可视化分析系列文章一共分成 3 个部分，分别对应 <strong>Dataset 和测试过程中的可视化、训练过程中的可视化以及其余相关脚本可视化</strong>。其目录主结构为：</p> 
<p><strong>(1) 第一篇</strong></p> 
<ul><li> <p>MMEngine 可视化器和可视化后端介绍</p> </li><li> <p>Dataset 输出可视化</p> 
  <ul><li>可视化 Dataset 输出</li><li>可视化绘制结果保存到 WandB</li></ul> </li><li> <p>模型测试中的可视化</p> 
  <ul><li>GT 和预测分开可视化</li><li>GT 和预测叠加可视化</li><li>可视化绘制结果保存到 Tensorboard</li><li>可视化 NMS 前后结果并将结果保存到 Tensorboard</li><li>可视化注意力模块并用 WandB 保存为表格格式</li></ul> </li></ul> 
<p><strong>(2) 第二篇</strong></p> 
<ul><li> <p>模型训练中的可视化</p> 
  <ul><li>训练 loss 和评估指标等标量可视化</li><li>追加自定义标量并存储到 WandB</li><li>YOLOv5 训练中正样本可视化分析</li><li>配置文件存储和可视化</li><li>Tensorboard 模型结构图可视化</li><li>参数梯度分布可视化</li></ul> </li><li> <p>扩展可视化器和可视化后端</p> </li></ul> 
<p><strong>(3) 第三篇</strong></p> 
<ul><li>图片推理结果可视化，包括大图推理</li><li>特征图可视化</li><li>Grad-Based CAM 和 Grad-Free CAM 可视化</li><li>COCO 数据集标注可视化</li><li>数据集分布可视化</li></ul> 
<p>由于 MMYOLO 中的可视化器是直接引用的 MMDetection 3.x 中，所以本文所述内容完全适用于 MMDetection 3.x，并且因为 MMEngine 中统一了可视化器，因此本文部分内容也同样适用于 OpenMMLab 2.0 的各个框架。</p> 
<p>MMEngine 官方地址：</p> 
<p>https://github.com/open-mmlab/mmengine</p> 
<p>MMDetection 官方地址：</p> 
<p>https://github.com/open-mmlab/mmdetection</p> 
<p>MMYOLO 官方地址：</p> 
<p>https://github.com/open-mmlab/mmyolo</p> 
<p>本系列文章包括多位社区小伙伴的热情贡献， GitHub ID：@<strong>RangeKing @matrixgame2018 @PeterH0323，感谢大家！</strong></p> 
<p>本文是可视化的第一篇，如果大家对系列文章的规划有其他更好意见，欢迎留言给我们反馈！</p> 
<h2><a id="MMEngine__85"></a>MMEngine 可视化器和可视化后端介绍</h2> 
<h3><a id="_87"></a>总体介绍</h3> 
<p>MMEngine 引入了可视化对象 Visualizer 和多个可视化存储后端 VisBackend，如 <code>LocalVisBackend</code>、<code>WandbVisBackend</code> 和 <code>TensorboardVisBackend</code> 等。可视化对象 Visualizer 和可视化存储后端 VisBackend 的关系比较好理解：<strong>可视化对象负责绘制过程，而具体的存储交给可视化存储后端。可视化器绘制完成后，可以同时发给多个存储后端</strong>。</p> 
<p>为了简化接口调用，大部分情况下用户不会直接操作可视化存储后端，而是由可视化器统一管理。可视化对象 Visualizer 具体功能详细说明如下：</p> 
<ul><li><strong>支持基础绘图接口以及特征图可视化</strong></li><li><strong>支持本地， TensorBoard 以及 WandB 等多种后端，可以将训练状态例如 loss 、lr 或者性能评估指标以及可视化的结果写入指定的单一或多个后端</strong></li><li><strong>支持配置文件存储到多个后端，方便后续复现</strong></li><li><strong>允许在代码库任意位置调用，对任意位置的特征</strong> <strong>、</strong> <strong>图像</strong> <strong>、</strong> <strong>状态等进行可视化和存储</strong></li></ul> 
<h3><a id="_98"></a>功能简介</h3> 
<p>为了方便不同层级的可视化需求，可视化器 Visualizer 提供了 3 大类 API 接口，分别是：</p> 
<ul><li><strong>基础绘制接口，典型的如绘制 bbox、mask 和特征图</strong></li><li><strong>OpenMMLab 数据流格式绘制接口 add_datasample，用于支持绘制 MMYOLO 或者其他</strong> <strong>算法库</strong> <strong>输出的格式</strong></li><li><strong>存储接口，将绘制后结果存到后端中</strong></li></ul> 
<p>详细用法请阅读，本文不再赘述</p> 
<ul><li><strong>用户文档</strong>：https://github.com/open-mmlab/mmengine/blob/main/docs/zh_cn/advanced_tutorials/visualization.md</li><li><strong>设计文档</strong>：https://github.com/open-mmlab/mmengine/blob/main/docs/zh_cn/design/visualization.md</li></ul> 
<h3><a id="_114"></a>简单案例</h3> 
<p>下面我们给出两个简单例子，希望能提供更直观的体会。</p> 
<ol><li> <h4><a id="_118"></a>叠加绘制多个对象</h4> </li></ol> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> mmcv
<span class="token keyword">from</span> mmengine<span class="token punctuation">.</span>visualization <span class="token keyword">import</span> Visualizer

<span class="token comment"># 图片位于 https://github.com/open-mmlab/mmengine/blob/main/docs/en/_static/image/cat_and_dog.png</span>
image <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'cat_and_dog.png'</span><span class="token punctuation">,</span> channel_order<span class="token operator">=</span><span class="token string">'rgb'</span><span class="token punctuation">)</span>

<span class="token comment"># 初始化可视化器</span>
visualizer <span class="token operator">=</span> Visualizer<span class="token punctuation">(</span>image<span class="token operator">=</span>image<span class="token punctuation">)</span>

<span class="token comment"># 绘制多个检测框</span>
visualizer<span class="token punctuation">.</span>draw_bboxes<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">209</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">147</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> line_styles<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">)</span>

<span class="token comment"># 绘制单个检测框, xyxy 格式</span>
visualizer<span class="token punctuation">.</span>draw_bboxes<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">147</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> edge_colors<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> line_widths<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

visualizer<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2c/d8/cAJyQx80_o.png" alt=""></p> 
<ol start="2"><li> <h4><a id="_142"></a>绘制内容并存储到多个后端</h4> </li></ol> 
<p>假设想将绘制的图片保存到本地和 Tensorboard，<strong>只需要给 vis_backends 传递多个后端存储对象即可</strong>。示例如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> mmcv
<span class="token keyword">from</span> mmengine<span class="token punctuation">.</span>visualization <span class="token keyword">import</span> Visualizer

<span class="token comment"># 图片位于 https://github.com/open-mmlab/mmengine/blob/main/docs/en/_static/image/cat_and_dog.png</span>
image <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'cat_and_dog.png'</span><span class="token punctuation">,</span> channel_order<span class="token operator">=</span><span class="token string">'rgb'</span><span class="token punctuation">)</span>

<span class="token comment"># 初始化可视化器</span>
visualizer <span class="token operator">=</span> Visualizer<span class="token punctuation">(</span>image<span class="token operator">=</span>image<span class="token punctuation">,</span> vis_backends<span class="token operator">=</span><span class="token punctuation">[</span> <span class="token builtin">dict</span> <span class="token punctuation">(</span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token string">'LocalVisBackend'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span> <span class="token punctuation">(</span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token string">'TensorboardVisBackend'</span> <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> save_dir<span class="token operator">=</span><span class="token string">'temp_dir'</span><span class="token punctuation">)</span>

<span class="token comment"># 绘制多个检测框</span>
visualizer<span class="token punctuation">.</span>draw_bboxes<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">209</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">147</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> line_styles<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">)</span>

<span class="token comment"># 将图片存储到多个后端中</span>
visualizer<span class="token punctuation">.</span>add_image<span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">,</span> visualizer<span class="token punctuation">.</span>get_image<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>程序运行后会在 <code>temp_dir/vis_data</code> 文件夹下生成对应的图片和 Tensorboard 文件。</p> 
<p><strong>得益于可视化器的接口统一，你也可以轻松快速</strong> <strong>地</strong> <strong>扩展出你想要的可视化后端，后面我们将结合具体场景详细说明可视化器的各类用法。</strong></p> 
<h2><a id="Dataset__171"></a>Dataset 输出可视化</h2> 
<p>Dataset 输出可视化可以快速验证 dataset 和 pipeline 输出是否正确，可谓是一大神器。同时参考 MMClassfication 提供的对每个 pipeline 进行可视化的亮点功能，社区用户也在 MMYOLO 中进行了支持。功能脚本位于 https://github.com/open-mmlab/mmyolo/blob/main/tools/analysis_tools/browse_dataset.py</p> 
<p>下面结合 YOLOv5 配置进行详细说明。首先 MMYOLO 中默认的可视化配置为：</p> 
<pre><code class="prism language-python">vis_backends <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LocalVisBackend'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
visualizer <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'mmdet.DetLocalVisualizer'</span><span class="token punctuation">,</span> <span class="token comment"># 使用 mmdet 的可视化器</span>
    vis_backends<span class="token operator">=</span>vis_backends<span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">'visualizer'</span><span class="token punctuation">)</span>
</code></pre> 
<p>其使用了 MMDetection 中的 DetLocalVisualizer 可视化器，并且将结果保存到本地（默认不开启）。</p> 
<p>注：本小节所用图片都来自 MS COCO2017 Val 数据集。</p> 
<h3><a id="1__Dataset__192"></a>1 可视化 Dataset 输出</h3> 
<h4><a id="11__Dataset__194"></a>1.1 可视化 Dataset 输出结果</h4> 
<p>最常用的功能如下：</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> mmyolo
python tools/analysis_tools/browse_dataset.py configs/yolov5/yolov5_s-v61_syncbn_8xb16-300e_coco.py
</code></pre> 
<p>其会每隔 3 秒在本地窗口显示一张图片和对应数据增强后的标注：</p> 
<p><img src="https://images2.imgbox.com/1e/91/8QHbDb5a_o.png" alt=""></p> 
<p>为了方便使用，该脚本还提供了： <code>--out-dir</code> （将结果保存到本地）；<code>--show-number</code> （仅仅显示前 n 张图片）等功能。</p> 
<h4><a id="12__pipeline__209"></a>1.2 可视化 pipeline 输出结果</h4> 
<pre><code class="prism language-shell">python tools/analysis_tools/browse_dataset.py configs/yolov5/yolov5_s-v61_syncbn_8xb16-300e_coco.py <span class="token parameter variable">--mode</span> pipeline
</code></pre> 
<p>结果如下所示：</p> 
<p><img src="https://images2.imgbox.com/d6/52/78qe0u5k_o.png" alt=""></p> 
<p>其会显示每个 pipeline 运行后的效果图，也会显示当前图片的 shape 等信息。后续我们也会不断新增新功能。</p> 
<h3><a id="2__WandB_221"></a>2 可视化绘制结果保存到 WandB</h3> 
<p>MMEngine 已经支持了常用的 Tensorboard 和 WandB 后端，目前也在不断地新增其他后端。想切换为 WandB 后端，只需要修改配置即可，打开 <code>configs/_base_/default_runtime.py</code>，将 vis_backends 换掉即可：</p> 
<pre><code class="prism language-python">vis_backends <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'WandbVisBackend'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
visualizer <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'mmdet.DetLocalVisualizer'</span><span class="token punctuation">,</span>
    vis_backends<span class="token operator">=</span>vis_backends<span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">'visualizer'</span><span class="token punctuation">,</span>
    save_dir<span class="token operator">=</span><span class="token string">'result'</span><span class="token punctuation">)</span> <span class="token comment"># 因为这个脚本没有用到 runner，因此必须要指定保存路径</span>
</code></pre> 
<p>运行命令为：</p> 
<pre><code class="prism language-shell">python tools/analysis_tools/browse_dataset.py configs/yolov5/yolov5_s-v61_syncbn_8xb16-300e_coco.py -- not <span class="token parameter variable">-show</span>
</code></pre> 
<p>会在本地路径 <code>result/vis_data/wandb</code> 下生成 WandB 数据，在浏览器中打开对应地址就可以查看保存的数据。</p> 
<p><img src="https://images2.imgbox.com/69/aa/5WnPPRGB_o.png" alt=""></p> 
<p>其他后端也是一样的使用方式，非常便捷。</p> 
<h2><a id="_246"></a>模型测试中的可视化</h2> 
<p>模型测试是通过 <code>test.py</code> 实现。</p> 
<p>为了方便演示，我首先利用<a href="https://github.com/open-mmlab/mmyolo/blob/main/tools/misc/extract_subcoco.py"> extract_subcoco.py</a> 脚本将完整的 coco 数据集切分为小数据集，读者也可以这样做快速验证功能。</p> 
<p>注：本小节所用图片都来自 MS COCO2017 Val 数据集。</p> 
<p>下面以 5 个不同需求来演示测试中的可视化实现方式。</p> 
<h3><a id="1_GT__256"></a>1 GT 和预测分开可视化</h3> 
<p>想可视化预测结果，只需要指定 <code>--show</code> 即可，典型示例如下：</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> mmyolo
python tools/test.py configs/yolov5/yolov5_s-v61_syncbn_fast_8xb16-300e_coco.py yolov5_s-v61_syncbn_fast_8xb16-300e_coco_20220918_084700-86e02187.pth <span class="token parameter variable">--show</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b0/0e/tdb8P225_o.png" alt=""></p> 
<p>上图左侧为 GT，右侧为预测结果。你也可以指定 <code>--show-dir</code> 将预测结果保存到本地。</p> 
<h3><a id="2_GT__269"></a>2 GT 和预测叠加可视化</h3> 
<p>MMDetection 中可视化器默认情况下是左右图显示。为何不采用叠加到同一张图显示模式？ 原因是存在 mask 或者其他更密集信息情况下叠加显示效果比较糟糕，在仅仅只有 bbox 标注情况下可能看不出来。</p> 
<p>那么如何支持叠加显示？<strong>不好意思，在不改代码情况下暂时没有支持</strong>，为了能够实现这个需求，下面提供一种改代码的实现方式：</p> 
<ol><li>打开 mmdet/visualization/local_visualizer.py</li><li>在 https://github.com/open-mmlab/mmdetection/blob/3.x/mmdet/visualization/local_visualizer.py#L362 前面新增如下代码：</li></ol> 
<pre><code class="prism language-python">image <span class="token operator">=</span> gt_img_data
</code></pre> 
<ol start="3"><li>在 https://github.com/open-mmlab/mmdetection/blob/3.x/mmdet/visualization/local_visualizer.py#L379 前面新增如下代码：</li></ol> 
<pre><code class="prism language-python">gt_img_data <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre> 
<p>就可以了。不过为了更好地区分预测框和 GT 框，我们最好需要改一下显示颜色</p> 
<ol start="4"><li>在 https://github.com/open-mmlab/mmdetection/blob/3.x/mmdet/visualization/local_visualizer.py#L133 前面新增如下代码：</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">if</span> <span class="token string">'scores'</span> <span class="token keyword">in</span> instances<span class="token punctuation">:</span>
    colors <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 预测框红色</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    colors <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 标注框绿色</span>
</code></pre> 
<p>效果如下所示：</p> 
<p><img src="https://images2.imgbox.com/4a/da/7gV3iQdi_o.png" alt=""></p> 
<h3><a id="3__Tensorboard_306"></a>3 可视化绘制结果保存到 Tensorboard</h3> 
<p>用户只需要修改配置即可，打开 <code>configs/_base_/default_runtime.py</code>，将 vis_backends 换掉，同时还需要修改 default_hooks 参数。</p> 
<pre><code class="prism language-python">vis_backends <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'TensorboardVisBackend'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
visualizer <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'mmdet.DetLocalVisualizer'</span><span class="token punctuation">,</span>
    vis_backends<span class="token operator">=</span>vis_backends<span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">'visualizer'</span> <span class="token comment"># 不需要指定保存路径</span>
<span class="token punctuation">)</span> 
    
default_hooks <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    visualization<span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'mmdet.DetVisualizationHook'</span><span class="token punctuation">,</span> 
    interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 保存间隔改成 1，每张图片都保存</span>
    draw<span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 重要！开启绘制和保存功能，默认不开启</span>
<span class="token punctuation">)</span> 
</code></pre> 
<pre><code class="prism language-shell">python tools/test.py configs/yolov5/yolov5_s-v61_syncbn_fast_8xb16-300e_coco.py yolov5_s-v61_syncbn_fast_8xb16-300e_coco_20220918_084700-86e02187.pth
</code></pre> 
<p>会在 <code>work_dirs/yolov5_s-v61_syncbn_fast_8xb16-300e_coco/时间戳/vis_data</code> 路径下生成 tf 文件，浏览器启动方式为：</p> 
<pre><code class="prism language-shell">tensorboard <span class="token parameter variable">--logdir</span> work_dirs
</code></pre> 
<p>效果如下：</p> 
<p><img src="https://images2.imgbox.com/12/86/jf3SC7ed_o.png" alt=""></p> 
<h3><a id="4__NMS__Tensorboard_339"></a>4 可视化 NMS 前后结果并将结果保存到 Tensorboard</h3> 
<p><strong>为了验证可视化器支持在代码任意位置进行可视化，我</strong> <strong>们</strong> <strong>采用 YOLOv5 算法进行测试，并可视化 NMS 前后的效果，并且将对比图保存到 Tensorboard 中。</strong></p> 
<p>首先配置文件和第 3 小节一样修改即可，然后在 https://github.com/open-mmlab/mmyolo/blob/main/mmyolo/models/dense_heads/yolov5_head.py#L413 处修改为调用两次_bbox_post_process，其中一次为 nms 前，一次为 nms 后即可。将原先的：</p> 
<pre><code class="prism language-python">results <span class="token operator">=</span> self<span class="token punctuation">.</span>_bbox_post_process<span class="token punctuation">(</span>
        results<span class="token operator">=</span>results<span class="token punctuation">,</span>
        cfg<span class="token operator">=</span>cfg<span class="token punctuation">,</span>
        rescale<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        with_nms<span class="token operator">=</span>with_nms<span class="token punctuation">,</span>
        img_meta<span class="token operator">=</span>img_meta<span class="token punctuation">)</span>
</code></pre> 
<p>替换为如下代码即可：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> mmcv
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> mmengine<span class="token punctuation">.</span>visualization <span class="token keyword">import</span> Visualizer
<span class="token keyword">from</span> mmdet<span class="token punctuation">.</span>structures <span class="token keyword">import</span> DetDataSample

<span class="token comment"># 获取可视化器</span>
det_visualizer <span class="token operator">=</span> Visualizer<span class="token punctuation">.</span>get_current_instance<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取原图</span>
img <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_meta<span class="token punctuation">[</span><span class="token string">'img_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
img <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>imconvert<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'bgr'</span><span class="token punctuation">,</span> <span class="token string">'rgb'</span><span class="token punctuation">)</span>

<span class="token comment"># 构建DataSample</span>
pred_data_sample <span class="token operator">=</span> DetDataSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># nms 前结果</span>
results_pre_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>_bbox_post_process<span class="token punctuation">(</span>
    results<span class="token operator">=</span>copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">,</span>
    cfg<span class="token operator">=</span>cfg<span class="token punctuation">,</span>
    rescale<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    with_nms<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    img_meta<span class="token operator">=</span>img_meta<span class="token punctuation">)</span>
pred_data_sample<span class="token punctuation">.</span>pred_instances <span class="token operator">=</span> results_pre_nms
<span class="token comment"># 绘制</span>
det_visualizer<span class="token punctuation">.</span>add_datasample<span class="token punctuation">(</span>
    <span class="token string">'nms_or_not'</span><span class="token punctuation">,</span>
    img<span class="token punctuation">,</span>
    draw_gt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    data_sample<span class="token operator">=</span>pred_data_sample<span class="token punctuation">,</span>
    show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    wait_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    pred_score_thr<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
    out_file<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token comment"># 获取 nms 前绘制结果   </span>
img_pre_nms <span class="token operator">=</span> det_visualizer<span class="token punctuation">.</span>get_image<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># nms 后结果</span>
results <span class="token operator">=</span> self<span class="token punctuation">.</span>_bbox_post_process<span class="token punctuation">(</span>
    results<span class="token operator">=</span>results<span class="token punctuation">,</span>
    cfg<span class="token operator">=</span>cfg<span class="token punctuation">,</span>
    rescale<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    with_nms<span class="token operator">=</span>with_nms<span class="token punctuation">,</span>
    img_meta<span class="token operator">=</span>img_meta<span class="token punctuation">)</span>
pred_data_sample<span class="token punctuation">.</span>pred_instances <span class="token operator">=</span> results
<span class="token comment"># 绘制</span>
det_visualizer<span class="token punctuation">.</span>add_datasample<span class="token punctuation">(</span>
    <span class="token string">'nms_or_not'</span><span class="token punctuation">,</span>
    img<span class="token punctuation">,</span>
    draw_gt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    data_sample<span class="token operator">=</span>pred_data_sample<span class="token punctuation">,</span>
    show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    wait_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    pred_score_thr<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
    out_file<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token comment"># 获取 nms 后绘制结果       </span>
img_post_nms <span class="token operator">=</span> det_visualizer<span class="token punctuation">.</span>get_image<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 左右图显示</span>
drawn_img <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>img_pre_nms<span class="token punctuation">,</span> img_post_nms<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 保存到后端</span>
det_visualizer<span class="token punctuation">.</span>add_image<span class="token punctuation">(</span><span class="token string">'pre_and_post_nms_results'</span><span class="token punctuation">,</span> drawn_img<span class="token punctuation">,</span> step<span class="token operator">=</span>self<span class="token punctuation">.</span>_step<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>_step <span class="token operator">+=</span> <span class="token number">1</span>
</code></pre> 
<p><strong>注意： self._step = 0 需要在</strong> ****<strong>YOLOv5Head 中初始化下。</strong></p> 
<p>会在 <code>work_dirs/yolov5_s-v61_syncbn_fast_8xb16-300e_coco/时间戳/vis_data</code> 路径下生成 tensorboard 文件，浏览器启动方式为：</p> 
<pre><code class="prism language-shell">tensorboard <span class="token parameter variable">--logdir</span> work_dirs
</code></pre> 
<p>效果如下：</p> 
<p><img src="https://images2.imgbox.com/16/02/hz5lxb3V_o.png" alt=""></p> 
<h3><a id="5__WandB__437"></a>5 可视化注意力模块并用 WandB 保存为表格格式</h3> 
<p>注意力模块添加后是否有效的一个简单检测办法就是可视化注意力前后特征图变化。本小节采用 RTMDet 的骨干网络中通道注意力模块来作为演示案例。</p> 
<p><strong>为了突出可视化器的自定义功能，在绘制后采用 WandB 特有的表格存储格式进行说明。</strong></p> 
<p>在 MMYOLO 中 RTMDet backbone 的 stage 1 至 stage 4，一共 4 个 stage 的 CSPLayer 中嵌入了通道注意力，如下所示：</p> 
<p><img src="https://images2.imgbox.com/31/6f/EHzxcKUb_o.png" alt=""></p> 
<p>完整结构图见：https://github.com/open-mmlab/mmyolo/blob/main/docs/zh_cn/algorithm_descriptions/rtmdet_description.md</p> 
<p>本文以 RTMDet-s 模型为例，对每个 stage 中嵌入的通道注意力计算前后的特征图进行可视化，验证注意力机制是否生效。最终效果如下所示：</p> 
<p><img src="https://images2.imgbox.com/32/ae/UblE1sls_o.png" alt=""></p> 
<p>以其中一种图片细节为例，stage 4 通道注意力运算前：</p> 
<p><img src="https://images2.imgbox.com/39/b2/TiH1X71c_o.png" alt=""></p> 
<p>stage 4 通道注意力运算后：</p> 
<p><img src="https://images2.imgbox.com/60/28/USwyzM3x_o.png" alt=""></p> 
<p>总结来说：</p> 
<ul><li><strong>一共 9 列，第 1 列显示原图，第 2~9 列分别是 4 个 stage 通道注意力运算前后的特征图</strong></li><li><strong>输出的每个特征图都是采用 MMEngine 中的</strong> <strong><code>draw_featmap</code></strong> <strong>函数绘制，并采用了</strong> <strong><code>select_max</code></strong> <strong>通道压缩模式，你也可以换成其他显示模式</strong></li><li><strong>为了更容易对齐，采用原图叠加特征图显示模式</strong></li><li><strong>采用 WandB 特有的表格组织格式显示</strong></li></ul> 
<p>下面是详细修改步骤。</p> 
<p><strong>(1) 修改 configs/<em>base</em>/default_runtime.py</strong></p> 
<p>将可视化后端修改为 WandB</p> 
<pre><code class="prism language-python">
vis_backends <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'WandbVisBackend'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
</code></pre> 
<p><strong>(2) 保存原图和 stage 信息</strong></p> 
<p>为了得到原图，需要修改 <code>mmyolo/models/backbones/base_backbone.py</code> 中的 forward 函数为如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">:</span>

    <span class="token keyword">from</span> mmengine <span class="token keyword">import</span> MessageHub
    <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
    message_hub <span class="token operator">=</span> MessageHub<span class="token punctuation">.</span>get_current_instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 得到原图，并还原为归一化前的原图</span>
    orig_img <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 这里是 hard code</span>
    mean <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">103.53</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    std <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">57.375</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">58.395</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    orig_img <span class="token operator">=</span> orig_img <span class="token operator">*</span> std <span class="token operator">+</span> mean
    <span class="token comment"># bgr-&gt;rgb</span>
    orig_img <span class="token operator">=</span> orig_img<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  
    
    <span class="token comment"># 暂时保存起来</span>
    message_hub<span class="token punctuation">.</span>update_info<span class="token punctuation">(</span> <span class="token string">'orig_img'</span> <span class="token punctuation">,</span> orig_img<span class="token punctuation">)</span>

    outs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> layer_name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>layers<span class="token punctuation">)</span><span class="token punctuation">:</span>
        layer <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> layer_name<span class="token punctuation">)</span>
        
        <span class="token comment"># stage 信息后面需要用到</span>
        message_hub<span class="token punctuation">.</span>update_info<span class="token punctuation">(</span><span class="token string">'stage'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>

        x <span class="token operator">=</span> layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>out_indices<span class="token punctuation">:</span>
            outs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>outs<span class="token punctuation">)</span>
</code></pre> 
<p><strong>(3) 绘制注意力前后特征图</strong></p> 
<p>修改 <code>mmdet/models/layers/csp_layer.py</code> 中的 CSPLayer 的 forward 函数：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
    x_short <span class="token operator">=</span> self<span class="token punctuation">.</span>short_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x_main <span class="token operator">=</span> self<span class="token punctuation">.</span>main_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x_main <span class="token operator">=</span> self<span class="token punctuation">.</span>blocks<span class="token punctuation">(</span>x_main<span class="token punctuation">)</span>

    x_final <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x_main<span class="token punctuation">,</span> x_short<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>channel_attention<span class="token punctuation">:</span>
        <span class="token comment"># 新增代码</span>
        <span class="token keyword">from</span> mmengine<span class="token punctuation">.</span>visualization <span class="token keyword">import</span> Visualizer
        <span class="token keyword">from</span> mmengine <span class="token keyword">import</span> MessageHub
        
        message_hub <span class="token operator">=</span> MessageHub<span class="token punctuation">.</span>get_current_instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
        det_visualizer <span class="token operator">=</span> Visualizer<span class="token punctuation">.</span>get_current_instance<span class="token punctuation">(</span><span class="token punctuation">)</span>

        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 绘制通道注意力前特征图并保存到 data</span>
        orig_img <span class="token operator">=</span> message_hub<span class="token punctuation">.</span>get_info<span class="token punctuation">(</span><span class="token string">'orig_img'</span><span class="token punctuation">)</span>
        drawn_img <span class="token operator">=</span> det_visualizer<span class="token punctuation">.</span>draw_featmap<span class="token punctuation">(</span>x_final<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">,</span> channel_reduction<span class="token operator">=</span><span class="token string">'select_max'</span><span class="token punctuation">)</span>
        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>drawn_img<span class="token punctuation">)</span>

        x_final <span class="token operator">=</span> self<span class="token punctuation">.</span>attention<span class="token punctuation">(</span>x_final<span class="token punctuation">)</span>
       
        <span class="token comment"># 绘制通道注意力后特征图并保存到 data</span>
        drawn_img <span class="token operator">=</span> det_visualizer<span class="token punctuation">.</span>draw_featmap<span class="token punctuation">(</span>x_final<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">,</span> channel_reduction<span class="token operator">=</span><span class="token string">'select_max'</span><span class="token punctuation">)</span>
        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>drawn_img<span class="token punctuation">)</span>
        
        <span class="token comment"># 将数据存储起来，在 hook 中获取并存储</span>
        message_hub<span class="token punctuation">.</span>update_info<span class="token punctuation">(</span><span class="token string">'ca_attn'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>message_hub<span class="token punctuation">.</span>get_info<span class="token punctuation">(</span><span class="token string">'stage'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

    <span class="token keyword">return</span> self<span class="token punctuation">.</span>final_conv<span class="token punctuation">(</span>x_final<span class="token punctuation">)</span>
</code></pre> 
<p><strong>(4) 在 DetVisualizationHook 中处理并保存到 WandB</strong></p> 
<p>修改 <code>mmdet/engine/hooks/visualization_hook.py</code> 中的 <code>after_test_iter</code> 方法：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">after_test_iter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runner<span class="token punctuation">:</span> Runner<span class="token punctuation">,</span> batch_idx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> data_batch<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
                    outputs<span class="token punctuation">:</span> Sequence<span class="token punctuation">[</span>DetDataSample<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    
    <span class="token keyword">from</span> mmengine <span class="token keyword">import</span> MessageHub
    message_hub <span class="token operator">=</span> MessageHub<span class="token punctuation">.</span>get_current_instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 获取原图</span>
    ca_attns <span class="token operator">=</span> <span class="token punctuation">[</span>message_hub<span class="token punctuation">.</span>get_info<span class="token punctuation">(</span><span class="token string">'orig_img'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 获取 8 个特征图</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ca_attn <span class="token operator">=</span> message_hub<span class="token punctuation">.</span>get_info<span class="token punctuation">(</span><span class="token string">'ca_attn'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ca_attns<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>ca_attn<span class="token punctuation">)</span>
    
    <span class="token comment"># 获取 wandb 后端对象</span>
    wandb <span class="token operator">=</span> self<span class="token punctuation">.</span>_visualizer<span class="token punctuation">.</span>get_backend<span class="token punctuation">(</span><span class="token string">'WandbVisBackend'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>experiment
    
    <span class="token comment"># 设置为 wandb 的 image 格式</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ca_attn <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>ca_attns<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ca_attns<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wandb<span class="token punctuation">.</span>Image<span class="token punctuation">(</span>ca_attn<span class="token punctuation">)</span>
    
    self<span class="token punctuation">.</span>ca_atten<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ca_attns<span class="token punctuation">)</span>
    
    
    <span class="token comment"># 以下代码都不动</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>draw <span class="token keyword">is</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>
</code></pre> 
<p>由于 WandB 特点，还需要在程序运行完成后，将数据序列化并上传到 WandB：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">after_run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runner<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    det_visualizer <span class="token operator">=</span> Visualizer<span class="token punctuation">.</span>get_current_instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 获取后端</span>
    wandb <span class="token operator">=</span> det_visualizer<span class="token punctuation">.</span>get_backend<span class="token punctuation">(</span><span class="token string">'WandbVisBackend'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>experiment

    columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'orig_img'</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        columns<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ca_pre_max_stage'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'ca_post_max_stage'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 保存为表格</span>
    wandb<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'featmap'</span><span class="token punctuation">:</span> wandb<span class="token punctuation">.</span>Table<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns<span class="token punctuation">,</span> data<span class="token operator">=</span>self<span class="token punctuation">.</span>ca_atten<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
</code></pre> 
<p><strong>可视化器的使用非常灵活，当目前接口无法满足你的需求时候，你可以通过 get_backend 直接获取到特定的后端，然后直接调用后端特定方法就行。这样就实现了在提供通用接口基础上还有无限扩展功能。</strong></p> 
<p>我们选择几张图片看一下注意力效果，看起来还是很有效的。</p> 
<p><img src="https://images2.imgbox.com/36/4d/P7vwDPkd_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/4c/eb/sWEmzLq6_o.png" alt=""></p> 
<h2><a id="_623"></a>总结</h2> 
<p>本文以几个小例子演示了 MMEngine 的可视化器和可视化后端功能，并重点对 MMYOLO 中常用的测试过程可视化进行了详细的案例说明，从中可以看出可视化器具备灵活和便捷使用的特点。</p> 
<p><strong>MMYOLO 官方地址：</strong> <strong>https://github.com/open-mmlab/mmyolo</strong></p> 
<p><strong>MMEngine 官方地址：</strong> <strong>https://github.com/open-mmlab/mmengine</strong></p> 
<p>欢迎大家体验，如果对你有帮助，就点个 star 吧~ 期待你的反馈！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8850b4e14a3e178cf051e64f42be9e5e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Windows11-Redis 最新安装教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b80ea5b205d605050e963d6a81506659/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java—动态规划之背包问题DP</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>