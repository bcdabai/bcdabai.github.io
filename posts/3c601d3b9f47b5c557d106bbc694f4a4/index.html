<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>tcp-full.cc - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="tcp-full.cc" />
<meta property="og:description" content="ns2--tcp-full.cc
1 /* -*- Mode:C&#43;&#43;; c-basic-offset:8; tab-width:8; indent-tabs-mode:t -*- */ 2 3 /* 4 * Copyright (c) Intel Corporation 2001. All rights reserved. 5 * 6 * Licensed under the Apache License, Version 2.0 (the &#34;License&#34;); 7 * you may not use this file except in compliance with the License. 8 * You may obtain a copy of the License at 9 * http://www.apache.org/licenses/LICENSE-2.0 10 * 11 * Unless required by applicable law or agreed to in writing, software 12 * distributed under the License is distributed on an &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3c601d3b9f47b5c557d106bbc694f4a4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-22T20:49:52+08:00" />
<meta property="article:modified_time" content="2019-09-22T20:49:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">tcp-full.cc</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body" class="blogpost-body"> 
 <p>ns2--tcp-full.cc</p> 
 <div class="cnblogs_code"> 
  <pre><span style="color:#008080;">   1</span> <span style="color:#008000;">/*</span><span style="color:#008000;"> -*-    Mode:C++; c-basic-offset:8; tab-width:8; indent-tabs-mode:t -*- </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">   2</span> 
<span style="color:#008080;">   3</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">   4</span> <span style="color:#008000;"> * Copyright (c) Intel Corporation 2001. All rights reserved.
</span><span style="color:#008080;">   5</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">   6</span> <span style="color:#008000;"> * Licensed under the Apache License, Version 2.0 (the "License");
</span><span style="color:#008080;">   7</span> <span style="color:#008000;"> * you may not use this file except in compliance with the License.
</span><span style="color:#008080;">   8</span> <span style="color:#008000;"> * You may obtain a copy of the License at
</span><span style="color:#008080;">   9</span> <span style="color:#008000;"> *   </span><span style="color:#008000;text-decoration:underline;">http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="color:#008080;">  10</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  11</span> <span style="color:#008000;"> * Unless required by applicable law or agreed to in writing, software
</span><span style="color:#008080;">  12</span> <span style="color:#008000;"> * distributed under the License is distributed on an "AS IS" BASIS,
</span><span style="color:#008080;">  13</span> <span style="color:#008000;"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span style="color:#008080;">  14</span> <span style="color:#008000;"> * See the License for the specific language governing permissions and
</span><span style="color:#008080;">  15</span> <span style="color:#008000;"> * limitations under the License.
</span><span style="color:#008080;">  16</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">  17</span> 
<span style="color:#008080;">  18</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">  19</span> <span style="color:#008000;"> * Copyright (c) 1997, 1998 The Regents of the University of California.
</span><span style="color:#008080;">  20</span> <span style="color:#008000;"> * All rights reserved.
</span><span style="color:#008080;">  21</span> <span style="color:#008000;"> * 
</span><span style="color:#008080;">  22</span> <span style="color:#008000;"> * Redistribution and use in source and binary forms, with or without
</span><span style="color:#008080;">  23</span> <span style="color:#008000;"> * modification, are permitted provided that the following conditions
</span><span style="color:#008080;">  24</span> <span style="color:#008000;"> * are met:
</span><span style="color:#008080;">  25</span> <span style="color:#008000;"> * 1. Redistributions of source code must retain the above copyright
</span><span style="color:#008080;">  26</span> <span style="color:#008000;"> *    notice, this list of conditions and the following disclaimer.
</span><span style="color:#008080;">  27</span> <span style="color:#008000;"> * 2. Redistributions in binary form must reproduce the above copyright
</span><span style="color:#008080;">  28</span> <span style="color:#008000;"> *    notice, this list of conditions and the following disclaimer in the
</span><span style="color:#008080;">  29</span> <span style="color:#008000;"> *    documentation and/or other materials provided with the distribution.
</span><span style="color:#008080;">  30</span> <span style="color:#008000;"> * 3. All advertising materials mentioning features or use of this software
</span><span style="color:#008080;">  31</span> <span style="color:#008000;"> *    must display the following acknowledgement:
</span><span style="color:#008080;">  32</span> <span style="color:#008000;"> *     This product includes software developed by the Network Research
</span><span style="color:#008080;">  33</span> <span style="color:#008000;"> *     Group at Lawrence Berkeley National Laboratory.
</span><span style="color:#008080;">  34</span> <span style="color:#008000;"> * 4. Neither the name of the University nor of the Laboratory may be used
</span><span style="color:#008080;">  35</span> <span style="color:#008000;"> *    to endorse or promote products derived from this software without
</span><span style="color:#008080;">  36</span> <span style="color:#008000;"> *    specific prior written permission.
</span><span style="color:#008080;">  37</span> <span style="color:#008000;"> * 
</span><span style="color:#008080;">  38</span> <span style="color:#008000;"> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
</span><span style="color:#008080;">  39</span> <span style="color:#008000;"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
</span><span style="color:#008080;">  40</span> <span style="color:#008000;"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
</span><span style="color:#008080;">  41</span> <span style="color:#008000;"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
</span><span style="color:#008080;">  42</span> <span style="color:#008000;"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
</span><span style="color:#008080;">  43</span> <span style="color:#008000;"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
</span><span style="color:#008080;">  44</span> <span style="color:#008000;"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
</span><span style="color:#008080;">  45</span> <span style="color:#008000;"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
</span><span style="color:#008080;">  46</span> <span style="color:#008000;"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
</span><span style="color:#008080;">  47</span> <span style="color:#008000;"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
</span><span style="color:#008080;">  48</span> <span style="color:#008000;"> * SUCH DAMAGE.
</span><span style="color:#008080;">  49</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">  50</span> 
<span style="color:#008080;">  51</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">  52</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  53</span> <span style="color:#008000;"> * Full-TCP : A two-way TCP very similar to the 4.4BSD version of Reno TCP.
</span><span style="color:#008080;">  54</span> <span style="color:#008000;"> * This version also includes variants Tahoe, NewReno, and SACK.
</span><span style="color:#008080;">  55</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  56</span> <span style="color:#008000;"> * This code below has received a fairly major restructuring (Aug. 2001).
</span><span style="color:#008080;">  57</span> <span style="color:#008000;"> * The ReassemblyQueue structure is now removed to a separate module and
</span><span style="color:#008080;">  58</span> <span style="color:#008000;"> * entirely re-written.
</span><span style="color:#008080;">  59</span> <span style="color:#008000;"> * Also, the SACK functionality has been re-written (almost) entirely.
</span><span style="color:#008080;">  60</span> <span style="color:#008000;"> * -KF [kfall@intel.com]
</span><span style="color:#008080;">  61</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  62</span> <span style="color:#008000;"> * This code below was motivated in part by code contributed by
</span><span style="color:#008080;">  63</span> <span style="color:#008000;"> * Kathie Nichols (nichols@baynetworks.com).  The code below is based primarily
</span><span style="color:#008080;">  64</span> <span style="color:#008000;"> * on the 4.4BSD TCP implementation. -KF [kfall@ee.lbl.gov]
</span><span style="color:#008080;">  65</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  66</span> <span style="color:#008000;"> * Kathie Nichols and Van Jacobson have contributed significant bug fixes,
</span><span style="color:#008080;">  67</span> <span style="color:#008000;"> * especially with respect to the the handling of sequence numbers during
</span><span style="color:#008080;">  68</span> <span style="color:#008000;"> * connection establishment/clearin.  Additional fixes have followed
</span><span style="color:#008080;">  69</span> <span style="color:#008000;"> * theirs.
</span><span style="color:#008080;">  70</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  71</span> <span style="color:#008000;"> * Fixes for gensack() and ReassemblyQueue::add() contributed by Richard 
</span><span style="color:#008080;">  72</span> <span style="color:#008000;"> * Mortier &lt;Richard.Mortier@cl.cam.ac.uk&gt;
</span><span style="color:#008080;">  73</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  74</span> <span style="color:#008000;"> * Some warnings and comments:
</span><span style="color:#008080;">  75</span> <span style="color:#008000;"> *    this version of TCP will not work correctly if the sequence number
</span><span style="color:#008080;">  76</span> <span style="color:#008000;"> *    goes above 2147483648 due to sequence number wrap
</span><span style="color:#008080;">  77</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  78</span> <span style="color:#008000;"> *    this version of TCP by default sends data at the beginning of a
</span><span style="color:#008080;">  79</span> <span style="color:#008000;"> *    connection in the "typical" way... That is,
</span><span style="color:#008080;">  80</span> <span style="color:#008000;"> *        A   ------&gt; SYN ------&gt; B
</span><span style="color:#008080;">  81</span> <span style="color:#008000;"> *        A   &lt;----- SYN+ACK ---- B
</span><span style="color:#008080;">  82</span> <span style="color:#008000;"> *        A   ------&gt; ACK ------&gt; B
</span><span style="color:#008080;">  83</span> <span style="color:#008000;"> *        A   ------&gt; data -----&gt; B
</span><span style="color:#008080;">  84</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  85</span> <span style="color:#008000;"> *    there is no dynamic receiver's advertised window.   The advertised
</span><span style="color:#008080;">  86</span> <span style="color:#008000;"> *    window is simulated by simply telling the sender a bound on the window
</span><span style="color:#008080;">  87</span> <span style="color:#008000;"> *    size (wnd_).
</span><span style="color:#008080;">  88</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  89</span> <span style="color:#008000;"> *    in real TCP, a user process performing a read (via PRU_RCVD)
</span><span style="color:#008080;">  90</span> <span style="color:#008000;"> *        calls tcp_output each time to (possibly) send a window
</span><span style="color:#008080;">  91</span> <span style="color:#008000;"> *        update.  Here we don't have a user process, so we simulate
</span><span style="color:#008080;">  92</span> <span style="color:#008000;"> *        a user process always ready to consume all the receive buffer
</span><span style="color:#008080;">  93</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  94</span> <span style="color:#008000;"> * Notes:
</span><span style="color:#008080;">  95</span> <span style="color:#008000;"> *    wnd_, wnd_init_, cwnd_, ssthresh_ are in segment units
</span><span style="color:#008080;">  96</span> <span style="color:#008000;"> *    sequence and ack numbers are in byte units
</span><span style="color:#008080;">  97</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">  98</span> <span style="color:#008000;"> * Futures:
</span><span style="color:#008080;">  99</span> <span style="color:#008000;"> *      there are different existing TCPs with respect to how
</span><span style="color:#008080;"> 100</span> <span style="color:#008000;"> *      ack's are handled on connection startup.  Some delay
</span><span style="color:#008080;"> 101</span> <span style="color:#008000;"> *      the ack for the first segment, which can cause connections
</span><span style="color:#008080;"> 102</span> <span style="color:#008000;"> *      to take longer to start up than if we be sure to ack it quickly.
</span><span style="color:#008080;"> 103</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 104</span> <span style="color:#008000;"> *      some TCPs arrange for immediate ACK generation if the incoming segment
</span><span style="color:#008080;"> 105</span> <span style="color:#008000;"> *      contains the PUSH bit
</span><span style="color:#008080;"> 106</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 107</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 108</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 109</span> 
<span style="color:#008080;"> 110</span> <span style="color:#000000;">#ifndef lint
</span><span style="color:#008080;"> 111</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> rcsid[] =
<span style="color:#008080;"> 112</span>     <span style="color:#800000;">"</span><span style="color:#800000;">@(#) $Header: /cvsroot/nsnam/ns-2/tcp/tcp-full.cc,v 1.130 2010/03/08 05:54:54 tom_henderson Exp $ (LBL)</span><span style="color:#800000;">"</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 113</span> <span style="color:#0000ff;">#endif</span>
<span style="color:#008080;"> 114</span> 
<span style="color:#008080;"> 115</span> #include <span style="color:#800000;">"</span><span style="color:#800000;">ip.h</span><span style="color:#800000;">"</span>
<span style="color:#008080;"> 116</span> #include <span style="color:#800000;">"</span><span style="color:#800000;">tcp-full.h</span><span style="color:#800000;">"</span>
<span style="color:#008080;"> 117</span> #include <span style="color:#800000;">"</span><span style="color:#800000;">flags.h</span><span style="color:#800000;">"</span>
<span style="color:#008080;"> 118</span> #include <span style="color:#800000;">"</span><span style="color:#800000;">random.h</span><span style="color:#800000;">"</span>
<span style="color:#008080;"> 119</span> #include <span style="color:#800000;">"</span><span style="color:#800000;">template.h</span><span style="color:#800000;">"</span>
<span style="color:#008080;"> 120</span> 
<span style="color:#008080;"> 121</span> <span style="color:#000000;">#ifndef TRUE
</span><span style="color:#008080;"> 122</span> <span style="color:#0000ff;">#define</span>    TRUE     1
<span style="color:#008080;"> 123</span> <span style="color:#0000ff;">#endif</span>
<span style="color:#008080;"> 124</span> 
<span style="color:#008080;"> 125</span> <span style="color:#000000;">#ifndef FALSE
</span><span style="color:#008080;"> 126</span> <span style="color:#0000ff;">#define</span>    FALSE     0
<span style="color:#008080;"> 127</span> <span style="color:#0000ff;">#endif</span>
<span style="color:#008080;"> 128</span> 
<span style="color:#008080;"> 129</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 130</span> <span style="color:#008000;"> * Tcl Linkage for the following:
</span><span style="color:#008080;"> 131</span> <span style="color:#008000;"> *    Agent/TCP/FullTcp, Agent/TCP/FullTcp/Tahoe,
</span><span style="color:#008080;"> 132</span> <span style="color:#008000;"> *    Agent/TCP/FullTcp/Newreno, Agent/TCP/FullTcp/Sack
</span><span style="color:#008080;"> 133</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 134</span> <span style="color:#008000;"> * See tcl/lib/ns-default.tcl for init methods for
</span><span style="color:#008080;"> 135</span> <span style="color:#008000;"> *    Tahoe, Newreno, and Sack
</span><span style="color:#008080;"> 136</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 137</span> 
<span style="color:#008080;"> 138</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">class</span> FullTcpClass : <span style="color:#0000ff;">public</span><span style="color:#000000;"> TclClass { 
</span><span style="color:#008080;"> 139</span> <span style="color:#0000ff;">public</span><span style="color:#000000;">:
</span><span style="color:#008080;"> 140</span>     FullTcpClass() : TclClass(<span style="color:#800000;">"</span><span style="color:#800000;">Agent/TCP/FullTcp</span><span style="color:#800000;">"</span><span style="color:#000000;">) {}
</span><span style="color:#008080;"> 141</span>     TclObject* create(<span style="color:#0000ff;">int</span>, <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span>*<span style="color:#0000ff;">const</span>*<span style="color:#000000;">) { 
</span><span style="color:#008080;"> 142</span>         <span style="color:#0000ff;">return</span> (<span style="color:#0000ff;">new</span><span style="color:#000000;"> FullTcpAgent());
</span><span style="color:#008080;"> 143</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 144</span> <span style="color:#000000;">} class_full;
</span><span style="color:#008080;"> 145</span> 
<span style="color:#008080;"> 146</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">class</span> TahoeFullTcpClass : <span style="color:#0000ff;">public</span><span style="color:#000000;"> TclClass { 
</span><span style="color:#008080;"> 147</span> <span style="color:#0000ff;">public</span><span style="color:#000000;">:
</span><span style="color:#008080;"> 148</span>     TahoeFullTcpClass() : TclClass(<span style="color:#800000;">"</span><span style="color:#800000;">Agent/TCP/FullTcp/Tahoe</span><span style="color:#800000;">"</span><span style="color:#000000;">) {}
</span><span style="color:#008080;"> 149</span>     TclObject* create(<span style="color:#0000ff;">int</span>, <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span>*<span style="color:#0000ff;">const</span>*<span style="color:#000000;">) { 
</span><span style="color:#008080;"> 150</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> ns-default sets reno_fastrecov_ to false</span>
<span style="color:#008080;"> 151</span>         <span style="color:#0000ff;">return</span> (<span style="color:#0000ff;">new</span><span style="color:#000000;"> TahoeFullTcpAgent());
</span><span style="color:#008080;"> 152</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 153</span> <span style="color:#000000;">} class_tahoe_full;
</span><span style="color:#008080;"> 154</span> 
<span style="color:#008080;"> 155</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">class</span> NewRenoFullTcpClass : <span style="color:#0000ff;">public</span><span style="color:#000000;"> TclClass { 
</span><span style="color:#008080;"> 156</span> <span style="color:#0000ff;">public</span><span style="color:#000000;">:
</span><span style="color:#008080;"> 157</span>     NewRenoFullTcpClass() : TclClass(<span style="color:#800000;">"</span><span style="color:#800000;">Agent/TCP/FullTcp/Newreno</span><span style="color:#800000;">"</span><span style="color:#000000;">) {}
</span><span style="color:#008080;"> 158</span>     TclObject* create(<span style="color:#0000ff;">int</span>, <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span>*<span style="color:#0000ff;">const</span>*<span style="color:#000000;">) { 
</span><span style="color:#008080;"> 159</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> ns-default sets open_cwnd_on_pack_ to false</span>
<span style="color:#008080;"> 160</span>         <span style="color:#0000ff;">return</span> (<span style="color:#0000ff;">new</span><span style="color:#000000;"> NewRenoFullTcpAgent());
</span><span style="color:#008080;"> 161</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 162</span> <span style="color:#000000;">} class_newreno_full;
</span><span style="color:#008080;"> 163</span> 
<span style="color:#008080;"> 164</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">class</span> SackFullTcpClass : <span style="color:#0000ff;">public</span><span style="color:#000000;"> TclClass { 
</span><span style="color:#008080;"> 165</span> <span style="color:#0000ff;">public</span><span style="color:#000000;">:
</span><span style="color:#008080;"> 166</span>     SackFullTcpClass() : TclClass(<span style="color:#800000;">"</span><span style="color:#800000;">Agent/TCP/FullTcp/Sack</span><span style="color:#800000;">"</span><span style="color:#000000;">) {}
</span><span style="color:#008080;"> 167</span>     TclObject* create(<span style="color:#0000ff;">int</span>, <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span>*<span style="color:#0000ff;">const</span>*<span style="color:#000000;">) { 
</span><span style="color:#008080;"> 168</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> ns-default sets reno_fastrecov_ to false
</span><span style="color:#008080;"> 169</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> ns-default sets open_cwnd_on_pack_ to false</span>
<span style="color:#008080;"> 170</span>         <span style="color:#0000ff;">return</span> (<span style="color:#0000ff;">new</span><span style="color:#000000;"> SackFullTcpAgent());
</span><span style="color:#008080;"> 171</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 172</span> <span style="color:#000000;">} class_sack_full;
</span><span style="color:#008080;"> 173</span> 
<span style="color:#008080;"> 174</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 175</span> <span style="color:#008000;"> * Delayed-binding variable linkage
</span><span style="color:#008080;"> 176</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 177</span> 
<span style="color:#008080;"> 178</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 179</span> <span style="color:#000000;">FullTcpAgent::delay_bind_init_all()
</span><span style="color:#008080;"> 180</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 181</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">segsperack_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 182</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">segsize_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 183</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">tcprexmtthresh_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 184</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">iss_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 185</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">nodelay_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 186</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">data_on_syn_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 187</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">dupseg_fix_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 188</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">dupack_reset_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 189</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">close_on_empty_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 190</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">signal_on_empty_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 191</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">interval_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 192</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">ts_option_size_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 193</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">reno_fastrecov_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 194</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">pipectrl_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 195</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">open_cwnd_on_pack_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 196</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">halfclose_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 197</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">nopredict_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 198</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">ecn_syn_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 199</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">ecn_syn_wait_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 200</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">debug_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 201</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">spa_thresh_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 202</span> 
<span style="color:#008080;"> 203</span> <span style="color:#000000;">    TcpAgent::delay_bind_init_all();
</span><span style="color:#008080;"> 204</span>        
<span style="color:#008080;"> 205</span> <span style="color:#000000;">          reset();
</span><span style="color:#008080;"> 206</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 207</span> 
<span style="color:#008080;"> 208</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 209</span> FullTcpAgent::delay_bind_dispatch(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *varName, <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *localName, TclObject *<span style="color:#000000;">tracer)
</span><span style="color:#008080;"> 210</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 211</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">segsperack_</span><span style="color:#800000;">"</span>, &amp;segs_per_ack_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 212</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">segsize_</span><span style="color:#800000;">"</span>, &amp;maxseg_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 213</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">tcprexmtthresh_</span><span style="color:#800000;">"</span>, &amp;tcprexmtthresh_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 214</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">iss_</span><span style="color:#800000;">"</span>, &amp;iss_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 215</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">spa_thresh_</span><span style="color:#800000;">"</span>, &amp;spa_thresh_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 216</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">nodelay_</span><span style="color:#800000;">"</span>, &amp;nodelay_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 217</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">data_on_syn_</span><span style="color:#800000;">"</span>, &amp;data_on_syn_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 218</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">dupseg_fix_</span><span style="color:#800000;">"</span>, &amp;dupseg_fix_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 219</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">dupack_reset_</span><span style="color:#800000;">"</span>, &amp;dupack_reset_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 220</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">close_on_empty_</span><span style="color:#800000;">"</span>, &amp;close_on_empty_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 221</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">signal_on_empty_</span><span style="color:#800000;">"</span>, &amp;signal_on_empty_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 222</span>         <span style="color:#0000ff;">if</span> (delay_bind_time(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">interval_</span><span style="color:#800000;">"</span>, &amp;delack_interval_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 223</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">ts_option_size_</span><span style="color:#800000;">"</span>, &amp;ts_option_size_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 224</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">reno_fastrecov_</span><span style="color:#800000;">"</span>, &amp;reno_fastrecov_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 225</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">pipectrl_</span><span style="color:#800000;">"</span>, &amp;pipectrl_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 226</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">open_cwnd_on_pack_</span><span style="color:#800000;">"</span>, &amp;open_cwnd_on_pack_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 227</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">halfclose_</span><span style="color:#800000;">"</span>, &amp;halfclose_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 228</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">nopredict_</span><span style="color:#800000;">"</span>, &amp;nopredict_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 229</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">ecn_syn_</span><span style="color:#800000;">"</span>, &amp;ecn_syn_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 230</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">ecn_syn_wait_</span><span style="color:#800000;">"</span>, &amp;ecn_syn_wait_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 231</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">debug_</span><span style="color:#800000;">"</span>, &amp;debug_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 232</span> 
<span style="color:#008080;"> 233</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;"> TcpAgent::delay_bind_dispatch(varName, localName, tracer);
</span><span style="color:#008080;"> 234</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 235</span> 
<span style="color:#008080;"> 236</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 237</span> <span style="color:#000000;">SackFullTcpAgent::delay_bind_init_all()
</span><span style="color:#008080;"> 238</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 239</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">clear_on_timeout_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 240</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">sack_rtx_cthresh_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 241</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">sack_rtx_bthresh_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 242</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">sack_block_size_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 243</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">sack_option_size_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 244</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">max_sack_blocks_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 245</span>         delay_bind_init_one(<span style="color:#800000;">"</span><span style="color:#800000;">sack_rtx_threshmode_</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 246</span> <span style="color:#000000;">    FullTcpAgent::delay_bind_init_all();
</span><span style="color:#008080;"> 247</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 248</span> 
<span style="color:#008080;"> 249</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 250</span> SackFullTcpAgent::delay_bind_dispatch(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *varName, <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *localName, TclObject *<span style="color:#000000;">tracer)
</span><span style="color:#008080;"> 251</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 252</span>         <span style="color:#0000ff;">if</span> (delay_bind_bool(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">clear_on_timeout_</span><span style="color:#800000;">"</span>, &amp;clear_on_timeout_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 253</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">sack_rtx_cthresh_</span><span style="color:#800000;">"</span>, &amp;sack_rtx_cthresh_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 254</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">sack_rtx_bthresh_</span><span style="color:#800000;">"</span>, &amp;sack_rtx_bthresh_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 255</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">sack_rtx_threshmode_</span><span style="color:#800000;">"</span>, &amp;sack_rtx_threshmode_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 256</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">sack_block_size_</span><span style="color:#800000;">"</span>, &amp;sack_block_size_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 257</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">sack_option_size_</span><span style="color:#800000;">"</span>, &amp;sack_option_size_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 258</span>         <span style="color:#0000ff;">if</span> (delay_bind(varName, localName, <span style="color:#800000;">"</span><span style="color:#800000;">max_sack_blocks_</span><span style="color:#800000;">"</span>, &amp;max_sack_blocks_, tracer)) <span style="color:#0000ff;">return</span><span style="color:#000000;"> TCL_OK;
</span><span style="color:#008080;"> 259</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;"> FullTcpAgent::delay_bind_dispatch(varName, localName, tracer);
</span><span style="color:#008080;"> 260</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 261</span> 
<span style="color:#008080;"> 262</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 263</span> FullTcpAgent::command(<span style="color:#0000ff;">int</span> argc, <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span>*<span style="color:#0000ff;">const</span>*<span style="color:#000000;"> argv)
</span><span style="color:#008080;"> 264</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 265</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> would like to have some "connect" primitive
</span><span style="color:#008080;"> 266</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> here, but the problem is that we get called before
</span><span style="color:#008080;"> 267</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> the simulation is running and we want to send a SYN.
</span><span style="color:#008080;"> 268</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> Because no routing exists yet, this fails.
</span><span style="color:#008080;"> 269</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> Instead, see code in advance().
</span><span style="color:#008080;"> 270</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;"> 271</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> listen can happen any time because it just changes state_
</span><span style="color:#008080;"> 272</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;"> 273</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> close is designed to happen at some point after the
</span><span style="color:#008080;"> 274</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> simulation is running (using an ns 'at' command)</span>
<span style="color:#008080;"> 275</span> 
<span style="color:#008080;"> 276</span>     <span style="color:#0000ff;">if</span> (argc == <span style="color:#800080;">2</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 277</span>         <span style="color:#0000ff;">if</span> (strcmp(argv[<span style="color:#800080;">1</span>], <span style="color:#800000;">"</span><span style="color:#800000;">listen</span><span style="color:#800000;">"</span>) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 278</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> just a state transition</span>
<span style="color:#008080;"> 279</span> <span style="color:#000000;">            listen();
</span><span style="color:#008080;"> 280</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;"> (TCL_OK);
</span><span style="color:#008080;"> 281</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 282</span>         <span style="color:#0000ff;">if</span> (strcmp(argv[<span style="color:#800080;">1</span>], <span style="color:#800000;">"</span><span style="color:#800000;">close</span><span style="color:#800000;">"</span>) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 283</span> <span style="color:#000000;">            usrclosed();
</span><span style="color:#008080;"> 284</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;"> (TCL_OK);
</span><span style="color:#008080;"> 285</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 286</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 287</span>     <span style="color:#0000ff;">if</span> (argc == <span style="color:#800080;">3</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 288</span>         <span style="color:#0000ff;">if</span> (strcmp(argv[<span style="color:#800080;">1</span>], <span style="color:#800000;">"</span><span style="color:#800000;">advance</span><span style="color:#800000;">"</span>) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 289</span>             advanceby(atoi(argv[<span style="color:#800080;">2</span><span style="color:#000000;">]));
</span><span style="color:#008080;"> 290</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;"> (TCL_OK);
</span><span style="color:#008080;"> 291</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 292</span>         <span style="color:#0000ff;">if</span> (strcmp(argv[<span style="color:#800080;">1</span>], <span style="color:#800000;">"</span><span style="color:#800000;">advanceby</span><span style="color:#800000;">"</span>) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 293</span>             advanceby(atoi(argv[<span style="color:#800080;">2</span><span style="color:#000000;">]));
</span><span style="color:#008080;"> 294</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;"> (TCL_OK);
</span><span style="color:#008080;"> 295</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 296</span>         <span style="color:#0000ff;">if</span> (strcmp(argv[<span style="color:#800080;">1</span>], <span style="color:#800000;">"</span><span style="color:#800000;">advance-bytes</span><span style="color:#800000;">"</span>) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 297</span>             advance_bytes(atoi(argv[<span style="color:#800080;">2</span><span style="color:#000000;">]));
</span><span style="color:#008080;"> 298</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;"> (TCL_OK);
</span><span style="color:#008080;"> 299</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 300</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 301</span>     <span style="color:#0000ff;">if</span> (argc == <span style="color:#800080;">4</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 302</span>         <span style="color:#0000ff;">if</span> (strcmp(argv[<span style="color:#800080;">1</span>], <span style="color:#800000;">"</span><span style="color:#800000;">sendmsg</span><span style="color:#800000;">"</span>) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 303</span>             sendmsg(atoi(argv[<span style="color:#800080;">2</span>]), argv[<span style="color:#800080;">3</span><span style="color:#000000;">]);
</span><span style="color:#008080;"> 304</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;"> (TCL_OK);
</span><span style="color:#008080;"> 305</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 306</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 307</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (TcpAgent::command(argc, argv));
</span><span style="color:#008080;"> 308</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 309</span> 
<span style="color:#008080;"> 310</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 311</span> <span style="color:#008000;"> * "User Interface" Functions for Full TCP
</span><span style="color:#008080;"> 312</span> <span style="color:#008000;"> *    advanceby(number of packets)
</span><span style="color:#008080;"> 313</span> <span style="color:#008000;"> *    advance_bytes(number of bytes)
</span><span style="color:#008080;"> 314</span> <span style="color:#008000;"> *    sendmsg(int bytes, char* buf)
</span><span style="color:#008080;"> 315</span> <span style="color:#008000;"> *    listen
</span><span style="color:#008080;"> 316</span> <span style="color:#008000;"> *    close
</span><span style="color:#008080;"> 317</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 318</span> 
<span style="color:#008080;"> 319</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 320</span> <span style="color:#008000;"> * the 'advance' interface to the regular tcp is in packet
</span><span style="color:#008080;"> 321</span> <span style="color:#008000;"> * units.  Here we scale this to bytes for full tcp.
</span><span style="color:#008080;"> 322</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 323</span> <span style="color:#008000;"> * 'advance' is normally called by an "application" (i.e. data source)
</span><span style="color:#008080;"> 324</span> <span style="color:#008000;"> * to signal that there is something to send
</span><span style="color:#008080;"> 325</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 326</span> <span style="color:#008000;"> * 'curseq_' is the sequence number of the last byte provided
</span><span style="color:#008080;"> 327</span> <span style="color:#008000;"> * by the application.  In the case where no data has been supplied
</span><span style="color:#008080;"> 328</span> <span style="color:#008000;"> * by the application, curseq_ is the iss_.
</span><span style="color:#008080;"> 329</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 330</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 331</span> FullTcpAgent::advanceby(<span style="color:#0000ff;">int</span><span style="color:#000000;"> np)
</span><span style="color:#008080;"> 332</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 333</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> XXX hack:
</span><span style="color:#008080;"> 334</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    because np is in packets and a data source
</span><span style="color:#008080;"> 335</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    may pass a *huge* number as a way to tell us
</span><span style="color:#008080;"> 336</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    to go forever, just look for the huge number
</span><span style="color:#008080;"> 337</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    and if it's there, pre-divide it</span>
<span style="color:#008080;"> 338</span>     <span style="color:#0000ff;">if</span> (np &gt;= <span style="color:#800080;">0x10000000</span><span style="color:#000000;">)
</span><span style="color:#008080;"> 339</span>         np /=<span style="color:#000000;"> maxseg_;
</span><span style="color:#008080;"> 340</span> 
<span style="color:#008080;"> 341</span>     advance_bytes(np *<span style="color:#000000;"> maxseg_);
</span><span style="color:#008080;"> 342</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 343</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 344</span> 
<span style="color:#008080;"> 345</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 346</span> <span style="color:#008000;"> * the byte-oriented interface: advance_bytes(int nbytes)
</span><span style="color:#008080;"> 347</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 348</span> 
<span style="color:#008080;"> 349</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 350</span> FullTcpAgent::advance_bytes(<span style="color:#0000ff;">int</span><span style="color:#000000;"> nb)
</span><span style="color:#008080;"> 351</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 352</span> 
<span style="color:#008080;"> 353</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;"> 354</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> state-specific operations:
</span><span style="color:#008080;"> 355</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    if CLOSED or LISTEN, reset and try a new active open/connect
</span><span style="color:#008080;"> 356</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    if ESTABLISHED, queue and try to send more
</span><span style="color:#008080;"> 357</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    if SYN_SENT or SYN_RCVD, just queue
</span><span style="color:#008080;"> 358</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    if above ESTABLISHED, we are closing, so don't allow
</span><span style="color:#008080;"> 359</span>     <span style="color:#008000;">//
</span><span style="color:#008080;"> 360</span> 
<span style="color:#008080;"> 361</span>     <span style="color:#0000ff;">switch</span><span style="color:#000000;"> (state_) {
</span><span style="color:#008080;"> 362</span> 
<span style="color:#008080;"> 363</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_CLOSED:
</span><span style="color:#008080;"> 364</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_LISTEN:
</span><span style="color:#008080;"> 365</span> <span style="color:#000000;">                reset();
</span><span style="color:#008080;"> 366</span>                 curseq_ = iss_ +<span style="color:#000000;"> nb;
</span><span style="color:#008080;"> 367</span>                 connect();              <span style="color:#008000;">//</span><span style="color:#008000;"> initiate new connection</span>
<span style="color:#008080;"> 368</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 369</span> 
<span style="color:#008080;"> 370</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_ESTABLISHED:
</span><span style="color:#008080;"> 371</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_SYN_SENT:
</span><span style="color:#008080;"> 372</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_SYN_RECEIVED:
</span><span style="color:#008080;"> 373</span>                 <span style="color:#0000ff;">if</span> (curseq_ &lt;<span style="color:#000000;"> iss_) 
</span><span style="color:#008080;"> 374</span>                         curseq_ =<span style="color:#000000;"> iss_; 
</span><span style="color:#008080;"> 375</span>                 curseq_ +=<span style="color:#000000;"> nb;
</span><span style="color:#008080;"> 376</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 377</span> 
<span style="color:#008080;"> 378</span>     <span style="color:#0000ff;">default</span><span style="color:#000000;">:
</span><span style="color:#008080;"> 379</span>             <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) 
</span><span style="color:#008080;"> 380</span>                 fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent::advance(%s): cannot advance while in state %s\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 381</span> <span style="color:#000000;">                 now(), name(), statestr(state_));
</span><span style="color:#008080;"> 382</span> 
<span style="color:#008080;"> 383</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 384</span> 
<span style="color:#008080;"> 385</span>     <span style="color:#0000ff;">if</span> (state_ ==<span style="color:#000000;"> TCPS_ESTABLISHED)
</span><span style="color:#008080;"> 386</span>         send_much(<span style="color:#800080;">0</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;"> 387</span> 
<span style="color:#008080;"> 388</span>       <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 389</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 390</span> 
<span style="color:#008080;"> 391</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 392</span> <span style="color:#008000;"> * If MSG_EOF is set, by setting close_on_empty_ to TRUE, we ensure that
</span><span style="color:#008080;"> 393</span> <span style="color:#008000;"> * a FIN will be sent when the send buffer emptys.
</span><span style="color:#008080;"> 394</span> <span style="color:#008000;"> * If DAT_EOF is set, the callback function done_data is called
</span><span style="color:#008080;"> 395</span> <span style="color:#008000;"> * when the send buffer empty
</span><span style="color:#008080;"> 396</span> <span style="color:#008000;"> * 
</span><span style="color:#008080;"> 397</span> <span style="color:#008000;"> * When (in the future?) FullTcpAgent implements T/TCP, avoidance of 3-way 
</span><span style="color:#008080;"> 398</span> <span style="color:#008000;"> * handshake can be handled in this function.
</span><span style="color:#008080;"> 399</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 400</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 401</span> FullTcpAgent::sendmsg(<span style="color:#0000ff;">int</span> nbytes, <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">flags)
</span><span style="color:#008080;"> 402</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 403</span>     <span style="color:#0000ff;">if</span> (flags &amp;&amp; strcmp(flags, <span style="color:#800000;">"</span><span style="color:#800000;">MSG_EOF</span><span style="color:#800000;">"</span>) == <span style="color:#800080;">0</span><span style="color:#000000;">) 
</span><span style="color:#008080;"> 404</span>         close_on_empty_ =<span style="color:#000000;"> TRUE;    
</span><span style="color:#008080;"> 405</span>     <span style="color:#0000ff;">if</span> (flags &amp;&amp; strcmp(flags, <span style="color:#800000;">"</span><span style="color:#800000;">DAT_EOF</span><span style="color:#800000;">"</span>) == <span style="color:#800080;">0</span><span style="color:#000000;">) 
</span><span style="color:#008080;"> 406</span>         signal_on_empty_ =<span style="color:#000000;"> TRUE;    
</span><span style="color:#008080;"> 407</span> 
<span style="color:#008080;"> 408</span>     <span style="color:#0000ff;">if</span> (nbytes == -<span style="color:#800080;">1</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 409</span>         infinite_send_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;"> 410</span>         advance_bytes(<span style="color:#800080;">0</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 411</span>     } <span style="color:#0000ff;">else</span>
<span style="color:#008080;"> 412</span> <span style="color:#000000;">        advance_bytes(nbytes);
</span><span style="color:#008080;"> 413</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 414</span> 
<span style="color:#008080;"> 415</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 416</span> <span style="color:#008000;"> * do an active open
</span><span style="color:#008080;"> 417</span> <span style="color:#008000;"> * (in real TCP, see tcp_usrreq, case PRU_CONNECT)
</span><span style="color:#008080;"> 418</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 419</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 420</span> <span style="color:#000000;">FullTcpAgent::connect()
</span><span style="color:#008080;"> 421</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 422</span>     newstate(TCPS_SYN_SENT);    <span style="color:#008000;">//</span><span style="color:#008000;"> sending a SYN now</span>
<span style="color:#008080;"> 423</span> <span style="color:#000000;">    sent(iss_, foutput(iss_, REASON_NORMAL));
</span><span style="color:#008080;"> 424</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 425</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 426</span> 
<span style="color:#008080;"> 427</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 428</span> <span style="color:#008000;"> * be a passive opener
</span><span style="color:#008080;"> 429</span> <span style="color:#008000;"> * (in real TCP, see tcp_usrreq, case PRU_LISTEN)
</span><span style="color:#008080;"> 430</span> <span style="color:#008000;"> * (for simulation, make this peer's ptype ACKs)
</span><span style="color:#008080;"> 431</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 432</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 433</span> <span style="color:#000000;">FullTcpAgent::listen()
</span><span style="color:#008080;"> 434</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 435</span> <span style="color:#000000;">    newstate(TCPS_LISTEN);
</span><span style="color:#008080;"> 436</span>     type_ = PT_ACK;    <span style="color:#008000;">//</span><span style="color:#008000;"> instead of PT_TCP</span>
<span style="color:#008080;"> 437</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 438</span> 
<span style="color:#008080;"> 439</span> 
<span style="color:#008080;"> 440</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 441</span> <span style="color:#008000;">* This function is invoked when the sender buffer is empty. It in turn
</span><span style="color:#008080;"> 442</span> <span style="color:#008000;">* invokes the Tcl done_data procedure that was registered with TCP.
</span><span style="color:#008080;"> 443</span> <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 444</span>  
<span style="color:#008080;"> 445</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 446</span> <span style="color:#000000;">FullTcpAgent::bufferempty()
</span><span style="color:#008080;"> 447</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 448</span>        signal_on_empty_=<span style="color:#000000;">FALSE;
</span><span style="color:#008080;"> 449</span>     Tcl::instance().evalf(<span style="color:#800000;">"</span><span style="color:#800000;">%s done_data</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>-&gt;<span style="color:#000000;">name());
</span><span style="color:#008080;"> 450</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 451</span> 
<span style="color:#008080;"> 452</span> 
<span style="color:#008080;"> 453</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 454</span> <span style="color:#008000;"> * called when user/application performs 'close'
</span><span style="color:#008080;"> 455</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 456</span> 
<span style="color:#008080;"> 457</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 458</span> <span style="color:#000000;">FullTcpAgent::usrclosed()
</span><span style="color:#008080;"> 459</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 460</span>     curseq_ = maxseq_ - <span style="color:#800080;">1</span>;    <span style="color:#008000;">//</span><span style="color:#008000;"> now, no more data</span>
<span style="color:#008080;"> 461</span>     infinite_send_ = FALSE;    <span style="color:#008000;">//</span><span style="color:#008000;"> stop infinite send</span>
<span style="color:#008080;"> 462</span> 
<span style="color:#008080;"> 463</span>     <span style="color:#0000ff;">switch</span><span style="color:#000000;"> (state_) {
</span><span style="color:#008080;"> 464</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_CLOSED:
</span><span style="color:#008080;"> 465</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_LISTEN:
</span><span style="color:#008080;"> 466</span> <span style="color:#000000;">        cancel_timers();
</span><span style="color:#008080;"> 467</span> <span style="color:#000000;">        newstate(TCPS_CLOSED);
</span><span style="color:#008080;"> 468</span> <span style="color:#000000;">        finish();
</span><span style="color:#008080;"> 469</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 470</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_SYN_SENT:
</span><span style="color:#008080;"> 471</span> <span style="color:#000000;">        newstate(TCPS_CLOSED);
</span><span style="color:#008080;"> 472</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> fall through </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 473</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_LAST_ACK:
</span><span style="color:#008080;"> 474</span>         flags_ |=<span style="color:#000000;"> TF_NEEDFIN;
</span><span style="color:#008080;"> 475</span>         send_much(<span style="color:#800080;">1</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;"> 476</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 477</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_SYN_RECEIVED:
</span><span style="color:#008080;"> 478</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_ESTABLISHED:
</span><span style="color:#008080;"> 479</span> <span style="color:#000000;">        newstate(TCPS_FIN_WAIT_1);
</span><span style="color:#008080;"> 480</span>         flags_ |=<span style="color:#000000;"> TF_NEEDFIN;
</span><span style="color:#008080;"> 481</span>         send_much(<span style="color:#800080;">1</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;"> 482</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 483</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_CLOSE_WAIT:
</span><span style="color:#008080;"> 484</span> <span style="color:#000000;">        newstate(TCPS_LAST_ACK);
</span><span style="color:#008080;"> 485</span>         flags_ |=<span style="color:#000000;"> TF_NEEDFIN;
</span><span style="color:#008080;"> 486</span>         send_much(<span style="color:#800080;">1</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;"> 487</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 488</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_FIN_WAIT_1:
</span><span style="color:#008080;"> 489</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_FIN_WAIT_2:
</span><span style="color:#008080;"> 490</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_CLOSING:
</span><span style="color:#008080;"> 491</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> usr asked for a close more than once [?] </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 492</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_)
</span><span style="color:#008080;"> 493</span> <span style="color:#000000;">                 fprintf(stderr,
</span><span style="color:#008080;"> 494</span>                    <span style="color:#800000;">"</span><span style="color:#800000;">%f FullTcpAgent(%s): app close in bad state %s\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 495</span> <span style="color:#000000;">                   now(), name(), statestr(state_));
</span><span style="color:#008080;"> 496</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 497</span>     <span style="color:#0000ff;">default</span><span style="color:#000000;">:
</span><span style="color:#008080;"> 498</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_)
</span><span style="color:#008080;"> 499</span> <span style="color:#000000;">                fprintf(stderr,
</span><span style="color:#008080;"> 500</span>                 <span style="color:#800000;">"</span><span style="color:#800000;">%f FullTcpAgent(%s): app close in unknown state %s\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 501</span> <span style="color:#000000;">                now(), name(), statestr(state_));
</span><span style="color:#008080;"> 502</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 503</span> 
<span style="color:#008080;"> 504</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 505</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 506</span> 
<span style="color:#008080;"> 507</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 508</span> <span style="color:#008000;"> * Utility type functions
</span><span style="color:#008080;"> 509</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 510</span> 
<span style="color:#008080;"> 511</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 512</span> <span style="color:#000000;">FullTcpAgent::cancel_timers()
</span><span style="color:#008080;"> 513</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 514</span> 
<span style="color:#008080;"> 515</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> cancel: rtx, burstsend, delsnd</span>
<span style="color:#008080;"> 516</span> <span style="color:#000000;">    TcpAgent::cancel_timers();      
</span><span style="color:#008080;"> 517</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> cancel: delack</span>
<span style="color:#008080;"> 518</span> <span style="color:#000000;">    delack_timer_.force_cancel();
</span><span style="color:#008080;"> 519</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 520</span> 
<span style="color:#008080;"> 521</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 522</span> FullTcpAgent::newstate(<span style="color:#0000ff;">int</span><span style="color:#000000;"> state)
</span><span style="color:#008080;"> 523</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 524</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f(%s): state changed from %s to %s\n",
</span><span style="color:#008080;"> 525</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), name(), statestr(state_), statestr(state));</span>
<span style="color:#008080;"> 526</span> 
<span style="color:#008080;"> 527</span>     state_ =<span style="color:#000000;"> state;
</span><span style="color:#008080;"> 528</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 529</span> 
<span style="color:#008080;"> 530</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 531</span> FullTcpAgent::prpkt(Packet *<span style="color:#000000;">pkt)
</span><span style="color:#008080;"> 532</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 533</span>     hdr_tcp *tcph = hdr_tcp::access(pkt);    <span style="color:#008000;">//</span><span style="color:#008000;"> TCP header</span>
<span style="color:#008080;"> 534</span>     hdr_cmn *th = hdr_cmn::access(pkt);    <span style="color:#008000;">//</span><span style="color:#008000;"> common header (size, etc)
</span><span style="color:#008080;"> 535</span>     <span style="color:#008000;">//</span><span style="color:#008000;">hdr_flags *fh = hdr_flags::access(pkt);    </span><span style="color:#008000;">//</span><span style="color:#008000;"> flags (CWR, CE, bits)</span>
<span style="color:#008080;"> 536</span>     hdr_ip* iph =<span style="color:#000000;"> hdr_ip::access(pkt);
</span><span style="color:#008080;"> 537</span>     <span style="color:#0000ff;">int</span> datalen = th-&gt;size() - tcph-&gt;hlen(); <span style="color:#008000;">//</span><span style="color:#008000;"> # payload bytes</span>
<span style="color:#008080;"> 538</span> 
<span style="color:#008080;"> 539</span>     fprintf(stdout, <span style="color:#800000;">"</span><span style="color:#800000;"> [%d:%d.%d&gt;%d.%d] (hlen:%d, dlen:%d, seq:%d, ack:%d, flags:0x%x (%s), salen:%d, reason:0x%x)\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 540</span>         th-&gt;<span style="color:#000000;">uid(),
</span><span style="color:#008080;"> 541</span>         iph-&gt;saddr(), iph-&gt;<span style="color:#000000;">sport(),
</span><span style="color:#008080;"> 542</span>         iph-&gt;daddr(), iph-&gt;<span style="color:#000000;">dport(),
</span><span style="color:#008080;"> 543</span>         tcph-&gt;<span style="color:#000000;">hlen(),
</span><span style="color:#008080;"> 544</span> <span style="color:#000000;">        datalen,
</span><span style="color:#008080;"> 545</span>         tcph-&gt;<span style="color:#000000;">seqno(),
</span><span style="color:#008080;"> 546</span>         tcph-&gt;<span style="color:#000000;">ackno(),
</span><span style="color:#008080;"> 547</span>         tcph-&gt;flags(), flagstr(tcph-&gt;<span style="color:#000000;">flags()),
</span><span style="color:#008080;"> 548</span>         tcph-&gt;<span style="color:#000000;">sa_length(),
</span><span style="color:#008080;"> 549</span>         tcph-&gt;<span style="color:#000000;">reason());
</span><span style="color:#008080;"> 550</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 551</span> 
<span style="color:#008080;"> 552</span> <span style="color:#0000ff;">char</span> *
<span style="color:#008080;"> 553</span> FullTcpAgent::flagstr(<span style="color:#0000ff;">int</span><span style="color:#000000;"> hflags)
</span><span style="color:#008080;"> 554</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 555</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> update this if tcp header flags change</span>
<span style="color:#008080;"> 556</span>     <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">char</span> *flagstrs[<span style="color:#800080;">28</span>] =<span style="color:#000000;"> {
</span><span style="color:#008080;"> 557</span>         <span style="color:#800000;">"</span><span style="color:#800000;">&lt;null&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;SYN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;SYN,FIN&gt;</span><span style="color:#800000;">"</span>,    <span style="color:#008000;">//</span><span style="color:#008000;"> 0-3</span>
<span style="color:#008080;"> 558</span>         <span style="color:#800000;">"</span><span style="color:#800000;">&lt;?&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;?,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;?,SYN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;?,SYN,FIN&gt;</span><span style="color:#800000;">"</span>,    <span style="color:#008000;">//</span><span style="color:#008000;"> 4-7</span>
<span style="color:#008080;"> 559</span>         <span style="color:#800000;">"</span><span style="color:#800000;">&lt;PSH&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;PSH,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;PSH,SYN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;PSH,SYN,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#008000;">//</span><span style="color:#008000;"> 0x08-0x0b</span>
<span style="color:#008080;"> 560</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> do not use &lt;??, in next line because that's an ANSI trigraph </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 561</span>         <span style="color:#800000;">"</span><span style="color:#800000;">&lt;?&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;?,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;?,SYN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;?,SYN,FIN&gt;</span><span style="color:#800000;">"</span>,        <span style="color:#008000;">//</span><span style="color:#008000;"> 0x0c-0x0f</span>
<span style="color:#008080;"> 562</span>         <span style="color:#800000;">"</span><span style="color:#800000;">&lt;ACK&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;ACK,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;ACK,SYN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;ACK,SYN,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#008000;">//</span><span style="color:#008000;"> 0x10-0x13</span>
<span style="color:#008080;"> 563</span>         <span style="color:#800000;">"</span><span style="color:#800000;">&lt;ACK&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;ACK,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;ACK,SYN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;ACK,SYN,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#008000;">//</span><span style="color:#008000;"> 0x14-0x17</span>
<span style="color:#008080;"> 564</span>         <span style="color:#800000;">"</span><span style="color:#800000;">&lt;PSH,ACK&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;PSH,ACK,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;PSH,ACK,SYN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">&lt;PSH,ACK,SYN,FIN&gt;</span><span style="color:#800000;">"</span>, <span style="color:#008000;">//</span><span style="color:#008000;"> 0x18-0x1b</span>
<span style="color:#008080;"> 565</span> <span style="color:#000000;">    };
</span><span style="color:#008080;"> 566</span>     <span style="color:#0000ff;">if</span> (hflags &lt; <span style="color:#800080;">0</span> || (hflags &gt; <span style="color:#800080;">28</span><span style="color:#000000;">)) {
</span><span style="color:#008080;"> 567</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> Added strings for CWR and ECE  -M. Weigle 6/27/02 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 568</span>         <span style="color:#0000ff;">if</span> (hflags == <span style="color:#800080;">72</span><span style="color:#000000;">) 
</span><span style="color:#008080;"> 569</span>              <span style="color:#0000ff;">return</span> (<span style="color:#800000;">"</span><span style="color:#800000;">&lt;ECE,PSH&gt;</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 570</span>          <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (hflags == <span style="color:#800080;">80</span><span style="color:#000000;">)
</span><span style="color:#008080;"> 571</span>              <span style="color:#0000ff;">return</span> (<span style="color:#800000;">"</span><span style="color:#800000;">&lt;ECE,ACK&gt;</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 572</span>          <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (hflags == <span style="color:#800080;">88</span><span style="color:#000000;">) 
</span><span style="color:#008080;"> 573</span>              <span style="color:#0000ff;">return</span> (<span style="color:#800000;">"</span><span style="color:#800000;">&lt;ECE,PSH,ACK&gt;</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 574</span>          <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (hflags == <span style="color:#800080;">152</span><span style="color:#000000;">) 
</span><span style="color:#008080;"> 575</span>              <span style="color:#0000ff;">return</span> (<span style="color:#800000;">"</span><span style="color:#800000;">&lt;CWR,PSH,ACK&gt;</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 576</span>         <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (hflags == <span style="color:#800080;">153</span><span style="color:#000000;">)
</span><span style="color:#008080;"> 577</span>             <span style="color:#0000ff;">return</span> (<span style="color:#800000;">"</span><span style="color:#800000;">&lt;CWR,PSH,ACK,FIN&gt;</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 578</span>         <span style="color:#0000ff;">else</span>
<span style="color:#008080;"> 579</span>             <span style="color:#0000ff;">return</span> (<span style="color:#800000;">"</span><span style="color:#800000;">&lt;invalid&gt;</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 580</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 581</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (flagstrs[hflags]);
</span><span style="color:#008080;"> 582</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 583</span> 
<span style="color:#008080;"> 584</span> <span style="color:#0000ff;">char</span> *
<span style="color:#008080;"> 585</span> FullTcpAgent::statestr(<span style="color:#0000ff;">int</span><span style="color:#000000;"> state)
</span><span style="color:#008080;"> 586</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 587</span>     <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">char</span> *statestrs[TCP_NSTATES] =<span style="color:#000000;"> {
</span><span style="color:#008080;"> 588</span>         <span style="color:#800000;">"</span><span style="color:#800000;">CLOSED</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">LISTEN</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">SYN_SENT</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">SYN_RCVD</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 589</span>         <span style="color:#800000;">"</span><span style="color:#800000;">ESTABLISHED</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">CLOSE_WAIT</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">FIN_WAIT_1</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">CLOSING</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 590</span>         <span style="color:#800000;">"</span><span style="color:#800000;">LAST_ACK</span><span style="color:#800000;">"</span>, <span style="color:#800000;">"</span><span style="color:#800000;">FIN_WAIT_2</span><span style="color:#800000;">"</span>
<span style="color:#008080;"> 591</span> <span style="color:#000000;">    };
</span><span style="color:#008080;"> 592</span>     <span style="color:#0000ff;">if</span> (state &lt; <span style="color:#800080;">0</span> || (state &gt;=<span style="color:#000000;"> TCP_NSTATES))
</span><span style="color:#008080;"> 593</span>         <span style="color:#0000ff;">return</span> (<span style="color:#800000;">"</span><span style="color:#800000;">INVALID</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 594</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (statestrs[state]);
</span><span style="color:#008080;"> 595</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 596</span> 
<span style="color:#008080;"> 597</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 598</span> DelAckTimer::expire(Event *<span style="color:#000000;">) {
</span><span style="color:#008080;"> 599</span>         a_-&gt;<span style="color:#000000;">timeout(TCP_TIMER_DELACK);
</span><span style="color:#008080;"> 600</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 601</span> 
<span style="color:#008080;"> 602</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 603</span> <span style="color:#008000;"> * reset to starting point, don't set state_ here,
</span><span style="color:#008080;"> 604</span> <span style="color:#008000;"> * because our starting point might be LISTEN rather
</span><span style="color:#008080;"> 605</span> <span style="color:#008000;"> * than CLOSED if we're a passive opener
</span><span style="color:#008080;"> 606</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 607</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 608</span> <span style="color:#000000;">FullTcpAgent::reset()
</span><span style="color:#008080;"> 609</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 610</span>     cancel_timers();    <span style="color:#008000;">//</span><span style="color:#008000;"> cancel timers first</span>
<span style="color:#008080;"> 611</span>           TcpAgent::reset();    <span style="color:#008000;">//</span><span style="color:#008000;"> resets most variables</span>
<span style="color:#008080;"> 612</span>     rq_.clear();        <span style="color:#008000;">//</span><span style="color:#008000;"> clear reassembly queue</span>
<span style="color:#008080;"> 613</span>     rtt_init();        <span style="color:#008000;">//</span><span style="color:#008000;"> zero rtt, srtt, backoff</span>
<span style="color:#008080;"> 614</span> 
<span style="color:#008080;"> 615</span>     last_ack_sent_ = -<span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 616</span>     rcv_nxt_ = -<span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 617</span>     pipe_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 618</span>     rtxbytes_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 619</span>     flags_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 620</span>     t_seqno_ =<span style="color:#000000;"> iss_;
</span><span style="color:#008080;"> 621</span>     maxseq_ = -<span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 622</span>     irs_ = -<span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 623</span>     last_send_time_ = -<span style="color:#800080;">1.0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 624</span>     <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ts_option_)
</span><span style="color:#008080;"> 625</span>         recent_ = recent_age_ = <span style="color:#800080;">0.0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 626</span>     <span style="color:#0000ff;">else</span>
<span style="color:#008080;"> 627</span>         recent_ = recent_age_ = -<span style="color:#800080;">1.0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 628</span> 
<span style="color:#008080;"> 629</span>     fastrecov_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;"> 630</span> 
<span style="color:#008080;"> 631</span>     closed_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 632</span>     close_on_empty_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;"> 633</span> 
<span style="color:#008080;"> 634</span>         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ecn_syn_)
</span><span style="color:#008080;"> 635</span>                 ecn_syn_next_ = <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 636</span>         <span style="color:#0000ff;">else</span>
<span style="color:#008080;"> 637</span>                 ecn_syn_next_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 638</span> 
<span style="color:#008080;"> 639</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 640</span> 
<span style="color:#008080;"> 641</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 642</span> <span style="color:#008000;"> * This function is invoked when the connection is done. It in turn
</span><span style="color:#008080;"> 643</span> <span style="color:#008000;"> * invokes the Tcl finish procedure that was registered with TCP.
</span><span style="color:#008080;"> 644</span> <span style="color:#008000;"> * This function mimics tcp_close()
</span><span style="color:#008080;"> 645</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 646</span> 
<span style="color:#008080;"> 647</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 648</span> <span style="color:#000000;">FullTcpAgent::finish()
</span><span style="color:#008080;"> 649</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 650</span>     Tcl::instance().evalf(<span style="color:#800000;">"</span><span style="color:#800000;">%s done</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>-&gt;<span style="color:#000000;">name());
</span><span style="color:#008080;"> 651</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 652</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 653</span> <span style="color:#008000;"> * headersize:
</span><span style="color:#008080;"> 654</span> <span style="color:#008000;"> *    how big is an IP+TCP header in bytes; include options such as ts
</span><span style="color:#008080;"> 655</span> <span style="color:#008000;"> * this function should be virtual so others (e.g. SACK) can override
</span><span style="color:#008080;"> 656</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 657</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 658</span> <span style="color:#000000;">FullTcpAgent::headersize()
</span><span style="color:#008080;"> 659</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 660</span>     <span style="color:#0000ff;">int</span> total =<span style="color:#000000;"> tcpip_base_hdr_size_;
</span><span style="color:#008080;"> 661</span>     <span style="color:#0000ff;">if</span> (total &lt; <span style="color:#800080;">1</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 662</span> <span style="color:#000000;">        fprintf(stderr,
</span><span style="color:#008080;"> 663</span>             <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s): warning: tcpip hdr size is only %d bytes\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 664</span> <span style="color:#000000;">            now(), name(), tcpip_base_hdr_size_);
</span><span style="color:#008080;"> 665</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 666</span> 
<span style="color:#008080;"> 667</span>     <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ts_option_)
</span><span style="color:#008080;"> 668</span>         total +=<span style="color:#000000;"> ts_option_size_;
</span><span style="color:#008080;"> 669</span> 
<span style="color:#008080;"> 670</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (total);
</span><span style="color:#008080;"> 671</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 672</span> 
<span style="color:#008080;"> 673</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 674</span> <span style="color:#008000;"> * flags that are completely dependent on the tcp state
</span><span style="color:#008080;"> 675</span> <span style="color:#008000;"> * these are used for the next outgoing packet in foutput()
</span><span style="color:#008080;"> 676</span> <span style="color:#008000;"> * (in real TCP, see tcp_fsm.h, the "tcp_outflags" array)
</span><span style="color:#008080;"> 677</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 678</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 679</span> <span style="color:#000000;">FullTcpAgent::outflags()
</span><span style="color:#008080;"> 680</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 681</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> in real TCP an RST is added in the CLOSED state</span>
<span style="color:#008080;"> 682</span>     <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">int</span> tcp_outflags[TCP_NSTATES] =<span style="color:#000000;"> {
</span><span style="color:#008080;"> 683</span>         TH_ACK,              <span style="color:#008000;">/*</span><span style="color:#008000;"> 0, CLOSED </span><span style="color:#008000;">*/</span>  
<span style="color:#008080;"> 684</span>         <span style="color:#800080;">0</span>,                      <span style="color:#008000;">/*</span><span style="color:#008000;"> 1, LISTEN </span><span style="color:#008000;">*/</span> 
<span style="color:#008080;"> 685</span>         TH_SYN,                 <span style="color:#008000;">/*</span><span style="color:#008000;"> 2, SYN_SENT </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 686</span>         TH_SYN|TH_ACK,          <span style="color:#008000;">/*</span><span style="color:#008000;"> 3, SYN_RECEIVED </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 687</span>         TH_ACK,                 <span style="color:#008000;">/*</span><span style="color:#008000;"> 4, ESTABLISHED </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 688</span>         TH_ACK,                 <span style="color:#008000;">/*</span><span style="color:#008000;"> 5, CLOSE_WAIT </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 689</span>         TH_FIN|TH_ACK,          <span style="color:#008000;">/*</span><span style="color:#008000;"> 6, FIN_WAIT_1 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 690</span>         TH_FIN|TH_ACK,          <span style="color:#008000;">/*</span><span style="color:#008000;"> 7, CLOSING </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 691</span>         TH_FIN|TH_ACK,          <span style="color:#008000;">/*</span><span style="color:#008000;"> 8, LAST_ACK </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 692</span>         TH_ACK,                 <span style="color:#008000;">/*</span><span style="color:#008000;"> 9, FIN_WAIT_2 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 693</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> 10, TIME_WAIT --- not used in simulator </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 694</span> <span style="color:#000000;">    };
</span><span style="color:#008080;"> 695</span> 
<span style="color:#008080;"> 696</span>     <span style="color:#0000ff;">if</span> (state_ &lt; <span style="color:#800080;">0</span> || (state_ &gt;=<span style="color:#000000;"> TCP_NSTATES)) {
</span><span style="color:#008080;"> 697</span>         fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f FullTcpAgent(%s): invalid state %d\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 698</span> <span style="color:#000000;">            now(), name(), state_);
</span><span style="color:#008080;"> 699</span>         <span style="color:#0000ff;">return</span> (<span style="color:#800080;">0x0</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 700</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 701</span> 
<span style="color:#008080;"> 702</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (tcp_outflags[state_]);
</span><span style="color:#008080;"> 703</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 704</span> 
<span style="color:#008080;"> 705</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 706</span> <span style="color:#008000;"> * reaass() -- extract the appropriate fields from the packet
</span><span style="color:#008080;"> 707</span> <span style="color:#008000;"> *    and pass this info the ReassemblyQueue add routine
</span><span style="color:#008080;"> 708</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 709</span> <span style="color:#008000;"> * returns the TCP header flags representing the "or" of
</span><span style="color:#008080;"> 710</span> <span style="color:#008000;"> *    the flags contained in the adjacent sequence # blocks
</span><span style="color:#008080;"> 711</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 712</span> 
<span style="color:#008080;"> 713</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 714</span> FullTcpAgent::reass(Packet*<span style="color:#000000;"> pkt)
</span><span style="color:#008080;"> 715</span> <span style="color:#000000;">{  
</span><span style="color:#008080;"> 716</span>         hdr_tcp *tcph =<span style="color:#000000;">  hdr_tcp::access(pkt);
</span><span style="color:#008080;"> 717</span>         hdr_cmn *th =<span style="color:#000000;"> hdr_cmn::access(pkt);
</span><span style="color:#008080;"> 718</span>    
<span style="color:#008080;"> 719</span>         <span style="color:#0000ff;">int</span> start = tcph-&gt;<span style="color:#000000;">seqno();
</span><span style="color:#008080;"> 720</span>         <span style="color:#0000ff;">int</span> end = start + th-&gt;size() - tcph-&gt;<span style="color:#000000;">hlen();
</span><span style="color:#008080;"> 721</span>         <span style="color:#0000ff;">int</span> tiflags = tcph-&gt;<span style="color:#000000;">flags();
</span><span style="color:#008080;"> 722</span>     <span style="color:#0000ff;">int</span> fillshole = (start ==<span style="color:#000000;"> rcv_nxt_);
</span><span style="color:#008080;"> 723</span>     <span style="color:#0000ff;">int</span><span style="color:#000000;"> flags;
</span><span style="color:#008080;"> 724</span>    
<span style="color:#008080;"> 725</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> end contains the seq of the last byte of
</span><span style="color:#008080;"> 726</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> in the packet plus one</span>
<span style="color:#008080;"> 727</span> 
<span style="color:#008080;"> 728</span>     <span style="color:#0000ff;">if</span> (start == end &amp;&amp; (tiflags &amp; TH_FIN) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 729</span>         fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s)::reass() -- bad condition - adding non-FIN zero-len seg\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;"> 730</span> <span style="color:#000000;">            now(), name());
</span><span style="color:#008080;"> 731</span> <span style="color:#000000;">        abort();
</span><span style="color:#008080;"> 732</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 733</span> 
<span style="color:#008080;"> 734</span>     flags = rq_.add(start, end, tiflags, <span style="color:#800080;">0</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 735</span> 
<span style="color:#008080;"> 736</span>     <span style="color:#008000;">//</span><span style="color:#008000;">present:
</span><span style="color:#008080;"> 737</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;"> 738</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> If we've never received a SYN (unlikely)
</span><span style="color:#008080;"> 739</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> or this is an out of order addition, no reason to coalesce
</span><span style="color:#008080;"> 740</span>     <span style="color:#008000;">//
</span><span style="color:#008080;"> 741</span> 
<span style="color:#008080;"> 742</span>     <span style="color:#0000ff;">if</span> (TCPS_HAVERCVDSYN(state_) == <span style="color:#800080;">0</span> || !<span style="color:#000000;">fillshole) {
</span><span style="color:#008080;"> 743</span>          <span style="color:#0000ff;">return</span> (<span style="color:#800080;">0x00</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 744</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 745</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;"> 746</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> If we get some data in SYN_RECVD, no need to present to user yet
</span><span style="color:#008080;"> 747</span>     <span style="color:#008000;">//
</span><span style="color:#008080;"> 748</span>     <span style="color:#0000ff;">if</span> (state_ == TCPS_SYN_RECEIVED &amp;&amp; (end &gt;<span style="color:#000000;"> start))
</span><span style="color:#008080;"> 749</span>         <span style="color:#0000ff;">return</span> (<span style="color:#800080;">0x00</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 750</span> 
<span style="color:#008080;"> 751</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> clear out data that has been passed, up to rcv_nxt_,
</span><span style="color:#008080;"> 752</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> collects flags</span>
<span style="color:#008080;"> 753</span> 
<span style="color:#008080;"> 754</span>     flags |=<span style="color:#000000;"> rq_.cleartonxt();
</span><span style="color:#008080;"> 755</span> 
<span style="color:#008080;"> 756</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;"> (flags);
</span><span style="color:#008080;"> 757</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 758</span> 
<span style="color:#008080;"> 759</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 760</span> <span style="color:#008000;"> * utility function to set rcv_next_ during inital exchange of seq #s
</span><span style="color:#008080;"> 761</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 762</span> 
<span style="color:#008080;"> 763</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 764</span> FullTcpAgent::rcvseqinit(<span style="color:#0000ff;">int</span> seq, <span style="color:#0000ff;">int</span><span style="color:#000000;"> dlen)
</span><span style="color:#008080;"> 765</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 766</span>     <span style="color:#0000ff;">return</span> (seq + dlen + <span style="color:#800080;">1</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 767</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 768</span> 
<span style="color:#008080;"> 769</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 770</span> <span style="color:#008000;"> * build a header with the timestamp option if asked
</span><span style="color:#008080;"> 771</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 772</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 773</span> FullTcpAgent::build_options(hdr_tcp*<span style="color:#000000;"> tcph)
</span><span style="color:#008080;"> 774</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 775</span>     <span style="color:#0000ff;">int</span> total = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 776</span>     <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ts_option_) {
</span><span style="color:#008080;"> 777</span>         tcph-&gt;ts() =<span style="color:#000000;"> now();
</span><span style="color:#008080;"> 778</span>         tcph-&gt;ts_echo() =<span style="color:#000000;"> recent_;
</span><span style="color:#008080;"> 779</span>         total +=<span style="color:#000000;"> ts_option_size_;
</span><span style="color:#008080;"> 780</span>     } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;"> 781</span>         tcph-&gt;ts() = tcph-&gt;ts_echo() = -<span style="color:#800080;">1.0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 782</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 783</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (total);
</span><span style="color:#008080;"> 784</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 785</span> 
<span style="color:#008080;"> 786</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 787</span> <span style="color:#008000;"> * pack() -- is the ACK a partial ACK? (not past recover_)
</span><span style="color:#008080;"> 788</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 789</span> 
<span style="color:#008080;"> 790</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 791</span> FullTcpAgent::pack(Packet *<span style="color:#000000;">pkt)
</span><span style="color:#008080;"> 792</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 793</span>     hdr_tcp *tcph =<span style="color:#000000;"> hdr_tcp::access(pkt);
</span><span style="color:#008080;"> 794</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> Added check for fast recovery.  -M. Weigle 5/2/02 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 795</span>     <span style="color:#0000ff;">return</span> (fastrecov_ &amp;&amp; tcph-&gt;ackno() &gt;= highest_ack_ &amp;&amp;
<span style="color:#008080;"> 796</span>         tcph-&gt;ackno() &lt;<span style="color:#000000;"> recover_);
</span><span style="color:#008080;"> 797</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 798</span> 
<span style="color:#008080;"> 799</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 800</span> <span style="color:#008000;"> * baseline reno TCP exists fast recovery on a partial ACK
</span><span style="color:#008080;"> 801</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 802</span> 
<span style="color:#008080;"> 803</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 804</span> FullTcpAgent::pack_action(Packet*<span style="color:#000000;">)
</span><span style="color:#008080;"> 805</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 806</span>     <span style="color:#0000ff;">if</span> (reno_fastrecov_ &amp;&amp; fastrecov_ &amp;&amp; cwnd_ &gt; <span style="color:#0000ff;">double</span><span style="color:#000000;">(ssthresh_)) {
</span><span style="color:#008080;"> 807</span>         cwnd_ = <span style="color:#0000ff;">double</span>(ssthresh_); <span style="color:#008000;">//</span><span style="color:#008000;"> retract window if inflated</span>
<span style="color:#008080;"> 808</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 809</span>     fastrecov_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;"> 810</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: EXITED FAST RECOVERY\n", now());</span>
<span style="color:#008080;"> 811</span>     dupacks_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 812</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 813</span> 
<span style="color:#008080;"> 814</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 815</span> <span style="color:#008000;"> * ack_action -- same as partial ACK action for base Reno TCP
</span><span style="color:#008080;"> 816</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 817</span> 
<span style="color:#008080;"> 818</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 819</span> FullTcpAgent::ack_action(Packet*<span style="color:#000000;"> p)
</span><span style="color:#008080;"> 820</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 821</span> <span style="color:#000000;">    FullTcpAgent::pack_action(p);
</span><span style="color:#008080;"> 822</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 823</span> 
<span style="color:#008080;"> 824</span> 
<span style="color:#008080;"> 825</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 826</span> <span style="color:#008000;"> * sendpacket: 
</span><span style="color:#008080;"> 827</span> <span style="color:#008000;"> *    allocate a packet, fill in header fields, and send
</span><span style="color:#008080;"> 828</span> <span style="color:#008000;"> *    also keeps stats on # of data pkts, acks, re-xmits, etc
</span><span style="color:#008080;"> 829</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 830</span> <span style="color:#008000;"> * fill in packet fields.  Agent::allocpkt() fills
</span><span style="color:#008080;"> 831</span> <span style="color:#008000;"> * in most of the network layer fields for us.
</span><span style="color:#008080;"> 832</span> <span style="color:#008000;"> * So fill in tcp hdr and adjust the packet size.
</span><span style="color:#008080;"> 833</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 834</span> <span style="color:#008000;"> * Also, set the size of the tcp header.
</span><span style="color:#008080;"> 835</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 836</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 837</span> FullTcpAgent::sendpacket(<span style="color:#0000ff;">int</span> seqno, <span style="color:#0000ff;">int</span> ackno, <span style="color:#0000ff;">int</span> pflags, <span style="color:#0000ff;">int</span> datalen, <span style="color:#0000ff;">int</span> reason, Packet *<span style="color:#000000;">p)
</span><span style="color:#008080;"> 838</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 839</span>         <span style="color:#0000ff;">if</span> (!p) p =<span style="color:#000000;"> allocpkt();
</span><span style="color:#008080;"> 840</span>         hdr_tcp *tcph =<span style="color:#000000;"> hdr_tcp::access(p);
</span><span style="color:#008080;"> 841</span>     hdr_flags *fh =<span style="color:#000000;"> hdr_flags::access(p);
</span><span style="color:#008080;"> 842</span> 
<span style="color:#008080;"> 843</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> build basic header w/options </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 844</span> 
<span style="color:#008080;"> 845</span>         tcph-&gt;seqno() =<span style="color:#000000;"> seqno;
</span><span style="color:#008080;"> 846</span>         tcph-&gt;ackno() =<span style="color:#000000;"> ackno;
</span><span style="color:#008080;"> 847</span>         tcph-&gt;flags() =<span style="color:#000000;"> pflags;
</span><span style="color:#008080;"> 848</span>         tcph-&gt;reason() |= reason; <span style="color:#008000;">//</span><span style="color:#008000;"> make tcph-&gt;reason look like ns1 pkt-&gt;flags?</span>
<span style="color:#008080;"> 849</span>     tcph-&gt;sa_length() = <span style="color:#800080;">0</span>;    <span style="color:#008000;">//</span><span style="color:#008000;"> may be increased by build_options()</span>
<span style="color:#008080;"> 850</span>         tcph-&gt;hlen() =<span style="color:#000000;"> tcpip_base_hdr_size_;
</span><span style="color:#008080;"> 851</span>     tcph-&gt;hlen() +=<span style="color:#000000;"> build_options(tcph);
</span><span style="color:#008080;"> 852</span> 
<span style="color:#008080;"> 853</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 854</span> <span style="color:#008000;">     * Explicit Congestion Notification (ECN) related:
</span><span style="color:#008080;"> 855</span> <span style="color:#008000;">     * Bits in header:
</span><span style="color:#008080;"> 856</span> <span style="color:#008000;">     *     ECT (EC Capable Transport),
</span><span style="color:#008080;"> 857</span> <span style="color:#008000;">     *     ECNECHO (ECHO of ECN Notification generated at router),
</span><span style="color:#008080;"> 858</span> <span style="color:#008000;">     *     CWR (Congestion Window Reduced from RFC 2481)
</span><span style="color:#008080;"> 859</span> <span style="color:#008000;">     * States in TCP:
</span><span style="color:#008080;"> 860</span> <span style="color:#008000;">     *    ecn_: I am supposed to do ECN if my peer does
</span><span style="color:#008080;"> 861</span> <span style="color:#008000;">     *    ect_: I am doing ECN (ecn_ should be T and peer does ECN)
</span><span style="color:#008080;"> 862</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 863</span>     
<span style="color:#008080;"> 864</span>     <span style="color:#0000ff;">if</span> (datalen &gt; <span style="color:#800080;">0</span> &amp;&amp;<span style="color:#000000;"> ecn_ ){
</span><span style="color:#008080;"> 865</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> set ect on data packets </span>
<span style="color:#008080;"> 866</span>         fh-&gt;ect() = ect_;    <span style="color:#008000;">//</span><span style="color:#008000;"> on after mutual agreement on ECT</span>
<span style="color:#008080;"> 867</span>         } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; ecn_syn_ &amp;&amp; ecn_syn_next_ &amp;&amp; (pflags &amp; TH_SYN) &amp;&amp; (pflags &amp;<span style="color:#000000;"> TH_ACK)) {
</span><span style="color:#008080;"> 868</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> set ect on syn/ack packet, if syn packet was negotiating ECT</span>
<span style="color:#008080;"> 869</span>                    fh-&gt;ect() =<span style="color:#000000;"> ect_;
</span><span style="color:#008080;"> 870</span>     } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;"> 871</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> Set ect() to 0.  -M. Weigle 1/19/05 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 872</span>         fh-&gt;ect() = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 873</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 874</span>     <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; ect_ &amp;&amp;<span style="color:#000000;"> recent_ce_ ) { 
</span><span style="color:#008080;"> 875</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> This is needed here for the ACK in a SYN, SYN/ACK, ACK
</span><span style="color:#008080;"> 876</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> sequence.</span>
<span style="color:#008080;"> 877</span>         pflags |=<span style="color:#000000;"> TH_ECE;
</span><span style="color:#008080;"> 878</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 879</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> fill in CWR and ECE bits which don't actually sit in
</span><span style="color:#008080;"> 880</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> the tcp_flags but in hdr_flags</span>
<span style="color:#008080;"> 881</span>         <span style="color:#0000ff;">if</span> ( pflags &amp;<span style="color:#000000;"> TH_ECE) {
</span><span style="color:#008080;"> 882</span>                 fh-&gt;ecnecho() = <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 883</span>         } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;"> 884</span>                 fh-&gt;ecnecho() = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 885</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 886</span>         <span style="color:#0000ff;">if</span> ( pflags &amp;<span style="color:#000000;"> TH_CWR ) {
</span><span style="color:#008080;"> 887</span>                 fh-&gt;cong_action() = <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 888</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 889</span>     <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;"> 890</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> Set cong_action() to 0  -M. Weigle 1/19/05 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 891</span>         fh-&gt;cong_action() = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 892</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 893</span> 
<span style="color:#008080;"> 894</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> actual size is data length plus header length </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 895</span> 
<span style="color:#008080;"> 896</span>         hdr_cmn *ch =<span style="color:#000000;"> hdr_cmn::access(p);
</span><span style="color:#008080;"> 897</span>         ch-&gt;size() = datalen + tcph-&gt;<span style="color:#000000;">hlen();
</span><span style="color:#008080;"> 898</span> 
<span style="color:#008080;"> 899</span>         <span style="color:#0000ff;">if</span> (datalen &lt;= <span style="color:#800080;">0</span><span style="color:#000000;">)
</span><span style="color:#008080;"> 900</span>                 ++<span style="color:#000000;">nackpack_;
</span><span style="color:#008080;"> 901</span>         <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;"> 902</span>                 ++<span style="color:#000000;">ndatapack_;
</span><span style="color:#008080;"> 903</span>                 ndatabytes_ +=<span style="color:#000000;"> datalen;
</span><span style="color:#008080;"> 904</span>         last_send_time_ = now();    <span style="color:#008000;">//</span><span style="color:#008000;"> time of last data</span>
<span style="color:#008080;"> 905</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 906</span>         <span style="color:#0000ff;">if</span> (reason == REASON_TIMEOUT || reason == REASON_DUPACK || reason ==<span style="color:#000000;"> REASON_SACK) {
</span><span style="color:#008080;"> 907</span>                 ++<span style="color:#000000;">nrexmitpack_;
</span><span style="color:#008080;"> 908</span>                 nrexmitbytes_ +=<span style="color:#000000;"> datalen;
</span><span style="color:#008080;"> 909</span> <span style="color:#000000;">        }
</span><span style="color:#008080;"> 910</span> 
<span style="color:#008080;"> 911</span>     last_ack_sent_ =<span style="color:#000000;"> ackno;
</span><span style="color:#008080;"> 912</span> 
<span style="color:#008080;"> 913</span> <span style="color:#008000;">//</span><span style="color:#008000;">if (state_ != TCPS_ESTABLISHED) {
</span><span style="color:#008080;"> 914</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f(%s)[state:%s]: sending pkt ", now(), name(), statestr(state_));
</span><span style="color:#008080;"> 915</span> <span style="color:#008000;">//</span><span style="color:#008000;">prpkt(p);
</span><span style="color:#008080;"> 916</span> <span style="color:#008000;">//</span><span style="color:#008000;">}</span>
<span style="color:#008080;"> 917</span> 
<span style="color:#008080;"> 918</span>     send(p, <span style="color:#800080;">0</span><span style="color:#000000;">);
</span><span style="color:#008080;"> 919</span> 
<span style="color:#008080;"> 920</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 921</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 922</span> 
<span style="color:#008080;"> 923</span> <span style="color:#008000;">//</span>
<span style="color:#008080;"> 924</span> <span style="color:#008000;">//</span><span style="color:#008000;"> reset_rtx_timer: called during a retransmission timeout
</span><span style="color:#008080;"> 925</span> <span style="color:#008000;">//</span><span style="color:#008000;"> to perform exponential backoff.  Also, note that because
</span><span style="color:#008080;"> 926</span> <span style="color:#008000;">//</span><span style="color:#008000;"> we have performed a retransmission, our rtt timer is now
</span><span style="color:#008080;"> 927</span> <span style="color:#008000;">//</span><span style="color:#008000;"> invalidated (indicate this by setting rtt_active_ false)
</span><span style="color:#008080;"> 928</span> <span style="color:#008000;">//
</span><span style="color:#008080;"> 929</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;"> 930</span> FullTcpAgent::reset_rtx_timer(<span style="color:#0000ff;">int</span> <span style="color:#008000;">/*</span><span style="color:#008000;"> mild </span><span style="color:#008000;">*/</span><span style="color:#000000;">)
</span><span style="color:#008080;"> 931</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 932</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> cancel old timer, set a new one</span>
<span style="color:#008080;"> 933</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> if there is no outstanding data, don't back off rtx timer *
</span><span style="color:#008080;"> 934</span> <span style="color:#008000;">     * (Fix from T. Kelly.) </span><span style="color:#008000;">*/</span>
<span style="color:#008080;"> 935</span>     <span style="color:#0000ff;">if</span> (!(highest_ack_ == maxseq_ &amp;&amp;<span style="color:#000000;"> restart_bugfix_)) {
</span><span style="color:#008080;"> 936</span>             rtt_backoff();        <span style="color:#008000;">//</span><span style="color:#008000;"> double current timeout</span>
<span style="color:#008080;"> 937</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 938</span>         set_rtx_timer();    <span style="color:#008000;">//</span><span style="color:#008000;"> set new timer</span>
<span style="color:#008080;"> 939</span>         rtt_active_ = FALSE;    <span style="color:#008000;">//</span><span style="color:#008000;"> no timing during this window</span>
<span style="color:#008080;"> 940</span> <span style="color:#000000;">}
</span><span style="color:#008080;"> 941</span> 
<span style="color:#008080;"> 942</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;"> 943</span> <span style="color:#008000;"> * see if we should send a segment, and if so, send it
</span><span style="color:#008080;"> 944</span> <span style="color:#008000;"> *     (may be ACK or data)
</span><span style="color:#008080;"> 945</span> <span style="color:#008000;"> * return the number of data bytes sent (count a SYN or FIN as 1 each)
</span><span style="color:#008080;"> 946</span> <span style="color:#008000;"> *
</span><span style="color:#008080;"> 947</span> <span style="color:#008000;"> * simulator var, desc (name in real TCP)
</span><span style="color:#008080;"> 948</span> <span style="color:#008000;"> * --------------------------------------
</span><span style="color:#008080;"> 949</span> <span style="color:#008000;"> * maxseq_, largest seq# we've sent plus one (snd_max)
</span><span style="color:#008080;"> 950</span> <span style="color:#008000;"> * flags_, flags regarding our internal state (t_state)
</span><span style="color:#008080;"> 951</span> <span style="color:#008000;"> * pflags, a local used to build up the tcp header flags (flags)
</span><span style="color:#008080;"> 952</span> <span style="color:#008000;"> * curseq_, is the highest sequence number given to us by "application"
</span><span style="color:#008080;"> 953</span> <span style="color:#008000;"> * highest_ack_, the highest ACK we've seen for our data (snd_una-1)
</span><span style="color:#008080;"> 954</span> <span style="color:#008000;"> * seqno, the next seq# we're going to send (snd_nxt)
</span><span style="color:#008080;"> 955</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;"> 956</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;"> 957</span> FullTcpAgent::foutput(<span style="color:#0000ff;">int</span> seqno, <span style="color:#0000ff;">int</span><span style="color:#000000;"> reason)
</span><span style="color:#008080;"> 958</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 959</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> if maxseg_ not set, set it appropriately
</span><span style="color:#008080;"> 960</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> Q: how can this happen?</span>
<span style="color:#008080;"> 961</span> 
<span style="color:#008080;"> 962</span>     <span style="color:#0000ff;">if</span> (maxseg_ == <span style="color:#800080;">0</span><span style="color:#000000;">) 
</span><span style="color:#008080;"> 963</span>            maxseg_ = size_ -<span style="color:#000000;"> headersize();
</span><span style="color:#008080;"> 964</span>     <span style="color:#0000ff;">else</span>
<span style="color:#008080;"> 965</span>         size_ =  maxseg_ +<span style="color:#000000;"> headersize();
</span><span style="color:#008080;"> 966</span> 
<span style="color:#008080;"> 967</span>     <span style="color:#0000ff;">int</span> is_retransmit = (seqno &lt;<span style="color:#000000;"> maxseq_);
</span><span style="color:#008080;"> 968</span>     <span style="color:#0000ff;">int</span> quiet = (highest_ack_ ==<span style="color:#000000;"> maxseq_);
</span><span style="color:#008080;"> 969</span>     <span style="color:#0000ff;">int</span> pflags =<span style="color:#000000;"> outflags();
</span><span style="color:#008080;"> 970</span>     <span style="color:#0000ff;">int</span> syn = (seqno ==<span style="color:#000000;"> iss_);
</span><span style="color:#008080;"> 971</span>     <span style="color:#0000ff;">int</span> emptying_buffer =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;"> 972</span>     <span style="color:#0000ff;">int</span> buffered_bytes = (infinite_send_) ?<span style="color:#000000;"> TCP_MAXSEQ :
</span><span style="color:#008080;"> 973</span>                 curseq_ - highest_ack_ + <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 974</span> 
<span style="color:#008080;"> 975</span>     <span style="color:#0000ff;">int</span> win = window() * maxseg_;    <span style="color:#008000;">//</span><span style="color:#008000;"> window (in bytes)</span>
<span style="color:#008080;"> 976</span>     <span style="color:#0000ff;">int</span> off = seqno - highest_ack_;    <span style="color:#008000;">//</span><span style="color:#008000;"> offset of seg in window</span>
<span style="color:#008080;"> 977</span>     <span style="color:#0000ff;">int</span><span style="color:#000000;"> datalen;
</span><span style="color:#008080;"> 978</span>     <span style="color:#008000;">//</span><span style="color:#008000;">int amtsent = 0;
</span><span style="color:#008080;"> 979</span> 
<span style="color:#008080;"> 980</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> be careful if we have not received any ACK yet</span>
<span style="color:#008080;"> 981</span>     <span style="color:#0000ff;">if</span> (highest_ack_ &lt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;"> 982</span>         <span style="color:#0000ff;">if</span> (!<span style="color:#000000;">infinite_send_)
</span><span style="color:#008080;"> 983</span>             buffered_bytes = curseq_ -<span style="color:#000000;"> iss_;;
</span><span style="color:#008080;"> 984</span>         off = seqno -<span style="color:#000000;"> iss_;
</span><span style="color:#008080;"> 985</span> <span style="color:#000000;">    }
</span><span style="color:#008080;"> 986</span> 
<span style="color:#008080;"> 987</span>     <span style="color:#0000ff;">if</span> (syn &amp;&amp; !<span style="color:#000000;">data_on_syn_)
</span><span style="color:#008080;"> 988</span>         datalen = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 989</span>     <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span><span style="color:#000000;"> (pipectrl_)
</span><span style="color:#008080;"> 990</span>         datalen = buffered_bytes -<span style="color:#000000;"> off;
</span><span style="color:#008080;"> 991</span>     <span style="color:#0000ff;">else</span>
<span style="color:#008080;"> 992</span>         datalen = min(buffered_bytes, win) -<span style="color:#000000;"> off;
</span><span style="color:#008080;"> 993</span> 
<span style="color:#008080;"> 994</span>         <span style="color:#0000ff;">if</span> ((signal_on_empty_) &amp;&amp; (!buffered_bytes) &amp;&amp; (!<span style="color:#000000;">syn))
</span><span style="color:#008080;"> 995</span> <span style="color:#000000;">                    bufferempty();
</span><span style="color:#008080;"> 996</span> 
<span style="color:#008080;"> 997</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;"> 998</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> in real TCP datalen (len) could be &lt; 0 if there was window
</span><span style="color:#008080;"> 999</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> shrinkage, or if a FIN has been sent and neither ACKd nor
</span><span style="color:#008080;">1000</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> retransmitted.  Only this 2nd case concerns us here...
</span><span style="color:#008080;">1001</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">1002</span>     <span style="color:#0000ff;">if</span> (datalen &lt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1003</span>         datalen = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">1004</span>     } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (datalen &gt;<span style="color:#000000;"> maxseg_) {
</span><span style="color:#008080;">1005</span>         datalen =<span style="color:#000000;"> maxseg_;
</span><span style="color:#008080;">1006</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1007</span> 
<span style="color:#008080;">1008</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">1009</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> this is an option that causes us to slow-start if we've
</span><span style="color:#008080;">1010</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> been idle for a "long" time, where long means a rto or longer
</span><span style="color:#008080;">1011</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> the slow-start is a sort that does not set ssthresh
</span><span style="color:#008080;">1012</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">1013</span> 
<span style="color:#008080;">1014</span>     <span style="color:#0000ff;">if</span> (slow_start_restart_ &amp;&amp; quiet &amp;&amp; datalen &gt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1015</span>         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (idle_restart()) {
</span><span style="color:#008080;">1016</span> <span style="color:#000000;">            slowdown(CLOSE_CWND_INIT);
</span><span style="color:#008080;">1017</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1018</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1019</span> 
<span style="color:#008080;">1020</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">1021</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> see if sending this packet will empty the send buffer
</span><span style="color:#008080;">1022</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> a dataless SYN packet counts also
</span><span style="color:#008080;">1023</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">1024</span> 
<span style="color:#008080;">1025</span>     <span style="color:#0000ff;">if</span> (!infinite_send_ &amp;&amp; ((seqno + datalen) &gt; curseq_ || 
<span style="color:#008080;">1026</span>         (syn &amp;&amp; datalen == <span style="color:#800080;">0</span><span style="color:#000000;">))) {
</span><span style="color:#008080;">1027</span>         emptying_buffer =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">1028</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">1029</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if not a retransmission, notify application that 
</span><span style="color:#008080;">1030</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> everything has been sent out at least once.
</span><span style="color:#008080;">1031</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">1032</span>         <span style="color:#0000ff;">if</span> (!<span style="color:#000000;">syn) {
</span><span style="color:#008080;">1033</span> <span style="color:#000000;">            idle();
</span><span style="color:#008080;">1034</span>             <span style="color:#0000ff;">if</span> (close_on_empty_ &amp;&amp;<span style="color:#000000;"> quiet) {
</span><span style="color:#008080;">1035</span>                 flags_ |=<span style="color:#000000;"> TF_NEEDCLOSE;
</span><span style="color:#008080;">1036</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">1037</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1038</span>         pflags |=<span style="color:#000000;"> TH_PUSH;
</span><span style="color:#008080;">1039</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">1040</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if close_on_empty set, we are finished
</span><span style="color:#008080;">1041</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> with this connection; close it
</span><span style="color:#008080;">1042</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">1043</span>     } <span style="color:#0000ff;">else</span><span style="color:#000000;">  {
</span><span style="color:#008080;">1044</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> not emptying buffer, so can't be FIN </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1045</span>         pflags &amp;= ~<span style="color:#000000;">TH_FIN;
</span><span style="color:#008080;">1046</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1047</span>     <span style="color:#0000ff;">if</span> (infinite_send_ &amp;&amp; (syn &amp;&amp; datalen == <span style="color:#800080;">0</span><span style="color:#000000;">))
</span><span style="color:#008080;">1048</span>         pflags |= TH_PUSH;  <span style="color:#008000;">//</span><span style="color:#008000;"> set PUSH for dataless SYN</span>
<span style="color:#008080;">1049</span> 
<span style="color:#008080;">1050</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> sender SWS avoidance (Nagle) </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1051</span> 
<span style="color:#008080;">1052</span>     <span style="color:#0000ff;">if</span> (datalen &gt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1053</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if full-sized segment, ok</span>
<span style="color:#008080;">1054</span>         <span style="color:#0000ff;">if</span> (datalen ==<span style="color:#000000;"> maxseg_)
</span><span style="color:#008080;">1055</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> send;
</span><span style="color:#008080;">1056</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if Nagle disabled and buffer clearing, ok</span>
<span style="color:#008080;">1057</span>         <span style="color:#0000ff;">if</span> ((quiet || nodelay_)  &amp;&amp;<span style="color:#000000;"> emptying_buffer)
</span><span style="color:#008080;">1058</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> send;
</span><span style="color:#008080;">1059</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if a retransmission</span>
<span style="color:#008080;">1060</span>         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (is_retransmit)
</span><span style="color:#008080;">1061</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> send;
</span><span style="color:#008080;">1062</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if big "enough", ok...
</span><span style="color:#008080;">1063</span>         <span style="color:#008000;">//</span><span style="color:#008000;">    (this is not a likely case, and would
</span><span style="color:#008080;">1064</span>         <span style="color:#008000;">//</span><span style="color:#008000;">    only happen for tiny windows)</span>
<span style="color:#008080;">1065</span>         <span style="color:#0000ff;">if</span> (datalen &gt;= ((wnd_ * maxseg_) / <span style="color:#800080;">2.0</span><span style="color:#000000;">))
</span><span style="color:#008080;">1066</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> send;
</span><span style="color:#008080;">1067</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1068</span> 
<span style="color:#008080;">1069</span>     <span style="color:#0000ff;">if</span><span style="color:#000000;"> (need_send())
</span><span style="color:#008080;">1070</span>         <span style="color:#0000ff;">goto</span><span style="color:#000000;"> send;
</span><span style="color:#008080;">1071</span> 
<span style="color:#008080;">1072</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">1073</span> <span style="color:#008000;">     * send now if a control packet or we owe peer an ACK
</span><span style="color:#008080;">1074</span> <span style="color:#008000;">     * TF_ACKNOW can be set during connection establishment and
</span><span style="color:#008080;">1075</span> <span style="color:#008000;">     * to generate acks for out-of-order data
</span><span style="color:#008080;">1076</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">1077</span> 
<span style="color:#008080;">1078</span>     <span style="color:#0000ff;">if</span> ((flags_ &amp; (TF_ACKNOW|TF_NEEDCLOSE)) ||
<span style="color:#008080;">1079</span>         (pflags &amp; (TH_SYN|<span style="color:#000000;">TH_FIN))) {
</span><span style="color:#008080;">1080</span>         <span style="color:#0000ff;">goto</span><span style="color:#000000;"> send;
</span><span style="color:#008080;">1081</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1082</span> 
<span style="color:#008080;">1083</span>         <span style="color:#008000;">/*</span>      
<span style="color:#008080;">1084</span> <span style="color:#008000;">         * No reason to send a segment, just return.
</span><span style="color:#008080;">1085</span>          <span style="color:#008000;">*/</span>      
<span style="color:#008080;">1086</span>     <span style="color:#0000ff;">return</span> <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">1087</span> 
<span style="color:#008080;">1088</span> <span style="color:#000000;">send:
</span><span style="color:#008080;">1089</span> 
<span style="color:#008080;">1090</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> is a syn or fin?</span>
<span style="color:#008080;">1091</span> 
<span style="color:#008080;">1092</span>     syn = (pflags &amp; TH_SYN) ? <span style="color:#800080;">1</span> : <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">1093</span>     <span style="color:#0000ff;">int</span> fin = (pflags &amp; TH_FIN) ? <span style="color:#800080;">1</span> : <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">1094</span> 
<span style="color:#008080;">1095</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> setup ECN syn and ECN SYN+ACK packet headers </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1096</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; syn &amp;&amp; !(pflags &amp;<span style="color:#000000;"> TH_ACK)){
</span><span style="color:#008080;">1097</span>                 pflags |=<span style="color:#000000;"> TH_ECE;
</span><span style="color:#008080;">1098</span>                 pflags |=<span style="color:#000000;"> TH_CWR;
</span><span style="color:#008080;">1099</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1100</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; syn &amp;&amp; (pflags &amp;<span style="color:#000000;"> TH_ACK)){
</span><span style="color:#008080;">1101</span>                 pflags |=<span style="color:#000000;"> TH_ECE;
</span><span style="color:#008080;">1102</span>                 pflags &amp;= ~<span style="color:#000000;">TH_CWR;
</span><span style="color:#008080;">1103</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1104</span>     <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; ect_ &amp;&amp; cong_action_ &amp;&amp; 
<span style="color:#008080;">1105</span>                  (!is_retransmit ||<span style="color:#000000;"> SetCWRonRetransmit_)) {
</span><span style="color:#008080;">1106</span>         <span style="color:#008000;">/*</span> 
<span style="color:#008080;">1107</span> <span style="color:#008000;">         * Don't set CWR for a retranmitted SYN+ACK (has ecn_ 
</span><span style="color:#008080;">1108</span> <span style="color:#008000;">         * and cong_action_ set).
</span><span style="color:#008080;">1109</span> <span style="color:#008000;">         * -M. Weigle 6/19/02
</span><span style="color:#008080;">1110</span> <span style="color:#008000;">                 *
</span><span style="color:#008080;">1111</span> <span style="color:#008000;">                 * SetCWRonRetransmit_ was changed to true,
</span><span style="color:#008080;">1112</span> <span style="color:#008000;">                 * allowing CWR on retransmitted data packets.  
</span><span style="color:#008080;">1113</span> <span style="color:#008000;">                 * See test ecn_burstyEcn_reno_full 
</span><span style="color:#008080;">1114</span> <span style="color:#008000;">                 * in test-suite-ecn-full.tcl.
</span><span style="color:#008080;">1115</span> <span style="color:#008000;">         * - Sally Floyd, 6/5/08.
</span><span style="color:#008080;">1116</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1117</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> set CWR if necessary </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1118</span>         pflags |=<span style="color:#000000;"> TH_CWR;
</span><span style="color:#008080;">1119</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> Turn cong_action_ off: Added 6/5/08, Sally Floyd. </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1120</span>         cong_action_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">1121</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1122</span> 
<span style="color:#008080;">1123</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> moved from sendpacket()  -M. Weigle 6/19/02 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1124</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">1125</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> although CWR bit is ordinarily associated with ECN,
</span><span style="color:#008080;">1126</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> it has utility within the simulator for traces. Thus, set
</span><span style="color:#008080;">1127</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> it even if we aren't doing ECN
</span><span style="color:#008080;">1128</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">1129</span>     <span style="color:#0000ff;">if</span> (datalen &gt; <span style="color:#800080;">0</span> &amp;&amp; cong_action_ &amp;&amp; !<span style="color:#000000;">is_retransmit) {
</span><span style="color:#008080;">1130</span>         pflags |=<span style="color:#000000;"> TH_CWR;
</span><span style="color:#008080;">1131</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1132</span>   
<span style="color:#008080;">1133</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> set ECE if necessary </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1134</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; ect_ &amp;&amp;<span style="color:#000000;"> recent_ce_ ) {
</span><span style="color:#008080;">1135</span>         pflags |=<span style="color:#000000;"> TH_ECE;
</span><span style="color:#008080;">1136</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1137</span> 
<span style="color:#008080;">1138</span>         <span style="color:#008000;">/*</span> 
<span style="color:#008080;">1139</span> <span style="color:#008000;">         * Tack on the FIN flag to the data segment if close_on_empty_
</span><span style="color:#008080;">1140</span> <span style="color:#008000;">         * was previously set-- avoids sending a separate FIN
</span><span style="color:#008080;">1141</span>          <span style="color:#008000;">*/</span> 
<span style="color:#008080;">1142</span>         <span style="color:#0000ff;">if</span> (flags_ &amp;<span style="color:#000000;"> TF_NEEDCLOSE) {
</span><span style="color:#008080;">1143</span>                 flags_ &amp;= ~<span style="color:#000000;">TF_NEEDCLOSE;
</span><span style="color:#008080;">1144</span>                 <span style="color:#0000ff;">if</span> (state_ &lt;= TCPS_ESTABLISHED &amp;&amp; state_ !=<span style="color:#000000;"> TCPS_CLOSED)
</span><span style="color:#008080;">1145</span> <span style="color:#000000;">                {
</span><span style="color:#008080;">1146</span>                     pflags |=<span style="color:#000000;">TH_FIN;
</span><span style="color:#008080;">1147</span>                     fin = <span style="color:#800080;">1</span>;  <span style="color:#008000;">/*</span><span style="color:#008000;"> FIN consumes sequence number </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1148</span> <span style="color:#000000;">                    newstate(TCPS_FIN_WAIT_1);
</span><span style="color:#008080;">1149</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">1150</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1151</span> <span style="color:#000000;">    sendpacket(seqno, rcv_nxt_, pflags, datalen, reason);
</span><span style="color:#008080;">1152</span> 
<span style="color:#008080;">1153</span>         <span style="color:#008000;">/*</span>      
<span style="color:#008080;">1154</span> <span style="color:#008000;">         * Data sent (as far as we can tell).
</span><span style="color:#008080;">1155</span> <span style="color:#008000;">         * Any pending ACK has now been sent.
</span><span style="color:#008080;">1156</span>          <span style="color:#008000;">*/</span>      
<span style="color:#008080;">1157</span>     flags_ &amp;= ~(TF_ACKNOW|<span style="color:#000000;">TF_DELACK);
</span><span style="color:#008080;">1158</span> 
<span style="color:#008080;">1159</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">1160</span> <span style="color:#008000;">     * if we have reacted to congestion recently, the
</span><span style="color:#008080;">1161</span> <span style="color:#008000;">     * slowdown() procedure will have set cong_action_ and
</span><span style="color:#008080;">1162</span> <span style="color:#008000;">     * sendpacket will have copied that to the outgoing pkt
</span><span style="color:#008080;">1163</span> <span style="color:#008000;">     * CWR field. If that packet contains data, then
</span><span style="color:#008080;">1164</span> <span style="color:#008000;">     * it will be reliably delivered, so we are free to turn off the
</span><span style="color:#008080;">1165</span> <span style="color:#008000;">     * cong_action_ state now  If only a pure ACK, we keep the state
</span><span style="color:#008080;">1166</span> <span style="color:#008000;">     * around until we actually send a segment
</span><span style="color:#008080;">1167</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">1168</span> 
<span style="color:#008080;">1169</span>     <span style="color:#0000ff;">int</span> reliable = datalen + syn + fin; <span style="color:#008000;">//</span><span style="color:#008000;"> seq #'s reliably sent</span>
<span style="color:#008080;">1170</span>     <span style="color:#008000;">/*</span> 
<span style="color:#008080;">1171</span> <span style="color:#008000;">     * Don't reset cong_action_ until we send new data.
</span><span style="color:#008080;">1172</span> <span style="color:#008000;">     * -M. Weigle 6/19/02
</span><span style="color:#008080;">1173</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">1174</span>     <span style="color:#0000ff;">if</span> (cong_action_ &amp;&amp; reliable &gt; <span style="color:#800080;">0</span> &amp;&amp; !<span style="color:#000000;">is_retransmit)
</span><span style="color:#008080;">1175</span>         cong_action_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">1176</span> 
<span style="color:#008080;">1177</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> highest: greatest sequence number sent + 1
</span><span style="color:#008080;">1178</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    and adjusted for SYNs and FINs which use up one number</span>
<span style="color:#008080;">1179</span> 
<span style="color:#008080;">1180</span>     <span style="color:#0000ff;">int</span> highest = seqno +<span style="color:#000000;"> reliable;
</span><span style="color:#008080;">1181</span>     <span style="color:#0000ff;">if</span> (highest &gt;<span style="color:#000000;"> maxseq_) {
</span><span style="color:#008080;">1182</span>         maxseq_ =<span style="color:#000000;"> highest;
</span><span style="color:#008080;">1183</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">1184</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if we are using conventional RTT estimation,
</span><span style="color:#008080;">1185</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> establish timing on this segment
</span><span style="color:#008080;">1186</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">1187</span>         <span style="color:#0000ff;">if</span> (!ts_option_ &amp;&amp; rtt_active_ ==<span style="color:#000000;"> FALSE) {
</span><span style="color:#008080;">1188</span>             rtt_active_ = TRUE;    <span style="color:#008000;">//</span><span style="color:#008000;"> set timer</span>
<span style="color:#008080;">1189</span>             rtt_seq_ = seqno;     <span style="color:#008000;">//</span><span style="color:#008000;"> timed seq #</span>
<span style="color:#008080;">1190</span>             rtt_ts_ = now();    <span style="color:#008000;">//</span><span style="color:#008000;"> when set</span>
<span style="color:#008080;">1191</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1192</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1193</span> 
<span style="color:#008080;">1194</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">1195</span> <span style="color:#008000;">     * Set retransmit timer if not currently set,
</span><span style="color:#008080;">1196</span> <span style="color:#008000;">     * and not doing an ack or a keep-alive probe.
</span><span style="color:#008080;">1197</span> <span style="color:#008000;">     * Initial value for retransmit timer is smoothed
</span><span style="color:#008080;">1198</span> <span style="color:#008000;">     * round-trip time + 2 * round-trip time variance.
</span><span style="color:#008080;">1199</span> <span style="color:#008000;">     * Future values are rtt + 4 * rttvar.
</span><span style="color:#008080;">1200</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">1201</span>     <span style="color:#0000ff;">if</span> (rtx_timer_.status() != TIMER_PENDING &amp;&amp;<span style="color:#000000;"> reliable) {
</span><span style="color:#008080;">1202</span>         set_rtx_timer();  <span style="color:#008000;">//</span><span style="color:#008000;"> no timer pending, schedule one</span>
<span style="color:#008080;">1203</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1204</span> 
<span style="color:#008080;">1205</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (reliable);
</span><span style="color:#008080;">1206</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1207</span> 
<span style="color:#008080;">1208</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1209</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">1210</span> <span style="color:#008000;"> * send_much: send as much data as we are allowed to.  This is
</span><span style="color:#008080;">1211</span> <span style="color:#008000;"> * controlled by the "pipectrl_" variable.  If pipectrl_ is set
</span><span style="color:#008080;">1212</span> <span style="color:#008000;"> * to FALSE, then we are working as a normal window-based TCP and
</span><span style="color:#008080;">1213</span> <span style="color:#008000;"> * we are allowed to send whatever the window allows.
</span><span style="color:#008080;">1214</span> <span style="color:#008000;"> * If pipectrl_ is set to TRUE, then we are allowed to send whatever
</span><span style="color:#008080;">1215</span> <span style="color:#008000;"> * pipe_ allows us to send.  One tricky part is to make sure we
</span><span style="color:#008080;">1216</span> <span style="color:#008000;"> * do not overshoot the receiver's advertised window if we are
</span><span style="color:#008080;">1217</span> <span style="color:#008000;"> * in (pipectrl_ == TRUE) mode.
</span><span style="color:#008080;">1218</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1219</span>   
<span style="color:#008080;">1220</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">1221</span> FullTcpAgent::send_much(<span style="color:#0000ff;">int</span> force, <span style="color:#0000ff;">int</span> reason, <span style="color:#0000ff;">int</span><span style="color:#000000;"> maxburst)
</span><span style="color:#008080;">1222</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1223</span>     <span style="color:#0000ff;">int</span> npackets = <span style="color:#800080;">0</span>;    <span style="color:#008000;">//</span><span style="color:#008000;"> sent so far
</span><span style="color:#008080;">1224</span> 
<span style="color:#008080;">1225</span> <span style="color:#008000;">//</span><span style="color:#008000;">if ((int(t_seqno_)) &gt; 1)
</span><span style="color:#008080;">1226</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: send_much(f:%d, win:%d, pipectrl:%d, pipe:%d, t_seqno:%d, topwin:%d, maxseq_:%d\n",
</span><span style="color:#008080;">1227</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), force, win, pipectrl_, pipe_, int(t_seqno_), topwin, int(maxseq_));</span>
<span style="color:#008080;">1228</span> 
<span style="color:#008080;">1229</span>     <span style="color:#0000ff;">if</span> (!force &amp;&amp; (delsnd_timer_.status() ==<span style="color:#000000;"> TIMER_PENDING))
</span><span style="color:#008080;">1230</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">1231</span> 
<span style="color:#008080;">1232</span>     <span style="color:#0000ff;">while</span> (<span style="color:#800080;">1</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1233</span> 
<span style="color:#008080;">1234</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1235</span> <span style="color:#008000;">         * note that if output decides to not actually send
</span><span style="color:#008080;">1236</span> <span style="color:#008000;">         * (e.g. because of Nagle), then if we don't break out
</span><span style="color:#008080;">1237</span> <span style="color:#008000;">         * of this loop, we can loop forever at the same
</span><span style="color:#008080;">1238</span> <span style="color:#008000;">         * simulated time instant
</span><span style="color:#008080;">1239</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1240</span>         <span style="color:#0000ff;">int</span><span style="color:#000000;"> amt;
</span><span style="color:#008080;">1241</span>         <span style="color:#0000ff;">int</span> seq =<span style="color:#000000;"> nxt_tseq();
</span><span style="color:#008080;">1242</span>         <span style="color:#0000ff;">if</span> (!force &amp;&amp; !<span style="color:#000000;">send_allowed(seq))
</span><span style="color:#008080;">1243</span>             <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">1244</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> Q: does this need to be here too?</span>
<span style="color:#008080;">1245</span>         <span style="color:#0000ff;">if</span> (!force &amp;&amp; overhead_ != <span style="color:#800080;">0</span> &amp;&amp;
<span style="color:#008080;">1246</span>             (delsnd_timer_.status() !=<span style="color:#000000;"> TIMER_PENDING)) {
</span><span style="color:#008080;">1247</span> <span style="color:#000000;">            delsnd_timer_.resched(Random::uniform(overhead_));
</span><span style="color:#008080;">1248</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">1249</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1250</span>         <span style="color:#0000ff;">if</span> ((amt = foutput(seq, reason)) &lt;= <span style="color:#800080;">0</span><span style="color:#000000;">)
</span><span style="color:#008080;">1251</span>             <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">1252</span>         <span style="color:#0000ff;">if</span> ((outflags() &amp;<span style="color:#000000;"> TH_FIN))
</span><span style="color:#008080;">1253</span>             --amt;    <span style="color:#008000;">//</span><span style="color:#008000;"> don't count FINs</span>
<span style="color:#008080;">1254</span> <span style="color:#000000;">        sent(seq, amt);
</span><span style="color:#008080;">1255</span>         force = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">1256</span> 
<span style="color:#008080;">1257</span>         <span style="color:#0000ff;">if</span> ((outflags() &amp; (TH_SYN|TH_FIN)) ||
<span style="color:#008080;">1258</span>             (maxburst &amp;&amp; ++npackets &gt;=<span style="color:#000000;"> maxburst))
</span><span style="color:#008080;">1259</span>             <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">1260</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1261</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">1262</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1263</span> 
<span style="color:#008080;">1264</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1265</span> <span style="color:#008000;"> * base TCP: we are allowed to send a sequence number if it
</span><span style="color:#008080;">1266</span> <span style="color:#008000;"> * is in the window
</span><span style="color:#008080;">1267</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1268</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">1269</span> FullTcpAgent::send_allowed(<span style="color:#0000ff;">int</span><span style="color:#000000;"> seq)
</span><span style="color:#008080;">1270</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1271</span>         <span style="color:#0000ff;">int</span> win = window() *<span style="color:#000000;"> maxseg_;
</span><span style="color:#008080;">1272</span>         <span style="color:#0000ff;">int</span> topwin = curseq_; <span style="color:#008000;">//</span><span style="color:#008000;"> 1 seq number past the last byte we can send</span>
<span style="color:#008080;">1273</span> 
<span style="color:#008080;">1274</span>         <span style="color:#0000ff;">if</span> ((topwin &gt; highest_ack_ + win) ||<span style="color:#000000;"> infinite_send_)
</span><span style="color:#008080;">1275</span>                 topwin = highest_ack_ +<span style="color:#000000;"> win; 
</span><span style="color:#008080;">1276</span> 
<span style="color:#008080;">1277</span>     <span style="color:#0000ff;">return</span> (seq &lt;<span style="color:#000000;"> topwin);
</span><span style="color:#008080;">1278</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1279</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1280</span> <span style="color:#008000;"> * Process an ACK
</span><span style="color:#008080;">1281</span> <span style="color:#008000;"> *    this version of the routine doesn't necessarily
</span><span style="color:#008080;">1282</span> <span style="color:#008000;"> *    require the ack to be one which advances the ack number
</span><span style="color:#008080;">1283</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">1284</span> <span style="color:#008000;"> * if this ACKs a rtt estimate
</span><span style="color:#008080;">1285</span> <span style="color:#008000;"> *    indicate we are not timing
</span><span style="color:#008080;">1286</span> <span style="color:#008000;"> *    reset the exponential timer backoff (gamma)
</span><span style="color:#008080;">1287</span> <span style="color:#008000;"> * update rtt estimate
</span><span style="color:#008080;">1288</span> <span style="color:#008000;"> * cancel retrans timer if everything is sent and ACK'd, else set it
</span><span style="color:#008080;">1289</span> <span style="color:#008000;"> * advance the ack number if appropriate
</span><span style="color:#008080;">1290</span> <span style="color:#008000;"> * update segment to send next if appropriate
</span><span style="color:#008080;">1291</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1292</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">1293</span> FullTcpAgent::newack(Packet*<span style="color:#000000;"> pkt)
</span><span style="color:#008080;">1294</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1295</span>     hdr_tcp *tcph =<span style="color:#000000;"> hdr_tcp::access(pkt);
</span><span style="color:#008080;">1296</span> 
<span style="color:#008080;">1297</span>     register <span style="color:#0000ff;">int</span> ackno = tcph-&gt;<span style="color:#000000;">ackno();
</span><span style="color:#008080;">1298</span>     <span style="color:#0000ff;">int</span> progress = (ackno &gt;<span style="color:#000000;"> highest_ack_);
</span><span style="color:#008080;">1299</span> 
<span style="color:#008080;">1300</span>     <span style="color:#0000ff;">if</span> (ackno ==<span style="color:#000000;"> maxseq_) {
</span><span style="color:#008080;">1301</span>         cancel_rtx_timer();    <span style="color:#008000;">//</span><span style="color:#008000;"> all data ACKd</span>
<span style="color:#008080;">1302</span>     } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span><span style="color:#000000;"> (progress) {
</span><span style="color:#008080;">1303</span> <span style="color:#000000;">        set_rtx_timer();
</span><span style="color:#008080;">1304</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1305</span> 
<span style="color:#008080;">1306</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> advance the ack number if this is for new data</span>
<span style="color:#008080;">1307</span>     <span style="color:#0000ff;">if</span><span style="color:#000000;"> (progress)
</span><span style="color:#008080;">1308</span>         highest_ack_ =<span style="color:#000000;"> ackno;
</span><span style="color:#008080;">1309</span> 
<span style="color:#008080;">1310</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> if we have suffered a retransmit timeout, t_seqno_
</span><span style="color:#008080;">1311</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> will have been reset to highest_ ack.  If the
</span><span style="color:#008080;">1312</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> receiver has cached some data above t_seqno_, the
</span><span style="color:#008080;">1313</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> new-ack value could (should) jump forward.  We must
</span><span style="color:#008080;">1314</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> update t_seqno_ here, otherwise we would be doing
</span><span style="color:#008080;">1315</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> go-back-n.</span>
<span style="color:#008080;">1316</span> 
<span style="color:#008080;">1317</span>     <span style="color:#0000ff;">if</span> (t_seqno_ &lt;<span style="color:#000000;"> highest_ack_)
</span><span style="color:#008080;">1318</span>         t_seqno_ = highest_ack_; <span style="color:#008000;">//</span><span style="color:#008000;"> seq# to send next</span>
<span style="color:#008080;">1319</span> 
<span style="color:#008080;">1320</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1321</span> <span style="color:#008000;">         * Update RTT only if it's OK to do so from info in the flags header.
</span><span style="color:#008080;">1322</span> <span style="color:#008000;">         * This is needed for protocols in which intermediate agents
</span><span style="color:#008080;">1323</span> 
<span style="color:#008080;">1324</span> <span style="color:#008000;">         * in the network intersperse acks (e.g., ack-reconstructors) for
</span><span style="color:#008080;">1325</span> <span style="color:#008000;">         * various reasons (without violating e2e semantics).
</span><span style="color:#008080;">1326</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1327</span>         hdr_flags *fh =<span style="color:#000000;"> hdr_flags::access(pkt);
</span><span style="color:#008080;">1328</span> 
<span style="color:#008080;">1329</span>     <span style="color:#0000ff;">if</span> (!fh-&gt;<span style="color:#000000;">no_ts_) {
</span><span style="color:#008080;">1330</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ts_option_) {
</span><span style="color:#008080;">1331</span>             recent_age_ =<span style="color:#000000;"> now();
</span><span style="color:#008080;">1332</span>             recent_ = tcph-&gt;<span style="color:#000000;">ts();
</span><span style="color:#008080;">1333</span>             rtt_update(now() - tcph-&gt;<span style="color:#000000;">ts_echo());
</span><span style="color:#008080;">1334</span>             <span style="color:#0000ff;">if</span> (ts_resetRTO_ &amp;&amp; (!ect_ || !ecn_backoff_ ||
<span style="color:#008080;">1335</span>                    !hdr_flags::access(pkt)-&gt;<span style="color:#000000;">ecnecho())) { 
</span><span style="color:#008080;">1336</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> From Andrei Gurtov
</span><span style="color:#008080;">1337</span>                 <span style="color:#008000;">//</span>
<span style="color:#008080;">1338</span>                              <span style="color:#008000;">//</span><span style="color:#008000;"> Don't end backoff if still in ECN-Echo with
</span><span style="color:#008080;">1339</span>                              <span style="color:#008000;">//</span><span style="color:#008000;"> a congestion window of 1 packet.</span>
<span style="color:#008080;">1340</span>                 t_backoff_ = <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;">1341</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">1342</span>         } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (rtt_active_ &amp;&amp; ackno &gt;<span style="color:#000000;"> rtt_seq_) {
</span><span style="color:#008080;">1343</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> got an RTT sample, record it
</span><span style="color:#008080;">1344</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> "t_backoff_ = 1;" deleted by T. Kelly.</span>
<span style="color:#008080;">1345</span>             rtt_active_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">1346</span>             rtt_update(now() -<span style="color:#000000;"> rtt_ts_);
</span><span style="color:#008080;">1347</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">1348</span>         <span style="color:#0000ff;">if</span> (!ect_ || !ecn_backoff_ ||
<span style="color:#008080;">1349</span>             !hdr_flags::access(pkt)-&gt;<span style="color:#000000;">ecnecho()) {
</span><span style="color:#008080;">1350</span>             <span style="color:#008000;">/*</span>
<span style="color:#008080;">1351</span> <span style="color:#008000;">             * Don't end backoff if still in ECN-Echo with
</span><span style="color:#008080;">1352</span> <span style="color:#008000;">             * a congestion window of 1 packet.
</span><span style="color:#008080;">1353</span> <span style="color:#008000;">             * Fix from T. Kelly.
</span><span style="color:#008080;">1354</span>              <span style="color:#008000;">*/</span>
<span style="color:#008080;">1355</span>             t_backoff_ = <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;">1356</span>             ecn_backoff_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">1357</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1358</span> 
<span style="color:#008080;">1359</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1360</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">1361</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1362</span> 
<span style="color:#008080;">1363</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1364</span> <span style="color:#008000;"> * this is the simulated form of the header prediction
</span><span style="color:#008080;">1365</span> <span style="color:#008000;"> * predicate.  While not really necessary for a simulation, it
</span><span style="color:#008080;">1366</span> <span style="color:#008000;"> * follows the code base more closely and can sometimes help to reveal
</span><span style="color:#008080;">1367</span> <span style="color:#008000;"> * odd behavior caused by the implementation structure..
</span><span style="color:#008080;">1368</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">1369</span> <span style="color:#008000;"> * Here's the comment from the real TCP:
</span><span style="color:#008080;">1370</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">1371</span> <span style="color:#008000;"> * Header prediction: check for the two common cases
</span><span style="color:#008080;">1372</span> <span style="color:#008000;"> * of a uni-directional data xfer.  If the packet has
</span><span style="color:#008080;">1373</span> <span style="color:#008000;"> * no control flags, is in-sequence, the window didn't
</span><span style="color:#008080;">1374</span> <span style="color:#008000;"> * change and we're not retransmitting, it's a
</span><span style="color:#008080;">1375</span> <span style="color:#008000;"> * candidate.  If the length is zero and the ack moved
</span><span style="color:#008080;">1376</span> <span style="color:#008000;"> * forward, we're the sender side of the xfer.  Just
</span><span style="color:#008080;">1377</span> <span style="color:#008000;"> * free the data acked &amp; wake any higher level process
</span><span style="color:#008080;">1378</span> <span style="color:#008000;"> * that was blocked waiting for space.  If the length
</span><span style="color:#008080;">1379</span> <span style="color:#008000;"> * is non-zero and the ack didn't move, we're the
</span><span style="color:#008080;">1380</span> <span style="color:#008000;"> * receiver side.  If we're getting packets in-order
</span><span style="color:#008080;">1381</span> <span style="color:#008000;"> * (the reassembly queue is empty), add the data to
</span><span style="color:#008080;">1382</span> <span style="color:#008000;"> * the socket buffer and note that we need a delayed ack.
</span><span style="color:#008080;">1383</span> <span style="color:#008000;"> * Make sure that the hidden state-flags are also off.
</span><span style="color:#008080;">1384</span> <span style="color:#008000;"> * Since we check for TCPS_ESTABLISHED above, it can only
</span><span style="color:#008080;">1385</span> <span style="color:#008000;"> * be TF_NEEDSYN.
</span><span style="color:#008080;">1386</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1387</span> 
<span style="color:#008080;">1388</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">1389</span> FullTcpAgent::predict_ok(Packet*<span style="color:#000000;"> pkt)
</span><span style="color:#008080;">1390</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1391</span>     hdr_tcp *tcph =<span style="color:#000000;"> hdr_tcp::access(pkt);
</span><span style="color:#008080;">1392</span>         hdr_flags *fh =<span style="color:#000000;"> hdr_flags::access(pkt);
</span><span style="color:#008080;">1393</span> 
<span style="color:#008080;">1394</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> not the fastest way to do this, but perhaps clearest </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1395</span> 
<span style="color:#008080;">1396</span>     <span style="color:#0000ff;">int</span> p1 = (state_ == TCPS_ESTABLISHED);        <span style="color:#008000;">//</span><span style="color:#008000;"> ready</span>
<span style="color:#008080;">1397</span>     <span style="color:#0000ff;">int</span> p2 = ((tcph-&gt;flags() &amp; (TH_SYN|TH_FIN|TH_ACK)) == TH_ACK); <span style="color:#008000;">//</span><span style="color:#008000;"> ACK</span>
<span style="color:#008080;">1398</span>     <span style="color:#0000ff;">int</span> p3 = ((flags_ &amp; TF_NEEDFIN) == <span style="color:#800080;">0</span>);        <span style="color:#008000;">//</span><span style="color:#008000;"> don't need fin</span>
<span style="color:#008080;">1399</span>     <span style="color:#0000ff;">int</span> p4 = (!ts_option_ || fh-&gt;no_ts_ || (tcph-&gt;ts() &gt;= recent_)); <span style="color:#008000;">//</span><span style="color:#008000;"> tsok</span>
<span style="color:#008080;">1400</span>     <span style="color:#0000ff;">int</span> p5 = (tcph-&gt;seqno() == rcv_nxt_);        <span style="color:#008000;">//</span><span style="color:#008000;"> in-order data</span>
<span style="color:#008080;">1401</span>     <span style="color:#0000ff;">int</span> p6 = (t_seqno_ == maxseq_);            <span style="color:#008000;">//</span><span style="color:#008000;"> not re-xmit</span>
<span style="color:#008080;">1402</span>     <span style="color:#0000ff;">int</span> p7 = (!ecn_ || fh-&gt;ecnecho() == <span style="color:#800080;">0</span>);        <span style="color:#008000;">//</span><span style="color:#008000;"> no ECN</span>
<span style="color:#008080;">1403</span>     <span style="color:#0000ff;">int</span> p8 = (tcph-&gt;sa_length() == <span style="color:#800080;">0</span>);        <span style="color:#008000;">//</span><span style="color:#008000;"> no SACK info</span>
<span style="color:#008080;">1404</span> 
<span style="color:#008080;">1405</span>     <span style="color:#0000ff;">return</span> (p1 &amp;&amp; p2 &amp;&amp; p3 &amp;&amp; p4 &amp;&amp; p5 &amp;&amp; p6 &amp;&amp; p7 &amp;&amp;<span style="color:#000000;"> p8);
</span><span style="color:#008080;">1406</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1407</span> 
<span style="color:#008080;">1408</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1409</span> <span style="color:#008000;"> * fast_retransmit using the given seqno
</span><span style="color:#008080;">1410</span> <span style="color:#008000;"> *    perform fast RTX, set recover_, set last_cwnd_action
</span><span style="color:#008080;">1411</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1412</span> 
<span style="color:#008080;">1413</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">1414</span> FullTcpAgent::fast_retransmit(<span style="color:#0000ff;">int</span><span style="color:#000000;"> seq)
</span><span style="color:#008080;">1415</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1416</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> we are now going to fast-retransmit and willtrace that event</span>
<span style="color:#008080;">1417</span>     trace_event(<span style="color:#800000;">"</span><span style="color:#800000;">FAST_RETX</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;">1418</span>     
<span style="color:#008080;">1419</span>     recover_ = maxseq_;    <span style="color:#008000;">//</span><span style="color:#008000;"> recovery target</span>
<span style="color:#008080;">1420</span>     last_cwnd_action_ =<span style="color:#000000;"> CWND_ACTION_DUPACK;
</span><span style="color:#008080;">1421</span>     <span style="color:#0000ff;">return</span>(foutput(seq, REASON_DUPACK));    <span style="color:#008000;">//</span><span style="color:#008000;"> send one pkt</span>
<span style="color:#008080;">1422</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1423</span> 
<span style="color:#008080;">1424</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1425</span> <span style="color:#008000;"> * real tcp determines if the remote
</span><span style="color:#008080;">1426</span> <span style="color:#008000;"> * side should receive a window update/ACK from us, and often
</span><span style="color:#008080;">1427</span> <span style="color:#008000;"> * results in sending an update every 2 segments, thereby
</span><span style="color:#008080;">1428</span> <span style="color:#008000;"> * giving the familiar 2-packets-per-ack behavior of TCP.
</span><span style="color:#008080;">1429</span> <span style="color:#008000;"> * Here, we don't advertise any windows, so we just see if
</span><span style="color:#008080;">1430</span> <span style="color:#008000;"> * there's at least 'segs_per_ack_' pkts not yet acked
</span><span style="color:#008080;">1431</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">1432</span> <span style="color:#008000;"> * also, provide for a segs-per-ack "threshold" where
</span><span style="color:#008080;">1433</span> <span style="color:#008000;"> * we generate 1-ack-per-seg until enough stuff
</span><span style="color:#008080;">1434</span> <span style="color:#008000;"> * (spa_thresh_ bytes) has been received from the other side
</span><span style="color:#008080;">1435</span> <span style="color:#008000;"> * This idea came from vj/kmn in BayTcp.  Added 8/21/01.
</span><span style="color:#008080;">1436</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1437</span> 
<span style="color:#008080;">1438</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">1439</span> <span style="color:#000000;">FullTcpAgent::need_send()
</span><span style="color:#008080;">1440</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1441</span>     <span style="color:#0000ff;">if</span> (flags_ &amp;<span style="color:#000000;"> TF_ACKNOW)
</span><span style="color:#008080;">1442</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">1443</span> 
<span style="color:#008080;">1444</span>     <span style="color:#0000ff;">int</span> spa = (spa_thresh_ &gt; <span style="color:#800080;">0</span> &amp;&amp; ((rcv_nxt_ - irs_)  &lt; spa_thresh_)) ?
<span style="color:#008080;">1445</span>         <span style="color:#800080;">1</span><span style="color:#000000;"> : segs_per_ack_;
</span><span style="color:#008080;">1446</span>         
<span style="color:#008080;">1447</span>     <span style="color:#0000ff;">return</span> ((rcv_nxt_ - last_ack_sent_) &gt;= (spa *<span style="color:#000000;"> maxseg_));
</span><span style="color:#008080;">1448</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1449</span> 
<span style="color:#008080;">1450</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1451</span> <span style="color:#008000;"> * determine whether enough time has elapsed in order to
</span><span style="color:#008080;">1452</span> <span style="color:#008000;"> * conclude a "restart" is necessary (e.g. a slow-start)
</span><span style="color:#008080;">1453</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">1454</span> <span style="color:#008000;"> * for now, keep track of this similarly to how rtt_update() does
</span><span style="color:#008080;">1455</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1456</span> 
<span style="color:#008080;">1457</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">1458</span> <span style="color:#000000;">FullTcpAgent::idle_restart()
</span><span style="color:#008080;">1459</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1460</span>     <span style="color:#0000ff;">if</span> (last_send_time_ &lt; <span style="color:#800080;">0.0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1461</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> last_send_time_ isn't set up yet, we shouldn't
</span><span style="color:#008080;">1462</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> do the idle_restart</span>
<span style="color:#008080;">1463</span>         <span style="color:#0000ff;">return</span> (<span style="color:#800080;">0</span><span style="color:#000000;">);
</span><span style="color:#008080;">1464</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1465</span> 
<span style="color:#008080;">1466</span>     <span style="color:#0000ff;">double</span> tao = now() -<span style="color:#000000;"> last_send_time_;
</span><span style="color:#008080;">1467</span>     <span style="color:#0000ff;">if</span> (!<span style="color:#000000;">ts_option_) {
</span><span style="color:#008080;">1468</span>                 <span style="color:#0000ff;">double</span> tickoff = fmod(last_send_time_ +<span style="color:#000000;"> boot_time_,
</span><span style="color:#008080;">1469</span> <span style="color:#000000;">            tcp_tick_);
</span><span style="color:#008080;">1470</span>                 tao = <span style="color:#0000ff;">int</span>((tao + tickoff) / tcp_tick_) *<span style="color:#000000;"> tcp_tick_;
</span><span style="color:#008080;">1471</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1472</span> 
<span style="color:#008080;">1473</span>     <span style="color:#0000ff;">return</span> (tao &gt; t_rtxcur_);  <span style="color:#008000;">//</span><span style="color:#008000;"> verify this CHECKME</span>
<span style="color:#008080;">1474</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1475</span> 
<span style="color:#008080;">1476</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1477</span> <span style="color:#008000;"> * tcp-full's version of set_initial_window()... over-rides
</span><span style="color:#008080;">1478</span> <span style="color:#008000;"> * the one in tcp.cc
</span><span style="color:#008080;">1479</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1480</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">1481</span> <span style="color:#000000;">FullTcpAgent::set_initial_window()
</span><span style="color:#008080;">1482</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1483</span>     syn_ = TRUE;    <span style="color:#008000;">//</span><span style="color:#008000;"> full-tcp always models SYN exchange</span>
<span style="color:#008080;">1484</span> <span style="color:#000000;">    TcpAgent::set_initial_window();
</span><span style="color:#008080;">1485</span> <span style="color:#000000;">}       
</span><span style="color:#008080;">1486</span> 
<span style="color:#008080;">1487</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1488</span> <span style="color:#008000;"> * main reception path - 
</span><span style="color:#008080;">1489</span> <span style="color:#008000;"> * called from the agent that handles the data path below in its muxing mode
</span><span style="color:#008080;">1490</span> <span style="color:#008000;"> * advance() is called when connection is established with size sent from
</span><span style="color:#008080;">1491</span> <span style="color:#008000;"> * user/application agent
</span><span style="color:#008080;">1492</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">1493</span> <span style="color:#008000;"> * This is a fairly complex function.  It operates generally as follows:
</span><span style="color:#008080;">1494</span> <span style="color:#008000;"> *    do header prediction for simple cases (pure ACKS or data)
</span><span style="color:#008080;">1495</span> <span style="color:#008000;"> *    if in LISTEN and we get a SYN, begin initializing connection
</span><span style="color:#008080;">1496</span> <span style="color:#008000;"> *    if in SYN_SENT and we get an ACK, complete connection init
</span><span style="color:#008080;">1497</span> <span style="color:#008000;"> *    trim any redundant data from received dataful segment
</span><span style="color:#008080;">1498</span> <span style="color:#008000;"> *    deal with ACKS:
</span><span style="color:#008080;">1499</span> <span style="color:#008000;"> *        if in SYN_RCVD, complete connection init then go on
</span><span style="color:#008080;">1500</span> <span style="color:#008000;"> *        see if ACK is old or at the current highest_ack
</span><span style="color:#008080;">1501</span> <span style="color:#008000;"> *        if at current high, is the threshold reached or not
</span><span style="color:#008080;">1502</span> <span style="color:#008000;"> *        if so, maybe do fast rtx... otherwise drop or inflate win
</span><span style="color:#008080;">1503</span> <span style="color:#008000;"> *    deal with incoming data
</span><span style="color:#008080;">1504</span> <span style="color:#008000;"> *    deal with FIN bit on in arriving packet
</span><span style="color:#008080;">1505</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1506</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">1507</span> FullTcpAgent::recv(Packet *pkt, Handler*<span style="color:#000000;">)
</span><span style="color:#008080;">1508</span> <span style="color:#000000;">{
</span><span style="color:#008080;">1509</span>     hdr_tcp *tcph = hdr_tcp::access(pkt);    <span style="color:#008000;">//</span><span style="color:#008000;"> TCP header</span>
<span style="color:#008080;">1510</span>     hdr_cmn *th = hdr_cmn::access(pkt);    <span style="color:#008000;">//</span><span style="color:#008000;"> common header (size, etc)</span>
<span style="color:#008080;">1511</span>     hdr_flags *fh = hdr_flags::access(pkt);    <span style="color:#008000;">//</span><span style="color:#008000;"> flags (CWR, CE, bits)</span>
<span style="color:#008080;">1512</span> 
<span style="color:#008080;">1513</span>     <span style="color:#0000ff;">int</span> needoutput =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">1514</span>     <span style="color:#0000ff;">int</span> ourfinisacked =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">1515</span>     <span style="color:#0000ff;">int</span> dupseg = FALSE;            <span style="color:#008000;">//</span><span style="color:#008000;"> recv'd dup data segment</span>
<span style="color:#008080;">1516</span>     <span style="color:#0000ff;">int</span> todrop = <span style="color:#800080;">0</span>;                <span style="color:#008000;">//</span><span style="color:#008000;"> duplicate DATA cnt in seg</span>
<span style="color:#008080;">1517</span> 
<span style="color:#008080;">1518</span>     last_state_ =<span style="color:#000000;"> state_;
</span><span style="color:#008080;">1519</span> 
<span style="color:#008080;">1520</span>     <span style="color:#0000ff;">int</span> datalen = th-&gt;size() - tcph-&gt;hlen(); <span style="color:#008000;">//</span><span style="color:#008000;"> # payload bytes</span>
<span style="color:#008080;">1521</span>     <span style="color:#0000ff;">int</span> ackno = tcph-&gt;ackno();         <span style="color:#008000;">//</span><span style="color:#008000;"> ack # from packet</span>
<span style="color:#008080;">1522</span>     <span style="color:#0000ff;">int</span> tiflags = tcph-&gt;flags() ;          <span style="color:#008000;">//</span><span style="color:#008000;"> tcp flags from packet
</span><span style="color:#008080;">1523</span> 
<span style="color:#008080;">1524</span> <span style="color:#008000;">//</span><span style="color:#008000;">if (state_ != TCPS_ESTABLISHED || (tiflags&amp;(TH_SYN|TH_FIN))) {
</span><span style="color:#008080;">1525</span> <span style="color:#008000;">//</span><span style="color:#008000;">fprintf(stdout, "%f(%s)in state %s recv'd this packet: ", now(), name(), statestr(state_));
</span><span style="color:#008080;">1526</span> <span style="color:#008000;">//</span><span style="color:#008000;">prpkt(pkt);
</span><span style="color:#008080;">1527</span> <span style="color:#008000;">//</span><span style="color:#008000;">}</span>
<span style="color:#008080;">1528</span> 
<span style="color:#008080;">1529</span>     <span style="color:#008000;">/*</span> 
<span style="color:#008080;">1530</span> <span style="color:#008000;">     * Acknowledge FIN from passive closer even in TCPS_CLOSED state
</span><span style="color:#008080;">1531</span> <span style="color:#008000;">     * (since we lack TIME_WAIT state and RST packets,
</span><span style="color:#008080;">1532</span> <span style="color:#008000;">     * the loss of the FIN packet from the passive closer will make that
</span><span style="color:#008080;">1533</span> <span style="color:#008000;">     * endpoint retransmit the FIN forever)
</span><span style="color:#008080;">1534</span> <span style="color:#008000;">     * -F. Hernandez-Campos 8/6/00
</span><span style="color:#008080;">1535</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">1536</span>     <span style="color:#0000ff;">if</span> ( (state_ == TCPS_CLOSED) &amp;&amp; (tiflags &amp;<span style="color:#000000;"> TH_FIN) ) {
</span><span style="color:#008080;">1537</span>         <span style="color:#0000ff;">goto</span><span style="color:#000000;"> dropafterack;
</span><span style="color:#008080;">1538</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1539</span> 
<span style="color:#008080;">1540</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">1541</span> <span style="color:#008000;">     * Don't expect to see anything while closed
</span><span style="color:#008080;">1542</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">1543</span> 
<span style="color:#008080;">1544</span>     <span style="color:#0000ff;">if</span> (state_ ==<span style="color:#000000;"> TCPS_CLOSED) {
</span><span style="color:#008080;">1545</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">1546</span>                 fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcp(%s): recv'd pkt in CLOSED state: </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">1547</span> <span style="color:#000000;">                now(), name());
</span><span style="color:#008080;">1548</span> <span style="color:#000000;">                prpkt(pkt);
</span><span style="color:#008080;">1549</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">1550</span>         <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">1551</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1552</span> 
<span style="color:#008080;">1553</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1554</span> <span style="color:#008000;">         * Process options if not in LISTEN state,
</span><span style="color:#008080;">1555</span> <span style="color:#008000;">         * else do it below
</span><span style="color:#008080;">1556</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1557</span>     <span style="color:#0000ff;">if</span> (state_ !=<span style="color:#000000;"> TCPS_LISTEN)
</span><span style="color:#008080;">1558</span> <span style="color:#000000;">        dooptions(pkt);
</span><span style="color:#008080;">1559</span> 
<span style="color:#008080;">1560</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">1561</span> <span style="color:#008000;">     * if we are using delayed-ACK timers and
</span><span style="color:#008080;">1562</span> <span style="color:#008000;">     * no delayed-ACK timer is set, set one.
</span><span style="color:#008080;">1563</span> <span style="color:#008000;">     * They are set to fire every 'interval_' secs, starting
</span><span style="color:#008080;">1564</span> <span style="color:#008000;">     * at time t0 = (0.0 + k * interval_) for some k such
</span><span style="color:#008080;">1565</span> <span style="color:#008000;">     * that t0 &gt; now
</span><span style="color:#008080;">1566</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">1567</span>     <span style="color:#0000ff;">if</span> (delack_interval_ &gt; <span style="color:#800080;">0.0</span> &amp;&amp;
<span style="color:#008080;">1568</span>         (delack_timer_.status() !=<span style="color:#000000;"> TIMER_PENDING)) {
</span><span style="color:#008080;">1569</span>         <span style="color:#0000ff;">int</span> last = <span style="color:#0000ff;">int</span>(now() /<span style="color:#000000;"> delack_interval_);
</span><span style="color:#008080;">1570</span>         delack_timer_.resched(delack_interval_ * (last + <span style="color:#800080;">1.0</span>) -<span style="color:#000000;"> now());
</span><span style="color:#008080;">1571</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1572</span> 
<span style="color:#008080;">1573</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">1574</span> <span style="color:#008000;">     * Try header prediction: in seq data or in seq pure ACK
</span><span style="color:#008080;">1575</span> <span style="color:#008000;">     *    with no funny business
</span><span style="color:#008080;">1576</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">1577</span>     <span style="color:#0000ff;">if</span> (!nopredict_ &amp;&amp;<span style="color:#000000;"> predict_ok(pkt)) {
</span><span style="color:#008080;">1578</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">1579</span> <span style="color:#008000;">                 * If last ACK falls within this segment's sequence numbers,
</span><span style="color:#008080;">1580</span> <span style="color:#008000;">                 * record the timestamp.
</span><span style="color:#008080;">1581</span> <span style="color:#008000;">         * See RFC1323 (now RFC1323 bis)
</span><span style="color:#008080;">1582</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1583</span>                 <span style="color:#0000ff;">if</span> (ts_option_ &amp;&amp; !fh-&gt;no_ts_ &amp;&amp;
<span style="color:#008080;">1584</span>             tcph-&gt;seqno() &lt;=<span style="color:#000000;"> last_ack_sent_) {
</span><span style="color:#008080;">1585</span>             <span style="color:#008000;">/*</span>
<span style="color:#008080;">1586</span> <span style="color:#008000;">             * this is the case where the ts value is newer than
</span><span style="color:#008080;">1587</span> <span style="color:#008000;">             * the last one we've seen, and the seq # is the one
</span><span style="color:#008080;">1588</span> <span style="color:#008000;">             * we expect [seqno == last_ack_sent_] or older
</span><span style="color:#008080;">1589</span>              <span style="color:#008000;">*/</span>
<span style="color:#008080;">1590</span>             recent_age_ =<span style="color:#000000;"> now();
</span><span style="color:#008080;">1591</span>             recent_ = tcph-&gt;<span style="color:#000000;">ts();
</span><span style="color:#008080;">1592</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">1593</span> 
<span style="color:#008080;">1594</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">1595</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> generate a stream of ecnecho bits until we see a true
</span><span style="color:#008080;">1596</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> cong_action bit
</span><span style="color:#008080;">1597</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">1598</span> 
<span style="color:#008080;">1599</span>             <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ecn_) {
</span><span style="color:#008080;">1600</span>                 <span style="color:#0000ff;">if</span> (fh-&gt;ce() &amp;&amp; fh-&gt;<span style="color:#000000;">ect()) {
</span><span style="color:#008080;">1601</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> no CWR from peer yet... arrange to
</span><span style="color:#008080;">1602</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> keep sending ECNECHO</span>
<span style="color:#008080;">1603</span>                     recent_ce_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">1604</span>                 } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (fh-&gt;<span style="color:#000000;">cwr()) {
</span><span style="color:#008080;">1605</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> got CWR response from peer.. stop
</span><span style="color:#008080;">1606</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> sending ECNECHO bits</span>
<span style="color:#008080;">1607</span>                     recent_ce_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">1608</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">1609</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">1610</span> 
<span style="color:#008080;">1611</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> Header predication basically looks to see
</span><span style="color:#008080;">1612</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if the incoming packet is an expected pure ACK
</span><span style="color:#008080;">1613</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> or an expected data segment</span>
<span style="color:#008080;">1614</span> 
<span style="color:#008080;">1615</span>         <span style="color:#0000ff;">if</span> (datalen == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1616</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> check for a received pure ACK in the correct range..
</span><span style="color:#008080;">1617</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> also checks to see if we are wnd_ limited
</span><span style="color:#008080;">1618</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> (we don't change cwnd at all below), plus
</span><span style="color:#008080;">1619</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> not being in fast recovery and not a partial ack.
</span><span style="color:#008080;">1620</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> If we are in fast
</span><span style="color:#008080;">1621</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> recovery, go below so we can remember to deflate
</span><span style="color:#008080;">1622</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> the window if we need to</span>
<span style="color:#008080;">1623</span>             <span style="color:#0000ff;">if</span> (ackno &gt; highest_ack_ &amp;&amp; ackno &lt; maxseq_ &amp;&amp;
<span style="color:#008080;">1624</span>                 cwnd_ &gt;= wnd_ &amp;&amp; !<span style="color:#000000;">fastrecov_) {
</span><span style="color:#008080;">1625</span>                 newack(pkt);    <span style="color:#008000;">//</span><span style="color:#008000;"> update timers,  highest_ack_</span>
<span style="color:#008080;">1626</span>                 send_much(<span style="color:#800080;">0</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;">1627</span> <span style="color:#000000;">                Packet::free(pkt);
</span><span style="color:#008080;">1628</span>                 <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">1629</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">1630</span>         } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (ackno == highest_ack_ &amp;&amp;<span style="color:#000000;"> rq_.empty()) {
</span><span style="color:#008080;">1631</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> check for pure incoming segment
</span><span style="color:#008080;">1632</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> the next data segment we're awaiting, and
</span><span style="color:#008080;">1633</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> that there's nothing sitting in the reassem-
</span><span style="color:#008080;">1634</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> bly queue
</span><span style="color:#008080;">1635</span>             <span style="color:#008000;">//</span><span style="color:#008000;">     give to "application" here
</span><span style="color:#008080;">1636</span>             <span style="color:#008000;">//</span><span style="color:#008000;">    note: DELACK is inspected only by
</span><span style="color:#008080;">1637</span>             <span style="color:#008000;">//</span><span style="color:#008000;">    tcp_fasttimo() in real tcp.  Every 200 ms
</span><span style="color:#008080;">1638</span>             <span style="color:#008000;">//</span><span style="color:#008000;">    this routine scans all tcpcb's looking for
</span><span style="color:#008080;">1639</span>             <span style="color:#008000;">//</span><span style="color:#008000;">    DELACK segments and when it finds them
</span><span style="color:#008080;">1640</span>             <span style="color:#008000;">//</span><span style="color:#008000;">    changes DELACK to ACKNOW and calls tcp_output()</span>
<span style="color:#008080;">1641</span>             rcv_nxt_ +=<span style="color:#000000;"> datalen;
</span><span style="color:#008080;">1642</span>             flags_ |=<span style="color:#000000;"> TF_DELACK;
</span><span style="color:#008080;">1643</span>             recvBytes(datalen); <span style="color:#008000;">//</span><span style="color:#008000;"> notify application of "delivery"
</span><span style="color:#008080;">1644</span>             <span style="color:#008000;">//</span>
<span style="color:#008080;">1645</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> special code here to simulate the operation
</span><span style="color:#008080;">1646</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> of a receiver who always consumes data,
</span><span style="color:#008080;">1647</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> resulting in a call to tcp_output</span>
<span style="color:#008080;">1648</span> <span style="color:#000000;">            Packet::free(pkt);
</span><span style="color:#008080;">1649</span>             <span style="color:#0000ff;">if</span><span style="color:#000000;"> (need_send())
</span><span style="color:#008080;">1650</span>                 send_much(<span style="color:#800080;">1</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;">1651</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">1652</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1653</span>     } <span style="color:#008000;">/*</span><span style="color:#008000;"> header prediction </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1654</span> 
<span style="color:#008080;">1655</span> 
<span style="color:#008080;">1656</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">1657</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> header prediction failed
</span><span style="color:#008080;">1658</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> (e.g. pure ACK out of valid range, SACK present, etc)...
</span><span style="color:#008080;">1659</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> do slow path processing
</span><span style="color:#008080;">1660</span> 
<span style="color:#008080;">1661</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">1662</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> the following switch does special things for these states:
</span><span style="color:#008080;">1663</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    TCPS_LISTEN, TCPS_SYN_SENT
</span><span style="color:#008080;">1664</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">1665</span> 
<span style="color:#008080;">1666</span>     <span style="color:#0000ff;">switch</span><span style="color:#000000;"> (state_) {
</span><span style="color:#008080;">1667</span> 
<span style="color:#008080;">1668</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1669</span> <span style="color:#008000;">         * If the segment contains an ACK then it is bad and do reset.
</span><span style="color:#008080;">1670</span> <span style="color:#008000;">         * If it does not contain a SYN then it is not interesting; drop it.
</span><span style="color:#008080;">1671</span> <span style="color:#008000;">         * Otherwise initialize tp-&gt;rcv_nxt, and tp-&gt;irs, iss is already
</span><span style="color:#008080;">1672</span> <span style="color:#008000;">     * selected, and send a segment:
</span><span style="color:#008080;">1673</span> <span style="color:#008000;">         *     &lt;SEQ=ISS&gt;&lt;ACK=RCV_NXT&gt;&lt;CTL=SYN,ACK&gt;
</span><span style="color:#008080;">1674</span> <span style="color:#008000;">         * Initialize tp-&gt;snd_nxt to tp-&gt;iss.
</span><span style="color:#008080;">1675</span> <span style="color:#008000;">         * Enter SYN_RECEIVED state, and process any other fields of this
</span><span style="color:#008080;">1676</span> <span style="color:#008000;">         * segment in this state.
</span><span style="color:#008080;">1677</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1678</span> 
<span style="color:#008080;">1679</span>     <span style="color:#0000ff;">case</span> TCPS_LISTEN:    <span style="color:#008000;">/*</span><span style="color:#008000;"> awaiting peer's SYN </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1680</span> 
<span style="color:#008080;">1681</span>         <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_ACK) {
</span><span style="color:#008080;">1682</span>                         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">1683</span> <span style="color:#000000;">                        fprintf(stderr,
</span><span style="color:#008080;">1684</span>                     <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s): warning: recv'd ACK while in LISTEN: </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">1685</span> <span style="color:#000000;">                    now(), name());
</span><span style="color:#008080;">1686</span> <span style="color:#000000;">                    prpkt(pkt);
</span><span style="color:#008080;">1687</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">1688</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> don't want ACKs in LISTEN</span>
<span style="color:#008080;">1689</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> dropwithreset;
</span><span style="color:#008080;">1690</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1691</span>         <span style="color:#0000ff;">if</span> ((tiflags &amp; TH_SYN) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1692</span>                         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">1693</span>                         fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s): warning: recv'd NON-SYN while in LISTEN\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">1694</span> <span style="color:#000000;">                now(), name());
</span><span style="color:#008080;">1695</span> <span style="color:#000000;">                    prpkt(pkt);
</span><span style="color:#008080;">1696</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">1697</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> any non-SYN is discarded</span>
<span style="color:#008080;">1698</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">1699</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1700</span> 
<span style="color:#008080;">1701</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1702</span> <span style="color:#008000;">         * must by a SYN (no ACK) at this point...
</span><span style="color:#008080;">1703</span> <span style="color:#008000;">         * in real tcp we would bump the iss counter here also
</span><span style="color:#008080;">1704</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1705</span> <span style="color:#000000;">        dooptions(pkt);
</span><span style="color:#008080;">1706</span>         irs_ = tcph-&gt;<span style="color:#000000;">seqno();
</span><span style="color:#008080;">1707</span>         t_seqno_ = iss_; <span style="color:#008000;">/*</span><span style="color:#008000;"> tcp_sendseqinit() macro in real tcp </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1708</span>         rcv_nxt_ =<span style="color:#000000;"> rcvseqinit(irs_, datalen);
</span><span style="color:#008080;">1709</span>         flags_ |=<span style="color:#000000;"> TF_ACKNOW;
</span><span style="color:#008080;">1710</span> 
<span style="color:#008080;">1711</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> check for a ECN-SYN with ECE|CWR</span>
<span style="color:#008080;">1712</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; fh-&gt;ecnecho() &amp;&amp; fh-&gt;<span style="color:#000000;">cong_action()) {
</span><span style="color:#008080;">1713</span>             ect_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">1714</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1715</span> 
<span style="color:#008080;">1716</span> 
<span style="color:#008080;">1717</span>         <span style="color:#0000ff;">if</span> (fid_ == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1718</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> XXX: sort of hack... If we do not
</span><span style="color:#008080;">1719</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> have a special flow ID, pick up that
</span><span style="color:#008080;">1720</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> of the sender (active opener)</span>
<span style="color:#008080;">1721</span>             hdr_ip* iph =<span style="color:#000000;"> hdr_ip::access(pkt);
</span><span style="color:#008080;">1722</span>             fid_ = iph-&gt;<span style="color:#000000;">flowid();
</span><span style="color:#008080;">1723</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1724</span> 
<span style="color:#008080;">1725</span> <span style="color:#000000;">        newstate(TCPS_SYN_RECEIVED);
</span><span style="color:#008080;">1726</span>         <span style="color:#0000ff;">goto</span><span style="color:#000000;"> trimthenstep6;
</span><span style="color:#008080;">1727</span> 
<span style="color:#008080;">1728</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1729</span> <span style="color:#008000;">         * If the state is SYN_SENT:
</span><span style="color:#008080;">1730</span> <span style="color:#008000;">         *      if seg contains an ACK, but not for our SYN, drop the input.
</span><span style="color:#008080;">1731</span> <span style="color:#008000;">         *      if seg does not contain SYN, then drop it.
</span><span style="color:#008080;">1732</span> <span style="color:#008000;">         * Otherwise this is an acceptable SYN segment
</span><span style="color:#008080;">1733</span> <span style="color:#008000;">         *      initialize tp-&gt;rcv_nxt and tp-&gt;irs
</span><span style="color:#008080;">1734</span> <span style="color:#008000;">         *      if seg contains ack then advance tp-&gt;snd_una
</span><span style="color:#008080;">1735</span> <span style="color:#008000;">         *      if SYN has been acked change to ESTABLISHED else SYN_RCVD state
</span><span style="color:#008080;">1736</span> <span style="color:#008000;">         *      arrange for segment to be acked (eventually)
</span><span style="color:#008080;">1737</span> <span style="color:#008000;">         *      continue processing rest of data/controls, beginning with URG
</span><span style="color:#008080;">1738</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1739</span> 
<span style="color:#008080;">1740</span>     <span style="color:#0000ff;">case</span> TCPS_SYN_SENT:    <span style="color:#008000;">/*</span><span style="color:#008000;"> we sent SYN, expecting SYN+ACK (or SYN) </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1741</span> 
<span style="color:#008080;">1742</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> drop if it's a SYN+ACK and the ack field is bad </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1743</span>         <span style="color:#0000ff;">if</span> ((tiflags &amp; TH_ACK) &amp;&amp;
<span style="color:#008080;">1744</span>             ((ackno &lt;= iss_) || (ackno &gt;<span style="color:#000000;"> maxseq_))) {
</span><span style="color:#008080;">1745</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> not an ACK for our SYN, discard</span>
<span style="color:#008080;">1746</span>                         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">1747</span>                    fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent::recv(%s): bad ACK for our SYN: </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">1748</span> <span style="color:#000000;">                    now(), name());
</span><span style="color:#008080;">1749</span> <span style="color:#000000;">                    prpkt(pkt);
</span><span style="color:#008080;">1750</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">1751</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> dropwithreset;
</span><span style="color:#008080;">1752</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1753</span> 
<span style="color:#008080;">1754</span>         <span style="color:#0000ff;">if</span> ((tiflags &amp; TH_SYN) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1755</span>                         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">1756</span>                     fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent::recv(%s): no SYN for our SYN: </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">1757</span> <span style="color:#000000;">                    now(), name());
</span><span style="color:#008080;">1758</span> <span style="color:#000000;">                    prpkt(pkt);
</span><span style="color:#008080;">1759</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">1760</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">1761</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1762</span> 
<span style="color:#008080;">1763</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> looks like an ok SYN or SYN+ACK </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1764</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> If ecn_syn_wait is set to 2:
</span><span style="color:#008080;">1765</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> Check if CE-marked SYN/ACK packet, then just send an ACK
</span><span style="color:#008080;">1766</span>                 <span style="color:#008000;">//</span><span style="color:#008000;">  packet with ECE set, and drop the SYN/ACK packet.
</span><span style="color:#008080;">1767</span>                 <span style="color:#008000;">//</span><span style="color:#008000;">  Don't update TCP state. </span>
<span style="color:#008080;">1768</span>         <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_ACK) 
</span><span style="color:#008080;">1769</span> <span style="color:#000000;">        {
</span><span style="color:#008080;">1770</span>                         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; fh-&gt;ecnecho() &amp;&amp; !fh-&gt;cong_action() &amp;&amp; ecn_syn_wait_ == <span style="color:#800080;">2</span><span style="color:#000000;">) 
</span><span style="color:#008080;">1771</span>                         <span style="color:#008000;">//</span><span style="color:#008000;"> if SYN/ACK packet and ecn_syn_wait_ == 2</span>
<span style="color:#008080;">1772</span> <span style="color:#000000;">            {
</span><span style="color:#008080;">1773</span>                         <span style="color:#0000ff;">if</span> ( fh-&gt;<span style="color:#000000;">ce() ) 
</span><span style="color:#008080;">1774</span>                                 <span style="color:#008000;">//</span><span style="color:#008000;"> If SYN/ACK packet is CE-marked</span>
<span style="color:#008080;">1775</span> <span style="color:#000000;">                {
</span><span style="color:#008080;">1776</span>                     <span style="color:#008000;">//</span><span style="color:#008000;">cancel_rtx_timer();
</span><span style="color:#008080;">1777</span>                     <span style="color:#008000;">//</span><span style="color:#008000;">newack(pkt);</span>
<span style="color:#008080;">1778</span> <span style="color:#000000;">                    set_rtx_timer();
</span><span style="color:#008080;">1779</span>                     sendpacket(t_seqno_, rcv_nxt_, TH_ACK|TH_ECE, <span style="color:#800080;">0</span>, <span style="color:#800080;">0</span><span style="color:#000000;">);
</span><span style="color:#008080;">1780</span>                     <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">1781</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">1782</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">1783</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1784</span> 
<span style="color:#008080;">1785</span> 
<span style="color:#008080;">1786</span> <span style="color:#000000;">#ifdef notdef
</span><span style="color:#008080;">1787</span> cancel_rtx_timer();    <span style="color:#008000;">//</span><span style="color:#008000;"> cancel timer on our 1st SYN [does this belong!?]</span>
<span style="color:#008080;">1788</span> <span style="color:#0000ff;">#endif</span>
<span style="color:#008080;">1789</span>         irs_ = tcph-&gt;seqno();    <span style="color:#008000;">//</span><span style="color:#008000;"> get initial recv'd seq #</span>
<span style="color:#008080;">1790</span>         rcv_nxt_ =<span style="color:#000000;"> rcvseqinit(irs_, datalen);
</span><span style="color:#008080;">1791</span> 
<span style="color:#008080;">1792</span>         <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_ACK) {
</span><span style="color:#008080;">1793</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> SYN+ACK (our SYN was acked)</span>
<span style="color:#008080;">1794</span>                         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; fh-&gt;ecnecho() &amp;&amp; !fh-&gt;<span style="color:#000000;">cong_action()) {
</span><span style="color:#008080;">1795</span>                                 ect_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">1796</span>                         <span style="color:#0000ff;">if</span> ( fh-&gt;<span style="color:#000000;">ce() ) 
</span><span style="color:#008080;">1797</span>                         recent_ce_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">1798</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">1799</span>             highest_ack_ =<span style="color:#000000;"> ackno;
</span><span style="color:#008080;">1800</span>             cwnd_ =<span style="color:#000000;"> initial_window();
</span><span style="color:#008080;">1801</span> 
<span style="color:#008080;">1802</span> <span style="color:#000000;">#ifdef notdef
</span><span style="color:#008080;">1803</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">1804</span> <span style="color:#008000;"> * if we didn't have to retransmit the SYN,
</span><span style="color:#008080;">1805</span> <span style="color:#008000;"> * use its rtt as our initial srtt &amp; rtt var.
</span><span style="color:#008080;">1806</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">1807</span> <span style="color:#0000ff;">if</span><span style="color:#000000;"> (t_rtt_) {
</span><span style="color:#008080;">1808</span>     <span style="color:#0000ff;">double</span> tao = now() - tcph-&gt;<span style="color:#000000;">ts();
</span><span style="color:#008080;">1809</span> <span style="color:#000000;">    rtt_update(tao);
</span><span style="color:#008080;">1810</span> <span style="color:#000000;">}
</span><span style="color:#008080;">1811</span> <span style="color:#0000ff;">#endif</span>
<span style="color:#008080;">1812</span> 
<span style="color:#008080;">1813</span>             <span style="color:#008000;">/*</span>
<span style="color:#008080;">1814</span> <span style="color:#008000;">             * if there's data, delay ACK; if there's also a FIN
</span><span style="color:#008080;">1815</span> <span style="color:#008000;">             * ACKNOW will be turned on later.
</span><span style="color:#008080;">1816</span>              <span style="color:#008000;">*/</span>
<span style="color:#008080;">1817</span>             <span style="color:#0000ff;">if</span> (datalen &gt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">1818</span>                 flags_ |= TF_DELACK;    <span style="color:#008000;">//</span><span style="color:#008000;"> data there: wait</span>
<span style="color:#008080;">1819</span>             } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">1820</span>                 flags_ |= TF_ACKNOW;    <span style="color:#008000;">//</span><span style="color:#008000;"> ACK peer's SYN</span>
<span style="color:#008080;">1821</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">1822</span> 
<span style="color:#008080;">1823</span>                         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1824</span> <span style="color:#008000;">                         * Received &lt;SYN,ACK&gt; in SYN_SENT[*] state.
</span><span style="color:#008080;">1825</span> <span style="color:#008000;">                         * Transitions:
</span><span style="color:#008080;">1826</span> <span style="color:#008000;">                         *      SYN_SENT  --&gt; ESTABLISHED
</span><span style="color:#008080;">1827</span> <span style="color:#008000;">                         *      SYN_SENT* --&gt; FIN_WAIT_1
</span><span style="color:#008080;">1828</span>                          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1829</span> 
<span style="color:#008080;">1830</span>             <span style="color:#0000ff;">if</span> (flags_ &amp;<span style="color:#000000;"> TF_NEEDFIN) {
</span><span style="color:#008080;">1831</span> <span style="color:#000000;">                newstate(TCPS_FIN_WAIT_1);
</span><span style="color:#008080;">1832</span>                 flags_ &amp;= ~<span style="color:#000000;">TF_NEEDFIN;
</span><span style="color:#008080;">1833</span>                 tiflags &amp;= ~<span style="color:#000000;">TH_SYN;
</span><span style="color:#008080;">1834</span>             } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">1835</span> <span style="color:#000000;">                newstate(TCPS_ESTABLISHED);
</span><span style="color:#008080;">1836</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">1837</span> 
<span style="color:#008080;">1838</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> special to ns:
</span><span style="color:#008080;">1839</span>             <span style="color:#008000;">//</span><span style="color:#008000;">  generate pure ACK here.
</span><span style="color:#008080;">1840</span>             <span style="color:#008000;">//</span><span style="color:#008000;">  this simulates the ordinary connection establishment
</span><span style="color:#008080;">1841</span>             <span style="color:#008000;">//</span><span style="color:#008000;">  where the ACK of the peer's SYN+ACK contains
</span><span style="color:#008080;">1842</span>             <span style="color:#008000;">//</span><span style="color:#008000;">  no data.  This is typically caused by the way
</span><span style="color:#008080;">1843</span>             <span style="color:#008000;">//</span><span style="color:#008000;">  the connect() socket call works in which the
</span><span style="color:#008080;">1844</span>             <span style="color:#008000;">//</span><span style="color:#008000;">  entire 3-way handshake occurs prior to the app
</span><span style="color:#008080;">1845</span>             <span style="color:#008000;">//</span><span style="color:#008000;">  being able to issue a write() [which actually
</span><span style="color:#008080;">1846</span>             <span style="color:#008000;">//</span><span style="color:#008000;">  causes the segment to be sent].</span>
<span style="color:#008080;">1847</span>             sendpacket(t_seqno_, rcv_nxt_, TH_ACK, <span style="color:#800080;">0</span>, <span style="color:#800080;">0</span><span style="color:#000000;">);
</span><span style="color:#008080;">1848</span>         } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">1849</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> Check ECN-SYN packet</span>
<span style="color:#008080;">1850</span>                         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; fh-&gt;ecnecho() &amp;&amp; fh-&gt;<span style="color:#000000;">cong_action())
</span><span style="color:#008080;">1851</span>                                 ect_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">1852</span> 
<span style="color:#008080;">1853</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> SYN (no ACK) (simultaneous active opens)</span>
<span style="color:#008080;">1854</span>             flags_ |=<span style="color:#000000;"> TF_ACKNOW;
</span><span style="color:#008080;">1855</span> <span style="color:#000000;">            cancel_rtx_timer();
</span><span style="color:#008080;">1856</span> <span style="color:#000000;">            newstate(TCPS_SYN_RECEIVED);
</span><span style="color:#008080;">1857</span>             <span style="color:#008000;">/*</span>
<span style="color:#008080;">1858</span> <span style="color:#008000;">             * decrement t_seqno_: we are sending a
</span><span style="color:#008080;">1859</span> <span style="color:#008000;">             * 2nd SYN (this time in the form of a
</span><span style="color:#008080;">1860</span> <span style="color:#008000;">             * SYN+ACK, so t_seqno_ will have been
</span><span style="color:#008080;">1861</span> <span style="color:#008000;">             * advanced to 2... reduce this
</span><span style="color:#008080;">1862</span>              <span style="color:#008000;">*/</span>
<span style="color:#008080;">1863</span>             t_seqno_--;    <span style="color:#008000;">//</span><span style="color:#008000;"> CHECKME</span>
<span style="color:#008080;">1864</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1865</span> 
<span style="color:#008080;">1866</span> <span style="color:#000000;">trimthenstep6:
</span><span style="color:#008080;">1867</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1868</span> <span style="color:#008000;">         * advance the seq# to correspond to first data byte
</span><span style="color:#008080;">1869</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1870</span>         tcph-&gt;seqno()++<span style="color:#000000;">;
</span><span style="color:#008080;">1871</span> 
<span style="color:#008080;">1872</span>         <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_ACK)
</span><span style="color:#008080;">1873</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> process_ACK;
</span><span style="color:#008080;">1874</span> 
<span style="color:#008080;">1875</span>         <span style="color:#0000ff;">goto</span><span style="color:#000000;"> step6;
</span><span style="color:#008080;">1876</span> 
<span style="color:#008080;">1877</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_LAST_ACK:
</span><span style="color:#008080;">1878</span>         <span style="color:#008000;">/*</span> 
<span style="color:#008080;">1879</span> <span style="color:#008000;">         * The only way we're in LAST_ACK is if we've already
</span><span style="color:#008080;">1880</span> <span style="color:#008000;">         * received a FIN, so ignore all retranmitted FINS.
</span><span style="color:#008080;">1881</span> <span style="color:#008000;">         * -M. Weigle 7/23/02
</span><span style="color:#008080;">1882</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1883</span>         <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_FIN) {
</span><span style="color:#008080;">1884</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">1885</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1886</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">1887</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_CLOSING:
</span><span style="color:#008080;">1888</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">1889</span>     } <span style="color:#008000;">/*</span><span style="color:#008000;"> end switch(state_) </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1890</span> 
<span style="color:#008080;">1891</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1892</span> <span style="color:#008000;">         * States other than LISTEN or SYN_SENT.
</span><span style="color:#008080;">1893</span> <span style="color:#008000;">         * First check timestamp, if present.
</span><span style="color:#008080;">1894</span> <span style="color:#008000;">         * Then check that at least some bytes of segment are within
</span><span style="color:#008080;">1895</span> <span style="color:#008000;">         * receive window.  If segment begins before rcv_nxt,
</span><span style="color:#008080;">1896</span> <span style="color:#008000;">         * drop leading data (and SYN); if nothing left, just ack.
</span><span style="color:#008080;">1897</span> <span style="color:#008000;">         *
</span><span style="color:#008080;">1898</span> <span style="color:#008000;">         * RFC 1323 PAWS: If we have a timestamp reply on this segment
</span><span style="color:#008080;">1899</span> <span style="color:#008000;">         * and it's less than ts_recent, drop it.
</span><span style="color:#008080;">1900</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1901</span> 
<span style="color:#008080;">1902</span>     <span style="color:#0000ff;">if</span> (ts_option_ &amp;&amp; !fh-&gt;no_ts_ &amp;&amp; recent_ &amp;&amp; tcph-&gt;ts() &lt;<span style="color:#000000;"> recent_) {
</span><span style="color:#008080;">1903</span>         <span style="color:#0000ff;">if</span> ((now() - recent_age_) &gt;<span style="color:#000000;"> TCP_PAWS_IDLE) {
</span><span style="color:#008080;">1904</span>             <span style="color:#008000;">/*</span>
<span style="color:#008080;">1905</span> <span style="color:#008000;">             * this is basically impossible in the simulator,
</span><span style="color:#008080;">1906</span> <span style="color:#008000;">             * but here it is...
</span><span style="color:#008080;">1907</span>              <span style="color:#008000;">*/</span>
<span style="color:#008080;">1908</span>                         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1909</span> <span style="color:#008000;">                         * Invalidate ts_recent.  If this segment updates
</span><span style="color:#008080;">1910</span> <span style="color:#008000;">                         * ts_recent, the age will be reset later and ts_recent
</span><span style="color:#008080;">1911</span> <span style="color:#008000;">                         * will get a valid value.  If it does not, setting
</span><span style="color:#008080;">1912</span> <span style="color:#008000;">                         * ts_recent to zero will at least satisfy the
</span><span style="color:#008080;">1913</span> <span style="color:#008000;">                         * requirement that zero be placed in the timestamp
</span><span style="color:#008080;">1914</span> <span style="color:#008000;">                         * echo reply when ts_recent isn't valid.  The
</span><span style="color:#008080;">1915</span> <span style="color:#008000;">                         * age isn't reset until we get a valid ts_recent
</span><span style="color:#008080;">1916</span> <span style="color:#008000;">                         * because we don't want out-of-order segments to be
</span><span style="color:#008080;">1917</span> <span style="color:#008000;">                         * dropped when ts_recent is old.
</span><span style="color:#008080;">1918</span>                          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1919</span>             recent_ = <span style="color:#800080;">0.0</span><span style="color:#000000;">;
</span><span style="color:#008080;">1920</span>         } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">1921</span>             fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s): dropped pkt due to bad ts\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">1922</span> <span style="color:#000000;">                now(), name());
</span><span style="color:#008080;">1923</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> dropafterack;
</span><span style="color:#008080;">1924</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1925</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">1926</span> 
<span style="color:#008080;">1927</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> check for redundant data at head/tail of segment
</span><span style="color:#008080;">1928</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    note that the 4.4bsd [Net/3] code has
</span><span style="color:#008080;">1929</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    a bug here which can cause us to ignore the
</span><span style="color:#008080;">1930</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    perfectly good ACKs on duplicate segments.  The
</span><span style="color:#008080;">1931</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    fix is described in (Stevens, Vol2, p. 959-960).
</span><span style="color:#008080;">1932</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    This code is based on that correction.
</span><span style="color:#008080;">1933</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">1934</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> In addition, it has a modification so that duplicate segments
</span><span style="color:#008080;">1935</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> with dup acks don't trigger a fast retransmit when dupseg_fix_
</span><span style="color:#008080;">1936</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> is enabled.
</span><span style="color:#008080;">1937</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">1938</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> Yet one more modification: make sure that if the received
</span><span style="color:#008080;">1939</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    segment had datalen=0 and wasn't a SYN or FIN that
</span><span style="color:#008080;">1940</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    we don't turn on the ACKNOW status bit.  If we were to
</span><span style="color:#008080;">1941</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    allow ACKNOW to be turned on, normal pure ACKs that happen
</span><span style="color:#008080;">1942</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    to have seq #s below rcv_nxt can trigger an ACK war by
</span><span style="color:#008080;">1943</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    forcing us to ACK the pure ACKs
</span><span style="color:#008080;">1944</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">1945</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> Update: if we have a dataless FIN, don't really want to
</span><span style="color:#008080;">1946</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> do anything with it.  In particular, would like to
</span><span style="color:#008080;">1947</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> avoid ACKing an incoming FIN+ACK while in CLOSING
</span><span style="color:#008080;">1948</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">1949</span>     todrop = rcv_nxt_ - tcph-&gt;seqno();  <span style="color:#008000;">//</span><span style="color:#008000;"> how much overlap?</span>
<span style="color:#008080;">1950</span> 
<span style="color:#008080;">1951</span>     <span style="color:#0000ff;">if</span> (todrop &gt; <span style="color:#800080;">0</span> &amp;&amp; ((tiflags &amp; (TH_SYN)) || datalen &gt; <span style="color:#800080;">0</span><span style="color:#000000;">)) {
</span><span style="color:#008080;">1952</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f(%s): trim 1..todrop:%d, dlen:%d\n",now(), name(), todrop, datalen);</span>
<span style="color:#008080;">1953</span>         <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_SYN) {
</span><span style="color:#008080;">1954</span>             tiflags &amp;= ~<span style="color:#000000;">TH_SYN;
</span><span style="color:#008080;">1955</span>             tcph-&gt;seqno()++<span style="color:#000000;">;
</span><span style="color:#008080;">1956</span>             th-&gt;size()--;    <span style="color:#008000;">//</span><span style="color:#008000;"> XXX Must decrease packet size too!!
</span><span style="color:#008080;">1957</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> Q: Why?.. this is only a SYN</span>
<span style="color:#008080;">1958</span>             todrop--<span style="color:#000000;">;
</span><span style="color:#008080;">1959</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1960</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">1961</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> see Stevens, vol 2, p. 960 for this check;
</span><span style="color:#008080;">1962</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> this check is to see if we are dropping
</span><span style="color:#008080;">1963</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> more than this segment (i.e. the whole pkt + a FIN),
</span><span style="color:#008080;">1964</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> or just the whole packet (no FIN)
</span><span style="color:#008080;">1965</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">1966</span>         <span style="color:#0000ff;">if</span> ((todrop &gt; datalen) ||
<span style="color:#008080;">1967</span>             (todrop == datalen &amp;&amp; ((tiflags &amp; TH_FIN) == <span style="color:#800080;">0</span><span style="color:#000000;">))) {
</span><span style="color:#008080;">1968</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f(%s): trim 2..todrop:%d, dlen:%d\n",now(), name(), todrop, datalen);</span>
<span style="color:#008080;">1969</span>                         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1970</span> <span style="color:#008000;">                         * Any valid FIN must be to the left of the window.
</span><span style="color:#008080;">1971</span> <span style="color:#008000;">                         * At this point the FIN must be a duplicate or out
</span><span style="color:#008080;">1972</span> <span style="color:#008000;">                         * of sequence; drop it.
</span><span style="color:#008080;">1973</span>                          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1974</span> 
<span style="color:#008080;">1975</span>             tiflags &amp;= ~<span style="color:#000000;">TH_FIN;
</span><span style="color:#008080;">1976</span> 
<span style="color:#008080;">1977</span>             <span style="color:#008000;">/*</span>
<span style="color:#008080;">1978</span> <span style="color:#008000;">             * Send an ACK to resynchronize and drop any data.
</span><span style="color:#008080;">1979</span> <span style="color:#008000;">             * But keep on processing for RST or ACK.
</span><span style="color:#008080;">1980</span>              <span style="color:#008000;">*/</span>
<span style="color:#008080;">1981</span> 
<span style="color:#008080;">1982</span>             flags_ |=<span style="color:#000000;"> TF_ACKNOW;
</span><span style="color:#008080;">1983</span>             todrop =<span style="color:#000000;"> datalen;
</span><span style="color:#008080;">1984</span>             dupseg = TRUE;    <span style="color:#008000;">//</span><span style="color:#008000;"> *completely* duplicate</span>
<span style="color:#008080;">1985</span> 
<span style="color:#008080;">1986</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">1987</span> 
<span style="color:#008080;">1988</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">1989</span> <span style="color:#008000;">         * Trim duplicate data from the front of the packet
</span><span style="color:#008080;">1990</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">1991</span> 
<span style="color:#008080;">1992</span>         tcph-&gt;seqno() +=<span style="color:#000000;"> todrop;
</span><span style="color:#008080;">1993</span>         th-&gt;size() -= todrop;    <span style="color:#008000;">//</span><span style="color:#008000;"> XXX Must decrease size too!!
</span><span style="color:#008080;">1994</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> why? [kf]..prob when put in RQ</span>
<span style="color:#008080;">1995</span>         datalen -=<span style="color:#000000;"> todrop;
</span><span style="color:#008080;">1996</span> 
<span style="color:#008080;">1997</span>     } <span style="color:#008000;">/*</span><span style="color:#008000;"> data trim </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">1998</span> 
<span style="color:#008080;">1999</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">2000</span> <span style="color:#008000;">     * If we are doing timstamps and this packet has one, and
</span><span style="color:#008080;">2001</span> <span style="color:#008000;">     * If last ACK falls within this segment's sequence numbers,
</span><span style="color:#008080;">2002</span> <span style="color:#008000;">     * record the timestamp.
</span><span style="color:#008080;">2003</span> <span style="color:#008000;">     * See RFC1323 (now RFC1323 bis)
</span><span style="color:#008080;">2004</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">2005</span>     <span style="color:#0000ff;">if</span> (ts_option_ &amp;&amp; !fh-&gt;no_ts_ &amp;&amp; tcph-&gt;seqno() &lt;=<span style="color:#000000;"> last_ack_sent_) {
</span><span style="color:#008080;">2006</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">2007</span> <span style="color:#008000;">         * this is the case where the ts value is newer than
</span><span style="color:#008080;">2008</span> <span style="color:#008000;">         * the last one we've seen, and the seq # is the one we expect
</span><span style="color:#008080;">2009</span> <span style="color:#008000;">         * [seqno == last_ack_sent_] or older
</span><span style="color:#008080;">2010</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2011</span>         recent_age_ =<span style="color:#000000;"> now();
</span><span style="color:#008080;">2012</span>         recent_ = tcph-&gt;<span style="color:#000000;">ts();
</span><span style="color:#008080;">2013</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2014</span> 
<span style="color:#008080;">2015</span>     <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_SYN) {
</span><span style="color:#008080;">2016</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">2017</span>                 fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent::recv(%s) received unexpected SYN (state:%d): </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2018</span> <span style="color:#000000;">                now(), name(), state_);
</span><span style="color:#008080;">2019</span> <span style="color:#000000;">                prpkt(pkt);
</span><span style="color:#008080;">2020</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">2021</span>         <span style="color:#0000ff;">goto</span><span style="color:#000000;"> dropwithreset;
</span><span style="color:#008080;">2022</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2023</span> 
<span style="color:#008080;">2024</span>     <span style="color:#0000ff;">if</span> ((tiflags &amp; TH_ACK) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2025</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">2026</span> <span style="color:#008000;">         * Added check for state != SYN_RECEIVED.  We will receive a 
</span><span style="color:#008080;">2027</span> <span style="color:#008000;">         * duplicate SYN in SYN_RECEIVED when our SYN/ACK was dropped.
</span><span style="color:#008080;">2028</span> <span style="color:#008000;">         * We should just ignore the duplicate SYN (our timeout for 
</span><span style="color:#008080;">2029</span> <span style="color:#008000;">         * resending the SYN/ACK is about the same as the client's 
</span><span style="color:#008080;">2030</span> <span style="color:#008000;">         * timeout for resending the SYN), but give no error message. 
</span><span style="color:#008080;">2031</span> <span style="color:#008000;">         * -M. Weigle 07/24/01
</span><span style="color:#008080;">2032</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2033</span>         <span style="color:#0000ff;">if</span> (state_ !=<span style="color:#000000;"> TCPS_SYN_RECEIVED) {
</span><span style="color:#008080;">2034</span>                         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">2035</span>                     fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent::recv(%s) got packet lacking ACK (state:%d): </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2036</span> <span style="color:#000000;">                now(), name(), state_);
</span><span style="color:#008080;">2037</span> <span style="color:#000000;">                    prpkt(pkt);
</span><span style="color:#008080;">2038</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">2039</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2040</span>         <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">2041</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2042</span> 
<span style="color:#008080;">2043</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">2044</span> <span style="color:#008000;">     * Ack processing.
</span><span style="color:#008080;">2045</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">2046</span> 
<span style="color:#008080;">2047</span>     <span style="color:#0000ff;">switch</span><span style="color:#000000;"> (state_) {
</span><span style="color:#008080;">2048</span>     <span style="color:#0000ff;">case</span> TCPS_SYN_RECEIVED:    <span style="color:#008000;">/*</span><span style="color:#008000;"> want ACK for our SYN+ACK </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2049</span>         <span style="color:#0000ff;">if</span> (ackno &lt; highest_ack_ || ackno &gt;<span style="color:#000000;"> maxseq_) {
</span><span style="color:#008080;">2050</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> not in useful range</span>
<span style="color:#008080;">2051</span>                         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">2052</span>                         fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s): ack(%d) not in range while in SYN_RECEIVED: </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2053</span> <span style="color:#000000;">                 now(), name(), ackno);
</span><span style="color:#008080;">2054</span> <span style="color:#000000;">                    prpkt(pkt);
</span><span style="color:#008080;">2055</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">2056</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> dropwithreset;
</span><span style="color:#008080;">2057</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2058</span> 
<span style="color:#008080;">2059</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; ect_ &amp;&amp; ecn_syn_ &amp;&amp; fh-&gt;ecnecho() &amp;&amp; ecn_syn_wait_ == <span style="color:#800080;">2</span><span style="color:#000000;">) 
</span><span style="color:#008080;">2060</span> <span style="color:#000000;">        {
</span><span style="color:#008080;">2061</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> The SYN/ACK packet was ECN-marked.
</span><span style="color:#008080;">2062</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> Reset the rtx timer, send another SYN/ACK packet
</span><span style="color:#008080;">2063</span>                 <span style="color:#008000;">//</span><span style="color:#008000;">  immediately, and drop the ACK packet.
</span><span style="color:#008080;">2064</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> Do not move to TCPS_ESTB state or update TCP variables.</span>
<span style="color:#008080;">2065</span> <span style="color:#000000;">            cancel_rtx_timer();
</span><span style="color:#008080;">2066</span>             ecn_syn_next_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2067</span> <span style="color:#000000;">            foutput(iss_, REASON_NORMAL);
</span><span style="color:#008080;">2068</span>             wnd_init_option_ = <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;">2069</span>                         wnd_init_ = <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;">2070</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">2071</span> <span style="color:#000000;">        } 
</span><span style="color:#008080;">2072</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; ect_ &amp;&amp; ecn_syn_ &amp;&amp; fh-&gt;ecnecho() &amp;&amp; ecn_syn_wait_ &lt; <span style="color:#800080;">2</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2073</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> The SYN/ACK packet was ECN-marked.</span>
<span style="color:#008080;">2074</span>             <span style="color:#0000ff;">if</span> (ecn_syn_wait_ == <span style="color:#800080;">1</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2075</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> A timer will be called in ecn().</span>
<span style="color:#008080;">2076</span>                 cwnd_ = <span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;">2077</span>                 use_rtt_ = <span style="color:#800080;">1</span>; <span style="color:#008000;">//</span><span style="color:#008000;">KK, wait for timeout() period</span>
<span style="color:#008080;">2078</span>             } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2079</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> Congestion window will be halved in ecn().</span>
<span style="color:#008080;">2080</span>                 cwnd_ = <span style="color:#800080;">2</span><span style="color:#000000;">;
</span><span style="color:#008080;">2081</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">2082</span>         } <span style="color:#0000ff;">else</span><span style="color:#000000;">  {
</span><span style="color:#008080;">2083</span>             cwnd_ =<span style="color:#000000;"> initial_window();
</span><span style="color:#008080;">2084</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2085</span>     
<span style="color:#008080;">2086</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2087</span> <span style="color:#008000;">                 * Make transitions:
</span><span style="color:#008080;">2088</span> <span style="color:#008000;">                 *      SYN-RECEIVED  -&gt; ESTABLISHED
</span><span style="color:#008080;">2089</span> <span style="color:#008000;">                 *      SYN-RECEIVED* -&gt; FIN-WAIT-1
</span><span style="color:#008080;">2090</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2091</span>                 <span style="color:#0000ff;">if</span> (flags_ &amp;<span style="color:#000000;"> TF_NEEDFIN) {
</span><span style="color:#008080;">2092</span> <span style="color:#000000;">            newstate(TCPS_FIN_WAIT_1);
</span><span style="color:#008080;">2093</span>                         flags_ &amp;= ~<span style="color:#000000;">TF_NEEDFIN;
</span><span style="color:#008080;">2094</span>                 } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2095</span> <span style="color:#000000;">                        newstate(TCPS_ESTABLISHED);
</span><span style="color:#008080;">2096</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">2097</span> 
<span style="color:#008080;">2098</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> fall into ... </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2099</span> 
<span style="color:#008080;">2100</span> 
<span style="color:#008080;">2101</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">2102</span> <span style="color:#008000;">         * In ESTABLISHED state: drop duplicate ACKs; ACK out of range
</span><span style="color:#008080;">2103</span> <span style="color:#008000;">         * ACKs.  If the ack is in the range
</span><span style="color:#008080;">2104</span> <span style="color:#008000;">         *      tp-&gt;snd_una &lt; ti-&gt;ti_ack &lt;= tp-&gt;snd_max
</span><span style="color:#008080;">2105</span> <span style="color:#008000;">         * then advance tp-&gt;snd_una to ti-&gt;ti_ack and drop
</span><span style="color:#008080;">2106</span> <span style="color:#008000;">         * data from the retransmission queue.
</span><span style="color:#008080;">2107</span> <span style="color:#008000;">     *
</span><span style="color:#008080;">2108</span> <span style="color:#008000;">     * note that state TIME_WAIT isn't used
</span><span style="color:#008080;">2109</span> <span style="color:#008000;">     * in the simulator
</span><span style="color:#008080;">2110</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2111</span> 
<span style="color:#008080;">2112</span>         <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_ESTABLISHED:
</span><span style="color:#008080;">2113</span>         <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_FIN_WAIT_1:
</span><span style="color:#008080;">2114</span>         <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_FIN_WAIT_2:
</span><span style="color:#008080;">2115</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_CLOSE_WAIT:
</span><span style="color:#008080;">2116</span>         <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_CLOSING:
</span><span style="color:#008080;">2117</span>         <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_LAST_ACK:
</span><span style="color:#008080;">2118</span> 
<span style="color:#008080;">2119</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">2120</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> look for ECNs in ACKs, react as necessary
</span><span style="color:#008080;">2121</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">2122</span> 
<span style="color:#008080;">2123</span>         <span style="color:#0000ff;">if</span> (fh-&gt;ecnecho() &amp;&amp; (!ecn_ || !<span style="color:#000000;">ect_)) {
</span><span style="color:#008080;">2124</span> <span style="color:#000000;">            fprintf(stderr,
</span><span style="color:#008080;">2125</span>                 <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcp(%s): warning, recvd ecnecho but I am not ECN capable!\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2126</span> <span style="color:#000000;">                now(), name());
</span><span style="color:#008080;">2127</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2128</span> 
<span style="color:#008080;">2129</span>                 <span style="color:#008000;">//</span>
<span style="color:#008080;">2130</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> generate a stream of ecnecho bits until we see a true
</span><span style="color:#008080;">2131</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> cong_action bit
</span><span style="color:#008080;">2132</span>                 <span style="color:#008000;">//</span> 
<span style="color:#008080;">2133</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ecn_) {
</span><span style="color:#008080;">2134</span>                         <span style="color:#0000ff;">if</span> (fh-&gt;ce() &amp;&amp; fh-&gt;<span style="color:#000000;">ect())
</span><span style="color:#008080;">2135</span>                                 recent_ce_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">2136</span>                         <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (fh-&gt;<span style="color:#000000;">cwr()) 
</span><span style="color:#008080;">2137</span>                                 recent_ce_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2138</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">2139</span> 
<span style="color:#008080;">2140</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">2141</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> If ESTABLISHED or starting to close, process SACKS
</span><span style="color:#008080;">2142</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">2143</span> 
<span style="color:#008080;">2144</span>         <span style="color:#0000ff;">if</span> (state_ &gt;= TCPS_ESTABLISHED &amp;&amp; tcph-&gt;sa_length() &gt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2145</span> <span style="color:#000000;">            process_sack(tcph);
</span><span style="color:#008080;">2146</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2147</span> 
<span style="color:#008080;">2148</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">2149</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> ACK indicates packet left the network
</span><span style="color:#008080;">2150</span>         <span style="color:#008000;">//</span><span style="color:#008000;">    try not to be fooled by data
</span><span style="color:#008080;">2151</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">2152</span> 
<span style="color:#008080;">2153</span>         <span style="color:#0000ff;">if</span> (fastrecov_ &amp;&amp; (datalen == <span style="color:#800080;">0</span> || ackno &gt;<span style="color:#000000;"> highest_ack_))
</span><span style="color:#008080;">2154</span>             pipe_ -=<span style="color:#000000;"> maxseg_;
</span><span style="color:#008080;">2155</span> 
<span style="color:#008080;">2156</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> look for dup ACKs (dup ack numbers, no data)
</span><span style="color:#008080;">2157</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">2158</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> do fast retransmit/recovery if at/past thresh</span>
<span style="color:#008080;">2159</span>         <span style="color:#0000ff;">if</span> (ackno &lt;=<span style="color:#000000;"> highest_ack_) {
</span><span style="color:#008080;">2160</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> a pure ACK which doesn't advance highest_ack_</span>
<span style="color:#008080;">2161</span>             <span style="color:#0000ff;">if</span> (datalen == <span style="color:#800080;">0</span> &amp;&amp; (!dupseg_fix_ || !<span style="color:#000000;">dupseg)) {
</span><span style="color:#008080;">2162</span> 
<span style="color:#008080;">2163</span>                                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2164</span> <span style="color:#008000;">                                 * If we have outstanding data
</span><span style="color:#008080;">2165</span> <span style="color:#008000;">                                 * this is a completely
</span><span style="color:#008080;">2166</span> <span style="color:#008000;">                                 * duplicate ack,
</span><span style="color:#008080;">2167</span> <span style="color:#008000;">                                 * the ack is the biggest we've
</span><span style="color:#008080;">2168</span> <span style="color:#008000;">                                 * seen and we've seen exactly our rexmt
</span><span style="color:#008080;">2169</span> <span style="color:#008000;">                                 * threshhold of them, assume a packet
</span><span style="color:#008080;">2170</span> <span style="color:#008000;">                                 * has been dropped and retransmit it.
</span><span style="color:#008080;">2171</span> <span style="color:#008000;">                                 *
</span><span style="color:#008080;">2172</span> <span style="color:#008000;">                                 * We know we're losing at the current
</span><span style="color:#008080;">2173</span> <span style="color:#008000;">                                 * window size so do congestion avoidance.
</span><span style="color:#008080;">2174</span> <span style="color:#008000;">                                 *
</span><span style="color:#008080;">2175</span> <span style="color:#008000;">                                 * Dup acks mean that packets have left the
</span><span style="color:#008080;">2176</span> <span style="color:#008000;">                                 * network (they're now cached at the receiver)
</span><span style="color:#008080;">2177</span> <span style="color:#008000;">                                 * so bump cwnd by the amount in the receiver
</span><span style="color:#008080;">2178</span> <span style="color:#008000;">                                 * to keep a constant cwnd packets in the
</span><span style="color:#008080;">2179</span> <span style="color:#008000;">                                 * network.
</span><span style="color:#008080;">2180</span>                                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2181</span> 
<span style="color:#008080;">2182</span>                 <span style="color:#0000ff;">if</span> ((rtx_timer_.status() != TIMER_PENDING) ||
<span style="color:#008080;">2183</span>                     ackno &lt;<span style="color:#000000;"> highest_ack_) {
</span><span style="color:#008080;">2184</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> Q: significance of timer not pending?
</span><span style="color:#008080;">2185</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> ACK below highest_ack_</span>
<span style="color:#008080;">2186</span> <span style="color:#000000;">                    oldack();
</span><span style="color:#008080;">2187</span>                 } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (++dupacks_ ==<span style="color:#000000;"> tcprexmtthresh_) {
</span><span style="color:#008080;">2188</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> ACK at highest_ack_ AND meets threshold
</span><span style="color:#008080;">2189</span>                     <span style="color:#008000;">//</span><span style="color:#008000;">trace_event("FAST_RECOVERY");</span>
<span style="color:#008080;">2190</span>                     dupack_action(); <span style="color:#008000;">//</span><span style="color:#008000;"> maybe fast rexmt</span>
<span style="color:#008080;">2191</span>                     <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">2192</span> 
<span style="color:#008080;">2193</span>                 } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (dupacks_ &gt;<span style="color:#000000;"> tcprexmtthresh_) {
</span><span style="color:#008080;">2194</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> ACK at highest_ack_ AND above threshole
</span><span style="color:#008080;">2195</span>                     <span style="color:#008000;">//</span><span style="color:#008000;">trace_event("FAST_RECOVERY");</span>
<span style="color:#008080;">2196</span> <span style="color:#000000;">                    extra_ack();
</span><span style="color:#008080;">2197</span> 
<span style="color:#008080;">2198</span>                     <span style="color:#008000;">//</span><span style="color:#008000;"> send whatever window allows</span>
<span style="color:#008080;">2199</span>                     send_much(<span style="color:#800080;">0</span><span style="color:#000000;">, REASON_DUPACK, maxburst_);
</span><span style="color:#008080;">2200</span>                     <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">2201</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">2202</span>             } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2203</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> non zero-length [dataful] segment
</span><span style="color:#008080;">2204</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> with a dup ack (normal for dataful segs)
</span><span style="color:#008080;">2205</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> (or window changed in real TCP).</span>
<span style="color:#008080;">2206</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (dupack_reset_) {
</span><span style="color:#008080;">2207</span>                     dupacks_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2208</span>                     fastrecov_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2209</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">2210</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">2211</span>             <span style="color:#0000ff;">break</span>;    <span style="color:#008000;">/*</span><span style="color:#008000;"> take us to "step6" </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2212</span>         } <span style="color:#008000;">/*</span><span style="color:#008000;"> end of dup/old acks </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2213</span> 
<span style="color:#008080;">2214</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">2215</span> <span style="color:#008000;">         * we've finished the fast retransmit/recovery period
</span><span style="color:#008080;">2216</span> <span style="color:#008000;">         * (i.e. received an ACK which advances highest_ack_)
</span><span style="color:#008080;">2217</span> <span style="color:#008000;">         * The ACK may be "good" or "partial"
</span><span style="color:#008080;">2218</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2219</span> 
<span style="color:#008080;">2220</span> <span style="color:#000000;">process_ACK:
</span><span style="color:#008080;">2221</span> 
<span style="color:#008080;">2222</span>         <span style="color:#0000ff;">if</span> (ackno &gt;<span style="color:#000000;"> maxseq_) {
</span><span style="color:#008080;">2223</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> ack more than we sent(!?)</span>
<span style="color:#008080;">2224</span>                         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">2225</span>                     fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent::recv(%s) too-big ACK (maxseq:%d): </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2226</span>                 now(), name(), <span style="color:#0000ff;">int</span><span style="color:#000000;">(maxseq_));
</span><span style="color:#008080;">2227</span> <span style="color:#000000;">                    prpkt(pkt);
</span><span style="color:#008080;">2228</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">2229</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> dropafterack;
</span><span style="color:#008080;">2230</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2231</span> 
<span style="color:#008080;">2232</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2233</span> <span style="color:#008000;">                 * If we have a timestamp reply, update smoothed
</span><span style="color:#008080;">2234</span> <span style="color:#008000;">                 * round trip time.  If no timestamp is present but
</span><span style="color:#008080;">2235</span> <span style="color:#008000;">                 * transmit timer is running and timed sequence
</span><span style="color:#008080;">2236</span> <span style="color:#008000;">                 * number was acked, update smoothed round trip time.
</span><span style="color:#008080;">2237</span> <span style="color:#008000;">                 * Since we now have an rtt measurement, cancel the
</span><span style="color:#008080;">2238</span> <span style="color:#008000;">                 * timer backoff (cf., Phil Karn's retransmit alg.).
</span><span style="color:#008080;">2239</span> <span style="color:#008000;">                 * Recompute the initial retransmit timer.
</span><span style="color:#008080;">2240</span> <span style="color:#008000;">         *
</span><span style="color:#008080;">2241</span> <span style="color:#008000;">                 * If all outstanding data is acked, stop retransmit
</span><span style="color:#008080;">2242</span> <span style="color:#008000;">                 * If there is more data to be acked, restart retransmit
</span><span style="color:#008080;">2243</span> <span style="color:#008000;">                 * timer, using current (possibly backed-off) value.
</span><span style="color:#008080;">2244</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2245</span>         newack(pkt);    <span style="color:#008000;">//</span><span style="color:#008000;"> handle timers, update highest_ack_</span>
<span style="color:#008080;">2246</span> 
<span style="color:#008080;">2247</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">2248</span> <span style="color:#008000;">         * if this is a partial ACK, invoke whatever we should
</span><span style="color:#008080;">2249</span> <span style="color:#008000;">         * note that newack() must be called before the action
</span><span style="color:#008080;">2250</span> <span style="color:#008000;">         * functions, as some of them depend on side-effects
</span><span style="color:#008080;">2251</span> <span style="color:#008000;">         * of newack()
</span><span style="color:#008080;">2252</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2253</span> 
<span style="color:#008080;">2254</span>         <span style="color:#0000ff;">int</span> <span style="color:#0000ff;">partial</span> =<span style="color:#000000;"> pack(pkt);
</span><span style="color:#008080;">2255</span> 
<span style="color:#008080;">2256</span>         <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">partial</span><span style="color:#000000;">)
</span><span style="color:#008080;">2257</span> <span style="color:#000000;">            pack_action(pkt);
</span><span style="color:#008080;">2258</span>         <span style="color:#0000ff;">else</span>
<span style="color:#008080;">2259</span> <span style="color:#000000;">            ack_action(pkt);
</span><span style="color:#008080;">2260</span> 
<span style="color:#008080;">2261</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">2262</span> <span style="color:#008000;">         * if this is an ACK with an ECN indication, handle this
</span><span style="color:#008080;">2263</span> <span style="color:#008000;">         * but not if it is a syn packet
</span><span style="color:#008080;">2264</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2265</span>         <span style="color:#0000ff;">if</span> (fh-&gt;ecnecho() &amp;&amp; !(tiflags&amp;<span style="color:#000000;">TH_SYN) )
</span><span style="color:#008080;">2266</span>         <span style="color:#0000ff;">if</span> (fh-&gt;<span style="color:#000000;">ecnecho()) {
</span><span style="color:#008080;">2267</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> Note from Sally: In one-way TCP,
</span><span style="color:#008080;">2268</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> ecn() is called before newack()...</span>
<span style="color:#008080;">2269</span>             ecn(highest_ack_);  <span style="color:#008000;">//</span><span style="color:#008000;"> updated by newack(), above
</span><span style="color:#008080;">2270</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> "set_rtx_timer();" from T. Kelly.</span>
<span style="color:#008080;">2271</span>             <span style="color:#0000ff;">if</span> (cwnd_ &lt; <span style="color:#800080;">1</span><span style="color:#000000;">)
</span><span style="color:#008080;">2272</span> <span style="color:#000000;">                 set_rtx_timer();
</span><span style="color:#008080;">2273</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2274</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> CHECKME: handling of rtx timer</span>
<span style="color:#008080;">2275</span>         <span style="color:#0000ff;">if</span> (ackno ==<span style="color:#000000;"> maxseq_) {
</span><span style="color:#008080;">2276</span>             needoutput =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">2277</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2278</span> 
<span style="color:#008080;">2279</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">2280</span> <span style="color:#008000;">         * If no data (only SYN) was ACK'd,
</span><span style="color:#008080;">2281</span> <span style="color:#008000;">         *    skip rest of ACK processing.
</span><span style="color:#008080;">2282</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2283</span>         <span style="color:#0000ff;">if</span> (ackno == (highest_ack_ + <span style="color:#800080;">1</span><span style="color:#000000;">))
</span><span style="color:#008080;">2284</span>             <span style="color:#0000ff;">goto</span><span style="color:#000000;"> step6;
</span><span style="color:#008080;">2285</span> 
<span style="color:#008080;">2286</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if we are delaying initial cwnd growth (probably due to
</span><span style="color:#008080;">2287</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> large initial windows), then only open cwnd if data has
</span><span style="color:#008080;">2288</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> been received
</span><span style="color:#008080;">2289</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> Q: check when this happens</span>
<span style="color:#008080;">2290</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2291</span> <span style="color:#008000;">                 * When new data is acked, open the congestion window.
</span><span style="color:#008080;">2292</span> <span style="color:#008000;">                 * If the window gives us less than ssthresh packets
</span><span style="color:#008080;">2293</span> <span style="color:#008000;">                 * in flight, open exponentially (maxseg per packet).
</span><span style="color:#008080;">2294</span> <span style="color:#008000;">                 * Otherwise open about linearly: maxseg per window
</span><span style="color:#008080;">2295</span> <span style="color:#008000;">                 * (maxseg^2 / cwnd per packet).
</span><span style="color:#008080;">2296</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2297</span>         <span style="color:#0000ff;">if</span> ((!delay_growth_ || (rcv_nxt_ &gt; <span style="color:#800080;">0</span>)) &amp;&amp;
<span style="color:#008080;">2298</span>             last_state_ ==<span style="color:#000000;"> TCPS_ESTABLISHED) {
</span><span style="color:#008080;">2299</span>             <span style="color:#0000ff;">if</span> (!<span style="color:#0000ff;">partial</span> ||<span style="color:#000000;"> open_cwnd_on_pack_) {
</span><span style="color:#008080;">2300</span>                            <span style="color:#0000ff;">if</span> (!ect_ || !hdr_flags::access(pkt)-&gt;<span style="color:#000000;">ecnecho())
</span><span style="color:#008080;">2301</span> <span style="color:#000000;">                opencwnd();
</span><span style="color:#008080;">2302</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">2303</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2304</span> 
<span style="color:#008080;">2305</span>         <span style="color:#0000ff;">if</span> ((state_ &gt;= TCPS_FIN_WAIT_1) &amp;&amp; (ackno ==<span style="color:#000000;"> maxseq_)) {
</span><span style="color:#008080;">2306</span>             ourfinisacked =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">2307</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2308</span> 
<span style="color:#008080;">2309</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">2310</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> special additional processing when our state
</span><span style="color:#008080;">2311</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> is one of the closing states:
</span><span style="color:#008080;">2312</span>         <span style="color:#008000;">//</span><span style="color:#008000;">    FIN_WAIT_1, CLOSING, LAST_ACK</span>
<span style="color:#008080;">2313</span> 
<span style="color:#008080;">2314</span>         <span style="color:#0000ff;">switch</span><span style="color:#000000;"> (state_) {
</span><span style="color:#008080;">2315</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2316</span> <span style="color:#008000;">                 * In FIN_WAIT_1 STATE in addition to the processing
</span><span style="color:#008080;">2317</span> <span style="color:#008000;">                 * for the ESTABLISHED state if our FIN is now acknowledged
</span><span style="color:#008080;">2318</span> <span style="color:#008000;">                 * then enter FIN_WAIT_2.
</span><span style="color:#008080;">2319</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2320</span>         <span style="color:#0000ff;">case</span> TCPS_FIN_WAIT_1:    <span style="color:#008000;">/*</span><span style="color:#008000;"> doing active close </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2321</span>             <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ourfinisacked) {
</span><span style="color:#008080;">2322</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> got the ACK, now await incoming FIN</span>
<span style="color:#008080;">2323</span> <span style="color:#000000;">                newstate(TCPS_FIN_WAIT_2);
</span><span style="color:#008080;">2324</span> <span style="color:#000000;">                cancel_timers();
</span><span style="color:#008080;">2325</span>                 needoutput =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2326</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">2327</span>             <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">2328</span> 
<span style="color:#008080;">2329</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2330</span> <span style="color:#008000;">                 * In CLOSING STATE in addition to the processing for
</span><span style="color:#008080;">2331</span> <span style="color:#008000;">                 * the ESTABLISHED state if the ACK acknowledges our FIN
</span><span style="color:#008080;">2332</span> <span style="color:#008000;">                 * then enter the TIME-WAIT state, otherwise ignore
</span><span style="color:#008080;">2333</span> <span style="color:#008000;">                 * the segment.
</span><span style="color:#008080;">2334</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2335</span>         <span style="color:#0000ff;">case</span> TCPS_CLOSING:    <span style="color:#008000;">/*</span><span style="color:#008000;"> simultaneous active close </span><span style="color:#008000;">*/</span><span style="color:#000000;">;
</span><span style="color:#008080;">2336</span>             <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ourfinisacked) {
</span><span style="color:#008080;">2337</span> <span style="color:#000000;">                newstate(TCPS_CLOSED);
</span><span style="color:#008080;">2338</span> <span style="color:#000000;">                cancel_timers();
</span><span style="color:#008080;">2339</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">2340</span>             <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">2341</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2342</span> <span style="color:#008000;">                 * In LAST_ACK, we may still be waiting for data to drain
</span><span style="color:#008080;">2343</span> <span style="color:#008000;">                 * and/or to be acked, as well as for the ack of our FIN.
</span><span style="color:#008080;">2344</span> <span style="color:#008000;">                 * If our FIN is now acknowledged,
</span><span style="color:#008080;">2345</span> <span style="color:#008000;">                 * enter the closed state and return.
</span><span style="color:#008080;">2346</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2347</span>         <span style="color:#0000ff;">case</span> TCPS_LAST_ACK:    <span style="color:#008000;">/*</span><span style="color:#008000;"> passive close </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2348</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> K: added state change here</span>
<span style="color:#008080;">2349</span>             <span style="color:#0000ff;">if</span><span style="color:#000000;"> (ourfinisacked) {
</span><span style="color:#008080;">2350</span> <span style="color:#000000;">                newstate(TCPS_CLOSED);
</span><span style="color:#008080;">2351</span>                 finish(); <span style="color:#008000;">//</span><span style="color:#008000;"> cancels timers, erc</span>
<span style="color:#008080;">2352</span>                 reset(); <span style="color:#008000;">//</span><span style="color:#008000;"> for connection re-use (bug fix from ns-users list)</span>
<span style="color:#008080;">2353</span>                 <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">2354</span>             } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2355</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> should be a FIN we've seen</span>
<span style="color:#008080;">2356</span>                                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">2357</span>                                         fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s)::received non-ACK (state:%d): </span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2358</span> <span style="color:#000000;">                                        now(), name(), state_);
</span><span style="color:#008080;">2359</span> <span style="color:#000000;">                        prpkt(pkt);
</span><span style="color:#008080;">2360</span> <span style="color:#000000;">                                }
</span><span style="color:#008080;">2361</span> <span style="color:#000000;">                        }
</span><span style="color:#008080;">2362</span>             <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">2363</span> 
<span style="color:#008080;">2364</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> no case for TIME_WAIT in simulator </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2365</span>         }  <span style="color:#008000;">//</span><span style="color:#008000;"> inner state_ switch (closing states)</span>
<span style="color:#008080;">2366</span>     } <span style="color:#008000;">//</span><span style="color:#008000;"> outer state_ switch (ack processing)</span>
<span style="color:#008080;">2367</span> 
<span style="color:#008080;">2368</span> <span style="color:#000000;">step6:
</span><span style="color:#008080;">2369</span> 
<span style="color:#008080;">2370</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">2371</span> <span style="color:#008000;">     * Processing of incoming DATAful segments.
</span><span style="color:#008080;">2372</span> <span style="color:#008000;">     *     Code above has already trimmed redundant data.
</span><span style="color:#008080;">2373</span> <span style="color:#008000;">     *
</span><span style="color:#008080;">2374</span> <span style="color:#008000;">     * real TCP handles window updates and URG data here also
</span><span style="color:#008080;">2375</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">2376</span> 
<span style="color:#008080;">2377</span> <span style="color:#008000;">/*</span><span style="color:#008000;"> dodata: this label is in the "real" code.. here only for reference </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2378</span> 
<span style="color:#008080;">2379</span>     <span style="color:#0000ff;">if</span> ((datalen &gt; <span style="color:#800080;">0</span> || (tiflags &amp; TH_FIN)) &amp;&amp;
<span style="color:#008080;">2380</span>         TCPS_HAVERCVDFIN(state_) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2381</span> 
<span style="color:#008080;">2382</span>         <span style="color:#008000;">//</span>
<span style="color:#008080;">2383</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> the following 'if' implements the "real" TCP
</span><span style="color:#008080;">2384</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> TCP_REASS macro
</span><span style="color:#008080;">2385</span>         <span style="color:#008000;">//
</span><span style="color:#008080;">2386</span> 
<span style="color:#008080;">2387</span>         <span style="color:#0000ff;">if</span> (tcph-&gt;seqno() == rcv_nxt_ &amp;&amp;<span style="color:#000000;"> rq_.empty()) {
</span><span style="color:#008080;">2388</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> got the in-order packet we were looking
</span><span style="color:#008080;">2389</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> for, nobody is in the reassembly queue,
</span><span style="color:#008080;">2390</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> so this is the common case...
</span><span style="color:#008080;">2391</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> note: in "real" TCP we must also be in
</span><span style="color:#008080;">2392</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> ESTABLISHED state to come here, because
</span><span style="color:#008080;">2393</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> data arriving before ESTABLISHED is
</span><span style="color:#008080;">2394</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> queued in the reassembly queue.  Since we
</span><span style="color:#008080;">2395</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> don't really have a process anyhow, just
</span><span style="color:#008080;">2396</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> accept the data here as-is (i.e. don't
</span><span style="color:#008080;">2397</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> require being in ESTABLISHED state)</span>
<span style="color:#008080;">2398</span>             flags_ |=<span style="color:#000000;"> TF_DELACK;
</span><span style="color:#008080;">2399</span>             rcv_nxt_ +=<span style="color:#000000;"> datalen;
</span><span style="color:#008080;">2400</span>             tiflags = tcph-&gt;flags() &amp;<span style="color:#000000;"> TH_FIN;
</span><span style="color:#008080;">2401</span> 
<span style="color:#008080;">2402</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> give to "application" here
</span><span style="color:#008080;">2403</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> in "real" TCP, this is sbappend() + sorwakeup()</span>
<span style="color:#008080;">2404</span>             <span style="color:#0000ff;">if</span><span style="color:#000000;"> (datalen)
</span><span style="color:#008080;">2405</span>                 recvBytes(datalen); <span style="color:#008000;">//</span><span style="color:#008000;"> notify app. of "delivery"</span>
<span style="color:#008080;">2406</span>             needoutput =<span style="color:#000000;"> need_send();
</span><span style="color:#008080;">2407</span>         } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2408</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> see the "tcp_reass" function:
</span><span style="color:#008080;">2409</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> not the one we want next (or it
</span><span style="color:#008080;">2410</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> is but there's stuff on the reass queue);
</span><span style="color:#008080;">2411</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> do whatever we need to do for out-of-order
</span><span style="color:#008080;">2412</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> segments or hole-fills.  Also,
</span><span style="color:#008080;">2413</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> send an ACK (or SACK) to the other side right now.
</span><span style="color:#008080;">2414</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> Note that we may have just a FIN here (datalen = 0)</span>
<span style="color:#008080;">2415</span>             <span style="color:#0000ff;">int</span> rcv_nxt_old_ = rcv_nxt_; <span style="color:#008000;">//</span><span style="color:#008000;"> notify app. if changes</span>
<span style="color:#008080;">2416</span>             tiflags =<span style="color:#000000;"> reass(pkt);
</span><span style="color:#008080;">2417</span>             <span style="color:#0000ff;">if</span> (rcv_nxt_ &gt;<span style="color:#000000;"> rcv_nxt_old_) {
</span><span style="color:#008080;">2418</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> if rcv_nxt_ has advanced, must have
</span><span style="color:#008080;">2419</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> been a hole fill.  In this case, there
</span><span style="color:#008080;">2420</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> is something to give to application</span>
<span style="color:#008080;">2421</span>                 recvBytes(rcv_nxt_ -<span style="color:#000000;"> rcv_nxt_old_);
</span><span style="color:#008080;">2422</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">2423</span>             flags_ |=<span style="color:#000000;"> TF_ACKNOW;
</span><span style="color:#008080;">2424</span> 
<span style="color:#008080;">2425</span>             <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_PUSH) {
</span><span style="color:#008080;">2426</span>                 <span style="color:#008000;">//</span>
<span style="color:#008080;">2427</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> ???: does this belong here
</span><span style="color:#008080;">2428</span>                 <span style="color:#008000;">//</span><span style="color:#008000;"> K: APPLICATION recv</span>
<span style="color:#008080;">2429</span>                 needoutput =<span style="color:#000000;"> need_send();
</span><span style="color:#008080;">2430</span> <span style="color:#000000;">            }
</span><span style="color:#008080;">2431</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2432</span>     } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2433</span>         <span style="color:#008000;">/*</span>
<span style="color:#008080;">2434</span> <span style="color:#008000;">         * we're closing down or this is a pure ACK that
</span><span style="color:#008080;">2435</span> <span style="color:#008000;">         * wasn't handled by the header prediction part above
</span><span style="color:#008080;">2436</span> <span style="color:#008000;">         * (e.g. because cwnd &lt; wnd)
</span><span style="color:#008080;">2437</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2438</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> K: this is deleted</span>
<span style="color:#008080;">2439</span>         tiflags &amp;= ~<span style="color:#000000;">TH_FIN;
</span><span style="color:#008080;">2440</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2441</span> 
<span style="color:#008080;">2442</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">2443</span> <span style="color:#008000;">     * if FIN is received, ACK the FIN
</span><span style="color:#008080;">2444</span> <span style="color:#008000;">     * (let user know if we could do so)
</span><span style="color:#008080;">2445</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">2446</span> 
<span style="color:#008080;">2447</span>     <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_FIN) {
</span><span style="color:#008080;">2448</span>         <span style="color:#0000ff;">if</span> (TCPS_HAVERCVDFIN(state_) == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2449</span>             flags_ |=<span style="color:#000000;"> TF_ACKNOW;
</span><span style="color:#008080;">2450</span>              rcv_nxt_++<span style="color:#000000;">;
</span><span style="color:#008080;">2451</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2452</span>         <span style="color:#0000ff;">switch</span><span style="color:#000000;"> (state_) {
</span><span style="color:#008080;">2453</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2454</span> <span style="color:#008000;">                 * In SYN_RECEIVED and ESTABLISHED STATES
</span><span style="color:#008080;">2455</span> <span style="color:#008000;">                 * enter the CLOSE_WAIT state.
</span><span style="color:#008080;">2456</span> <span style="color:#008000;">         * (passive close)
</span><span style="color:#008080;">2457</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2458</span>                 <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_SYN_RECEIVED:
</span><span style="color:#008080;">2459</span>                 <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_ESTABLISHED:
</span><span style="color:#008080;">2460</span> <span style="color:#000000;">            newstate(TCPS_CLOSE_WAIT);
</span><span style="color:#008080;">2461</span>                         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">2462</span> 
<span style="color:#008080;">2463</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2464</span> <span style="color:#008000;">                 * If still in FIN_WAIT_1 STATE FIN has not been acked so
</span><span style="color:#008080;">2465</span> <span style="color:#008000;">                 * enter the CLOSING state.
</span><span style="color:#008080;">2466</span> <span style="color:#008000;">         * (simultaneous close)
</span><span style="color:#008080;">2467</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2468</span>                 <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_FIN_WAIT_1:
</span><span style="color:#008080;">2469</span> <span style="color:#000000;">            newstate(TCPS_CLOSING);
</span><span style="color:#008080;">2470</span>                         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">2471</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2472</span> <span style="color:#008000;">                 * In FIN_WAIT_2 state enter the TIME_WAIT state,
</span><span style="color:#008080;">2473</span> <span style="color:#008000;">                 * starting the time-wait timer, turning off the other
</span><span style="color:#008080;">2474</span> <span style="color:#008000;">                 * standard timers.
</span><span style="color:#008080;">2475</span> <span style="color:#008000;">         * (in the simulator, just go to CLOSED)
</span><span style="color:#008080;">2476</span> <span style="color:#008000;">         * (completion of active close)
</span><span style="color:#008080;">2477</span>                  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2478</span>                 <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCPS_FIN_WAIT_2:
</span><span style="color:#008080;">2479</span> <span style="color:#000000;">                        newstate(TCPS_CLOSED);
</span><span style="color:#008080;">2480</span> <span style="color:#000000;">            cancel_timers();
</span><span style="color:#008080;">2481</span>                         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">2482</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2483</span>     } <span style="color:#008000;">/*</span><span style="color:#008000;"> end of if FIN bit on </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2484</span> 
<span style="color:#008080;">2485</span>     <span style="color:#0000ff;">if</span> (needoutput || (flags_ &amp;<span style="color:#000000;"> TF_ACKNOW))
</span><span style="color:#008080;">2486</span>         send_much(<span style="color:#800080;">1</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;">2487</span>     <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (curseq_ &gt;= highest_ack_ ||<span style="color:#000000;"> infinite_send_)
</span><span style="color:#008080;">2488</span>         send_much(<span style="color:#800080;">0</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;">2489</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> K: which state to return to when nothing left?</span>
<span style="color:#008080;">2490</span> 
<span style="color:#008080;">2491</span>     <span style="color:#0000ff;">if</span> (!halfclose_ &amp;&amp; state_ == TCPS_CLOSE_WAIT &amp;&amp; highest_ack_ ==<span style="color:#000000;"> maxseq_)
</span><span style="color:#008080;">2492</span> <span style="color:#000000;">        usrclosed();
</span><span style="color:#008080;">2493</span> 
<span style="color:#008080;">2494</span> <span style="color:#000000;">    Packet::free(pkt);
</span><span style="color:#008080;">2495</span> 
<span style="color:#008080;">2496</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> haoboy: Is here the place for done{} of active close? 
</span><span style="color:#008080;">2497</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> It cannot be put in the switch above because we might need to do
</span><span style="color:#008080;">2498</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> send_much() (an ACK)</span>
<span style="color:#008080;">2499</span>     <span style="color:#0000ff;">if</span> (state_ ==<span style="color:#000000;"> TCPS_CLOSED) 
</span><span style="color:#008080;">2500</span>         Tcl::instance().evalf(<span style="color:#800000;">"</span><span style="color:#800000;">%s done</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>-&gt;<span style="color:#000000;">name());
</span><span style="color:#008080;">2501</span> 
<span style="color:#008080;">2502</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2503</span> 
<span style="color:#008080;">2504</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">2505</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> various ways of dropping (some also ACK, some also RST)
</span><span style="color:#008080;">2506</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">2507</span> 
<span style="color:#008080;">2508</span> <span style="color:#000000;">dropafterack:
</span><span style="color:#008080;">2509</span>     flags_ |=<span style="color:#000000;"> TF_ACKNOW;
</span><span style="color:#008080;">2510</span>     send_much(<span style="color:#800080;">1</span><span style="color:#000000;">, REASON_NORMAL, maxburst_);
</span><span style="color:#008080;">2511</span>     <span style="color:#0000ff;">goto</span><span style="color:#000000;"> drop;
</span><span style="color:#008080;">2512</span> 
<span style="color:#008080;">2513</span> <span style="color:#000000;">dropwithreset:
</span><span style="color:#008080;">2514</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> we should be sending an RST here, but can't in simulator </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2515</span>     <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_ACK) {
</span><span style="color:#008080;">2516</span>         sendpacket(ackno, <span style="color:#800080;">0</span>, <span style="color:#800080;">0x0</span>, <span style="color:#800080;">0</span><span style="color:#000000;">, REASON_NORMAL);
</span><span style="color:#008080;">2517</span>     } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2518</span>         <span style="color:#0000ff;">int</span> ack = tcph-&gt;seqno() +<span style="color:#000000;"> datalen;
</span><span style="color:#008080;">2519</span>         <span style="color:#0000ff;">if</span> (tiflags &amp;<span style="color:#000000;"> TH_SYN)
</span><span style="color:#008080;">2520</span>             ack--<span style="color:#000000;">;
</span><span style="color:#008080;">2521</span>         sendpacket(<span style="color:#800080;">0</span>, ack, TH_ACK, <span style="color:#800080;">0</span><span style="color:#000000;">, REASON_NORMAL);
</span><span style="color:#008080;">2522</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2523</span> <span style="color:#000000;">drop:
</span><span style="color:#008080;">2524</span> <span style="color:#000000;">       Packet::free(pkt);
</span><span style="color:#008080;">2525</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2526</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2527</span> 
<span style="color:#008080;">2528</span> <span style="color:#008000;">/*</span>  
<span style="color:#008080;">2529</span> <span style="color:#008000;"> * Dupack-action: what to do on a DUP ACK.  After the initial check
</span><span style="color:#008080;">2530</span> <span style="color:#008000;"> * of 'recover' below, this function implements the following truth
</span><span style="color:#008080;">2531</span> <span style="color:#008000;"> * table:
</span><span style="color:#008080;">2532</span> <span style="color:#008000;"> *  
</span><span style="color:#008080;">2533</span> <span style="color:#008000;"> *      bugfix  ecn     last-cwnd == ecn        action  
</span><span style="color:#008080;">2534</span> <span style="color:#008000;"> *  
</span><span style="color:#008080;">2535</span> <span style="color:#008000;"> *      0       0       0                       full_reno_action
</span><span style="color:#008080;">2536</span> <span style="color:#008000;"> *      0       0       1                       full_reno_action [impossible]
</span><span style="color:#008080;">2537</span> <span style="color:#008000;"> *      0       1       0                       full_reno_action
</span><span style="color:#008080;">2538</span> <span style="color:#008000;"> *      0       1       1                       1/2 window, return 
</span><span style="color:#008080;">2539</span> <span style="color:#008000;"> *      1       0       0                       nothing 
</span><span style="color:#008080;">2540</span> <span style="color:#008000;"> *      1       0       1                       nothing         [impossible]
</span><span style="color:#008080;">2541</span> <span style="color:#008000;"> *      1       1       0                       nothing 
</span><span style="color:#008080;">2542</span> <span style="color:#008000;"> *      1       1       1                       1/2 window, return
</span><span style="color:#008080;">2543</span>  <span style="color:#008000;">*/</span> 
<span style="color:#008080;">2544</span>     
<span style="color:#008080;">2545</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2546</span> <span style="color:#000000;">FullTcpAgent::dupack_action()
</span><span style="color:#008080;">2547</span> <span style="color:#000000;">{   
</span><span style="color:#008080;">2548</span> 
<span style="color:#008080;">2549</span>         <span style="color:#0000ff;">int</span> recovered = (highest_ack_ &gt;<span style="color:#000000;"> recover_);
</span><span style="color:#008080;">2550</span> 
<span style="color:#008080;">2551</span>     fastrecov_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">2552</span>     rtxbytes_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2553</span> 
<span style="color:#008080;">2554</span>         <span style="color:#0000ff;">if</span> (recovered || (!bug_fix_ &amp;&amp; !<span style="color:#000000;">ecn_) 
</span><span style="color:#008080;">2555</span>             || (last_cwnd_action_ ==<span style="color:#000000;"> CWND_ACTION_DUPACK)
</span><span style="color:#008080;">2556</span>             || ( highest_ack_ == <span style="color:#800080;">0</span><span style="color:#000000;">)) {
</span><span style="color:#008080;">2557</span>                 <span style="color:#0000ff;">goto</span><span style="color:#000000;"> full_reno_action;
</span><span style="color:#008080;">2558</span> <span style="color:#000000;">        }       
</span><span style="color:#008080;">2559</span>     
<span style="color:#008080;">2560</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; last_cwnd_action_ ==<span style="color:#000000;"> CWND_ACTION_ECN) {
</span><span style="color:#008080;">2561</span> <span style="color:#000000;">                slowdown(CLOSE_CWND_HALF);
</span><span style="color:#008080;">2562</span> <span style="color:#000000;">        cancel_rtx_timer();
</span><span style="color:#008080;">2563</span>         rtt_active_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2564</span>         (<span style="color:#0000ff;">void</span><span style="color:#000000;">)fast_retransmit(highest_ack_);
</span><span style="color:#008080;">2565</span>                 <span style="color:#0000ff;">return</span><span style="color:#000000;">; 
</span><span style="color:#008080;">2566</span> <span style="color:#000000;">        }      
</span><span style="color:#008080;">2567</span>     
<span style="color:#008080;">2568</span>         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (bug_fix_) {
</span><span style="color:#008080;">2569</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2570</span> <span style="color:#008000;">                 * The line below, for "bug_fix_" true, avoids
</span><span style="color:#008080;">2571</span> <span style="color:#008000;">                 * problems with multiple fast retransmits in one
</span><span style="color:#008080;">2572</span> <span style="color:#008000;">                 * window of data.
</span><span style="color:#008080;">2573</span>                  <span style="color:#008000;">*/</span>      
<span style="color:#008080;">2574</span>                 <span style="color:#0000ff;">return</span><span style="color:#000000;">;  
</span><span style="color:#008080;">2575</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2576</span>     
<span style="color:#008080;">2577</span> <span style="color:#000000;">full_reno_action:    
</span><span style="color:#008080;">2578</span>         slowdown(CLOSE_SSTHRESH_HALF|<span style="color:#000000;">CLOSE_CWND_HALF);
</span><span style="color:#008080;">2579</span> <span style="color:#000000;">    cancel_rtx_timer();
</span><span style="color:#008080;">2580</span>     rtt_active_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2581</span>     recover_ =<span style="color:#000000;"> maxseq_;
</span><span style="color:#008080;">2582</span>     (<span style="color:#0000ff;">void</span><span style="color:#000000;">)fast_retransmit(highest_ack_);
</span><span style="color:#008080;">2583</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> we measure cwnd in packets,
</span><span style="color:#008080;">2584</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> so don't scale by maxseg_
</span><span style="color:#008080;">2585</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> as real TCP does</span>
<span style="color:#008080;">2586</span>     cwnd_ = <span style="color:#0000ff;">double</span>(ssthresh_) + <span style="color:#0000ff;">double</span><span style="color:#000000;">(dupacks_);
</span><span style="color:#008080;">2587</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2588</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2589</span> 
<span style="color:#008080;">2590</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2591</span> <span style="color:#000000;">FullTcpAgent::timeout_action()
</span><span style="color:#008080;">2592</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2593</span>     recover_ =<span style="color:#000000;"> maxseq_;
</span><span style="color:#008080;">2594</span> 
<span style="color:#008080;">2595</span>     <span style="color:#0000ff;">if</span> (cwnd_ &lt; <span style="color:#800080;">1.0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2596</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">2597</span>                 fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s):: resetting cwnd from %f to 1\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2598</span>             now(), name(), <span style="color:#0000ff;">double</span><span style="color:#000000;">(cwnd_));
</span><span style="color:#008080;">2599</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">2600</span>         cwnd_ = <span style="color:#800080;">1.0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2601</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2602</span> 
<span style="color:#008080;">2603</span>     <span style="color:#0000ff;">if</span> (last_cwnd_action_ ==<span style="color:#000000;"> CWND_ACTION_ECN) {
</span><span style="color:#008080;">2604</span> <span style="color:#000000;">        slowdown(CLOSE_CWND_ONE);
</span><span style="color:#008080;">2605</span>     } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2606</span>         slowdown(CLOSE_SSTHRESH_HALF|<span style="color:#000000;">CLOSE_CWND_RESTART);
</span><span style="color:#008080;">2607</span>         last_cwnd_action_ =<span style="color:#000000;"> CWND_ACTION_TIMEOUT;
</span><span style="color:#008080;">2608</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2609</span>     reset_rtx_timer(<span style="color:#800080;">1</span><span style="color:#000000;">);
</span><span style="color:#008080;">2610</span>     t_seqno_ = (highest_ack_ &lt; <span style="color:#800080;">0</span>) ? iss_ : <span style="color:#0000ff;">int</span><span style="color:#000000;">(highest_ack_);
</span><span style="color:#008080;">2611</span>     fastrecov_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2612</span>     dupacks_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2613</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2614</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">2615</span> <span style="color:#008000;"> * deal with timers going off.
</span><span style="color:#008080;">2616</span> <span style="color:#008000;"> * 2 types for now:
</span><span style="color:#008080;">2617</span> <span style="color:#008000;"> *    retransmission timer (rtx_timer_)
</span><span style="color:#008080;">2618</span> <span style="color:#008000;"> *  delayed ack timer (delack_timer_)
</span><span style="color:#008080;">2619</span> <span style="color:#008000;"> *    delayed send (randomization) timer (delsnd_timer_)
</span><span style="color:#008080;">2620</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">2621</span> <span style="color:#008000;"> * real TCP initializes the RTO as 6 sec
</span><span style="color:#008080;">2622</span> <span style="color:#008000;"> *    (A + 2D, where A=0, D=3), [Stevens p. 305]
</span><span style="color:#008080;">2623</span> <span style="color:#008000;"> * and thereafter uses
</span><span style="color:#008080;">2624</span> <span style="color:#008000;"> *    (A + 4D, where A and D are dynamic estimates)
</span><span style="color:#008080;">2625</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">2626</span> <span style="color:#008000;"> * note that in the simulator t_srtt_, t_rttvar_ and t_rtt_
</span><span style="color:#008080;">2627</span> <span style="color:#008000;"> * are all measured in 'tcp_tick_'-second units
</span><span style="color:#008080;">2628</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2629</span> 
<span style="color:#008080;">2630</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2631</span> FullTcpAgent::timeout(<span style="color:#0000ff;">int</span><span style="color:#000000;"> tno)
</span><span style="color:#008080;">2632</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2633</span> 
<span style="color:#008080;">2634</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">2635</span> <span style="color:#008000;">     * Due to F. Hernandez-Campos' fix in recv(), we may send an ACK
</span><span style="color:#008080;">2636</span> <span style="color:#008000;">     * while in the CLOSED state.  -M. Weigle 7/24/01
</span><span style="color:#008080;">2637</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">2638</span>     <span style="color:#0000ff;">if</span> (state_ ==<span style="color:#000000;"> TCPS_LISTEN) {
</span><span style="color:#008080;">2639</span>          <span style="color:#008000;">//</span><span style="color:#008000;"> shouldn't be getting timeouts here</span>
<span style="color:#008080;">2640</span>                 <span style="color:#0000ff;">if</span><span style="color:#000000;"> (debug_) {
</span><span style="color:#008080;">2641</span>                 fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s): unexpected timeout %d in state %s\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2642</span> <span style="color:#000000;">            now(), name(), tno, statestr(state_));
</span><span style="color:#008080;">2643</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">2644</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2645</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2646</span> 
<span style="color:#008080;">2647</span>     <span style="color:#0000ff;">switch</span><span style="color:#000000;"> (tno) {
</span><span style="color:#008080;">2648</span> 
<span style="color:#008080;">2649</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCP_TIMER_RTX:
</span><span style="color:#008080;">2650</span>                 <span style="color:#008000;">/*</span><span style="color:#008000;"> retransmit timer </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2651</span>                 ++<span style="color:#000000;">nrexmit_;
</span><span style="color:#008080;">2652</span> <span style="color:#000000;">                timeout_action();
</span><span style="color:#008080;">2653</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> fall thru </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2654</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCP_TIMER_DELSND:
</span><span style="color:#008080;">2655</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> for phase effects </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2656</span>                 send_much(<span style="color:#800080;">1</span><span style="color:#000000;">, PF_TIMEOUT, maxburst_);
</span><span style="color:#008080;">2657</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">2658</span> 
<span style="color:#008080;">2659</span>     <span style="color:#0000ff;">case</span><span style="color:#000000;"> TCP_TIMER_DELACK:
</span><span style="color:#008080;">2660</span>                 <span style="color:#0000ff;">if</span> (flags_ &amp;<span style="color:#000000;"> TF_DELACK) {
</span><span style="color:#008080;">2661</span>                         flags_ &amp;= ~<span style="color:#000000;">TF_DELACK;
</span><span style="color:#008080;">2662</span>                         flags_ |=<span style="color:#000000;"> TF_ACKNOW;
</span><span style="color:#008080;">2663</span>                         send_much(<span style="color:#800080;">1</span>, REASON_NORMAL, <span style="color:#800080;">0</span><span style="color:#000000;">);
</span><span style="color:#008080;">2664</span> <span style="color:#000000;">                }
</span><span style="color:#008080;">2665</span> <span style="color:#000000;">                delack_timer_.resched(delack_interval_);
</span><span style="color:#008080;">2666</span>         <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">2667</span>     <span style="color:#0000ff;">default</span><span style="color:#000000;">:
</span><span style="color:#008080;">2668</span>         fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s) Unknown Timeout type %d\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2669</span> <span style="color:#000000;">            now(), name(), tno);
</span><span style="color:#008080;">2670</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2671</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2672</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2673</span> 
<span style="color:#008080;">2674</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2675</span> FullTcpAgent::dooptions(Packet*<span style="color:#000000;"> pkt)
</span><span style="color:#008080;">2676</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2677</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> interesting options: timestamps (here),
</span><span style="color:#008080;">2678</span>     <span style="color:#008000;">//</span><span style="color:#008000;">    CC, CCNEW, CCECHO (future work perhaps?)</span>
<span style="color:#008080;">2679</span> 
<span style="color:#008080;">2680</span>         hdr_flags *fh =<span style="color:#000000;"> hdr_flags::access(pkt);
</span><span style="color:#008080;">2681</span>     hdr_tcp *tcph =<span style="color:#000000;"> hdr_tcp::access(pkt);
</span><span style="color:#008080;">2682</span> 
<span style="color:#008080;">2683</span>     <span style="color:#0000ff;">if</span> (ts_option_ &amp;&amp; !fh-&gt;<span style="color:#000000;">no_ts_) {
</span><span style="color:#008080;">2684</span>         <span style="color:#0000ff;">if</span> (tcph-&gt;ts() &lt; <span style="color:#800080;">0.0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2685</span> <span style="color:#000000;">            fprintf(stderr,
</span><span style="color:#008080;">2686</span>                 <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s) warning: ts_option enabled in this TCP, but appears to be disabled in peer\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2687</span> <span style="color:#000000;">                now(), name());
</span><span style="color:#008080;">2688</span>         } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (tcph-&gt;flags() &amp;<span style="color:#000000;"> TH_SYN) {
</span><span style="color:#008080;">2689</span>             flags_ |=<span style="color:#000000;"> TF_RCVD_TSTMP;
</span><span style="color:#008080;">2690</span>             recent_ = tcph-&gt;<span style="color:#000000;">ts();
</span><span style="color:#008080;">2691</span>             recent_age_ =<span style="color:#000000;"> now();
</span><span style="color:#008080;">2692</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2693</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2694</span> 
<span style="color:#008080;">2695</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2696</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2697</span> 
<span style="color:#008080;">2698</span> <span style="color:#008000;">//</span>
<span style="color:#008080;">2699</span> <span style="color:#008000;">//</span><span style="color:#008000;"> this shouldn't ever happen
</span><span style="color:#008080;">2700</span> <span style="color:#008000;">//
</span><span style="color:#008080;">2701</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2702</span> FullTcpAgent::process_sack(hdr_tcp*<span style="color:#000000;">)
</span><span style="color:#008080;">2703</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2704</span>     fprintf(stderr, <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s) Non-SACK capable FullTcpAgent received a SACK\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">2705</span> <span style="color:#000000;">        now(), name());
</span><span style="color:#008080;">2706</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2707</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2708</span> 
<span style="color:#008080;">2709</span> 
<span style="color:#008080;">2710</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">2711</span> <span style="color:#008000;"> * ****** Tahoe ******
</span><span style="color:#008080;">2712</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">2713</span> <span style="color:#008000;"> * for TCP Tahoe, we force a slow-start as the dup ack
</span><span style="color:#008080;">2714</span> <span style="color:#008000;"> * action.  Also, no window inflation due to multiple dup
</span><span style="color:#008080;">2715</span> <span style="color:#008000;"> * acks.  The latter is arranged by setting reno_fastrecov_
</span><span style="color:#008080;">2716</span> <span style="color:#008000;"> * false [which is performed by the Tcl init function for Tahoe in
</span><span style="color:#008080;">2717</span> <span style="color:#008000;"> * ns-default.tcl].
</span><span style="color:#008080;">2718</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2719</span> 
<span style="color:#008080;">2720</span> <span style="color:#008000;">/*</span> 
<span style="color:#008080;">2721</span> <span style="color:#008000;"> * Tahoe
</span><span style="color:#008080;">2722</span> <span style="color:#008000;"> * Dupack-action: what to do on a DUP ACK.  After the initial check
</span><span style="color:#008080;">2723</span> <span style="color:#008000;"> * of 'recover' below, this function implements the following truth
</span><span style="color:#008080;">2724</span> <span style="color:#008000;"> * table:
</span><span style="color:#008080;">2725</span> <span style="color:#008000;"> * 
</span><span style="color:#008080;">2726</span> <span style="color:#008000;"> *      bugfix  ecn     last-cwnd == ecn        action  
</span><span style="color:#008080;">2727</span> <span style="color:#008000;"> * 
</span><span style="color:#008080;">2728</span> <span style="color:#008000;"> *      0       0       0                       full_tahoe_action
</span><span style="color:#008080;">2729</span> <span style="color:#008000;"> *      0       0       1                       full_tahoe_action [impossible]
</span><span style="color:#008080;">2730</span> <span style="color:#008000;"> *      0       1       0                       full_tahoe_action
</span><span style="color:#008080;">2731</span> <span style="color:#008000;"> *      0       1       1                       1/2 window, return
</span><span style="color:#008080;">2732</span> <span style="color:#008000;"> *      1       0       0                       nothing 
</span><span style="color:#008080;">2733</span> <span style="color:#008000;"> *      1       0       1                       nothing         [impossible]
</span><span style="color:#008080;">2734</span> <span style="color:#008000;"> *      1       1       0                       nothing 
</span><span style="color:#008080;">2735</span> <span style="color:#008000;"> *      1       1       1                       1/2 window, return
</span><span style="color:#008080;">2736</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2737</span> 
<span style="color:#008080;">2738</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2739</span> <span style="color:#000000;">TahoeFullTcpAgent::dupack_action()
</span><span style="color:#008080;">2740</span> <span style="color:#000000;">{  
</span><span style="color:#008080;">2741</span>         <span style="color:#0000ff;">int</span> recovered = (highest_ack_ &gt;<span style="color:#000000;"> recover_);
</span><span style="color:#008080;">2742</span> 
<span style="color:#008080;">2743</span>     fastrecov_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">2744</span>     rtxbytes_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2745</span> 
<span style="color:#008080;">2746</span>         <span style="color:#0000ff;">if</span> (recovered || (!bug_fix_ &amp;&amp; !ecn_) || highest_ack_ == <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2747</span>                 <span style="color:#0000ff;">goto</span><span style="color:#000000;"> full_tahoe_action;
</span><span style="color:#008080;">2748</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2749</span>    
<span style="color:#008080;">2750</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; last_cwnd_action_ ==<span style="color:#000000;"> CWND_ACTION_ECN) {
</span><span style="color:#008080;">2751</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> slow start on ECN</span>
<span style="color:#008080;">2752</span>         last_cwnd_action_ =<span style="color:#000000;"> CWND_ACTION_DUPACK;
</span><span style="color:#008080;">2753</span> <span style="color:#000000;">                slowdown(CLOSE_CWND_ONE);
</span><span style="color:#008080;">2754</span> <span style="color:#000000;">        set_rtx_timer();
</span><span style="color:#008080;">2755</span>                 rtt_active_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2756</span>         t_seqno_ =<span style="color:#000000;"> highest_ack_;
</span><span style="color:#008080;">2757</span>                 <span style="color:#0000ff;">return</span><span style="color:#000000;">; 
</span><span style="color:#008080;">2758</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2759</span>    
<span style="color:#008080;">2760</span>         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (bug_fix_) {
</span><span style="color:#008080;">2761</span>                 <span style="color:#008000;">/*</span>
<span style="color:#008080;">2762</span> <span style="color:#008000;">                 * The line below, for "bug_fix_" true, avoids
</span><span style="color:#008080;">2763</span> <span style="color:#008000;">                 * problems with multiple fast retransmits in one
</span><span style="color:#008080;">2764</span> <span style="color:#008000;">                 * window of data.
</span><span style="color:#008080;">2765</span>                  <span style="color:#008000;">*/</span>      
<span style="color:#008080;">2766</span>                 <span style="color:#0000ff;">return</span><span style="color:#000000;">;  
</span><span style="color:#008080;">2767</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2768</span>    
<span style="color:#008080;">2769</span> <span style="color:#000000;">full_tahoe_action:
</span><span style="color:#008080;">2770</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> slow-start and reset ssthresh</span>
<span style="color:#008080;">2771</span>     trace_event(<span style="color:#800000;">"</span><span style="color:#800000;">FAST_RETX</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;">2772</span>     recover_ =<span style="color:#000000;"> maxseq_;
</span><span style="color:#008080;">2773</span>     last_cwnd_action_ =<span style="color:#000000;"> CWND_ACTION_DUPACK;
</span><span style="color:#008080;">2774</span>         slowdown(CLOSE_SSTHRESH_HALF|CLOSE_CWND_ONE);    <span style="color:#008000;">//</span><span style="color:#008000;"> cwnd-&gt;1</span>
<span style="color:#008080;">2775</span> <span style="color:#000000;">    set_rtx_timer();
</span><span style="color:#008080;">2776</span>         rtt_active_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2777</span>     t_seqno_ =<span style="color:#000000;"> highest_ack_;
</span><span style="color:#008080;">2778</span>     send_much(<span style="color:#800080;">0</span>, REASON_NORMAL, <span style="color:#800080;">0</span><span style="color:#000000;">);
</span><span style="color:#008080;">2779</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;">; 
</span><span style="color:#008080;">2780</span> <span style="color:#000000;">}  
</span><span style="color:#008080;">2781</span> 
<span style="color:#008080;">2782</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">2783</span> <span style="color:#008000;"> * ****** Newreno ******
</span><span style="color:#008080;">2784</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">2785</span> <span style="color:#008000;"> * for NewReno, a partial ACK does not exit fast recovery,
</span><span style="color:#008080;">2786</span> <span style="color:#008000;"> * and does not reset the dup ACK counter (which might trigger fast
</span><span style="color:#008080;">2787</span> <span style="color:#008000;"> * retransmits we don't want).  In addition, the number of packets
</span><span style="color:#008080;">2788</span> <span style="color:#008000;"> * sent in response to an ACK is limited to recov_maxburst_ during
</span><span style="color:#008080;">2789</span> <span style="color:#008000;"> * recovery periods.
</span><span style="color:#008080;">2790</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2791</span> 
<span style="color:#008080;">2792</span> NewRenoFullTcpAgent::NewRenoFullTcpAgent() : save_maxburst_(-<span style="color:#800080;">1</span><span style="color:#000000;">)
</span><span style="color:#008080;">2793</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2794</span>     bind(<span style="color:#800000;">"</span><span style="color:#800000;">recov_maxburst_</span><span style="color:#800000;">"</span>, &amp;<span style="color:#000000;">recov_maxburst_);
</span><span style="color:#008080;">2795</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2796</span> 
<span style="color:#008080;">2797</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2798</span> NewRenoFullTcpAgent::pack_action(Packet*<span style="color:#000000;">)
</span><span style="color:#008080;">2799</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2800</span>     (<span style="color:#0000ff;">void</span><span style="color:#000000;">)fast_retransmit(highest_ack_);
</span><span style="color:#008080;">2801</span>     cwnd_ = <span style="color:#0000ff;">double</span><span style="color:#000000;">(ssthresh_);
</span><span style="color:#008080;">2802</span>     <span style="color:#0000ff;">if</span> (save_maxburst_ &lt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2803</span>         save_maxburst_ =<span style="color:#000000;"> maxburst_;
</span><span style="color:#008080;">2804</span>         maxburst_ =<span style="color:#000000;"> recov_maxburst_;
</span><span style="color:#008080;">2805</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2806</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2807</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2808</span> 
<span style="color:#008080;">2809</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2810</span> NewRenoFullTcpAgent::ack_action(Packet*<span style="color:#000000;"> p)
</span><span style="color:#008080;">2811</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2812</span>     <span style="color:#0000ff;">if</span> (save_maxburst_ &gt;= <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2813</span>         maxburst_ =<span style="color:#000000;"> save_maxburst_;
</span><span style="color:#008080;">2814</span>         save_maxburst_ = -<span style="color:#800080;">1</span><span style="color:#000000;">;
</span><span style="color:#008080;">2815</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2816</span> <span style="color:#000000;">    FullTcpAgent::ack_action(p);
</span><span style="color:#008080;">2817</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2818</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2819</span> 
<span style="color:#008080;">2820</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">2821</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">2822</span> <span style="color:#008000;"> * ****** SACK ******
</span><span style="color:#008080;">2823</span> <span style="color:#008000;"> *
</span><span style="color:#008080;">2824</span> <span style="color:#008000;"> * for Sack, receiver part must report SACK data
</span><span style="color:#008080;">2825</span> <span style="color:#008000;"> * sender part maintains a 'scoreboard' (sq_) that
</span><span style="color:#008080;">2826</span> <span style="color:#008000;"> * records what it hears from receiver
</span><span style="color:#008080;">2827</span> <span style="color:#008000;"> * sender fills holes during recovery and obeys
</span><span style="color:#008080;">2828</span> <span style="color:#008000;"> * "pipe" style control until recovery is complete
</span><span style="color:#008080;">2829</span>  <span style="color:#008000;">*/</span>
<span style="color:#008080;">2830</span> 
<span style="color:#008080;">2831</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2832</span> <span style="color:#000000;">SackFullTcpAgent::reset()
</span><span style="color:#008080;">2833</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2834</span>     sq_.clear();            <span style="color:#008000;">//</span><span style="color:#008000;"> no SACK blocks</span>
<span style="color:#008080;">2835</span>     <span style="color:#008000;">/*</span><span style="color:#008000;"> Fixed typo.  -M. Weigle 6/17/02 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">2836</span>     sack_min_ = h_seqno_ = -<span style="color:#800080;">1</span>;    <span style="color:#008000;">//</span><span style="color:#008000;"> no left edge of SACK blocks</span>
<span style="color:#008080;">2837</span> <span style="color:#000000;">    FullTcpAgent::reset();
</span><span style="color:#008080;">2838</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2839</span> 
<span style="color:#008080;">2840</span> 
<span style="color:#008080;">2841</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">2842</span> SackFullTcpAgent::hdrsize(<span style="color:#0000ff;">int</span><span style="color:#000000;"> nsackblocks)
</span><span style="color:#008080;">2843</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2844</span>     <span style="color:#0000ff;">int</span> total =<span style="color:#000000;"> FullTcpAgent::headersize();
</span><span style="color:#008080;">2845</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> use base header size plus SACK option size</span>
<span style="color:#008080;">2846</span>         <span style="color:#0000ff;">if</span> (nsackblocks &gt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">2847</span>                 total += ((nsackblocks *<span style="color:#000000;"> sack_block_size_)
</span><span style="color:#008080;">2848</span>                         +<span style="color:#000000;"> sack_option_size_);
</span><span style="color:#008080;">2849</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2850</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (total);
</span><span style="color:#008080;">2851</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2852</span> 
<span style="color:#008080;">2853</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2854</span> <span style="color:#000000;">SackFullTcpAgent::dupack_action()
</span><span style="color:#008080;">2855</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2856</span> 
<span style="color:#008080;">2857</span>         <span style="color:#0000ff;">int</span> recovered = (highest_ack_ &gt;<span style="color:#000000;"> recover_);
</span><span style="color:#008080;">2858</span> 
<span style="color:#008080;">2859</span>     fastrecov_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">2860</span>     rtxbytes_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2861</span>     pipe_ = maxseq_ - highest_ack_ -<span style="color:#000000;"> sq_.total();
</span><span style="color:#008080;">2862</span> 
<span style="color:#008080;">2863</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: SACK DUPACK-ACTION:pipe_:%d, sq-total:%d, bugfix:%d, cwnd:%d, highest_ack:%d, recover_:%d\n",
</span><span style="color:#008080;">2864</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), pipe_, sq_.total(), bug_fix_, int(cwnd_), int(highest_ack_), recover_);</span>
<span style="color:#008080;">2865</span> 
<span style="color:#008080;">2866</span>         <span style="color:#0000ff;">if</span> (recovered || (!bug_fix_ &amp;&amp; !<span style="color:#000000;">ecn_)) {
</span><span style="color:#008080;">2867</span>                 <span style="color:#0000ff;">goto</span><span style="color:#000000;"> full_sack_action;
</span><span style="color:#008080;">2868</span> <span style="color:#000000;">        }           
</span><span style="color:#008080;">2869</span> 
<span style="color:#008080;">2870</span>         <span style="color:#0000ff;">if</span> (ecn_ &amp;&amp; last_cwnd_action_ ==<span style="color:#000000;"> CWND_ACTION_ECN) {
</span><span style="color:#008080;">2871</span>         <span style="color:#008000;">/*</span> 
<span style="color:#008080;">2872</span> <span style="color:#008000;">         * Received ECN notification and 3 DUPACKs in same 
</span><span style="color:#008080;">2873</span> <span style="color:#008000;">         * window. Don't cut cwnd again, but retransmit lost
</span><span style="color:#008080;">2874</span> <span style="color:#008000;">         * packet.   -M. Weigle  6/19/02
</span><span style="color:#008080;">2875</span>          <span style="color:#008000;">*/</span>
<span style="color:#008080;">2876</span>         last_cwnd_action_ =<span style="color:#000000;"> CWND_ACTION_DUPACK;
</span><span style="color:#008080;">2877</span> <span style="color:#000000;">        cancel_rtx_timer();
</span><span style="color:#008080;">2878</span>         rtt_active_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2879</span>         <span style="color:#0000ff;">int</span> amt =<span style="color:#000000;"> fast_retransmit(highest_ack_);
</span><span style="color:#008080;">2880</span>         pipectrl_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">2881</span>         h_seqno_ = highest_ack_ +<span style="color:#000000;"> amt;
</span><span style="color:#008080;">2882</span>         send_much(<span style="color:#800080;">0</span><span style="color:#000000;">, REASON_DUPACK, maxburst_);
</span><span style="color:#008080;">2883</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;">; 
</span><span style="color:#008080;">2884</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2885</span>    
<span style="color:#008080;">2886</span>         <span style="color:#0000ff;">if</span><span style="color:#000000;"> (bug_fix_) {
</span><span style="color:#008080;">2887</span>                 <span style="color:#008000;">/*</span>                              
<span style="color:#008080;">2888</span> <span style="color:#008000;">                 * The line below, for "bug_fix_" true, avoids
</span><span style="color:#008080;">2889</span> <span style="color:#008000;">                 * problems with multiple fast retransmits in one
</span><span style="color:#008080;">2890</span> <span style="color:#008000;">                 * window of data.
</span><span style="color:#008080;">2891</span>                  <span style="color:#008000;">*/</span>      
<span style="color:#008080;">2892</span> 
<span style="color:#008080;">2893</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: SACK DUPACK-ACTION BUGFIX RETURN:pipe_:%d, sq-total:%d, bugfix:%d, cwnd:%d\n",
</span><span style="color:#008080;">2894</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), pipe_, sq_.total(), bug_fix_, int(cwnd_));</span>
<span style="color:#008080;">2895</span>                 <span style="color:#0000ff;">return</span><span style="color:#000000;">;  
</span><span style="color:#008080;">2896</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2897</span>    
<span style="color:#008080;">2898</span> <span style="color:#000000;">full_sack_action:                               
</span><span style="color:#008080;">2899</span>     trace_event(<span style="color:#800000;">"</span><span style="color:#800000;">FAST_RECOVERY</span><span style="color:#800000;">"</span><span style="color:#000000;">);
</span><span style="color:#008080;">2900</span>         slowdown(CLOSE_SSTHRESH_HALF|<span style="color:#000000;">CLOSE_CWND_HALF);
</span><span style="color:#008080;">2901</span> <span style="color:#000000;">        cancel_rtx_timer();
</span><span style="color:#008080;">2902</span>         rtt_active_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2903</span> 
<span style="color:#008080;">2904</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> these initiate SACK-style "pipe" recovery</span>
<span style="color:#008080;">2905</span>     pipectrl_ =<span style="color:#000000;"> TRUE;
</span><span style="color:#008080;">2906</span>     recover_ = maxseq_;    <span style="color:#008000;">//</span><span style="color:#008000;"> where I am when recovery starts</span>
<span style="color:#008080;">2907</span> 
<span style="color:#008080;">2908</span>     <span style="color:#0000ff;">int</span> amt =<span style="color:#000000;"> fast_retransmit(highest_ack_);
</span><span style="color:#008080;">2909</span>     h_seqno_ = highest_ack_ +<span style="color:#000000;"> amt;
</span><span style="color:#008080;">2910</span> 
<span style="color:#008080;">2911</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: FAST-RTX seq:%d, h_seqno_ is now:%d, pipe:%d, cwnd:%d, recover:%d\n",
</span><span style="color:#008080;">2912</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), int(highest_ack_), h_seqno_, pipe_, int(cwnd_), recover_);</span>
<span style="color:#008080;">2913</span> 
<span style="color:#008080;">2914</span>     send_much(<span style="color:#800080;">0</span><span style="color:#000000;">, REASON_DUPACK, maxburst_);
</span><span style="color:#008080;">2915</span> 
<span style="color:#008080;">2916</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2917</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2918</span> 
<span style="color:#008080;">2919</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2920</span> SackFullTcpAgent::pack_action(Packet*<span style="color:#000000;">)
</span><span style="color:#008080;">2921</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2922</span>     <span style="color:#0000ff;">if</span> (!sq_.empty() &amp;&amp; sack_min_ &lt;<span style="color:#000000;"> highest_ack_) {
</span><span style="color:#008080;">2923</span>         sack_min_ =<span style="color:#000000;"> highest_ack_;
</span><span style="color:#008080;">2924</span> <span style="color:#000000;">        sq_.cleartonxt();
</span><span style="color:#008080;">2925</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2926</span>     pipe_ -= maxseg_;    <span style="color:#008000;">//</span><span style="color:#008000;"> see comment in tcp-sack1.cc</span>
<span style="color:#008080;">2927</span>     <span style="color:#0000ff;">if</span> (h_seqno_ &lt;<span style="color:#000000;"> highest_ack_)
</span><span style="color:#008080;">2928</span>         h_seqno_ =<span style="color:#000000;"> highest_ack_;
</span><span style="color:#008080;">2929</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2930</span> 
<span style="color:#008080;">2931</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2932</span> SackFullTcpAgent::ack_action(Packet*<span style="color:#000000;">)
</span><span style="color:#008080;">2933</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2934</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: EXITING fast recovery, recover:%d\n",
</span><span style="color:#008080;">2935</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), recover_);</span>
<span style="color:#008080;">2936</span>     fastrecov_ = pipectrl_ =<span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">2937</span>         <span style="color:#0000ff;">if</span> (!sq_.empty() &amp;&amp; sack_min_ &lt;<span style="color:#000000;"> highest_ack_) {
</span><span style="color:#008080;">2938</span>                 sack_min_ =<span style="color:#000000;"> highest_ack_;
</span><span style="color:#008080;">2939</span> <span style="color:#000000;">                sq_.cleartonxt();
</span><span style="color:#008080;">2940</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2941</span>     dupacks_ = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2942</span> 
<span style="color:#008080;">2943</span>     <span style="color:#008000;">/*</span> 
<span style="color:#008080;">2944</span> <span style="color:#008000;">     * Update h_seqno_ on new ACK (same as for partial ACKS)
</span><span style="color:#008080;">2945</span> <span style="color:#008000;">     * -M. Weigle 6/3/05
</span><span style="color:#008080;">2946</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">2947</span>     <span style="color:#0000ff;">if</span> (h_seqno_ &lt;<span style="color:#000000;"> highest_ack_)
</span><span style="color:#008080;">2948</span>         h_seqno_ =<span style="color:#000000;"> highest_ack_;
</span><span style="color:#008080;">2949</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2950</span> 
<span style="color:#008080;">2951</span> <span style="color:#008000;">//</span>
<span style="color:#008080;">2952</span> <span style="color:#008000;">//</span><span style="color:#008000;"> receiver side: if there are things in the reassembly queue,
</span><span style="color:#008080;">2953</span> <span style="color:#008000;">//</span><span style="color:#008000;"> build the appropriate SACK blocks to carry in the SACK
</span><span style="color:#008080;">2954</span> <span style="color:#008000;">//
</span><span style="color:#008080;">2955</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">2956</span> SackFullTcpAgent::build_options(hdr_tcp*<span style="color:#000000;"> tcph)
</span><span style="color:#008080;">2957</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2958</span>     <span style="color:#0000ff;">int</span> total =<span style="color:#000000;"> FullTcpAgent::build_options(tcph);
</span><span style="color:#008080;">2959</span> 
<span style="color:#008080;">2960</span>         <span style="color:#0000ff;">if</span> (!<span style="color:#000000;">rq_.empty()) {
</span><span style="color:#008080;">2961</span>                 <span style="color:#0000ff;">int</span> nblk = rq_.gensack(&amp;tcph-&gt;sa_left(<span style="color:#800080;">0</span><span style="color:#000000;">), max_sack_blocks_);
</span><span style="color:#008080;">2962</span>                 tcph-&gt;sa_length() =<span style="color:#000000;"> nblk;
</span><span style="color:#008080;">2963</span>         total += (nblk * sack_block_size_) +<span style="color:#000000;"> sack_option_size_;
</span><span style="color:#008080;">2964</span>         } <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">2965</span>                 tcph-&gt;sa_length() = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;">2966</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">2967</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (total);
</span><span style="color:#008080;">2968</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2969</span> 
<span style="color:#008080;">2970</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2971</span> <span style="color:#000000;">SackFullTcpAgent::timeout_action()
</span><span style="color:#008080;">2972</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2973</span> <span style="color:#000000;">    FullTcpAgent::timeout_action();
</span><span style="color:#008080;">2974</span> 
<span style="color:#008080;">2975</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">2976</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> original SACK spec says the sender is
</span><span style="color:#008080;">2977</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> supposed to clear out its knowledge of what
</span><span style="color:#008080;">2978</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> the receiver has in the case of a timeout
</span><span style="color:#008080;">2979</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> (on the chance the receiver has renig'd).
</span><span style="color:#008080;">2980</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> Here, this happens when clear_on_timeout_ is
</span><span style="color:#008080;">2981</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> enabled.
</span><span style="color:#008080;">2982</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">2983</span> 
<span style="color:#008080;">2984</span>     <span style="color:#0000ff;">if</span><span style="color:#000000;"> (clear_on_timeout_) {
</span><span style="color:#008080;">2985</span> <span style="color:#000000;">        sq_.clear();
</span><span style="color:#008080;">2986</span>         sack_min_ =<span style="color:#000000;"> highest_ack_;
</span><span style="color:#008080;">2987</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">2988</span> 
<span style="color:#008080;">2989</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">2990</span> <span style="color:#000000;">}
</span><span style="color:#008080;">2991</span> 
<span style="color:#008080;">2992</span> <span style="color:#0000ff;">void</span>
<span style="color:#008080;">2993</span> SackFullTcpAgent::process_sack(hdr_tcp*<span style="color:#000000;"> tcph)
</span><span style="color:#008080;">2994</span> <span style="color:#000000;">{
</span><span style="color:#008080;">2995</span>     <span style="color:#008000;">//</span>
<span style="color:#008080;">2996</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> Figure out how many sack blocks are
</span><span style="color:#008080;">2997</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> in the pkt.  Insert each block range
</span><span style="color:#008080;">2998</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> into the scoreboard
</span><span style="color:#008080;">2999</span>     <span style="color:#008000;">//
</span><span style="color:#008080;">3000</span> 
<span style="color:#008080;">3001</span>     <span style="color:#0000ff;">if</span> (max_sack_blocks_ &lt;= <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">3002</span> <span style="color:#000000;">        fprintf(stderr,
</span><span style="color:#008080;">3003</span>             <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s) warning: received SACK block but I am not SACK enabled\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">3004</span> <span style="color:#000000;">            now(), name());
</span><span style="color:#008080;">3005</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">3006</span> <span style="color:#000000;">    }    
</span><span style="color:#008080;">3007</span> 
<span style="color:#008080;">3008</span>     <span style="color:#0000ff;">int</span> slen = tcph-&gt;<span style="color:#000000;">sa_length(), i;
</span><span style="color:#008080;">3009</span>     <span style="color:#0000ff;">for</span> (i = <span style="color:#800080;">0</span>; i &lt; slen; ++<span style="color:#000000;">i) {
</span><span style="color:#008080;">3010</span>         <span style="color:#008000;">/*</span><span style="color:#008000;"> Added check for FIN   -M. Weigle 5/21/02 </span><span style="color:#008000;">*/</span>
<span style="color:#008080;">3011</span>         <span style="color:#0000ff;">if</span> (((tcph-&gt;flags() &amp; TH_FIN) == <span style="color:#800080;">0</span>) &amp;&amp; 
<span style="color:#008080;">3012</span>             tcph-&gt;sa_left(i) &gt;= tcph-&gt;<span style="color:#000000;">sa_right(i)) {
</span><span style="color:#008080;">3013</span> <span style="color:#000000;">            fprintf(stderr,
</span><span style="color:#008080;">3014</span>                 <span style="color:#800000;">"</span><span style="color:#800000;">%f: FullTcpAgent(%s) warning: received illegal SACK block [%d,%d]\n</span><span style="color:#800000;">"</span><span style="color:#000000;">,
</span><span style="color:#008080;">3015</span>                 now(), name(), tcph-&gt;sa_left(i), tcph-&gt;<span style="color:#000000;">sa_right(i));
</span><span style="color:#008080;">3016</span>             <span style="color:#0000ff;">continue</span><span style="color:#000000;">;
</span><span style="color:#008080;">3017</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">3018</span>         sq_.add(tcph-&gt;sa_left(i), tcph-&gt;sa_right(i), <span style="color:#800080;">0</span><span style="color:#000000;">);  
</span><span style="color:#008080;">3019</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">3020</span> 
<span style="color:#008080;">3021</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;">;
</span><span style="color:#008080;">3022</span> <span style="color:#000000;">}
</span><span style="color:#008080;">3023</span> 
<span style="color:#008080;">3024</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">3025</span> SackFullTcpAgent::send_allowed(<span style="color:#0000ff;">int</span><span style="color:#000000;"> seq)
</span><span style="color:#008080;">3026</span> <span style="color:#000000;">{
</span><span style="color:#008080;">3027</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> not in pipe control, so use regular control</span>
<span style="color:#008080;">3028</span>     <span style="color:#0000ff;">if</span> (!<span style="color:#000000;">pipectrl_)
</span><span style="color:#008080;">3029</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;"> (FullTcpAgent::send_allowed(seq));
</span><span style="color:#008080;">3030</span> 
<span style="color:#008080;">3031</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> don't overshoot receiver's advertised window</span>
<span style="color:#008080;">3032</span>     <span style="color:#0000ff;">int</span> topawin = highest_ack_ + <span style="color:#0000ff;">int</span>(wnd_) *<span style="color:#000000;"> maxseg_;
</span><span style="color:#008080;">3033</span>     <span style="color:#0000ff;">if</span> (seq &gt;=<span style="color:#000000;"> topawin) {
</span><span style="color:#008080;">3034</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: SEND(%d) NOT ALLOWED DUE TO AWIN:%d, pipe:%d, cwnd:%d\n",
</span><span style="color:#008080;">3035</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), seq, topawin, pipe_, int(cwnd_));</span>
<span style="color:#008080;">3036</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">3037</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">3038</span> 
<span style="color:#008080;">3039</span>     <span style="color:#008000;">/*</span>
<span style="color:#008080;">3040</span> <span style="color:#008000;">     * If not in ESTABLISHED, don't send anything we don't have
</span><span style="color:#008080;">3041</span> <span style="color:#008000;">     *   -M. Weigle 7/18/02
</span><span style="color:#008080;">3042</span>      <span style="color:#008000;">*/</span>
<span style="color:#008080;">3043</span>     <span style="color:#0000ff;">if</span> (state_ != TCPS_ESTABLISHED &amp;&amp; seq &gt;<span style="color:#000000;"> curseq_)
</span><span style="color:#008080;">3044</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;"> FALSE;
</span><span style="color:#008080;">3045</span> 
<span style="color:#008080;">3046</span>     <span style="color:#008000;">//</span><span style="color:#008000;"> don't overshoot cwnd_</span>
<span style="color:#008080;">3047</span>     <span style="color:#0000ff;">int</span> cwin = <span style="color:#0000ff;">int</span>(cwnd_) *<span style="color:#000000;"> maxseg_;
</span><span style="color:#008080;">3048</span>     <span style="color:#0000ff;">return</span> (pipe_ &lt;<span style="color:#000000;"> cwin);
</span><span style="color:#008080;">3049</span> <span style="color:#000000;">}
</span><span style="color:#008080;">3050</span> 
<span style="color:#008080;">3051</span> 
<span style="color:#008080;">3052</span> <span style="color:#008000;">//</span>
<span style="color:#008080;">3053</span> <span style="color:#008000;">//</span><span style="color:#008000;"> Calculate the next seq# to send by send_much.  If we are recovering and
</span><span style="color:#008080;">3054</span> <span style="color:#008000;">//</span><span style="color:#008000;"> we have learned about data cached at the receiver via a SACK,
</span><span style="color:#008080;">3055</span> <span style="color:#008000;">//</span><span style="color:#008000;"> we may want something other than new data (t_seqno)
</span><span style="color:#008080;">3056</span> <span style="color:#008000;">//
</span><span style="color:#008080;">3057</span> 
<span style="color:#008080;">3058</span> <span style="color:#0000ff;">int</span>
<span style="color:#008080;">3059</span> <span style="color:#000000;">SackFullTcpAgent::nxt_tseq()
</span><span style="color:#008080;">3060</span> <span style="color:#000000;">{
</span><span style="color:#008080;">3061</span> 
<span style="color:#008080;">3062</span>     <span style="color:#0000ff;">int</span> in_recovery = (highest_ack_ &lt;<span style="color:#000000;"> recover_);
</span><span style="color:#008080;">3063</span>     <span style="color:#0000ff;">int</span> seq =<span style="color:#000000;"> h_seqno_;
</span><span style="color:#008080;">3064</span> 
<span style="color:#008080;">3065</span>     <span style="color:#0000ff;">if</span> (!<span style="color:#000000;">in_recovery) {
</span><span style="color:#008080;">3066</span> <span style="color:#008000;">//</span><span style="color:#008000;">if (int(t_seqno_) &gt; 1)
</span><span style="color:#008080;">3067</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: non-recovery nxt_tseq called w/t_seqno:%d\n",
</span><span style="color:#008080;">3068</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), int(t_seqno_));
</span><span style="color:#008080;">3069</span> <span style="color:#008000;">//</span><span style="color:#008000;">sq_.dumplist();</span>
<span style="color:#008080;">3070</span>         <span style="color:#0000ff;">return</span><span style="color:#000000;"> (t_seqno_);
</span><span style="color:#008080;">3071</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">3072</span> 
<span style="color:#008080;">3073</span>     <span style="color:#0000ff;">int</span> fcnt;    <span style="color:#008000;">//</span><span style="color:#008000;"> following count-- the
</span><span style="color:#008080;">3074</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> count field in the block
</span><span style="color:#008080;">3075</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> after the seq# we are about
</span><span style="color:#008080;">3076</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> to send</span>
<span style="color:#008080;">3077</span>     <span style="color:#0000ff;">int</span> fbytes;    <span style="color:#008000;">//</span><span style="color:#008000;"> fcnt in bytes
</span><span style="color:#008080;">3078</span> 
<span style="color:#008080;">3079</span> <span style="color:#008000;">//</span><span style="color:#008000;">if (int(t_seqno_) &gt; 1)
</span><span style="color:#008080;">3080</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: recovery nxt_tseq called w/t_seqno:%d, seq:%d, mode:%d\n",
</span><span style="color:#008080;">3081</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), int(t_seqno_), seq, sack_rtx_threshmode_);
</span><span style="color:#008080;">3082</span> <span style="color:#008000;">//</span><span style="color:#008000;">sq_.dumplist();</span>
<span style="color:#008080;">3083</span> 
<span style="color:#008080;">3084</span>     <span style="color:#0000ff;">while</span> ((seq = sq_.nexthole(seq, fcnt, fbytes)) &gt; <span style="color:#800080;">0</span><span style="color:#000000;">) {
</span><span style="color:#008080;">3085</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> if we have a following block
</span><span style="color:#008080;">3086</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> with a large enough count
</span><span style="color:#008080;">3087</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> we should use the seq# we get
</span><span style="color:#008080;">3088</span>         <span style="color:#008000;">//</span><span style="color:#008000;"> from nexthole()</span>
<span style="color:#008080;">3089</span>         <span style="color:#0000ff;">if</span> (sack_rtx_threshmode_ == <span style="color:#800080;">0</span> ||
<span style="color:#008080;">3090</span>             (sack_rtx_threshmode_ == <span style="color:#800080;">1</span> &amp;&amp; fcnt &gt;= sack_rtx_cthresh_) ||
<span style="color:#008080;">3091</span>             (sack_rtx_threshmode_ == <span style="color:#800080;">2</span> &amp;&amp; fbytes &gt;= sack_rtx_bthresh_) ||
<span style="color:#008080;">3092</span>             (sack_rtx_threshmode_ == <span style="color:#800080;">3</span> &amp;&amp; (fcnt &gt;= sack_rtx_cthresh_ || fbytes &gt;= sack_rtx_bthresh_)) ||
<span style="color:#008080;">3093</span>             (sack_rtx_threshmode_ == <span style="color:#800080;">4</span> &amp;&amp; (fcnt &gt;= sack_rtx_cthresh_ &amp;&amp; fbytes &gt;=<span style="color:#000000;"> sack_rtx_bthresh_))) {
</span><span style="color:#008080;">3094</span> 
<span style="color:#008080;">3095</span> <span style="color:#008000;">//</span><span style="color:#008000;">if (int(t_seqno_) &gt; 1)
</span><span style="color:#008080;">3096</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: nxt_tseq&lt;hole&gt; returning %d\n",
</span><span style="color:#008080;">3097</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), int(seq));
</span><span style="color:#008080;">3098</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> adjust h_seqno, as we may have
</span><span style="color:#008080;">3099</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> been "jumped ahead" by learning
</span><span style="color:#008080;">3100</span>             <span style="color:#008000;">//</span><span style="color:#008000;"> about a filled hole</span>
<span style="color:#008080;">3101</span>             <span style="color:#0000ff;">if</span> (seq &gt;<span style="color:#000000;"> h_seqno_)
</span><span style="color:#008080;">3102</span>                 h_seqno_ =<span style="color:#000000;"> seq;
</span><span style="color:#008080;">3103</span>             <span style="color:#0000ff;">return</span><span style="color:#000000;"> (seq);
</span><span style="color:#008080;">3104</span>         } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (fcnt &lt;= <span style="color:#800080;">0</span><span style="color:#000000;">)
</span><span style="color:#008080;">3105</span>             <span style="color:#0000ff;">break</span><span style="color:#000000;">;
</span><span style="color:#008080;">3106</span>         <span style="color:#0000ff;">else</span><span style="color:#000000;"> {
</span><span style="color:#008080;">3107</span>             seq +=<span style="color:#000000;"> maxseg_;
</span><span style="color:#008080;">3108</span> <span style="color:#000000;">        }
</span><span style="color:#008080;">3109</span> <span style="color:#000000;">    }
</span><span style="color:#008080;">3110</span> <span style="color:#008000;">//</span><span style="color:#008000;">if (int(t_seqno_) &gt; 1)
</span><span style="color:#008080;">3111</span> <span style="color:#008000;">//</span><span style="color:#008000;">printf("%f: nxt_tseq&lt;top&gt; returning %d\n",
</span><span style="color:#008080;">3112</span> <span style="color:#008000;">//</span><span style="color:#008000;">now(), int(t_seqno_));</span>
<span style="color:#008080;">3113</span>     <span style="color:#0000ff;">return</span><span style="color:#000000;"> (t_seqno_);
</span><span style="color:#008080;">3114</span> }</pre> 
 </div> 
 <p> </p> 
</div> 
<p>转载于:https://www.cnblogs.com/forcheryl/p/4191026.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ddb90db3c9a83a395cba101872a73dc3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LogStash安装及综合案例</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/db484a3cf8073ff42c92b4121f26ba87/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">学生信息管理系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>