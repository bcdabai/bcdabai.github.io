<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8S搭建Zabbix6.2.6版本＜详细版＞ - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8S搭建Zabbix6.2.6版本＜详细版＞" />
<meta property="og:description" content="文章目录 简介环境介绍一、部署MySQL服务1.1、准备软件包1.2、卸载mariadb1.3、安装MySQL1.4、登录mysql数据库，创建用户、库、修改权限 二、搭建NFS四、创建PV4.1、创建nfs的deployment4.2、创建nfs-rbac4.3、创建nfs-sc4.4、启动PV 五、创建zabbix-service5.1、创建zabbix-service.yaml5.2、启动zabbix-server5.3、启动zabbix的web页面5.4、启动zabbix的web页面5.5、访问zabbix的web页面 六、Helm部署zabbix-proxy&amp;zabbix-agent6.1、安装Helm工具6.2、添加Helm Chart Repository6.3、Zabbix Helm Chart,并解压6.4、配置Chart6.5、配置values.yaml6.6、修改kube-state-metrics 依赖Chart参数配置6.7、Helm 安装zabbix Chart 7、登录Web界面配置proxy7.1、创建proxy7.2、验证proxy状态7.3、创建主机组7.4、添加主机7.5、查看IP查看token7.6、定义变量7.7、 创建k8s-cluster主机，用于自动发现服务组件7.7.1、创建主机7.7.2、定义变量7.7.3、验证主机 简介 以下实验由yaml清单部署PV&#43;zabbix-server，使用helm构建zabbix-proxy/agent完成
环境介绍 名称版本信息操作系统IP备注信息K8S集群1.20.15Centos7.9192.168.11.21
192.168.11.22
192.168.11.23
21:k8s-master
22:k8s-node01
23:k8s-node02Zabbix6.2.6Centos7.9容器内所有zabbix容器都在zabbix名称空间MySQL8.0.30-glicCentos7.9192.168.11.24MySQL程序在/home/application下NFSCentos7.9192.168.11.24共享目录为/nfs K8S集群在此不做演示,请先搭建K8S集群再做以下实验
一、部署MySQL服务 1.1、准备软件包 本次实验使用8.0.30-glibc版本：https://downloads.mysql.com/archives/community/
1.2、卸载mariadb #查看是否存在MariaDB rpm -qa|grep mariadb #卸载mariadb yum remove mariadb* 1.3、安装MySQL root@mysql-nfs-server]─[~] mkdir -p /home/application/mysql ##创建mysql工作目录 tar -xf mysql-8.0.30-linux-glibc2.12-x86_64.tar.xz mv mysql-8.0.30-linux-glibc2.12-x86_64 /home/application/mysql/app ##将mysql目录移动并改名 echo &#34;export PATH=$PATH:/home/application/mysql/app/bin&#34; &gt;&gt; /etc/profile ##永久添加mysql的命令路径 . /etc/profile ##已经生效 useradd -s /sbin/nologin mysql -M ##创建mysql用户，用来运行mysql程序 mkdir -p /home/application/mysql/data ##创建mysql的数据目录 chown -Rf mysql." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ddf78c8f92e317dc3922aef988fcda91/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-15T20:01:05+08:00" />
<meta property="article:modified_time" content="2023-07-15T20:01:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8S搭建Zabbix6.2.6版本＜详细版＞</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">简介</a></li><li><a href="#_11" rel="nofollow">环境介绍</a></li><li><a href="#MySQL_24" rel="nofollow">一、部署MySQL服务</a></li><li><ul><li><ul><li><ul><li><a href="#11_25" rel="nofollow">1.1、准备软件包</a></li><li><a href="#12mariadb_29" rel="nofollow">1.2、卸载mariadb</a></li><li><a href="#13MySQL_38" rel="nofollow">1.3、安装MySQL</a></li><li><a href="#14mysql_138" rel="nofollow">1.4、登录mysql数据库，创建用户、库、修改权限</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#NFS_160" rel="nofollow">二、搭建NFS</a></li><li><a href="#PV_175" rel="nofollow">四、创建PV</a></li><li><ul><li><ul><li><ul><li><a href="#41nfsdeployment_182" rel="nofollow">4.1、创建nfs的deployment</a></li><li><a href="#42nfsrbac_227" rel="nofollow">4.2、创建nfs-rbac</a></li><li><a href="#43nfssc_301" rel="nofollow">4.3、创建nfs-sc</a></li><li><a href="#44PV_312" rel="nofollow">4.4、启动PV</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#zabbixservice_326" rel="nofollow">五、创建zabbix-service</a></li><li><ul><li><ul><li><ul><li><a href="#51zabbixserviceyaml_327" rel="nofollow">5.1、创建zabbix-service.yaml</a></li><li><a href="#52zabbixserver_429" rel="nofollow">5.2、启动zabbix-server</a></li><li><a href="#53zabbixweb_450" rel="nofollow">5.3、启动zabbix的web页面</a></li><li><a href="#54zabbixweb_513" rel="nofollow">5.4、启动zabbix的web页面</a></li><li><a href="#55zabbixweb_535" rel="nofollow">5.5、访问zabbix的web页面</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#Helmzabbixproxyzabbixagent_540" rel="nofollow">六、Helm部署zabbix-proxy&amp;zabbix-agent</a></li><li><ul><li><ul><li><ul><li><a href="#61Helm_541" rel="nofollow">6.1、安装Helm工具</a></li><li><a href="#62Helm_Chart_Repository_554" rel="nofollow">6.2、添加Helm Chart Repository</a></li><li><a href="#63Zabbix_Helm_Chart_563" rel="nofollow">6.3、Zabbix Helm Chart,并解压</a></li><li><a href="#64Chart_571" rel="nofollow">6.4、配置Chart</a></li><li><a href="#65valuesyaml_593" rel="nofollow">6.5、配置values.yaml</a></li><li><a href="#66kubestatemetrics_Chart_876" rel="nofollow">6.6、修改kube-state-metrics 依赖Chart参数配置</a></li><li><a href="#67Helm_zabbix_Chart_1162" rel="nofollow">6.7、Helm 安装zabbix Chart</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#7Webproxy_1216" rel="nofollow">7、登录Web界面配置proxy</a></li><li><ul><li><ul><li><ul><li><a href="#71proxy_1217" rel="nofollow">7.1、创建proxy</a></li><li><a href="#72proxy_1222" rel="nofollow">7.2、验证proxy状态</a></li><li><a href="#73_1227" rel="nofollow">7.3、创建主机组</a></li><li><a href="#74_1230" rel="nofollow">7.4、添加主机</a></li><li><a href="#75IPtoken_1233" rel="nofollow">7.5、查看IP查看token</a></li><li><a href="#76_1242" rel="nofollow">7.6、定义变量</a></li><li><a href="#77_k8scluster_1249" rel="nofollow">7.7、 创建k8s-cluster主机，用于自动发现服务组件</a></li><li><ul><li><a href="#771_1250" rel="nofollow">7.7.1、创建主机</a></li><li><a href="#772_1257" rel="nofollow">7.7.2、定义变量</a></li><li><a href="#773_1274" rel="nofollow">7.7.3、验证主机</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_3"></a>简介</h2> 
<p>以下实验由yaml清单部署PV+zabbix-server，使用helm构建zabbix-proxy/agent完成</p> 
<p><br><br><br></p> 
<h2><a id="_11"></a>环境介绍</h2> 
<table><thead><tr><th>名称</th><th align="center">版本信息</th><th align="center">操作系统</th><th align="center">IP</th><th align="left">备注信息</th></tr></thead><tbody><tr><td>K8S集群</td><td align="center">1.20.15</td><td align="center">Centos7.9</td><td align="center">192.168.11.21<br>192.168.11.22<br>192.168.11.23<br></td><td align="left">21:k8s-master<br>22:k8s-node01<br>23:k8s-node02</td></tr><tr><td>Zabbix</td><td align="center">6.2.6</td><td align="center">Centos7.9</td><td align="center">容器内</td><td align="left">所有zabbix容器都在zabbix名称空间</td></tr><tr><td>MySQL</td><td align="center">8.0.30-glic</td><td align="center">Centos7.9</td><td align="center">192.168.11.24</td><td align="left">MySQL程序在/home/application下</td></tr><tr><td>NFS</td><td align="center"></td><td align="center">Centos7.9</td><td align="center">192.168.11.24</td><td align="left">共享目录为/nfs</td></tr></tbody></table> 
<p><strong><code>K8S集群在此不做演示,请先搭建K8S集群再做以下实验</code></strong></p> 
<p><br><br><br></p> 
<h2><a id="MySQL_24"></a>一、部署MySQL服务</h2> 
<h5><a id="11_25"></a>1.1、准备软件包</h5> 
<p>本次实验使用8.0.30-glibc版本：<a href="https://downloads.mysql.com/archives/community/" rel="nofollow">https://downloads.mysql.com/archives/community/</a><br> <img src="https://images2.imgbox.com/c8/bd/DTArv03y_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="12mariadb_29"></a>1.2、卸载mariadb</h5> 
<pre><code class="prism language-bash"><span class="token comment">#查看是否存在MariaDB</span>
<span class="token function">rpm</span> -qa<span class="token operator">|</span><span class="token function">grep</span> mariadb

<span class="token comment">#卸载mariadb</span>
yum remove mariadb*
</code></pre> 
<h5><a id="13MySQL_38"></a>1.3、安装MySQL</h5> 
<pre><code class="prism language-bash">root@mysql-nfs-server<span class="token punctuation">]</span>─<span class="token punctuation">[</span>~<span class="token punctuation">]</span> 
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/application/mysql
<span class="token comment">##创建mysql工作目录</span>
<span class="token function">tar</span> <span class="token parameter variable">-xf</span> mysql-8.0.30-linux-glibc2.12-x86_64.tar.xz 
<span class="token function">mv</span> mysql-8.0.30-linux-glibc2.12-x86_64 /home/application/mysql/app
<span class="token comment">##将mysql目录移动并改名</span>
<span class="token builtin class-name">echo</span> <span class="token string">"export PATH=<span class="token environment constant">$PATH</span>:/home/application/mysql/app/bin"</span> <span class="token operator">&gt;&gt;</span> /etc/profile
<span class="token comment">##永久添加mysql的命令路径</span>
<span class="token builtin class-name">.</span> /etc/profile
<span class="token comment">##已经生效</span>
<span class="token function">useradd</span> <span class="token parameter variable">-s</span> /sbin/nologin mysql <span class="token parameter variable">-M</span>
<span class="token comment">##创建mysql用户，用来运行mysql程序</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/application/mysql/data
<span class="token comment">##创建mysql的数据目录</span>
<span class="token function">chown</span> <span class="token parameter variable">-Rf</span> mysql.mysql /home/application/mysql/app
<span class="token function">chown</span> <span class="token parameter variable">-Rf</span> mysql.mysql /home/application/mysql/data
<span class="token comment">##修改目录属主属组	</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">wget</span> cmake gcc gcc-c++ ncurses ncurses-devel libaio-devel openssl openssl-devel  libaio libaio-devel
<span class="token comment">##安装mysql的依赖</span>
mysqld --initialize-insecure  <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/home/application/mysql/app <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/home/application/mysql/data
<span class="token comment">##初始化mysql</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/application/mysql/data/logs
<span class="token comment">##创建mysql的日志存放目录</span>
<span class="token function">chown</span> <span class="token parameter variable">-Rf</span> mysql.mysql /home/application/mysql/data/logs 
<span class="token comment">##修改目录属主属组</span>
</code></pre> 
<p>修改mysql的配置文件</p> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /etc/my.cnf
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/home/application/mysql/app
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/home/application/mysql/data
<span class="token assign-left variable">character_set_server</span><span class="token operator">=</span>utf8
collation-server<span class="token operator">=</span>utf8_general_ci

skip-name-resolve<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">#设置只能用IP登录，不能用主机名,跳过域名解析</span>

<span class="token assign-left variable">log_timestamps</span><span class="token operator">=</span>SYSTEM
<span class="token comment">#日志时间</span>

<span class="token comment">#慢日志设置</span>
<span class="token assign-left variable">long_query_time</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">slow_query_log</span><span class="token operator">=</span>ON
<span class="token assign-left variable">slow_query_log_file</span><span class="token operator">=</span>/home/application/mysql/data/logs/slow_query.log

<span class="token comment">#通用日志设置</span>
<span class="token assign-left variable">general_log</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">general_log_file</span><span class="token operator">=</span>/home/application/mysql/data/logs/mysql_general.log

<span class="token comment">#错误日志设置</span>
log-error<span class="token operator">=</span>/home/application/mysql/data/logs/mysql-error.log

<span class="token comment">#设置默认的存储引擎</span>
default-storage-engine<span class="token operator">=</span>INNODB

<span class="token comment">#设置默认密码插件</span>
<span class="token assign-left variable">default_authentication_plugin</span><span class="token operator">=</span>mysql_native_password

<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token assign-left variable">max_connections</span><span class="token operator">=</span><span class="token number">1000</span>
<span class="token assign-left variable">sql_mode</span><span class="token operator">=</span>STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
<span class="token assign-left variable">max_allowed_packet</span><span class="token operator">=</span>300M
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock

</code></pre> 
<p>使用systemctl控制MySQL</p> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /etc/systemd/system/mysqld.service  
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>MySQL Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:mysqld<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>http://dev.mysql.com/doc/refman/en/using-systemd.html
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
<span class="token assign-left variable">After</span><span class="token operator">=</span>syslog.target
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">User</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">Group</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/home/application/mysql/app/bin/mysqld --defaults-file<span class="token operator">=</span>/etc/my.cnf
LimitNOFILE <span class="token operator">=</span> <span class="token number">5000</span>

</code></pre> 
<p>启动服务</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">15</span>:47:30 root@mysql-server<span class="token punctuation">]</span>─<span class="token punctuation">[</span>~<span class="token punctuation">]</span>
systemctl daemon-reload
systemctl  <span class="token builtin class-name">enable</span>  <span class="token parameter variable">--now</span> mysqld.service  
systemctl status  mysqld.service
</code></pre> 
<h5><a id="14mysql_138"></a>1.4、登录mysql数据库，创建用户、库、修改权限</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">15</span>:47:30 root@mysql-NFS-server<span class="token punctuation">]</span>─<span class="token punctuation">[</span>~<span class="token punctuation">]</span>
mysql <span class="token parameter variable">-uroot</span>

mysql<span class="token operator">&gt;</span> alter user <span class="token string">'root'</span>@<span class="token string">'localhost'</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">'zabbix'</span><span class="token punctuation">;</span>    
<span class="token comment">##修改root的密码为zabbix</span>
mysql<span class="token operator">&gt;</span> CREATE DATABASE zabbix DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin<span class="token punctuation">;</span>     
<span class="token comment">##创建zabbix库</span>
mysql<span class="token operator">&gt;</span> CREATE <span class="token environment constant">USER</span> <span class="token string">'zabbix'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'zabbix'</span><span class="token punctuation">;</span>     
<span class="token comment">##创建zabbix用户，密码为zabbix</span>
mysql<span class="token operator">&gt;</span> GRANT ALL PRIVILEGES ON *.* TO <span class="token string">'zabbix'</span>@<span class="token string">'%'</span><span class="token punctuation">;</span>    
<span class="token comment">##修改zabbix为全权限用户</span>
mysql<span class="token operator">&gt;</span> flush privileges<span class="token punctuation">;</span>  
<span class="token comment">##刷新权限</span>
mysql<span class="token operator">&gt;</span> <span class="token punctuation">\</span>q

</code></pre> 
<p><br><br><br></p> 
<h2><a id="NFS_160"></a>二、搭建NFS</h2> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:23:51 root@mysql-nfs-server<span class="token punctuation">]</span>─<span class="token punctuation">[</span>~<span class="token punctuation">]</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /nfs
<span class="token comment">#创建nfs挂载目录</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nfs-utils rpcbind
<span class="token comment">#安装nfs和rpc</span>
<span class="token builtin class-name">echo</span> <span class="token string">"/nfs *(rw,sync,no_root_squash,no_subtree_check)"</span> <span class="token operator">&gt;&gt;</span> /etc/exports
systemctl start nfs <span class="token operator">&amp;&amp;</span> systemctl start rpcbind
systemctl <span class="token builtin class-name">enable</span> nfs-server <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> rpcbind
showmount <span class="token parameter variable">-e</span>   
<span class="token comment">##是否看到/nfs *字样</span>
</code></pre> 
<h2><a id="PV_175"></a>四、创建PV</h2> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">15</span>:43:11 root@k8s-master1 ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /webapp  <span class="token comment">##创建yaml文件存放目录</span>
<span class="token builtin class-name">cd</span> /webapp
</code></pre> 
<h5><a id="41nfsdeployment_182"></a>4.1、创建nfs的deployment</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:29:02 root@k8s-master1 webapp<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token function">vim</span> nfs-client.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-client-provisioner
  labels:
    app: nfs-client-provisioner
    <span class="token comment"># replace with namespace where provisioner is deployed</span>
  namespace: default
spec:
  replicas: <span class="token number">1</span>
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: nfs-client-provisioner
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
        - name: nfs-client-provisioner
          image: registry.cn-beijing.aliyuncs.com/xngczl/nfs-subdir-external-provisione:v4.0.0
          volumeMounts:
            - name: nfs-client-root
              mountPath: /persistentvolumes
          env:
            - name: PROVISIONER_NAME
              value: fuseim.pri/ifs <span class="token comment">#注意这个值，可以自定义</span>
            - name: NFS_SERVER
              value: <span class="token number">192.168</span>.11.24 <span class="token comment">#nfs的IP，不一样要更换</span>
            - name: NFS_PATH
              value: /nfs  <span class="token comment">#共享目录，不一样要更换</span>
      volumes:
        - name: nfs-client-root
          nfs:
            server: <span class="token number">192.168</span>.11.24 <span class="token comment">#nfs的IP，不一样要更换</span>
            path: /nfs  <span class="token comment">#共享目录，不一样要更换</span>
</code></pre> 
<h5><a id="42nfsrbac_227"></a>4.2、创建nfs-rbac</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:30:42 root@k8s-master1 webapp<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token function">vim</span> nfs-client-rbac.yaml 
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  namespace: default
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nfs-client-provisioner-runner
rules:
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"nodes"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"create"</span>, <span class="token string">"delete"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"update"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"create"</span>, <span class="token string">"update"</span>, <span class="token string">"patch"</span><span class="token punctuation">]</span>
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: run-nfs-client-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    <span class="token comment"># replace with namespace where provisioner is deployed</span>
    namespace: default
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  namespace: default
rules:
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"create"</span>, <span class="token string">"update"</span>, <span class="token string">"patch"</span><span class="token punctuation">]</span>
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  namespace: default
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    <span class="token comment"># replace with namespace where provisioner is deployed</span>
    namespace: default
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac.authorization.k8s.io
</code></pre> 
<h5><a id="43nfssc_301"></a>4.3、创建nfs-sc</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:32:54 root@k8s-master1 webapp<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token function">vim</span> nfs-client-class.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata: 
  name: course-nfs-storage
provisioner: fuseim.pri/ifs
</code></pre> 
<h5><a id="44PV_312"></a>4.4、启动PV</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:34:12 root@k8s-master1 webapp<span class="token punctuation">]</span><span class="token comment">#</span>
kubectl  apply  <span class="token parameter variable">-f</span> nfs-client.yaml 
kubectl  apply  <span class="token parameter variable">-f</span> nfs-client-rbac.yaml
kubectl  apply  <span class="token parameter variable">-f</span> nfs-client-class.yaml 
kubectl  get po,sc
NAME                                          READY   STATUS    RESTARTS   AGE
pod/nfs-client-provisioner-8579c9d69b-m6vp4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13m

NAME                                             PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
storageclass.storage.k8s.io/course-nfs-storage   fuseim.pri/ifs   Delete          Immediate           <span class="token boolean">false</span>                  13m
</code></pre> 
<h2><a id="zabbixservice_326"></a>五、创建zabbix-service</h2> 
<h5><a id="51zabbixserviceyaml_327"></a>5.1、创建zabbix-service.yaml</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:36:54 root@k8s-master1 webapp<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token function">vim</span> zabbix-server.yaml 
apiVersion: v1
kind: Namespace
metadata:
  name: zabbix
---
apiVersion: v1
kind: Service
metadata:
  name: zabbix-server
  namespace: zabbix
  labels:
    app: zabbix-server
spec:
  selector:
    app: zabbix-server
  ports:
  - name: zabbix-server
    port: <span class="token number">10051</span>
    nodePort: <span class="token number">30051</span>
  type: NodePort

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zabbix-scripts
  namespace: zabbix
spec:
  storageClassName: <span class="token string">"course-nfs-storage"</span>
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: zabbix-server
  name: zabbix-server
  namespace: zabbix
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: zabbix-server
  template:
    metadata:
      labels:
        app: zabbix-server
    spec:
      nodeSelector:
        zabbix-server: <span class="token string">"true"</span>
      hostNetwork: <span class="token boolean">true</span>
      containers:
      - image: zabbix/zabbix-server-mysql:6.2.6-centos
        imagePullPolicy: IfNotPresent
        name: zabbix-server-mysql
        volumeMounts:
        - mountPath: /usr/lib/zabbix/alertscripts
          name: zabbix-scripts
        env:
        - name: DB_SERVER_HOST
          value: <span class="token number">192.168</span>.11.24
        - name: DB_SERVER_PORT
          value: <span class="token string">"3306"</span>
        - name: MYSQL_DATABASE
          value: zabbix
        - name: MYSQL_USER
          value: zabbix
        - name: MYSQL_PASSWORD
          value: zabbix
        - name: ZBX_CACHESIZE
          value: <span class="token string">"512M"</span>
        - name: ZBX_HISTORYCACHESIZE
          value: <span class="token string">"128M"</span>
        - name: ZBX_HISTORYINDEXCACHESIZE
          value: <span class="token string">"128M"</span>
        - name: ZBX_TRENDCACHESIZE
          value: <span class="token string">"128M"</span>
        - name: ZBX_VALUECACHESIZE
          value: <span class="token string">"256M"</span>
        - name: ZBX_TIMEOUT
          value: <span class="token string">"30"</span>
        resources:
          requests:
            cpu: 500m
            memory: 500Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
        - name: zabbix-scripts
          persistentVolumeClaim:
            claimName: zabbix-scripts
</code></pre> 
<h5><a id="52zabbixserver_429"></a>5.2、启动zabbix-server</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:39:33 root@k8s-master1 webapp<span class="token punctuation">]</span><span class="token comment">#</span>
kubectl label <span class="token function">node</span> k8s-node01  zabbix-server<span class="token operator">=</span>true
<span class="token comment">#因为设置只能允许再标签为zabbix-server=true的节点上，所以设置一个标签</span>
kubectl apply <span class="token parameter variable">-f</span> zabbix-server.yaml
kubectl get all <span class="token parameter variable">-n</span> zabbix
NAME                                             READY   STATUS    RESTARTS   AGE
pod/zabbix-server-69d5fdb86d-z6h58               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s

NAME                                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>           AGE
service/zabbix-server                   NodePort    <span class="token number">10.101</span>.70.252   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">10051</span>:30051/TCP    47s

NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/zabbix-server               <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           47s

NAME                                                   DESIRED   CURRENT   READY   AGE
replicaset.apps/zabbix-server-69d5fdb86d               <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       47s

</code></pre> 
<h5><a id="53zabbixweb_450"></a>5.3、启动zabbix的web页面</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:47:03 root@k8s-master1 webapp<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token function">vim</span> zabbix-web.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: zabbix-web
  name: zabbix-web
  namespace: zabbix
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: zabbix-web
  template:
    metadata:
      labels:
        app: zabbix-web
    spec:
      containers:
      - image: zabbix/zabbix-web-nginx-mysql:6.2.6-centos
        imagePullPolicy: IfNotPresent
        name: zabbix-web-nginx-mysql
        env:
        - name: DB_SERVER_HOST
          value: <span class="token number">192.168</span>.11.24 <span class="token comment">#指定数据数据库IP</span>
        - name: MYSQL_USER
          value: zabbix <span class="token comment">#登录数据库的用户</span>
        - name: MYSQL_PASSWORD
          value: zabbix <span class="token comment">#密码</span>
        - name: ZBX_SERVER_HOST
          value: zabbix-server
        - name: PHP_TZ
          value: Asia/shanghai
        resources:
          requests:
            cpu: 500m
            memory: 500Mi
          limits:
            cpu: 1000m
            memory: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: zabbix-web
  name: zabbix-web
  namespace: zabbix
spec:
  ports:
  - name: web
    port: <span class="token number">8080</span>
    protocol: TCP
    targetPort: <span class="token number">8080</span>
    nodePort: <span class="token number">30008</span> <span class="token comment">#访问的端口</span>
  selector:
    app: zabbix-web
  type: NodePort
</code></pre> 
<h5><a id="54zabbixweb_513"></a>5.4、启动zabbix的web页面</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">16</span>:51:25 root@k8s-master1 webapp<span class="token punctuation">]</span><span class="token comment"># </span>
kubectl  apply  <span class="token parameter variable">-f</span> zabbix-web.yaml
kubectl get all <span class="token parameter variable">-n</span> zabbix
NAME                                             READY   STATUS    RESTARTS   AGE
pod/zabbix-server-69d5fdb86d-z6h58               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m20s
pod/zabbix-web-fdb545749-dhk7b                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          72s

NAME                                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>           AGE
service/zabbix-server                   NodePort    <span class="token number">10.101</span>.70.252    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">10051</span>:30051/TCP   3m20s
service/zabbix-web                      NodePort    <span class="token number">10.110</span>.39.191    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30008/TCP    72s 

NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/zabbix-server               <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           3m20s
deployment.apps/zabbix-web                  <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           72s

NAME                                                   DESIRED   CURRENT   READY   AGE
replicaset.apps/zabbix-server-69d5fdb86d               <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       3m20s
replicaset.apps/zabbix-web-fdb545746                   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       72s
</code></pre> 
<h5><a id="55zabbixweb_535"></a>5.5、访问zabbix的web页面</h5> 
<p>浏览器访问192.168.11.21:30008<br> <img src="https://images2.imgbox.com/f8/e4/QNydlic7_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Helmzabbixproxyzabbixagent_540"></a>六、Helm部署zabbix-proxy&amp;zabbix-agent</h2> 
<h5><a id="61Helm_541"></a>6.1、安装Helm工具</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:00:37 root@k8s-master1 webapp<span class="token punctuation">]</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /webapp/helm
<span class="token builtin class-name">cd</span> /webapp/helm

<span class="token punctuation">[</span><span class="token number">17</span>:02:10 root@k8s-master1 helm<span class="token punctuation">]</span>
<span class="token function">wget</span> https://get.helm.sh/helm-v3.8.1-linux-amd64.tar.gz  
<span class="token comment">##安装Helm工具</span>
<span class="token function">tar</span> zxvf helm-v3.8.1-linux-amd64.tar.gz
<span class="token function">cp</span> linux-amd64/helm /usr/local/bin/helm
</code></pre> 
<h5><a id="62Helm_Chart_Repository_554"></a>6.2、添加Helm Chart Repository</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:02:33 root@k8s-master1 helm<span class="token punctuation">]</span><span class="token comment"># </span>
helm repo <span class="token function">add</span> zabbix-chart-6.2 https://cdn.zabbix.com/zabbix/integrations/kubernetes-helm/6.2/ 
helm repo list
NAME                URL                                                          
zabbix-chart-6.2    https://cdn.zabbix.com/zabbix/integrations/kubernetes-helm/6.2
</code></pre> 
<h5><a id="63Zabbix_Helm_Chart_563"></a>6.3、Zabbix Helm Chart,并解压</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:04:38 root@k8s-master1 helm<span class="token punctuation">]</span><span class="token comment"># </span>
helm pull zabbix-chart-6.2/zabbix-helm-chrt  
<span class="token comment">##下载chart</span>
<span class="token function">tar</span> <span class="token parameter variable">-xf</span> zabbix-helm-chrt-1.1.1.tgz
</code></pre> 
<h5><a id="64Chart_571"></a>6.4、配置Chart</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:07:19 root@k8s-master1 helm<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token builtin class-name">cd</span> /webapp/helm/zabbix-helm-chrt/

<span class="token punctuation">[</span><span class="token number">17</span>:07:41 root@k8s-master1 zabbix-helm-chrt<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token function">vim</span> Chart.yaml
apiVersion: v2
appVersion: <span class="token number">6.2</span>.0
dependencies:
- condition: kubeStateMetrics.enabled
  name: kube-state-metrics
  repository: https://charts.bitnami.com/bitnami
  version: <span class="token number">3.5</span>.*
description: A Helm chart <span class="token keyword">for</span> deploying Zabbix agent and proxy
home: https://www.zabbix.com/
icon: https://assets.zabbix.com/img/logo/zabbix_logo_500x131.png
name: zabbix-helm-chrt
type: application
version: <span class="token number">1.1</span>.1
</code></pre> 
<h5><a id="65valuesyaml_593"></a>6.5、配置values.yaml</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:10:49 root@k8s-master1 zabbix-helm-chrt<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token function">vim</span> values.yaml
<span class="token comment">## nameOverride -- Override name of app</span>
nameOverride: <span class="token string">""</span>
<span class="token comment">## fullnameOverride -- Override the full qualified app name</span>
fullnameOverride: <span class="token string">"zabbix"</span>
<span class="token comment">## kubeStateMetricsEnabled -- If true, deploys the kube-state-metrics deployment</span>
kubeStateMetricsEnabled: <span class="token boolean">true</span>
<span class="token comment">## Service accoun for Kubernetes API</span>
rbac:
  <span class="token comment">## rbac.create  Specifies whether the RBAC resources should be created</span>
  create: <span class="token boolean">true</span>
  additionalRulesForClusterRole: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">##  - apiGroups: [ "" ]</span>
  <span class="token comment">##    resources:</span>
  <span class="token comment">##      - nodes/proxy</span>
  <span class="token comment">##    verbs: [ "get", "list", "watch" ]</span>
serviceAccount:
  <span class="token comment">## serviceAccount.create  Specifies whether a service account should be created</span>
  create: <span class="token boolean">true</span>
  <span class="token comment">## serviceAccount.name  The name of the service account to use. If not set name is generated using the fullname template</span>
  name: zabbix-service-account


<span class="token comment">##  **Zabbix proxy** configurations</span>
zabbixProxy:
  <span class="token comment">## Enables use of **Zabbix proxy**</span>
  enabled: <span class="token boolean">true</span>
  containerSecurityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  resources: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  image:
    <span class="token comment">## Zabbix proxy Docker image name</span>
    repository: zabbix/zabbix-proxy-sqlite3
    <span class="token comment">## Tag of Docker image of Zabbix proxy</span>
    tag: <span class="token number">6.2</span>.6-centos
    pullPolicy: IfNotPresent
    <span class="token comment">## List of dockerconfig secrets names to use when pulling images</span>
    pullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>

  env:
    <span class="token comment">## The variable allows to switch Zabbix proxy mode. Bu default, value is 0 - active proxy. Allowed values are 0 and 1.</span>
    - name: ZBX_PROXYMODE
      value: <span class="token number">0</span>
    <span class="token comment">## Zabbix proxy hostname</span>
    - name: ZBX_HOSTNAME
      value: zabbix-proxy-k8s
    <span class="token comment">## Zabbix server host</span>
    <span class="token comment">## If ProxyMode is set to active mode:</span>
    <span class="token comment">## IP address or DNS name of Zabbix server to get configuration data from and send data to.</span>

    <span class="token comment">## If ProxyMode is set to passive mode:</span>
    <span class="token comment">## List of comma delimited IP addresses, optionally in CIDR notation, or DNS names of Zabbix server. Incoming connections will be accepted only from the addresses listed here. If IPv6 support is enabled then '127.0.0.1', '::127.0.0.1', '::ffff:127.0.0.1' are treated equally and '::/0' will allow any IPv4 or IPv6 address. '0.0.0.0/0' can be used to allow any IPv4 address.</span>
    <span class="token comment">## Example: Server=127.0.0.1,192.168.1.0/24,::1,2001:db8::/32,zabbix.example.com</span>
    - name: ZBX_SERVER_HOST
      value: <span class="token string">"172.16.201.31"</span>
    <span class="token comment">## Zabbix server port</span>
    - name: ZBX_SERVER_PORT
      value: <span class="token number">10051</span>
    <span class="token comment">## The variable is used to specify debug level. By default, value is 3</span>
    - name: ZBX_DEBUGLEVEL
      value: <span class="token number">3</span>
    <span class="token comment">## Cache size</span>
    - name: ZBX_CACHESIZE
      value: 128M
    <span class="token comment">## The variable enable communication with Zabbix Java Gateway to collect Java related checks</span>
    - name: ZBX_JAVAGATEWAY_ENABLE
      value: <span class="token boolean">false</span>
    <span class="token comment">## How often proxy retrieves configuration data from Zabbix server in seconds. Active proxy parameter. Ignored for passive proxies.</span>
    - name: ZBX_CONFIGFREQUENCY
      value: <span class="token number">60</span>
    <span class="token comment">## List can be extended with other environment variables listed here: https://github.com/zabbix/zabbix-docker/tree/5.4/agent/alpine#other-variables</span>
    <span class="token comment">## For example:</span>
    <span class="token comment">## The variable is list of comma separated loadable Zabbix modules.</span>
    <span class="token comment">## - name: ZBX_LOADMODULE</span>
    <span class="token comment">##   value : dummy1.so,dummy2.so</span>


  service:
    annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    labels: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment">## Type of service for Zabbix proxy</span>
    type: ClusterIP
    <span class="token comment">## Port to expose service</span>
    port: <span class="token number">10051</span>
    <span class="token comment">## Port of application pod</span>
    targetPort: <span class="token number">10051</span>
    <span class="token comment">## Zabbix proxy Ingress externalIPs with optional path</span>
    <span class="token comment">## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips</span>
    <span class="token comment">## Must be provided if ProxyMode is set to passive mode</span>
    externalIPs: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">## Loadbalancer IP</span>
    <span class="token comment">## Only use if service.type is "LoadBalancer"</span>
    <span class="token comment">##</span>
    loadBalancerIP: <span class="token string">""</span>
    loadBalancerSourceRanges: <span class="token punctuation">[</span><span class="token punctuation">]</span>


  <span class="token comment">## Node selector for Zabbix proxy</span>
  nodeSelector: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token comment">## Tolerations configurations for Zabbix proxy</span>
  tolerations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token comment">## Affinity configurations for Zabbix proxy</span>
  affinity: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  persistentVolume:
    <span class="token comment">## If true, Zabbix proxy will create/use a Persistent Volume Claim</span>
    <span class="token comment">##</span>
    enabled: <span class="token boolean">false</span>

    <span class="token comment">## Zabbix proxy data Persistent Volume access modes</span>
    <span class="token comment">## Must match those of existing PV or dynamic provisioner</span>
    <span class="token comment">## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/</span>
    <span class="token comment">##</span>
    accessModes:
      - ReadWriteOnce

    <span class="token comment">## Zabbix proxy data Persistent Volume Claim annotations</span>
    <span class="token comment">##</span>
    annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">## Zabbix proxy data Persistent Volume existing claim name</span>
    <span class="token comment">## Requires zabbixProxy.persistentVolume.enabled: true</span>
    <span class="token comment">## If defined, PVC must be created manually before volume will be bound</span>
    existingClaim: <span class="token string">""</span>

    <span class="token comment">## Zabbix proxy data Persistent Volume mount root path</span>
    <span class="token comment">##</span>
    mountPath: /data

    <span class="token comment">## Zabbix proxy data Persistent Volume size</span>
    <span class="token comment">##</span>
    size: 2Gi

    <span class="token comment">## Zabbix proxy data Persistent Volume Storage Class</span>
    <span class="token comment">## If defined, storageClassName: &lt;storageClass&gt;</span>
    <span class="token comment">## If set to "-", storageClassName: "", which disables dynamic provisioning</span>
    <span class="token comment">## If undefined (the default) or set to null, no storageClassName spec is</span>
    <span class="token comment">##   set, choosing the default provisioner.  (gp2 on AWS, standard on</span>
    <span class="token comment">##   GKE, AWS &amp; OpenStack)</span>
    <span class="token comment">##</span>
    storageClass: <span class="token string">"-"</span>

    <span class="token comment">## Zabbix proxy data Persistent Volume Binding Mode</span>
    <span class="token comment">## If defined, volumeBindingMode: &lt;volumeBindingMode&gt;</span>
    <span class="token comment">## If undefined (the default) or set to null, no volumeBindingMode spec is</span>
    <span class="token comment">##   set, choosing the default mode.</span>
    <span class="token comment">##</span>
    volumeBindingMode: <span class="token string">""</span>

    <span class="token comment">## Subdirectory of Zabbix proxy data Persistent Volume to mount</span>
    <span class="token comment">## Useful if the volume's root directory is not empty</span>
    <span class="token comment">##</span>
    subPath: <span class="token string">""</span>

<span class="token comment">## **Zabbix agent** configurations</span>
zabbixAgent:
  <span class="token comment">## Enables use of Zabbix agent</span>
  enabled: <span class="token boolean">true</span>
  resources: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      <span class="token comment">##  requests:</span>
      <span class="token comment">##   cpu: 100m</span>
      <span class="token comment">##   memory: 54Mi</span>
      <span class="token comment">##  limits:</span>
      <span class="token comment">##   cpu: 100m</span>
      <span class="token comment">##   memory: 54Mi</span>

  securityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># fsGroup: 65534</span>
    <span class="token comment"># runAsGroup: 65534</span>
    <span class="token comment"># runAsNonRoot: true</span>
    <span class="token comment"># runAsUser: 65534</span>

  containerSecurityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment">## capabilities:</span>
    <span class="token comment">##   add:</span>
    <span class="token comment">##   - SYS_TIME</span>

  <span class="token comment">## Expose the service to the host network</span>
  hostNetwork: <span class="token boolean">true</span>

  <span class="token comment"># Specify dns configuration options for agent containers e.g ndots</span>
  <span class="token comment">## ref: https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-dns-config</span>
  dnsConfig: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token comment">#  options:</span>
  <span class="token comment">#  - name: ndots</span>
  <span class="token comment">#    value: "1"</span>

  <span class="token comment">## Share the host process ID namespace</span>
  hostPID: <span class="token boolean">true</span>
  <span class="token comment">## If true, agent pods mounts host / at /host/root</span>
  <span class="token comment">##</span>
  hostRootFsMount: <span class="token boolean">true</span>
  extraHostVolumeMounts: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">##  - name: &lt;mountName&gt;</span>
  <span class="token comment">##    hostPath: &lt;hostPath&gt;</span>
  <span class="token comment">##    mountPath: &lt;mountPath&gt;</span>
  <span class="token comment">##    readOnly: true|false</span>
  <span class="token comment">##    mountPropagation: None|HostToContainer|Bidirectional</span>
  image:
    <span class="token comment">## Zabbix agent Docker image name</span>
    repository: zabbix/zabbix-agent2
    <span class="token comment">## Tag of Docker image of Zabbix agent</span>
    tag: <span class="token number">6.2</span>.6-centos
    pullPolicy: IfNotPresent
    <span class="token comment">## List of dockerconfig secrets names to use when pulling images</span>
    pullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  env:
      <span class="token comment">## Zabbix server host</span>
    - name: ZBX_SERVER_HOST
      value: <span class="token number">0.0</span>.0.0/0
      <span class="token comment">## Zabbix server port</span>
    - name: ZBX_SERVER_PORT
      value: <span class="token number">10051</span>
      <span class="token comment">## This variable is boolean (true or false) and enables or disables feature of passive checks. By default, value is true</span>
    - name: ZBX_PASSIVE_ALLOW
      value: <span class="token boolean">true</span>
      <span class="token comment">## The variable is comma separated list of allowed Zabbix server or proxy hosts for connections to Zabbix agent container.</span>
    - name: ZBX_PASSIVESERVERS
      value: <span class="token number">0.0</span>.0.0/0
      <span class="token comment">## This variable is boolean (true or false) and enables or disables feature of active checks</span>
    - name: ZBX_ACTIVE_ALLOW
      value: <span class="token boolean">false</span>
      <span class="token comment">## The variable is used to specify debug level, from 0 to 5</span>
    - name: ZBX_DEBUGLEVEL
      value: <span class="token number">3</span>
      <span class="token comment">## The variable is used to specify timeout for processing checks. By default, value is 4.</span>
    - name: ZBX_TIMEOUT
      value: <span class="token number">4</span>
    <span class="token comment">## List can be extended with other environment variables listed here: https://github.com/zabbix/zabbix-docker/tree/5.4/agent/alpine#other-variables</span>
    <span class="token comment">## For example:</span>
    <span class="token comment">## The variable is comma separated list of allowed Zabbix server or proxy hosts for connections to Zabbix agent container. You may specify port.</span>
    <span class="token comment">## - name: ZBX_ACTIVESERVERS</span>
    <span class="token comment">##   value: ''</span>
      <span class="token comment">## The variable is list of comma separated loadable Zabbix modules. It works with volume /var/lib/zabbix/modules.</span>
    <span class="token comment">## - name: ZBX_LOADMODULE</span>
    <span class="token comment">##   value: ''</span>

  <span class="token comment">## Node selector for Agent. Only supports Linux.</span>
  nodeSelector:
    kubernetes.io/os: linux

  <span class="token comment">## Tolerations configurations</span>
  tolerations:
    - effect: NoSchedule
      key: node-role.kubernetes.io/master
  <span class="token comment">## Affinity configurations</span>
  affinity: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  serviceAccount:
    <span class="token comment">## Specifies whether a ServiceAccount should be created</span>
    create: <span class="token boolean">true</span>
    <span class="token comment">## The name of the ServiceAccount to use.</span>
    <span class="token comment">## If not set and create is true, a name is generated using the fullname template</span>
    name: zabbix-agent-service-account
    annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    imagePullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    automountServiceAccountToken: <span class="token boolean">false</span>

  service:
    type: ClusterIP
    port: <span class="token number">10050</span>
    targetPort: <span class="token number">10050</span>
    nodePort: <span class="token number">10050</span>
    portName: zabbix-agent
    listenOnAllInterfaces: <span class="token boolean">true</span>
    annotations:
      agent.zabbix/monitor: <span class="token string">"true"</span>

  rbac:
    <span class="token comment">## If true, create &amp; use RBAC resources</span>
    <span class="token comment">##</span>
    create: <span class="token boolean">true</span>
    <span class="token comment">## If true, create &amp; use Pod Security Policy resources</span>
    <span class="token comment">## https://kubernetes.io/docs/concepts/policy/pod-security-policy/</span>
    <span class="token comment">## PodSecurityPolicies disabled by default because they are deprecated in Kubernetes 1.21 and will be removed in Kubernetes 1.25.</span>
    <span class="token comment">## If you are using PodSecurityPolicies you can enable the previous behaviour by setting `rbac.pspEnabled: true`</span>
    pspEnabled: <span class="token boolean">false</span>
    pspAnnotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<h5><a id="66kubestatemetrics_Chart_876"></a>6.6、修改kube-state-metrics 依赖Chart参数配置</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:12:29 root@k8s-master1 zabbix-helm-chrt<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token builtin class-name">cd</span> charts/kube-state-metrics/

<span class="token punctuation">[</span><span class="token number">17</span>:14:05 root@k8s-master1 kube-state-metrics<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token function">vim</span> values.yaml
<span class="token comment">## nameOverride -- Override name of app</span>
nameOverride: <span class="token string">""</span>
<span class="token comment">## fullnameOverride -- Override the full qualified app name</span>
fullnameOverride: <span class="token string">"zabbix"</span>
<span class="token comment">## kubeStateMetricsEnabled -- If true, deploys the kube-state-metrics deployment</span>
kubeStateMetricsEnabled: <span class="token boolean">true</span>
<span class="token comment">## Service accoun for Kubernetes API</span>
rbac:
  <span class="token comment">## rbac.create  Specifies whether the RBAC resources should be created</span>
  create: <span class="token boolean">true</span>
  additionalRulesForClusterRole: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">##  - apiGroups: [ "" ]</span>
  <span class="token comment">##    resources:</span>
  <span class="token comment">##      - nodes/proxy</span>
  <span class="token comment">##    verbs: [ "get", "list", "watch" ]</span>
serviceAccount:
  <span class="token comment">## serviceAccount.create  Specifies whether a service account should be created</span>
  create: <span class="token boolean">true</span>
  <span class="token comment">## serviceAccount.name  The name of the service account to use. If not set name is generated using the fullname template</span>
  name: zabbix-service-account


<span class="token comment">##  **Zabbix proxy** configurations</span>
zabbixProxy:
  <span class="token comment">## Enables use of **Zabbix proxy**</span>
  enabled: <span class="token boolean">true</span>
  containerSecurityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  resources: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  image:
    <span class="token comment">## Zabbix proxy Docker image name</span>
    repository: zabbix/zabbix-proxy-sqlite3
    <span class="token comment">## Tag of Docker image of Zabbix proxy</span>
    tag: <span class="token number">6.2</span>.6-centos
    pullPolicy: IfNotPresent
    <span class="token comment">## List of dockerconfig secrets names to use when pulling images</span>
    pullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>

  env:
    <span class="token comment">## The variable allows to switch Zabbix proxy mode. Bu default, value is 0 - active proxy. Allowed values are 0 and 1.</span>
    - name: ZBX_PROXYMODE
      value: <span class="token number">0</span>
    <span class="token comment">## Zabbix proxy hostname</span>
    - name: ZBX_HOSTNAME
      value: zabbix-proxy-k8s
    <span class="token comment">## Zabbix server host</span>
    <span class="token comment">## If ProxyMode is set to active mode:</span>
    <span class="token comment">## IP address or DNS name of Zabbix server to get configuration data from and send data to.</span>

    <span class="token comment">## If ProxyMode is set to passive mode:</span>
    <span class="token comment">## List of comma delimited IP addresses, optionally in CIDR notation, or DNS names of Zabbix server. Incoming connections will be accepted only from the addresses listed here. If IPv6 support is enabled then '127.0.0.1', '::127.0.0.1', '::ffff:127.0.0.1' are treated equally and '::/0' will allow any IPv4 or IPv6 address. '0.0.0.0/0' can be used to allow any IPv4 address.</span>
    <span class="token comment">## Example: Server=127.0.0.1,192.168.1.0/24,::1,2001:db8::/32,zabbix.example.com</span>
    - name: ZBX_SERVER_HOST
      value: <span class="token string">"172.16.201.31"</span>
    <span class="token comment">## Zabbix server port</span>
    - name: ZBX_SERVER_PORT
      value: <span class="token number">10051</span>
    <span class="token comment">## The variable is used to specify debug level. By default, value is 3</span>
    - name: ZBX_DEBUGLEVEL
      value: <span class="token number">3</span>
    <span class="token comment">## Cache size</span>
    - name: ZBX_CACHESIZE
      value: 128M
    <span class="token comment">## The variable enable communication with Zabbix Java Gateway to collect Java related checks</span>
    - name: ZBX_JAVAGATEWAY_ENABLE
      value: <span class="token boolean">false</span>
    <span class="token comment">## How often proxy retrieves configuration data from Zabbix server in seconds. Active proxy parameter. Ignored for passive proxies.</span>
    - name: ZBX_CONFIGFREQUENCY
      value: <span class="token number">60</span>
    <span class="token comment">## List can be extended with other environment variables listed here: https://github.com/zabbix/zabbix-docker/tree/5.4/agent/alpine#other-variables</span>
    <span class="token comment">## For example:</span>
    <span class="token comment">## The variable is list of comma separated loadable Zabbix modules.</span>
    <span class="token comment">## - name: ZBX_LOADMODULE</span>
    <span class="token comment">##   value : dummy1.so,dummy2.so</span>


  service:
    annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    labels: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment">## Type of service for Zabbix proxy</span>
    type: ClusterIP
    <span class="token comment">## Port to expose service</span>
    port: <span class="token number">10051</span>
    <span class="token comment">## Port of application pod</span>
    targetPort: <span class="token number">10051</span>
    <span class="token comment">## Zabbix proxy Ingress externalIPs with optional path</span>
    <span class="token comment">## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips</span>
    <span class="token comment">## Must be provided if ProxyMode is set to passive mode</span>
    externalIPs: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">## Loadbalancer IP</span>
    <span class="token comment">## Only use if service.type is "LoadBalancer"</span>
    <span class="token comment">##</span>
    loadBalancerIP: <span class="token string">""</span>
    loadBalancerSourceRanges: <span class="token punctuation">[</span><span class="token punctuation">]</span>


  <span class="token comment">## Node selector for Zabbix proxy</span>
  nodeSelector: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token comment">## Tolerations configurations for Zabbix proxy</span>
  tolerations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token comment">## Affinity configurations for Zabbix proxy</span>
  affinity: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  persistentVolume:
    <span class="token comment">## If true, Zabbix proxy will create/use a Persistent Volume Claim</span>
    <span class="token comment">##</span>
    enabled: <span class="token boolean">false</span>

    <span class="token comment">## Zabbix proxy data Persistent Volume access modes</span>
    <span class="token comment">## Must match those of existing PV or dynamic provisioner</span>
    <span class="token comment">## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/</span>
    <span class="token comment">##</span>
    accessModes:
      - ReadWriteOnce

    <span class="token comment">## Zabbix proxy data Persistent Volume Claim annotations</span>
    <span class="token comment">##</span>
    annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">## Zabbix proxy data Persistent Volume existing claim name</span>
    <span class="token comment">## Requires zabbixProxy.persistentVolume.enabled: true</span>
    <span class="token comment">## If defined, PVC must be created manually before volume will be bound</span>
    existingClaim: <span class="token string">""</span>

    <span class="token comment">## Zabbix proxy data Persistent Volume mount root path</span>
    <span class="token comment">##</span>
    mountPath: /data

    <span class="token comment">## Zabbix proxy data Persistent Volume size</span>
    <span class="token comment">##</span>
    size: 2Gi

    <span class="token comment">## Zabbix proxy data Persistent Volume Storage Class</span>
    <span class="token comment">## If defined, storageClassName: &lt;storageClass&gt;</span>
    <span class="token comment">## If set to "-", storageClassName: "", which disables dynamic provisioning</span>
    <span class="token comment">## If undefined (the default) or set to null, no storageClassName spec is</span>
    <span class="token comment">##   set, choosing the default provisioner.  (gp2 on AWS, standard on</span>
    <span class="token comment">##   GKE, AWS &amp; OpenStack)</span>
    <span class="token comment">##</span>
    storageClass: <span class="token string">"-"</span>

    <span class="token comment">## Zabbix proxy data Persistent Volume Binding Mode</span>
    <span class="token comment">## If defined, volumeBindingMode: &lt;volumeBindingMode&gt;</span>
    <span class="token comment">## If undefined (the default) or set to null, no volumeBindingMode spec is</span>
    <span class="token comment">##   set, choosing the default mode.</span>
    <span class="token comment">##</span>
    volumeBindingMode: <span class="token string">""</span>

    <span class="token comment">## Subdirectory of Zabbix proxy data Persistent Volume to mount</span>
    <span class="token comment">## Useful if the volume's root directory is not empty</span>
    <span class="token comment">##</span>
    subPath: <span class="token string">""</span>

<span class="token comment">## **Zabbix agent** configurations</span>
zabbixAgent:
  <span class="token comment">## Enables use of Zabbix agent</span>
  enabled: <span class="token boolean">true</span>
  resources: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      <span class="token comment">##  requests:</span>
      <span class="token comment">##   cpu: 100m</span>
      <span class="token comment">##   memory: 54Mi</span>
      <span class="token comment">##  limits:</span>
      <span class="token comment">##   cpu: 100m</span>
      <span class="token comment">##   memory: 54Mi</span>

  securityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># fsGroup: 65534</span>
    <span class="token comment"># runAsGroup: 65534</span>
    <span class="token comment"># runAsNonRoot: true</span>
    <span class="token comment"># runAsUser: 65534</span>

  containerSecurityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment">## capabilities:</span>
    <span class="token comment">##   add:</span>
    <span class="token comment">##   - SYS_TIME</span>

  <span class="token comment">## Expose the service to the host network</span>
  hostNetwork: <span class="token boolean">true</span>

  <span class="token comment"># Specify dns configuration options for agent containers e.g ndots</span>
  <span class="token comment">## ref: https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-dns-config</span>
  dnsConfig: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token comment">#  options:</span>
  <span class="token comment">#  - name: ndots</span>
  <span class="token comment">#    value: "1"</span>

  <span class="token comment">## Share the host process ID namespace</span>
  hostPID: <span class="token boolean">true</span>
  <span class="token comment">## If true, agent pods mounts host / at /host/root</span>
  <span class="token comment">##</span>
  hostRootFsMount: <span class="token boolean">true</span>
  extraHostVolumeMounts: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">##  - name: &lt;mountName&gt;</span>
  <span class="token comment">##    hostPath: &lt;hostPath&gt;</span>
  <span class="token comment">##    mountPath: &lt;mountPath&gt;</span>
  <span class="token comment">##    readOnly: true|false</span>
  <span class="token comment">##    mountPropagation: None|HostToContainer|Bidirectional</span>
  image:
    <span class="token comment">## Zabbix agent Docker image name</span>
    repository: zabbix/zabbix-agent2
    <span class="token comment">## Tag of Docker image of Zabbix agent</span>
    tag: <span class="token number">6.2</span>.6-centos
    pullPolicy: IfNotPresent
    <span class="token comment">## List of dockerconfig secrets names to use when pulling images</span>
    pullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  env:
      <span class="token comment">## Zabbix server host</span>
    - name: ZBX_SERVER_HOST
      value: <span class="token number">0.0</span>.0.0/0
      <span class="token comment">## Zabbix server port</span>
    - name: ZBX_SERVER_PORT
      value: <span class="token number">10051</span>
      <span class="token comment">## This variable is boolean (true or false) and enables or disables feature of passive checks. By default, value is true</span>
    - name: ZBX_PASSIVE_ALLOW
      value: <span class="token boolean">true</span>
      <span class="token comment">## The variable is comma separated list of allowed Zabbix server or proxy hosts for connections to Zabbix agent container.</span>
    - name: ZBX_PASSIVESERVERS
      value: <span class="token number">0.0</span>.0.0/0
      <span class="token comment">## This variable is boolean (true or false) and enables or disables feature of active checks</span>
    - name: ZBX_ACTIVE_ALLOW
      value: <span class="token boolean">false</span>
      <span class="token comment">## The variable is used to specify debug level, from 0 to 5</span>
    - name: ZBX_DEBUGLEVEL
      value: <span class="token number">3</span>
      <span class="token comment">## The variable is used to specify timeout for processing checks. By default, value is 4.</span>
    - name: ZBX_TIMEOUT
      value: <span class="token number">4</span>
    <span class="token comment">## List can be extended with other environment variables listed here: https://github.com/zabbix/zabbix-docker/tree/5.4/agent/alpine#other-variables</span>
    <span class="token comment">## For example:</span>
    <span class="token comment">## The variable is comma separated list of allowed Zabbix server or proxy hosts for connections to Zabbix agent container. You may specify port.</span>
    <span class="token comment">## - name: ZBX_ACTIVESERVERS</span>
    <span class="token comment">##   value: ''</span>
      <span class="token comment">## The variable is list of comma separated loadable Zabbix modules. It works with volume /var/lib/zabbix/modules.</span>
    <span class="token comment">## - name: ZBX_LOADMODULE</span>
    <span class="token comment">##   value: ''</span>

  <span class="token comment">## Node selector for Agent. Only supports Linux.</span>
  nodeSelector:
    kubernetes.io/os: linux

  <span class="token comment">## Tolerations configurations</span>
  tolerations:
    - effect: NoSchedule
      key: node-role.kubernetes.io/master
  <span class="token comment">## Affinity configurations</span>
  affinity: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  serviceAccount:
    <span class="token comment">## Specifies whether a ServiceAccount should be created</span>
    create: <span class="token boolean">true</span>
    <span class="token comment">## The name of the ServiceAccount to use.</span>
    <span class="token comment">## If not set and create is true, a name is generated using the fullname template</span>
    name: zabbix-agent-service-account
    annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    imagePullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    automountServiceAccountToken: <span class="token boolean">false</span>

  service:
    type: ClusterIP
    port: <span class="token number">10050</span>
    targetPort: <span class="token number">10050</span>
    nodePort: <span class="token number">10050</span>
    portName: zabbix-agent
    listenOnAllInterfaces: <span class="token boolean">true</span>
    annotations:
      agent.zabbix/monitor: <span class="token string">"true"</span>

  rbac:
    <span class="token comment">## If true, create &amp; use RBAC resources</span>
    <span class="token comment">##</span>
    create: <span class="token boolean">true</span>
    <span class="token comment">## If true, create &amp; use Pod Security Policy resources</span>
    <span class="token comment">## https://kubernetes.io/docs/concepts/policy/pod-security-policy/</span>
    <span class="token comment">## PodSecurityPolicies disabled by default because they are deprecated in Kubernetes 1.21 and will be removed in Kubernetes 1.25.</span>
    <span class="token comment">## If you are using PodSecurityPolicies you can enable the previous behaviour by setting `rbac.pspEnabled: true`</span>
    pspEnabled: <span class="token boolean">false</span>
    pspAnnotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<h5><a id="67Helm_zabbix_Chart_1162"></a>6.7、Helm 安装zabbix Chart</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:17:04 root@k8s-master1 kube-state-metrics<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token builtin class-name">cd</span> /webapp/helm/zabbix-helm-chrt/

<span class="token punctuation">[</span><span class="token number">17</span>:17:32 root@k8s-master1 zabbix-helm-chrt<span class="token punctuation">]</span><span class="token comment"># </span>
helm <span class="token function">install</span> zabbix <span class="token builtin class-name">.</span> --dependency-update <span class="token parameter variable">-n</span> zabbix 

NAME: zabbix
LAST DEPLOYED: Fri Dec  <span class="token number">30</span> <span class="token number">17</span>:18:22 <span class="token number">2023</span>
NAMESPACE: zabbix
STATUS: deployed
REVISION: <span class="token number">1</span>
TEST SUITE: None
NOTES:
Thank you <span class="token keyword">for</span> installing zabbix-helm-chrt.

Your release is named zabbix.
Zabbix agent installed:  <span class="token string">"zabbix/zabbix-agent2:6.2.6-centos"</span>
Zabbix proxy installed:  <span class="token string">"zabbix/zabbix-proxy-sqlite3:6.2.6-centos"</span>

Annotations:
app.kubernetes.io/name: zabbix
helm.sh/chart: zabbix-helm-chrt-1.1.1
app.kubernetes.io/version: <span class="token string">"6.2.0"</span>
app.kubernetes.io/managed-by: Helm


Service account created:
    zabbix-service-account

To learn <span class="token function">more</span> about the release, try:

  $ helm status zabbix
  $ helm get all zabbix

</code></pre> 
<p>查看pod</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:19:38 root@k8s-master1 zabbix-helm-chrt<span class="token punctuation">]</span><span class="token comment"># </span>
kubectl get pods <span class="token parameter variable">-n</span> zabbix

NAME                                         READY   STATUS    RESTARTS   AGE
zabbix-agent-cm7fv                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m40s
zabbix-agent-mj6hb                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m40s
zabbix-agent-nqtfc                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m40s
zabbix-kube-state-metrics-f96fb757b-dhlth    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m40s
zabbix-proxy-6b86dfd8df-sk7s6                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m40s
zabbix-server-69d5fdb86-z5h58                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          34m
zabbix-web-fdb545749-dhk7b                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32m

</code></pre> 
<h2><a id="7Webproxy_1216"></a>7、登录Web界面配置proxy</h2> 
<h5><a id="71proxy_1217"></a>7.1、创建proxy</h5> 
<p><img src="https://images2.imgbox.com/c4/81/OVB7m3IO_o.png" alt="在这里插入图片描述"></p> 
<p>Proxy name：zabbix-proxy-k8s</p> 
<h5><a id="72proxy_1222"></a>7.2、验证proxy状态</h5> 
<p><img src="https://images2.imgbox.com/32/f4/f3wbTF3r_o.png" alt="在这里插入图片描述"></p> 
<p><code>要等此处不红继续往下走，如果等待几分钟后一只为红色把pod删了试一下（会自己创建）：kubectl delete pod -n zabbix zabbix-proxy-79dcdc48bd-m5kf8</code></p> 
<h5><a id="73_1227"></a>7.3、创建主机组</h5> 
<p><img src="https://images2.imgbox.com/2f/b5/L1NYq5AY_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="74_1230"></a>7.4、添加主机</h5> 
<p><img src="https://images2.imgbox.com/fd/45/1bW6NCG1_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="75IPtoken_1233"></a>7.5、查看IP查看token</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">17</span>:29:16 root@k8s-master1 ~<span class="token punctuation">]</span><span class="token comment"># </span>
kubectl get endpoints <span class="token parameter variable">-n</span> zabbix  
<span class="token comment">##查看ip</span>
kubectl get secret zabbix-service-account <span class="token parameter variable">-n</span> zabbix <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>.data.token<span class="token punctuation">}</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span> 
<span class="token comment">##查看token，配置zabbix时使用。</span>
</code></pre> 
<h5><a id="76_1242"></a>7.6、定义变量</h5> 
<pre><code>{$KUBE.API.ENDPOINT.URL} : https://192.168.11.21:6443/api
{$KUBE.API.TOKEN}: XXXXXXXX [上面获取到的token]
{$KUBE.NODES.ENDPOINT.NAME}： zabbix-agent 【通过kubectl get ep -n zabbix 获取到】
</code></pre> 
<p><img src="https://images2.imgbox.com/d7/19/z4X4rZts_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="77_k8scluster_1249"></a>7.7、 创建k8s-cluster主机，用于自动发现服务组件</h5> 
<h6><a id="771_1250"></a>7.7.1、创建主机</h6> 
<pre><code>Host name: k8s-cluster
Templates: 选择Templates 下的Kubernetes cluster state by HTTP 模板，用于自动发现K8S节点主机
Host groups： K8S Server
Monitored by proxy： 选择 zabbix-proxy-k8s 代理节点
</code></pre> 
<p><img src="https://images2.imgbox.com/65/be/dqgRh0HT_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="772_1257"></a>7.7.2、定义变量</h6> 
<pre><code>{$KUBE.API.HOST}: 192.168.11.21
{$KUBE.API.PORT}：6443
{$KUBE.API.TOKEN}： XXXXX [上面获取到的token]
{$KUBE.API.URL} : https://192.168.11.21:6443
{$KUBE.API_SERVER.PORT}：6443
{$KUBE.API_SERVER.SCHEME}：https
{$KUBE.CONTROLLER_MANAGER.PORT}：10252
{$KUBE.CONTROLLER_MANAGER.SCHEME}：http
{$KUBE.KUBELET.PORT}：10250
{$KUBE.KUBELET.SCHEME}：https
{$KUBE.SCHEDULER.PORT}：10251 
{$KUBE.SCHEDULER.SCHEME}：http
{$KUBE.STATE.ENDPOINT.NAME}：zabbix-kube-state-metrics 【通过kubectl get ep -n zabbix 获取到】
</code></pre> 
<p><code>IP端口以实际为准</code><br> <img src="https://images2.imgbox.com/8e/db/JiLPuiDZ_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="773_1274"></a>7.7.3、验证主机</h6> 
<p><img src="https://images2.imgbox.com/a2/83/h09WpBXN_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1aea8a5ebb89ea2269d42bdb6e488426/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">nginx通过upstream反代，部分页面404的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3ad29c134425c1d5c4d8708a4ae0a89c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">初始化K8S集群</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>