<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL 2008 R2 发邮件储存过程（含附件）测试 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL 2008 R2 发邮件储存过程（含附件）测试" />
<meta property="og:description" content="SQL 2008 R2 发邮件储存过程测试，
如执行不了 请启动 /*
如出现错误请执行下列代码授权
sp_configure &#39;show advanced options&#39;,1
reconfigure
go
sp_configure &#39;xp_cmdshell&#39;,1
reconfigure
go sp_configure &#39;Ole Automation Procedures&#39;,1
reconfigure
go
*/
参数有填写发件人，收件人（可用逗号填写多个收件人），标题，正文件内容，格式是HTMLBody 表格型，TextBody 文本型
附件发送请留言 数据库是否有访问附件的权限，一般附件放在服务器上测试的话是可以正常访问的，如果是HTMLBody 注意格式填写，如下代码
create PROCEDURE [dbo].[send_mailYSunKpi] @From varchar(1000) , --发件人 @To varchar(1000) , --收件人 @Subject nvarchar(128)=&#39;&#39;, --标题 @Body NVARCHAR(MAX) =&#39;&#39;, --正文 @TypeHTML nvarchar(10)=&#39;&#39;, --发送格式 If you are using HTML e-mail, use &#39;HTMLBody&#39; instead of &#39;TextBody&#39;. @Attachment varchar(250)=&#39;&#39; --附件发送 --附件路径必须是数据库可以访问的路径，最好是在服务器上的路径 --with encryption /********************************************************************* /* 如出现错误请执行下列代码授权 sp_configure &#39;show advanced options&#39;,1 reconfigure go sp_configure &#39;xp_cmdshell&#39;,1 reconfigure go sp_configure &#39;Ole Automation Procedures&#39;,1 reconfigure go */ This stored procedure takes the parameters and sends an e-mail." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c164940ab882e078a60896e67e68922b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-10-23T23:22:49+08:00" />
<meta property="article:modified_time" content="2018-10-23T23:22:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL 2008 R2 发邮件储存过程（含附件）测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>SQL 2008 R2 发邮件储存过程测试，</p> 
<p>如执行不了 请启动 </p> 
<p>/*<br> 如出现错误请执行下列代码授权<br> sp_configure 'show advanced options',1<br> reconfigure<br> go<br> sp_configure 'xp_cmdshell',1<br> reconfigure<br> go <br>  <br> sp_configure 'Ole Automation Procedures',1<br> reconfigure<br> go<br> */</p> 
<p>参数有填写发件人，收件人（可用逗号填写多个收件人），标题，正文件内容，格式是HTMLBody 表格型，TextBody 文本型</p> 
<p>附件发送请留言 数据库是否有访问附件的权限，一般附件放在服务器上测试的话是可以正常访问的，如果是HTMLBody 注意格式填写，如下代码</p> 
<pre class="has"><code class="language-sql">create PROCEDURE [dbo].[send_mailYSunKpi]
   @From varchar(1000) ,  --发件人
   @To varchar(1000) ,   --收件人
   @Subject nvarchar(128)='', --标题
   @Body NVARCHAR(MAX) ='', --正文
   @TypeHTML nvarchar(10)='', --发送格式  If you are using HTML e-mail, use 'HTMLBody' instead of 'TextBody'.
   @Attachment varchar(250)='' --附件发送  --附件路径必须是数据库可以访问的路径，最好是在服务器上的路径
--with encryption

/*********************************************************************
/*
如出现错误请执行下列代码授权
sp_configure 'show advanced options',1
reconfigure
go
sp_configure 'xp_cmdshell',1
reconfigure
go 
 
sp_configure 'Ole Automation Procedures',1
reconfigure
go
*/
This stored procedure takes the parameters and sends an e-mail.
All the mail configurations are hard-coded in the stored procedure.
Comments are added to the stored procedure where necessary.
References to the CDOSYS objects are at the following MSDN Web site:
http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cdosys/html/_cdosys_messaging.asp

***********************************************************************/
AS
Declare @iMsg int
Declare @hr int
Declare @source varchar(255)
Declare @description varchar(500)
Declare @output varchar(1000)

Declare @smtpserver varchar(200)
Declare @sendusername varchar(200)
Declare @sendpassword varchar(200)   
      
--please set the values before excute the stored procedure
set @smtpserver  = 'ysungj.com'  --smtp服务器
set @sendusername = '*****@ysungj.com'--发送认证:用户名
set @sendpassword = '*****'--发送认证:密码

if @sendusername='' or  @sendpassword=''
begin
 raiserror 50000 'please set the @sendusername and  @sendpassword values before excute the stored procedure'
 return -1
end

--replace the quotation marks
set @Subject=replace(@Subject,'''','''''')
set @Body=replace(@Body,'''','''''')




--************* Create the CDO.Message Object ************************
EXEC @hr = sp_OACreate 'CDO.Message', @iMsg OUT

--***************Configuring the Message Object ******************
-- This is to configure a remote SMTP server.
-- http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cdosys/html/_cdosys_schema_configuration_sendusing.asp
EXEC @hr = sp_OASetProperty @iMsg, 'Configuration.fields("http://schemas.microsoft.com/cdo/configuration/sendusing").Value','2'
-- This is to configure the Server Name or IP address.
-- Replace MailServerName by the name or IP of your SMTP Server.
EXEC @hr = sp_OASetProperty @iMsg, 'Configuration.fields("http://schemas.microsoft.com/cdo/configuration/smtpserver").Value', @smtpserver
--
EXEC @hr = sp_OASetProperty @iMsg, 'Configuration.fields("http://schemas.microsoft.com/cdo/configuration/smtpauthenticate").Value','1' 

EXEC @hr = sp_OASetProperty @iMsg, 'Configuration.fields("http://schemas.microsoft.com/cdo/configuration/sendusername").Value', @sendusername
EXEC @hr = sp_OASetProperty @iMsg, 'Configuration.fields("http://schemas.microsoft.com/cdo/configuration/sendpassword").Value', @sendpassword
 
-- Save the configurations to the message object.
EXEC @hr = sp_OAMethod @iMsg, 'Configuration.Fields.Update', null

-- Set the e-mail parameters.
EXEC @hr = sp_OASetProperty @iMsg, 'To', @To
EXEC @hr = sp_OASetProperty @iMsg, 'From', @From
EXEC @hr = sp_OASetProperty @iMsg, 'Subject', @Subject

-- If you are using HTML e-mail, use 'HTMLBody' instead of 'TextBody'.

EXEC @hr = sp_OASetProperty @iMsg, @TypeHTML,@Body --@Body+''
if @Attachment &lt;&gt;''
BEGIN
EXEC @hr = sp_OAMethod @iMsg, 'AddAttachment',NULL, @Attachment;
END
EXEC @hr = sp_OAMethod @iMsg, 'Send', NULL
print @hr;
if @@error&lt;&gt;0 or @hr&lt;&gt;0
begin
 raiserror 55000 '&lt;send_mail&gt; Error: send mail failed.'
end
else 
begin
 print 'Success: send mail ok.'
end

EXEC @hr = sp_OAGetErrorInfo NULL, @source OUT, @description OUT
IF @hr = 0
BEGIN
 SELECT @output = '&lt;send_mail&gt; Error Source: ' + @source
 PRINT  @output
 SELECT @output = '&lt;send_mail&gt; Error Description: ' + @description
 PRINT  @output
END
ELSE
BEGIN
 PRINT '  sp_OAGetErrorInfo failed.'
 RETURN
END

-- Do some error handling after each step if you have to.
-- Clean up the objects created.
EXEC @hr = sp_OADestroy @iMsg


GO
</code></pre> 
<p>SQL 储存过程调用 过程代码如下， </p> 
<pre class="has"><code class="language-sql">
Declare @description NVARCHAR(MAX),@Attachment nvarchar(120)='';             
SET @description = N'&lt;style&gt;table{table-layout:fixed;width:1200px;border:1px solid #000000;border-collapse:collapse;font-size:12px;empty-cells:show;}'
                                    + N'th,td{border:1px solid #000000;padding:3px;}&lt;/style&gt;'
                                    + N'&lt;H2&gt;客户列表导出时间'
                                    + CONVERT(VARCHAR(19), GETDATE(), 120)
                                    + '客户情况表&lt;/H2&gt;' --标题   
                                    + N'&lt;table&gt;' + N'&lt;thead&gt;&lt;tr&gt;'
                                    + N'&lt;th style="width:80px;"&gt;ID&lt;/th&gt;'
                                    + N'&lt;th style="width:90px;"&gt;姓名&lt;/th&gt;'
                                    + N'&lt;th style="width:350px;"&gt;公司&lt;/th&gt;'
                                    + N'&lt;th style="width:150px;"&gt;部门&lt;/th&gt;'
                                    + N'&lt;th style="width:80px;"&gt;职位&lt;/th&gt;'
                                    + N'&lt;th style="width:80px;"&gt;电话&lt;/th&gt;'
                                    + N'&lt;th style="width:80px;"&gt;日期&lt;/th&gt;'                                 
                                    + N'&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;'  --表头   
                                    + CAST(( SELECT [mKey] AS td , '' ,
                                                   [Name] AS td ,
                                                    '' ,
                                                   [Company] AS td ,
                                                    '' ,
                                                    ISNULL([Dept], ' ') td ,
                                                    '' ,                                                   
                                                    [Zwei] AS td ,
                                                    '' ,
                                                   [Tel-Long] as  td ,
                                                    ''
                                                     ,
                                                   GETDATE() as  td ,
                                                    ''
                                             FROM [YS_IMS].[dbo].[YSTel]                                                   
                                           FOR
                                             XML PATH('tr') ,
                                                 TYPE
                                           ) AS NVARCHAR(MAX))
                                    + N'&lt;/tbody&gt;&lt;/table&gt;'; 


SET @Attachment=N'D:\资料.xls'

exec  [send_mailYSunKpi] '**ix@ysungj.com','****@ysungj.com,****@qq.com','测试邮件',@description,'HTMLBody',@Attachment; --'HTMLBody' --TextBody</code></pre> 
<p> 效果如下图所示：<img alt="" class="has" src="https://images2.imgbox.com/69/14/DbEVGljF_o.jpg"></p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/957e2dda10c9354cf5cc9e70b2f947b6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">map转换成JSON的3种方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a4bd89d6cf6022d8ca14b7defbf34c99/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用emscripten实现js直接调用C代码(emscripten的初探)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>