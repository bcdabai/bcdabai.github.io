<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL Server 动态行转列（参数化表名、分组列、行转列字段、字段值） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL Server 动态行转列（参数化表名、分组列、行转列字段、字段值）" />
<meta property="og:description" content="一、 构造测试数据 --创建测试表 IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N&#39;[dbo].[TestRows2Columns]&#39;) AND type in (N&#39;U&#39;)) DROP TABLE [dbo].[TestRows2Columns] GO CREATE TABLE [dbo].[TestRows2Columns]( [Id] [int] IDENTITY(1,1) NOT NULL, [UserName] [nvarchar](50) NULL, [Subject] [nvarchar](50) NULL, [Source] [numeric](18, 0) NULL ) ON [PRIMARY] GO --插入测试数据 INSERT INTO [TestRows2Columns] ([UserName],[Subject],[Source]) SELECT N&#39;张三&#39;,N&#39;语文&#39;,60 UNION ALL SELECT N&#39;李四&#39;,N&#39;数学&#39;,70 UNION ALL SELECT N&#39;王五&#39;,N&#39;英语&#39;,80 UNION ALL SELECT N&#39;王五&#39;,N&#39;数学&#39;,75 UNION ALL SELECT N&#39;王五&#39;,N&#39;语文&#39;,57 UNION ALL SELECT N&#39;李四&#39;,N&#39;语文&#39;,80 UNION ALL SELECT N&#39;张三&#39;,N&#39;英语&#39;,100 GO SELECT * FROM [TestRows2Columns]; 二、 静态实现行转列 --1：静态拼接行转列 SELECT [UserName], SUM(CASE [Subject] WHEN &#39;数学&#39; THEN [Source] ELSE 0 END) AS &#39;[数学]&#39;, SUM(CASE [Subject] WHEN &#39;英语&#39; THEN [Source] ELSE 0 END) AS &#39;[英语]&#39;, SUM(CASE [Subject] WHEN &#39;语文&#39; THEN [Source] ELSE 0 END) AS &#39;[语文]&#39; FROM [TestRows2Columns] GROUP BY [UserName]; 三、 动态实现行转列 这是使用拼接SQL的方式实现的，所以它适用于SQL Server 2000以上的数据库版本。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/893c370ded49be4f0a1752c1bb69f481/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-20T22:11:01+08:00" />
<meta property="article:modified_time" content="2023-01-20T22:11:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL Server 动态行转列（参数化表名、分组列、行转列字段、字段值）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>一、 构造测试数据</h3> 
<pre><code class="language-sql">--创建测试表
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TestRows2Columns]') AND type in (N'U'))
DROP TABLE [dbo].[TestRows2Columns]
GO
CREATE TABLE [dbo].[TestRows2Columns](
    [Id] [int] IDENTITY(1,1) NOT NULL,
    [UserName] [nvarchar](50) NULL,
    [Subject] [nvarchar](50) NULL,
    [Source] [numeric](18, 0) NULL
) ON [PRIMARY]
GO

--插入测试数据
INSERT INTO [TestRows2Columns] ([UserName],[Subject],[Source]) 
    SELECT N'张三',N'语文',60  UNION ALL
    SELECT N'李四',N'数学',70  UNION ALL
    SELECT N'王五',N'英语',80  UNION ALL
    SELECT N'王五',N'数学',75  UNION ALL
    SELECT N'王五',N'语文',57  UNION ALL
    SELECT N'李四',N'语文',80  UNION ALL
    SELECT N'张三',N'英语',100
GO

SELECT * FROM [TestRows2Columns];</code></pre> 
<p><img alt="wps_clip_image-8842" src="https://images2.imgbox.com/41/21/vzwTtgqo_o.png"></p> 
<p></p> 
<h3>二、 静态实现行转列</h3> 
<pre><code class="language-sql">--1：静态拼接行转列
SELECT [UserName],
SUM(CASE [Subject] WHEN '数学' THEN [Source] ELSE 0 END) AS '[数学]',
SUM(CASE [Subject] WHEN '英语' THEN [Source] ELSE 0 END) AS '[英语]',
SUM(CASE [Subject] WHEN '语文' THEN [Source] ELSE 0 END) AS '[语文]'     
FROM [TestRows2Columns]
GROUP BY [UserName];</code></pre> 
<p><img alt="wps_clip_image-14456" src="https://images2.imgbox.com/d1/ae/8pkLbeHJ_o.png"></p> 
<p></p> 
<h3>三、 动态实现行转列</h3> 
<p>这是使用拼接SQL的方式实现的，所以它适用于SQL Server 2000以上的数据库版本。</p> 
<pre><code class="language-sql">--2：动态拼接行转列
DECLARE @sql VARCHAR(8000)
SET @sql = 'SELECT [UserName],'   
SELECT @sql = @sql + 'SUM(CASE [Subject] WHEN '''+[Subject]+''' THEN [Source] ELSE 0 END) AS '''+QUOTENAME([Subject])+''','   
FROM (SELECT DISTINCT [Subject] FROM [TestRows2Columns]) AS a     
SELECT @sql = LEFT(@sql,LEN(@sql)-1) + ' FROM [TestRows2Columns] GROUP BY [UserName]'   
PRINT(@sql)
EXEC(@sql)
GO</code></pre> 
<p></p> 
<h3>四、 透视函数 PIVOT</h3> 
<h4>1. 静态方式</h4> 
<p>2005之后有了一个专门的PIVOT 和 UNPIVOT 关系运算符做行列之间的转换，下面是静态的方式实现的</p> 
<pre><code class="language-sql">--3：静态PIVOT行转列
SELECT  *
FROM    ( SELECT    [UserName] ,
                    [Subject] ,
                    [Source]
          FROM      [TestRows2Columns]
        ) p PIVOT
( SUM([Source]) FOR [Subject] IN ( [数学],[英语],[语文] ) ) AS pvt
ORDER BY pvt.[UserName];
GO</code></pre> 
<p><img alt="wps_clip_image-23886" src="https://images2.imgbox.com/ea/e1/hp46Qz5q_o.png"></p> 
<p></p> 
<h4>2. 动态方式</h4> 
<p>在上面静态的SQL基础上进行修改，这样就不用理会记录里面存储了什么，需要转成什么列名的问题了</p> 
<pre><code class="language-sql">--4：动态PIVOT行转列
DECLARE @sql_str VARCHAR(8000)
DECLARE @sql_col VARCHAR(8000)
SELECT @sql_col = ISNULL(@sql_col + ',','') + QUOTENAME([Subject]) FROM [TestRows2Columns] GROUP BY [Subject]
SET @sql_str = '
SELECT * FROM (
    SELECT [UserName],[Subject],[Source] FROM [TestRows2Columns]) p PIVOT 
    (SUM([Source]) FOR [Subject] IN ( '+ @sql_col +') ) AS pvt 
ORDER BY pvt.[UserName]'
PRINT (@sql_str)
EXEC (@sql_str);</code></pre> 
<p></p> 
<h3>五、 参数化动态PIVOT行转列</h3> 
<p>也许很多人到了上面一步就够了，但是你会发现，当别人拿到你的代码，需要不断的修改成他自己环境中表名、分组列、行转列字段、字段值这几个参数。所以，我继续对上面的脚本进行修改，你只要设置自己的参数就可以实现行转列了</p> 
<pre><code class="language-sql">--5：参数化动态PIVOT行转列
-- =============================================
-- Author:        &lt;听风吹雨&gt;
-- Create date: &lt;2014.05.26&gt;
-- Description:    &lt;参数化动态PIVOT行转列&gt;
-- Blog:        &lt;http://www.cnblogs.com/gaizai/&gt;
-- =============================================
DECLARE @sql_str NVARCHAR(MAX)
DECLARE @sql_col NVARCHAR(MAX)
DECLARE @tableName SYSNAME --行转列表
DECLARE @groupColumn SYSNAME --分组字段
DECLARE @row2column SYSNAME --行变列的字段
DECLARE @row2columnValue SYSNAME --行变列值的字段
SET @tableName = 'TestRows2Columns'
SET @groupColumn = 'UserName'
SET @row2column = 'Subject'
SET @row2columnValue = 'Source'

--从行数据中获取可能存在的列
SET @sql_str = N'
SELECT @sql_col_out = ISNULL(@sql_col_out + '','','''') + QUOTENAME(['+@row2column+']) 
    FROM ['+@tableName+'] GROUP BY ['+@row2column+']'
--PRINT @sql_str
EXEC sp_executesql @sql_str,N'@sql_col_out NVARCHAR(MAX) OUTPUT',@sql_col_out=@sql_col OUTPUT
--PRINT @sql_col

SET @sql_str = N'
SELECT * FROM (
    SELECT ['+@groupColumn+'],['+@row2column+'],['+@row2columnValue+'] FROM ['+@tableName+']) p PIVOT 
    (SUM(['+@row2columnValue+']) FOR ['+@row2column+'] IN ( '+ @sql_col +') ) AS pvt 
ORDER BY pvt.['+@groupColumn+']'
--PRINT (@sql_str)
EXEC (@sql_str)</code></pre> 
<p><img alt="wps_clip_image-17757" src="https://images2.imgbox.com/4b/38/09MLIiCf_o.png"></p> 
<p>在实际的运用中，经常遇到需要对基础表的数据进行筛选后再进行行转列，下面的脚本将满足你这个需求：</p> 
<pre><code class="language-sql">--6：带条件查询的参数化动态PIVOT行转列
-- =============================================
-- Author:        &lt;听风吹雨&gt;
-- Create date: &lt;2014.05.26&gt;
-- Description:    &lt;参数化动态PIVOT行转列，带条件查询的参数化动态PIVOT行转列&gt;
-- Blog:        &lt;http://www.cnblogs.com/gaizai/&gt;
-- =============================================
DECLARE @sql_str NVARCHAR(MAX)
DECLARE @sql_col NVARCHAR(MAX)
DECLARE @sql_where NVARCHAR(MAX)
DECLARE @tableName SYSNAME --行转列表
DECLARE @groupColumn SYSNAME --分组字段
DECLARE @row2column SYSNAME --行变列的字段
DECLARE @row2columnValue SYSNAME --行变列值的字段
SET @tableName = 'TestRows2Columns'
SET @groupColumn = 'UserName'
SET @row2column = 'Subject'
SET @row2columnValue = 'Source'
SET @sql_where = 'WHERE UserName = ''王五'''

--从行数据中获取可能存在的列
SET @sql_str = N'
SELECT @sql_col_out = ISNULL(@sql_col_out + '','','''') + QUOTENAME(['+@row2column+']) 
    FROM ['+@tableName+'] '+@sql_where+' GROUP BY ['+@row2column+']'
--PRINT @sql_str
EXEC sp_executesql @sql_str,N'@sql_col_out NVARCHAR(MAX) OUTPUT',@sql_col_out=@sql_col OUTPUT
--PRINT @sql_col

SET @sql_str = N'
SELECT * FROM (
    SELECT ['+@groupColumn+'],['+@row2column+'],['+@row2columnValue+'] FROM ['+@tableName+']'+@sql_where+') p PIVOT 
    (SUM(['+@row2columnValue+']) FOR ['+@row2column+'] IN ( '+ @sql_col +') ) AS pvt 
ORDER BY pvt.['+@groupColumn+']'
--PRINT (@sql_str)
EXEC (@sql_str)</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0e6558787a01cc7d43f67dab04a75883/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue 实现Ctrl &#43; S / C / V</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2de095f3f032cdeba23d095ea22cdcc0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一行代码解决PyTorch训练模型时突然出现的For debugging consider passing CUDA_LAUNCH_BLOCKING=1报错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>