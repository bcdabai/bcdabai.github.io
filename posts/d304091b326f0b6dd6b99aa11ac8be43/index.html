<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Gitlab7.14 中文版安装教程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Gitlab7.14 中文版安装教程" />
<meta property="og:description" content="Gitlab7.14 中文版安装教程 注： 本教程由羞涩梦整理同步发布，本人技术分享站点：blog.hukanfa.com转发本文请备注原文链接，本文内容整理日期：2024-01-28csdn 博客名称：五维空间-影子，欢迎关注 1 简要说明 说明
为何写本文 1、本人所在公司目前在用的gilab版本为7.14.3，鉴于版本比较老打算迁移到新版。 2、旧版乃前人所部署，部署方式也比较传统：通过手动一步步搭环境和组件，还是比较繁琐 3、本人一般用docker方式部署gitlab，借此机会通过手动方式实现下gilab部署也是有必要的 gitlab简介 1、Ruby on Rails 开发的开源应用程序，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目 2、与Github类似的功能，能够浏览源代码，管理缺陷和注释， 3、可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库 本次部署gitlab所用到的环境和依赖版本说明 # 以下依赖版本可根据需求选择，可以使用较新版本代替 * 系统版本：Centos 7 * gitlab：7-14中文版|英文版 * ruby：2.2.0 * mysql：5.7 * nginx：1.8.0 * git: 2.8.2 * redis：yum 版本 特别说明：由于旧版距今很多年，重新部署还是有很多坑。也许你按照文档走还会碰到新的问题，希望能克服！
2 前期部署 2.1 基本配置 操作如下
关闭防火墙相关 # 永久 sed -i &#39;s/^SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/sysconfig/selinux # 临时 setenforce 0 systemctl stop firewalld systemctl disable firewalld 安装epel源 # 方式一 yum -y install epel* # 方式二（推荐） wget https://dl." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d304091b326f0b6dd6b99aa11ac8be43/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-28T20:01:43+08:00" />
<meta property="article:modified_time" content="2024-01-28T20:01:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Gitlab7.14 中文版安装教程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2 align="center">Gitlab7.14 中文版安装教程</h2> 
<ul><li><code>注</code>： 
  <ul><li>本教程由<strong>羞涩梦</strong>整理同步发布，本人技术分享站点：blog.hukanfa.com</li><li>转发本文请备注原文链接，本文内容整理日期：2024-01-28</li><li><strong>csdn</strong> 博客名称：五维空间-影子，欢迎关注</li></ul> </li></ul> 
<h2><a id="1__9"></a>1 简要说明</h2> 
<ul><li> <p>说明</p> 
  <ul><li>为何写本文</li></ul> <pre><code class="prism language-shell"><span class="token number">1</span>、本人所在公司目前在用的gilab版本为7.14.3，鉴于版本比较老打算迁移到新版。
<span class="token number">2</span>、旧版乃前人所部署，部署方式也比较传统：通过手动一步步搭环境和组件，还是比较繁琐
<span class="token number">3</span>、本人一般用docker方式部署gitlab，借此机会通过手动方式实现下gilab部署也是有必要的
</code></pre> 
  <ul><li>gitlab简介</li></ul> <pre><code class="prism language-shell"><span class="token number">1</span>、Ruby on Rails 开发的开源应用程序，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目
<span class="token number">2</span>、与Github类似的功能，能够浏览源代码，管理缺陷和注释，
<span class="token number">3</span>、可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库
</code></pre> 
  <ul><li>本次部署gitlab所用到的环境和依赖版本说明</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 以下依赖版本可根据需求选择，可以使用较新版本代替</span>

* 系统版本：Centos <span class="token number">7</span>
* gitlab：7-14中文版<span class="token operator">|</span>英文版
* ruby：2.2.0
* mysql：5.7
* nginx：1.8.0 
* git: <span class="token number">2.8</span>.2
* redis：yum 版本
</code></pre> </li></ul> 
<p><code>特别说明</code>：由于旧版距今很多年，重新部署还是有很多坑。也许你按照文档走还会碰到新的问题，希望能克服！</p> 
<h2><a id="2__49"></a>2 前期部署</h2> 
<h3><a id="21__51"></a>2.1 基本配置</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>关闭防火墙相关</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 永久</span>
<span class="token function">sed</span> -i <span class="token string">'s/^SELINUX=enforcing/SELINUX=disabled/g'</span>  /etc/sysconfig/selinux
<span class="token comment"># 临时</span>
setenforce <span class="token number">0</span>

systemctl stop firewalld
systemctl disable firewalld
</code></pre> 
  <ul><li>安装<code>epel</code>源</li></ul> <pre><code class="prism language-shell">  <span class="token comment"># 方式一</span>
  yum -y <span class="token function">install</span> epel* 
  
  <span class="token comment"># 方式二（推荐）</span>
  <span class="token function">wget</span> https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
  <span class="token function">rpm</span> -ivh epel-release-latest-7.noarch.rpm
  
<span class="token comment"># 导入key</span>
  <span class="token function">rpm</span> --import https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-7
</code></pre> 
  <ul><li>安装<code>puias</code>源</li></ul> <pre><code class="prism language-shell"><span class="token comment">#  puias 是基于RH的一个扩展distribution和mirror，目前它由普林斯顿高能所维护。</span>

<span class="token comment"># /etc/yum.repos.d/puias-computational.repo</span>
<span class="token punctuation">[</span>PUIAS_computational<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>PUIAS computational Base <span class="token variable">$releasever</span> - <span class="token variable">$basearch</span>
<span class="token assign-left variable">mirrorlist</span><span class="token operator">=</span>http://puias.math.ias.edu/data/puias/computational/<span class="token variable">$releasever</span>/<span class="token variable">$basearch</span>/mirrorlist
<span class="token comment">#baseurl=http://puias.math.ias.edu/data/puias/computational/$releasever/$basearch</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-puias

<span class="token comment"># 导入key，下面二选一</span>
<span class="token function">rpm</span> --import http://puias.princeton.edu/data/puias/7/x86_64/os/RPM-GPG-KEY-puias
<span class="token comment"># rpm --import http://springdale.math.ias.edu/data/puias/7/x86_64/os/RPM-GPG-KEY-puias</span>
</code></pre> 
  <ul><li>重新建立缓存</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 建立缓存</span>
yum clean all <span class="token operator">&amp;&amp;</span> yum makecache
</code></pre> 
  <ul><li>创建git用户</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 请确保用户家目录有足够磁盘空间，因为后续仓库默认的数据都在其家目录下。也可修改到其他目录</span>
<span class="token comment"># 默认/home/git，如需指定家目录使用 -d 参数</span>
<span class="token function">useradd</span> <span class="token function">git</span>
<span class="token comment"># 设置密码  fZ2ICa7w</span>
<span class="token function">passwd</span> <span class="token function">git</span>
<span class="token comment"># 配置sudo权限</span>
<span class="token builtin class-name">echo</span> <span class="token string">"git ALL=(ALL) NOPASSWD: ALL"</span> <span class="token operator">&gt;&gt;</span>/etc/sudoers

<span class="token builtin class-name">echo</span> <span class="token string">"export git_SSL_NO_VERIFY=1"</span> <span class="token operator">&gt;&gt;</span> /home/git/.bash_profile
<span class="token builtin class-name">source</span> /home/git/.bash_profile

<span class="token comment"># 不添加变量的话使用https链接会报如下错误，不过本文没有使用https</span>
fatal: unable to access <span class="token string">'https://github.com/gitlabhq/grit.git/'</span><span class="token builtin class-name">:</span> Peer certificate cannot be authenticated with known CA certificates
</code></pre> </li></ul> 
<h3><a id="22_Development_Tools_126"></a>2.2 安装Development Tools</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li><strong>不要</strong> 用yum安装ruby、git、nginx 和 mysql，redis可以使用yum安装</li></ul> <pre><code class="prism language-shell">yum -y <span class="token function">install</span> readline readline-devel ncurses-devel gdbm-devel glibc-devel tcl-devel expat-devel db4-devel byacc sqlite-devel libyaml libyaml-devel libffi libffi-devel libxml2 libxml2-devel libxslt libxslt-devel libicu libicu-devel system-config-firewall-tui python-devel redis <span class="token function">wget</span> crontabs logwatch <span class="token function">logrotate</span> perl-Time-HiRes gettext gettext-devel openssl-devel zlib-devel gcc gcc-c++ <span class="token function">make</span> autoconf tk-devel python-pip patch pcre-devel <span class="token function">curl</span> curl-devel <span class="token function">sudo</span> yum-plugin-fastestmirror cmake perl-CPAN nodejs automake libxml* libmcrypt* libtool-ltdl-devel* yum-utils
</code></pre> 
  <ul><li>卸载已经安装的包</li></ul> <pre><code class="prism language-shell">yum -y remove ruby <span class="token function">git</span> nginx mysql mysql-server
</code></pre> 
  <ul><li>安装Development Tools开发组包</li></ul> <pre><code class="prism language-shell">yum -y groupinstall <span class="token string">'Development Tools'</span>
</code></pre> </li></ul> 
<h3><a id="23__150"></a>2.3 配置时间同步</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>更新<code>localtime</code>文件</li></ul> <pre><code class="prism language-shell"><span class="token function">rm</span> -f /etc/localtime
<span class="token function">ln</span> -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre> 
  <ul><li>安装</li></ul> <pre><code class="prism language-shell"><span class="token comment"># yum 方式</span>
yum -y <span class="token function">install</span> ntp
<span class="token comment"># 同步时间</span>
ntpdate pool.ntp.org

<span class="token comment"># 配置定时任务同步时间，也可以通过 crontba -e 设置</span>
<span class="token builtin class-name">echo</span> <span class="token string">'*/20 * * * * /usr/sbin/ntpdate pool.ntp.org &gt; /dev/null 2&gt;&amp;1'</span> <span class="token operator">&gt;&gt;</span> /var/spool/cron/root

<span class="token comment"># 查看</span>
$ <span class="token function">crontab</span> -l
*/20 * * * * /usr/sbin/ntpdate pool.ntp.org <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
</code></pre> </li></ul> 
<h3><a id="24_git_179"></a>2.4 安装git</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>下载安装包</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 不检查证书下载</span>
<span class="token function">wget</span> https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.8.2.tar.gz --no-check-certificate

<span class="token comment"># 编译安装</span>
<span class="token function">tar</span> zxvf git-2.8.2.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> git-2.8.2
./configure --prefix<span class="token operator">=</span>/usr/local/git
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>

<span class="token comment"># 确认git版本，如有其他旧版本是还没卸载干净</span>
$ <span class="token function">git</span> --version
<span class="token function">git</span> version <span class="token number">1.8</span>.3.1
$ yum -y remove <span class="token function">git</span>

<span class="token comment"># 全局环境变量</span>
<span class="token builtin class-name">echo</span> <span class="token string">'export PATH="/usr/local/git/bin:<span class="token environment constant">$PATH</span>"'</span> <span class="token operator">&gt;&gt;</span> /etc/profile
<span class="token comment"># 刷新</span>
<span class="token builtin class-name">source</span> /etc/profile

<span class="token comment"># 验证</span>
<span class="token function">git</span> --version
</code></pre> </li></ul> 
<h3><a id="25_nginx_211"></a>2.5 安装nginx</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>下载源码包并安装</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 下载</span>
<span class="token function">wget</span> http://nginx.org/download/nginx-1.8.0.tar.gz

<span class="token comment"># 解压</span>
<span class="token function">tar</span> -zxvf nginx-1.8.0.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> nginx-1.8.0

<span class="token comment"># 编译安装</span>
./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>hukanfa --group<span class="token operator">=</span>hukanfa --with-http_ssl_module --with-http_stub_status_module --with-pcre

<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> </li></ul> 
<h2><a id="3_redis_234"></a>3 安装redis</h2> 
<ul><li> <p>操作如下</p> 
  <ul><li>前面已经使用yum安装过了，下面主要是配置</li><li>使用socket方式连接<code>redis</code>(&gt;= redis 2.4.0)</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 备份之前配置,修改端口号,添加socket配置,添加socket权限,启动服务</span>
<span class="token function">cp</span> -ar /etc/redis.conf /etc/redis.conf.bak

<span class="token comment"># 修改以下redis配置 /etc/redis.conf</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
port <span class="token number">6379</span>
unixsocket /var/run/redis/redis.sock
unixsocketperm 0775

<span class="token comment"># 启动服务</span>
systemctl start redis
systemctl status redis

<span class="token comment"># 配置开机自启</span>
systemctl <span class="token builtin class-name">enable</span> redis
<span class="token comment"># chkconfig redis on</span>
</code></pre> 
  <ul><li>将git用户添加到redis组</li></ul> <pre><code class="prism language-shell">$ gpasswd -a <span class="token function">git</span> redis
Adding user <span class="token function">git</span> to group redis
$ <span class="token function">id</span> <span class="token function">git</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">(</span>git<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">(</span>git<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">(</span>git<span class="token punctuation">)</span>,993<span class="token punctuation">(</span>redis<span class="token punctuation">)</span>
</code></pre> </li></ul> 
<h2><a id="4_mysql_275"></a>4 安装mysql</h2> 
<h3><a id="41__277"></a>4.1 下载安装包</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>添加mysql用户</li></ul> <pre><code class="prism language-shell"><span class="token function">groupadd</span> mysql
<span class="token function">useradd</span>  -g mysql -s /sbin/nologin mysql
</code></pre> 
  <ul><li>获取安装包</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 官网源码包下载地址，选择对应版本下载即可。下载跳转页面选择左下角不登陆下载，见图</span>
https://dev.mysql.com/downloads/mysql/
<span class="token comment"># 具体下载链接（下载带boots的，后续mysql版本都需要boots）</span>
<span class="token function">wget</span> https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-boost-5.7.44.tar.gz
<span class="token comment"># 百度网盘下载链接</span>
https://pan.baidu.com/s/1wrlTyaigxvTKTNf6H8F4KQ?pwd<span class="token operator">=</span>fniy 
</code></pre> </li></ul> 
<p><img src="https://images2.imgbox.com/4e/54/F2hJ7bTr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/92/0e/bOKwIDYp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="42__307"></a>4.2 编译安装</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>准备所需的文件路径</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 安装目录及pid文件所在目录\数据目录、日志目录</span>
<span class="token function">mkdir</span> -p /usr/local/mysql57/<span class="token punctuation">{<!-- --></span>data,logs<span class="token punctuation">}</span>
<span class="token comment"># socket 文件路径</span>
/tmp
</code></pre> 
  <ul><li>安装<code>msyql-boost</code></li></ul> <pre><code class="prism language-shell"><span class="token comment"># 解压</span>
<span class="token function">tar</span> -zxvf mysql-boost-5.7.44.tar.gz
<span class="token comment"># 进入到解压目录下</span>
<span class="token builtin class-name">cd</span> mysql-5.7.44
</code></pre> 
  <ul><li>编译安装</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 注意 -DWITH_BOOST=boost 只是相对于cmake执行的当前路径，若是其他路径请写全路径</span>
<span class="token comment"># 预编译</span>
cmake <span class="token builtin class-name">.</span> <span class="token punctuation">\</span>
-DCMAKE_INSTALL_PREFIX<span class="token operator">=</span>/usr/local/mysql57 <span class="token punctuation">\</span>
-DDOWNLOAD_BOOST<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
-DWITH_BOOST<span class="token operator">=</span>boost <span class="token punctuation">\</span>
-DWITH_INNOBASE_STORAGE_ENGINE<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
-DMYSQL_TCP_PORT<span class="token operator">=</span><span class="token number">3306</span> <span class="token punctuation">\</span>
-DWITH_EXTRA_CHARSETS<span class="token operator">=</span>all <span class="token punctuation">\</span>
-DWITH_READLINE<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
-DENABLED_LOCAL_INFILE<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
-DDEFAULT_CHARSET<span class="token operator">=</span>utf8mb4 <span class="token punctuation">\</span>
-DDEFAULT_COLLATION<span class="token operator">=</span>utf8mb4_general_ci

<span class="token comment"># 正式编译(这个过程需要等待十几分钟)，安装过程无异常退出则成功(~ ~)</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> 
  <ul><li>安装成功后，路径下会有以下目录</li></ul> <pre><code class="prism language-shell">$ <span class="token builtin class-name">pwd</span>
/usr/local/mysql57
$ <span class="token function">ls</span>
bin  data  docs  include  lib  LICENSE  logs  <span class="token function">man</span>  mysql-test  README  README-test  share  support-files
</code></pre> </li></ul> 
<h3><a id="43__363"></a>4.3 调整配置</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>目录授权</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 更改安装目录所属为mysql用户</span>
<span class="token function">chown</span> -R mysql:mysql /usr/local/mysql57
</code></pre> 
  <ul><li>编辑主配置文件<code>my.cnf</code></li></ul> <pre><code class="prism language-shell"><span class="token comment"># 备份原配置</span>
<span class="token function">cp</span> -ar /etc/my.cnf  /etc/my.cnf.bak
<span class="token comment"># 清空配置文件</span>
<span class="token operator">&gt;</span> /etc/my.cnf
<span class="token comment"># vim /etc/my.cnf</span>
<span class="token punctuation">[</span>client<span class="token punctuation">]</span>
port <span class="token operator">=</span> <span class="token number">3306</span>
socket <span class="token operator">=</span> /tmp/mysql.sock
default-character-set <span class="token operator">=</span> utf8mb4
 
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
port <span class="token operator">=</span> <span class="token number">3306</span>
user <span class="token operator">=</span> mysql
pid-file <span class="token operator">=</span> /usr/local/mysql57/mysql.pid
socket <span class="token operator">=</span> /tmp/mysql.sock
basedir <span class="token operator">=</span> /usr/local/mysql57
datadir <span class="token operator">=</span> /usr/local/mysql57/data
 
log_error <span class="token operator">=</span> /usr/local/mysql57/logs/error.log
slow_query_log_file <span class="token operator">=</span> /usr/local/mysql57/logs/slow.log

<span class="token punctuation">[</span>mysqldump<span class="token punctuation">]</span>
quick
max_allowed_packet <span class="token operator">=</span> 16M
 
<span class="token punctuation">[</span>myisamchk<span class="token punctuation">]</span>
key_buffer_size         <span class="token operator">=</span> 256M
sort_buffer_size        <span class="token operator">=</span> 8M
read_buffer             <span class="token operator">=</span> 4M
write_buffer            <span class="token operator">=</span> 4M
</code></pre> 
  <ul><li>初始化</li></ul> <pre><code class="prism language-shell"><span class="token comment"># cd /usr/local/mysql57</span>
./bin/mysqld --initialize-insecure --user<span class="token operator">=</span>mysql --basedir<span class="token operator">=</span>/usr/local/mysql57 --datadir<span class="token operator">=</span>/usr/local/mysql57/data
<span class="token comment"># 执行完成后data目录下会生产初始数据</span>
</code></pre> 
  <ul><li>配置环境变量</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 全局环境变量</span>
<span class="token builtin class-name">echo</span> <span class="token string">'export PATH="/usr/local/mysql57/bin:<span class="token environment constant">$PATH</span>"'</span> <span class="token operator">&gt;&gt;</span> /etc/profile
<span class="token comment"># 刷新</span>
<span class="token builtin class-name">source</span> /etc/profile
</code></pre> </li><li> <p><strong>初始化特别说明</strong></p> 
  <ul><li><code>–initialize</code>：会生成一个随机密码(~/.mysql_secret)</li><li><code>--initialize-insecure</code>：不会生成密码，后续再另行设定</li></ul> </li></ul> 
<h3><a id="44__435"></a>4.4 启动项设置</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>使用 <strong>systemctl</strong> 管理</li></ul> <pre><code class="prism language-shell"><span class="token comment"># vim /usr/lib/systemd/system/mysql.service</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>The Mysql Process Manager
<span class="token assign-left variable">After</span><span class="token operator">=</span>syslog.target network.target remote-fs.target nss-lookup.target
 
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">PIDFile</span><span class="token operator">=</span>/usr/local/mysql57/mysql.pid
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/mysql57/support-files/mysql.server start
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -s HUP <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/bin/kill -s QUIT <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>false
 
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> 
  <ul><li>启动服务</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 重载配置</span>
systemctl daemon-reload
<span class="token comment"># 启动服务</span>
systemctl start mysql
<span class="token comment"># 查看状态</span>
<span class="token punctuation">[</span>root@hukanfa support-files<span class="token punctuation">]</span><span class="token comment"># systemctl status mysql</span>
● mysql.service - The Mysql Process Manager
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/mysql.service<span class="token punctuation">;</span> disabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span>
<span class="token comment"># 开机自启动</span>
systemctl <span class="token builtin class-name">enable</span> mysql
</code></pre> 
  <ul><li>创建数据库及<strong>gitlab</strong>用户</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 登录数据库，无密码。后续可自行设置</span>
mysql -u root
<span class="token comment"># 创建数据库</span>
CREATE DATABASE IF NOT EXISTS gitlabhq_production<span class="token punctuation">;</span>
<span class="token comment"># 创建用户</span>
GRANT ALL PRIVILEGES ON gitlabhq_production.* TO <span class="token string">'git'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'cX4ncpjZMU'</span><span class="token punctuation">;</span>
<span class="token comment"># 刷新权限</span>
FLUSH PRIVILEGES<span class="token punctuation">;</span>
</code></pre> 
  <ul><li>测试连接</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 输入密码后登录</span>
mysql -ugit -p
<span class="token comment"># 查看库</span>
mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+---------------------+
<span class="token operator">|</span> Database            <span class="token operator">|</span>
+---------------------+
<span class="token operator">|</span> information_schema  <span class="token operator">|</span>
<span class="token operator">|</span> gitlabhq_production <span class="token operator">|</span>
+---------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> </li></ul> 
<h2><a id="5_gitlab_508"></a>5 安装gitlab</h2> 
<p><strong><code>注</code></strong>：此篇开始，一般使用<code>git</code>用户环境操作</p> 
<h3><a id="51_ruby_514"></a>5.1 安装ruby</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>下载ruby源码包</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 查看ruby版本</span>
https://www.ruby-lang.org/zh_cn/downloads/releases/

<span class="token comment"># 下载</span>
<span class="token function">wget</span> http://cache.ruby-lang.org/pub/ruby/2.2/ruby-2.2.0.tar.gz

</code></pre> 
  <ul><li>编译安装ruby</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 解压</span>
<span class="token function">tar</span> -zxvf <span class="token function">tar</span> -zxvf ruby-2.2.0.tar.gz

<span class="token comment"># 编译安装</span>
<span class="token builtin class-name">cd</span> ruby-2.2.0
./configure --prefix<span class="token operator">=</span>/usr/local/ruby --disable-install-rdoc
<span class="token function">make</span> clean <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>

<span class="token comment"># 全局环境变量</span>
<span class="token builtin class-name">echo</span> <span class="token string">'export PATH="/usr/local/ruby/bin:<span class="token environment constant">$PATH</span>"'</span> <span class="token operator">&gt;&gt;</span> /etc/profile
<span class="token comment"># 刷新</span>
<span class="token builtin class-name">source</span> /etc/profile

<span class="token comment"># 验证</span>
gem --version
<span class="token comment">####</span>
<span class="token number">2.4</span>.5
ruby --version
<span class="token comment">####</span>
ruby <span class="token number">2.2</span>.0p0 <span class="token punctuation">(</span><span class="token number">2014</span>-12-25 revision <span class="token number">49005</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>x86_64-linux<span class="token punctuation">]</span>
  
<span class="token function">chown</span> -R git:git /usr/local/ruby
</code></pre> </li></ul> 
<h3><a id="52_bundler_560"></a>5.2 安装bundler</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>添加国内源</li></ul> <pre><code class="prism language-shell"><span class="token comment"># gem source --remove|-r --add|-a</span>
<span class="token comment"># 删除默认源 # 新增国内源</span>
gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/
<span class="token comment"># gem source -a http://mirrors.aliyun.com/rubygems/</span>
<span class="token comment"># 更新缓存</span>
gem sources -u
<span class="token comment"># 查看在用的源</span>
gem sources -l
</code></pre> 
  <ul><li>安装bundler</li></ul> <pre><code class="prism language-shell"><span class="token comment"># ruby2.5.0 版本只支持 bundler2.0.0以下版本，之下最新版本为：1.17.3</span>
gem <span class="token function">install</span> bundler -v <span class="token number">1.17</span>.3
<span class="token comment"># 安装完成后，bundle/bundler命令默认在ruby安装目录bin下，如/usr/local/ruby/bin/</span>

<span class="token comment"># bundler版本查看链接</span>
https://github.com/rubygems/bundler/tags
</code></pre> 
  <ul><li>如果遇到 SSL 证书问题，请修改 <code>~/.gemrc</code> 文件，增加 <code>ssl_verify_mode: 0</code> 配置，以便于 RubyGems 可以忽略 SSL 证书错误。</li></ul> <pre><code class="prism language-shell"><span class="token comment"># vim  ~/.gemrc</span>
</code></pre> </li></ul> 
<hr> 
<p>:sources:</p> 
<ul><li> <p>https://gems.ruby-china.com<br> :ssl_verify_mode: 0</p> <pre><code>
</code></pre> </li></ul> 
<h3><a id="53_gitlabshell_607"></a>5.3 安装gitlab-shell</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>切换到git用户</li></ul> <pre><code class="prism language-shell"><span class="token function">su</span> - <span class="token function">git</span>
<span class="token comment"># 配置gem安装忽略证书认证</span>
<span class="token function">vim</span>  ~/.gemrc
---
:backtrace: <span class="token boolean">false</span>
:bulk_threshold: <span class="token number">1000</span>
:sources:
- https://gems.ruby-china.com/
:ssl_verify_mode: <span class="token number">0</span>
:update_sources: <span class="token boolean">true</span>
:verbose: <span class="token boolean">true</span>
</code></pre> 
  <ul><li>下载仓库代码</li></ul> <pre><code class="prism language-shelll">git clone https://gitlab.com/gitlab-org/gitlab-shell.git -b v2.7.2
cd gitlab-shell/
cp config.yml.example config.yml
vi config.yml
</code></pre> 
  <ul><li>修改配置</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 配置自己的gitlab域名和端口，没有就用默认</span>
gitlab_url: <span class="token string">"http://localhost:8080"</span>
<span class="token comment"># 下面修改的内容为git指定家目录后的操作，如果是默认的/home/git则不需要修改，后面不再提示</span>
<span class="token comment">##################################</span>
repos_path: <span class="token string">"/home/git/repositories"</span>
auth_file: <span class="token string">"/home/git/.ssh/authorized_keys"</span>
<span class="token comment">##################################</span>
</code></pre> 
  <ul><li>配置gitlab-shell使用reidis-socket</li></ul> <pre><code class="prism language-shell">redis:
bin: /usr/bin/redis-cli
<span class="token comment"># host: 127.0.0.1</span>
<span class="token comment"># port: 6379</span>
<span class="token comment"># pass: redispass # Allows you to specify the password for Redis</span>
database: <span class="token number">0</span>
socket: /var/run/redis/redis.sock
namespace: resque:gitlab
</code></pre> 
  <ul><li>安装</li></ul> <pre><code class="prism language-shell">./bin/install

<span class="token comment"># cd ~</span>
</code></pre> </li></ul> 
<h3><a id="54__673"></a>5.4 拉取代码</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>方式一</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 从官网下载，英文版本。低版本gitlab估计是不能选择语言，最新版本是可以在设置界面选择语言</span>
<span class="token function">git</span> clone https://gitlab.com/gitlab-org/gitlab-ce.git -b <span class="token number">7</span>-14-stable gitlab
</code></pre> 
  <ul><li>方式二</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 中文版 7.14</span>
<span class="token function">git</span> clone https://gitee.com/hukanfa/gitlab.git -b <span class="token number">7</span>-14-zh gitlab
</code></pre> </li></ul> 
<h3><a id="55__694"></a>5.5 修改主配置</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>复制配置文件</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 切换到git用户，进入到gitlab根目录</span>
<span class="token function">cp</span> config/gitlab.yml.example config/gitlab.yml
</code></pre> 
  <ul><li>修改<code>gitlab.yml</code>配置文件，默认用了<code>/home/git</code>路径的基本不用改</li></ul> <pre><code class="prism language-shell"><span class="token function">vim</span> config/gitlab.yml
<span class="token comment">################</span>
:%s/home/data/g
<span class="token comment">################</span>
<span class="token comment">## gitLab settings</span>
gitlab:
<span class="token comment">## 设置域名或用默认</span>
host: localhost 
port: <span class="token number">8080</span>
https: <span class="token boolean">false</span>
<span class="token comment"># 如果准备使用smtp方式发送邮件，这里可以修改为发送邮件的账号，如果使用系统sendmail就不用修改</span>
email_from: noreply@cass.com
email_display_name: GitLab
email_reply_to: noreply@cass.com
<span class="token comment"># 允许使用用户名或邮箱账号登录</span>
allow_username_or_email_login: <span class="token boolean">true</span>
<span class="token comment"># 根据需要设定</span>
path: /home/git/gitlab-satellites/

gitlab_shell:
  path: /home/git/gitlab-shell/

<span class="token comment"># REPOS_PATH MUST NOT BE A SYMLINK!!!</span>
repos_path: /home/git/repositories/
hooks_path: /home/git/gitlab-shell/hooks/
<span class="token comment">##################################</span>
<span class="token comment"># ssh端口，根据实际修改</span>
ssh_port: <span class="token number">22</span>
<span class="token comment"># 下面是编译安装git后的路径，默认文件最大大小和超时时间</span>
git:
  bin_path: /usr/local/bin/git
  max_size: <span class="token number">524288000</span> <span class="token comment"># 5.megabytes</span>
  timeout: <span class="token number">300</span>
</code></pre> 
  <ul><li>修改<code>unicorn.rb</code>，默认**/home/git**目录的不用改</li></ul> <pre><code class="prism language-shell"><span class="token function">cp</span> config/unicorn.rb.example config/unicorn.rb
<span class="token function">vim</span> config/unicorn.rb
<span class="token comment">###################################</span>
working_directory <span class="token string">"/home/git/gitlab"</span> <span class="token comment"># available in 0.94.0+</span>
listen <span class="token string">"/home/git/gitlab/tmp/sockets/gitlab.socket"</span>, :backlog <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">64</span>
pid <span class="token string">"/home/git/gitlab/tmp/pids/unicorn.pid"</span>
stderr_path <span class="token string">"/home/git/gitlab/log/unicorn.stderr.log"</span>
stdout_path <span class="token string">"/home/git/gitlab/log/unicorn.stdout.log"</span>

<span class="token comment"># 默认8080端口，如果被占用自修改</span>
listen <span class="token string">"127.0.0.1:8080"</span>, :tcp_nopush <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
<span class="token function">timeout</span> <span class="token number">300</span>
</code></pre> 
  <ul><li>创建目录</li></ul> <pre><code class="prism language-shell"><span class="token function">mkdir</span> /home/git/gitlab-satellites
</code></pre> 
  <ul><li>关于<code>rack_attack.rb</code></li></ul> <pre><code class="prism language-shell"><span class="token comment"># rack-attack 可以根据ip、域名等设置黑名单、设置访问频率。请按需配置，这里暂不配置</span>
<span class="token function">cp</span> config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb
<span class="token comment"># 关于这块使用附上参考博文： https://blog.csdn.net/qq_41037744/article/details/134519179</span>
</code></pre> </li></ul> 
<h3><a id="56__778"></a>5.6 修改数据库配置</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>修改连接redis配置</li></ul> <pre><code class="prism language-shell"><span class="token function">cp</span> config/resque.yml.example config/resque.yml
<span class="token comment"># 修改配置</span>
<span class="token function">vim</span> config/resque.yml
<span class="token comment">###################################</span>
development: redis://localhost:6379
test: redis://localhost:6379
production: unix:/var/run/redis/redis.sock
</code></pre> 
  <ul><li>修改连接数据mysql库配置</li></ul> <pre><code class="prism language-shell"><span class="token function">cp</span> config/database.yml.mysql config/database.yml
<span class="token function">vim</span> config/database.yml
<span class="token comment">############################</span>
production:
  adapter: mysql2
  encoding: utf8mb4
  collation: utf8mb4_general_ci
  reconnect: <span class="token boolean">false</span>
  database: gitlabhq_production
  pool: <span class="token number">10</span>
  username: root  <span class="token comment"># 这里之前用git用户，但发现有下面报错提示，懒得排查直接换成root，之前没设置过密码</span>
  <span class="token comment">#password: "cX4ncpjZMUv"</span>
  <span class="token comment">#host: localhost</span>
  <span class="token comment"># socket: /tmp/mysql.sock</span>
  
<span class="token comment"># 用git用户报错</span>
Access denied <span class="token keyword">for</span> user <span class="token string">'git'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span>using password: YES<span class="token punctuation">)</span>Please provide the root password <span class="token keyword">for</span> your mysql installation
</code></pre> </li></ul> 
<h3><a id="57_gems_819"></a>5.7 安装gems</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>安装</li></ul> <pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> ~/gitlab
<span class="token function">sudo</span> gem <span class="token function">install</span> charlock_holmes --version <span class="token string">'0.6.9'</span>
<span class="token comment">#####</span>
Fetching: charlock_holmes-0.6.9.gem <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
Installing ri documentation <span class="token keyword">for</span> charlock_holmes-0.6.9
Done installing documentation <span class="token keyword">for</span> charlock_holmes after <span class="token number">6</span> seconds
<span class="token number">1</span> gem installed
</code></pre> 
  <ul><li>修改源为国内</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 1</span>
<span class="token function">vim</span> Gemfile
<span class="token builtin class-name">source</span> <span class="token string">"https://rubygems.org"</span> 改为
<span class="token builtin class-name">source</span> <span class="token string">"https://gems.ruby-china.com"</span>
<span class="token comment"># source "http://mirrors.aliyun.com/rubygems"</span>
<span class="token comment"># 2</span>
<span class="token function">vim</span> Gemfile.lock
<span class="token builtin class-name">source</span> <span class="token string">"https://gems.ruby-china.com"</span>
</code></pre> 
  <ul><li>修改文件</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 【1】第一波更改</span>
<span class="token comment">### vim Gemfile.lock  行首添加</span>
GIT
  remote: https://gitee.com/hukanfa/gemnasium-gitlab-service
  revision: 4f2f3cb0003c8f5938286cb7161ff93d2804f934
  specs:
    gemnasium-gitlab-service <span class="token punctuation">(</span><span class="token number">0.2</span>.6<span class="token punctuation">)</span>
      rugged <span class="token punctuation">(</span>~<span class="token operator">&gt;</span> <span class="token number">0.21</span><span class="token punctuation">)</span>
<span class="token comment"># 删掉</span>
<span class="token number">260</span>     gemnasium-gitlab-service <span class="token punctuation">(</span><span class="token number">0.2</span>.6<span class="token punctuation">)</span>
<span class="token number">261</span>       rugged <span class="token punctuation">(</span>~<span class="token operator">&gt;</span> <span class="token number">0.21</span><span class="token punctuation">)</span>
<span class="token comment"># 改为感叹号</span>
<span class="token number">789</span>   gemnasium-gitlab-service<span class="token operator">!</span>

<span class="token comment">### vim Gemfile</span>
<span class="token comment"># 增加</span>
gem <span class="token string">"gemnasium-gitlab-service"</span>, git: <span class="token string">"https://gitee.com/hukanfa/gemnasium-gitlab-service"</span>
<span class="token comment"># 删掉</span>
<span class="token number">157</span> gem <span class="token string">"gemnasium-gitlab-service"</span>, <span class="token string">"~&gt; 0.2"</span>

<span class="token comment"># 两个文件修改mysql2的版本为 0.3.21</span>
<span class="token comment"># 之后遇到一些依赖报错直接在上面两个文件直接删掉就行，版本过于老旧一些依赖在源中已经找不到了或者新版不支持了</span>
</code></pre> 
  <ul><li>执行安装</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 有些版本低的依赖可打开源站所属对应依赖有哪些版本，重新指定版本</span>
bundle <span class="token function">install</span> --deployment --without development <span class="token builtin class-name">test</span> postgres puma aws wiki
gem <span class="token function">install</span> rdoc-data<span class="token punctuation">;</span> rdoc-data --install
</code></pre> </li></ul> 
<h3><a id="58__886"></a>5.8 数据初始化及配置检查</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>初始化数据库</li></ul> <pre><code class="prism language-shell"><span class="token comment"># bundle exec rake gitlab:setup RAILS_ENV=production --verbose</span>
<span class="token punctuation">..</span>.
Do you want to <span class="token builtin class-name">continue</span> <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? <span class="token function">yes</span>
<span class="token comment">#最后初始化成功后会获得账号和密码</span>
<span class="token operator">==</span> Seed from /home/git/gitlab/db/fixtures/production/001_admin.rb

Administrator account created:

login<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.root
password<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>5iveL<span class="token operator">!</span>fe
</code></pre> </li></ul> 
<pre><code>  
- 检查gitLab及其环境的配置是否正确
  
  ```shell
  cd ~/gitlab
  bundle exec rake gitlab:env:info RAILS_ENV=production
  ##########
  [git@hukanfa gitlab]$ bundle exec rake gitlab:env:info RAILS_ENV=production
  
  System information
  System:
  Current User:	git
  Using RVM:	no
  Ruby Version:	2.2.0p0
  Gem Version:	2.4.5
  Bundler Version:1.17.3
  Rake Version:	10.4.2
  Sidekiq Version:3.3.0
  
  GitLab information
  Version:	7.14.3
  Revision:	12bbae4
  Directory:	/home/git/gitlab
  DB Adapter:	mysql2
  URL:		http://localhost:8080
  HTTP Clone URL:	http://localhost:8080/some-group/some-project.git
  SSH Clone URL:	git@localhost:some-group/some-project.git
  Using LDAP:	no
  Using Omniauth:	no
  
  GitLab Shell
  Version:	2.7.2
  Repositories:	/home/git/repositories/
  Hooks:		/home/git/gitlab-shell/hooks/
  Git:		/usr/bin/git
  
  #  bundle exec rake sidekiq:start RAILS_ENV=production
  # bundle exec rake gitlab:check RAILS_ENV=production
  
  # 这里都走一遍
  chmod -R ug+rwX,o-rwx /home/git/repositories/
  chmod -R ug-s /home/git/repositories/
  find /home/git/repositories/ -type d -print0 | sudo xargs -0 chmod g+s
  sudo chmod u+rwx,g=rx,o-rwx /home/git/gitlab-satellites
</code></pre> 
<h3><a id="59_nginx_954"></a>5.9 配置nginx</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>创建启动脚本</li></ul> <pre><code class="prism language-shell"><span class="token comment"># root执行</span>
<span class="token function">cp</span> lib/support/init.d/gitlab /etc/init.d/gitlab
<span class="token function">cp</span> lib/support/init.d/gitlab.default.example /etc/default/gitlab
<span class="token function">cp</span> lib/support/logrotate/gitlab /etc/logrotate.d/gitlab
<span class="token function">chmod</span> +x /etc/init.d/gitlab

<span class="token comment"># 配置开机启动</span>
<span class="token function">chkconfig</span> --add gitlab
<span class="token function">chkconfig</span> gitlab on

<span class="token comment">##### 下面这里如果安装目录不是/home/git/gitlab就需要改 ########</span>
<span class="token comment"># vim /etc/default/gitlab</span>
<span class="token comment"># app_root="/data/$app_user/gitlab"</span>

<span class="token comment">#无需下载</span>
<span class="token comment">##sudo wget https://raw.github.com/gitlabhq/gitlab-recipes/master/init/sysvinit/centos/gitlab-unicorn -P /etc/init.d/</span>
<span class="token comment">##sudo mv /etc/init.d/gitlab-unicorn /etc/init.d/gitlab</span>
<span class="token comment">##########################</span>
</code></pre> </li></ul> 
<pre><code>  
  - 调整配置
  
  ```shell
  # 复制配置文件
  cd ~/gitlab
  sudo mkdir /usr/local/nginx/conf/conf.d/ -p
  sudo cp lib/support/nginx/gitlab /usr/local/nginx/conf/conf.d/
  cd /usr/local/nginx/conf/conf.d/
  sudo chown -R git:git .
  cp gitlab gitlab.conf
  vim /usr/local/nginx/conf/nginx.conf
  
  # 修改nginx主配置
  user  git;
  worker_processes  2;
  events {
   worker_connections  1024;
  }
  
  http {
   include mime.types;
   # 这句话加入
   include conf.d/*.conf;
  ......
  
  # gitlab虚拟主机的配置
  vim /usr/local/nginx/conf/conf.d/gitlab.conf
  server {
    listen 0.0.0.0:8080 default_server;
    #listen [::]:80 default_server;
    server_name gitlab.hkf56.com;
    # 修改日志路径
    access_log  /usr/local/nginx/logs/gitlab_access.log;
    error_log   /usr/local/nginx/logs/gitlab_error.log;

  location ~ ^/(assets)/ {
 root /home/git/gitlab/public;
   #gzip_static on;
   
    access_log  /var/log/nginx/gitlab_access.log;
    error_log   /var/log/nginx/gitlab_error.log;
</code></pre> 
<ul><li> <p>修改后得<code>gitlab.conf</code>内容如下</p> <pre><code class="prism language-shell">upstream gitlab <span class="token punctuation">{<!-- --></span>
  server unix:/home/git/gitlab/tmp/sockets/gitlab.socket <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  server_name gitlab.hkf56.com<span class="token punctuation">;</span>
  server_tokens off<span class="token punctuation">;</span>
  root /home/git/gitlab/public<span class="token punctuation">;</span>
  client_max_body_size 20m<span class="token punctuation">;</span>
  access_log  logs/gitlab_access.log<span class="token punctuation">;</span>
  error_log   logs/gitlab_error.log<span class="token punctuation">;</span>

  location / <span class="token punctuation">{<!-- --></span>
    try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/index.html <span class="token variable">$uri</span>.html @gitlab<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location /uploads/ <span class="token punctuation">{<!-- --></span>
    proxy_read_timeout      <span class="token number">300</span><span class="token punctuation">;</span>
    proxy_connect_timeout   <span class="token number">300</span><span class="token punctuation">;</span>
    proxy_redirect          off<span class="token punctuation">;</span>

    proxy_set_header    Host                <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    proxy_set_header    X-Real-IP           <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    proxy_set_header    X-Forwarded-For     <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    proxy_set_header    X-Forwarded-Proto   <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    proxy_set_header    X-Frame-Options     SAMEORIGIN<span class="token punctuation">;</span>

    proxy_pass http://gitlab<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location @gitlab <span class="token punctuation">{<!-- --></span>
    proxy_read_timeout      <span class="token number">300</span><span class="token punctuation">;</span>
    proxy_connect_timeout   <span class="token number">300</span><span class="token punctuation">;</span>
    proxy_redirect          off<span class="token punctuation">;</span>

    proxy_set_header    Host                <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    proxy_set_header    X-Real-IP           <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    proxy_set_header    X-Forwarded-For     <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    proxy_set_header    X-Forwarded-Proto   <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    proxy_set_header    X-Frame-Options     SAMEORIGIN<span class="token punctuation">;</span>

    proxy_pass http://gitlab<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location ~ ^/<span class="token punctuation">(</span>assets<span class="token punctuation">)</span>/ <span class="token punctuation">{<!-- --></span>
    root /home/git/gitlab/public<span class="token punctuation">;</span>
    <span class="token comment">#gzip_static on;</span>
    expires max<span class="token punctuation">;</span>
    add_header Cache-Control public<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  error_page <span class="token number">502</span> /502.html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
  <ul><li>拉取gitLab静态文件</li></ul> <pre><code class="prism language-shell"><span class="token function">su</span> - <span class="token function">git</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> ~/gitlab
bundle <span class="token builtin class-name">exec</span> rake assets:precompile <span class="token assign-left variable">RAILS_ENV</span><span class="token operator">=</span>production
<span class="token comment"># redis的socket文件授权</span>
<span class="token function">chmod</span> <span class="token number">777</span> /var/run/redis/redis.sock
<span class="token comment"># 启动gitlab服务</span>
<span class="token function">sudo</span> <span class="token function">service</span> gitlab restart
<span class="token comment">#####</span>
<span class="token punctuation">..</span>.
The GitLab Unicorn web server with pid <span class="token number">49907</span> is running.
The GitLab Sidekiq job dispatcher with pid <span class="token number">49938</span> is running.
GitLab and all its components are up and running.
<span class="token comment"># 查看端口</span>
<span class="token function">netstat</span> -antlp <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">8080</span>
<span class="token comment"># 启动nginx</span>
<span class="token function">sudo</span> /usr/local/nginx/sbin/nginx
</code></pre> </li></ul> 
<h3><a id="510__1109"></a>5.10 访问测试</h3> 
<ul><li> <p>操作如下</p> 
  <ul><li>修改本地hosts文件增加解析如下</li></ul> <pre><code class="prism language-shell"><span class="token comment"># window 路径如下 C:\Windows\System32\drivers\etc\hosts</span>
<span class="token number">192.168</span>.26.8  gitlab.hkf56.com
</code></pre> 
  <ul><li>页面访问域名，输入下面账号密码</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 初始管理员帐号密码为</span>
root  5iveL<span class="token operator">!</span>fe
</code></pre> <p><img src="https://images2.imgbox.com/21/ef/qIYyDrpk_o.png" alt="在这里插入图片描述"></p> 
  <ul><li> <p>登入后重置密码<br> <img src="https://images2.imgbox.com/70/fc/aYHot9np_o.png" alt="在这里插入图片描述"></p> </li><li> <p>最终效果如下<br> <img src="https://images2.imgbox.com/0a/62/CvM822EM_o.png" alt="在这里插入图片描述"></p> </li><li> <p>恭喜你，已经完成了gitlab7.14.3版本部署。过程很多坑，但按照文档走一定顺利</p> </li></ul> </li></ul> 
<h3><a id="511__1144"></a>5.11 修改邮件发送</h3> 
<p><code>注</code>：此部分内容作者本人并未测试过，有需要请自行完成配置并测试</p> 
<ul><li> <p>操作如下</p> 
  <ul><li>修改配置</li></ul> <pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> ~/gitlab/
<span class="token function">vim</span> config/environments/production.rb
 config.action_mailer.delivery_method <span class="token operator">=</span> :smtp

<span class="token function">cp</span> config/initializers/smtp_settings.rb.sample config/initializers/smtp_settings.rb

<span class="token function">vim</span> config/initializers/smtp_settings.rb
<span class="token keyword">if</span> Rails.env.production?

Gitlab::Application.config.action_mailer.delivery_method <span class="token operator">=</span> :smtp

ActionMailer::Base.smtp_settings <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
address: <span class="token string">"smtp.163.com"</span>,
port: <span class="token number">25</span>,
user_name: <span class="token string">"xxx@cass.com"</span>,
password: <span class="token string">"password"</span>,
domain: <span class="token string">"smtp.163.com"</span>,
authentication: :plain,
enable_starttls_auto: true,
<span class="token comment">#openssl_verify_mode: 'peer' # See ActionMailer documentation for other possible options</span>
<span class="token punctuation">}</span>
end
</code></pre> 
  <ul><li>8.x版本的邮件配置和7.x有所不同</li></ul> <pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> ~/gitlab/
<span class="token function">vim</span> config/environments/production.rb
config.action_mailer.delivery_method <span class="token operator">=</span> :smtp
config.action_mailer.smtp_settings <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
:address <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"smtp.163.com"</span>,
:port <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"25"</span>,
:domain <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"smtp.163.com"</span>,
:authentication <span class="token operator">=</span><span class="token operator">&gt;</span> :plain,
:user_name <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"xxx@163.com"</span>,
:password <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"xxx"</span>,
:enable_starttls_auto <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> 
  <ul><li>配置好你的邮箱和密码</li></ul> <pre><code class="prism language-shell"><span class="token comment"># 编辑config/gitlab.yml 对应修改一下配置</span>
email_from: xxx@cass.com
email_display_name: GitLab
email_reply_to:xxx@cass.com
</code></pre> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d78cdf295fee7101ed3dd4bd4c03b9de/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【接口自动化测试】一步一步教你搭建接口环境</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/047ce56e71c727a400b5d8f7e22c2549/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">获胜的概率2</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>