<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ALS算法介绍（协同过滤算法介绍） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ALS算法介绍（协同过滤算法介绍）" />
<meta property="og:description" content="目录 一、ALS算法概括二、ALS算法原理及运用（1）、协同过滤（2）、ALS算法工作原理（3）、ALS算法输入的参数 三、代码实现 一、ALS算法概括 1、ALS算法用来补全用户评分矩阵。由于用户评分矩阵比较稀疏，将用户评分矩阵进行分解，变成V和U的乘积。通过求得V和U两个小的矩阵来补全用户评分矩阵。
2、ALS算法使用交替最小二乘法来进行求解
3、ALS分为显示反馈和隐式反馈两种。显示反馈是指用户有明确的评分。对于商品推荐来说，大部分是通过用户的行为，获取隐式反馈的评分。隐式反馈评分矩阵需要进行处理，如果有用户评分则置为1，没有则赋值为0。但是对这个处理后的评分矩阵，再有一个置信度来评价这个评分。置信度等于1&#43;a*用户真实评分
4、ALS的代价函数是估计值和现有的评分值误差的平方和，引入了L2正则
二、ALS算法原理及运用 ALS：交替最小二乘（alternating least squares）的简称。在机器学习中，ALS特指使用交替最小二乘求解的一个协同推荐算法。它通过观察到的所有用户给商品的打分，来推断每个用户的喜好并向用户推荐适合的商品。
在ALS算法出现前，协同过滤算法是最适合做类似的工作的，理解ALS算法工作原理前可以先了解一下协同过滤的工作原理。
（1）、协同过滤 1 什么是协同过滤
协同过滤是利用集体智慧的一个典型方法。要理解什么是协同过滤 (Collaborative Filtering, 简称 CF)，首先想一个简单的问题，如果你现在想看个电影，但你不知道具体看哪部，你会怎么做？大部分的人会问问周围的朋友，看看最近有什么好看的电影推荐，而我们一般更倾向于从口味比较类似的朋友那里得到推荐。这就是协同过滤的核心思想。
换句话说，就是借鉴和你相关人群的观点来进行推荐，很好理解。
2 协同过滤的实现
要实现协同过滤的推荐算法，要进行以下三个步骤：
收集数据——找到相似用户和物品——进行推荐
收集数据
这里的数据指的都是用户的历史行为数据，比如用户的购买历史，关注，收藏行为，或者发表了某些评论，给某个物品打了多少分等等，这些都可以用来作为数据供推荐算法使用，服务于推荐算法。需要特别指出的在于，不同的数据准确性不同，粒度也不同，在使用时需要考虑到噪音所带来的影响。
找到相似用户和物品
这一步也很简单，其实就是计算用户间以及物品间的相似度。以下是几种计算相似度的方法：
欧几里德距离
皮尔逊相关系数
Cosine 相似度
Tanimoto 系数
进行推荐
在知道了如何计算相似度后，就可以进行推荐了。
在协同过滤中，有两种主流方法：基于用户的协同过滤，和基于物品的协同过滤。具体怎么来阐述他们的原理呢，看个图大家就明白了
基于用户的 CF 的基本思想相当简单，基于用户对物品的偏好找到相邻邻居用户，然后将邻居用户喜欢的推荐给当前用户。计算上，就是将一个用户对所有物品的偏好作为一个向量来计算用户之间的相似度，找到 K 邻居后，根据邻居的相似度权重以及他们对物品的偏好，预测当前用户没有偏好的未涉及物品，计算得到一个排序的物品列表作为推荐。 下图给出了一个例子，对于用户 A，根据用户的历史偏好，这里只计算得到一个邻居 - 用户 C，然后将用户 C 喜欢的物品 D 推荐给用户 A。
基于物品的 CF 的原理和基于用户的 CF 类似，只是在计算邻居时采用物品本身，而不是从用户的角度，即基于用户对物品的偏好找到相似的物品，然后根据用户的历史偏好，推荐相似的物品给他。从计算的角度看，就是将所有用户对某个物品的偏好作为一个向量来计算物品之间的相似度，得到物品的相似物品后，根据用户历史的偏好预测当前用户还没有表示偏好的物品，计算得到一个排序的物品列表作为推荐。下图给出了一个例子，对于物品 A，根据所有用户的历史偏好，喜欢物品 A 的用户都喜欢物品 C，得出物品 A 和物品 C 比较相似，而用户 C 喜欢物品 A，那么可以推断出用户 C 可能也喜欢物品 C。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/30a3baa82d1282cee3442ba47aa7e6be/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-22T09:51:37+08:00" />
<meta property="article:modified_time" content="2020-10-22T09:51:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ALS算法介绍（协同过滤算法介绍）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#ALS_1" rel="nofollow">一、ALS算法概括</a></li><li><a href="#ALS_7" rel="nofollow">二、ALS算法原理及运用</a></li><li><ul><li><a href="#1_10" rel="nofollow">（1）、协同过滤</a></li><li><a href="#2ALS_86" rel="nofollow">（2）、ALS算法工作原理</a></li><li><a href="#3ALS_117" rel="nofollow">（3）、ALS算法输入的参数</a></li></ul> 
  </li><li><a href="#_145" rel="nofollow">三、代码实现</a></li></ul> 
</div> 
<p></p> 
<h2><a id="ALS_1"></a>一、ALS算法概括</h2> 
<p>1、ALS算法用来补全用户评分矩阵。由于用户评分矩阵比较稀疏，将用户评分矩阵进行分解，变成V和U的乘积。通过求得V和U两个小的矩阵来补全用户评分矩阵。<br> 2、ALS算法使用交替最小二乘法来进行求解<br> 3、ALS分为显示反馈和隐式反馈两种。显示反馈是指用户有明确的评分。对于商品推荐来说，大部分是通过用户的行为，获取隐式反馈的评分。隐式反馈评分矩阵需要进行处理，如果有用户评分则置为1，没有则赋值为0。但是对这个处理后的评分矩阵，再有一个置信度来评价这个评分。置信度等于1+a*用户真实评分<br> 4、ALS的代价函数是估计值和现有的评分值误差的平方和，引入了L2正则<br> <img src="https://images2.imgbox.com/4c/a8/TDU0lBCP_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="ALS_7"></a>二、ALS算法原理及运用</h2> 
<p>ALS：交替最小二乘（alternating least squares）的简称。在机器学习中，ALS特指使用交替最小二乘求解的一个协同推荐算法。它通过观察到的所有用户给商品的打分，来推断每个用户的喜好并向用户推荐适合的商品。<br> 在ALS算法出现前，协同过滤算法是最适合做类似的工作的，理解ALS算法工作原理前可以先了解一下协同过滤的工作原理。</p> 
<h3><a id="1_10"></a>（1）、协同过滤</h3> 
<p><strong>1 什么是协同过滤</strong><br> 协同过滤是利用<strong>集体智慧</strong>的一个典型方法。要理解什么是协同过滤 (Collaborative Filtering, 简称 CF)，首先想一个简单的问题，如果你现在想看个电影，但你不知道具体看哪部，你会怎么做？大部分的人会问问周围的朋友，看看最近有什么好看的电影推荐，而我们一般更倾向于从口味比较类似的朋友那里得到推荐。这就是协同过滤的核心思想。</p> 
<p>换句话说，就是借鉴和你相关人群的观点来进行推荐，很好理解。</p> 
<p><strong>2 协同过滤的实现</strong></p> 
<p>要实现协同过滤的推荐算法，要进行以下三个步骤：</p> 
<p><font color="grteewee">收集数据——找到相似用户和物品——进行推荐</font></p> 
<p><strong><font color="red">收集数据</font></strong></p> 
<p>这里的数据指的都是用户的历史行为数据，比如用户的购买历史，关注，收藏行为，或者发表了某些评论，给某个物品打了多少分等等，这些都可以用来作为数据供推荐算法使用，服务于推荐算法。需要特别指出的在于，不同的数据准确性不同，粒度也不同，在使用时需要考虑到噪音所带来的影响。</p> 
<p><strong><font color="red">找到相似用户和物品</font></strong></p> 
<p>这一步也很简单，其实就是计算用户间以及物品间的相似度。以下是几种计算相似度的方法：</p> 
<p>欧几里德距离<br> <img src="https://images2.imgbox.com/68/58/ttTkosAl_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1a/50/5OOSwX3i_o.png" alt="在这里插入图片描述"></p> 
<p></p> 
<p>皮尔逊相关系数</p> 
<p><img src="https://images2.imgbox.com/ca/79/QYlrAFbv_o.png" alt="在这里插入图片描述"></p> 
<p>Cosine 相似度</p> 
<p><img src="https://images2.imgbox.com/08/a5/tpxnBcyC_o.png" alt="在这里插入图片描述"></p> 
<p>Tanimoto 系数</p> 
<p><img src="https://images2.imgbox.com/d6/1a/YNHDG5TE_o.png" alt="在这里插入图片描述"></p> 
<p><strong><font color="red">进行推荐</font></strong></p> 
<p>在知道了如何计算相似度后，就可以进行推荐了。</p> 
<p>在协同过滤中，有两种主流方法：基于用户的协同过滤，和基于物品的协同过滤。具体怎么来阐述他们的原理呢，看个图大家就明白了</p> 
<p>基于用户的 CF 的基本思想相当简单，基于用户对物品的偏好找到相邻邻居用户，然后将邻居用户喜欢的推荐给当前用户。计算上，就是将一个用户对所有物品的偏好作为一个向量来计算用户之间的相似度，找到 K 邻居后，根据邻居的相似度权重以及他们对物品的偏好，预测当前用户没有偏好的未涉及物品，计算得到一个排序的物品列表作为推荐。 下图给出了一个例子，对于用户 A，根据用户的历史偏好，这里只计算得到一个邻居 - 用户 C，然后将用户 C 喜欢的物品 D 推荐给用户 A。</p> 
<p><img src="https://images2.imgbox.com/43/17/0uvbU6rg_o.png" alt="在这里插入图片描述"></p> 
<p>基于物品的 CF 的原理和基于用户的 CF 类似，只是在计算邻居时采用物品本身，而不是从用户的角度，即基于用户对物品的偏好找到相似的物品，然后根据用户的历史偏好，推荐相似的物品给他。从计算的角度看，就是将所有用户对某个物品的偏好作为一个向量来计算物品之间的相似度，得到物品的相似物品后，根据用户历史的偏好预测当前用户还没有表示偏好的物品，计算得到一个排序的物品列表作为推荐。下图给出了一个例子，对于物品 A，根据所有用户的历史偏好，喜欢物品 A 的用户都喜欢物品 C，得出物品 A 和物品 C 比较相似，而用户 C 喜欢物品 A，那么可以推断出用户 C 可能也喜欢物品 C。</p> 
<p><img src="https://images2.imgbox.com/90/07/Bd13eVTB_o.png" alt="在这里插入图片描述"></p> 
<p><strong><font color="red">总结</font></strong></p> 
<p>以上两个方法都能很好的给出推荐，并可以达到不错的效果。但是他们之间还是有不同之处的，而且适用性也有区别。下面进行一下对比</p> 
<p><strong><font color="red">计算复杂度</font></strong></p> 
<p>Item CF 和 User CF 是基于协同过滤推荐的两个最基本的算法，User CF 是很早以前就提出来了，Item CF 是从 Amazon 的论文和专利发表之后（2001 年左右）开始流行，大家都觉得 Item CF 从性能和复杂度上比 User CF 更优，其中的一个主要原因就是对于一个在线网站，用户的数量往往大大超过物品的数量，同时物品的数据相对稳定，因此计算物品的相似度不但计算量较小，同时也不必频繁更新。但我们往往忽略了这种情况只适应于提供商品的电子商务网站，对于新闻，博客或者微内容的推荐系统，情况往往是相反的，物品的数量是海量的，同时也是更新频繁的，所以单从复杂度的角度，这两个算法在不同的系统中各有优势，推荐引擎的设计者需要根据自己应用的特点选择更加合适的算法。</p> 
<p><strong><font color="red">适用场景</font></strong></p> 
<p>在非社交网络的网站中，内容内在的联系是很重要的推荐原则，它比基于相似用户的推荐原则更加有效。比如在购书网站上，当你看一本书的时候，推荐引擎会给你推荐相关的书籍，这个推荐的重要性远远超过了网站首页对该用户的综合推荐。可以看到，在这种情况下，Item CF 的推荐成为了引导用户浏览的重要手段。同时 Item CF 便于为推荐做出解释，在一个非社交网络的网站中，给某个用户推荐一本书，同时给出的解释是某某和你有相似兴趣的人也看了这本书，这很难让用户信服，因为用户可能根本不认识那个人；但如果解释说是因为这本书和你以前看的某本书相似，用户可能就觉得合理而采纳了此推荐。</p> 
<p>相反的，在现今很流行的社交网络站点中，User CF 是一个更不错的选择，User CF 加上社会网络信息，可以增加用户对推荐解释的信服程度。</p> 
<p>如果想看更详细的说明，请参见<a href="http://www.ibm.com/developerworks/cn/web/1103_zhaoct_recommstudy2/index.html" rel="nofollow">http://www.ibm.com/developerworks/cn/web/1103_zhaoct_recommstudy2/index.html</a></p> 
<h3><a id="2ALS_86"></a>（2）、ALS算法工作原理</h3> 
<p>ALS算法是2008年以来，用的比较多的协同过滤算法。它已经集成到Spark的Mllib库中，使用起来比较方便。<br> 从协同过滤的分类来说，ALS算法属于<strong>User-Item CF</strong>，也叫做混合CF。它同时考虑了User和Item两个方面。<br> 用户和商品的关系，可以抽象为如下的三元组：<strong>&lt;User,Item,Rating&gt;</strong>。其中，Rating是用户对商品的评分，表征用户对该商品的喜好程度。<br> 假设我们有一批用户数据，其中包含m个User和n个Item，则我们定义Rating矩阵，其中的元素表示第u个User对第i个Item的评分。<br> 在实际使用中，由于n和m的数量都十分巨大，因此R矩阵的规模很容易就会突破1亿项。这时候，传统的矩阵分解方法对于这么大的数据量已经是很难处理了。<br> 另一方面，一个用户也不可能给所有商品评分，因此，R矩阵注定是个稀疏矩阵。矩阵中所缺失的评分，又叫做missing item。</p> 
<p>为了更好的实现推荐系统，我们需要对这个稀疏的矩阵建模。一般可以采用矩阵分解（或矩阵补全）的方式。</p> 
<p>具体就是找出两个低维度的矩阵，使得它们的乘积是原始的矩阵。因此这也是一种降维技术。假设我们的用户和物品数目分别是U和I，那对应的“用户-物品”矩阵的维度为U×I，如下图所示：<br> <img src="https://images2.imgbox.com/6f/c2/WBfY5YOa_o.png" alt="在这里插入图片描述"></p> 
<p>要找到和“用户-物品”矩阵近似的k维（低阶）矩阵，最终要求出如下两个矩阵：一个用于表示用户的U×k维矩阵，以及一个表征物品的k×I维矩阵。这两个矩阵也称作因子矩阵。它们的乘积便是原始评级矩阵的一个近似。值得注意的是，原始评级矩阵通常很稀疏，但因子矩阵却是稠密的（满秩的），如下图所示：</p> 
<p><img src="https://images2.imgbox.com/9f/58/EPZBHva6_o.png" alt="在这里插入图片描述"><br> 这类模型试图发现对应“用户-物品”矩阵内在行为结构的隐含特征（这里表示为因子矩阵），所以也把它们称为隐特征模型。隐含特征或因子不能直接解释，但它可能表示了某些含义，比如对电影的某个导演、种类、风格或某些演员的偏好。</p> 
<p>k隐藏因子的取值有一定的约束：</p> 
<p>1.<strong>k一般是低阶，小于u和I</strong></p> 
<p>2.生产环境中，k的取值范围一般是10~50,不宜过小或是过大，如果k过大，会导致计算代价增大</p> 
<p>由于是对“用户-物品”矩阵直接建模，用这些模型进行预测也相对直接：要计算给定用户对某个物品的预计评级，就从用户因子矩阵和物品因子矩阵分别选取相应的行（用户因子向量）与列（物品因子向量），然后计算两者的点积即可。如下图所示：<br> <img src="https://images2.imgbox.com/ff/bb/thqjKWqm_o.png" alt="在这里插入图片描述"><br> 而对于物品之间相似度的计算，可以用最近邻模型中用到的相似度衡量方法。不同的是，这里可以直接利用物品因子向量，将相似度计算转换为对两物品因子向量之间相似度的计算，如下图所示：<br> <img src="https://images2.imgbox.com/d3/cb/WNE1Zjvo_o.png" alt="在这里插入图片描述"><br> 因子分解类模型的好处在于，一旦建立了模型，对推荐的求解便相对容易。所以这类模型的表现通常都很出色。但弊端可能在于因子数量的选择有一定困难，往往要结合具体业务和数据量来决定。一般来说，因子的取值范围在10~200之间。注意：k越大，其计算复杂度越高</p> 
<h3><a id="3ALS_117"></a>（3）、ALS算法输入的参数</h3> 
<p><strong><font color="red">参数一: 训练集（rating）</font></strong></p> 
<p>用户对我们这件商品的评分,用户点击了这件商品,我们就给一个评分,然后点击了这个商品的下一步又是多少评分,订单又是多少分,还有访问步长也有加权分,访问时常也有加权分,到最后付款,一共1分.</p> 
<p>每一步的评分其实就是一个权重.也可以理解为用户对商品合适程度,喜好程度.用户和商品就组成了一个矩阵,只要用户点击了商品,就对这个商品有个评分了,而有的却没有点击,它是空白的,我们要做的就是填充这些空白,在空白处根据之前的权重预测一个评分.然后推荐.</p> 
<p>假如预测分和真是分不匹配,我们就优化参数,线上观察效果,再优化权重分,参数.</p> 
<p>训练集是用户，物品，评分.,是一个double类型</p> 
<p><strong><font color="red">参数二: 特征值</font></strong></p> 
<p>给一个特征值,也是double类型的,可以很多参数,可以很少,这个是模型了,看你的模型设计了,如0.1,然后矩阵与特征相乘,所有的特征值与矩阵相乘的分相加,就得到了一个预测分.</p> 
<p>假如预测分与实际分不同的话, 那就是特征值给的有问题了,可以修改特征值参数,直到和预测分类似即可.这就是那些算法工程师一直线上看效果,然后调参数了</p> 
<p><strong><font color="red">参数三: 迭代参数（numIterations）</font></strong></p> 
<p>这个参数是让模型趋近于平稳,也是一个double值,也就是它的标准差越来越平稳,迭代之后会产生一个预测分,((预测分-真实分)的平方+预测分) / n 在发个方,这就是标准差,只要标准差越来越平稳,也就是收敛,就这OK了,.迭代参数就好了</p> 
<p><strong><font color="red">参数四: 防过拟合参数</font></strong></p> 
<p>这个参数也是一个和double值,过拟合比如给机器看一个红色的苹果,突然给一张青色的苹果让它识别, 它就不认识这是一个苹果了,就是为了满足尽可能复杂的任务,我们给它的一个参数. 不妨参数的话,他就像一个单调函数,无法涵盖所有的点,而我们的目的就是为了涵盖大多数的点,如下图所示<br> <img src="https://images2.imgbox.com/83/18/Dk3M5hp3_o.png" alt="防过拟合"></p> 
<p>参考：<a href="https://www.jianshu.com/p/740cb3a103df" rel="nofollow">https://www.jianshu.com/p/740cb3a103df</a></p> 
<h2><a id="_145"></a>三、代码实现</h2> 
<pre><code class="prism language-scala"><span class="token keyword">object</span> AlsTest <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">val</span> actToNum <span class="token operator">=</span> udf<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">(</span>str<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token keyword">=&gt;</span><span class="token punctuation">{<!-- --></span>
      str <span class="token keyword">match</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token string">"BROWSE"</span><span class="token keyword">=&gt;</span><span class="token number">1</span>
        <span class="token keyword">case</span> <span class="token string">"COLLECT"</span><span class="token keyword">=&gt;</span><span class="token number">2</span>
        <span class="token keyword">case</span> <span class="token string">"BUYCAR"</span><span class="token keyword">=&gt;</span><span class="token number">4</span>
        <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span><span class="token number">8</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">case</span> <span class="token keyword">class</span> UserAction<span class="token punctuation">(</span>act<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>act_time<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>cust_id<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>good_id<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>browse<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">"alstest"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> txt <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"file:///D:/1016log/*.log"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//将读入的数据转为dataframe</span>
    <span class="token keyword">import</span> spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span>_
    <span class="token comment">//计算出每个用户对该用户接触过的商品的评分</span>
   <span class="token keyword">var</span> df <span class="token operator">=</span>  txt<span class="token punctuation">.</span>map<span class="token punctuation">(</span>line<span class="token keyword">=&gt;</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> arr <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
      UserAction<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>arr<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>arr<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>arr<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"cust_id"</span><span class="token punctuation">,</span>$<span class="token string">"good_id"</span><span class="token punctuation">,</span>actToNum<span class="token punctuation">(</span>$<span class="token string">"act"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"cust_id"</span><span class="token punctuation">,</span><span class="token string">"good_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>sum<span class="token punctuation">(</span>$<span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//为了防止用户编号或商品编号中含有给数字情况，所以要对所有的商品和用户编号给一个连续的对应的数字编号后在存到换存</span>
    <span class="token keyword">val</span> wnd1 <span class="token operator">=</span> Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>desc<span class="token punctuation">(</span><span class="token string">"good_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> wnd2 <span class="token operator">=</span> Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>desc<span class="token punctuation">(</span><span class="token string">"cust_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> mm <span class="token operator">=</span> <span class="token keyword">new</span> MySqlHandler
    
    <span class="token keyword">val</span> goodstab<span class="token operator">=</span> mm<span class="token punctuation">.</span>readMysql<span class="token punctuation">(</span>spark<span class="token punctuation">,</span><span class="token string">"goods"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"good_id"</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>wnd1<span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"gid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> custtab <span class="token operator">=</span> mm<span class="token punctuation">.</span>readMysql<span class="token punctuation">(</span>spark<span class="token punctuation">,</span><span class="token string">"customs"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"cust_id"</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>wnd2<span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//将df和goodstab和custtab join一下只保留元祖(gid uid score)</span>

<span class="token keyword">val</span> df1 <span class="token operator">=</span> df<span class="token punctuation">.</span>join<span class="token punctuation">(</span>goodstab<span class="token punctuation">,</span> Seq<span class="token punctuation">(</span><span class="token string">"good_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"inner"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>join<span class="token punctuation">(</span>custtab<span class="token punctuation">,</span> Seq<span class="token punctuation">(</span><span class="token string">"cust_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"inner"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"gid"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">)</span>

    <span class="token comment">//将稀疏表转为Rating对象集合</span>
    <span class="token keyword">val</span> alldata <span class="token operator">=</span> df1<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>map<span class="token punctuation">(</span>row<span class="token keyword">=&gt;</span><span class="token punctuation">{<!-- --></span>
      Rating<span class="token punctuation">(</span>row<span class="token punctuation">.</span>getAs<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">.</span>toInt<span class="token punctuation">,</span>row<span class="token punctuation">.</span>getAs<span class="token punctuation">(</span><span class="token string">"gid"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">.</span>toInt<span class="token punctuation">,</span>row<span class="token punctuation">.</span>getAs<span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">.</span>toFloat<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//将获得的Rating集合拆分为按照0.2.0.8两个集合</span>
    <span class="token keyword">val</span> Array<span class="token punctuation">(</span>train<span class="token punctuation">,</span>test<span class="token punctuation">)</span> <span class="token operator">=</span> alldata<span class="token punctuation">.</span>randomSplit<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//使用8成的数据去训练模型</span>
    <span class="token keyword">val</span> model <span class="token operator">=</span> <span class="token keyword">new</span> ALS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setRank<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setIterations<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setLambda<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setImplicitPrefs<span class="token punctuation">(</span>implicitPrefs <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">(</span>alldata<span class="token punctuation">)</span>

<span class="token comment">//    val model = ALS.train(train, rank = 10, maxIter = 20, implicitPrefs = false)</span>
    <span class="token comment">//对模型进行测试</span>
    <span class="token keyword">val</span> tj <span class="token operator">=</span> model<span class="token punctuation">.</span>recommendProductsForUsers<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
    tj<span class="token punctuation">.</span>flatMap<span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span><span class="token punctuation">(</span>user<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>ratings<span class="token operator">:</span>Array<span class="token punctuation">[</span>Rating<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">=&gt;</span>
        ratings<span class="token punctuation">.</span>map<span class="token punctuation">{<!-- --></span>
          <span class="token keyword">case</span> <span class="token punctuation">(</span>rat<span class="token operator">:</span>Rating<span class="token punctuation">)</span><span class="token keyword">=&gt;</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>rat<span class="token punctuation">.</span>product<span class="token punctuation">,</span>rat<span class="token punctuation">.</span>rating<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9426e03cc4c117b415219af998aa4109/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">springMVC文件上传和springMVC对json的处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/14c4f8c8d3ba58e55a7c7fd3dd866b86/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【计算机网络】Stanford CS144（原实验相关内容已删）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>