<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>黑马点评项目总结 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="黑马点评项目总结" />
<meta property="og:description" content="文章目录 1.登录怎么实现？1.1 基于Session登录1.2 ThreadLocal1.3 session共享问题1.4 基于Redis实现共享session登录 2.商户查询缓存怎么实现？2.1 什么是缓存，有什么用？使用缓存会带来什么问题？2.2 解决缓存一致性问题要采用什么策略？2.3 缓存存在的问题2.3.1 缓存穿透2.3.2 缓存雪崩2.3.3 缓存击穿 3.秒杀业务3.1 全局唯一ID3.2 秒杀下单3.3 库存超卖问题3.4 一人一单3.4.1 单机情况下实现一人一单3.4.2 集群模式下一人一单的并发安全问题 3.5 分布式锁3.5.1 基于 Redis 的分布式锁 3.6 Redis消息队列实现异步秒杀 4.点赞怎么实现？4.1 需求：4.2 实现步骤： 5.点赞排行版怎么实现？5.1 需求：5.2 实现步骤： 6.关注怎么实现?6.1 需求：6.2 实现步骤： 7.共同关注怎么实现?7.1 需求：7.2 实现步骤： 8.关注推送怎么实现？8.1 需求：8.2 实现步骤： 9.用户签到怎么实现？9.1 签到9.2 连续签到天数统计 10.用户信息UV统计怎么实现？11.项目中遇到的困难11.1 事务失效的情况11.2 事务失效的情况——秒杀模块一人一单 1.登录怎么实现？ 1.1 基于Session登录 登录包括短信验证码的发送，然后是基于短信验证码的登录，最后是对登录状态的校验。
发送短信验证码
用户提交自己的手机号，服务端接收到这个手机号以后，首先要去验证一下手机号是不是合法的。合法就发送验证码。发验证码之前要先生成验证码，生成验证码的目的是为了让用户去做登录。要把这个验证码保存在本地，将来用户在登录的时候，才能做验证。那既然是基于session登录，那肯定是把这个验证码保存在session当中，之后就可以给用户发送短信验证码了。 public Result sendCode(String phone, HttpSession session) { //1.校验手机号:利用util下RegexUtils进行正则验证 if (RegexUtils.isPhoneInvalid(phone)) { // 2.如果不符合，返回错误信息 return Result.fail(&#34;手机号格式错误！&#34;); } // 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7a14eb8c5a3e52a365b9bbe120a71f1d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-11T14:55:52+08:00" />
<meta property="article:modified_time" content="2023-06-11T14:55:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">黑马点评项目总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1_1" rel="nofollow">1.登录怎么实现？</a></li><li><ul><li><ul><li><a href="#11_Session_2" rel="nofollow">1.1 基于Session登录</a></li><li><a href="#12_ThreadLocal_64" rel="nofollow">1.2 ThreadLocal</a></li><li><a href="#13_session_67" rel="nofollow">1.3 session共享问题</a></li><li><a href="#14_Redissession_74" rel="nofollow">1.4 基于Redis实现共享session登录</a></li></ul> 
  </li></ul> 
  </li><li><a href="#2_137" rel="nofollow">2.商户查询缓存怎么实现？</a></li><li><ul><li><ul><li><a href="#21__138" rel="nofollow">2.1 什么是缓存，有什么用？使用缓存会带来什么问题？</a></li><li><a href="#22__148" rel="nofollow">2.2 解决缓存一致性问题要采用什么策略？</a></li><li><a href="#23__178" rel="nofollow">2.3 缓存存在的问题</a></li><li><ul><li><a href="#231__179" rel="nofollow">2.3.1 缓存穿透</a></li><li><a href="#232__190" rel="nofollow">2.3.2 缓存雪崩</a></li><li><a href="#233__195" rel="nofollow">2.3.3 缓存击穿</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#3_201" rel="nofollow">3.秒杀业务</a></li><li><ul><li><ul><li><a href="#31_ID_202" rel="nofollow">3.1 全局唯一ID</a></li><li><a href="#32__283" rel="nofollow">3.2 秒杀下单</a></li><li><a href="#33__293" rel="nofollow">3.3 库存超卖问题</a></li><li><a href="#34__328" rel="nofollow">3.4 一人一单</a></li><li><ul><li><a href="#341__329" rel="nofollow">3.4.1 单机情况下实现一人一单</a></li><li><a href="#342__334" rel="nofollow">3.4.2 集群模式下一人一单的并发安全问题</a></li></ul> 
    </li><li><a href="#35__345" rel="nofollow">3.5 分布式锁</a></li><li><ul><li><a href="#351__Redis__359" rel="nofollow">3.5.1 基于 Redis 的分布式锁</a></li></ul> 
    </li><li><a href="#36_Redis_370" rel="nofollow">3.6 Redis消息队列实现异步秒杀</a></li></ul> 
  </li></ul> 
  </li><li><a href="#4_383" rel="nofollow">4.点赞怎么实现？</a></li><li><ul><li><ul><li><a href="#41__384" rel="nofollow">4.1 需求：</a></li><li><a href="#42__387" rel="nofollow">4.2 实现步骤：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#5_484" rel="nofollow">5.点赞排行版怎么实现？</a></li><li><ul><li><ul><li><a href="#51__485" rel="nofollow">5.1 需求：</a></li><li><a href="#52__487" rel="nofollow">5.2 实现步骤：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#6_567" rel="nofollow">6.关注怎么实现?</a></li><li><ul><li><ul><li><a href="#61__568" rel="nofollow">6.1 需求：</a></li><li><a href="#62__571" rel="nofollow">6.2 实现步骤：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#7_614" rel="nofollow">7.共同关注怎么实现?</a></li><li><ul><li><ul><li><a href="#71__615" rel="nofollow">7.1 需求：</a></li><li><a href="#72__617" rel="nofollow">7.2 实现步骤：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#8_691" rel="nofollow">8.关注推送怎么实现？</a></li><li><ul><li><ul><li><a href="#81__692" rel="nofollow">8.1 需求：</a></li><li><a href="#82__696" rel="nofollow">8.2 实现步骤：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#9_792" rel="nofollow">9.用户签到怎么实现？</a></li><li><ul><li><ul><li><a href="#91__793" rel="nofollow">9.1 签到</a></li><li><a href="#92__819" rel="nofollow">9.2 连续签到天数统计</a></li></ul> 
  </li></ul> 
  </li><li><a href="#10UV_823" rel="nofollow">10.用户信息UV统计怎么实现？</a></li><li><a href="#11_851" rel="nofollow">11.项目中遇到的困难</a></li><li><ul><li><ul><li><a href="#111__852" rel="nofollow">11.1 事务失效的情况</a></li><li><a href="#112__893" rel="nofollow">11.2 事务失效的情况——秒杀模块一人一单</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1_1"></a>1.登录怎么实现？</h2> 
<h4><a id="11_Session_2"></a>1.1 基于Session登录</h4> 
<p>登录包括短信验证码的发送，然后是基于短信验证码的登录，最后是对登录状态的校验。<br> <img src="https://images2.imgbox.com/58/29/tEI8PEE2_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>发送短信验证码</p> 
</blockquote> 
<ul><li>用户提交自己的手机号，服务端接收到这个手机号以后，首先要去验证一下手机号是不是合法的。合法就发送验证码。发验证码之前要先生成验证码，生成验证码的目的是为了让用户去做登录。要把这个验证码保存在本地，将来用户在登录的时候，才能做验证。那既然是基于session登录，那肯定是把这个验证码保存在session当中，之后就可以给用户发送短信验证码了。</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.校验手机号:利用util下RegexUtils进行正则验证</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2.如果不符合，返回错误信息</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"手机号格式错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.符合，生成验证码:导入hutool依赖，内有RandomUtil</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.保存验证码到 session</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5.发送验证码</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"发送短信验证码成功，验证码：{}"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回ok</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>短信验证码登录、注册</p> 
</blockquote> 
<ul><li>用户收到验证码以后，就可以去做登录或者注册。把自己的手机号和验证码提交到后台，后台去验证他提交的这两个数据。用户提交的验证码，跟上一步保存在session里的验证码做一个比较。如果一样证明验证码是正确的，但不能证明他就可以登录，因为手机号还没有验证。要验证手机号，我们可以去数据库里查，根据手机号去查询用户信息，有可能查得到，也有可能查不到，所以要对用户做个判断，如果这个用户存在，就可以登录。登录一定要保存用户信息，保存在session里。如果用户不存在，证明这个人是第一次来访问，这个时候要给他注册成一个新用户，给他填充一些基本信息，写到数据库中，然后把用户信息保存到session里。也就是说， 登录和注册其实是在一个功能里完成的。</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1.校验手机号</span>
    <span class="token class-name">String</span> phone <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"手机号格式错误!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//2.校验验证码</span>
    <span class="token class-name">Object</span> cacheCode <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>code<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">||</span><span class="token operator">!</span>cacheCode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//3.不一致，报错</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"验证码错误!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token comment">//4.一致，根据手机号查询用户(需要写对应的单表查询方法:select * from tb_user where phone = #{phone})</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//5.注册用户</span>
        user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span><span class="token string">"user_"</span><span class="token operator">+</span><span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存用户</span>
        <span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//6.存入session,需要隐藏用户敏感信息，不能直接存user</span>
    <span class="token comment">//session.setAttribute("user",user);</span>
    session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<blockquote> 
 <p>校验登录状态</p> 
</blockquote> 
<ul><li>后续开发的很多业务中需要登录验证，我们不可能在每一个 controller 里来写这些业务逻辑。所以用一个<strong>拦截器</strong>（由 SpringMVC 提供）统一进行拦截然后验证。用户登录成功了，那以后他访问一些关键的业务的时候，都需要去校验登录状态。那么我们把用户信息保存到session了，我们要基于session进行校验。session是基于cookie的，每一个session都会有一个对应的session ID保存在浏览器的cookie当中，所以说，当用户来访问我们的时候，他一定会携带上自己的cookie，cookie里就会有那个session ID。这个时候我们可以基于cookie当中的session ID，从而拿到session，从而去从session当中获取用户。那这个时候我们只需要判断一下这个session有没有用户，就能够知道他是否登录了，那如果经过判断发现没有用户，那就拦截他的请求就行了。那如果判断有，证明这个用户是曾经登录过的，那就放行。这个登陆状态的校验不能白校验，因为在后续的业务当中，一定会用到当前登录的这个用户的信息，既然如此，我们把这个用户的信息给他缓存起来，方便后续的业务是不是来使用它，把登录用户缓存在这个ThreadLocal当中，那这样一来呢，后续的业务就可以直接从ThreadLocal里获取用户，这就是基于session的一个登录状态的校验了。<br> <img src="https://images2.imgbox.com/3a/17/NdQDr25D_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="12_ThreadLocal_64"></a>1.2 ThreadLocal</h4> 
<p>ThreadLocal其实就是一个线程域对象。在我们的业务当中，每一个请求到达我们的微服务，它都会是一个独立的线程，如果说，我们没有用ThreadLocal，而是直接把数据保存到一个本地变量，那就会可能出现多线程并发修改的一个安全问题，而ThreadLocal呢，它会将这个数据保存到每一个线程的内部，在线程内部创建一个map来去保存，这样一来每一个线程都有自己独立的存储空间，那每一个请求来了以后，都会有自己的空间，相互之间没有干扰。然后我们再去放行，那后续的所有的业务都可以从这里边去取出自己的用户信息。</p> 
<h4><a id="13_session_67"></a>1.3 session共享问题</h4> 
<ul><li> <p>基于session的短信登录会出现session共享的问题：多台Tomcat无法共享session存储空间，当请求切换到不同tomcat服务时会导致数据丢失的问题。</p> </li><li> <p>将来为了应对并发，肯定是要做水平扩展，部署多个tomcat形成负载均衡的集群。当请求进入Nginx，它会做一个负载均衡，在多台tomcat进行轮询。每一个tomcat都会有自己的session空间。用户请求来了以后，第一次被负载均衡到了第一台tomcat。假如说用户登录，那么用户信息保存到了这台tomcat里面去了。紧接着，用户第二次登录，请求被负载均衡到了第二台tomcat。那去获取用户信息的时候，就是空的。就会告诉用户说你没有登录，这不扯了吗？我前一秒钟刚登录完，这样用户体验就很不好。这就是所谓的session共享的问题。</p> </li><li> <p>session 的替代方案应该满足：数据共享；内存存储；key、value 结构（Redis 恰好就满足这些情况）<br> <img src="https://images2.imgbox.com/56/62/YyyuCl7u_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h4><a id="14_Redissession_74"></a>1.4 基于Redis实现共享session登录</h4> 
<p><img src="https://images2.imgbox.com/90/27/nyDcuAdm_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>修改发送短信验证码,保存验证码用Redis的String数据结构，key是手机号，value是验证码</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token comment">// 4.保存验证码到 session</span>
        <span class="token comment">// session.setAttribute("code",code);</span>
        <span class="token comment">// 4.保存验证码到 Redis</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>LOGIN_CODE_KEY <span class="token operator">+</span> phone<span class="token punctuation">,</span> code<span class="token punctuation">,</span> LOGIN_CODE_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>修改短信验证码登录、注册，用Redis的Hash数据结构保存用户，通过UUID随机生成token，作为登录令牌。不能直接把user存入Hash，而是要通过UserDTO隐藏用户敏感信息，然后存入</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.校验手机号</span>
        <span class="token class-name">String</span> phone <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"手机号格式错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.从redis获取验证码并校验</span>
        <span class="token class-name">String</span> cacheCode <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>LOGIN_CODE_KEY <span class="token operator">+</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheCode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>cacheCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 不一致，报错</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"验证码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3.一致，根据手机号查询用户 select * from tb_user where phone = #{phone}</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.判断用户是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//5.注册用户</span>
            <span class="token class-name">User</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newUser<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newUser<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span>USER_NICK_NAME_PREFIX <span class="token operator">+</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">save</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            user <span class="token operator">=</span> newUser<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6.保存用户信息到 redis中</span>
        <span class="token comment">// 6.1.通过UUID随机生成token，作为登录令牌</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.2.将User对象转为HashMap存储</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> userDTO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"nickName"</span><span class="token punctuation">,</span> userDTO<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"icon"</span><span class="token punctuation">,</span> userDTO<span class="token punctuation">.</span><span class="token function">getIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.3.存储到redis中</span>
        <span class="token class-name">String</span> tokenKey <span class="token operator">=</span> LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>tokenKey<span class="token punctuation">,</span> userMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.4.设置token有效期</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>tokenKey<span class="token punctuation">,</span> LOGIN_USER_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 7.返回token</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>修改校验登录状态</p> 
</blockquote> 
<ul><li>之前拦截器拦截的是需要登录检验的路径，对于一些不会被拦截器拦截的路径（比如首页），拦截器就不会生效，token就不会刷新。那么token过了有效时间后，尽管用户一直在访问，但用户的登录状态也就消失了。我们可以在原有的拦截器上新增一个拦截器，第一个拦截器拦截一切路径,保存ThreadLocal和刷新token有效期,第二个拦截器做登录校验。<br> <img src="https://images2.imgbox.com/90/2b/IR9K6196_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="2_137"></a>2.商户查询缓存怎么实现？</h2> 
<h4><a id="21__138"></a>2.1 什么是缓存，有什么用？使用缓存会带来什么问题？</h4> 
<blockquote> 
 <p>什么是缓存：</p> 
</blockquote> 
<ul><li>缓存（Cache）是数据交换的缓冲区，是临时存贮数据的地方，<strong>读写性能较高</strong>。</li></ul> 
<blockquote> 
 <p>缓存的作用：</p> 
</blockquote> 
<ul><li>降低后端的负载压力：请求进入Tomcat以后，以前我们是要去查数据库，而数据库要去做磁盘读写，相对来说效率是比较低的，一些复杂业务的Sql查询起来就更慢了。如果有了缓存，请求进入Tomcat以后，直接在缓存里查到数据，返回给前端，不用去查数据库，对后端来说压力就大大降低了。</li><li>提高读写效率，降低响应时间：数据库的读写是磁盘读写，响应时间比较长。如果使用像Redis这样的缓存，它的读写延时往往在微秒级别，响应时间大大缩短，读写效率大大提高，在面对用户量比较大，并发量比较高的业务里，使用缓存就能够解决这样的高并发问题。</li></ul> 
<blockquote> 
 <p>使用缓存带来的问题：</p> 
</blockquote> 
<ul><li>使用缓存可能会带来数据一致性问题，用户查询数据先去查Redis，如果数据库的数据发生改变，Redis里的数据还没及时更新，那么从缓存内取到的数据就会出错。</li></ul> 
<h4><a id="22__148"></a>2.2 解决缓存一致性问题要采用什么策略？</h4> 
<ul><li>解决缓存一致性问题的策略：<strong>缓存更新策略</strong></li></ul> 
<table><thead><tr><th>内存淘汰</th><th>超时剔除</th><th>主动更新</th></tr></thead><tbody><tr><td>不用自己维护。利用 Redis 的内存淘汰机制：当内存不足时自动淘汰部分数据。下次查询时更新缓存。</td><td>给缓存数据添加 TTL 时间，到期后自动删除缓存。下次查询时更新缓存。</td><td>编写业务逻辑，在修改数据库的同时，更新缓存。</td></tr></tbody></table> 
<p><strong>业务场景</strong></p> 
<ul><li>低一致性需求：使用Redis自带的内存淘汰机制。</li><li>高一致性需求：主动更新，并以超时剔除作为兜底方案。</li></ul> 
<p><strong>具体例子</strong><br> 项目中 ShopController 中给查询商铺的缓存添加<font color="#dd0000">超时剔除</font>和<font color="#006600">主动更新</font>的策略</p> 
<ul><li>查询数据时：根据 id 查询店铺时，如果缓存未命中，则查询数据库，将数据库结果写入缓存，并设置<font color="#dd0000">超时时间</font>。</li><li>修改数据时：根据 id 修改店铺时，<font color="#006600">先更新数据库，再删除缓存</font>，通过事务保证原子性。</li></ul> 
<blockquote> 
 <p>更新商铺时，保证数据库和缓存的一致性</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"店铺id不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 1.更新数据库</span>
        <span class="token function">updateById</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.删除缓存</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="23__178"></a>2.3 缓存存在的问题</h4> 
<h5><a id="231__179"></a>2.3.1 缓存穿透</h5> 
<p>缓存穿透是指用户请求的数据在缓存和数据库中都不存在，如果不断发起这样的请求，这些请求都会打到数据库，给数据库带来巨大的压力。<br> 常见的解决方案有两种：<br> 1.缓存null值<br> 2.布隆过滤<br> <img src="https://images2.imgbox.com/eb/67/1Q3fywV9_o.png" alt=""></p> 
<blockquote> 
 <p>基于<font color="#dd0000">缓存空对象</font>解决商铺查询的缓存穿透问题</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/52/f5/2iiEr5K1_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="232__190"></a>2.3.2 缓存雪崩</h5> 
<p>缓存雪崩指<font color="#dd0000">在同一时段大量的缓存key同时失效</font>或者<font color="#green">Redis服务宕机</font>，导致大量请求到达数据库，带来巨大压力。<br> 解决方案：<br> 1.<font color="#dd0000">给不同的Key的TTL添加随机值</font><br> 2.<font color="#green">利用Redis集群提高服务的可用性</font><img src="https://images2.imgbox.com/2b/d8/g6hmq17H_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="233__195"></a>2.3.3 缓存击穿</h5> 
<p>缓存击穿问题也叫热点Key问题，就是一个被<font color="#dd0000">高并发</font>访问并且<font color="#dd0000">缓存重建耗时长</font>的key突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。<br> 常见的解决方案有两种：<br> 1.互斥锁：查询缓存未命中，获取互斥锁，获取到互斥锁的线程才能查询数据库重建缓存，将数据写入缓存中后，释放锁。<br> 2.逻辑过期：查询缓存，发现逻辑时间已经过期，获取互斥锁，开启新线程；在新线程中查询数据库重建缓存，将数据写入缓存中后，释放锁；在释放锁之前，查询该数据时，都会将过期的数据返回。<img src="https://images2.imgbox.com/7d/bc/7qJ44Cu5_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/a3/3a/JT7juaNC_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_201"></a>3.秒杀业务</h2> 
<h4><a id="31_ID_202"></a>3.1 全局唯一ID</h4> 
<p>当用户抢购优惠券时，就会生成订单并保存到订单表中，而订单表如果使用数据库自增ID就存在一些问题：</p> 
<ul><li>id的规律性太明显：用户就能根据id猜测在一天时间内，卖出了多少单，这明显不合适。</li><li>受单表数据量的限制：当数据量增大时，单张表保存不了那么多的数据，就要将数据分到多张表，MySql每张表都从1开始增，那订单id就重复了，肯定不行，我们需要保证id的唯一性。</li></ul> 
<p>全局唯一 ID 生成策略用的是Redis自增id策略。Redis的String数据结构，有个Increment命令,可以实现自增。</p> 
<ul><li>ID 的组成部分： 时间戳 + 自增id。</li><li>符号位：1bit，永远为0</li><li>时间戳：31bit，以秒为单位，可以使用69年</li><li>序列号：32bit，秒内的计数器，支持每秒产生2^32个不同ID<br> <img src="https://images2.imgbox.com/03/21/G6cLGBtC_o.png" alt="在这里插入图片描述"></li></ul> 
<blockquote> 
 <p>全局唯一ID</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisIdWorker</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//开始时间戳</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> BEGIN_TIMESTAMP <span class="token operator">=</span> <span class="token number">1640995200L</span><span class="token punctuation">;</span>
    <span class="token comment">//序列号的位数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT_BITS <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisIdWorker</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.生成时间戳</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> nowSecond <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> nowSecond <span class="token operator">-</span> BEGIN_TIMESTAMP<span class="token punctuation">;</span>

        <span class="token comment">// 2.生成序列号</span>
        <span class="token comment">// 2.1.获取当前日期，精确到天</span>
        <span class="token class-name">String</span> date <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy:MM:dd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.2.自增长</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">"icr:"</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.拼接并返回</span>
        <span class="token keyword">return</span> timestamp <span class="token operator">&lt;&lt;</span> COUNT_BITS <span class="token operator">|</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>测试</p> 
</blockquote> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token comment">//线程池,500个线程</span>
    <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> es <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testRedisIdWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//CountDownLatch: 300个线程执行任务，每当一个线程的任务执行完，计数器-1</span>
        <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//任务：每个线程生成100个id，并打印</span>
        <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"id = "</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//提交任务300次</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            es<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"time = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> begin<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="32__283"></a>3.2 秒杀下单</h4> 
<p>秒杀下单时需要判断两点：</p> 
<ul><li>秒杀是否开始或结束，如果尚未开始或已经结束则无法下单</li><li>库存是否充足，不足则无法下单<br> <img src="https://images2.imgbox.com/37/46/fs0GpRWV_o.png" alt="在这里插入图片描述"></li></ul> 
<p>下单核心逻辑分析：</p> 
<p>当用户开始进行下单，我们应当去查询优惠卷信息，查询到优惠卷信息，判断是否满足秒杀条件，时间是否充足，如果时间充足，则进一步判断库存是否足够，如果两者都满足，则扣减库存，创建订单，然后返回订单id，如果有一个条件不满足则直接结束。</p> 
<h4><a id="33__293"></a>3.3 库存超卖问题</h4> 
<p>超卖问题是典型的多线程并发安全问题。线程 1 和 线程 2 都查询库存为 1（二者都未进行判断并扣减），之后线程1先判断1&gt;0,扣减库存，这时候库存变为0。线程2也判断1&gt;0,扣减库存，这时候库存就变成-1了。<br> <img src="https://images2.imgbox.com/6d/f1/ejago1Tr_o.png" alt="在这里插入图片描述"><br> 多线程并发安全问题产生的原因就是多个线程操作共享资源，操作资源的代码有好几行，在这几行代码执行的中间，多个线程互相穿插，就出现安全问题了。</p> 
<p>针对这一问题的常见解决方案就是加锁：而对于加锁，通常有两种解决方案：</p> 
<ul><li>悲观锁：认为线程安全问题一定会发生，在对数据操作之前先获取锁，确保线程串行执行（既然多线程并发会有安全问题，就不让它并发，多个线程一个一个地去执行,在高并发场景下效率就比较低。Synchronized和Lock都是悲观锁）。</li><li>乐观锁：认为线程安全问题不一定会发生，因此不加锁，只是在更新数据时去判断有没有其它线程对数据做了修改。</li></ul> 
<p>乐观锁的关键是判断之前查询得到的数据是否有被修改过，常见的处理方式有两种：版本号 和 CAS<br> <img src="https://images2.imgbox.com/73/f8/4hp7rZ8D_o.png" alt="在这里插入图片描述"><br> 版本号法：每当数据进行修改，版本号就会 +1。判断一个数据有没有修改过只要判断版本号有没有变化。<br> <img src="https://images2.imgbox.com/86/1a/pqE4bkev_o.png" alt="在这里插入图片描述"><br> CAS法：在版本号法基础上进行简化，通过数据本身有没有发生变化来判断线程是否安全。既然每次更新都要更新库存和版本，那只要判断我扣减库存时的库存和之前我查询到的库存是不是一样的，一样就意味着没有修改过库存，那么此时线程就是安全的。</p> 
<blockquote> 
 <p>乐观锁</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">// 5. 减扣库存</span>
<span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//set stock = stock - 1</span>
            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock= stock -1"</span><span class="token punctuation">)</span> 
            <span class="token comment">//where voucher_id = ? and stock = ?</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>以上逻辑的核心含义是：只要扣减库存时的库存和之前我查询到的库存是一样的，就意味着没有人在中间修改过库存，那么此时就是安全的，但是以上这种方式通过测试发现会有很多失败的情况，失败的原因在于：在使用乐观锁过程中假设100个线程同时都拿到了100的库存，然后大家一起去进行扣减，但是100个人中只有1个人能扣减成功，其他人在处理时，他们在扣减时，库存已经被修改过了，所以此时其他线程都会失败</p> 
<blockquote> 
 <p>修改乐观锁，改成stock大于0</p> 
</blockquote> 
<pre><code class="prism language-java">     <span class="token comment">// 5. 减扣库存</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// set stock= stock - 1</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock - 1"</span><span class="token punctuation">)</span>
                <span class="token comment">// where voucher_id = ? and stock &gt; 0</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="34__328"></a>3.4 一人一单</h4> 
<h5><a id="341__329"></a>3.4.1 单机情况下实现一人一单</h5> 
<p>修改秒杀业务，要求同一个优惠券，一个用户只能下一单。<br> 具体操作逻辑如下：时间是否充足，如果时间充足，则进一步判断库存是否足够，然后再根据优惠卷id和用户id查询是否已经下过这个订单，如果下过这个订单，则不再下单，否则进行下单<br> <img src="https://images2.imgbox.com/a8/92/Qzc5kEDP_o.png" alt="在这里插入图片描述"><br> <strong>存在问题</strong>：和之前库存超卖问题一样，有多线程并发安全问题，多个线程穿插执行。所以需要加锁，但是乐观锁比较适合更新数据，而现在是插入数据，所以我们需要使用悲观锁操作。</p> 
<h5><a id="342__334"></a>3.4.2 集群模式下一人一单的并发安全问题</h5> 
<p>通过加锁可以解决在单机情况下的一人一单安全问题，但是在集群模式下就不行了。<br> 1、我们将服务启动两份，端口分别为8081和8082：</p> 
<p><img src="https://images2.imgbox.com/0a/a9/PBFaDVYz_o.png" alt="在这里插入图片描述"><br> 2、然后修改nginx的conf目录下的nginx.conf文件，配置反向代理和负载均衡：<br> <img src="https://images2.imgbox.com/75/bb/zfRarmp3_o.png" alt="在这里插入图片描述"><br> <strong>有关锁失效原因分析</strong></p> 
<p>由于我们部署了多个tomcat，每个tomcat都有一个属于自己的jvm，jvm的内部维护了一个锁监视器对象，那么假设在服务器A的tomcat内部，有两个线程，这两个线程由于使用的是同一份代码，那么他们的锁对象userid是同一个，是可以实现互斥的，但是如果现在是服务器B的tomcat内部，又有两个线程，但是他们的锁对象写的虽然和服务器A一样，但是锁对象却不是同一个，所以线程3和线程4可以实现互斥，但是却无法和线程1和线程2实现互斥，这就是 集群环境下，syn锁失效的原因，在这种情况下，我们就需要使用分布式锁来解决这个问题。<br> <img src="https://images2.imgbox.com/18/8c/IijawPeK_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="35__345"></a>3.5 分布式锁</h4> 
<p>分布式锁：满足分布式系统或集群模式下多进程可见并且互斥的锁。<br> 分布式锁的核心思想就是让大家都使用同一把锁，只要大家使用的是同一把锁，那么我们就能锁住线程。<br> <img src="https://images2.imgbox.com/c2/40/y3D57tQt_o.png" alt="在这里插入图片描述"><br> 常见的分布式锁有三种：</p> 
<ul><li> <p>Mysql：mysql本身有互斥锁机制，但是mysql性能一般，所以mysql作为分布式锁比较少见。</p> </li><li> <p>现在企业级开发中基本都使用Redis或者zookeeper作为分布式锁。</p> </li><li> <p>Redis：利用<font color="red">setnx</font>方法，获取锁。如果key插入成功，则表示获得到了锁，如果插入失败则表示无法获得到锁，利用这套逻辑来实现分布式锁</p> </li><li> <p>Zookeeper：zookeeper利用节点的唯一性和有序性（节点id递增）实现互斥。</p> </li></ul> 
<h5><a id="351__Redis__359"></a>3.5.1 基于 Redis 的分布式锁</h5> 
<p>实现分布式锁时需要实现两个方法：获取锁和释放锁</p> 
<ul><li>获取锁：利用 setnx 命令获取锁</li><li>释放锁： 
  <ul><li>手动释放：利用 del 命令 直接删除</li><li>超时释放：获取锁时通过 expire 命令添加超时时间，避免服务宕机</li></ul> </li></ul> 
<p>如果获取锁成功，还没来得及expire，Redis 就宕机了。如何保证获取锁和释放锁操作同时成功和失败，保证其原子性？<br> 将 setnx 命令 和 ex命令 合起来：SET key value EX 超时时间 NX</p> 
<h4><a id="36_Redis_370"></a>3.6 Redis消息队列实现异步秒杀</h4> 
<p>消息队列（Message Queue）是存放消息的队列。最简单的消息队列模型包括3个角色：</p> 
<ul><li>生产者：发送消息到消息队列</li><li>消息队列：存储和管理消息，也被称为消息代理（Message Broker）</li><li>消费者：从消息队列获取消息并处理消息</li></ul> 
<p>使用队列的好处在于 <strong>解耦</strong>：所谓解耦，举一个生活中的例子就是：快递员(生产者)把快递放到快递柜里边(Message Queue)去，我们(消费者)从快递柜里边去拿东西，这就是一个异步，如果耦合，那么这个快递员相当于直接把快递交给你，这事固然好，但是万一你不在家，那么快递员就会一直等你，这就浪费了快递员的时间，所以这种思想在我们日常开发中，是非常有必要的。</p> 
<p>在秒杀场景中：当有人抢购优惠券时，不着急真正下单，可以先判断用户有没有购买的资格，有购买的资格，不写到数据库，而是把订单的相关信息写到消息队列里去，通过队列把消息发送出去，这时候再开启一个独立的线程作为消费者，不断地从队列里获取消息，真正地完成下单，写入数据库。这样秒杀的业务就和写数据库的业务分离了，变成了异步操作，解除了耦合。</p> 
<p>这里我们可以使用一些现成的mq，比如kafka，rabbitmq等等，但是如果没有安装mq，我们也可以直接使用redis提供的mq方案，降低我们的部署和学习成本。<br> <img src="https://images2.imgbox.com/93/f9/VJfhCkoR_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4_383"></a>4.点赞怎么实现？</h2> 
<h4><a id="41__384"></a>4.1 需求：</h4> 
<p>同一个用户只能点赞一次，再次点击就取消点赞。<br> 如果当前用户已经点赞，则点赞按钮高亮显示（由前端来实现，我们只要告诉前端有没有点过赞，前端判断Blog类的isLike属性是True还是False，True表示点过赞，False表示没点赞）</p> 
<h4><a id="42__387"></a>4.2 实现步骤：</h4> 
<ul><li>要实现点赞功能，第一件事就是给 Blog 类中添加一个 isLike 字段，标识它有没有被点过赞</li><li>那怎么判断用户有没有点过赞呢？最简单的方案就是在数据库里建张表，这张表里保存这个Blog的id和给这个Blog点赞的User的id。每当点赞了一次，这张表就记录了一条数据，那下次再点赞就去判断这张表有没有这条数据，有的话就说明点过赞了，这种实现方式是可以的，但是用数据库来实现，太重了！！这种点赞的判断肯定比较多，对数据库的压力比较大。所以我们就用Redis来实现，我们要判断用户有没有点过赞，其实就是记录当前的Blog被哪些人点赞过，我们可以在Redis里，以Blog的id为key，value就去记录给这个Blog点赞过的所有用户，这时候就需要一个集合把所有点赞过的用户id都存进去，下次就判断用户id在这个集合里存不存在，就知道点没点过赞了。我们要找Redis中一个集合的数据结构，同时一个用户只能点赞一次，也就是说在这个集合中用户id不能重复，那Redis中的数据结构保证是集合，又保证元素不可重复，那就是Set集合了。利用Set 集合判断是否点赞过，没点赞过则点赞数 + 1，点赞过则点赞数 - 1</li><li>剩下的就是前端查询的时候给Blog类的isLike属性赋值。有2个地方做了查询，第一个就是在首页查询Blog的列表，这是个分页查询，第二个地方是点击某个Blog，查看它的详情的时候。<br> 所以要在根据 id 查询Blog的时候，判断当前登录用户是否点赞过，给isLike属性赋值，还有分页查询Blog的时候，判断当前登录用户是否点赞过，给isLike属性赋值。</li></ul> 
<blockquote> 
 <p>给 Blog 类中添加一个 isLike 字段</p> 
</blockquote> 
<pre><code class="prism language-java"> <span class="token comment">//是否点赞</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isLike<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>判断用户是否对该 Blog 点赞过</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 判断用户是否对该 Blog 点赞过
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">isBlogLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> BLOG_LIKED_KEY <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 用户未登录，无需查询是否点过赞</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> isLiked <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isLiked<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">/**
     * 展示 Blog 详情页（根据ID查Blog）
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1. 查询blog</span>
        <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>blog <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"笔记不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//2. 查询blog相关的用户</span>
        <span class="token function">queryBlogWithUserInfo</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.查询blog是否被点赞</span>
        <span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 分页查询 Blog
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryHotBlog</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> current<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 分页查询</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string">"liked"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>MAX_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前页数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询blog相关的用户以及blog是否被点赞</span>
        records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>blog <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryBlogWithUserInfo</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>实现点赞功能</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">likeBlog</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 判断当前登录用户是否点过赞。</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> BLOG_LIKED_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> isLiked <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	
    <span class="token comment">// 2. 未点过赞：点赞，数据库点赞数 +1，将用户保存到 Redis 的 Set 集合中。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isFalse</span><span class="token punctuation">(</span>isLiked<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Boolean</span> isSucceed <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"liked = liked + 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isSucceed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 3. 已点过赞：取消赞，数据库点赞数 -1，将用户从 Redis 的 Set 集合中移除。</span>
        <span class="token class-name">Boolean</span> isSucceed <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"liked = liked - 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isSucceed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="5_484"></a>5.点赞排行版怎么实现？</h2> 
<h4><a id="51__485"></a>5.1 需求：</h4> 
<p>按照点赞时间先后排序，返回Top5点赞的用户。</p> 
<h4><a id="52__487"></a>5.2 实现步骤：</h4> 
<ul><li>之前的点赞是放在 Set 集合中，但是 Set 集合里的元素是无序不可重复的，这里需要使用可排序的 Set 集合，即 SortedSet。</li><li>通过 ZSCORE 命令获取 SortedSet 中存储的元素的相关的 SCORE 值，来判断存不存在元素，查的到就是有点赞，查不到就是没点赞。</li><li>排行榜的功能通过 ZRANGE 命令获取范围内的元素，按时间戳从小到大排序，返回前5名，那就是查0到4的元素。</li></ul> 
<blockquote> 
 <p>修改点赞业务逻辑</p> 
</blockquote> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">isBlogLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.获取登录用户</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> BLOG_LIKED_KEY <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 用户未登录，无需查询是否点过赞</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.判断当前登录用户是否已经点赞</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Boolean isLiked = stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span>
        <span class="token class-name">Double</span> score <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//blog.setIsLike(BooleanUtil.isTrue(isLiked);</span>
        blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span>score <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">likeBlog</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 判断当前登录用户是否点过赞。</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> BLOG_LIKED_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token comment">//Boolean isLiked = stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span>
  	<span class="token class-name">Double</span> score <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 未点过赞：点赞，数据库点赞数 +1，将用户保存到 Redis 的 Set 集合中。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isFalse</span><span class="token punctuation">(</span>isLiked<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Boolean</span> isSucceed <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"liked = liked + 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isSucceed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//stringRedisTemplate.opsForSet().add(key, userId.toString());</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 3. 已点过赞：取消赞，数据库点赞数 -1，将用户从 Redis 的 Set 集合中移除。</span>
        <span class="token class-name">Boolean</span> isSucceed <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"liked = liked - 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isSucceed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//stringRedisTemplate.opsForSet().remove(key, userId.toString());</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>top5点赞用户查询</p> 
</blockquote> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogLikes</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> BLOG_LIKED_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token comment">// 1. 查询最早五个点赞的用户</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> topFive <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topFive <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> topFive<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. 解析出UserId,然后根据UserId查询user,再转化为UserDto</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userIdList <span class="token operator">=</span> topFive<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        List&lt;UserDTO&gt; userDTOList = userService.listByIds(userIdList)</span>
<span class="token comment">//                .stream()</span>
<span class="token comment">//                .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span>
<span class="token comment">//                .collect(Collectors.toList());</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">listByIds</span><span class="token punctuation">(</span>userIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> userDTOList  <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">User</span> user <span class="token operator">:</span> users<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userDTOList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userDTOList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="6_567"></a>6.关注怎么实现?</h2> 
<h4><a id="61__568"></a>6.1 需求：</h4> 
<p>关注讲的是用户之间的关系，是种多对多的关系，需要借助中间表，通过 tb_follow表进行表示。<br> 关注功能需要实现两个接口：1.关注与取关的接口 2.判断是否关注的接口。</p> 
<h4><a id="62__571"></a>6.2 实现步骤：</h4> 
<p>判断到底是关注还是取关，取决的是传的参数isFollow，是True就代表关注，是False就代表取关。先获取当前登录的用户，然后判断是关注还是取关，关注就新增数据，取关就删除数据。</p> 
<pre><code class="prism language-java">	<span class="token comment">//关注或取关</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.获取当前登录用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>isFollow<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2.关注，新增数据</span>
            <span class="token class-name">Follow</span> follow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            follow<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            follow<span class="token punctuation">.</span><span class="token function">setFollowUserId</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">save</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?</span>
            <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"follow_user_id"</span><span class="token punctuation">,</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">remove</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>关注和取关完成之后，我们就要去判断一个用户有没有关注，就去tb_follow表查询有没有这样的一条数据，有的话就是关注了，没有的话就是没有关注。</p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * 判断是否关注该用户
     * @param followUserId
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">isFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.获取当前登录用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.查询是否已关注 select count(*) from tb_follow where user_id = #{userId} and follow_user_id = #{followUserId};</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"follow_user_id"</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.判断是否关注</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="7_614"></a>7.共同关注怎么实现?</h2> 
<h4><a id="71__615"></a>7.1 需求：</h4> 
<p>在博主个人页面展示出当前用户与博主的共同好友</p> 
<h4><a id="72__617"></a>7.2 实现步骤：</h4> 
<ul><li>要实现共同关注，我们要去查当前登录的用户和目标用户都关注了谁，求这两个关注列表中的交集。求交集可以用Redis的Set集合。当前登录的用户关注了谁保存在Set集合当中，目标用户关注了谁也保存在Set集合当中，然后求它们的交集。</li><li>所以我们要先去修改之前的关注取关的代码，每次关注的时候不仅要把目标用户放到数据库里，还要放到Redis里，取关的时候要把目标用户从数据库里删除，还要从Redis里删除：</li></ul> 
<pre><code class="prism language-java">	<span class="token comment">//关注或取关</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.获取当前登录用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> followKey <span class="token operator">=</span> <span class="token string">"follow:"</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>isFollow<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2.关注，新增数据</span>
            <span class="token class-name">Follow</span> follow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            follow<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            follow<span class="token punctuation">.</span><span class="token function">setFollowUserId</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isSave <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>isSave<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//把目标用户id放入Redis的Set集合 当前用户id 为 key，关注用户id 为 value</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>followKey<span class="token punctuation">,</span> followUserId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?</span>
            <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"follow_user_id"</span><span class="token punctuation">,</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isRemove <span class="token operator">=</span> <span class="token function">remove</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>isRemove<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//把目标用户id从Redis的Set集合移除</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>followKey<span class="token punctuation">,</span> followUserId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ul><li>接下来实现共同关注,求当前用户和目标用户关注列表的交集。</li><li>先获取当前登录用户，再获取目标用户，求交集，通过stream流解析出UserId集合，然后根据UserId查询用户。</li></ul> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">commonFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.获取当前登录用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> followKey1 <span class="token operator">=</span> <span class="token string">"follow:"</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
        <span class="token comment">//获取目标用户</span>
        <span class="token class-name">String</span> followKey2 <span class="token operator">=</span> <span class="token string">"follow:"</span> <span class="token operator">+</span> followUserId<span class="token punctuation">;</span>

        <span class="token comment">//2.求交集</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> intersect <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span>followKey1<span class="token punctuation">,</span> followKey2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>intersect<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">||</span>intersect<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//3.解析出id集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userIdList <span class="token operator">=</span> intersect<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4.然后根据UserId查询用户,再转化为UserDto List&lt;User&gt; ---&gt; List&lt;UserDTO&gt;</span>
<span class="token comment">//        List&lt;User&gt; users = userService.listByIds(userIdList);</span>
<span class="token comment">//        List&lt;UserDTO&gt; userDTOList  =new ArrayList&lt;&gt;();</span>
<span class="token comment">//        for (User user : users){<!-- --></span>
<span class="token comment">//            UserDTO userDTO = new UserDTO();</span>
<span class="token comment">//            BeanUtils.copyProperties(user,userDTO);</span>
<span class="token comment">//            userDTOList.add(userDTO);</span>
<span class="token comment">//        }</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> userDTOList <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">listByIds</span><span class="token punctuation">(</span>userIdList<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userDTOList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="8_691"></a>8.关注推送怎么实现？</h2> 
<h4><a id="81__692"></a>8.1 需求：</h4> 
<p>要去修改新增笔记的业务，在保存 Blog 到数据库的同时，也要推送消息到粉丝的收件箱。<br> 收件箱根据时间戳排序，使用 Redis 的 SortedSet 数据结构实现。<br> 实现滚动分页查询收件箱数据。（不能使用传统的分页，因为Feed流中的数据会不断更新，每当有新数据的时候，就会出现角标变动，读取到重复的数据，所以需要利用到滚动分页，记录每次操作的最后一条消息，从这个位置开始读取数据。）</p> 
<h4><a id="82__696"></a>8.2 实现步骤：</h4> 
<p>关注推送也叫做 Feed 流。用户通过无限下拉刷新获取新的信息。<br> 获取信息的两种模式:</p> 
<ul><li>传统模式：用户自己寻找信息。</li><li>Feed流模式：应用程序将信息推送给用户。<br> <img src="https://images2.imgbox.com/e5/8b/Q2mDEpwW_o.png" alt="在这里插入图片描述"><br> Feed 流有两种常见模式：</li><li>Timeline模式：不做内容筛选，直接按照内容发布时间排序，常用于好友或关注。比如微信的朋友圈。</li><li>智能排序模式：利用算法屏蔽掉违规、用户不感兴趣的内容。推送用户感兴趣的信息来吸引用户，比如快手，抖音，b站。</li></ul> 
<p>在我们的业务量，个人页面中有个关注的选项卡，这里会展示出关注的人发的探店笔记。用户关注的人发布新的笔记，就会第一时间推送给用户，是基于关注的好友来做 Feed 流，因此采用的是Timeline模式。<br> 实现Timeline模式的方案有三种：拉模式、推模式、推拉结合。<br> 因为用户不多，这里基于推模式实现关注推送。</p> 
<blockquote> 
 <p>推送消息到粉丝的收件箱</p> 
</blockquote> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">saveBlog</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 获取登录用户</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 保存探店博文</span>
        <span class="token keyword">boolean</span> isSucceed <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isFalse</span><span class="token punctuation">(</span>isSucceed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"笔记发布失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. 查询笔记作者的所有粉丝（select * from tb_follow where follow_user_id = ?）</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span> followUserList <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"follow_user_id"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>followUserList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> followUserList <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4. 推送笔记给所有粉丝</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Follow</span> follow <span class="token operator">:</span> followUserList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 粉丝ID</span>
            <span class="token class-name">Long</span> userId <span class="token operator">=</span> follow<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 推送</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> FEED_KEY <span class="token operator">+</span> userId<span class="token punctuation">;</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 返回id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>滚动分页查询</p> 
</blockquote> 
<pre><code class="prism language-java"> <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogOfFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> max<span class="token punctuation">,</span> <span class="token class-name">Integer</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 获取当前用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 查询收件箱 ZREVRANGEBYSCORE key max min LIMIT offset count</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> FEED_KEY <span class="token operator">+</span> userId<span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tupleSet <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverseRangeByScoreWithScores</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tupleSet<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> tupleSet <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//3.解析数据：blogId，minTime（时间戳），offset</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> blogIdList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tupleSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> minTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nextOffset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tuple <span class="token operator">:</span> tupleSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            blogIdList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 时间戳（最后一个元素即为最小时间戳）</span>
            <span class="token keyword">long</span> time <span class="token operator">=</span> tuple<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 假设时间戳为：5 4 4 2 2</span>
            <span class="token comment">// 5 != 0 --&gt; minTime=5; nextOffset = 1;</span>
            <span class="token comment">// 4 != 5 --&gt; minTime=4; nextOffset = 1;</span>
            <span class="token comment">// 4 == 4 --&gt; minTime=4; nextOffset = 2;</span>
            <span class="token comment">// 2 != 4 --&gt; minTime=2; nextOffset = 1;</span>
            <span class="token comment">// 2 == 2 --&gt; minTime=2; nextOffset = 2;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">==</span> minTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                nextOffset <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                minTime <span class="token operator">=</span> time<span class="token punctuation">;</span>
                nextOffset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 4. 根据 ID 查询 Blog</span>
        <span class="token class-name">String</span> blogIdStr <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">,</span> blogIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> blogList <span class="token operator">=</span> <span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Blog</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> blogIdList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">"ORDER BY FIELD(id, "</span> <span class="token operator">+</span> blogIdStr <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Blog</span> blog <span class="token operator">:</span> blogList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 完善 Blog 数据：查询并且设置与 Blog 有关的用户信息，以及 Blog 是否被该用户点赞</span>
            <span class="token function">queryBlogWithUserInfo</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. 封装并返回</span>
        <span class="token class-name">ScrollResult</span> scrollResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScrollResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scrollResult<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>blogList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scrollResult<span class="token punctuation">.</span><span class="token function">setMinTime</span><span class="token punctuation">(</span>minTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scrollResult<span class="token punctuation">.</span><span class="token function">setOffset</span><span class="token punctuation">(</span>nextOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>scrollResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="9_792"></a>9.用户签到怎么实现？</h2> 
<h4><a id="91__793"></a>9.1 签到</h4> 
<p>假如直接用数据库表来实现签到，用户签到一次就是一条记录，若有 1000 万用户，平均每人每年的签到次数为 10 次，这张表的数据量为 1 亿条，数据库压力过大。<br> <img src="https://images2.imgbox.com/11/2e/XUrkMPny_o.png" alt="在这里插入图片描述"><br> 解决方案：用一张签到表，签到打个 ✔️ 即可，未签到打个❌。<br> <img src="https://images2.imgbox.com/b6/79/pGvKN0B6_o.png" alt="在这里插入图片描述"></p> 
<ul><li>按月统计用户签到信息，签到记为 1，未签到则记为 0。</li><li>每一个 bit 位对应当月的一天，形成映射关系；用 0 和 1 标识业务状态，这种思路被称为位图（BitMap），位图的核心思想是把bit位和某种业务状态进行映射，实现简单，节省内存，大多数在做数据统计的时候就会用到BitMap。（布隆过滤器的底层也是用BitMap来实现的）</li><li>Redis 中使用 String 数据结构实现 BitMap，最大上限是 512 MB，转换为 Bit 则是 2<sup>32</sup>个<br> bit 位。（512MB=2<sup>9</sup> x 2<sup>10</sup>KB=2<sup>19</sup>KB=2<sup>29</sup>B=2<sup>32</sup>bit）</li></ul> 
<pre><code class="prism language-java"> <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.获取当前用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.获取日期</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.拼接key  sign:1010:202302</span>
        <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">":yyyyMM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> USER_SIGN_KEY <span class="token operator">+</span> userId <span class="token operator">+</span> keySuffix<span class="token punctuation">;</span>
        <span class="token comment">//4.获取今天是本月的第几天 （1～31，对应BitMap的offset0～30）</span>
        <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//5.写入redis</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>dayOfMonth<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="92__819"></a>9.2 连续签到天数统计</h4> 
<p><img src="https://images2.imgbox.com/93/23/EqsOApwB_o.png" alt="在这里插入图片描述"><br> 从最后一次签到向前统计，直到遇到第一次未签到为止；计算总的签到次数，就是连续签到天数。<br> Java 代码：用BitField命令获取本月到今天为止的所有数据，定义一个计数器，从后向前遍历每个 Bit 位；BitField命令获取到数据的是十进制，将它与 1 做与运算，就能得到最后一个 bit 位。随后将数字右移 1 位，下一个 bit 位就成为了最后一个 bit 位。不断地向前统计，每次获得一个非0 的数字计数器 + 1，直到遍历完所有的数据。<img src="https://images2.imgbox.com/c2/cc/Hp7QSRJX_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="10UV_823"></a>10.用户信息UV统计怎么实现？</h2> 
<ul><li>UV：Unique Visitor，也叫独立访客量。同一个用户1天内多次访问该网站，只记录1次。</li><li>PV：Page View，也叫页面访问量或页面点击量，用户每访问一次页面，就记录1次PV，用户多次访问页面，则记录多次PV。</li></ul> 
<p>UV 统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到 Redis 中，数据量会非常恐怖。</p> 
<ul><li>Hyperloglog是种概率算法，根据一些数据的统计来推算出一个总的数量。</li><li>Redis 中的 Hyperloglog是基于String结构实现的，单个Hyperloglog的内存永远小于16KB，内存占用非常低！</li><li>作为代价，Hyperloglog的测量结果是有大约0.81％的误差。不过对于 UV 统计来说，没啥差。因为是大数据量的统计，比如说1万用户，大约0.81％的误差也就是80多个人。</li></ul> 
<blockquote> 
 <p>单元测试，向 HyperLogLog 中添加100万条数据</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        j <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        values<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"user_"</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">999</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 发送到 Redis</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"hl2"</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//  统计数量</span>
    <span class="token class-name">Long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token string">"hl2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"count = "</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="11_851"></a>11.项目中遇到的困难</h2> 
<h4><a id="111__852"></a>11.1 事务失效的情况</h4> 
<p>1、调用自身方法导致的事务失效</p> 
<blockquote> 
 <p>一个简单的事务失效的例子:</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">updateOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 相当于this.updateOrder(order)</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// update order</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>事务可以生效，是因为Spring对当前类做了动态代理。这里调用的方法，是this.的方式调用的，我们要获取代理对象让事务生效。</p> 
<blockquote> 
 <p>1.获取代理对象让事务生效</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        proxy<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// update order</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>2.在pom文件里引入aspectj依赖</p> 
</blockquote> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.aspectj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aspectjweaver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<blockquote> 
 <p>3.启动类上加 @EnableAspectJAutoProxy(exposeProxy = true) 暴露代理对象</p> 
</blockquote> 
<h4><a id="112__893"></a>11.2 事务失效的情况——秒杀模块一人一单</h4> 
<blockquote> 
 <p>最终版</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 根据 优惠券id 查询数据库</span>
        <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 判断秒杀是否开始或结束（未开始或已结束，返回异常结果）</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀尚未开始!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. 判断库存是否充足（不充足返回异常结果）</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取代理对象</span>
            <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 4. 一人一单（根据 优惠券id 和 用户id 查询订单；存在，则直接返回）</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"不可重复下单！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. 减扣库存</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// set stock= stock - 1</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock - 1"</span><span class="token punctuation">)</span>
                <span class="token comment">// where  voucher_id = ? and stock = ?</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//减扣失败</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 6. 创建订单</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Long userId = UserHolder.getUser().getId();</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSaved <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSaved<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"下单失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 7. 返回 订单id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fa3b9667d70cac8844350a1fd13bc105/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何入门编程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3013f53e001a6b745f4b698d65bf1957/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">安装win10虚拟机</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>