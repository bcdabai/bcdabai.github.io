<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32——IIC基础知识及例程使用（后续拓展） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32——IIC基础知识及例程使用（后续拓展）" />
<meta property="og:description" content="文章目录 IIC协议软件实现IIC例程（操作24C02芯片）软件程序流程硬件设计软件设计IIC协议实现代码操作24C02芯片代码 编译成功后进行下载验证： STM32自带IIC部分实现例程操作 IIC协议 IIC(Inter－Integrated Circuit)总线是一种由 PHILIPS 公司开发的两线式串行总线，用于连接
微控制器及其外围设备。它是由数据线 SDA 和时钟 SCL 构成的串行总线，可发送和接收数据。
在 CPU 与被控 IC 之间、 IC 与 IC 之间进行双向传送， 高速 IIC 总线一般可达 400kbps 以上。
I2C 总线在传送数据过程中共有三种类型信号， 它们分别是：开始信号、结束信号和应答
信号。
开始信号： SCL 为高电平时， SDA 由高电平向低电平跳变，开始传送数据。
结束信号： SCL 为高电平时， SDA 由低电平向高电平跳变，结束传送数据。
应答信号：接收数据的 IC 在接收到 8bit 数据后，向发送数据的 IC 发出特定的低电平脉冲，
表示已收到数据。 CPU 向受控单元发出一个信号后，等待受控单元发出一个应答信号， CPU 接
收到应答信号后，根据实际情况作出是否继续传递信号的判断。若未收到应答信号，由判断为
受控单元出现故障。
这些信号中，起始信号是必需的，结束信号和应答信号，都可以不要。 IIC 总线时序图如
图所示：
之前一直听过也偶尔用IIC协议，但是真的在单片机中自我实现或者随意配置还是做不到，这里还是先用开发板上自带的IIC模块和例程来进行学习记录。
开发板上的例程IIC主要使用板载的EEPROM芯片，型号为24C02。该芯片的总容量是256个字节，通过IIC总线与外部连接，通过操作该芯片可以初步了解IIC的初始化及整个协议的运作流程。
一般例程上都是采用软件模拟来达到IIC协议的效果，而对于硬件IIC却很少见有人做个相关的例程，我这里先使用软件模拟IIC来实现操作芯片的效果，后期深入了解后尝试能够使用STM32的硬件IIC来进行操作。
软件实现IIC例程（操作24C02芯片） 软件程序流程 该例程主要使用IIC协议来完成对24C02芯片的操作。整个例程的流程基本上：开机先检测24C02是否存在，然后在主循环中使用按键（KEY0）来执行写入芯片操作，另一个按键（WK_UP）来执行读取操作，通过TFTLCD模块显示相应的信息，同时使用LED0来提示程序正在运行。
硬件设计 根据前面的描述，这个例程中需要操作的外设有：24C02芯片、按键KEY、LED灯以及用来显示的LCD屏幕模块。KEY、LED灯都是通过简单的GPIO通用输入输出功能来实现，这里就不进行详细描述了，LCD屏幕会在另一篇文章中详细描述。
接下来我们看板子上对于24C02芯片的相关硬件连接，如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/45f9e577b382d80144192b1d2436c40e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-26T22:36:26+08:00" />
<meta property="article:modified_time" content="2020-04-26T22:36:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32——IIC基础知识及例程使用（后续拓展）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#IIC_3" rel="nofollow">IIC协议</a></li><li><a href="#IIC24C02_22" rel="nofollow">软件实现IIC例程（操作24C02芯片）</a></li><li><ul><li><a href="#_23" rel="nofollow">软件程序流程</a></li><li><a href="#_26" rel="nofollow">硬件设计</a></li><li><a href="#_31" rel="nofollow">软件设计</a></li><li><ul><li><a href="#IIC_34" rel="nofollow">IIC协议实现代码</a></li><li><a href="#24C02_196" rel="nofollow">操作24C02芯片代码</a></li></ul> 
   </li><li><a href="#_441" rel="nofollow">编译成功后进行下载验证：</a></li></ul> 
  </li><li><a href="#STM32IIC_452" rel="nofollow">STM32自带IIC部分实现例程操作</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="IIC_3"></a>IIC协议</h2> 
<p>IIC(Inter－Integrated Circuit)总线是一种由 PHILIPS 公司开发的两线式串行总线，用于连接<br> 微控制器及其外围设备。它是由数据线 SDA 和时钟 SCL 构成的串行总线，可发送和接收数据。<br> 在 CPU 与被控 IC 之间、 IC 与 IC 之间进行双向传送， 高速 IIC 总线一般可达 400kbps 以上。<br> I2C 总线在传送数据过程中共有三种类型信号， 它们分别是：开始信号、结束信号和应答<br> 信号。<br> 开始信号： SCL 为高电平时， SDA 由高电平向低电平跳变，开始传送数据。<br> 结束信号： SCL 为高电平时， SDA 由低电平向高电平跳变，结束传送数据。<br> 应答信号：接收数据的 IC 在接收到 8bit 数据后，向发送数据的 IC 发出特定的低电平脉冲，<br> 表示已收到数据。 CPU 向受控单元发出一个信号后，等待受控单元发出一个应答信号， CPU 接<br> 收到应答信号后，根据实际情况作出是否继续传递信号的判断。若未收到应答信号，由判断为<br> 受控单元出现故障。<br> 这些信号中，起始信号是必需的，结束信号和应答信号，都可以不要。 IIC 总线时序图如<br> 图所示：</p> 
<p><img src="https://images2.imgbox.com/ed/b1/mNb2wAHQ_o.png" alt="在这里插入图片描述">之前一直听过也偶尔用IIC协议，但是真的在单片机中自我实现或者随意配置还是做不到，这里还是先用开发板上自带的IIC模块和例程来进行学习记录。<br> 开发板上的例程IIC主要使用板载的EEPROM芯片，型号为24C02。该芯片的总容量是256个字节，通过IIC总线与外部连接，通过操作该芯片可以初步了解IIC的初始化及整个协议的运作流程。<br> 一般例程上都是采用软件模拟来达到IIC协议的效果，而对于硬件IIC却很少见有人做个相关的例程，我这里先使用软件模拟IIC来实现操作芯片的效果，后期深入了解后尝试能够使用STM32的硬件IIC来进行操作。</p> 
<h2><a id="IIC24C02_22"></a>软件实现IIC例程（操作24C02芯片）</h2> 
<h3><a id="_23"></a>软件程序流程</h3> 
<p>该例程主要使用IIC协议来完成对24C02芯片的操作。整个例程的流程基本上：开机先检测24C02是否存在，然后在主循环中使用按键（KEY0）来执行写入芯片操作，另一个按键（WK_UP）来执行读取操作，通过TFTLCD模块显示相应的信息，同时使用LED0来提示程序正在运行。</p> 
<h3><a id="_26"></a>硬件设计</h3> 
<p>根据前面的描述，这个例程中需要操作的外设有：24C02芯片、按键KEY、LED灯以及用来显示的LCD屏幕模块。KEY、LED灯都是通过简单的GPIO通用输入输出功能来实现，这里就不进行详细描述了，LCD屏幕会在另一篇文章中详细描述。<br> 接下来我们看板子上对于24C02芯片的相关硬件连接，如下：<br> <img src="https://images2.imgbox.com/cf/fc/JprVCBRX_o.png" alt="在这里插入图片描述">从图中可以看到，STM32F103中引出的管教PB6、PB7本来也是STM32103芯片定义的I2C1管脚，外面通过上拉电阻接入到芯片24C02的SCL和SDA引脚处。</p> 
<h3><a id="_31"></a>软件设计</h3> 
<p>通过GPIO模拟I2C协议达到I2C通信的相同的效果，主要实现在myiic.c和myiic.h文件中，具体内容如下：</p> 
<h4><a id="IIC_34"></a>IIC协议实现代码</h4> 
<ul><li>myiic.c</li></ul> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myiic.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">//初始化IIC</span>
<span class="token keyword">void</span> <span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>					     
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>	RCC_APB2Periph_GPIOB<span class="token punctuation">,</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能GPIOB时钟</span>
	   
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_6<span class="token operator">|</span>GPIO_Pin_7<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP <span class="token punctuation">;</span>   <span class="token comment">//推挽输出</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span>GPIO_Pin_6<span class="token operator">|</span>GPIO_Pin_7<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//PB6,PB7 输出高</span>
<span class="token punctuation">}</span>
<span class="token comment">//产生IIC起始信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//sda线输出</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	  	  
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//START:when CLK is high,DATA change form high to low </span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//钳住I2C总线，准备发送或接收数据 </span>
<span class="token punctuation">}</span>	  
<span class="token comment">//产生IIC停止信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sda线输出</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//STOP:when CLK is high DATA change form low to high</span>
 	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//发送I2C总线结束信号</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							   	
<span class="token punctuation">}</span>
<span class="token comment">//等待应答信号到来</span>
<span class="token comment">//返回值：1，接收应答失败</span>
<span class="token comment">//        0，接收应答成功</span>
u8 <span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 ucErrTime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//SDA设置为输入  </span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
	<span class="token keyword">while</span><span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		ucErrTime<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ucErrTime<span class="token operator">&gt;</span><span class="token number">250</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//时钟输出0 	   </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> 
<span class="token comment">//产生ACK应答</span>
<span class="token keyword">void</span> <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//不产生ACK应答		    </span>
<span class="token keyword">void</span> <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>					 				     
<span class="token comment">//IIC发送一个字节</span>
<span class="token comment">//返回从机有无应答</span>
<span class="token comment">//1，有应答</span>
<span class="token comment">//0，无应答			  </span>
<span class="token keyword">void</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>u8 txd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>                        
    u8 t<span class="token punctuation">;</span>   
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	    
    IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//拉低时钟开始数据传输</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>              
        <span class="token comment">//IIC_SDA=(txd&amp;0x80)&gt;&gt;7;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>txd<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">)</span>
			IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		txd<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> 	  
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//对TEA5767这三个延时都是必须的</span>
		IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	 
<span class="token punctuation">}</span> 	    
<span class="token comment">//读1个字节，ack=1时，发送ACK，ack=0，发送nACK   </span>
u8 <span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ack<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span>receive<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDA设置为输入</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
        IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        receive<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>receive<span class="token operator">++</span><span class="token punctuation">;</span>   
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>					 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span>
        <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送nACK</span>
    <span class="token keyword">else</span>
        <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送ACK   </span>
    <span class="token keyword">return</span> receive<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>myiic.h</li></ul> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> __MYIIC_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __MYIIC_H</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>

<span class="token comment">//IO方向设置</span>
<span class="token comment">//stm32f103使用GPIO的CRL和CRH寄存器来操作GPIO的输入输出状态，CRL操作第0~7管脚，CRH操作第8~15管脚。</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SDA_IN()  {GPIOB-&gt;CRL&amp;=0X0FFFFFFF;GPIOB-&gt;CRL|=(u32)8&lt;&lt;28;}</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SDA_OUT() {GPIOB-&gt;CRL&amp;=0X0FFFFFFF;GPIOB-&gt;CRL|=(u32)3&lt;&lt;28;}</span>

<span class="token comment">//IO操作函数	 </span>
<span class="token macro property">#<span class="token directive keyword">define</span> IIC_SCL    PBout(6) </span><span class="token comment">//SCL</span>
<span class="token macro property">#<span class="token directive keyword">define</span> IIC_SDA    PBout(7) </span><span class="token comment">//SDA	 </span>
<span class="token macro property">#<span class="token directive keyword">define</span> READ_SDA   PBin(7)  </span><span class="token comment">//输入SDA </span>

<span class="token comment">//IIC所有操作函数</span>
<span class="token keyword">void</span> <span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//初始化IIC的IO口				 </span>
<span class="token keyword">void</span> <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//发送IIC开始信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  			<span class="token comment">//发送IIC停止信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>u8 txd<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//IIC发送一个字节</span>
u8 <span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ack<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//IIC读取一个字节</span>
u8 <span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 				<span class="token comment">//IIC等待ACK信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//IIC发送ACK信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//IIC不发送ACK信号</span>

<span class="token keyword">void</span> <span class="token function">IIC_Write_One_Byte</span><span class="token punctuation">(</span>u8 daddr<span class="token punctuation">,</span>u8 addr<span class="token punctuation">,</span>u8 data<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">IIC_Read_One_Byte</span><span class="token punctuation">(</span>u8 daddr<span class="token punctuation">,</span>u8 addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	  
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre> 
<h4><a id="24C02_196"></a>操作24C02芯片代码</h4> 
<p>在这部分代码中主要定义了24C02芯片的初始化及读数据和写数据的具体实现。</p> 
<ul><li>24c02.c</li></ul> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"24cxx.h"</span> </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">//初始化IIC接口</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//因为在例程中只有这一个芯片使用IIC，所以我们在IIC实现之初就是为该操作准备的，实际使用时一般管脚的初始化都是跟外设在一起，并不是说协议初始化后对应的外设就能使用。</span>
<span class="token punctuation">}</span>
<span class="token comment">//在AT24CXX指定地址读出一个数据</span>
<span class="token comment">//ReadAddr:开始读数的地址  </span>
<span class="token comment">//读操作，首先发送外设地址（7位数）|1（写模式）给IIC，得到ACK后，发送需要读取的数据地址ReadAddr,16位地址，先发高8位，得到ACK后继续发低8位，得到ACK后开始进入IIC接收模式，发送start信号，发送外设地址（7位数）|0（读模式）给IIC，得到ACK后，读取此时IIC上的8位数据后根据需要发送nack或者ack，这里发送nack（IIC_Read_Byte的参数为0），之后发送停止信号即可。</span>
<span class="token comment">//返回值  :读到的数据</span>
u8 <span class="token function">AT24CXX_ReadOneByte</span><span class="token punctuation">(</span>u16 ReadAddr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>				  
	u8 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		  	    																 
    <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>EE_TYPE<span class="token operator">&gt;</span>AT24C16<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">//发送写命令</span>
		<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>ReadAddr<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送高地址</span>
		<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		 
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA0</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ReadAddr<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送器件地址0XA0,写数据 	 </span>

	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>ReadAddr<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送低地址</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    
	<span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  	 	   
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//进入接收模式			   </span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
    temp<span class="token operator">=</span><span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		   
    <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//产生一个停止条件	    </span>
	<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//在AT24CXX指定地址写入一个数据</span>
<span class="token comment">//WriteAddr  :写入数据的目的地址    </span>
<span class="token comment">//DataToWrite:要写入的数据</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_WriteOneByte</span><span class="token punctuation">(</span>u16 WriteAddr<span class="token punctuation">,</span>u8 DataToWrite<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>				   	  	    																 
    <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>EE_TYPE<span class="token operator">&gt;</span>AT24C16<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    <span class="token comment">//发送写命令</span>
		<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送高地址</span>
 	<span class="token punctuation">}</span><span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA0</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送器件地址0XA0,写数据 </span>
	<span class="token punctuation">}</span>	 
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
    <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送低地址</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	 										  		   
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>DataToWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//发送字节							   </span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  		    	   
    <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//产生一个停止条件 </span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
<span class="token punctuation">}</span>
<span class="token comment">//在AT24CXX里面的指定地址开始写入长度为Len的数据</span>
<span class="token comment">//该函数用于写入16bit或者32bit的数据.</span>
<span class="token comment">//WriteAddr  :开始写入的地址  </span>
<span class="token comment">//DataToWrite:数据数组首地址</span>
<span class="token comment">//Len        :要写入数据的长度2,4</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_WriteLenByte</span><span class="token punctuation">(</span>u16 WriteAddr<span class="token punctuation">,</span>u32 DataToWrite<span class="token punctuation">,</span>u8 Len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  	
	u8 t<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>Len<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">AT24CXX_WriteOneByte</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">+</span>t<span class="token punctuation">,</span><span class="token punctuation">(</span>DataToWrite<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>												    
<span class="token punctuation">}</span>

<span class="token comment">//在AT24CXX里面的指定地址开始读出长度为Len的数据</span>
<span class="token comment">//该函数用于读出16bit或者32bit的数据.</span>
<span class="token comment">//ReadAddr   :开始读出的地址 </span>
<span class="token comment">//返回值     :数据</span>
<span class="token comment">//Len        :要读出数据的长度2,4</span>
u32 <span class="token function">AT24CXX_ReadLenByte</span><span class="token punctuation">(</span>u16 ReadAddr<span class="token punctuation">,</span>u8 Len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  	
	u8 t<span class="token punctuation">;</span>
	u32 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>Len<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		temp<span class="token operator">&lt;&lt;=</span><span class="token number">8</span><span class="token punctuation">;</span>
		temp<span class="token operator">+</span><span class="token operator">=</span><span class="token function">AT24CXX_ReadOneByte</span><span class="token punctuation">(</span>ReadAddr<span class="token operator">+</span>Len<span class="token operator">-</span>t<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	 				   
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> temp<span class="token punctuation">;</span>												    
<span class="token punctuation">}</span>
<span class="token comment">//检查AT24CXX是否正常</span>
<span class="token comment">//这里用了24XX的最后一个地址(255)来存储标志字.</span>
<span class="token comment">//如果用其他24C系列,这个地址要修改</span>
<span class="token comment">//返回1:检测失败</span>
<span class="token comment">//返回0:检测成功</span>
u8 <span class="token function">AT24CXX_Check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 temp<span class="token punctuation">;</span>
	temp<span class="token operator">=</span><span class="token function">AT24CXX_ReadOneByte</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//避免每次开机都写AT24CXX			   </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">==</span><span class="token number">0X55</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>		   
	<span class="token keyword">else</span><span class="token comment">//排除第一次初始化的情况</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">AT24CXX_WriteOneByte</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0X55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    temp<span class="token operator">=</span><span class="token function">AT24CXX_ReadOneByte</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  
		<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">==</span><span class="token number">0X55</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>											  
<span class="token punctuation">}</span>

<span class="token comment">//在AT24CXX里面的指定地址开始读出指定个数的数据</span>
<span class="token comment">//ReadAddr :开始读出的地址 对24c02为0~255</span>
<span class="token comment">//pBuffer  :数据数组首地址</span>
<span class="token comment">//NumToRead:要读出数据的个数</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_Read</span><span class="token punctuation">(</span>u16 ReadAddr<span class="token punctuation">,</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span>u16 NumToRead<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>NumToRead<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>pBuffer<span class="token operator">++</span><span class="token operator">=</span><span class="token function">AT24CXX_ReadOneByte</span><span class="token punctuation">(</span>ReadAddr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		NumToRead<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
<span class="token comment">//在AT24CXX里面的指定地址开始写入指定个数的数据</span>
<span class="token comment">//WriteAddr :开始写入的地址 对24c02为0~255</span>
<span class="token comment">//pBuffer   :数据数组首地址</span>
<span class="token comment">//NumToWrite:要写入数据的个数</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_Write</span><span class="token punctuation">(</span>u16 WriteAddr<span class="token punctuation">,</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span>u16 NumToWrite<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>NumToWrite<span class="token operator">--</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">AT24CXX_WriteOneByte</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">,</span><span class="token operator">*</span>pBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
		WriteAddr<span class="token operator">++</span><span class="token punctuation">;</span>
		pBuffer<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>24c02.h</li></ul> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> __24CXX_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __24CXX_H</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myiic.h"</span>   </span>

<span class="token macro property">#<span class="token directive keyword">define</span> AT24C01		127</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AT24C02		255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AT24C04		511</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AT24C08		1023</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AT24C16		2047</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AT24C32		4095</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AT24C64	    8191</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AT24C128	16383</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AT24C256	32767  </span>
<span class="token comment">//Mini STM32开发板使用的是24c02，所以定义EE_TYPE为AT24C02</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EE_TYPE AT24C02</span>
					  
u8 <span class="token function">AT24CXX_ReadOneByte</span><span class="token punctuation">(</span>u16 ReadAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">//指定地址读取一个字节</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_WriteOneByte</span><span class="token punctuation">(</span>u16 WriteAddr<span class="token punctuation">,</span>u8 DataToWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//指定地址写入一个字节</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_WriteLenByte</span><span class="token punctuation">(</span>u16 WriteAddr<span class="token punctuation">,</span>u32 DataToWrite<span class="token punctuation">,</span>u8 Len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定地址开始写入指定长度的数据</span>
u32 <span class="token function">AT24CXX_ReadLenByte</span><span class="token punctuation">(</span>u16 ReadAddr<span class="token punctuation">,</span>u8 Len<span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//指定地址开始读取指定长度数据</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_Write</span><span class="token punctuation">(</span>u16 WriteAddr<span class="token punctuation">,</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span>u16 NumToWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//从指定地址开始写入指定长度的数据</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_Read</span><span class="token punctuation">(</span>u16 ReadAddr<span class="token punctuation">,</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span>u16 NumToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>   	<span class="token comment">//从指定地址开始读出指定长度的数据</span>

u8 <span class="token function">AT24CXX_Check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//检查器件</span>
<span class="token keyword">void</span> <span class="token function">AT24CXX_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化IIC</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre> 
<p>接下来是主函数如下：</p> 
<ul><li>main.c</li></ul> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"usmart.h"</span>	 </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"24cxx.h"</span>	 </span>
 				 	
<span class="token comment">//要写入到24c02的字符串数组</span>
<span class="token keyword">const</span> u8 TEXT_Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"WarShipSTM32 IIC TEST"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SIZE sizeof(TEXT_Buffer)	</span>
	
 <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>	 
	u8 key<span class="token punctuation">;</span>
	u16 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 datatemp<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    	 <span class="token comment">//延时函数初始化	  </span>
  <span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置中断优先级分组为组2：2位抢占优先级，2位响应优先级</span>
	<span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 	<span class="token comment">//串口初始化为115200</span>
	<span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		  		<span class="token comment">//初始化与LED连接的硬件接口</span>
	<span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			   	<span class="token comment">//初始化LCD 	</span>
	<span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//按键初始化		 	 	</span>
	<span class="token function">AT24CXX_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//IIC初始化 </span>

 	POINT_COLOR<span class="token operator">=</span>RED<span class="token punctuation">;</span><span class="token comment">//设置字体为红色 </span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"WarShip STM32"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"IIC TEST"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"ATOM@ALIENTEK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"2015/1/15"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"KEY1:Write  KEY0:Read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//显示提示信息		</span>
 	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">AT24CXX_Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//检测不到24c02</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"24C02 Check Failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Please Check!      "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		LED0<span class="token operator">=</span><span class="token operator">!</span>LED0<span class="token punctuation">;</span><span class="token comment">//DS0闪烁</span>
	<span class="token punctuation">}</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"24C02 Ready!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
 	POINT_COLOR<span class="token operator">=</span>BLUE<span class="token punctuation">;</span><span class="token comment">//设置字体为蓝色	  </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		key<span class="token operator">=</span><span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY1_PRES<span class="token punctuation">)</span><span class="token comment">//KEY_UP按下,写入24C02</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">LCD_Fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">239</span><span class="token punctuation">,</span><span class="token number">319</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除半屏    </span>
 			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Start Write 24C02...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">AT24CXX_Write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>TEXT_Buffer<span class="token punctuation">,</span>SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"24C02 Write Finished!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示传送完成</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY0_PRES<span class="token punctuation">)</span><span class="token comment">//KEY1按下,读取字符串并显示</span>
		<span class="token punctuation">{<!-- --></span>
 			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Start Read 24C02.... "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">AT24CXX_Read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>datatemp<span class="token punctuation">,</span>SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"The Data Readed Is:  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示传送完成</span>
			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">190</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>datatemp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示读到的字符串</span>
		<span class="token punctuation">}</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">20</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			LED0<span class="token operator">=</span><span class="token operator">!</span>LED0<span class="token punctuation">;</span><span class="token comment">//提示系统正在运行	</span>
			i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>		   
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_441"></a>编译成功后进行下载验证：</h3> 
<p>通过先按<br> WK_UP 按键写入数据，然后按 KEY1 读取数据， 得到如图 所示：<br> <img src="https://images2.imgbox.com/12/31/pAuEGDMC_o.png" alt="在这里插入图片描述"><br> 同时 DS0 会不停的闪烁，提示程序正在运行。 程序在开机的时候会检测 24C02 是否存在，<br> 如果不存在则会在 TFTLCD 模块上显示错误信息，同时 DS0 慢闪。 读者可以通过跳线帽把 PB6<br> 和 PB7 短接就可以看到报错了。<br> 我们通过在 USMART 里面加入 AT24CXX_WriteOneByte 和 AT24CXX_ReadOneByte 函数，<br> 就可以通过 USMART 读取和写入 24C02 的任何地址了。如图 所示：<br> <img src="https://images2.imgbox.com/13/47/zS3FAdgS_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="STM32IIC_452"></a>STM32自带IIC部分实现例程操作</h2> 
<p>本来想着通过将STM32F103的PB6和PB7管脚初始化成IIC功能，并通过库函数进行了对应的IIC初始化，但是具体实现中还是没能成功，可能某个地方使用还是不太对。<br> 这部分还在研究中，后续成功操作出来再来添加修改吧。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/58edaddf7ccd13187ed300a55d2c256c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于JFormDesigner注册的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bb07869526d495ad608d2591816a94df/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">小型文件系统FatFS和LittleFS对比和区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>