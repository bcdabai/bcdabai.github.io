<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>网页串口 webSerial - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="网页串口 webSerial" />
<meta property="og:description" content="index.html
&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=&#34;utf-8&#34; /&gt; &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1&#34;&gt; &lt;title&gt;&lt;/title&gt; &lt;script type=&#34;text/javascript&#34;&gt; if(isIE() || isFirefox()){ alert(&#39;当前浏览器（IE浏览器、火狐浏览器）不支持网页串口！请使用Edge或谷歌浏览器访问！&#39;) } else{ window.location.href = &#34;./b.html&#34; } //判断是否为IE浏览器 function isIE(){ if(!!window.ActiveXObject || &#34;ActiveXObject&#34; in window){//ie浏览器不支持 return true; }else{ return false; } } // 判断是否为火狐浏览器 function isFirefox(){ str = navigator.userAgent; if(str.indexOf(&#34;Firefox&#34;) &gt;= 0){ return true } else{ return false } } &lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;/body&gt; &lt;/html&gt; b.html
&lt;!DOCTYPE html&gt; &lt;html lang=&#34;en&#34;&gt; &lt;head&gt; &lt;meta charset=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a742aa6caefe4543fcd81a2451207d37/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-02T08:44:11+08:00" />
<meta property="article:modified_time" content="2023-08-02T08:44:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">网页串口 webSerial</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>index.html</strong></p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;meta charset="utf-8" /&gt;
		&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
		&lt;title&gt;&lt;/title&gt;
		&lt;script type="text/javascript"&gt;
			if(isIE() || isFirefox()){
				alert('当前浏览器（IE浏览器、火狐浏览器）不支持网页串口！请使用Edge或谷歌浏览器访问！')
			}
			else{
				window.location.href = "./b.html"
			}
			
			//判断是否为IE浏览器
			function isIE(){
				if(!!window.ActiveXObject || "ActiveXObject" in window){//ie浏览器不支持
					return true;
				}else{
					return false;
				}
			}
			
			// 判断是否为火狐浏览器
			function isFirefox(){
				str = navigator.userAgent;
				if(str.indexOf("Firefox") &gt;= 0){
					return true
				}
				else{
					return false
				}
			}
		&lt;/script&gt;
	&lt;/head&gt;
	&lt;body&gt;
		
	&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
<p><strong>b.html</strong></p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
	&lt;head&gt;
		&lt;meta charset="utf-8" /&gt;
		&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
		&lt;link rel="stylesheet" href="css/bootstrap.min.css"&gt;
		&lt;script src="jQuery/jquery-1.10.2.min.js"&gt;&lt;/script&gt;
		&lt;script src="js/bootstrap.min.js"&gt;&lt;/script&gt;
		
		&lt;script type="text/javascript" charset="UTF-8"&gt;
			console.log(window.location.href)  //http://172.16.4.131/wwx/webSerial/6.html
			let reader, textEncoder, writer
			let KeepReading=true
			let port
			let isOpen = false//当前串口是否打开；false代表未打开串口
			let res = ''//保存返回结果
			
			//连接串口
			async function myconnect(){
				if ("serial" in navigator) {
					var baudRate=$("#baudRate option:selected").text();
					var dataBits=$("#dataBits option:selected").text();
					var stopBits=$("#stopBits option:selected").text();
					var parity=$("#parity option:selected").text();
					
					// 提示用户选择一个串口。
					 port = await navigator.serial.requestPort();
					 var open_val = {baudRate:Number(baudRate),dataBits:Number(dataBits),stopBits:Number(stopBits),parity:parity,flowControl:'none', bufferSize:16}
					 
					 // 等待串口打开  SerialOptions
					 await port.open(open_val)//使用前端传的串口参数
					 isOpen = true;
					 $('#openBtn').hide()
					 $('#closeBtn').show()
					 $('#sendBtn').show()
					 
					 // 創建一個讀取器並將流鎖定到它。當流被鎖定時，在釋放此讀取器之前無法獲取其他讀取器
					 reader = port.readable.getReader();
					 //调用port.readable.getReader()创建一个读取器并将其锁定为readable。当可读被锁定时，串口不能被关闭。
				}
				else{
					alert("当前浏览器（IE浏览器、火狐浏览器）不支持网页串口！无法使用网页进行串口通讯！请使用Edge或谷歌浏览器访问！")
				}
			}
			
			// 发送指令并读取数据
			async function mysend(){
				var myendStr = $("input[name='end']:checked").val();//是否以\r结束
				res  = ''
				var sendMsg = $("#send").val(); 
				if(sendMsg==''){
					alert('请输入指令！')
				}
				else{//8 位无符号整数值的类型化数组  Uint8Array 对象
					//23 30 31 0D
					// uart.write(b'\x7b\x46\x30\x30\x52\x44\x44\x5b\x0d')   //高温高湿机
					// cmd = b'\x01\x03\x00\x00\x00\x03'  #讀振動傳感器值命令
					// 发送文本指令
					textEncoder = new TextEncoderStream();//轉換流，它抓取所有Uint8Array塊並將它們轉換為字符串。
					writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
					writer = textEncoder.writable.getWriter();
					console.log('sendMsg=='+sendMsg)
					
					if(myendStr=='N'){
						await writer.write(sendMsg)
					}else{
						await writer.write(sendMsg + "\r")
					}
					// await writer.write("#01\r")
					await  writer.close()
					writer.releaseLock();// 允许稍后关闭串口
					$('#receive').val('');//清空上次返回数据
					
					//读取串口数据
					while (port.readable &amp;&amp; KeepReading) {
						// 創建一個讀取器並將流鎖定到它。當流被鎖定時，在釋放此讀取器之前無法獲取其他讀取器
						// reader = port.readable.getReader();
						//调用port.readable.getReader()创建一个读取器并将其锁定为readable。当可读被锁定时，串口不能被关闭。
						try {
							while (true) {//监听来自串行设备的数据
							// 当使用循环从串行设备连续读取数据时，端口Readable将一直被锁定，直到遇到错误。在这种情况下，调用reader.cancel()将强制reader.read()
							// 立即解析为{value: undefined, done: true}，从而允许循环调用reader.releaseLock()
							const { value, done } = await reader.read();
							if (done) {//如果done为真，则串行端口已经关闭，或者没有更多的数据输入。
								break;
							}
					      if (value) {
							  console.log(value)
							  // res += value
							  res += Uint8ArrayToString(value).toString()
							  $('#receive').val(res)
					      }
					    }
						} catch (error) {//只要错误是非致命的，一个新的ReadableStream就会自动创建。如果发生致命错误，如串行设备被删除，则端口。可读的变成了零。
					    // TODO: 处理非致命的读错误。
							console.log(error)
							console.log("处理非致命的读错误");
							alert("数据读取失败")
						}finally{
							// 允许稍后关闭串口。
							reader.releaseLock();
							await port.close()
							console.log('串口已关闭')
							myclose()
							isOpen = false
					  }
					}
				}
			}
			
			// 关闭串口
			async function myclose(){
				if(isOpen){
					window.location.href = "./b.html"
					// KeepReading = false;
					// reader.cancel();
					console.log('关闭reader')
					$('#openBtn').show()
					$('#closeBtn').hide()
					$('#sendBtn').hide()
				}
				else{
					alert("串口未打开，无需关闭串口！")
				}
			}
			
			// 数组转字符串
			function Uint8ArrayToString(fileData){
			  var dataString = "";
			  for (var i = 0; i &lt; fileData.length; i++) {
			    dataString += String.fromCharCode(fileData[i]);
			  }
			  return dataString;
			}
			
			// 字符串转数组
			function toUint8Arr(str) {
				const buffer = [];
				for (let i of str) {
				    const _code = i.charCodeAt(0);
				    if (_code &lt; 0x80) {
				        buffer.push(_code);
				    } else if (_code &lt; 0x800) {
				        buffer.push(0xc0 + (_code &gt;&gt; 6));
				        buffer.push(0x80 + (_code &amp; 0x3f));
				    } else if (_code &lt; 0x10000) {
				        buffer.push(0xe0 + (_code &gt;&gt; 12));
				        buffer.push(0x80 + (_code &gt;&gt; 6 &amp; 0x3f));
				        buffer.push(0x80 + (_code &amp; 0x3f));
				    }
				}
				return Uint8Array.from(buffer); 
			}
			
			// 字符串转换UTF8字节
			function strToUtf8Bytes(str) {
				const utf8 = [];
				  for (let ii = 0; ii &lt; str.length; ii++) {
					let charCode = str.charCodeAt(ii);
					if (charCode &lt; 0x80) utf8.push(charCode);
					else if (charCode &lt; 0x800) {
					  utf8.push(0xc0 | (charCode &gt;&gt; 6), 0x80 | (charCode &amp; 0x3f));
					} else if (charCode &lt; 0xd800 || charCode &gt;= 0xe000) {
					  utf8.push(0xe0 | (charCode &gt;&gt; 12), 0x80 | ((charCode &gt;&gt; 6) &amp; 0x3f), 0x80 | (charCode &amp; 0x3f));
					} else {
					  ii++;
					  charCode = 0x10000 + (((charCode &amp; 0x3ff) &lt;&lt; 10) | (str.charCodeAt(ii) &amp; 0x3ff));
					  utf8.push(
						0xf0 | (charCode &gt;&gt; 18),
						0x80 | ((charCode &gt;&gt; 12) &amp; 0x3f),
						0x80 | ((charCode &gt;&gt; 6) &amp; 0x3f),
						0x80 | (charCode &amp; 0x3f),
					  );
					}
				  }
				  //兼容汉字，ASCII码表最大的值为127，大于127的值为特殊字符
				  for(let jj=0;jj&lt;utf8.length;jj++){
					  var code = utf8[jj];
					  if(code&gt;127){
						  utf8[jj] = code - 256;
					  }
				  }
				  return utf8;
			}
		
			// 根据返回字节码进行16进制转换
			function strToHexCharCode(str){
					var hexCharCode = [];
					var chars = ["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];
					for(var i = 0; i &lt; str.length; i++) {
						  var bit = (str[i] &amp; 0x0f0) &gt;&gt; 4;
						  hexCharCode.push(chars[bit]);
						  var bit = str[i] &amp; 0x0f;
						  hexCharCode.push(chars[bit]);
					}
				   return hexCharCode.join("");
			}

		&lt;/script&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;table border="0" width="50%" align="center"&gt;
			&lt;tr align="center"&gt;&lt;td colspan="4"&gt;&lt;h1&gt;网页串口工具&lt;/h3&gt;&lt;/td&gt;&lt;/tr&gt;
			&lt;tr&gt;
				&lt;td style="padding: 5px;" colspan="1"&gt;
					波特率
					&lt;select name="" id="baudRate" class="form-control "&gt;
						&lt;option value ="110"&gt;110&lt;/option&gt;
						&lt;option value ="300"&gt;300&lt;/option&gt;
						&lt;option value ="600"&gt;600&lt;/option&gt;
						&lt;option value ="1200"&gt;1200&lt;/option&gt;
						&lt;option value ="2400"&gt;2400&lt;/option&gt;
						&lt;option value ="4800"&gt;4800&lt;/option&gt;
						&lt;option value ="9600"&gt;9600&lt;/option&gt;
						&lt;option value ="14400"&gt;14400&lt;/option&gt;
						&lt;option value ="19200"&gt;19200&lt;/option&gt;
						&lt;option value ="38400"&gt;38400&lt;/option&gt;
						&lt;option value ="56000"&gt;56000&lt;/option&gt;
						&lt;option value ="57600"&gt;57600&lt;/option&gt;
						&lt;option value ="115200"&gt;115200&lt;/option&gt;
					&lt;/select&gt;&lt;/td&gt;
				&lt;td style="padding: 5px;" colspan="1"&gt;
				奇偶校验模式
				&lt;select name="" id="parity" class="form-control "&gt;
					&lt;option value="none"&gt;none&lt;/option&gt;
					&lt;option value="even"&gt;even&lt;/option&gt;
					&lt;option value="odd"&gt;odd&lt;/option&gt;
				&lt;/select&gt;
				&lt;/td&gt;&lt;td style="padding: 5px;" colspan="1"&gt;数据位
				&lt;select name="" id="dataBits" class="form-control "&gt;
					&lt;option value="7"&gt;7&lt;/option&gt;
					&lt;option value="8"&gt;8&lt;/option&gt;
				&lt;/select&gt;&lt;/td&gt;
				&lt;td style="padding: 5px;" colspan="1"&gt;停止位
				&lt;select name="" id="stopBits" class="form-control "&gt;
					&lt;option value="1"&gt;1&lt;/option&gt;
					&lt;option value="2"&gt;2&lt;/option&gt;
				&lt;/select&gt;&lt;/td&gt;
			&lt;/tr&gt;
			&lt;tr align=""&gt;
				&lt;td colspan="1" style="padding: 5px;"&gt;发送指令(不包含\r)
				&lt;textarea rows="3" cols="5" id="send" class="form-control "&gt;&lt;/textarea&gt;&lt;/td&gt;
				&lt;td colspan="3" style="padding: 5px;"&gt;接收内容
					&lt;textarea rows="3" cols="5" id="receive" class="form-control "&gt;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;
			&lt;tr align=""&gt;
				&lt;td&gt;是否以\r结束
				&lt;input type="radio" checked="checked" name="end" value="Y"/&gt;是
				&lt;input type="radio"  name="end" value="N"/&gt;否&lt;/td&gt;
			&lt;/tr&gt;
			&lt;tr align="center"&gt;
				&lt;td align="center" style="padding: 5px;" colspan="4"&gt;
					&lt;button id="openBtn" type="button" onclick="myconnect()" class="btn-xs btn-primary" &gt;打开串口&lt;/button&gt;
					&lt;button id="closeBtn" type="button" onclick="myclose()" class="btn-xs btn-primary" style="display: none;"&gt;关闭串口&lt;/button&gt;
					&lt;button id="sendBtn" type="button" onclick="mysend()" class="btn-xs btn-primary"  style="display: none;"&gt;发送指令&lt;/button&gt; &lt;/td&gt;&lt;/tr&gt;
		&lt;/table&gt;
	&lt;/body&gt;
&lt;/html&gt;

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7574e21f5fcd9f5ef6fe0788e5e2a920/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">项目编译时报错：error adding symbols：DSO missing from command line</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/becb20ee49e6b12e32e29033be923513/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">给已有的linux系统增加磁盘容量</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>