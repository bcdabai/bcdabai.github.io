<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DTM分布式事务 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DTM分布式事务" />
<meta property="og:description" content="DTM分布式事务 从内网看到了关于事务在业务中的讨论，评论区大佬有提及DTM开源项目[https://dtm.pub/]，开学开学
基础理论 一、Why DTM ​ 项目产生于实际生产中的问题，涉及订单支付的服务会将所有业务相关逻辑放到一个大的本地事务，导致大量耦合，复杂度大幅提升
​ java成熟的分布式事务解决方案，使用代价过高：大量业务用java重写
​ DTM，Distributed Transaction Manager， 其是一个分布式事务管理器，解决跨数据库、跨服务、跨语言更新数据的一致性问题。
​ DTM提供了Saga、TCC、XA和二阶段消息模式以满足不同应用场景的需求，同时首创的子事务屏障技术有效解决幂等、悬挂和空补偿等异常问题。
​ DTM的优点：
提供简单易用的接口，拆分具体业务接入分布式事务支持多语言栈核心技术子事务屏蔽，降低处理子事务乱的难度 二、 快速上手 1、Demo ​ 了解DTM的发展和特点，quick start一下8⃣️
// 运行dtm git clone https://github.com/dtm-labs/dtm &amp;&amp; cd dtm go run main.go // 运行一个saga示例 go run qs/main.go ​ 上述Saga示例实现一个类似跨行转账的功能，包括两个事务分支：资金转出（TransOut）、资金转入（TransIn）。DTM保证TransIn和TransOut要么全成功，要么全回滚，保证最终金额的正确性。
// 具体业务微服务地址 const qsBusi = &#34;http://localhost:8081/api/busi_saga&#34; req := &amp;gin.H{&#34;amount&#34;: 30} // 微服务的载荷 // DtmServer为DTM服务的地址，是一个url DtmServer := &#34;http://localhost:36789/api/dtmsvr&#34; saga := dtmcli.NewSaga(DtmServer, shortuuid.New()). // 添加一个TransOut的子事务，正向操作为url: qsBusi&#43;&#34;/TransOut&#34;， 补偿操作为url: qsBusi&#43;&#34;/TransOutCompensate&#34; Add(qsBusi&#43;&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7d324f4c9f197f3d6a61f81c4cd753e4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T15:02:29+08:00" />
<meta property="article:modified_time" content="2024-01-08T15:02:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DTM分布式事务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="DTM_0"></a>DTM分布式事务</h2> 
<blockquote> 
 <p>从内网看到了关于事务在业务中的讨论，评论区大佬有提及DTM开源项目[https://dtm.pub/]，开学开学</p> 
</blockquote> 
<h3><a id="_8"></a>基础理论</h3> 
<h4><a id="Why_DTM_10"></a>一、Why DTM</h4> 
<blockquote> 
 <p>​ 项目产生于实际生产中的问题，涉及订单支付的服务会将<strong>所有业务相关逻辑放到一个大的本地事务</strong>，导致大量耦合，复杂度大幅提升</p> 
 <p>​ java成熟的分布式事务解决方案，使用代价过高：大量业务用java重写</p> 
</blockquote> 
<p>​ DTM，Distributed Transaction Manager， 其是一个分布式事务管理器，解决跨数据库、跨服务、跨语言更新数据的一致性问题。</p> 
<p>​ DTM提供了Saga、TCC、XA和二阶段消息模式以满足不同应用场景的需求，同时首创的<strong>子事务屏障</strong>技术有效解决<code>幂等</code>、<code>悬挂</code>和<code>空补偿</code>等异常问题。</p> 
<p>​ DTM的优点：</p> 
<ul><li>提供简单易用的接口，拆分具体业务接入分布式事务</li><li>支持多语言栈</li><li>核心技术<strong>子事务屏蔽</strong>，降低处理子事务乱的难度</li></ul> 
<h4><a id="__28"></a>二、 快速上手</h4> 
<h5><a id="1Demo_30"></a>1、Demo</h5> 
<p>​ 了解DTM的发展和特点，quick start一下8⃣️</p> 
<pre><code class="prism language-shell">// 运行dtm
<span class="token function">git</span> clone https://github.com/dtm-labs/dtm <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> dtm
go run main.go
// 运行一个saga示例
go run qs/main.go
</code></pre> 
<p>​ 上述Saga示例实现一个类似跨行转账的功能，包括两个事务分支：资金转出（TransOut）、资金转入（TransIn）。DTM保证TransIn和TransOut要么全成功，要么全回滚，保证最终金额的正确性。</p> 
<pre><code class="prism language-go">  <span class="token comment">// 具体业务微服务地址</span>
  <span class="token keyword">const</span> qsBusi <span class="token operator">=</span> <span class="token string">"http://localhost:8081/api/busi_saga"</span>
  req <span class="token operator">:=</span> <span class="token operator">&amp;</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"amount"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">}</span> <span class="token comment">// 微服务的载荷</span>
  <span class="token comment">// DtmServer为DTM服务的地址，是一个url</span>
  DtmServer <span class="token operator">:=</span> <span class="token string">"http://localhost:36789/api/dtmsvr"</span>
  saga <span class="token operator">:=</span> dtmcli<span class="token punctuation">.</span><span class="token function">NewSaga</span><span class="token punctuation">(</span>DtmServer<span class="token punctuation">,</span> shortuuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token comment">// 添加一个TransOut的子事务，正向操作为url: qsBusi+"/TransOut"， 补偿操作为url: qsBusi+"/TransOutCompensate"</span>
    <span class="token function">Add</span><span class="token punctuation">(</span>qsBusi<span class="token operator">+</span><span class="token string">"/TransOut"</span><span class="token punctuation">,</span> qsBusi<span class="token operator">+</span><span class="token string">"/TransOutCompensate"</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token comment">// 添加一个TransIn的子事务，正向操作为url: qsBusi+"/TransIn"， 补偿操作为url: qsBusi+"/TransInCompensate"</span>
    <span class="token function">Add</span><span class="token punctuation">(</span>qsBusi<span class="token operator">+</span><span class="token string">"/TransIn"</span><span class="token punctuation">,</span> qsBusi<span class="token operator">+</span><span class="token string">"/TransInCompensate"</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span>
  <span class="token comment">// 提交saga事务，dtm会完成所有的子事务/回滚所有的子事务</span>
  err <span class="token operator">:=</span> saga<span class="token punctuation">.</span><span class="token function">Submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9a/ad/9EzXEVSn_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_61"></a>2、时序图</h5> 
<p><img src="https://images2.imgbox.com/45/7c/Jrqu5Fzn_o.png" alt="在这里插入图片描述"></p> 
<p>​ 从以上时序图可以看出，DTM整个全局事务分为如下几步：</p> 
<ol><li>用户定义好全局事务所有的事务分支（全局事务的组成部分称为事务分支），然后提交给DTM，DTM持久化全局事务信息后，立即返回</li><li>DTM取出第一个事务分支，这里是TransOut，调用该服务并成功返回</li><li>DTM取出第二个事务分支，这里是TransIn，调用该服务并成功返回</li><li>DTM已完成所有的事务分支，将全局事务的状态修改为已完成</li></ol> 
<p><strong>失败情况：</strong></p> 
<p>​ 在实际业务中，子事务可以出现失败，例如转入的子账号被冻结导致转账失败。因此可以对业务代码进行修改来模拟TransIn正向操作失败</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">qsAddRoute</span><span class="token punctuation">(</span>app <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>qsBusiAPI<span class="token operator">+</span><span class="token string">"/TransIn"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"TransIn"</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
		<span class="token comment">// c.JSON(409, "") // Status 409 for Failure. Won't be retried</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>qsBusiAPI<span class="token operator">+</span><span class="token string">"/TransInCompensate"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"TransInCompensate"</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>qsBusiAPI<span class="token operator">+</span><span class="token string">"/TransOut"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"TransOut"</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>qsBusiAPI<span class="token operator">+</span><span class="token string">"/TransOutCompensate"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"TransOutCompensate"</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 再次运行，整个事务最终失败，时序图：</p> 
<p><img src="https://images2.imgbox.com/8d/02/fBbOXJyE_o.png" alt="在这里插入图片描述"></p> 
<p>在转入操作失败的情况下，<strong>TransIn和TransOut的补偿操作被执行</strong>，保证了最终的余额和转账前是一样的</p> 
<p><img src="https://images2.imgbox.com/7b/3c/RrennwJx_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Demo_111"></a>三、二阶段消息Demo</h4> 
<blockquote> 
 <p>业务场景：</p> 
 <p>​ 跨行转账是典型的分布式事务场景，在这里A需要跨行转账给B</p> 
 <p>假设需求场景：</p> 
 <p>​ 只有转出A可能失败，转入B是能够最终成功的</p> 
</blockquote> 
<p>​ 二阶段消息是DTM首创的事务模式，<strong>用于替换本地事务表和事务消息这两种现有的方案</strong></p> 
<p>​ 二阶段消息能够保证<code>本地事务</code>的提交和<code>全局事务</code>的提交是原子性的，适合解决<strong>不需要回滚</strong>的分布式事务场景</p> 
<h5><a id="1_125"></a>1、核心代码</h5> 
<pre><code class="prism language-go"><span class="token comment">// SagaAdjustBalance 1</span>
<span class="token keyword">func</span> <span class="token function">SagaAdjustBalance</span><span class="token punctuation">(</span>db dtmcli<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> uid <span class="token builtin">int</span><span class="token punctuation">,</span> amount <span class="token builtin">int</span><span class="token punctuation">,</span> result <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> dtmcli<span class="token punctuation">.</span>ResultFailure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> dtmcli<span class="token punctuation">.</span>ErrFailure
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> dtmimp<span class="token punctuation">.</span><span class="token function">DBExec</span><span class="token punctuation">(</span>BusiConf<span class="token punctuation">.</span>Driver<span class="token punctuation">,</span> db<span class="token punctuation">,</span> <span class="token string">"update dtm_busi.user_account set balance = balance + ? where user_id = ?"</span><span class="token punctuation">,</span> amount<span class="token punctuation">,</span> uid<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>调整用户的账号余额</p> 
<pre><code class="prism language-go">app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/SagaBTransIn"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			barrier <span class="token operator">:=</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token keyword">return</span> barrier<span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">SagaAdjustBalance</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransInUID<span class="token punctuation">,</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>TransInResult<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>barrier.Call主要用于处理幂等，保证重复调用不会多次调整余额</p> 
<p><strong>开启事务，进行分支调用</strong></p> 
<pre><code class="prism language-go">	gid <span class="token operator">:=</span> dtmimp<span class="token punctuation">.</span><span class="token function">GetFuncName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	req <span class="token operator">:=</span> busi<span class="token punctuation">.</span><span class="token function">GenReqHTTP</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	msg <span class="token operator">:=</span> dtmcli<span class="token punctuation">.</span><span class="token function">NewMsg</span><span class="token punctuation">(</span>DtmServer<span class="token punctuation">,</span> gid<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Add</span><span class="token punctuation">(</span>busi<span class="token punctuation">.</span>Busi<span class="token operator">+</span><span class="token string">"/SagaBTransIn"</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">DoAndSubmitDB</span><span class="token punctuation">(</span>Busi<span class="token operator">+</span><span class="token string">"/QueryPreparedB"</span><span class="token punctuation">,</span> <span class="token function">dbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToSQLDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> busi<span class="token punctuation">.</span><span class="token function">SagaAdjustBalance</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> busi<span class="token punctuation">.</span>TransOutUID<span class="token punctuation">,</span> <span class="token operator">-</span>req<span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>该代码保证了DoAndSubmitDB的业务提交和全局事务提交是原子性的，保证TransOut和TransIn同时成功or失败。 其中DoAndSubmitDB第一个参数为回查URL</p> 
<pre><code class="prism language-go">	app<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/QueryPrepared"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
		logger<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"%s QueryPrepared"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"gid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">string2DtmError</span><span class="token punctuation">(</span>dtmimp<span class="token punctuation">.</span><span class="token function">OrString</span><span class="token punctuation">(</span>MainSwitch<span class="token punctuation">.</span>QueryPreparedResult<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtmcli<span class="token punctuation">.</span>ResultSuccess<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	app<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/QueryPreparedB"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
		logger<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"%s QueryPreparedB"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"gid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		bb <span class="token operator">:=</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
		db <span class="token operator">:=</span> <span class="token function">dbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToSQLDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> bb<span class="token punctuation">.</span><span class="token function">QueryPrepared</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="2_178"></a>2、原子性</h5> 
<p><img src="https://images2.imgbox.com/cb/d9/1eQm6aHO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="SAGADemo_183"></a>四、SAGA型事务Demo</h4> 
<blockquote> 
 <p>业务场景：</p> 
 <p>​ A需要跨行转账给B</p> 
 <p>假设场景：</p> 
 <p>​ 转出A和转入B都可能成功和失败，需要最终转入转出都成功or失败</p> 
</blockquote> 
<p><strong>核心思想：</strong></p> 
<p>​ 将长事务拆分为多个本地短事务，有Saga事务协调器来协调，如果各个本地事务成功完成则正常完成，如果某个步骤失败，则根据相反顺序依次调用补偿操作。</p> 
<h5><a id="1_199"></a>1、核心代码</h5> 
<p>​ 调整用户的账户余额</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">SagaAdjustBalance</span><span class="token punctuation">(</span>db dtmcli<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> uid <span class="token builtin">int</span><span class="token punctuation">,</span> amount <span class="token builtin">int</span><span class="token punctuation">,</span> result <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> dtmcli<span class="token punctuation">.</span>ResultFailure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> dtmcli<span class="token punctuation">.</span>ErrFailure
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> dtmimp<span class="token punctuation">.</span><span class="token function">DBExec</span><span class="token punctuation">(</span>BusiConf<span class="token punctuation">.</span>Driver<span class="token punctuation">,</span> db<span class="token punctuation">,</span> <span class="token string">"update dtm_busi.user_account set balance = balance + ? where user_id = ?"</span><span class="token punctuation">,</span> amount<span class="token punctuation">,</span> uid<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 正向操作/补偿操作的处理函数（源码新增的Demo并未在此作展示</p> 
<pre><code class="prism language-go">		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/SagaBTransIn"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			barrier <span class="token operator">:=</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token keyword">return</span> barrier<span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">SagaAdjustBalance</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransInUID<span class="token punctuation">,</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>TransInResult<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/SagaBTransInCom"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			barrier <span class="token operator">:=</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token keyword">return</span> barrier<span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">SagaAdjustBalance</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransInUID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/SagaBTransOut"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			barrier <span class="token operator">:=</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token keyword">return</span> barrier<span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">SagaAdjustBalance</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransOutUID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>TransOutResult<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/SagaBTransOutCom"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			barrier <span class="token operator">:=</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token keyword">return</span> barrier<span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">SagaAdjustBalance</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransOutUID<span class="token punctuation">,</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>开启事务，进行分支调用</strong></p> 
<pre><code class="prism language-go">		req <span class="token operator">:=</span> <span class="token operator">&amp;</span>busi<span class="token punctuation">.</span>ReqHTTP<span class="token punctuation">{<!-- --></span>Amount<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">}</span>
	  <span class="token comment">// DtmServer为DTM服务的地址</span>
		saga <span class="token operator">:=</span> dtmcli<span class="token punctuation">.</span><span class="token function">NewSaga</span><span class="token punctuation">(</span>dtmutil<span class="token punctuation">.</span>DefaultHTTPServer<span class="token punctuation">,</span> shortuuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token comment">// 添加一个TransOut的子事务，正向操作为url: qsBusi+"/TransOut"， 逆向操作为url: qsBusi+"/TransOutCom"</span>
      <span class="token function">Add</span><span class="token punctuation">(</span>busi<span class="token punctuation">.</span>Busi<span class="token operator">+</span><span class="token string">"/SagaBTransOut"</span><span class="token punctuation">,</span> busi<span class="token punctuation">.</span>Busi<span class="token operator">+</span><span class="token string">"/SagaBTransOutCom"</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token comment">// 添加一个TransIn的子事务，正向操作为url: qsBusi+"/TransOut"， 逆向操作为url: qsBusi+"/TransInCom"</span>
			<span class="token function">Add</span><span class="token punctuation">(</span>busi<span class="token punctuation">.</span>Busi<span class="token operator">+</span><span class="token string">"/SagaBTransIn"</span><span class="token punctuation">,</span> busi<span class="token punctuation">.</span>Busi<span class="token operator">+</span><span class="token string">"/SagaBTransInCom"</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span>
		<span class="token comment">// 提交saga事务，dtm会完成所有的子事务/回滚所有的子事务</span>
    logger<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"busi trans submit"</span><span class="token punctuation">)</span>
		err <span class="token operator">:=</span> saga<span class="token punctuation">.</span><span class="token function">Submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="2_257"></a>2、时序图</h5> 
<p>​ 与<code>快速上手</code>demo一致</p> 
<p><img src="https://images2.imgbox.com/e6/56/Zo6Qo0bg_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3_264"></a>3、处理网络异常</h5> 
<p>​ 假设提交给dtm的事务中， 调用转入操作时，出现短暂的故障——&gt;dtm会重试未完成的操作，此时要求<strong>全局事务中的各个子事务时幂等的</strong>。</p> 
<p>​ 子事务屏障技术，提供了<code>BranchBarrier</code>工具类，提供Call函数来保证函数内部的业务最多被调用一次。</p> 
<h5><a id="4_270"></a>4、处理回滚</h5> 
<p>​ 事务失败交互的时序图：</p> 
<p><img src="https://images2.imgbox.com/e2/6f/vhFxlr31_o.png" alt="在这里插入图片描述"></p> 
<ul><li>TransIn的正向操作发生在提交之前，则补偿为<strong>空操作</strong></li><li>TransIn的操作如果发生在提交后，则补偿操作会将数据提交一次</li></ul> 
<h4><a id="TCCDemo_280"></a>五、TCC型事务Demo</h4> 
<blockquote> 
 <p>业务场景：</p> 
 <p>​ A需要跨行转账给B</p> 
 <p>假设场景：</p> 
 <p>​ 转出A和转入B都可能成功和失败，需要最终转入转出都成功or失败</p> 
</blockquote> 
<p>​ 还有一个要求，假如发生回滚，SAGA 模式下会发生A发现自己的余额被扣减了，但是收款方B迟迟没有收到余额，那么会对A造成很大的困扰。业务上面希望不要出现这种情况</p> 
<p>TCC分为3个阶段</p> 
<ul><li>Try 阶段：尝试执行，完成所有业务检查（一致性）, 预留必须业务资源（准隔离性）</li><li>Confirm 阶段：如果所有分支的Try都成功了，则走到Confirm阶段。Confirm真正执行业务，不作任何业务检查，只使用 Try 阶段预留的业务资源</li><li>Cancel 阶段：如果所有分支的Try有一个失败了，则走到Cancel阶段。Cancel释放 Try 阶段预留的业务资源。</li></ul> 
<p><img src="https://images2.imgbox.com/29/50/gxh0X1i9_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="1_303"></a>1、核心代码</h5> 
<p>​ 冻结/解冻资金操作，会检查约束balance+trading_balance &gt;= 0，如果约束不成立，执行失败（trading_balance 表示被冻结的金额</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">tccAdjustTrading</span><span class="token punctuation">(</span>db dtmcli<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> uid <span class="token builtin">int</span><span class="token punctuation">,</span> amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	affected<span class="token punctuation">,</span> err <span class="token operator">:=</span> dtmimp<span class="token punctuation">.</span><span class="token function">DBExec</span><span class="token punctuation">(</span>BusiConf<span class="token punctuation">.</span>Driver<span class="token punctuation">,</span> db<span class="token punctuation">,</span> <span class="token string">`update dtm_busi.user_account
		set trading_balance=trading_balance+?
		where user_id=? and trading_balance + ? + balance &gt;= 0`</span><span class="token punctuation">,</span> amount<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> affected <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"update error, maybe balance not enough"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">tccAdjustBalance</span><span class="token punctuation">(</span>db dtmcli<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> uid <span class="token builtin">int</span><span class="token punctuation">,</span> amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	affected<span class="token punctuation">,</span> err <span class="token operator">:=</span> dtmimp<span class="token punctuation">.</span><span class="token function">DBExec</span><span class="token punctuation">(</span>BusiConf<span class="token punctuation">.</span>Driver<span class="token punctuation">,</span> db<span class="token punctuation">,</span> <span class="token string">`update dtm_busi.user_account
		set trading_balance=trading_balance-?,
		balance=balance+? where user_id=?`</span><span class="token punctuation">,</span> amount<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> uid<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> affected <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"update user_account 0 rows"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>​ Try/Confirm/Cancel处理函数：</p> 
<pre><code class="prism language-go">		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/TccBTransOutTry"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			req <span class="token operator">:=</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token keyword">if</span> req<span class="token punctuation">.</span>TransOutResult <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">string2DtmError</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>TransOutResult<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			bb <span class="token operator">:=</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token keyword">if</span> req<span class="token punctuation">.</span>Store <span class="token operator">==</span> Redis <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> bb<span class="token punctuation">.</span><span class="token function">RedisCheckAdjustAmount</span><span class="token punctuation">(</span><span class="token function">RedisGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetRedisAccountKey</span><span class="token punctuation">(</span>TransOutUID<span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token number">7</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> req<span class="token punctuation">.</span>Store <span class="token operator">==</span> Mongo <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> bb<span class="token punctuation">.</span><span class="token function">MongoCall</span><span class="token punctuation">(</span><span class="token function">MongoGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>sc mongo<span class="token punctuation">.</span>SessionContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span> <span class="token function">SagaMongoAdjustBalance</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> sc<span class="token punctuation">.</span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TransOutUID<span class="token punctuation">,</span> <span class="token operator">-</span>req<span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">return</span> bb<span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">tccAdjustTrading</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransOutUID<span class="token punctuation">,</span> <span class="token operator">-</span>req<span class="token punctuation">.</span>Amount<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/TccBTransOutConfirm"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Store <span class="token operator">==</span> Redis <span class="token operator">||</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Store <span class="token operator">==</span> Mongo <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">tccAdjustBalance</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransOutUID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Amount<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/TccBTransOutCancel"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span>TccBarrierTransOutCancel<span class="token punctuation">)</span><span class="token punctuation">)</span>
		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/TccBTransInTry"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			req <span class="token operator">:=</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token keyword">if</span> req<span class="token punctuation">.</span>TransInResult <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">string2DtmError</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>TransInResult<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">tccAdjustTrading</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransInUID<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Amount<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/TccBTransInConfirm"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">tccAdjustBalance</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransInUID<span class="token punctuation">,</span> <span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Amount<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		app<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>BusiAPI<span class="token operator">+</span><span class="token string">"/TccBTransInCancel"</span><span class="token punctuation">,</span> dtmutil<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token function">MustBarrierFromGin</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CallWithDB</span><span class="token punctuation">(</span><span class="token function">pdbGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token function">tccAdjustTrading</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> TransInUID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">reqFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>Amount<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>开启事务，进行分支调用</strong></p> 
<pre><code class="prism language-go">	req <span class="token operator">:=</span> busi<span class="token punctuation">.</span><span class="token function">GenReqHTTP</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	gid <span class="token operator">:=</span> dtmimp<span class="token punctuation">.</span><span class="token function">GetFuncName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// TccGlobalTransaction 会开启一个全局事务</span>
	err <span class="token operator">:=</span> dtmcli<span class="token punctuation">.</span><span class="token function">TccGlobalTransaction</span><span class="token punctuation">(</span>DtmServer<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tcc <span class="token operator">*</span>dtmcli<span class="token punctuation">.</span>Tcc<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>resty<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// CallBranch 会将事务分支的Confirm/Cancel注册到全局事务上，然后直接调用Try</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> tcc<span class="token punctuation">.</span><span class="token function">CallBranch</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> Busi<span class="token operator">+</span><span class="token string">"/TccBTransOutTry"</span><span class="token punctuation">,</span> Busi<span class="token operator">+</span><span class="token string">"/TccBTransOutConfirm"</span><span class="token punctuation">,</span> Busi<span class="token operator">+</span><span class="token string">"/TccBTransOutCancel"</span><span class="token punctuation">)</span>
		assert<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> tcc<span class="token punctuation">.</span><span class="token function">CallBranch</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> Busi<span class="token operator">+</span><span class="token string">"/TccBTransInTry"</span><span class="token punctuation">,</span> Busi<span class="token operator">+</span><span class="token string">"/TccBTransInConfirm"</span><span class="token punctuation">,</span> Busi<span class="token operator">+</span><span class="token string">"/TccBTransInCancel"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="2_398"></a>2、处理网络异常</h5> 
<p>​ 同SAGA部分</p> 
<h5><a id="3_404"></a>3、处理回滚</h5> 
<p>​ 事务失败交互的时序图：</p> 
<p><img src="https://images2.imgbox.com/43/2f/8IU2MPTZ_o.png" alt="在这里插入图片描述"></p> 
<p>​ 跟成功的TCC差别就在于，当某个子事务返回失败后，后续就回滚全局事务，调用各个子事务的Cancel操作，保证全局事务全部回滚</p> 
<ul><li>TransIn的正向操作发生在提交之前，则补偿为<strong>空操作</strong></li><li>TransIn的操作如果发生在提交后，则补偿操作会将数据提交一次</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e58a1f4c01f62ec9b6f0d08653f312b1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">电脑应用程序分身双开及多开(能记住账号和密码)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/09248472609f955ebc269d81430c85e7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JHipster - Spring Boot 的快速开发利器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>