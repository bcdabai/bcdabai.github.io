<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何在业务低峰期优先删除利用率低的 Kubernetes Pod 实例 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何在业务低峰期优先删除利用率低的 Kubernetes Pod 实例" />
<meta property="og:description" content="公众号关注 「奇妙的 Linux 世界」
设为「星标」，每天带你玩转 Linux ！
需求场景 同一应用的不同 Pod 可能其利用率是不同的。
在对应用执行缩容操作时， 可能希望移除利用率较低的 Pod。
为了避免频繁更新 Pod，应用应该在执行缩容操作之前更新一次 controller.kubernetes.io/pod-deletion-cost 注解值 （将注解值设置为一个与其 Pod 利用率对应的值）。如果应用自身控制器缩容操作时（例如 Spark 部署的驱动 Pod），这种机制是可以起作用的。
controller.kubernetes.io/pod-deletion-cost 通过使用 controller.kubernetes.io/pod-deletion-cost 注解，用户可以对 ReplicaSet 缩容时要先删除哪些 Pod 设置偏好。
• 类别：注解
• 特性状态： Kubernetes v1.22 [beta]
• 例子：controller.kubernetes.io/pod-deletion-cost: &#34;10&#34;
• 用于：Pod
• 该注解用于设置 Pod 删除成本允许用户影响 ReplicaSet 缩减顺序。注解解析为 int32 类型。
此注解要设置到 Pod 上，取值范围为 [-2147483647, 2147483647]。所代表的是删除同一 ReplicaSet 中其他 Pod 相比较而言的开销。删除开销较小的 Pod 比删除开销较高的 Pod 更容易被删除。
Pod 如果未设置此注解，则隐含的设置值为 0。负值也是可接受的。如果注解值非法，API 服务器会拒绝对应的 Pod。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/443e9577612a28058e35f7ee795c620d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T08:29:41+08:00" />
<meta property="article:modified_time" content="2024-01-10T08:29:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何在业务低峰期优先删除利用率低的 Kubernetes Pod 实例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="js_content"> 
 <p style="text-align:center;">公众号关注 「奇妙的 Linux 世界」<br></p> 
 <p style="text-align:center;">设为「星标」，每天带你玩转 Linux ！</p> 
 <p style="text-align:center;"><img title="" src="https://images2.imgbox.com/49/b8/mxc3Jkgc_o.png" alt="45aeac64a6d591a9fbc74a9d521136ac.png"></p> 
 <h3>需求场景</h3> 
 <p style="text-align:left;">同一应用的不同 Pod 可能其利用率是不同的。</p> 
 <p style="text-align:left;">在<strong>对应用执行缩容操作时， 可能希望移除利用率较低的 Pod</strong>。</p> 
 <p style="text-align:left;">为了避免频繁更新 Pod，应用应该在执行缩容操作之前更新一次 <code>controller.kubernetes.io/pod-deletion-cost</code> 注解值 （将<strong>注解值设置为一个与其 Pod 利用率对应的值</strong>）。如果应用自身控制器缩容操作时（例如 Spark 部署的驱动 Pod），这种机制是可以起作用的。<br></p> 
 <h3>controller.kubernetes.io/pod-deletion-cost</h3> 
 <p style="text-align:left;">通过使用 <code>controller.kubernetes.io/pod-deletion-cost</code> 注解，用户可以对 ReplicaSet 缩容时要先删除哪些 Pod 设置偏好。</p> 
 <blockquote> 
  <ul><li><p>• 类别：注解</p></li><li><p>• <strong>特性状态：</strong> <code>Kubernetes v1.22 [beta]</code></p></li><li><p>• 例子：<code>controller.kubernetes.io/pod-deletion-cost: "10"</code></p></li><li><p>• 用于：Pod</p></li><li><p>• 该注解用于设置 Pod 删除成本允许用户影响 ReplicaSet 缩减顺序。注解解析为 <code>int32</code> 类型。</p></li></ul> 
 </blockquote> 
 <p style="text-align:left;">此注解要设置到 Pod 上，取值范围为 [-2147483647, 2147483647]。所代表的是删除同一 ReplicaSet 中其他 Pod 相比较而言的开销。删除开销较小的 Pod 比删除开销较高的 Pod 更容易被删除。</p> 
 <p style="text-align:left;">Pod 如果未设置此注解，则隐含的设置值为 0。负值也是可接受的。如果注解值非法，API 服务器会拒绝对应的 Pod。</p> 
 <p style="text-align:left;">此功能特性处于 Beta 阶段，默认被启用。你可以通过为 kube-apiserver 和 kube-controller-manager 设置特性门控 <code>PodDeletionCost</code> 来禁用此功能。</p> 
 <p style="text-align:left;"><strong>说明：</strong></p> 
 <ul><li><p>• <strong>此机制实施时仅是尽力而为</strong>，并不能对 Pod 的删除顺序作出任何保证；</p></li><li><p>• 用户<strong>应避免频繁更新注解值</strong>，例如根据某观测度量值来更新此注解值是应该避免的。这样做会在 API 服务器上产生大量的 Pod 更新操作。</p></li><li></ul> 
 <h3>实操演练</h3> 
 <p style="text-align:left;">编写一个副本数为3的<code>nginx-deployment</code></p> 
 <pre class="has"><code class="language-go">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  # tells deployment to run 3 pods matching the template
  replicas: 3 
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80</code></pre> 
 <p style="text-align:left;">部署后，效果如下：</p> 
 <pre class="has"><code class="language-go">$ kubectl apply -f nginx-deployment.yaml 
deployment.apps/nginx-deployment created

$  kubectl get pod -owide
NAME                                READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATES
nginx-deployment-66b6c48dd5-97rjj   1/1     Running   0          11s   10.244.219.78   master   &lt;none&gt;           &lt;none&gt;
nginx-deployment-66b6c48dd5-fcckz   1/1     Running   0          11s   10.244.219.77   master   &lt;none&gt;           &lt;none&gt;
nginx-deployment-66b6c48dd5-rsq8j   1/1     Running   0          11s   10.244.219.79   master   &lt;none&gt;           &lt;none&gt;</code></pre> 
 <p style="text-align:left;">修改pod注解，使用 <code>controller.kubernetes.io/pod-deletion-cost</code> 注解</p> 
 <blockquote> 
  <p><code>nginx-deployment-66b6c48dd5-97rjj </code>删除成本设置为100</p> 
  <p><code>nginx-deployment-66b6c48dd5-fcckz</code>删除成本设置为60</p> 
  <p><code>nginx-deployment-66b6c48dd5-rsq8j</code>删除成本设置为20</p> 
 </blockquote> 
 <pre class="has"><code class="language-go"># `nginx-deployment-66b6c48dd5-97rjj `删除成本设置为100
kubectl annotate pod nginx-deployment-66b6c48dd5-97rjj controller.kubernetes.io/pod-deletion-cost=100 --overwrite

# `nginx-deployment-66b6c48dd5-fcckz`删除成本设置为60
kubectl annotate pod nginx-deployment-66b6c48dd5-fcckz controller.kubernetes.io/pod-deletion-cost=60 --overwrite

# `nginx-deployment-66b6c48dd5-rsq8j`删除成本设置为20
kubectl annotate pod nginx-deployment-66b6c48dd5-rsq8j controller.kubernetes.io/pod-deletion-cost=20 --overwrite</code></pre> 
 <p style="text-align:left;">查看所有pod的<code>controller.kubernetes.io/pod-deletion-cost</code>注解，发现 <code>controller.kubernetes.io/pod-deletion-cost</code> 注解已经被添加</p> 
 <pre class="has"><code class="language-go">$ kubectl get pods -l app=nginx -o custom-columns=POD_NAME:.metadata.name,POD_DELETION_COST:.metadata.annotations.'controller\.kubernetes\.io/pod-deletion-cost'
POD_NAME                            POD_DELETION_COST
nginx-deployment-66b6c48dd5-97rjj   100
nginx-deployment-66b6c48dd5-fcckz   60
nginx-deployment-66b6c48dd5-rsq8j   20</code></pre> 
 <p style="text-align:left;">使用<code>kubectl scale</code>命令缩容<code>nginx-deployment</code>，发现<code>controller.kubernetes.io/pod-deletion-cost</code>数值低的pod优先被删除</p> 
 <pre class="has"><code class="language-go">$ kubectl scale deployment nginx-deployment --replicas=2
deployment.apps/nginx-deployment scaled

# 发现`controller.kubernetes.io/pod-deletion-cost`数值低的pod优先被删除
$  kubectl get pod -owide
NAME                                READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATES
nginx-deployment-66b6c48dd5-97rjj   1/1     Running   0          12m   10.244.219.78   master   &lt;none&gt;           &lt;none&gt;
nginx-deployment-66b6c48dd5-fcckz   1/1     Running   0          12m   10.244.219.77   master   &lt;none&gt;           &lt;none&gt;</code></pre> 
 <p style="text-align:left;">上面我们的<code>nginx-deployment-66b6c48dd5-rsq8j</code>删除成本设置为20，数值最低，所以优先被删除。</p> 
 <h3>拓展：kubectl scale缩容时删除pod的规则</h3> 
 <p style="text-align:left;">缩容时默认删除pod的逻辑代码如下，有兴趣的同学可以看一下：</p> 
 <blockquote> 
  <p>https://github.com/kubernetes/kubernetes/blob/release-1.11/pkg/controller/controller_utils.go#L737</p> 
 </blockquote> 
 <pre class="has"><code class="language-go">func (s ActivePods) Less(i, j int) bool {
    // 1. Unassigned &lt; assigned
    // If only one of the pods is unassigned, the unassigned one is smaller
    if s[i].Spec.NodeName != s[j].Spec.NodeName &amp;&amp; (len(s[i].Spec.NodeName) == 0 || len(s[j].Spec.NodeName) == 0) {
        return len(s[i].Spec.NodeName) == 0
    }
    // 2. PodPending &lt; PodUnknown &lt; PodRunning
    m := map[v1.PodPhase]int{v1.PodPending: 0, v1.PodUnknown: 1, v1.PodRunning: 2}
    if m[s[i].Status.Phase] != m[s[j].Status.Phase] {
        return m[s[i].Status.Phase] &lt; m[s[j].Status.Phase]
    }
    // 3. Not ready &lt; ready
    // If only one of the pods is not ready, the not ready one is smaller
    if podutil.IsPodReady(s[i]) != podutil.IsPodReady(s[j]) {
        return !podutil.IsPodReady(s[i])
    }
    // TODO: take availability into account when we push minReadySeconds information from deployment into pods,
    //       see https://github.com/kubernetes/kubernetes/issues/22065
    // 4. Been ready for empty time &lt; less time &lt; more time
    // If both pods are ready, the latest ready one is smaller
    if podutil.IsPodReady(s[i]) &amp;&amp; podutil.IsPodReady(s[j]) &amp;&amp; !podReadyTime(s[i]).Equal(podReadyTime(s[j])) {
        return afterOrZero(podReadyTime(s[i]), podReadyTime(s[j]))
    }
    // 5. Pods with containers with higher restart counts &lt; lower restart counts
    if maxContainerRestarts(s[i]) != maxContainerRestarts(s[j]) {
        return maxContainerRestarts(s[i]) &gt; maxContainerRestarts(s[j])
    }
    // 6. Empty creation time pods &lt; newer pods &lt; older pods
    if !s[i].CreationTimestamp.Equal(&amp;s[j].CreationTimestamp) {
        return afterOrZero(&amp;s[i].CreationTimestamp, &amp;s[j].CreationTimestamp)
    }
    return false
}</code></pre> 
 <p style="text-align:left;">总结一下：</p> 
 <blockquote> 
  <ol><li><p>1. 如果pod没分配到节点，先被删除</p></li><li><p>2. 如果pod的状态是 Pending&gt;PodUnknown&gt;PodRunning，则Pending优先被删除，PodUnknown次之，PodRunning最后被删除。</p></li><li><p>3. 不是Ready状态的Pod先被删除。</p></li><li><p>4. 如果Pod都是Ready状态，则最后一个变成Ready状态的Pod先被删除（Ready时间最短的）。</p></li><li><p>5. 重启次数大的Pod先被删除。</p></li><li><p>6. 创建时间最新的Pod先被删除。</p></li></ol> 
 </blockquote> 
 <h3>总结</h3> 
 <p style="text-align:left;"><code>controller.kubernetes.io/pod-deletion-cost</code> 是一个用于 Kubernetes Pod 的注解（Annotation）。这个注解通常用于管理控制器（Controller）对于 <strong>Pod 删除的优先级和策略</strong>。以下是有关如何使用 <code>controller.kubernetes.io/pod-deletion-cost</code> 注解的一些信息：</p> 
 <ol><li><p>1. <strong>控制器中的 Pod 删除顺序</strong>：Kubernetes 控制器（如 Deployment、StatefulSet 等）通常会维护一组 Pod，它们共同形成一个应用程序或服务的一部分。在某些情况下，<strong>你可能希望定义哪些 Pod 比其他 Pod 更容易删除</strong>。这可以通过 <code>controller.kubernetes.io/pod-deletion-cost</code> 注解来实现。</p></li><li><p>2. <strong>定义 Pod 删除的相对优先级</strong>：通过为 Pod 添加 <code>controller.kubernetes.io/pod-deletion-cost</code> 注解，你可以为每个 Pod 指定一个数字值，表示其删除的成本。<strong>较低成本的 Pod 将被控制器优先删除，以便在需要缩容时释放资源。</strong>这可以有助于控制器在缩容时选择删除哪些 Pod。例如，你可以设置：<code>controller.kubernetes.io/pod-deletion-cost: "50"</code>对于一个 Pod，而对于另一个 Pod，你可以设置：<code>controller.kubernetes.io/pod-deletion-cost: "100"</code>在这种情况下，具有成本为 50 的 Pod 会在成本为 100 的 Pod 之前被删除，以便控制器更倾向于删除成本较低的 Pod。</p></li><li><p>3. <strong>控制器的自定义删除策略</strong>：一些自定义控制器可能会使用这个注解来实现自定义的 Pod 删除策略。这取决于控制器的设计和需求。</p></li></ol> 
 <p style="text-align:left;">请注意，<code>controller.kubernetes.io/pod-deletion-cost</code> 注解的实际效果取决于控制器的实现和支持。并非所有控制器都支持这个注解，而且它的行为可能因控制器而异。如果你使用的是自定义控制器，可能需要查看相关文档或代码以了解如何正确配置和使用这个注解。</p> 
 <blockquote> 
  <p>本文转载自：「云原生百宝箱」，原文：https://url.hi-linux.com/vpCoh，版权归原作者所有。欢迎投稿，投稿邮箱: editor@hi-linux.com。</p> 
 </blockquote> 
 <p style="text-align:center;"><img src="https://images2.imgbox.com/f8/51/csDNT3ZT_o.gif" alt="e4afa2b4eca25fed68ee518a7ec3cd92.gif"><br><br></p> 
 <p>最近，我们建立了一个<strong>技术交流微信群</strong>。目前群里已加入了不少行业内的大神，有兴趣的同学可以加入和我们一起交流技术，在 <strong>「奇妙的 Linux 世界」</strong> 公众号直接回复 <strong>「加群」</strong> 邀请你入群。<br><br></p> 
 <p style="text-align:center;"><img title="" src="https://images2.imgbox.com/ec/12/Kh3ZxUdR_o.png" alt="3c949d956768b00795e45f2d83aec725.png"></p> 
 <p style="text-align:center;"><strong>你可能还喜欢</strong></p> 
 <p style="text-align:center;">点击下方图片即可阅读<br><br></p> 
 <p style="text-align:center;"><a href="" rel="nofollow"><img src="https://images2.imgbox.com/a1/9f/sP3DRYgc_o.png" alt="e3c53006d7209f2a647b8bd5cc29d3b8.png"></a></p> 
 <p style="text-align:center;">图解几种常见 Kubernetes Pod 驱逐场景<br><br><a href="" rel="nofollow"><img src="https://images2.imgbox.com/8b/8c/OpcyUMeB_o.png" alt="7f850088dd85df4fefd709965e4cfff1.png"></a><br>点击上方图片，『美团|饿了么』外卖红包天天免费领<br><br></p> 
 <p style="text-align:center;"><img src="https://images2.imgbox.com/2b/c3/a96dqJcB_o.png" alt="a6400c909cccab7118e919dc4f7a7d8f.png"></p> 
 <p style="text-align:center;">更多有趣的互联网新鲜事，关注「奇妙的互联网」视频号全了解！<br></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/165c107e804fef1f5263eceb02db757f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">阻塞队列（JAVA）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4b3b5eeefd3d8c33f6f797c14b5ba960/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">R 语言绘制 南丁格尔玫瑰图</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>