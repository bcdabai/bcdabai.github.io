<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Linux--信号】 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Linux--信号】" />
<meta property="og:description" content="目录 一、信号的概念1.1查看系统的信号1.2信号的处理方式 二、信号的产生方式2.1通过终端按键2.2kill命令2.3系统调用2.4软条件产生信号2.5硬件异常产生信号 三、信号的保存3.1概念的认识3.2sigset_t3.3信号集操作函数3.4sigprocmask &amp;&amp; sigpending3.4.1sigprocmask3.4.2 sigpending 3.5函数使用 四、信号的捕捉4.1内核态与用户态4.2内核空间与用户空间4.3信号捕捉4.4sigcation 五、可重入函数六、volatile七、SIGCHLD信号 一、信号的概念 1.1查看系统的信号 kill -l
1-31是普通信号，34-64是实时信号
每一个信号都有一个编号和一个宏定义名称。
1.2信号的处理方式 忽略信号。忽略信号也是处理了信号执行信号的默认处理动作利用signal系统调用，提供一个信号处理函数，要求在内核处理该信号时切换到用户态执行这个函数，这种方式称为捕捉一个信号。就像上面的代码，将2号信号捕捉为一个 handler函数。 #include&lt;iostream&gt; using namespace std; #include&lt;sys/types.h&gt; #include&lt;unistd.h&gt; #include&lt;signal.h&gt; #include&lt;stdlib.h&gt; void myhandler(int signo) { cout&lt;&lt;&#34;process get a signal:&#34;&lt;&lt;signo&lt;&lt;endl; } int main() { signal(2,myhandler); while(true) { cout&lt;&lt;&#34;i am a happy process:&#34;&lt;&lt;getpid()&lt;&lt;endl; sleep(1); } return 0; } 二、信号的产生方式 2.1通过终端按键 比如上面的ctrl &#43; c 就给进程发送了2号信号SIGINT。而ctrl &#43; \可以给进程发送3号信号SIGQUIT。
通过按键组合的方式来给进程发送信号。
2.2kill命令 kill 系统调用，作用：给当进程为pid的进程发送信号
2.3系统调用 kill系统调用 参数：pid:进程pid
sig:几号信号
返回值：成功返回0，失败返回-1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0a264f0b8072887db6fa06bf3287708b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-25T20:41:43+08:00" />
<meta property="article:modified_time" content="2023-12-25T20:41:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Linux--信号】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、信号的概念</a></li><li><ul><li><a href="#11_2" rel="nofollow">1.1查看系统的信号</a></li><li><a href="#12_7" rel="nofollow">1.2信号的处理方式</a></li></ul> 
  </li><li><a href="#_42" rel="nofollow">二、信号的产生方式</a></li><li><ul><li><a href="#21_43" rel="nofollow">2.1通过终端按键</a></li><li><a href="#22kill_46" rel="nofollow">2.2kill命令</a></li><li><a href="#23_49" rel="nofollow">2.3系统调用</a></li><li><a href="#24_150" rel="nofollow">2.4软条件产生信号</a></li><li><a href="#25_183" rel="nofollow">2.5硬件异常产生信号</a></li></ul> 
  </li><li><a href="#_227" rel="nofollow">三、信号的保存</a></li><li><ul><li><a href="#31_228" rel="nofollow">3.1概念的认识</a></li><li><a href="#32sigset_t_240" rel="nofollow">3.2sigset_t</a></li><li><a href="#33_246" rel="nofollow">3.3信号集操作函数</a></li><li><a href="#34sigprocmask__sigpending_268" rel="nofollow">3.4sigprocmask &amp;&amp; sigpending</a></li><li><ul><li><a href="#341sigprocmask_269" rel="nofollow">3.4.1sigprocmask</a></li><li><a href="#342_sigpending_283" rel="nofollow">3.4.2 sigpending</a></li></ul> 
   </li><li><a href="#35_289" rel="nofollow">3.5函数使用</a></li></ul> 
  </li><li><a href="#_346" rel="nofollow">四、信号的捕捉</a></li><li><ul><li><a href="#41_349" rel="nofollow">4.1内核态与用户态</a></li><li><a href="#42_370" rel="nofollow">4.2内核空间与用户空间</a></li><li><a href="#43_378" rel="nofollow">4.3信号捕捉</a></li><li><a href="#44sigcation_384" rel="nofollow">4.4sigcation</a></li></ul> 
  </li><li><a href="#_419" rel="nofollow">五、可重入函数</a></li><li><a href="#volatile_427" rel="nofollow">六、volatile</a></li><li><a href="#SIGCHLD_449" rel="nofollow">七、SIGCHLD信号</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、信号的概念</h2> 
<h3><a id="11_2"></a>1.1查看系统的信号</h3> 
<p>kill -l<br> <img src="https://images2.imgbox.com/64/81/m5JAiadD_o.png" alt="在这里插入图片描述"><br> 1-31是普通信号，34-64是实时信号<br> 每一个信号都有一个编号和一个宏定义名称。</p> 
<h3><a id="12_7"></a>1.2信号的处理方式</h3> 
<ol><li>忽略信号。忽略信号也是处理了信号</li><li>执行信号的默认处理动作</li><li>利用signal系统调用，提供一个信号处理函数，要求在内核处理该信号时切换到用户态执行这个函数，这种方式称为捕捉一个信号。就像上面的代码，将2号信号捕捉为一个</li></ol> 
<pre><code class="prism language-cpp">handler函数。
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myhandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"process get a signal:"</span><span class="token operator">&lt;&lt;</span>signo<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>myhandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"i am a happy process:"</span><span class="token operator">&lt;&lt;</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/16/17/JGPF6LFm_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_42"></a>二、信号的产生方式</h2> 
<h3><a id="21_43"></a>2.1通过终端按键</h3> 
<p>比如上面的ctrl + c 就给进程发送了2号信号SIGINT。而ctrl + \可以给进程发送3号信号SIGQUIT。<br> 通过按键组合的方式来给进程发送信号。</p> 
<h3><a id="22kill_46"></a>2.2kill命令</h3> 
<p>kill 系统调用，作用：给当进程为pid的进程发送信号<br> <img src="https://images2.imgbox.com/03/89/sLr8c7JS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_49"></a>2.3系统调用</h3> 
<ul><li>kill系统调用</li></ul> 
<p><img src="https://images2.imgbox.com/d4/9e/2ecl58UJ_o.png" alt="在这里插入图片描述"><br> 参数：pid:进程pid<br> sig:几号信号<br> 返回值：成功返回0，失败返回-1<br> 作用：给进程pid发送sig信号<br> <strong>mykill.cc</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">kill</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>myproc.cc</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"i am p process pid:"</span><span class="token operator">&lt;&lt;</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>现象：</strong><br> <img src="https://images2.imgbox.com/0d/e5/I6kC6yER_o.png" alt="在这里插入图片描述"></p> 
<ul><li>raise系统调用<br> <img src="https://images2.imgbox.com/ce/7d/awHVKVfK_o.png" alt="在这里插入图片描述"><br> 作用：给当前进程发送信号<br> <strong>myproc.cc</strong></li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> cnt<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">raise</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"i am p process pid:"</span><span class="token operator">&lt;&lt;</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cnt<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/31/5e/ux6N4O25_o.png" alt="在这里插入图片描述"></p> 
<ul><li>abort系统调用<br> <img src="https://images2.imgbox.com/d6/d4/ihpaEBDI_o.png" alt="在这里插入图片描述"><br> 作用：给进程发送6号信号，终止进程<br> <strong>注意：abort函数一定会成功终止进程。不管有没有重新捕捉信号。</strong><br> <strong>myproc.cc</strong></li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> cnt<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//raise(2);</span>
            <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"i am p process pid:"</span><span class="token operator">&lt;&lt;</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cnt<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/84/65/cW4KS8nh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/cd/eb/ousCyOQD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="24_150"></a>2.4软条件产生信号</h3> 
<p><img src="https://images2.imgbox.com/8c/ed/z9anR6Uu_o.png" alt="在这里插入图片描述"><br> 这里也有一个函数alarm，相当于设置一个闹钟，告诉内核多少秒后，发送一个SIGALRM信号给当前进程。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myhandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"process get a signal:"</span><span class="token operator">&lt;&lt;</span>signo<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"i am a happy process:"</span><span class="token operator">&lt;&lt;</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/67/31/jU3rnFoJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="25_183"></a>2.5硬件异常产生信号</h3> 
<p>硬件异常产生信号就是硬件发现进程的某种异常，而硬件是被操作系统管理。硬件会将异常通知给系统，系统就会向当前进程发送适当的信号。<br> 例如：野指针的情况、除0问题</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myhandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"process get a signal:"</span><span class="token operator">&lt;&lt;</span>signo<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span>myhandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span><span class="token operator">*</span> ptr<span class="token punctuation">;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token operator">*</span>ptr<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b3/2c/ktYGsNmJ_o.png" alt="在这里插入图片描述"><br> 原因：由于p是野指针，p指针变量里保存的是随机值，进程执行到野指针这一行。进程在页表中找映射的物理内存时，硬件mmu会发现该虚拟地址是一个 野指针，会产生异常，由于操作系统管理硬件，硬件会将异常发送给系统。系统会发送适当的信号给当前进程。<br> 上面代码有野指针，系统会发送11号信号给进程。但是在循环里面并没有野指针，但是发现一直在打印，说明系统一直在往进程发送11号信号，这是因为硬件异常并没有消除。<br> 只能向进程发送终止信号，终止进程才能结束。<br> <strong>总结</strong><br> 信号是由OS发出来的，上面的五种产生情况，是操作系统发出信号的触发条件。</p> 
<ul><li> <p>上面所有信号的产生都会需要操作系统的参与，为什么？<br> 因为操作系统是进程的管理者，只有操作系统能管理进程。</p> </li><li> <p>信号处理是什么时候被处理的？<br> 在合适的时候处理，并不是信号来了就处理。所以需要记录下来。</p> </li><li> <p>OS怎么向进程发送信号？<br> 普通信号有31个，进程PCB中有一个数据结构，是位图(只需要一个整数即可)。来记录当前进程是否收到对应位置的信号，OS向进程发送信号时，将对应位置置1即可。</p> </li></ul> 
<p>实时信号是由链表构成的，一个时间可以收到多个信号，不会丢失。</p> 
<h2><a id="_227"></a>三、信号的保存</h2> 
<h3><a id="31_228"></a>3.1概念的认识</h3> 
<ul><li>执行信号的处理动作称为信号递达（Delivery）</li><li>信号从产生到递达之间的状态，称为信号未决（pending）。上面说明过信号不是一产生就立即处理的。</li><li>进程可以选择阻塞某一个信号，被阻塞的信号产生时保持未决状态，直到进程解除对此信号的阻塞，才执行递达的动作。</li><li>阻塞和忽略是有本质的不同，只要信号被阻塞就不会递达，而忽略是在递达之后的处理方法。<br> <img src="https://images2.imgbox.com/ad/66/RKaY1zRo_o.png" alt="在这里插入图片描述"><br> 如上图：</li><li>SIGHUP信号未阻塞也未产生过，当它递达时执行默认处理动作（SIG_DEL）（未产生则不会递达）</li><li>SIGINT信号产生过，但正在被阻塞，所以暂时不能递达。虽然其处理动作是忽略（SIG_IGN），但在没有递达前不能忽略这个信号，因为进程仍有机会在改变处理动作之后再解除阻塞</li><li>SIGQUIT信号未产生过，但一旦产生SIGQUIT信号，该信号将被阻塞，它的处理动作是用户自定义函数sighandler</li><li>如果进程解除对某一个信号阻塞之前，该信号产生了很多次只会被记录一次即pending表里对应位置记录的值为1，而实时信号在递达之前产生多次可以依次放在一个队列里（这里只讨论普通信号）</li></ul> 
<h3><a id="32sigset_t_240"></a>3.2sigset_t</h3> 
<p>上面提到了三张表，那作为用户想要拿到表里面的内容是不能直接拿到的。需要通过一些接口还有输出型参数才能拿到。而这个输出型参数的类型就是sigset_t。<br> sigset_t被称为信号集，这个类型可以表示每个信号的"有效"或"无效"状态</p> 
<ul><li>在阻塞信号集中"有效"和"无效"的含义是该信号是否被阻塞。</li><li>在未决信号集中"有效"和"无效"的含义是该信号是否处于未决状态<br> 阻塞信号集也被称为当前进程的信号屏蔽字，"屏蔽"应该理解为阻塞而不是忽略</li></ul> 
<h3><a id="33_246"></a>3.3信号集操作函数</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
 
<span class="token keyword">int</span> <span class="token function">sigemptyset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigfillset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigdelset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token keyword">const</span> sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> 
<ul><li>sigemptyset函数：初始化set所指向的信号集，使其中所有信号的对应bit清零，表示该信号集不包含任何有效信号</li><li>sigfillset函数：初始化set所指向的信号集，使其中所有信号的对应bit置位，表示该信号集的有效信号包括系统支持的所有信号</li><li>sigaddset函数：在set所指向的信号集中添加某种有效信号</li><li>sigdelset函数：在set所指向的信号集中删除某种有效信号</li><li>sigemptyset、sigfillset、sigaddset和sigdelset函数都是成功返回0，出错返回-1</li><li>sigismember函数：判断在set所指向的信号集中是否包含某种信号，若包含则返回1，不包含则返回0，调用失败返回-1<br> <strong>注意：</strong></li><li>在使用sigset_t类型的变量前，一定要调用sigemptyset()或sigfillset()初始化，使信号处于确定的状态</li><li>代码中定义的sigset_t类型的变量s存在栈区，使用上面的函数只会对变量s造成影响，并不会影响进程的任何行为。还需通过sigprocmask()函数，才能将变量s的数据设置进操作系统</li></ul> 
<h3><a id="34sigprocmask__sigpending_268"></a>3.4sigprocmask &amp;&amp; sigpending</h3> 
<h4><a id="341sigprocmask_269"></a>3.4.1sigprocmask</h4> 
<p><strong>作用</strong>：sigprocmask()函数可用于读取或更改进程的信号屏蔽字（阻塞信号集）</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">sigprocmask</span><span class="token punctuation">(</span><span class="token keyword">int</span> how<span class="token punctuation">,</span> <span class="token keyword">const</span> sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> sigset_t <span class="token operator">*</span>oset<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>参数</strong>：</p> 
<ul><li>若oset是非空指针，则读取进程当前的信号屏蔽字通过oset参数传出</li><li>若set是非空指针，则更改进程的信号屏蔽字，参数how指示如何更改</li><li>若oset和set都是非空指针，则先将原来的信号屏蔽字备份到oset里，然后根据set和how参数更改信号屏蔽字</li><li>how<br> <img src="https://images2.imgbox.com/d7/8d/DzmKO02E_o.png" alt="在这里插入图片描述"><br> <strong>返回值</strong>：sigprocmask函数调用成功返回0，出错返回-1</li></ul> 
<h4><a id="342_sigpending_283"></a>3.4.2 sigpending</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">sigpending</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">)</span>；
</code></pre> 
<p><strong>作用</strong>：sigpending()函数用于读取进程的未决信号集<br> sigpending()函数读取当前进程的未决信号集，通过set参数传出。该函数调用成功返回0，出错返回-1</p> 
<h3><a id="35_289"></a>3.5函数使用</h3> 
<p><strong>mysignal.cc</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">PrintPending</span><span class="token punctuation">(</span>sigset_t<span class="token operator">&amp;</span> pending<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>size_t i<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">;</span>i<span class="token operator">&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pending<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> cout<span class="token operator">&lt;&lt;</span><span class="token string">"1"</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>    cout<span class="token operator">&lt;&lt;</span><span class="token string">"0"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"\n\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"catch a singal:"</span><span class="token operator">&lt;&lt;</span>signo<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//对2号信号进行捕捉</span>
    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>


    sigset_t bset<span class="token punctuation">,</span>oset<span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1.将2号信号进行屏蔽</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bset<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1.2调用系统调用，将数据设置系统内核</span>
    <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_SETMASK<span class="token punctuation">,</span><span class="token operator">&amp;</span>bset<span class="token punctuation">,</span><span class="token operator">&amp;</span>oset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将bset设置系统内核，在将系统内核原始的带回oset</span>

    <span class="token comment">//2.打印pengding</span>
    <span class="token keyword">int</span> cnt<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//15秒后解除阻塞</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_SETMASK<span class="token punctuation">,</span><span class="token operator">&amp;</span>oset<span class="token punctuation">,</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sigset_t pending<span class="token punctuation">;</span>
        <span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PrintPending</span><span class="token punctuation">(</span>pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cnt<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>现象：</strong><br> <img src="https://images2.imgbox.com/64/52/6QfrWzta_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_346"></a>四、信号的捕捉</h2> 
<p>进程收到信号之后，并不是立即处理信号，而是在合适的时候进行处理。"合适的时候"就是指，从内核态切换回用户态的时候。<br> 当我们的进程从内核态返回用户态的时候，进行信号的检测和处理。</p> 
<h3><a id="41_349"></a>4.1内核态与用户态</h3> 
<ul><li> <p>内核态通常用来执行操作系统的代码，是一种权限非常高的状态</p> </li><li> <p>用户态是一种用来执行普通用户代码的状态，是一种受监管的普通状态</p> </li></ul> 
<p>从用户态切换为内核态：</p> 
<ul><li> <p>需要进行系统调用时</p> </li><li> <p>当前进程的时间片到了，导致进程切换</p> </li><li> <p>产生异常、中断、陷阱等</p> </li></ul> 
<p>从内核态切换为用户态：</p> 
<ul><li>系统调用返回时</li><li>进程切换完毕</li><li>异常、中断、陷阱等处理完毕</li></ul> 
<p>由用户态切换为内核态被称之为陷入内核。每当需要陷入内核时，本质上是因为需要执行操作系统的代码。比如系统调用函数是由操作系统实现的，要进行系统调用就必须先由用户态切换为内核态</p> 
<h3><a id="42_370"></a>4.2内核空间与用户空间</h3> 
<p>每个进程都有自己的进程地址空间，该进程地址空间由内核空间和用户空间组成：</p> 
<p>用户所写的代码和数据位于用户空间，通过用户级页表与物理内存之间建立映射关系<br> 内核空间存储的实际上是操作系统代码和数据，通过内核级页表与物理内存之间建立映射关系<br> 内核级页表是一个全局的页表，它用来维护操作系统的代码与进程之间的关系。在每个进程的进程地址空间中，用户空间是属于当前进程的，每个进程看到的代码和数据是完全不同的，但内核空间所存放的都是操作系统的代码和数据，所有进程看到的都是一样的内容</p> 
<p><img src="https://images2.imgbox.com/03/60/aCdMiNVJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="43_378"></a>4.3信号捕捉</h3> 
<p>流程图：<br> <img src="https://images2.imgbox.com/09/96/WW7r6xtk_o.png" alt="在这里插入图片描述"><br> 简化图：<br> <img src="https://images2.imgbox.com/b8/8f/8nDJ7c8M_o.png" alt="在这里插入图片描述"><br> 该图形与直线有几个交点就代表在这期间有几次状态切换，而箭头的方向就代表着此次状态切换的方向，图形中间的圆点就代表着检查pending表。</p> 
<h3><a id="44sigcation_384"></a>4.4sigcation</h3> 
<p>捕捉信号除了使用signal()函数外，还可以使用sigaction()函数</p> 
<pre><code class="prism language-cpp"> <span class="token keyword">int</span> <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token operator">*</span>act<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token operator">*</span>oldact<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>sigaction()函数可以读取和修改与指定信号相关联的处理动作，该函数调用成功返回0，出错返回-1</p> 
<ul><li>signum代表指定信号的编号</li><li>若act指针非空，则根据act修改该信号的处理动作</li><li>若oldact指针非空，则通过oldact传出该信号原来的处理动作</li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>sa_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>sa_sigaction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> siginfo_t <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sigset_t   sa_mask<span class="token punctuation">;</span>
	<span class="token keyword">int</span>        sa_flags<span class="token punctuation">;</span>
	<span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>sa_restorer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>sa_handler</strong></p> 
<ul><li>将sa_handler赋值为SIG_IGN传给sigaction函数，表示忽略信号</li><li>将sa_handler赋值为SIG_DFL传给sigaction函数，表示执行系统默认动作</li><li>将sa_handler赋值为一个函数指针，表示用自定义函数捕捉信号，或者说向内核注册了一个信号处理函数</li></ul> 
<p><strong>sa_sigaction</strong><br> sa_sigaction是实时信号的处理函数<br> <strong>sa_mask</strong><br> 当某个信号的处理函数被调用，内核自动将当前信号加入进程的信号屏蔽字，当信号处理函数返回时自动恢复原来的信号屏蔽字，这样就保证了在处理某个信号时，若这种信号再次产生，那么它会被阻塞到当前处理结束为止。<br> 若在调用信号处理函数时，除了当前信号被自动屏蔽之外，还希望屏蔽另外一些信号，则用sa_mask字段说明这些需要额外屏蔽的信号，当信号处理函数返回时，会自动恢复成原来的信号屏蔽字。<br> <strong>sa_flags</strong><br> sa_flags字段包含一些选项，这里直接将sa_flags设置为0即可<br> <strong>sa_restorer</strong><br> 暂时不使用该参数</p> 
<h2><a id="_419"></a>五、可重入函数</h2> 
<p>我们都知道链表在进行头插的时候需要两个步骤。步骤1，将需要头插的结点的next指向head。步骤2，head更新。<br> 假设在执行完步骤1后突然来了一个信号并进行信号捕捉，对信号的处理方法是再进行头插node2。再头插完node2后回来执行步骤2就会出现下面的状况。<br> <img src="https://images2.imgbox.com/01/71/akJXjpSu_o.png" alt="在这里插入图片描述"><br> insert函数访问一个全局链表，有可能因为重入而造成错乱，这样的函数被称之为不可重入函数；反之，若一个函数只访问自己的局部变量或参数，则称之为可重入函数<br> <strong>一个函数符合以下条件之一就一定是不可重入的：</strong><br> 调用了malloc或free，因为malloc也是用全局链表来管理堆的<br> 调用了标准I/O库函数，因为标准I/O库的很多实现都以不可重入的方式使用全局数据结构</p> 
<h2><a id="volatile_427"></a>六、volatile</h2> 
<p><strong>代码：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chage flag 0 to 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	 <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在优化的条件下，flag可能会被优化到cpu内的寄存器中</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"process quit normal\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>优化情况下，键入 CTRL-C ,2号信号被捕捉，执行自定义动作，修改 flag＝1 ，但是 while 条件依旧满足,进程继续运行！但是很明显flag肯定已经被修改了，但是为何循环依旧执行？很明显， while 循环检查的flag，并不是内存中最新的flag，这就存在了数据二异性的问题。 while 检测的flag其实已经因为优化，被放在了CPU寄存器当中。如何解决呢？很明显需要 volatile<br> volatile 作用：保持内存的可见性，告知编译器，被该关键字修饰的变量，不允许被优化，对该变量的任何操作，都必须在真实的内存中进行操作</p> 
<h2><a id="SIGCHLD_449"></a>七、SIGCHLD信号</h2> 
<p>其实，子进程在终止时操作系统会给父进程发生SIGCHLD信号，该信号的默认处理动作是忽略，父进程可以自定义SIGCHLD信号的处理动作，这样父进程就只需专心处理自己的工作，不必关心子进程了，子进程终止时会通知父进程，父进程在信号处理函数中调用wait或waitpid函数清理子进程即可。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
 
<span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"get a signal:"</span> <span class="token operator">&lt;&lt;</span> signo <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"wait child "</span> <span class="token operator">&lt;&lt;</span> ret <span class="token operator">&lt;&lt;</span> <span class="token string">" success"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//child</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child is running, PID: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//father</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>要想不产生僵尸进程还有另外一种办法：父进程调用signal或sigaction函数将SIGCHLD信号的处理动作设置为SIG_IGN，这样子进程在终止时会自动清理掉，不会产生僵尸进程，也不会通知父进程。系统默认的忽略动作和用户用signal或sigaction函数自定义的忽略通常是没有区别的，但这是一个特列。此方法对于Linux可用，但不保证在其他UNIX系统上都可用</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//child</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child is running, PID: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//father</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/12fb5706701e250a1fa4921ba9c4dc6c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">nvidia相关</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/85552f8b779b6c60c91ff1609fe0b7a6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">docker-compose build报TypeError: kwargs_from_env() got an unexpected keyword argument ‘ssl_version’错误</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>