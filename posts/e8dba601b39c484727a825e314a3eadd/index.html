<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>keras训练的h5模型转换为pb模型 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="keras训练的h5模型转换为pb模型" />
<meta property="og:description" content="最近使用keras训练了一个图像分割的模型(.h5)，但最终需要在C&#43;&#43;中调用该模型，由于keras没有C&#43;&#43;接口，所以需要将.h5模型转换为.pb模型后通过tensorflow C&#43;&#43;接口进行调用。
由于本人之前接触深度学习较少，很多东西不是很懂，所以在转换过程中遇到了很多问题，在此记录，共同学习。
1、转换之前需要注意的点 本人在转换过程中发现tensorflow1.x和2.x存在区别，所以在转换之前最好确定训练模型时使用的tensorflow版本，转换过程使用的环境尽量和训练模型使用的环境保持一致，不然容易产生很多错误。导出模型时使用的API，是使用tensorflow.keras还是keras，和转换时使用的API保持一致，因为两者可能不兼容从而导致错误。tensorflow版本：明确当前使用的是1.x还是2.x版本keras版本：与tensorflow版本相匹配，查看tensorflow版本与keras版本对应关系tensorflow各版本whl下载地址 2、tensorflow1.x转换方法 使用环境说明：python3.6.12&#43;tensorflow1.15.0&#43;keras2.2.4
1、常用的方法基本均来自github：keras_to_tensorflow，直接clone下来使用即可。
使用方法：
（1）命令行方式：input_model输入.h5路径，output输入保存.pb路径。
python keras_to_tensorflow.py --input_model=&#34;./model.h5&#34; --output_model=&#34;./model.pb&#34; （2）将参数写入代码中，方便调试。
2、简化后的转换代码
from tensorflow.python.keras.models import load_model #from keras.models import load_model import tensorflow as tf from tensorflow.python.keras import backend as K #from keras import backend as K from tensorflow.python.framework import graph_io def freeze_session(session, keep_var_names=None, output_names=None, clear_devices=True): from tensorflow.python.framework.graph_util import convert_variables_to_constants graph = session.graph with graph.as_default(): freeze_var_names = list(set(v.op.name for v in tf.global_variables()).difference(keep_var_names or [])) output_names = output_names or [] output_names &#43;= [v." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e8dba601b39c484727a825e314a3eadd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-28T18:22:55+08:00" />
<meta property="article:modified_time" content="2021-06-28T18:22:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">keras训练的h5模型转换为pb模型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>最近使用keras训练了一个图像分割的模型(.h5)，但最终需要在C++中调用该模型，由于keras没有C++接口，所以需要将.h5模型转换为.pb模型后通过tensorflow C++接口进行调用。</p> 
<p>由于本人之前接触深度学习较少，很多东西不是很懂，所以在转换过程中遇到了很多问题，在此记录，共同学习。</p> 
<h4><a id="1_3"></a>1、转换之前需要注意的点</h4> 
<ul><li>本人在转换过程中发现tensorflow1.x和2.x存在区别，所以在转换之前最好确定训练模型时使用的tensorflow版本，<strong>转换过程使用的环境尽量和训练模型使用的环境保持一致</strong>，不然容易产生很多错误。</li><li><strong>导出模型时使用的API</strong>，是使用tensorflow.keras还是keras，和转换时使用的API保持一致，因为两者可能不兼容从而导致错误。</li><li>tensorflow版本：明确当前使用的是1.x还是2.x版本</li><li>keras版本：与tensorflow版本相匹配，<a href="https://docs.floydhub.com/guides/environments/" rel="nofollow">查看tensorflow版本与keras版本对应关系</a></li><li><a href="https://pypi.org/project/tensorflow-gpu/1.15.0/#files" rel="nofollow">tensorflow各版本whl下载地址</a></li></ul> 
<h4><a id="2tensorflow1x_9"></a>2、tensorflow1.x转换方法</h4> 
<p><strong>使用环境说明：python3.6.12+tensorflow1.15.0+keras2.2.4</strong></p> 
<p>1、常用的方法基本均来自github：<a href="https://github.com/amir-abdi/keras_to_tensorflow">keras_to_tensorflow</a>，直接clone下来使用即可。<br> 使用方法：<br> （1）命令行方式：input_model输入.h5路径，output输入保存.pb路径。</p> 
<pre><code class="prism language-python">python keras_to_tensorflow<span class="token punctuation">.</span>py 
    <span class="token operator">-</span><span class="token operator">-</span>input_model<span class="token operator">=</span><span class="token string">"./model.h5"</span> 
    <span class="token operator">-</span><span class="token operator">-</span>output_model<span class="token operator">=</span><span class="token string">"./model.pb"</span>
</code></pre> 
<p>（2）将参数写入代码中，方便调试。<br> <img src="https://images2.imgbox.com/01/60/5Sj5qezS_o.png" alt="在这里插入图片描述"><br> 2、简化后的转换代码</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> load_model   <span class="token comment">#from keras.models import load_model</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>keras <span class="token keyword">import</span> backend <span class="token keyword">as</span> K        <span class="token comment">#from keras import backend as K</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>framework <span class="token keyword">import</span> graph_io
 
<span class="token keyword">def</span> <span class="token function">freeze_session</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> keep_var_names<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> output_names<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> clear_devices<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>graph_util <span class="token keyword">import</span> convert_variables_to_constants
    graph <span class="token operator">=</span> session<span class="token punctuation">.</span>graph
    <span class="token keyword">with</span> graph<span class="token punctuation">.</span>as_default<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        freeze_var_names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>op<span class="token punctuation">.</span>name <span class="token keyword">for</span> v <span class="token keyword">in</span> tf<span class="token punctuation">.</span>global_variables<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>difference<span class="token punctuation">(</span>keep_var_names <span class="token operator">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        output_names <span class="token operator">=</span> output_names <span class="token operator">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        output_names <span class="token operator">+=</span> <span class="token punctuation">[</span>v<span class="token punctuation">.</span>op<span class="token punctuation">.</span>name <span class="token keyword">for</span> v <span class="token keyword">in</span> tf<span class="token punctuation">.</span>global_variables<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        input_graph_def <span class="token operator">=</span> graph<span class="token punctuation">.</span>as_graph_def<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> clear_devices<span class="token punctuation">:</span>
            <span class="token keyword">for</span> node <span class="token keyword">in</span> input_graph_def<span class="token punctuation">.</span>node<span class="token punctuation">:</span>
                node<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token string">""</span>
        frozen_graph <span class="token operator">=</span> convert_variables_to_constants<span class="token punctuation">(</span>session<span class="token punctuation">,</span> input_graph_def<span class="token punctuation">,</span>
                                                      output_names<span class="token punctuation">,</span> freeze_var_names<span class="token punctuation">)</span>
        <span class="token keyword">return</span> frozen_graph
 
 
<span class="token triple-quoted-string string">"""----------------------------------配置路径-----------------------------------"""</span>
h5_model_path<span class="token operator">=</span><span class="token string">'./unet.h5'</span>  <span class="token comment">#填写.h5路径</span>
output_path<span class="token operator">=</span><span class="token string">'.'</span>
pb_model_name<span class="token operator">=</span><span class="token string">'unet.pb'</span>    <span class="token comment">#填写保存.pb路径</span>
 
 
<span class="token triple-quoted-string string">"""----------------------------------导入keras模型------------------------------"""</span>
K<span class="token punctuation">.</span>set_learning_phase<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
net_model <span class="token operator">=</span> load_model<span class="token punctuation">(</span>h5_model_path<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'input is :'</span><span class="token punctuation">,</span> net_model<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'output is:'</span><span class="token punctuation">,</span> net_model<span class="token punctuation">.</span>output<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
 
<span class="token triple-quoted-string string">"""----------------------------------保存为.pb格式------------------------------"""</span>
sess <span class="token operator">=</span> K<span class="token punctuation">.</span>get_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
frozen_graph <span class="token operator">=</span> freeze_session<span class="token punctuation">(</span>K<span class="token punctuation">.</span>get_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> output_names<span class="token operator">=</span><span class="token punctuation">[</span>net_model<span class="token punctuation">.</span>output<span class="token punctuation">.</span>op<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
graph_io<span class="token punctuation">.</span>write_graph<span class="token punctuation">(</span>frozen_graph<span class="token punctuation">,</span> output_path<span class="token punctuation">,</span> pb_model_name<span class="token punctuation">,</span> as_text<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>3、常见错误</p> 
<p><code>(1) TypeError:Keras symbolic inputs/outputs do not implement op</code><br> <img src="https://images2.imgbox.com/aa/1d/ckAZXutc_o.png" alt="在这里插入图片描述"><br> <strong>解决方法</strong>：在使用tensorflow1.x时不会出现该错误，若使用tensorflow2.x会出现。此时可切换至tensorflow1.x；或将<code>.op</code>直接删除，修改为<code>net_model.output.name</code>也行，但是大概率还会在其它地方报错…<br> 所以最好还是使用tensorflow1.x，若上述方法解决不了，且需要tensorflow2.x，请看tensorflow2.x转换方法。</p> 
<p><code>(2) TypeError: __init__() got an unexpected keyword argument 'ragged'</code><br> <img src="https://images2.imgbox.com/c6/4f/pQNxBPvy_o.png" alt="在这里插入图片描述"><br> <strong>解决方法</strong>：可能是因为导出模型和转换模型使用的API不一致导致，查看导出模型使用的API属于tensorflow.keras还是keras。若转换模型代码中使用：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> load_model
<span class="token keyword">from</span> keras <span class="token keyword">import</span> backend <span class="token keyword">as</span> K
</code></pre> 
<p>修改为：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> load_model
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>keras <span class="token keyword">import</span> backend <span class="token keyword">as</span> K
</code></pre> 
<p><code>(3) TypeError: Unknown layer: Functional</code><br> <img src="https://images2.imgbox.com/2a/8b/vWJpJvCY_o.png" alt="在这里插入图片描述"><br> <strong>解决方法</strong>：我报错的原因是因为模型使用tensorflow2.4.1训练，转换时使用tensorflow1.15.0，导致该错误，主要问题还是因为环境不一致。<br> 或者是模型中存在自定义层，需要在load_model中显式指出，解决该问题的方法是在load_model函数中添加custom_objects参数，该参数接受一个字典，键值为自定义的层（<a href="https://blog.csdn.net/wlqkycg/article/details/89371531">参考博客</a>）。</p> 
<p><code>(4) TypeError: ('Unrecognized keyword arguments:', dict_keys(['ragged']))</code></p> 
<p><strong>解决方法</strong>：可能是因为tensorflow版本太低，建议使用更高版本。</p> 
<p><code>(5) TypeError: module 'tensorflow' has no attribute 'global_variables'</code><br> <img src="https://images2.imgbox.com/a6/2e/4tfUBY17_o.png" alt="在这里插入图片描述"></p> 
<p><strong>解决方法</strong>：当前tensorflow版本为2.x，可尝试如下修改方式。</p> 
<pre><code class="prism language-python">tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>global_variables<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#类似错误均可将tf修改为tf.compat.v1</span>
</code></pre> 
<p><code>(6) TypeError: *** is not in graph</code><br> <img src="https://images2.imgbox.com/36/2e/JRJxdECb_o.png" alt="在这里插入图片描述"><br> <strong>解决方法</strong>：错误说明：输出节点不在图中(如图中conv2d_18/Relu:0)。</p> 
<ul><li>convert_variables_to_constants函数用来指定保存的 节点名称 而不是 张量的名称 ， “conv2d_18/Relu:0” 是张量的名称而 “conv2d_18/Relu” 表示的是节点的名称。尝试将参数output_names直接指定为“conv2d_18/Relu”，如：</li></ul> 
<pre><code class="prism language-python">output_names<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'conv2d_18/Relu'</span><span class="token punctuation">]</span>
frozen_graph <span class="token operator">=</span> convert_variables_to_constants<span class="token punctuation">(</span>session<span class="token punctuation">,</span> input_graph_def<span class="token punctuation">,</span>
                                              output_names<span class="token punctuation">,</span> freeze_var_names<span class="token punctuation">)</span>
</code></pre> 
<ul><li>确认输出节点名称是否正确。</li><li>若上述方法无法解决，大概率还是tensorflow版本不一致导致。</li></ul> 
<h4><a id="3tensorflow2x_120"></a>3、tensorflow2.x转换方法</h4> 
<p><strong>使用环境说明：python3.8.5+tensorflow2.4.1+keras2.4.0</strong></p> 
<p>1、转换代码</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>convert_to_constants <span class="token keyword">import</span> convert_variables_to_constants_v2

<span class="token keyword">def</span> <span class="token function">h5_to_pb</span><span class="token punctuation">(</span>h5_save_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span>h5_save_path<span class="token punctuation">,</span> <span class="token builtin">compile</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
    full_model <span class="token operator">=</span> tf<span class="token punctuation">.</span>function<span class="token punctuation">(</span><span class="token keyword">lambda</span> Input<span class="token punctuation">:</span> model<span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">)</span>
    full_model <span class="token operator">=</span> full_model<span class="token punctuation">.</span>get_concrete_function<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>TensorSpec<span class="token punctuation">(</span>model<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">,</span> model<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Get frozen ConcreteFunction</span>
    frozen_func <span class="token operator">=</span> convert_variables_to_constants_v2<span class="token punctuation">(</span>full_model<span class="token punctuation">)</span>
    frozen_func<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>as_graph_def<span class="token punctuation">(</span><span class="token punctuation">)</span>

    layers <span class="token operator">=</span> <span class="token punctuation">[</span>op<span class="token punctuation">.</span>name <span class="token keyword">for</span> op <span class="token keyword">in</span> frozen_func<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>get_operations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Frozen model layers: "</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> layer <span class="token keyword">in</span> layers<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Frozen model inputs: "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frozen_func<span class="token punctuation">.</span>inputs<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Frozen model outputs: "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frozen_func<span class="token punctuation">.</span>outputs<span class="token punctuation">)</span>

    <span class="token comment"># Save frozen graph from frozen ConcreteFunction to hard drive</span>
    tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>write_graph<span class="token punctuation">(</span>graph_or_graph_def<span class="token operator">=</span>frozen_func<span class="token punctuation">.</span>graph<span class="token punctuation">,</span>
                      logdir<span class="token operator">=</span><span class="token string">"./pb"</span><span class="token punctuation">,</span>
                      name<span class="token operator">=</span><span class="token string">"model.pb"</span><span class="token punctuation">,</span>
                      as_text<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>   <span class="token comment">#可设置.pb存储路径</span>


h5_to_pb<span class="token punctuation">(</span><span class="token string">'./unet.h5'</span><span class="token punctuation">)</span>   <span class="token comment">#此处填入.h5路径</span>
</code></pre> 
<h4><a id="4pythonpb_160"></a>4、python环境下测试pb</h4> 
<p>需要根据实际情况进行修改，需要修改的地方在代码中已经标出。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2

<span class="token keyword">def</span> <span class="token function">recognize</span><span class="token punctuation">(</span>jpg_path<span class="token punctuation">,</span> pb_file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>Graph<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_default<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        output_graph_def <span class="token operator">=</span> tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>GraphDef<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
        <span class="token comment"># 打开.pb模型</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>pb_file_path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            output_graph_def<span class="token punctuation">.</span>ParseFromString<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            tensors <span class="token operator">=</span> tf<span class="token punctuation">.</span>import_graph_def<span class="token punctuation">(</span>output_graph_def<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"tensors:"</span><span class="token punctuation">,</span>tensors<span class="token punctuation">)</span>
 
        <span class="token comment"># 在一个session中去run一个前向</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
            init <span class="token operator">=</span> tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>
            sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init<span class="token punctuation">)</span>
 
            op <span class="token operator">=</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>get_operations<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
            <span class="token comment"># 打印图中有的操作</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span>m <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'op{}:'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>m<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
            input_x <span class="token operator">=</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"Input:0"</span><span class="token punctuation">)</span>  <span class="token comment"># 具体名称看上一段代码的input.name</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"input_X:"</span><span class="token punctuation">,</span>input_x<span class="token punctuation">)</span>
 
            out_softmax <span class="token operator">=</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"Identity:0"</span><span class="token punctuation">)</span>  <span class="token comment"># 具体名称看上一段代码的output.name</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Output:"</span><span class="token punctuation">,</span>out_softmax<span class="token punctuation">)</span>
 
            <span class="token comment"># 读入图片</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>jpg_path<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment">#注意读入灰度图还是彩图</span>
            img<span class="token operator">=</span>cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#需要和训练模型时图像resize大小保持一致</span>
            <span class="token comment">#img=img.astype(np.float32)</span>
            <span class="token comment">#img=1-img/255;</span>
            <span class="token comment"># img=np.reshape(img,(1,28,28,1))</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"img data type:"</span><span class="token punctuation">,</span>img<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
 
            <span class="token comment"># 显示图片内容</span>
            <span class="token comment"># for row in range(512):</span>
            <span class="token comment">#     for col in range(512):</span>
            <span class="token comment">#         if col!=511:</span>
            <span class="token comment">#             print(img[row][col],' ',end='')</span>
            <span class="token comment">#         else:</span>
            <span class="token comment">#             print(img[row][col])</span>
 
            img_out_softmax <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>out_softmax<span class="token punctuation">,</span>
                                       feed_dict<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>input_x<span class="token punctuation">:</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment">#图像大小保持一致</span>

            <span class="token comment">#转换为可保存图像</span>
            show_image <span class="token operator">=</span> img_out_softmax<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>          
            show_image <span class="token operator">=</span> show_image<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>        
            cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">'result.jpg'</span><span class="token punctuation">,</span>show_image<span class="token punctuation">)</span>
 
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"img_out_softmax:"</span><span class="token punctuation">,</span> img_out_softmax<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span>prob <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>img_out_softmax<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'class {} prob:{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>prob<span class="token punctuation">)</span><span class="token punctuation">)</span>
            prediction_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>img_out_softmax<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Final class if:"</span><span class="token punctuation">,</span>prediction_labels<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"prob of label:"</span><span class="token punctuation">,</span>img_out_softmax<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span>prediction_labels<span class="token punctuation">]</span><span class="token punctuation">)</span>
 
pb_path <span class="token operator">=</span> <span class="token string">'./model.pb'</span>   <span class="token comment">#pb路径</span>
img <span class="token operator">=</span> <span class="token string">'1107.bmp'</span>         <span class="token comment">#图像路径</span>
recognize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> pb_path<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="5_231"></a>5、总结</h4> 
<p>综上所述：大多数问题均是由tensorflow<strong>版本不一致导致</strong>，在解决bug之前最好将版本对应，这样可能会很快解决你的问题。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc5aad66f152a9298b1cb177bf957927/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">怎么看计算机远程桌面的端口号,远程桌面端口-windows如何设置远程桌面登录的端口号...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/96381be4d23ee5901e15bbc665359bcf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">手写koa2源码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>