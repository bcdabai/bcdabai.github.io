<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>23种设计模式7_代理模式之二动态代理 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="23种设计模式7_代理模式之二动态代理" />
<meta property="og:description" content="23种设计模式7_代理模式之二动态代理 1 基本介绍 代理模式：为其他对象提供一种代理以控制对这个对象的访问
代理模式也叫委托模式，它是一项基本设计技巧。许多其他的模式，如状态模式、策略模式、访问者模式本质上都是在更加特殊的场合采用了代理模式。在日常开发应用种，代理模式能够提供非常好的访问控制。
代理可分为两种：一种是静态代理，由程序员创建或由特定工具自动生成源代码，再对其编译。在程序运行前，代理类的**.class**文件就已经存在了；另一种是动态代理：在程序运行时，运用反射机制动态创建而成。
静态代理通常只代理一个类，动态代理是代理一个接口下的多个实现类。
静态代理参考：23种设计模式7_代理模式之一静态代理
静态代理事先知道自己要代理的是什么，而动态代理不知道要代理什么，只有在运行时才知道。
动态代理的两种实现方式：
①JDK动态代理*** 利用反射机制生成一个实现代理接口的匿名类，在调用具体方法前调用InvokeHandler*来处理
②CGlib动态代理*** 利用ASM开源包（开源的Java字节码编辑库，操作字节码），将代理对象类的class文件*加载进来，通过修改其字节码生成子类来处理。
2 JDK动态代理 继续通过游戏代练这个案例来演示动态代理，UML类图如下：
被代理接口：
public interface IGamePlayer { // 登录 void login(String playName, String password); // 打怪 void killMonster(); // 升级 void levelUp(); } 被代理类：
public class GamePlayer implements IGamePlayer{ // 游戏玩家名称 private String playerName; public GamePlayer(String playerName) { this.playerName = playerName; } @Override public void login(String playName, String password) { System.out.println(this.playerName &#43; &#34;登录游戏成功！&#34;); } @Override public void killMonster() { System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/08cf4d171c0385e27151bc38779041fd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-24T14:21:36+08:00" />
<meta property="article:modified_time" content="2021-03-24T14:21:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">23种设计模式7_代理模式之二动态代理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="237__0"></a>23种设计模式7_代理模式之二动态代理</h2> 
<h3><a id="1__2"></a>1 基本介绍</h3> 
<p>代理模式：为其他对象提供一种代理以控制对这个对象的访问</p> 
<p>代理模式也叫委托模式，它是一项基本设计技巧。许多其他的模式，如状态模式、策略模式、访问者模式本质上都是在更加特殊的场合采用了代理模式。在日常开发应用种，代理模式能够提供非常好的访问控制。</p> 
<p>代理可分为两种：一种是静态代理，由程序员创建或由特定工具自动生成源代码，再对其编译。在程序运行前，代理类的**.class**文件就已经存在了；另一种是动态代理：在程序运行时，运用反射机制动态创建而成。</p> 
<p>静态代理通常只代理一个类，动态代理是代理一个接口下的多个实现类。<br> 静态代理参考：<a href="https://blog.csdn.net/gaoyaopeng/article/details/115175779">23种设计模式7_代理模式之一静态代理</a></p> 
<p>静态代理事先知道自己要代理的是什么，而动态代理不知道要代理什么，只有在运行时才知道。</p> 
<p>动态代理的两种实现方式：</p> 
<p>①<em><strong>JDK动态代理*** 利用反射机制生成一个实现代理接口的匿名类，在调用具体方法前调用</strong>InvokeHandler</em>*来处理</p> 
<p>②<em><strong>CGlib动态代理*** 利用ASM开源包（开源的Java字节码编辑库，操作字节码），将代理对象类的</strong>class文件</em>*加载进来，通过修改其字节码生成子类来处理。</p> 
<h3><a id="2_JDK_25"></a>2 JDK动态代理</h3> 
<p>继续通过游戏代练这个案例来演示动态代理，UML类图如下：<br> <img src="https://images2.imgbox.com/ee/fb/9JyTPxgF_o.png" alt="在这里插入图片描述"></p> 
<p>被代理接口：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IGamePlayer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 登录</span>
    <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span>String playName<span class="token punctuation">,</span> String password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打怪</span>
    <span class="token keyword">void</span> <span class="token function">killMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 升级</span>
    <span class="token keyword">void</span> <span class="token function">levelUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>被代理类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GamePlayer</span> <span class="token keyword">implements</span> <span class="token class-name">IGamePlayer</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 游戏玩家名称</span>
    <span class="token keyword">private</span> String playerName<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">GamePlayer</span><span class="token punctuation">(</span>String playerName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>playerName <span class="token operator">=</span> playerName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span>String playName<span class="token punctuation">,</span> String password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>playerName <span class="token operator">+</span> <span class="token string">"登录游戏成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">killMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>playerName <span class="token operator">+</span> <span class="token string">"正在打怪！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">levelUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"恭喜"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>playerName <span class="token operator">+</span> <span class="token string">"又升了一级！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>动态代理类<strong>GamePlayerIH</strong>实现<strong>InvocationHandler</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GamePlayerIH</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 被代理的实例</span>
    Object obj <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token comment">// 我要代理谁</span>
    <span class="token keyword">public</span> <span class="token function">GamePlayerIH</span><span class="token punctuation">(</span>Object _obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> _obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 调用被代理的方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>客户端</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        IGamePlayer player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GamePlayer</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 定义一个Handler</span>
        InvocationHandler handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GamePlayerIH</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取类加载器</span>
        ClassLoader cl <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 动态产生一个代理者</span>
        IGamePlayer playerProxy <span class="token operator">=</span> <span class="token punctuation">(</span>IGamePlayer<span class="token punctuation">)</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>IGamePlayer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerProxy<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerProxy<span class="token punctuation">.</span><span class="token function">killMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerProxy<span class="token punctuation">.</span><span class="token function">levelUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>演示结果：<br> <img src="https://images2.imgbox.com/7c/c2/Hj6ruQOB_o.png" alt="在这里插入图片描述"></p> 
<p>Spring的核心之一AOP就是通过这种方式实现的，这种方式对我们的设计、编码有非常大的影响，对于日志、事务、权限等都可以在系统设计阶段不用考虑，而在设计后通过AOP的方式切过去。</p> 
<p>主题还用<code>IGamePlayer</code>接口和<code>GamePlayer</code>实现类；动态代理的Handler类还是<code>GamePlayerIH</code>，不过可以在invoke方法种添加详细的业务逻辑代码，下面对动态代理类进行优化：</p> 
<p>前置处理：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAdvice</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeforeAdvice</span> <span class="token keyword">implements</span> <span class="token class-name">IAdvice</span><span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"我是前置通知，我被执行了！！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>动态代理类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicProxy</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> T <span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
            ClassLoader loader<span class="token punctuation">,</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span>
            InvocationHandler handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 寻找JoinPoint连接点，AOP框架使用元数据定义</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 执行前置通知</span>
            <span class="token keyword">new</span> <span class="token class-name">BeforeAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 可以添加具体业务的代理，如IGamePlayer</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> T <span class="token function">newProxyInstance</span><span class="token punctuation">(</span>IGamePlayer gamePlayer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获得ClassLoader</span>
        ClassLoader loader <span class="token operator">=</span> gamePlayer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得接口数组</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> gamePlayer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取handler</span>
        GamePlayerIH handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GamePlayerIH</span><span class="token punctuation">(</span>gamePlayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>客户端：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        IGamePlayer player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GamePlayer</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 动态产生一个代理者</span>
        IGamePlayer playerProxy <span class="token operator">=</span> DynamicProxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerProxy<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerProxy<span class="token punctuation">.</span><span class="token function">killMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerProxy<span class="token punctuation">.</span><span class="token function">levelUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>演示结果：<br> <img src="https://images2.imgbox.com/36/0e/8SeqUb68_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_CGlib_188"></a>3 CGlib动态代理</h3> 
<h4><a id="31__190"></a>3.1 简单介绍</h4> 
<p>CGLIB是一个优秀的动态代理框架，它的底层使用ASM在内存中动态的生成被代理类的子类，使用CGLIB即使代理类没有实现任何接口也可以实现动态代理功能。CGLIB具有简单易用，它的运行速度要远远快于JDK的Proxy动态代理。</p> 
<h4><a id="32_CGLIB_196"></a>3.2 CGLIB的核心类</h4> 
<p><code>net.sf.cglib.proxy.Enhancer</code> – 主要的增强类<br> <code>net.sf.cglib.proxy.MethodInterceptor</code> – 主要的方法拦截类，它是Callback接口的子接口，需要用户实现<br> <code>net.sf.cglib.proxy.MethodProxy</code> – JDK的<code>java.lang.reflect.Method</code>类的代理类，可以方便的实现对源对象方法的调用,如使用：<code>Object o = methodProxy.invokeSuper(proxy, args);</code>//虽然第一个参数是被代理对象，也不会出现死循环的问题。</p> 
<h4><a id="33_Enhancer_204"></a>3.3 Enhancer</h4> 
<p><code>Enhancer</code> 是增强器，它对你想代理的类进行扩展</p> 
<p>它的两个主要方法：</p> 
<p><code>setSuperclass</code> 设置需要代理/增强的类（相当于父类）<br> <code>setCallback</code> 设置回调的拦截器，正常是<code>MethodInterceptor</code>的实现类</p> 
<h4><a id="34__MethodInterceptor_215"></a>3.4 MethodInterceptor</h4> 
<p><code>MethodInterceptor</code> 方法拦截器，在调用目标方法的时候会调用它的实现类进行拦截。它最重要方法为intercept，进行拦截并执行。</p> 
<p><code>intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy)</code></p> 
<p>第一个参数是增强类；</p> 
<p>第二个参数是拦截的方法；</p> 
<p>第三个参数是拦截的方法的参数；</p> 
<p>第四个参数是<code>Method</code>的代理类。</p> 
<h4><a id="35__231"></a>3.5 两种方式</h4> 
<p>cglib有两种可选方式，继承和引用。第一种是基于继承实现的动态代理，所以可以直接通过super调用target方法，但是这种方式在spring中是不支持的，因为这样的话，这个target对象就不能被spring所管理，所以cglib还是采用类似jdk的方式，通过持有target对象来达到拦截方法的效果。两种方式其一是通过使用<code>java.lang.reflect.Method</code> 对象的一般反射调用；另一种就是使用<code>net.sf.cglib.proxy.MethodProxy</code> 对象调用。通常使用第二种，因为它更快。</p> 
<h4><a id="36__237"></a>3.6 代码演示</h4> 
<p>创建一个普通类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"动物在奔跑！！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建cglib代理类，实现<code>MethodInterceptor</code>接口</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CglibProxy</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 增强器</span>
    <span class="token keyword">private</span> Enhancer enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">intercept</span><span class="token punctuation">(</span>Object o<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> MethodProxy methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-------------before-----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"method.getName():"</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"methodProxy.getSuperName():"</span> <span class="token operator">+</span> methodProxy<span class="token punctuation">.</span><span class="token function">getSuperName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object obj <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-------------after-----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Object <span class="token function">getProxy</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>main</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Animal animalProxy <span class="token operator">=</span> <span class="token punctuation">(</span>Animal<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">CglibProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        animalProxy<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行发现报错：</p> 
<p><img src="https://images2.imgbox.com/86/2a/PPkGtjQT_o.png" alt="在这里插入图片描述"></p> 
<p>报错内容是缺少类，发现我引入的包是<code>cglib-3.1.jar</code>，后面又导入了<code>asm-all-4.1.jar</code>，就能够正常运行了。</p> 
<p><img src="https://images2.imgbox.com/44/75/5n4m2JhF_o.png" alt="在这里插入图片描述"><br> <a href="https://download.csdn.net/download/gaoyaopeng/16076075">cglib资源包（包含cglib-3.1.jar和asm-all-4.1.jar）</a></p> 
<h4><a id="37__298"></a>3.7 拓展</h4> 
<p>被cglib代理的类只要是普通的类就行，但是要确保类和方法上没有被**<code>final</code><strong>关键字修饰。用</strong><code>final</code><strong>修饰的类会直接抛出异常，但是修饰方法就不会抛出异常，但是此方法不会被代理，但是不影响代理其他没有被</strong><code>final</code>**修改的方法。</p> 
<h5><a id="371__302"></a>3.7.1 死循环演示</h5> 
<p>对<code>CglibProxy</code>进行修改：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CglibProxy</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建增强器</span>
    <span class="token keyword">private</span> Enhancer enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 被代理对象，如果使用invoke会使用到</span>
    <span class="token keyword">private</span> Object target<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">intercept</span><span class="token punctuation">(</span>Object o<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> MethodProxy methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-------------before-----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"method.getName():"</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"methodProxy.getSuperName():"</span> <span class="token operator">+</span> methodProxy<span class="token punctuation">.</span><span class="token function">getSuperName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object obj <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Object obj = methodProxy.invoke(this.target, objects);</span>
        <span class="token comment">//Object obj = methodProxy.invokeSuper(o, objects);</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-------------after-----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Object <span class="token function">getProxy</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> obj<span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>演示结果</p> 
<p><img src="https://images2.imgbox.com/5d/0a/LkvGtgN8_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到一直在打印，导致**<code>StackOverflowError</code>**。注释掉的两个使用方式都是能够正常使用的。</p> 
<h5><a id="372__343"></a>3.7.2 原理分析</h5> 
<p>首先，我们需要获取到代理类的字节文件，然后对其反编译。在main方法种添加下面这句话：</p> 
<p><code>System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, "E:\\classes");</code></p> 
<p>再运行一遍你会发现有生成的代理class文件有三个，我们主要看**<code>Animal$$EnhancerByCGLIB$$e01ba0a1</code>**代理类！</p> 
<p><img src="https://images2.imgbox.com/50/db/4XJVoJCK_o.png" alt="在这里插入图片描述"></p> 
<p>反编译后（代码很长，我截取需要演示的部分，其他省略号）：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Animal</span>$$EnhancerByCGLIB$$e01ba0a1 <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token keyword">implements</span> <span class="token class-name">Factory</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> CGLIB$BOUND<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> ThreadLocal CGLIB$THREAD_CALLBACKS<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Callback<span class="token punctuation">[</span><span class="token punctuation">]</span> CGLIB$STATIC_CALLBACKS<span class="token punctuation">;</span>
    <span class="token keyword">private</span> MethodInterceptor CGLIB$CALLBACK_0<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Method CGLIB$run$<span class="token number">0</span>$Method<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> MethodProxy CGLIB$run$<span class="token number">0</span>$Proxy<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> CGLIB$emptyArgs<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Method CGLIB$finalize$<span class="token number">1</span>$Method<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> MethodProxy CGLIB$finalize$<span class="token number">1</span>$Proxy<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Method CGLIB$equals$<span class="token number">2</span>$Method<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> MethodProxy CGLIB$equals$<span class="token number">2</span>$Proxy<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Method CGLIB$toString$<span class="token number">3</span>$Method<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> MethodProxy CGLIB$toString$<span class="token number">3</span>$Proxy<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Method CGLIB$hashCode$<span class="token number">4</span>$Method<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> MethodProxy CGLIB$hashCode$<span class="token number">4</span>$Proxy<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Method CGLIB$clone$<span class="token number">5</span>$Method<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> MethodProxy CGLIB$clone$<span class="token number">5</span>$Proxy<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> CGLIB$<span class="token function">STATICHOOK1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        CGLIB$THREAD_CALLBACKS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CGLIB$emptyArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Class <span class="token class-name">var0</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"cn.test.Animal$$EnhancerByCGLIB$$e01ba0a1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Class <span class="token class-name">var1</span><span class="token punctuation">;</span>
        CGLIB$run$<span class="token number">0</span>$Method <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">findMethods</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>var1 <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"cn.test.Animal"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        CGLIB$run$<span class="token number">0</span>$Proxy <span class="token operator">=</span> MethodProxy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var0<span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"CGLIB$run$0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Method<span class="token punctuation">[</span><span class="token punctuation">]</span> var10000 <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">findMethods</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"finalize"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token string">"equals"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/Object;)Z"</span><span class="token punctuation">,</span> <span class="token string">"toString"</span><span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token string">"hashCode"</span><span class="token punctuation">,</span> <span class="token string">"()I"</span><span class="token punctuation">,</span> <span class="token string">"clone"</span><span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/Object;"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>var1 <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CGLIB$finalize$<span class="token number">1</span>$Method <span class="token operator">=</span> var10000<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        CGLIB$finalize$<span class="token number">1</span>$Proxy <span class="token operator">=</span> MethodProxy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var0<span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token string">"finalize"</span><span class="token punctuation">,</span> <span class="token string">"CGLIB$finalize$1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CGLIB$equals$<span class="token number">2</span>$Method <span class="token operator">=</span> var10000<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        CGLIB$equals$<span class="token number">2</span>$Proxy <span class="token operator">=</span> MethodProxy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var0<span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/Object;)Z"</span><span class="token punctuation">,</span> <span class="token string">"equals"</span><span class="token punctuation">,</span> <span class="token string">"CGLIB$equals$2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CGLIB$toString$<span class="token number">3</span>$Method <span class="token operator">=</span> var10000<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        CGLIB$toString$<span class="token number">3</span>$Proxy <span class="token operator">=</span> MethodProxy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var0<span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token string">"toString"</span><span class="token punctuation">,</span> <span class="token string">"CGLIB$toString$3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CGLIB$hashCode$<span class="token number">4</span>$Method <span class="token operator">=</span> var10000<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        CGLIB$hashCode$<span class="token number">4</span>$Proxy <span class="token operator">=</span> MethodProxy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var0<span class="token punctuation">,</span> <span class="token string">"()I"</span><span class="token punctuation">,</span> <span class="token string">"hashCode"</span><span class="token punctuation">,</span> <span class="token string">"CGLIB$hashCode$4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CGLIB$clone$<span class="token number">5</span>$Method <span class="token operator">=</span> var10000<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        CGLIB$clone$<span class="token number">5</span>$Proxy <span class="token operator">=</span> MethodProxy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var0<span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/Object;"</span><span class="token punctuation">,</span> <span class="token string">"clone"</span><span class="token punctuation">,</span> <span class="token string">"CGLIB$clone$5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">void</span> CGLIB$run$<span class="token function">0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        MethodInterceptor var10000 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>CGLIB$CALLBACK_0<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>var10000 <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            CGLIB$<span class="token function">BIND_CALLBACKS</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            var10000 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>CGLIB$CALLBACK_0<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>var10000 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            var10000<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CGLIB$run$<span class="token number">0</span>$Method<span class="token punctuation">,</span> CGLIB$emptyArgs<span class="token punctuation">,</span> CGLIB$run$<span class="token number">0</span>$Proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从反编译后的源码来看，可以看到被代理类的方法会生成两个代理方法，一个是跟我Animal种run方法同名的run方法，另一个是<code>CGLIB$run$0()</code>。</p> 
<p>1.<code>CGLIB$run$0()</code>是调用被代理的方法，可以看到别的啥都没干。</p> 
<p>2.同名的**<code>run()</code>** 首先判断有没有设置callback，我们在代码中设置为CglibProxy，所以就会调用CglibProxy的**<code>intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy)</code>**方法</p> 
<p>下面再看一下**<code>MethodProxy</code>**的源码，invoke和invokeSuper的具体执行流程。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MethodProxy<span class="token punctuation">.</span>FastClassInfo fci <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fastClassInfo<span class="token punctuation">;</span>
        <span class="token keyword">return</span> fci<span class="token punctuation">.</span>f1<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>fci<span class="token punctuation">.</span>i1<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> var4<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fastClassInfo<span class="token punctuation">.</span>i1 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Protected method: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sig1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> var5<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> Object <span class="token function">invokeSuper</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MethodProxy<span class="token punctuation">.</span>FastClassInfo fci <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fastClassInfo<span class="token punctuation">;</span>
        <span class="token keyword">return</span> fci<span class="token punctuation">.</span>f2<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>fci<span class="token punctuation">.</span>i2<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> var4<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>invoke和invokeSuper第一步都会执行**<code>init()</code>**这个方法</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fastClassInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>initLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fastClassInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                MethodProxy<span class="token punctuation">.</span>CreateInfo ci <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>createInfo<span class="token punctuation">;</span>
                MethodProxy<span class="token punctuation">.</span>FastClassInfo fci <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodProxy<span class="token punctuation">.</span>FastClassInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fci<span class="token punctuation">.</span>f1 <span class="token operator">=</span> <span class="token function">helper</span><span class="token punctuation">(</span>ci<span class="token punctuation">,</span> ci<span class="token punctuation">.</span>c1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fci<span class="token punctuation">.</span>f2 <span class="token operator">=</span> <span class="token function">helper</span><span class="token punctuation">(</span>ci<span class="token punctuation">,</span> ci<span class="token punctuation">.</span>c2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fci<span class="token punctuation">.</span>i1 <span class="token operator">=</span> fci<span class="token punctuation">.</span>f1<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sig1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fci<span class="token punctuation">.</span>i2 <span class="token operator">=</span> fci<span class="token punctuation">.</span>f2<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sig2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fastClassInfo <span class="token operator">=</span> fci<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>createInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个init方法就是加载**<code>MethodProxy.FastClassInfo</code>**。</p> 
<p><strong><code>c1</code></strong> 指的是我们的代理类，即**<code>Animal</code>**</p> 
<p><strong><code>c2</code></strong> 代理类，即**<code>Animal$$EnhancerByCGLIB$$e01ba0a1.class</code>**</p> 
<p><strong><code>f1</code></strong> 代理类，即**<code>Animal$$FastClassByCGLIB$$b2e76df5.class</code>**</p> 
<p><strong><code>f2</code></strong> 代理类，即**<code>Animal$$EnhancerByCGLIB$$e01ba0a1$$FastClassByCGLIB$$9a34f4cc.class</code>**</p> 
<p>上述三个class文件即**<code>E:\\classes</code>**这个路径下（当然还有你的包路径）生成出来的三个class文件</p> 
<p><strong><code>i1</code></strong> 即**<code>run()</code>**</p> 
<p><strong><code>i2</code></strong> 即**<code>CGLIB$run$0()</code>**</p> 
<p>为什么会生成f1和f2这两个代理类，这里就涉及到invoke和invokeSuper两个方法的区别，invoke就是f1.invoke()，invokeSuper就是f2.invoke()。</p> 
<p>这也就解释了为什么会发生死循环了，我们用的是invoke()方法，但是传入的是一个代理对象，从上面的代理类的代码可以看到还是会回到invoke()这个方法，所以就造成了死循环。</p> 
<h5><a id="373__499"></a>3.7.3 总结</h5> 
<p>cglib代理比jdk代理快很多，但是被代理的类和方法不能被final修改，而且有invoke和invokeSuper这两个方法，使用的时候需要谨慎。</p> 
<p>× <s><strong><code>Object obj = methodProxy.invoke(o, objects);</code></strong></s><br> √ <strong><code>Object obj = methodProxy.invoke(this.target, objects);</code></strong><br> √ <strong><code>Object obj = methodProxy.invokeSuper(o, objects);</code></strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f06951ba6f278b043c13b536a11bd96c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决Error:svn: E155037: Previous operation has not finished； run ‘cleanup‘ if it was interrupted</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2626285bbd44d3f68f35271d25fc4ba8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">运行mapreduce  物理内存不够问题：</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>