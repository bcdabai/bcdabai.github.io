<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Java实现登录验证码的功能 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Java实现登录验证码的功能" />
<meta property="og:description" content="今天给项目换了一个登录页面，而这个登录页面设计了验证码，于是想着把这个验证码功能实现一下。
这篇文章就如何实现登录时的验证码的验证功能结合代码进行详细地介绍，以及介绍功能实现的思路，文章不是一次写成的，中间考虑可能出现的问题，最后给出了一个比较稳定的版本。
目录
一、页面效果
二、实现思路
三、具体代码实现
1、准备工作
创建项目
添加依赖
修改配置
2、功能实现
后端代码
CaptchaController.java
UserLoginDTO.java
UserController.java
UserService.java
UserServiceImpl.java
前端代码
login.html
login.js
一、页面效果 登录的时候会把用户名、密码和验证码一起传到后端，并对验证码进行验证，只有验证码正确才能登录。
二、实现思路 那么，具体是如何实现的呢，首先大概介绍一下我实现这个功能的思路：
验证码图片的url由后端的一个Controller生成，前端请求这个Controller接口的时候根据当前时间生成一个uuid，并把这个uuid在前端使用localStorage缓存起来，下一次还是从缓存中获取。Controller生成验证码之后，把前端传过来的uuid通过redis缓存起来，这里分两次缓存 缓存uuid以uuid为key，缓存验证码这样，当点击登录按钮将数据提交到后台登录接口时，会从redis中获取uuid，然后通过这个uuid去获取验证码，和前端用户输入的验证码进行比较。 潜在问题：这样的设计可能会导致以下问题
多个用户同一时间访问登录页面，导致生成的uuid一样，数据会互相覆盖；uuid这个key被其他用户修改； 改进方案
前端生成随机的uuid，并缓存到localStorage，登陆的时候也把这个uuid传到后端，这样就解决了key重复和key被覆盖的问题。 三、具体代码实现 1、准备工作 创建项目 为了保存代码，在idea中新建一个springboot项目
创建好的项目目录结构
添加依赖 删除多余的文件及文件夹（可选），在pom.xml中添加必要的依赖~
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;project xmlns=&#34;http://maven.apache.org/POM/4.0.0&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xsi:schemaLocation=&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.5.9&lt;/version&gt; &lt;relativePath /&gt; &lt;/parent&gt; &lt;groupId&gt;cn.edu.sgu.www&lt;/groupId&gt; &lt;artifactId&gt;login-captcha&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;login-captcha&lt;/name&gt; &lt;description&gt;Java实现登录验证码功能&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!--validation--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/36e22eb37e643661add1f9955dbb7928/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T14:09:58+08:00" />
<meta property="article:modified_time" content="2024-01-04T14:09:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java实现登录验证码的功能</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p>今天给项目换了一个登录页面，而这个登录页面设计了验证码，于是想着把这个验证码功能实现一下。</p> 
 <p></p> 
 <p>这篇文章就如何实现登录时的验证码的验证功能结合代码进行详细地介绍，以及介绍功能实现的思路，文章不是一次写成的，中间考虑可能出现的问题，最后给出了一个比较稳定的版本。</p> 
</blockquote> 
<p></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="%E9%A1%B5%E9%9D%A2%E6%95%88%E6%9E%9C-toc" style="margin-left:0px;"><a href="#%E9%A1%B5%E9%9D%A2%E6%95%88%E6%9E%9C" rel="nofollow">一、页面效果</a></p> 
<p id="%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-toc" style="margin-left:0px;"><a href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" rel="nofollow">二、实现思路</a></p> 
<p id="%E4%B8%89%E3%80%81%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" rel="nofollow">三、具体代码实现</a></p> 
<p id="1%E3%80%81%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-toc" style="margin-left:40px;"><a href="#1%E3%80%81%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" rel="nofollow">1、准备工作</a></p> 
<p id="%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE-toc" style="margin-left:80px;"><a href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE" rel="nofollow">创建项目</a></p> 
<p id="%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-toc" style="margin-left:80px;"><a href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96" rel="nofollow">添加依赖</a></p> 
<p id="%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE-toc" style="margin-left:80px;"><a href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE" rel="nofollow">修改配置</a></p> 
<p id="2%E3%80%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0-toc" style="margin-left:40px;"><a href="#2%E3%80%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0" rel="nofollow">2、功能实现</a></p> 
<p id="%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81-toc" style="margin-left:80px;"><a href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81" rel="nofollow">后端代码</a></p> 
<p id="CaptchaController.java-toc" style="margin-left:120px;"><a href="#CaptchaController.java" rel="nofollow">CaptchaController.java</a></p> 
<p id="UserLoginDTO.java-toc" style="margin-left:120px;"><a href="#UserLoginDTO.java" rel="nofollow">UserLoginDTO.java</a></p> 
<p id="UserController.java-toc" style="margin-left:120px;"><a href="#UserController.java" rel="nofollow">UserController.java</a></p> 
<p id="UserService.java-toc" style="margin-left:120px;"><a href="#UserService.java" rel="nofollow">UserService.java</a></p> 
<p id="UserServiceImpl.java-toc" style="margin-left:120px;"><a href="#UserServiceImpl.java" rel="nofollow">UserServiceImpl.java</a></p> 
<p id="%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E4%BB%A3%E7%A0%81-toc" style="margin-left:80px;"><a href="#%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E4%BB%A3%E7%A0%81" rel="nofollow">前端代码</a></p> 
<p id="login.html-toc" style="margin-left:120px;"><a href="#login.html" rel="nofollow">login.html</a></p> 
<p id="login.js-toc" style="margin-left:120px;"><a href="#login.js" rel="nofollow">login.js</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%E9%A1%B5%E9%9D%A2%E6%95%88%E6%9E%9C" style="background-color:transparent;">一、页面效果</h2> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/b8/37/ahTHwwMi_o.png" width="1200"></p> 
<p>登录的时候会把用户名、密码和验证码一起传到后端，并对验证码进行验证，只有验证码正确才能登录。</p> 
<p></p> 
<h2 id="%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">二、实现思路</h2> 
<p>那么，具体是如何实现的呢，首先大概介绍一下我实现这个功能的思路：</p> 
<ul><li>验证码图片的url由后端的一个Controller生成，前端请求这个Controller接口的时候根据当前时间生成一个uuid，并把这个uuid在前端使用localStorage缓存起来，下一次还是从缓存中获取。</li><li>Controller生成验证码之后，把前端传过来的uuid通过redis缓存起来，这里分两次缓存 
  <ul><li>缓存uuid</li><li>以uuid为key，缓存验证码</li></ul></li><li>这样，当点击登录按钮将数据提交到后台登录接口时，会从redis中获取uuid，然后通过这个uuid去获取验证码，和前端用户输入的验证码进行比较。</li></ul> 
<p id="%E6%BD%9C%E5%9C%A8%E9%97%AE%E9%A2%98">潜在问题：这样的设计可能会导致以下问题</p> 
<ul><li>多个用户同一时间访问登录页面，导致生成的uuid一样，数据会互相覆盖；</li><li>uuid这个key被其他用户修改；</li></ul> 
<p id="%E6%94%B9%E8%BF%9B%E6%96%B9%E6%A1%88">改进方案</p> 
<ul><li>前端生成随机的uuid，并缓存到localStorage，登陆的时候也把这个uuid传到后端，这样就解决了key重复和key被覆盖的问题。</li></ul> 
<p></p> 
<h2 id="%E4%B8%89%E3%80%81%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">三、具体代码实现</h2> 
<h3 id="1%E3%80%81%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">1、准备工作</h3> 
<h4 id="%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE">创建项目</h4> 
<p>为了保存代码，在idea中新建一个springboot项目</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/02/c9/TvneKEfM_o.png" width="1200"></p> 
<p>创建好的项目目录结构</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/b5/c1/hl8av2d9_o.png" width="1200"></p> 
<p></p> 
<h4 id="%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96">添加依赖</h4> 
<p>删除多余的文件及文件夹（可选），在pom.xml中添加必要的依赖~</p> 
<pre><code class="language-XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.5.9&lt;/version&gt;
        &lt;relativePath /&gt;
    &lt;/parent&gt;

    &lt;groupId&gt;cn.edu.sgu.www&lt;/groupId&gt;
    &lt;artifactId&gt;login-captcha&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;login-captcha&lt;/name&gt;
    &lt;description&gt;Java实现登录验证码功能&lt;/description&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!--validation--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!--redis--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!--lombok--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;1.18.22&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!--生成验证码工具--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.whvcse&lt;/groupId&gt;
            &lt;artifactId&gt;easy-captcha&lt;/artifactId&gt;
            &lt;version&gt;1.6.2&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</code></pre> 
<p></p> 
<h4 id="%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE">修改配置</h4> 
<p>修改application.yml</p> 
<pre><code class="language-XML">server:
  port: 8888

logging:
  level:
    springfox: error
    cn.edu.sgu.www.logincaptcha: debug

spring:
  application:
    name: login-captcha
  redis:
    port: 6379
    host: localhost
    timeout: PT5s
    # password: mhxy1218

# 验证码图片设置
captcha:
  image:
    width: 66
    height: 22</code></pre> 
<p></p> 
<p>最后，把必要的一些基础类复制过来。</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/d9/71/LW7Ldic9_o.png" width="1200"></p> 
<p></p> 
<h3 id="2%E3%80%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0">2、功能实现</h3> 
<h4 id="%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81">后端代码</h4> 
<h5 id="CaptchaController.java">CaptchaController.java</h5> 
<p>给前端登录页面生成随机验证码的控制器类。</p> 
<pre><code class="language-java">package cn.edu.sgu.www.logincaptcha.controller;

import cn.edu.sgu.www.logincaptcha.consts.RedisKeyPrefixes;
import cn.edu.sgu.www.logincaptcha.exception.GlobalException;
import cn.edu.sgu.www.logincaptcha.property.CaptchaImageProperties;
import cn.edu.sgu.www.logincaptcha.redis.StringRedisUtils;
import cn.edu.sgu.www.logincaptcha.restful.ResponseCode;
import com.wf.captcha.GifCaptcha;
import com.wf.captcha.SpecCaptcha;
import com.wf.captcha.base.Captcha;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.context.request.RequestAttributes;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.concurrent.TimeUnit;

/**
 * @author heyunlin
 * @version 1.0
 */
@Slf4j
@RestController
@RequestMapping(value = "/captcha", produces = "application/json;charset=utf-8")
public class CaptchaController {

    private final StringRedisUtils stringRedisUtils;
    private final CaptchaImageProperties captchaImageProperties;

    @Autowired
    public CaptchaController(StringRedisUtils stringRedisUtils, CaptchaImageProperties captchaImageProperties) {
        this.stringRedisUtils = stringRedisUtils;
        this.captchaImageProperties = captchaImageProperties;
    }

    /**
     * 生成验证码
     * @param type 验证码图片类型
     * @param uuid 前端生成的uuid
     */
    @RequestMapping(value = "/generate", method = RequestMethod.GET)
    public void generate(@RequestParam String type, @RequestParam String uuid) throws IOException {
        Captcha captcha;
        Integer width = captchaImageProperties.getWidth();
        Integer height = captchaImageProperties.getHeight();

        switch (type) {
            case "png":
                captcha = new SpecCaptcha(width, height);
                break;
            case "gif":
                captcha = new GifCaptcha(width, height);
                break;
            default:
                throw new GlobalException(ResponseCode.BAD_REQUEST, "不合法的验证码类型：" + type);
        }

        captcha.setLen(4);
        captcha.setCharType(Captcha.TYPE_DEFAULT);

        String code = captcha.text();
        log.debug("生成的验证码：{}", code);

        // 根据uuid拼接前缀得到验证码的key
        String key = RedisKeyPrefixes.PREFIX_CAPTCHA + uuid;

        // 缓存验证码
        stringRedisUtils.set(key , code);
        // 设置验证码3分钟后过期
        stringRedisUtils.expire(key, 3, TimeUnit.MINUTES);

        // 获取HttpServletResponse对象
        HttpServletResponse response = getResponse();

        // 设置响应头
        response.setContentType("image/" + type);
        response.setDateHeader("Expires", 0);
        response.setHeader("Pragma", "No-cache");
        response.setHeader("Cache-Control", "no-cache");

        // 输出图片流
        captcha.out(response.getOutputStream());
    }

    /**
     * 获取HttpServletResponse对象
     * @return HttpServletResponse
     */
    private HttpServletResponse getResponse() {
        RequestAttributes attributes = RequestContextHolder.getRequestAttributes();

        if (attributes != null ) {
            HttpServletResponse response = ((ServletRequestAttributes) attributes).getResponse();

            if (response != null) {
                // 设置内容类型为json
                response.setContentType("application/json;charset=utf-8");

                return response;
            }
        }

        throw new GlobalException(ResponseCode.ERROR, "获取response对象失败");
    }

}</code></pre> 
<p></p> 
<h5 id="UserLoginDTO.java">UserLoginDTO.java</h5> 
<p>在项目根目录下创建dto包，然后新建一个UserLoginDTO.java来接受前端的数据。</p> 
<pre><code class="language-java">package cn.edu.sgu.www.logincaptcha.dto;

import lombok.Data;

import javax.validation.constraints.NotEmpty;
import java.io.Serializable;

/**
 * @author heyunlin
 * @version 1.0
 */
@Data
public class UserLoginDTO implements Serializable {
    private static final long serialVersionUID = 18L;

    /**
     * uuid：随机字符串
     */
    @NotEmpty(message = "验证码已过期，请重新获取")
    private String uuid;

    /**
     * 验证码
     */
    @NotEmpty(message = "验证码不允许为空")
    private String code;

    /**
     * 用户名
     */
    @NotEmpty(message = "用户名不允许为空")
    private String username;

    /**
     * 密码
     */
    @NotEmpty(message = "密码不允许为空")
    private String password;
}</code></pre> 
<p></p> 
<h5 id="UserController.java">UserController.java</h5> 
<pre><code class="language-java">package cn.edu.sgu.www.logincaptcha.controller;

import cn.edu.sgu.www.logincaptcha.dto.UserLoginDTO;
import cn.edu.sgu.www.logincaptcha.restful.JsonResult;
import cn.edu.sgu.www.logincaptcha.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

/**
 * @author heyunlin
 * @version 1.0
 */
@RestController
@RequestMapping(path = "/user", produces="application/json;charset=utf-8")
public class UserController {

    private final UserService userService;

    @Autowired
    public UserController(UserService userService) {
        this.userService = userService;
    }

    /**
     * 登录认证
     * @param loginDTO UserLoginDTO
     * @return JsonResult&lt;Void&gt;
     */
    @RequestMapping(value = "/login", method = RequestMethod.POST)
    public JsonResult&lt;Void&gt; login(@Validated UserLoginDTO loginDTO) {
        userService.login(loginDTO);

        return JsonResult.success();
    }

}</code></pre> 
<p></p> 
<h5 id="UserService.java">UserService.java</h5> 
<pre><code class="language-java">package cn.edu.sgu.www.logincaptcha.service;

import cn.edu.sgu.www.logincaptcha.dto.UserLoginDTO;

/**
 * @author heyunlin
 * @version 1.0
 */
public interface UserService {

    void login(UserLoginDTO loginDTO);
}</code></pre> 
<p></p> 
<h5 id="UserServiceImpl.java" style="background-color:transparent;">UserServiceImpl.java</h5> 
<pre><code class="language-java">package cn.edu.sgu.www.logincaptcha.service.impl;

import cn.edu.sgu.www.logincaptcha.consts.RedisKeyPrefixes;
import cn.edu.sgu.www.logincaptcha.dto.UserLoginDTO;
import cn.edu.sgu.www.logincaptcha.exception.GlobalException;
import cn.edu.sgu.www.logincaptcha.redis.StringRedisUtils;
import cn.edu.sgu.www.logincaptcha.restful.ResponseCode;
import cn.edu.sgu.www.logincaptcha.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 * @author heyunlin
 * @version 1.0
 */
@Service
public class UserServiceImpl implements UserService {

    private final StringRedisUtils stringRedisUtils;

    @Autowired
    public UserServiceImpl(StringRedisUtils stringRedisUtils) {
        this.stringRedisUtils = stringRedisUtils;
    }

    @Override
    public void login(UserLoginDTO loginDTO) {
        // 得到用户输入的验证码
        String code = loginDTO.getCode();

        // 获取正确的验证码
        String key = getCaptchaKey(loginDTO.getUuid());
        String realCode = stringRedisUtils.get(key);

        // 得到的验证码为空，则获取验证码到登录之间的时间已经过了3分钟，验证码过期已经被删除
        if (realCode == null) {
            throw new GlobalException(ResponseCode.BAD_REQUEST, "验证码已失效，请重新获取~");
        }
        // 验证码校验
        if (!code.equalsIgnoreCase(realCode)) {
            throw new GlobalException(ResponseCode.BAD_REQUEST, "验证码错误~");
        }

        /* 其它代码... */
    }

    /**
     * 拼接得到验证码的key
     * @param uuid 前端随机生成的uuid
     * @return String 验证码的key
     */
    private String getCaptchaKey(String uuid) {
        return RedisKeyPrefixes.PREFIX_CAPTCHA + uuid;
    }

}</code></pre> 
<p></p> 
<h4 id="%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E4%BB%A3%E7%A0%81">前端代码</h4> 
<h5 id="login.html">login.html</h5> 
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
        &lt;title&gt;登录页面&lt;/title&gt;
        &lt;link rel="stylesheet" href="/css/login.css"&gt;
        &lt;script src="/js/jquery.min.js"&gt;&lt;/script&gt;
        &lt;script src="/js/ajaxUtils.js"&gt;&lt;/script&gt;
        &lt;script src="/js/localStorage.js"&gt;&lt;/script&gt;
        &lt;script src="/js/login.js"&gt;&lt;/script&gt;
    &lt;/head&gt;

    &lt;body style="overflow:hidden"&gt;
        &lt;div class="pagewrap"&gt;
            &lt;div class="main"&gt;
                &lt;div class="header"&gt;&lt;/div&gt;

                &lt;div class="content"&gt;
                    &lt;div class="con_left"&gt;&lt;/div&gt;

                    &lt;div class="con_right"&gt;
                        &lt;div class="con_r_top"&gt;
                            &lt;a href="javascript:" class="left"&gt;下载游戏&lt;/a&gt;
                            &lt;a href="javascript:" class="right"&gt;登录管理&lt;/a&gt;
                        &lt;/div&gt;

                        &lt;ul&gt;
                            &lt;li class="con_r_left" style="display:none;"&gt;
                                &lt;div class="erweima"&gt;
                                    &lt;div class="qrcode"&gt;
                                        &lt;div id="output"&gt;
                                            &lt;img src="/images/mhxysy.png" /&gt;
                                        &lt;/div&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;

                                &lt;div style="height:70px;"&gt;
                                    &lt;p&gt;扫码下载梦幻西游手游&lt;/p&gt;
                                &lt;/div&gt;
                            &lt;/li&gt;


                            &lt;li class="con_r_right" style="display:block;"&gt;
                                &lt;div&gt;
                                    &lt;div class="user"&gt;
                                        &lt;div&gt;
                                            &lt;span class="user-icon"&gt;&lt;/span&gt;
                                            &lt;input type="text" id="username" /&gt;
                                        &lt;/div&gt;

                                        &lt;div&gt;
                                            &lt;span class="mima-icon"&gt;&lt;/span&gt;
                                            &lt;input type="password" id="password" /&gt;
                                        &lt;/div&gt;

                                        &lt;div&gt;
                                            &lt;span class="yzmz-icon"&gt;&lt;/span&gt;
                                            &lt;input type="text" id="code" /&gt;　　

                                            &lt;img id="captcha" alt="看不清？点击更换" /&gt;
                                        &lt;/div&gt;
                                    &lt;/div&gt;

                                    &lt;br&gt;

                                    &lt;button id="btn_Login" type="button"&gt;登 录&lt;/button&gt;
                                &lt;/div&gt;
                            &lt;/li&gt;
                        &lt;/ul&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre> 
<p></p> 
<h5 id="login.js">login.js</h5> 
<pre><code class="language-javascript">/**
 * 禁止输入空格
 */
function preventSpace() {
	let event = window.event;
	
	if(event.keyCode === 32) {
		event.returnValue = false;
	}
}

/**
 * 生成随机字符串
 * @param length 字符串的长度，默认11
 * @returns {string}
 */
function generateRandomString(length = 11) {
	let charset = "abcdefghijklmnopqrstuvwxyz-_ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
	let values = new Uint32Array(length);

	window.crypto.getRandomValues(values);

	let str = "";

	for (let i = 0; i &lt; length; i++) {
		str += charset[values[i] % charset.length];
	}

	return str;
}

/**
 * 登录
 */
function login() {
	let username = $("#username").val();
    let password = $("#password").val();
    let code = $("#code").val();

	if (!username) {
		alert("请输入用户名！");
		
		$("#username").focus();
	} else if (!password) {
		alert("请输入密码！");
		
		$("#password").focus();
	} else if (!code) {
		alert("请输入验证码！");
	} else {
		ajaxPost("/user/login", {
			username: username,
			password: password,
			code: code,
			uuid: getStorage("uuid")
		}, function() {
			location.href = "/index.html";
		}, function (res) {
			if (res &amp;&amp; res.responseJSON) {
				let response = res.responseJSON;

				if (res.status &amp;&amp; res.status === 404) {
					let message;

					if(response.path) {
						message = "路径" + response.path + "不存在。";
					} else {
						message = response.message;
					}

					alert(message);
				} else {
					alert(response.message);
				}
			} else {
				alert("请求无响应~");
			}
		});
	}
}

$(function() {
	$("#username").keydown(function() {
		preventSpace();
	}).attr("placeholder", "请输入用户名");

	$("#password").keydown(function() {
		preventSpace();
	}).attr("placeholder", "请输入密码");

	/**
	 * 给验证码输入框绑定回车登录事件
	 */
	$("#code").keydown(function() {
		let event = window.event;

		if(event.keyCode === 32) {
			event.returnValue = false;
		} else if(event.keyCode === 13) {
			login();
		}
	}).attr("placeholder", "验证码");

	/******************************************************************************************************/

	/*
	 * 验证码初始化
	 */
	// 从localStorage中获取uuid
	let uuid = getStorage("uuid");

	// uuid为空，则生成后保存到localStorage中
	if (!uuid) {
		// 生成uuid
		uuid = generateRandomString();

		// 保存uuid到localStorage
		storage("uuid", uuid);
	}

	let captcha_ = $("#captcha");

	// 设置验证码的图片路径
	captcha_.attr("src", "/captcha/generate?type=png&amp;uuid=" + uuid);
	// 设置验证码的title
	captcha_.attr("title", "看不清？换一张");

	// 点击验证码刷新
	captcha_.click(function () {
		// 生成uuid
		uuid = generateRandomString();

		// 保存uuid到localStorage
		storage("uuid", uuid);

		// 重新设置验证码图片的路径
		$("#captcha").attr("src", "/captcha/generate?v=" + new Date().getTime() + "&amp;type=png&amp;uuid=" + uuid);
	});

	/******************************************************************************************************/

	// 点击登录按钮
	$("#btn_Login").click(function () {
		login();
	});

	$(".content .con_right .left").on("click", function () {
		$(this).css({
			"color": "#333333",
			"border-bottom": "2px solid #2e558e"
		});
		$(".content .con_right .right").css({
			"color": "#999999",
			"border-bottom": "2px solid #dedede"
		});
		$(".content .con_right ul .con_r_left").css("display", "block");
		$(".content .con_right ul .con_r_right").css("display", "none");
	});

	$(".content .con_right .right").on("click", function () {
		$(this).css({
			"color": "#333333",
			"border-bottom": "2px solid #2e558e"
		});
		$(".content .con_right .left").css({
			"color": "#999999",
			"border-bottom": "2px solid #dedede"
		});
		$(".content .con_right ul .con_r_right").css("display", "block");
		$(".content .con_right ul .con_r_left").css("display", "none");
	});

});</code></pre> 
<p></p> 
<p>好了，这篇文章就分享到这里了，看完如果觉得对你有所帮助，不要忘了点赞+收藏哦~</p> 
<p>最新的代码已经保存到git仓库，可按需获取~</p> 
<p><a class="link-info has-card" href="https://gitee.com/he-yunlin/login-captcha.git" rel="nofollow" title="Java实现登录验证码功能"><span class="link-card-box"><span class="link-title">Java实现登录验证码功能</span><span class="link-link"><img class="link-link-icon" src="https://images2.imgbox.com/ec/41/euEUr5Jd_o.png" alt="icon-default.png?t=N7T8">https://gitee.com/he-yunlin/login-captcha.git</span></span></a></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/83647d5d0d235f4db2995e96eb90c927/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">逻辑控制使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/85c9b2d76c33b5b14b3b732a6cffabbc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CentOs搭建Kafka集群</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>