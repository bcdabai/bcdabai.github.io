<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL大表变更“字段/索引“可能会引发的锁表问题 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL大表变更“字段/索引“可能会引发的锁表问题" />
<meta property="og:description" content=" 参考：
亿级大表在线不锁表变更字段与索引_华为云官方博客-CSDN博客mysql该字段锁表_Mysql笔记（七）~ 大表加字段不锁表方案_weixin_39871162的博客-CSDN博客 声明：加索引可以不锁表，MySQL 5.6 以上的新特性，可参考：MySQL 5.6版本新特性之Online DDL：在线变更表结构且不阻塞数据库服务
背景：
大家在日常工作中，往往需要对数据库的表结构做变更，一般涉及到增删字段，修改字段属性等ALTER的操作。然而，在大表场景下，特别是千万级、亿级的大表，如果处理不当，这些操作往往会引发锁表的巨大隐患，特别是在生产环境中，一旦在变更表结构过程中，出现了长时间锁表，会导致用户产生的数据长时间无法正常变更到表中，进而导致服务功能异常，结果将是灾难性的。
一般执行这种Alter类型的变更，我们可能有以下的想法：
停服，在停服期间做表结构的变更，自然就可以防止对用户产生影响。但是，很多场景是不允许停服的。而且如果表的数据量达到上亿，那么需要停服时间可能需要十几个小时，甚至更长，这是极不现实的；凌晨执行，在用户较少的时间段内，做变更，尽量减少对用户产生影响。但是如果出现锁表的话，万一有用户使用服务，服务将不可用；使用临时表，但是缺点是复制数据到新表期间，如果用户在这期间做了update或delete操作，且数据修改发生在之前已经复制完成的部分，那么将无法感知到这部分数据，导致丢失掉用户的操作数据，风险太大；使用存储过程分批更新，缺点是执行时间会很久，且有可能影响到用户的DDL操作。因为为了防止每次循环修改时，锁住太多数据行，我们需要控制每次更新数据的行数，粒度不能太大，否则很有可能会锁住用户正在操作的数据行。 具体操作步骤：
创建一个临时的新表，首先复制旧表的结构(包含索引)
create table new_table like old_table;
给新表加上新增的字段
把旧表的数据复制过来（需注意复制过程也需要时间，这时如果有已经复制完的数据又被用户修改后，可能会导致复制后的数据不能保持最新的。所以原表如果有记录了数据的写入时间字段就最好了（比如modify_time），可以找到执行这一步操作之后的数据，并重复导入到新表，直到数据差异很小。不过还是会可能损失极少量的数据。）
insert into new_table(filed1,filed2…) select filed1,filed2,… from old_table;
删除旧表，重命名新表的名字为旧表的名字
建议：
尽量选择请求流量小的时间执行执行时先看一下有没有未提交的事务，注意查看事物 information_schema.innodb_trx 表随时关注服务器日志状况，已有问题要先行解决后续可先在预发环境或测试环境先行模拟，评估风险 " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d8ad98b59e567889f02bbe345f665259/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-15T14:58:25+08:00" />
<meta property="article:modified_time" content="2022-12-15T14:58:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL大表变更“字段/索引“可能会引发的锁表问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>参考：</p> 
<ul><li><a href="https://huaweicloud.blog.csdn.net/article/details/112764359?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;utm_relevant_index=2" rel="nofollow" title="亿级大表在线不锁表变更字段与索引_华为云官方博客-CSDN博客">亿级大表在线不锁表变更字段与索引_华为云官方博客-CSDN博客</a></li><li><a href="https://blog.csdn.net/weixin_39871162/article/details/113135143?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1.no_search_link&amp;spm=1001.2101.3001.4242.2&amp;utm_relevant_index=4" title="mysql该字段锁表_Mysql笔记（七）~ 大表加字段不锁表方案_weixin_39871162的博客-CSDN博客">mysql该字段锁表_Mysql笔记（七）~ 大表加字段不锁表方案_weixin_39871162的博客-CSDN博客</a></li></ul> 
<p>声明：<strong>加索引可以不锁表，MySQL <span style="color:#fe2c24;">5.6 </span>以上的新特性</strong>，可参考：<a class="link-info" href="https://blog.csdn.net/qq_37102984/article/details/125693219?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167108740816782429791564%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=167108740816782429791564&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-125693219-null-null.nonecase&amp;utm_term=online%20ddl&amp;spm=1018.2226.3001.4450" title="MySQL 5.6版本新特性之Online DDL：在线变更表结构且不阻塞数据库服务">MySQL 5.6版本新特性之Online DDL：在线变更表结构且不阻塞数据库服务</a></p> 
<p><strong>背景：</strong></p> 
<p><strong>        </strong>大家在日常工作中，往往需要对数据库的表结构做变更，一般涉及到增删字段，修改字段属性等ALTER的操作。然而，在大表场景下，特别是千万级、亿级的大表，如果处理不当，这些操作往往会引发锁表的巨大隐患，特别是在生产环境中，一旦在变更表结构过程中，出现了长时间锁表，会导致用户产生的数据长时间无法正常变更到表中，进而导致服务功能异常，结果将是灾难性的。</p> 
<p>        一般执行这种Alter类型的变更，我们可能有以下的想法：</p> 
<ol><li><strong>停服</strong>，在停服期间做表结构的变更，自然就可以防止对用户产生影响。但是，很多场景是不允许停服的。而且如果表的数据量达到上亿，那么需要停服时间可能需要十几个小时，甚至更长，这是极不现实的；</li><li><strong>凌晨执行</strong>，在用户较少的时间段内，做变更，尽量减少对用户产生影响。但是如果出现锁表的话，万一有用户使用服务，服务将不可用；</li><li><span style="color:#fe2c24;"><strong>使用临时表</strong></span>，但是缺点是复制数据到新表期间，如果用户在这期间做了update或delete操作，且数据修改发生在之前已经复制完成的部分，那么将无法感知到这部分数据，导致丢失掉用户的操作数据，风险太大；</li><li><strong>使用存储过程分批更新</strong>，缺点是执行时间会很久，且有可能影响到用户的DDL操作。因为为了防止每次循环修改时，锁住太多数据行，我们需要控制每次更新数据的行数，粒度不能太大，否则很有可能会锁住用户正在操作的数据行。</li></ol> 
<p></p> 
<p><strong>具体操作步骤：</strong></p> 
<ol><li> <p>创建一个临时的新表，首先复制旧表的结构(包含索引)<br><span style="background-color:#fbd4d0;">create table new_table like old_table;</span></p> </li><li> <p>给新表加上新增的字段</p> </li><li> <p>把旧表的数据复制过来（<span style="color:#fe2c24;">需注意复制过程也需要时间，这时如果有已经复制完的数据又被用户修改后，可能会导致复制后的数据不能保持最新的。<strong>所以原表如果有记录了数据的写入时间字段就最好了（比如modify_time），可以找到执行这一步操作之后的数据，并重复导入到新表，直到数据差异很小</strong>。不过还是会可能损失极少量的数据</span>。）<br><span style="background-color:#fbd4d0;">insert into new_table(filed1,filed2…) select filed1,filed2,… from old_table;</span></p> </li><li> <p>删除旧表，重命名新表的名字为旧表的名字</p> </li></ol> 
<p><strong>建议：</strong></p> 
<ol><li>尽量选择请求流量小的时间执行</li><li>执行时先看一下有没有未提交的事务，注意查看事物 information_schema.innodb_trx 表</li><li>随时关注服务器日志状况，已有问题要先行解决</li><li>后续可先在预发环境或测试环境先行模拟，评估风险</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0d675090c118bef97009b5c39454944/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">组件化开发必备：Gradle 依赖切换源码的实践</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f3a100b68a8be915ca0f0492a16767c2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;课程设计】期末大作业 - 基于Qt开发的中国象棋软件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>