<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>生产环境Mysql导致CPU飙高的问题 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="生产环境Mysql导致CPU飙高的问题" />
<meta property="og:description" content="问题表现 生产出现ng经常502，后通过监控mysql服务器cpu飙高
出现CPU飙高时操作
出现cpu飙高时使用先试用top命令查看进程，确定是java进程还是mysql 找到进程号 &lt;pid&gt;
一、如果是mysql 1、那么使用mysql终端或者数据库链接工具执行如下sql语句查看正在执行的sql：show processlist
2、查询慢sql，截取慢sql文件前面10000行数据导出来分析
3、查询进行中的事务，SELECT * FROM information_schema.INNODB_TRX
二、如果是java进程 1、执行命令查看占用最高的线程&lt;tid&gt; ：top -H -p 2、把线程占用最高的id转换为16进制 &lt;tid16&gt; ：printf “0x%x\n” &lt;tid&gt;
3、打印线程堆栈 ：jstack &lt;pid&gt; &gt; /home/finance/jstack.log
4、打开jstack.log 找到步骤3中的十六进制线程号 进行分析 搜索:nid=&lt;tid16&gt; 找到线程名和代码位置
事后分析： 一、mysql
1、分析show processlist 结果中的info查看sql问题，首先使用explain查看执行计划效率，如果效率无问题，查看是否调用频繁比如循环中不停调用
2、分析慢sql使用explain查看执行计划，效率有问题优化sql、优化索引
3、是否有事务死锁，如果有查看原因
二、JAVA
jsatck.log定位到代码后直接分析代码
已确定mysql服务器cpu飙高：因此分析慢sql 数据量
cbcc_work_order：5022940
cbcc_market_call_list：1994558
cbcc_work_order_visble_org：9022940
在慢sql发现该sql频繁出现
select * left join sys_organization t1 on t1.ID=t0.ORG_ID left join sys_organization t2 on t0.RV_ORG_ID=t2.ID where t0.info_sources_code=&#39;13&#39; and t0.org_id=#{orgId} and t0.status=1 and t0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cd8490fcc6253930583c2867be48b793/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-19T10:48:29+08:00" />
<meta property="article:modified_time" content="2023-10-19T10:48:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">生产环境Mysql导致CPU飙高的问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>问题表现</h2> 
<p>生产出现ng经常502，后通过监控mysql服务器cpu飙高</p> 
<p>出现CPU飙高时操作<br> 出现cpu飙高时使用先试用top命令查看进程，确定是java进程还是mysql 找到进程号 &lt;pid&gt;</p> 
<h3><a id="mysql_8"></a>一、如果是mysql</h3> 
<p>1、那么使用mysql终端或者数据库链接工具执行如下sql语句查看正在执行的sql：show processlist<br> 2、查询慢sql，截取慢sql文件前面10000行数据导出来分析<br> 3、查询进行中的事务，SELECT * FROM information_schema.INNODB_TRX</p> 
<h3><a id="java_12"></a>二、如果是java进程</h3> 
<p>1、执行命令查看占用最高的线程&lt;tid&gt; ：top -H -p <br> 2、把线程占用最高的id转换为16进制 &lt;tid16&gt; ：printf “0x%x\n” &lt;tid&gt;<br> 3、打印线程堆栈 ：jstack &lt;pid&gt; &gt; /home/finance/jstack.log<br> 4、打开jstack.log 找到步骤3中的十六进制线程号 进行分析 搜索:nid=&lt;tid16&gt; 找到线程名和代码位置</p> 
<h2><a id="_17"></a>事后分析：</h2> 
<p>一、mysql<br> 1、分析show processlist 结果中的info查看sql问题，首先使用explain查看执行计划效率，如果效率无问题，查看是否调用频繁比如循环中不停调用<br> 2、分析慢sql使用explain查看执行计划，效率有问题优化sql、优化索引<br> 3、是否有事务死锁，如果有查看原因<br> 二、JAVA<br> jsatck.log定位到代码后直接分析代码</p> 
<h2><a id="mysqlcpusql_24"></a>已确定mysql服务器cpu飙高：因此分析慢sql</h2> 
<p>数据量<br> cbcc_work_order：5022940<br> cbcc_market_call_list：1994558<br> cbcc_work_order_visble_org：9022940</p> 
<blockquote> 
 <p>在慢sql发现该sql频繁出现</p> 
</blockquote> 
<pre><code class="prism language-SQL">select *
        left join sys_organization t1 on t1.ID=t0.ORG_ID
        left join sys_organization t2 on t0.RV_ORG_ID=t2.ID
        where t0.info_sources_code='13' and t0.org_id=#{orgId} and t0.status=1 and t0.dept_code=1 and t0.deleted=0 and t0.create_time &gt;= '2020-01-01 00:00:00'
</code></pre> 
<blockquote> 
 <p><strong>原因为其中info_sources_code为int内容导致索引失效 ，并且前端轮训调用此接口，几乎3秒调用一次，因此使用用户上涨时，mysql cpu马上就上来了</strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>解决方案很简单，上述sql中info_sources_code='13’改为 info_sources_code=13即可</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/443b2fe1d4f9e9d5f0044dab03a4a1a1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">二叉树递归遍历</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7c4d29c618f08335c6a7ed9a90380538/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CPU飙高解决思路</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>