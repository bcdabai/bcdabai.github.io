<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mixtral 8X7B MoE模型基于阿里云人工智能平台PAI实践合集 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mixtral 8X7B MoE模型基于阿里云人工智能平台PAI实践合集" />
<meta property="og:description" content="作者：熊兮、贺弘、临在
Mixtral 8x7B大模型是Mixtral AI推出的基于decoder-only架构的稀疏专家混合网络（Mixture-Of-Experts，MOE）开源大语言模型。这一模型具有46.7B的总参数量，对于每个token，路由器网络选择八组专家网络中的两组进行处理，并且将其输出累加组合，在增加模型参数总量的同时，优化了模型推理的成本。在大多数基准测试中，Mixtral 8x7B模型与Llama2 70B和GPT-3.5表现相当，因此具有很高的使用性价比。
阿里云人工智能平台PAI是面向开发者和企业的机器学习/深度学习平台，提供包含数据标注、模型构建、模型训练、模型部署、推理优化在内的AI开发全链路服务。
本文介绍如何在PAI平台针对Mixtral 8x7B大模型的微调和推理服务的最佳实践，助力AI开发者快速开箱。以下我们将分别展示具体使用步骤。
使用PAI-DSW轻量化微调Mixtral 8x7B MOE大模型 PAI-DSW是云端机器学习开发IDE，为用户提供交互式编程环境，同时提供了丰富的计算资源。我们在智码实验室（智码实验室）Notebook Gallery中上线了两个微调Mixtral 8x7B MOE大模型的示例，参见下图：
上述Notebook可以使用阿里云PAI-DSW的实例打开，并且需要选择对应的计算资源和镜像。
使用Swift轻量化微调Mixtral 8x7B MOE大模型 Swift是魔搭ModelScope开源社区推出的轻量级训练推理工具开源库，使用Swift进行这一大模型LoRA轻量化微调需要使用2张GU108（80G）及以上资源。在安装完对应依赖后，我们首先下载模型至本地：
!apt-get update !echo y | apt-get install aria2 def aria2(url, filename, d): !aria2c --console-log-level=error -c -x 16 -s 16 {url} -o {filename} -d {d} mixtral_url = &#34;http://pai-vision-data-inner-wulanchabu.oss-cn-wulanchabu-internal.aliyuncs.com/mixtral/Mixtral-8x7B-Instruct-v0.1.tar&#34; aria2(mixtral_url, mixtral_url.split(&#34;/&#34;)[-1], &#34;/root/&#34;) !cd /root &amp;&amp; mkdir -p AI-ModelScope !cd /root &amp;&amp; tar -xf Mixtral-8x7B-Instruct-v0.1.tar -C /root/AI-ModelScope import os os.environ[&#39;MODELSCOPE_CACHE&#39;]=&#39;/root&#39; 当模型下载完毕后，我们使用Swift一键拉起训练任务：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9771aa14cef35c5e7aade0ce7ede7c0b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-12T10:54:36+08:00" />
<meta property="article:modified_time" content="2024-01-12T10:54:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mixtral 8X7B MoE模型基于阿里云人工智能平台PAI实践合集</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="u3b9a1598">作者：熊兮、贺弘、临在</p> 
<p id="uc6913e9b">Mixtral 8x7B大模型是Mixtral AI推出的基于decoder-only架构的稀疏专家混合网络（Mixture-Of-Experts，MOE）开源大语言模型。这一模型具有46.7B的总参数量，对于每个token，路由器网络选择八组专家网络中的两组进行处理，并且将其输出累加组合，在增加模型参数总量的同时，优化了模型推理的成本。在大多数基准测试中，Mixtral 8x7B模型与Llama2 70B和GPT-3.5表现相当，因此具有很高的使用性价比。</p> 
<p id="ua777db24">阿里云人工智能平台PAI是面向开发者和企业的机器学习/深度学习平台，提供包含数据标注、模型构建、模型训练、模型部署、推理优化在内的AI开发全链路服务。</p> 
<p id="u934c8a8c">本文介绍如何在PAI平台针对Mixtral 8x7B大模型的微调和推理服务的最佳实践，助力AI开发者快速开箱。以下我们将分别展示具体使用步骤。</p> 
<h2 id="gdve1">使用PAI-DSW轻量化微调Mixtral 8x7B MOE大模型</h2> 
<p id="u0762fcbe">PAI-DSW是云端机器学习开发IDE，为用户提供交互式编程环境，同时提供了丰富的计算资源。我们在智码实验室（<a href="https://gallery.pai-ml.com/" rel="nofollow" title="智码实验室">智码实验室</a>）Notebook Gallery中上线了两个微调Mixtral 8x7B MOE大模型的示例，参见下图：</p> 
<p class="img-center"><img alt="" height="1200" id="u8a1751dc" src="https://images2.imgbox.com/6f/bd/nwFohJNu_o.png" width="1200"></p> 
<p id="u7391ad44">上述Notebook可以使用阿里云PAI-DSW的实例打开，并且需要选择对应的计算资源和镜像。</p> 
<h3 id="xSwZj">使用Swift轻量化微调Mixtral 8x7B MOE大模型</h3> 
<p id="u33806361">Swift是魔搭ModelScope开源社区推出的轻量级训练推理工具开源库，使用Swift进行这一大模型LoRA轻量化微调需要使用2张GU108（80G）及以上资源。在安装完对应依赖后，我们首先下载模型至本地：</p> 
<pre id="aMgNy"><code>!apt-get update
!echo y | apt-get install aria2

def aria2(url, filename, d):
    !aria2c --console-log-level=error -c -x 16 -s 16 {url} -o {filename} -d {d}

mixtral_url = "http://pai-vision-data-inner-wulanchabu.oss-cn-wulanchabu-internal.aliyuncs.com/mixtral/Mixtral-8x7B-Instruct-v0.1.tar"
aria2(mixtral_url, mixtral_url.split("/")[-1], "/root/")
!cd /root &amp;&amp; mkdir -p AI-ModelScope 
!cd /root &amp;&amp; tar -xf Mixtral-8x7B-Instruct-v0.1.tar -C /root/AI-ModelScope

import os
os.environ['MODELSCOPE_CACHE']='/root'</code></pre> 
<p id="u7c89dd03">当模型下载完毕后，我们使用Swift一键拉起训练任务：</p> 
<pre id="sBrFz"><code>!cd swift/examples/pytorch/llm &amp;&amp; PYTHONPATH=../../.. \
CUDA_VISIBLE_DEVICES=0,1 \
python llm_sft.py \
    --model_id_or_path AI-ModelScope/Mixtral-8x7B-Instruct-v0.1 \
    --model_revision master \
    --sft_type lora \
    --tuner_backend swift \
    --dtype AUTO \
    --output_dir /root/output \
    --ddp_backend nccl \
    --dataset alpaca-zh \
    --train_dataset_sample 100 \
    --num_train_epochs 2 \
    --max_length 2048 \
    --check_dataset_strategy warning \
    --lora_rank 8 \
    --lora_alpha 32 \
    --lora_dropout_p 0.05 \
    --lora_target_modules ALL \
    --batch_size 1 \
    --weight_decay 0.01 \
    --learning_rate 1e-4 \
    --gradient_accumulation_steps 16 \
    --max_grad_norm 0.5 \
    --warmup_ratio 0.03 \
 	--eval_steps 300 \
    --save_steps 300 \
    --save_total_limit 2 \
    --logging_steps 10 \
    --only_save_model true \
    --gradient_checkpointing false</code></pre> 
<p id="ub7c2c5d6">模型训练完成后，我们将学习到的LoRA权重合并到模型Checkpoint中：</p> 
<pre id="HRSeq"><code>!swift merge-lora --ckpt_dir '/root/output/mistral-7b-moe-instruct/v3-20231215-111107/checkpoint-12'</code></pre> 
<p id="u770a91a0">其中，ckpt_dir参数的值需要替换成模型LoRA权重保存路径。为了测试模型训练的正确性，我们可以使用transformers库进行离线推理测试：</p> 
<pre id="Ejc58"><code>from transformers import AutoModelForCausalLM, AutoTokenizer

model_id = "/root/output/mistral-7b-moe-instruct/v3-20231215-111107/checkpoint-12-merged"
tokenizer = AutoTokenizer.from_pretrained(model_id, device_map='auto')

model = AutoModelForCausalLM.from_pretrained(model_id, device_map='auto')

text = """[INST] &lt;&lt;SYS&gt;&gt;
You are a helpful, respectful and honest assistant. Always answer as helpfully as possible, while being safe. Your answers should not include any harmful, unethical, racist, sexist, toxic, dangerous, or illegal content. Please ensure that your responses are socially unbiased and positive in nature.

If a question does not make any sense, or is not factually coherent, explain why instead of answering something not correct. If you don't know the answer to a question, please don't share false information.
&lt;&lt;/SYS&gt;&gt;

写一首歌的过程从开始到结束。 [/INST]"""
inputs = tokenizer(text, return_tensors="pt")

outputs = model.generate(**inputs, max_new_tokens=512)
print(tokenizer.decode(outputs[0], skip_special_tokens=True))</code></pre> 
<h3 id="ji1ij">使用Deepspeed轻量化微调Mixtral 8x7B MOE大模型</h3> 
<p id="u2aeeaa44">我们也可以使用Deepspeed对Mixtral 8x7B MOE大模型进行LoRA轻量化微调。同样的，我们需要使用2张GU108（80G）及以上资源。我们首先下载模型至本地：</p> 
<pre id="JSUzd"><code>!apt-get update
!echo y | apt-get install aria2

def aria2(url, filename, d):
    !aria2c --console-log-level=error -c -x 16 -s 16 {url} -o {filename} -d {d}

mixtral_url = "http://pai-vision-data-inner-wulanchabu.oss-cn-wulanchabu-internal.aliyuncs.com/mixtral/Mixtral-8x7B-Instruct-v0.1.tar"
aria2(mixtral_url, mixtral_url.split("/")[-1], "/root/")
!cd /root &amp;&amp; tar -xf Mixtral-8x7B-Instruct-v0.1.tar</code></pre> 
<p id="ufe41a1ca">第二步，我们下载一个示例古诗生成数据集，用户可以根据下述数据格式准备自己的数据集。</p> 
<pre id="b67wD"><code>!wget -c https://pai-quickstart-predeploy-hangzhou.oss-cn-hangzhou.aliyuncs.com/huggingface/datasets/llm_instruct/en_poetry_train_mixtral.json
!wget -c https://pai-quickstart-predeploy-hangzhou.oss-cn-hangzhou.aliyuncs.com/huggingface/datasets/llm_instruct/en_poetry_test_mixtral.json</code></pre> 
<p id="ub79a33fc">第三步，我们可以修改示例命令的超参数，并且拉起训练任务。</p> 
<pre id="jJORZ"><code>!mkdir -p /root/output
!deepspeed /ml/code/train_sft.py \
--model_name_or_path /root/Mixtral-8x7B-Instruct-v0.1/ \
--train_path en_poetry_train_mixtral.json \
--valid_path en_poetry_test_mixtral.json \
--learning_rate 1e-5 \
--lora_dim 32 \
--max_seq_len 256 \
--model mixtral \
--num_train_epochs 1 \
--per_device_train_batch_size 8 \
--zero_stage 3 \
--gradient_checkpointing \
--print_loss \
--deepspeed \
--output_dir /root/output/ \
--offload</code></pre> 
<p id="ud0e8030f">当训练结束后，我们拷贝额外配置文件至输出文件夹：</p> 
<pre id="gLzK4"><code>!cp /root/Mixtral-8x7B-Instruct-v0.1/generation_config.json /root/output
!cp /root/Mixtral-8x7B-Instruct-v0.1/special_tokens_map.json /root/output
!cp /root/Mixtral-8x7B-Instruct-v0.1/tokenizer.json /root/output
!cp /root/Mixtral-8x7B-Instruct-v0.1/tokenizer.model /root/output
!cp /root/Mixtral-8x7B-Instruct-v0.1/tokenizer_config.json /root/output</code></pre> 
<p id="u3779a94b">我们同样可以使用transformers库进行离线推理测试：</p> 
<pre id="g0BHU"><code>import os
from transformers import AutoModelForCausalLM, AutoTokenizer
import torch

model_id = "/root/output/"
tokenizer = AutoTokenizer.from_pretrained(model_id)

model = AutoModelForCausalLM.from_pretrained(model_id,device_map='auto',torch_dtype=torch.float16)

text = """[INST] Write a poem on a topic 'Care for Thy Soul as Thing of Greatest Price': [/INST]"""
inputs = tokenizer(text, return_tensors="pt").to('cuda')

outputs = model.generate(**inputs, max_new_tokens=20)
print(tokenizer.decode(outputs[0], skip_special_tokens=True))</code></pre> 
<p id="u50b06187">如果用户需要将上述模型部署为EAS服务，需要将格式转换成safetensors格式：</p> 
<pre id="yfbQ0"><code>state_dict = model.state_dict()
model.save_pretrained(
    model_id,
    state_dict=state_dict,
    safe_serialization=True)</code></pre> 
<h2 id="wyS4t">使用PAI-EAS在线部署Mixtral 8x7B MOE大模型</h2> 
<p id="u1f6f00ec">PAI-EAS是PAI平台推出的弹性推理服务，可以将各种大模型部署为在线服务。当Mixtral 8x7B MOE大模型微调完毕后，我们可以将其部署为PAI-EAS服务。这里，我们介绍使用PAI-SDK将上述模型进行部署。首先，我们在PAI-DSW环境安装PAI-SDK：</p> 
<pre id="bEr2h"><code>!python -m pip install alipai --upgrade</code></pre> 
<p id="uf700fa01">在安装完成后，在在命令行终端上执行以下命令，按照引导完成配置AccessKey、PAI工作空间以及 OSS Bucket：</p> 
<pre id="f5E5K"><code>python -m pai.toolkit.config</code></pre> 
<p id="u6321c00b">我们将训练好的模型上传至OSS Bucket。在下述命令中，source_path为模型Checkpoint保存的本地路径，oss_path为上传至OSS的目标路径：</p> 
<pre id="cvvxT"><code>import pai
from pai.session import get_default_session
from pai.common.oss_utils import upload

print(pai.__version__)
sess = get_default_session()

# 上传模型到默认的Bucket
model_uri = upload(
    source_path="/root/output", 
    oss_path="mixtral-7b-moe-instruct-sft-ds"
)

print(model_uri)</code></pre> 
<p id="u431cbe8a">PAI 提供了Mixtral 8X7B MOE 模型部署镜像和部署代码，用户可以通过相应的部署配置，将微调后的模型部署到PAI-EAS。</p> 
<pre id="iZnze"><code>from pai.model import RegisteredModel
from pai.predictor import Predictor

# 获取PAI提供的Mixtral模型服务配置（目前仅支持乌兰察布）
inference_spec = RegisteredModel(
    "Mixtral-8x7B-Instruct-v0.1",
    model_provider="pai",
).inference_spec

# 修改部署配置，使用微调后的模型
infer_spec.mount(model_uri, model_path="/ml/model")


# 部署推理服务服务
m = Model(inference_spec=infer_spec)

predictor: Predictor = m.deploy(
    service_name = 'mixtral_sdk_example_ds',
    options={
		"metadata.quota_id": "&lt;ResourceGroupQuotaId&gt;",
        "metadata.quota_type": "Lingjun",
        "metadata.workspace_id": session.workspace_id
    }
)

# 查看服务的Endpoint和Token
endpoint = predictor.internet_endpoint
token = predictor.access_token

</code></pre> 
<p id="u5e82cf87">以上配置项中，<code>metadata.quota_id</code>是用户购买的灵骏资源配额ID，在购买了灵骏资源之后，用户可以从PAI控制台页面的资源配额入口获取相应的信息。</p> 
<p id="ud1fe0c2b">部署的推理服务支持 OpenAI 的 API 风格进行调用，通过推理服务的详情页，用户可以获得服务访问地址（Endpoint）和访问凭证（Token）。使用 cURL 调用推理服务的示例如下：</p> 
<pre id="BQH9W"><code># 请注意替换为使用服务的Endpoint和Token
export API_ENDPOINT="&lt;ENDPOINT&gt;"
export API_TOKEN="&lt;TOKEN&gt;"

# 查看模型list
curl $API_ENDPOINT/v1/models \
	-H "Content-Type: application/json" \
	-H "Authorization: Bearer $API_TOKEN"

# 调用通用的文本生成API
curl $API_ENDPOINT/v1/completions \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $API_TOKEN" \
    -d '{
			"model": "Mixtral-8x7B-Instruct-v0.1",
			"prompt": "San Francisco is a",
			"max_tokens": 256,
			"temperature": 0
	}'

curl $API_ENDPOINT/v1/chat/completions \
    -H "Authorization: Bearer $API_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{
			"model": "Mixtral-8x7B-Instruct-v0.1",
      "messages": [
          {"role": "user", "content": "介绍一下上海的历史"}
        ]
      }'</code></pre> 
<h2 id="shYnb">使用PAI-QuickStart微调和部署Mixtral 8x7B MOE大模型</h2> 
<p id="ua0e9b936">快速开始（PAI-QuickStart）集成了国内外AI开源社区中优质的预训练模型，支持零代码或是SDK的方式实现微调和部署Mixtral 8x7B MOE大模型，用户只需要格式准备训练集和验证集，填写训练时候使用的超参数就可以一键拉起训练任务。Mixtral的模型卡片如下图所示：</p> 
<p id="ud4f94aa0"></p> 
<p class="img-center"><img alt="" height="1200" id="SNZLX" src="https://images2.imgbox.com/98/b8/p0J8JIUB_o.png" width="1200"></p> 
<p id="u960a6792">我们可以根据实际需求上传训练集和验证集，调整超参数，例如learning_rate、sequence_length、train_iters等，如下所示：</p> 
<p id="ue9173c92"></p> 
<p class="img-center"><img alt="" height="1200" id="u03a50991" src="https://images2.imgbox.com/de/e7/kqYkwolW_o.png" width="1200"></p> 
<p id="u9ea15705">点击“训练”按钮，PAI-QuickStart开始进行训练，用户可以查看训练任务状态和训练日志，如下所示：</p> 
<p id="u3fe60ee4"></p> 
<p class="img-center"><img alt="" height="1034" id="u9dcc2afd" src="https://images2.imgbox.com/1c/10/YE45LKJn_o.png" width="1200"></p> 
<p id="u92f13df4">如果需要将模型部署至PAI-EAS，可以在同一页面的模型部署卡面选择资源组，并且点击“部署”按钮实现一键部署。模型调用方式和上文PAI-EAS调用方式相同。</p> 
<p id="u5170b854"></p> 
<p class="img-center"><img alt="" height="1096" id="u1d8fed8a" src="https://images2.imgbox.com/75/52/6wSRpf21_o.png" width="1200"></p> 
<p id="uab3ac112"></p> 
<p id="ubc78d454"></p> 
<h2 id="vHF9w">相关资料</h2> 
<p id="u32f3dd07">阿里云人工智能平台PAI：</p> 
<p id="ue997005b"><a href="https://www.aliyun.com/product/bigdata/learn" rel="nofollow" title="人工智能平台 PAI_机器学习建模训练部署_智能推荐_人工智能-阿里云">人工智能平台 PAI_机器学习建模训练部署_智能推荐_人工智能-阿里云</a></p> 
<p id="u90f9bc40">交互式建模PAI-DSW：</p> 
<p id="u66876e2a"><a href="https://www.aliyun.com/activity/bigdata/pai/dsw" rel="nofollow" title="PAI_DSW_人工智能_深度学习_算法开发_Notebook_可视建模_开发环境_阿里云">PAI_DSW_人工智能_深度学习_算法开发_Notebook_可视建模_开发环境_阿里云</a></p> 
<p id="u36522601">模型在线服务PAI-EAS：</p> 
<p id="u51f83a11"><a href="https://www.aliyun.com/product/bigdata/learn/eas" rel="nofollow" title="模型在线服务PAI-EAS_人工智能平台PAI_在线推理服务_大数据-阿里云">模型在线服务PAI-EAS_人工智能平台PAI_在线推理服务_大数据-阿里云</a></p> 
<p id="udade61eb">PAI 快速开始：</p> 
<p id="ud684e373"><a href="https://help.aliyun.com/zh/pai/user-guide/quick-start-overview" rel="nofollow" title="PAI快速开始功能的介绍/计费/权限/开通/使用_人工智能平台 PAI(PAI)-阿里云帮助中心">PAI快速开始功能的介绍/计费/权限/开通/使用_人工智能平台 PAI(PAI)-阿里云帮助中心</a></p> 
<p id="ua3192b71">PAI Python SDK:</p> 
<p id="u5c91721c"><a href="https://github.com/aliyun/pai-python-sdk" title="GitHub - aliyun/pai-python-sdk: A HighLevel Python SDK helps you to train and deploy your model on PAI.">GitHub - aliyun/pai-python-sdk: A HighLevel Python SDK helps you to train and deploy your model on PAI.</a></p> 
<p id="u947e8fbf">阿里云PAI灵骏智算服务：</p> 
<p id="u12bb8508"><a href="https://www.aliyun.com/product/bigdata/learn/pailingjun" rel="nofollow" title="智算服务PAI-灵骏_AI算力_机器学习PAI_大数据-阿里云">智算服务PAI-灵骏_AI算力_机器学习PAI_大数据-阿里云</a></p> 
<p id="u094d87b1"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e73bbdbe0a94d2d7fea3faadc7a0829f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MapReduce Shuffle机制</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9a58e7ae5adbc31b28965106f8bb4e01/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【开源】基于JAVA&#43;Vue&#43;SpringBoot的校园电商物流云平台</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>