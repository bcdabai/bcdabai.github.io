<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于nginx的tomcat负载均衡和集群(超简单) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于nginx的tomcat负载均衡和集群(超简单)" />
<meta property="og:description" content="今天看到&#34;基于apache的tomcat负载均衡和集群配置 &#34;这篇文章成为javaEye热点。
略看了一下，感觉太复杂，要配置的东西太多，因此在这里写出一种更简洁的方法。
要集群tomcat主要是解决SESSION共享的问题，因此我利用memcached来保存session，多台TOMCAT服务器即可共享SESSION了。
你可以自己写tomcat的扩展来保存SESSION到memcached。
这里推荐使用memcached-session-manager这个开源项目（http://code.google.com/p/memcached-session-manager/ ），下面简称msm。
如何安装nginx、memcached、tomcat这些就不多说了。
先说明一下测试环境:
tomcat1、nginx、memcached安装在192.168.1.11
tomcat2安装在192.168.1.101
下面分步实现基于nginx的tomcat负载均衡和集群配置
一，tomcat集群
1，先下载msm及其依赖包
http://memcached-session-manager.googlecode.com/files/memcached-session-manager-1.3.0.jar
http://memcached-session-manager.googlecode.com/files/msm-javolution-serializer-jodatime-1.3.0.jar
http://memcached-session-manager.googlecode.com/files/msm-javolution-serializer-cglib-1.3.0.jar
http://spymemcached.googlecode.com/files/memcached-2.4.2.jar
http://memcached-session-manager.googlecode.com/files/javolution-5.4.3.1.jar
2，将这5个包放到$TOMCAT_HOME/lib目录下
3，修改$TOMCAT_HOME/conf/server.xml
&lt;Context docBase=&#34;E:/java_codes/TestSession/WebContent&#34; path=&#34;&#34; reloadable=&#34;true&#34; &gt; &lt;Manager className=&#34;de.javakaffee.web.msm.MemcachedBackupSessionManager&#34; memcachedNodes=&#34;n1:localhost:11211&#34; requestUriIgnorePattern=&#34;.*\.(png|gif|jpg|css|js)$&#34; sessionBackupAsync=&#34;false&#34; sessionBackupTimeout=&#34;100&#34; transcoderFactoryClass=&#34;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&#34; copyCollectionsForSerialization=&#34;false&#34; /&gt; &lt;/Context&gt; 这里的memcachedNodes是填写memcached节点,多个节点时可以以空隔分开，如:
n1:localhost:11211 n2:localhost:11212
sessionBackupTimeout的单位为分钟
E:/java_codes/TestSession/WebContent 替换成你的WEB目录
修改后重启两个TOMCAT即可,这个时候已经解决SESSION的共享问题.
二，配置nginx实现负载均衡
以我的nginx.conf为例
#user nobody; worker_processes 1; error_log logs/error.log; events { worker_connections 1024; } http { include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; #gzip on; upstream www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/258ba6bf01c0d92e2a871e4e0a6064e1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-11T09:56:22+08:00" />
<meta property="article:modified_time" content="2023-09-11T09:56:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于nginx的tomcat负载均衡和集群(超简单)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">今天看到"<strong>基于apache的tomcat负载均衡和集群配置 </strong>"这篇文章成为javaEye热点。</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">略看了一下，感觉太复杂，要配置的东西太多，因此在这里写出一种更简洁的方法。</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">要集群tomcat主要是解决SESSION共享的问题，因此我利用memcached来保存session，多台TOMCAT服务器即可共享SESSION了。</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">你可以自己写tomcat的扩展来保存SESSION到memcached。</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">这里推荐使用memcached-session-manager这个开源项目（<a href="http://code.google.com/p/memcached-session-manager/" rel="nofollow" title="http://code.google.com/p/memcached-session-manager/">http://code.google.com/p/memcached-session-manager/</a> ），下面简称msm。</span></span></p> 
<p style="margin-left:auto;"></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">如何安装nginx、memcached、tomcat这些就不多说了。</span></span></p> 
<p style="margin-left:auto;"></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">先说明一下测试环境:</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">tomcat1、nginx、memcached安装在192.168.1.11</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">tomcat2安装在192.168.1.101</span></span></p> 
<p style="margin-left:auto;"></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">下面分步实现基于nginx的tomcat负载均衡和集群配置</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"><strong>一，tomcat集群</strong></span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">    1，先下载msm及其依赖包</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">    <a href="http://memcached-session-manager.googlecode.com/files/memcached-session-manager-1.3.0.jar" rel="nofollow" title="http://memcached-session-manager.googlecode.com/files/memcached-session-manager-1.3.0.jar">http://memcached-session-manager.googlecode.com/files/memcached-session-manager-1.3.0.jar</a></span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">    <a href="http://memcached-session-manager.googlecode.com/files/msm-javolution-serializer-jodatime-1.3.0.jar" rel="nofollow" title="http://memcached-session-manager.googlecode.com/files/msm-javolution-serializer-jodatime-1.3.0.jar">http://memcached-session-manager.googlecode.com/files/msm-javolution-serializer-jodatime-1.3.0.jar</a></span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"><a href="http://memcached-session-manager.googlecode.com/files/msm-javolution-serializer-cglib-1.3.0.jar" rel="nofollow" title="http://memcached-session-manager.googlecode.com/files/msm-javolution-serializer-cglib-1.3.0.jar">http://memcached-session-manager.googlecode.com/files/msm-javolution-serializer-cglib-1.3.0.jar</a></span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"><a href="http://spymemcached.googlecode.com/files/memcached-2.4.2.jar" rel="nofollow" title="http://spymemcached.googlecode.com/files/memcached-2.4.2.jar">http://spymemcached.googlecode.com/files/memcached-2.4.2.jar</a></span></span></p> 
<p style="margin-left:auto;"></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"><a href="http://memcached-session-manager.googlecode.com/files/javolution-5.4.3.1.jar" rel="nofollow" title="http://memcached-session-manager.googlecode.com/files/javolution-5.4.3.1.jar">http://memcached-session-manager.googlecode.com/files/javolution-5.4.3.1.jar</a></span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">2，将这5个包放到$TOMCAT_HOME/lib目录下</span></span></p> 
<p style="margin-left:auto;"></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">3<a name="Update_server.xml">，修改$TOMCAT_HOME/conf/server.xml</a></span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<div style="margin-left:0;"> 
 <ol style="margin-left:45px;"><li> <pre><code class="hljs">&lt;Context docBase="E:/java_codes/TestSession/WebContent" path="" reloadable="true" &gt;  
&lt;Manager className="de.javakaffee.web.msm.MemcachedBackupSessionManager"  
    memcachedNodes="n1:localhost:11211"  
    requestUriIgnorePattern=".*\.(png|gif|jpg|css|js)$"  
    sessionBackupAsync="false"  
    sessionBackupTimeout="100"  
    transcoderFactoryClass="de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory"  
    copyCollectionsForSerialization="false"  
    /&gt;  
&lt;/Context&gt; </code></pre> <span style="background-color:#ffffff;"> </span></li><li></ol> 
</div> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> 这里的memcachedNodes是填写memcached节点,多个节点时可以以空隔分开，如:</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> n1:localhost:11211 n2:localhost:11212</span></span></p> 
<p style="margin-left:auto;"></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> sessionBackupTimeout的单位为分钟</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> <span style="color:#ff00ff;">E:/java_codes/TestSession/WebContent</span> 替换成你的WEB目录</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">  修改后重启两个TOMCAT即可,这个时候已经解决SESSION的共享问题.</span></span></p> 
<p style="margin-left:auto;"></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"><strong>二，配置nginx实现负载均衡</strong></span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">   以我的nginx.conf为例</span></span></p> 
<div style="margin-left:0;"> 
 <ol style="margin-left:45px;"><li> <pre><code class="hljs">#user  nobody;   
worker_processes  1;   
  
error_log  logs/error.log;   
  
events {   
    worker_connections  1024;   
}   
  
  
http {   
    include       mime.types;   
    default_type  application/octet-stream;   
  
    sendfile        on;   
    keepalive_timeout  65;   
  
    #gzip  on;   
    upstream  www.docyeah.com   {   
              server   192.168.1.11:8080;   
              server   192.168.1.101:8080;   
    }   
    server {   
        listen       80;   
        server_name  www.docyeah.com;   
        charset utf-8;   
        location / {   
            root   html;   
            index  index.html index.htm;   
            proxy_pass        http://www.docyeah.com;   
            proxy_set_header  X-Real-IP  $remote_addr;   
            client_max_body_size  100m;   
        }   
  
  
        location ~ ^/(WEB-INF)/ {    
        deny all;    
        }    
  
        error_page   500 502 503 504  /50x.html;   
        location = /50x.html {   
            root   html;   
        }   
  
    }   
}  </code></pre> <p></p> </li></ol> 
</div> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">将www.docyeah.com替换成你的域名</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">192.168.1.11和192.168.1.101替换成你服务器的IP</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">OK，已经完成。启动nginx即可。</span></span></p> 
<p style="margin-left:auto;"></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">这是我采用的负载均衡及集群方案，希望大家拍砖.</span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;"> </span></span></p> 
<p style="margin-left:auto;"><span style="color:#333333;"><span style="background-color:#ffffff;">补充：nginx在配置upstream时，有两个参数：<br> ip_hash（同一IP一直使用同一台server服务）<br> weight（server的使用权重，数值越大，nginx分发的请求越多）<br><br> 通过配合这两个参数，能粗糙地解决session共享的问题。<br> 对于一些不是太依赖session的应用，或者只有用户登录时保存，那么我认为可以用Cookies代替。<br> 即使真的要Session共享，我认为手动写代码保存到Memcached比为Tomcat加插件好，这样能获得更好的可控性。</span></span></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1260960c8665ddbae0b646c33c593473/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">浅入 Docker</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/719ae5b2ebea9a2e9192cf8dda9c9cab/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python（Web时代）—— Django的模板</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>