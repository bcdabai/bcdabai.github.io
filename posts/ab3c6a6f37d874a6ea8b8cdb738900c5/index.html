<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>北京讯为电子RK3568开发板Android11系统移植笔记 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="北京讯为电子RK3568开发板Android11系统移植笔记" />
<meta property="og:description" content="以进程的视角来看Android系统
Android源码获取途径 从谷歌网站获取Android源码
从芯片原厂获取Android源码
从方案厂商获取
优势：
从谷歌网站获取Android源码可以第一时间研究最新的技术，但是移植到具体的芯片上很难
从芯片原厂获取Android源码可以很容易得运行在某一个硬件上，但是更新较慢
AOSP下载 AOSP：Android Open-Source Project，中文为安卓开源项目。
repo工具下载 谷歌利用repo对所有git仓库进行管理，并且让用户通过repo工具批量下载Android源码，所以我们下载Android源码之前必须先安装repo工具。
Android官网repo介绍和安装方法
电脑硬件要求 内存：不少于16GB
存储：不少于300GB
Ubuntu版本：Ubuntu18.04
安装git 执行以下命令
sudo apt-get install git 设置git 执行如下命令，填写名字和邮箱。
git config --global user.name “” git config --global user.email “” git config --list 下载repo git clone https://gerrit-googlesource.lug.ustc.edu.cn/git-repo 注意这里有可能会因为网络问题下载不成功，如果不能访问，可以换中科大的下载源。也会给大家提供一个下载好的。
配置repo mkdir .repo //创建的是一个隐藏文件夹，我们使用命令“ll”查看。 mv git-repo .repo/repo //将git-repo移动到刚刚创建的.repo文件中，并将名称改为repo cp .repo/repo/repo ./ //将repo复制到当前目录。 chmod u&#43;x repo //修改repo操作权限。 下载源代码 官方下载教程
确定需要的安装版本的名称
用的是Android11，对应的版本标记可以在Android官网上找到
https://source.android.google.cn/docs/setup/about/build-numbers?hl=zh-cn%3F
这里我们选择android-security-11.0.0_r54,并记下这个标记会在下载的时候使用到。
AOSP源码可以清华和中科大的源中去下载：
中科大" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ab3c6a6f37d874a6ea8b8cdb738900c5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-20T18:11:10+08:00" />
<meta property="article:modified_time" content="2023-11-20T18:11:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">北京讯为电子RK3568开发板Android11系统移植笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/3a/0f/8GsF3pUv_o.png" alt="Android分层架构图"></p> 
<p>以进程的视角来看Android系统<br> <img src="https://images2.imgbox.com/2b/c6/d44fl2iy_o.png" alt="Android系统启动架构图"></p> 
<h2><a id="Android_5"></a>Android源码获取途径</h2> 
<ol><li> <p>从谷歌网站获取Android源码</p> </li><li> <p>从芯片原厂获取Android源码</p> </li><li> <p>从方案厂商获取</p> </li></ol> 
<p>优势：</p> 
<ol><li> <p>从谷歌网站获取Android源码可以第一时间研究最新的技术，但是移植到具体的芯片上很难</p> </li><li> <p>从芯片原厂获取Android源码可以很容易得运行在某一个硬件上，但是更新较慢</p> </li></ol> 
<h2><a id="AOSP_18"></a>AOSP下载</h2> 
<p>AOSP：Android Open-Source Project，中文为安卓开源项目。</p> 
<h3><a id="repo_22"></a>repo工具下载</h3> 
<p>谷歌利用repo对所有git仓库进行管理，并且让用户通过repo工具批量下载Android源码，所以我们下载Android源码之前必须先安装repo工具。</p> 
<p><a href="https://source.android.google.cn/source/downloading?hl=zh-cn" rel="nofollow">Android官网repo介绍和安装方法</a></p> 
<h3><a id="_27"></a>电脑硬件要求</h3> 
<p>内存：不少于16GB</p> 
<p>存储：不少于300GB</p> 
<p>Ubuntu版本：Ubuntu18.04</p> 
<h3><a id="git_35"></a>安装git</h3> 
<p>执行以下命令</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">git</span>  
</code></pre> 
<h3><a id="git_42"></a>设置git</h3> 
<p>执行如下命令，填写名字和邮箱。</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.name “”

<span class="token function">git</span> config <span class="token parameter variable">--global</span> user.email “”

<span class="token function">git</span> config <span class="token parameter variable">--list</span>
</code></pre> 
<h3><a id="repo_53"></a>下载repo</h3> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://gerrit-googlesource.lug.ustc.edu.cn/git-repo 
</code></pre> 
<p>注意这里有可能会因为网络问题下载不成功，如果不能访问，可以换中科大的下载源。也会给大家提供一个下载好的。</p> 
<h3><a id="repo_59"></a>配置repo</h3> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span>  .repo //创建的是一个隐藏文件夹，我们使用命令“ll”查看。
<span class="token function">mv</span> git-repo .repo/repo  //将git-repo移动到刚刚创建的.repo文件中，并将名称改为repo
<span class="token function">cp</span> .repo/repo/repo ./   //将repo复制到当前目录。
<span class="token function">chmod</span> u+x repo   //修改repo操作权限。
</code></pre> 
<h3><a id="_67"></a>下载源代码</h3> 
<p><a href="https://source.android.google.cn/docs/setup/build/downloading?hl=zh-cn" rel="nofollow">官方下载教程</a></p> 
<p>确定需要的安装版本的名称</p> 
<p>用的是Android11，对应的版本标记可以在Android官网上找到</p> 
<p>https://source.android.google.cn/docs/setup/about/build-numbers?hl=zh-cn%3F</p> 
<p>这里我们选择android-security-11.0.0_r54,并记下这个标记会在下载的时候使用到。</p> 
<p>AOSP源码可以清华和中科大的源中去下载：</p> 
<p><a href="https://mirrors.ustc.edu.cn/aosp/" rel="nofollow">中科大</a></p> 
<p><a href="https://mirrors.tuna.tsinghua.edu.cn/" rel="nofollow">清华</a></p> 
<p>在repo所在路径下输入以下命令来下载源码</p> 
<pre><code class="prism language-shell">./repo-init <span class="token parameter variable">-u</span> git://mirrors.ustc.edu.cn/aosp/platform/mainfest <span class="token parameter variable">-b</span> android-security-11.0.0_r54
</code></pre> 
<p>接着在repo所在路径输入命令，下载源码</p> 
<pre><code class="prism language-shell">./repo <span class="token function">sync</span> <span class="token parameter variable">-j2</span>
</code></pre> 
<h3><a id="AOSP_100"></a>编译谷歌AOSP源码环境准备</h3> 
<p>需要使用apt命令安装以下依赖包：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> git-core gnupg flex bison build-essential <span class="token function">zip</span> <span class="token function">curl</span> zlib1g-dev g++-multilib g++-,ultilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc <span class="token function">unzip</span> fontconfig
</code></pre> 
<p>JDK</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openjdk-8-jdk
</code></pre> 
<h2><a id="Android_115"></a>编译Android源码步骤（通用）</h2> 
<h3><a id="1_117"></a>步骤1：初始化编译环境</h3> 
<pre><code class="prism language-shell"><span class="token builtin class-name">source</span> build/envsetup.sh  //建立编译环境，提供编译所需要的命令<span class="token punctuation">(</span>只对当前终端有效<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_123"></a>步骤2：选择对应产品</h3> 
<pre><code class="prism language-shell">lunch   
</code></pre> 
<p><img src="https://images2.imgbox.com/9c/85/OeFDOJu1_o.png" alt="选择哪些产品"><br> 在虚拟机ubuntu中跑，所以选择aosp_x86_64-eng(或者31)<br> 前半部分是编译生成目标产品信息，后半部分是编译源码的主机信息<br> <img src="https://images2.imgbox.com/6a/85/5UmV31Fj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_133"></a>步骤3：编译</h3> 
<p><img src="https://images2.imgbox.com/1f/6e/Uy9LnFJI_o.png" alt="在这里插入图片描述"><br> 编译</p> 
<pre><code class="prism language-powershell">make <span class="token operator">-</span>j12
</code></pre> 
<h2><a id="Android_140"></a>用模拟器启动编译好的Android镜像</h2> 
<p>注意：</p> 
<ol><li>VMware ubuntu18.04开启虚拟化引擎<br> <img src="https://images2.imgbox.com/39/3a/5u63jx8G_o.png" alt="在这里插入图片描述"></li></ol> 
<p>2.shell终端切换到超级用户root</p> 
<p>进入编译好的路径<br> <img src="https://images2.imgbox.com/e3/cf/CskNEtAD_o.png" alt="在这里插入图片描述"><code>source build/envsetup.sh //建立编译环境，提供编译所需要的命令 lunch //选择编译产品aosp_x86_64-eng(或者31) emulator //启动模拟器 (+verbose 可查看更多调试信息) |grep kernel（查kernel关键词）</code><br> <img src="https://images2.imgbox.com/5e/1d/EoirQVVr_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>out/host/linux-x86/bin    <span class="token operator">/</span><span class="token operator">/</span>存放相关命令
<span class="token punctuation">.</span><span class="token operator">/</span>adb shell    <span class="token operator">/</span><span class="token operator">/</span>adb调试
</code></pre> 
<h2><a id="Android11BSP_159"></a>从一级目录入手来认识瑞芯微Android11原厂BSP</h2> 
<p><img src="https://images2.imgbox.com/60/b2/INLkWvbN_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/e6/f3/N6KcjOCe_o.png" alt="比较安卓源码和瑞芯微RK3568开发板源码"></p> 
<ul><li>Android.bp 从Android7开始来替代.mk文件，soong会使用Android.bp(类似make与makefile)</li><li>art 和dalvik Android运行环境相关（Android5.0以前用dalvik，5.0之后用art）</li><li>bionic Android系统C库 专门为移动计算而设计的一个文件夹<br> <img src="https://images2.imgbox.com/da/de/1U3vsabp_o.png" alt="在这里插入图片描述"></li><li>bootable 和引导程序相关</li><li>build 编译规则</li><li>build.sh 编译rk3568脚本</li><li>compatibility Android兼容相关代码</li><li>cts 兼容性测试相关</li><li>developers 应用程序开发相关</li><li>device 和硬件相关（重点关注）</li><li>external 开源模组相关文件（重点关注）</li><li>frameworks 应用程序框架（重点关注）</li><li>hardware 硬件抽象层相关代码</li><li>kernel linux内核源码和底层驱动（重点关注）</li><li>libcore Android核心库相关</li><li>libnativehelper 动态库相关</li><li>out 编译之后生成镜像的文件夹（重点关注）</li><li>package 应用程序相关文件夹</li><li>pdk 本地开发套件</li><li>platform-testing 测试相关</li><li>prebuilts 资源文件相关比如编译器</li><li>sdk SDK</li><li>system 底层文件</li><li>test 测试相关</li><li>toolchain 编译链</li><li>tools 工具相关</li><li>u-boot uboot</li><li>vendor 厂商定制相关</li></ul> 
<p>瑞芯微厂商添加的</p> 
<ul><li>rknin</li><li>RKDocs</li><li>rkst</li><li>RKTools</li></ul> 
<h2><a id="RK3568Android_197"></a>RK3568原厂Android源码编译</h2> 
<p><img src="https://images2.imgbox.com/54/76/lc7usDi8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5a/bd/zlFhbWgH_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_201"></a>代码编译</h3> 
<p>一键编译命令</p> 
<p>各个平台编译命令汇总</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">.</span><span class="token operator">/</span>build<span class="token punctuation">.</span>sh <span class="token operator">-</span>UKAup 
（ WHERE: <span class="token operator">-</span>U = build uboot 
<span class="token operator">-</span>C = build kernel with Clang 
<span class="token operator">-</span>K = build kernel 
<span class="token operator">-</span>A = build android 
<span class="token operator">-</span>p = will build packaging in IMAGE 
<span class="token operator">-</span>o = build OTA package 
<span class="token operator">-</span>u = build update<span class="token punctuation">.</span>img 
<span class="token operator">-</span>v = build android with <span class="token string">'user'</span> or <span class="token string">'userdebug'</span> 
<span class="token operator">-</span>d = huild kernel dts name 
<span class="token operator">-</span>V = build version 
<span class="token operator">-</span>J = build jobs 
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>大家可以按需使用，不用记录uboot/kernel编译命令了<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> ）
============================================================ 
请注意使用一键编译命令之前需要设置环境变量，选择好自己需要编译的平台，举例：
source build/envsetup<span class="token punctuation">.</span>sh 
lunch rk3568_r-userdebug 
============================================================
</code></pre> 
<p><img src="https://images2.imgbox.com/fc/54/DV25sM60_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/93/55/bYMvtl6y_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/48/bb/OUXJJarO_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e7/4b/p93asjpL_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/44/69/viuubL8C_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="uboot_232"></a>原厂uboot源码顶层目录讲解</h2> 
<p>Android下uboot移植</p> 
<p>uboot-&gt;kernel-&gt;rootfs<br> <img src="https://images2.imgbox.com/f5/29/BPqxuJNM_o.png" alt="在这里插入图片描述"></p> 
<ul><li>api 独立的API，给外部APP调用的，跟硬件的关系不大</li><li>arch cpu架构相关代码<br> 这里我们看ARM架构，mach-xxx 分别是不同的公司的CPU，（cpu，dts,include,lib都是ARM架构处理器通用文件夹）<br> <img src="https://images2.imgbox.com/e8/f3/4vJ1cfuY_o.png" alt="在这里插入图片描述"></li><li>board 开发板相关代码（我们可以添加自己开发板的代码）</li><li>cmd 支持shell命令</li><li>common uboot通用文件（对硬件依赖性不是那么强）</li><li>configs 编译uboot所用的配置文件</li><li>disk 分区相关的数据结构</li><li>doc Documentation 这两个文件夹放的是官方的文档</li><li>drivers 驱动程序相关</li><li>dts 编译好的设备树文件</li><li>env 环境变量相关文件</li><li>.example 示例相关代码</li><li>fit 打包格式相关</li><li>config.mk,Kbuild,Kconfig,Makefile,PREUPLOAD.cfg, README,snapshot.commit 和编译相关</li><li>fs 表示uboot支持哪些文件系统</li><li>include 头文件</li><li>lib 库文件</li><li>Licenses 许可</li><li>make.sh 瑞芯微自己实现的自定义编译脚本</li><li>net 网络功能实现相关代码</li><li>post 测试相关</li><li>scripts 固件操作的脚本</li><li>spl tpl 编译uboot后放置的文件夹</li><li>test 测试文件相关</li><li>tools 工具相关</li></ul> 
<p>编译uboot</p> 
<pre><code class="prism language-powershell">cd rk_android11/rk_android11<span class="token punctuation">.</span>0_sdk_211130
<span class="token punctuation">.</span><span class="token operator">/</span>build<span class="token punctuation">.</span>sh <span class="token operator">-</span>U
</code></pre> 
<p><strong>报错提示不用管</strong><br> <img src="https://images2.imgbox.com/20/ec/4LjiR0Fg_o.png" alt="在这里插入图片描述"><br> 编译后生成的两个重点文件<br> <img src="https://images2.imgbox.com/3c/bb/Vspw1zEa_o.png" alt="在这里插入图片描述"><br> 编译之后生成的文件分析<br> <img src="https://images2.imgbox.com/62/d4/75oBfL2h_o.png" alt="在这里插入图片描述"><br> 圈起来的是可行固件</p> 
<ul><li>resource.img 资源文件</li><li>u-boot 编译之后的elf格式uboot镜像文件</li><li>u-boot.bin 编译之后的二进制格式uboot镜像文件</li><li>u-boot.cfg u-boot.cfg.configs 编译之后的配置文件，可以通过这个来看我们配置哪些选项</li><li>u-boot-dtb u-boot的设备树文件</li><li>u-boot.lds 链接脚本</li><li>u-boot.map 映像文件</li><li>u-boot-nodtb.bin u-boot-dtb.bin</li><li>u-boot.srec srec格式的uboot镜像文件</li><li>u-boot.sym 符号文件</li><li>tee.bin optv的镜像文件</li></ul> 
<p>将u-boot.img 烧写进开发板</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4cdeb319def865faeacf0a5f6c29ead5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jwt单点登录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/38a9a9a98242040aa4047e646d5ee374/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深信服技术认证“SCSA-S”划重点：渗透测试工具使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>