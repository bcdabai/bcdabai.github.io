<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>GoFrame Step by Step Demo - P1 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="GoFrame Step by Step Demo - P1" />
<meta property="og:description" content="GoFrame Step by Step Demo P1 框架说明文档GFTool 安装Web框架学习 文章目录 GoFrame Step by Step Demo P1参考Demo记录安装GF Tool加入环境变量创建并初始化项目配置项目数据数据表构建路由1. API2. 鉴权3. 用户4. 权限Code验证码 本片后记 参考Demo StandAlone Projects using GoFrame
gf-demos - (Official) GoFrame新手入门基础演示项目。gf-cli - (Official) GoFrame Command Line Interface.focus-single - (Official) GoFrame开源社区项目，可作为一个完整项目示例。gfast - 基于GoFrame框架的后台管理系统。gmanager - 基于GoFrame框架的管理平台。gf-vue-admin - 基于GoFrame&#43;Vue搭建的后台管理系统框架。gf-admin-api - 一个前后端分离项目，前端Vue.js、后端GoFrame。gea - 基于GoFrame、Vue &amp; Element的前后端分离权限管理系统。dmicro - 基于GoFrame的rpc框架。 Libraries and Plugins using GoFrame
polaris - Polaris with GoFrame.gtoken - 基于GoFrame框架的token插件，通过服务端验证方式实现token认证.gf-jwt - GoFrame HTTP JWT middleware." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/67e8e2c7cefc591204bfb0cf2b6d6366/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-09T17:52:30+08:00" />
<meta property="article:modified_time" content="2022-01-09T17:52:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">GoFrame Step by Step Demo - P1</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="GoFrame_Step_by_Step_Demo_P1_1"></a>GoFrame Step by Step Demo P1</h2> 
<ul><li><a href="https://goframe.org/display/gf" rel="nofollow">框架说明文档</a></li><li><a href="https://goframe.org/pages/viewpage.action?pageId=1115782" rel="nofollow">GFTool 安装</a></li><li><a href="https://goframe.org/pages/viewpage.action?pageId=1114405" rel="nofollow">Web框架学习</a></li></ul> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#GoFrame_Step_by_Step_Demo_P1_1" rel="nofollow">GoFrame Step by Step Demo P1</a></li><li><ul><li><a href="#Demo_7" rel="nofollow">参考Demo</a></li><li><a href="#_30" rel="nofollow">记录</a></li><li><ul><li><a href="#GF_Tool_32" rel="nofollow">安装GF Tool加入环境变量</a></li><li><a href="#_65" rel="nofollow">创建并初始化项目</a></li><li><a href="#_131" rel="nofollow">配置项目数据</a></li><li><a href="#_248" rel="nofollow">数据表构建</a></li><li><a href="#_454" rel="nofollow">路由</a></li><li><ul><li><a href="#1_API_457" rel="nofollow">1. API</a></li><li><a href="#2__484" rel="nofollow">2. 鉴权</a></li><li><a href="#3__523" rel="nofollow">3. 用户</a></li><li><a href="#4__530" rel="nofollow">4. 权限</a></li><li><a href="#Code_534" rel="nofollow">Code</a></li><li><a href="#_835" rel="nofollow">验证码</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_886" rel="nofollow">本片后记</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="Demo_7"></a>参考Demo</h3> 
<p>StandAlone Projects using GoFrame</p> 
<ul><li><a href="https://github.com/gogf/gf-demos">gf-demos</a> - (Official) GoFrame新手入门基础演示项目。</li><li><a href="https://github.com/gogf/gf-cli">gf-cli</a> - (Official) GoFrame Command Line Interface.</li><li><a href="https://github.com/gogf/focus-single">focus-single</a> - (Official) GoFrame开源社区项目，可作为一个完整项目示例。</li><li><a href="https://github.com/tiger1103/gfast">gfast</a> - 基于GoFrame框架的后台管理系统。</li><li><a href="https://github.com/goflyfox/gmanager">gmanager</a> - 基于GoFrame框架的管理平台。</li><li><a href="https://gf-vue-admin.com/" rel="nofollow">gf-vue-admin</a> - 基于GoFrame+Vue搭建的后台管理系统框架。</li><li><a href="https://github.com/jangworn/gf-admin-api">gf-admin-api</a> - 一个前后端分离项目，前端Vue.js、后端GoFrame。</li><li><a href="https://github.com/1307super/gea">gea</a> - 基于GoFrame、Vue &amp; Element的前后端分离权限管理系统。</li><li><a href="https://github.com/osgochina/dmicro">dmicro</a> - 基于GoFrame的rpc框架。</li></ul> 
<p>Libraries and Plugins using GoFrame</p> 
<ul><li><a href="https://github.com/gogf/polaris">polaris</a> - Polaris with GoFrame.</li><li><a href="https://github.com/goflyfox/gtoken">gtoken</a> - 基于GoFrame框架的token插件，通过服务端验证方式实现token认证.</li><li><a href="https://github.com/gogf/gf-jwt">gf-jwt</a> - GoFrame HTTP JWT middleware.</li><li><a href="https://github.com/gogf/csrf">csrf</a> - CSRF middleware for GoFrame web server.</li><li><a href="https://github.com/vance-liu/gdb-adapter">gdb-adapter</a> - GoFrame ORM adapter for Casbin.</li></ul> 
<p>Use Cases using GoFrame</p> 
<ul><li><a href="https://www.liming.me/" rel="nofollow">Bingo</a> - 个人博客程序，后台前端采用Vue2+ElementUI2，服务端用的GoFrame。</li><li><a href="https://homeapp.top/" rel="nofollow">云传意</a> - 微信小程序：云传意。</li></ul> 
<h3><a id="_30"></a>记录</h3> 
<h4><a id="GF_Tool_32"></a>安装GF Tool加入环境变量</h4> 
<pre><code>USAGE
    gf COMMAND [ARGUMENT] [OPTION]

COMMAND
    env        show current Golang environment variables
    get        install or update GF to system in default...
    gen        automatically generate go files for ORM models...
    mod        extra features for go modules...
    run        running go codes with hot-compiled-like feature...
    init       create and initialize an empty GF project...
    help       show more information about a specified command
    pack       packing any file/directory to a resource file, or a go file...
    build      cross-building go project for lots of platforms...
    docker     create a docker image for current GF project...
    swagger    swagger feature for current project...
    update     update current gf binary to latest one (might need root/admin permission)
    install    install gf binary to system (might need root/admin permission)
    version    show current binary version info

OPTION
    -y         all yes for all command without prompt ask
    -?,-h      show this help or detail for specified command
    -v,-i      show version information
    -debug     show internal detailed debugging information

ADDITIONAL
    Use 'gf help COMMAND' or 'gf COMMAND -h' for detail about a command, which has '...'
    in the tail of their comments.
</code></pre> 
<h4><a id="_65"></a>创建并初始化项目</h4> 
<ul><li>使用<code>gf init quabg</code>创建项目</li><li><code>cd quabg</code> 然后<code>go mod download</code>下载所有依赖库</li><li><code>gf run main.go</code>启动服务（包含自动热重启功能）</li></ul> 
<p>然后就可以使用VS Code或者Idea开发你的代码啦！</p> 
<blockquote> 
 <p>Note: 如果go下载过慢，需要设置代理。参考<a href="https://goproxy.cn/" rel="nofollow">goproxy</a></p> 
</blockquote> 
<p>项目结构如下：（注意版本，新版V2与V1在目录结构上有差别）</p> 
<pre><code>│  Dockerfile
│  go.mod
│  go.sum
│  main.go                    # 入口文件，引用 boot.go 和 router.go 进行初始化，然后Run
│  README.MD
├─app
│  ├─api                    
│  │      hello.go
│  ├─dao
│  │      .gitkeep
│  ├─model
│  │      .gitkeep
│  └─service
│          .gitkeep
├─boot
│      .gitkeep
│      boot.go                 # 启动第一个执行的 init, 主要是加载packed内容或者其他自定义的行为
├─config
│      .gitkeep
│      config.toml
├─docker
│      .gitkeep
├─document
│      .gitkeep
├─i18n
│      .gitkeep
├─packed
│      packed.go               # packed功能实现文件，用来打包静态资源  
├─public
│  ├─html
│  │      .gitkeep
│  ├─plugin
│  │      .gitkeep
│  └─resource
│      ├─css
│      │      .gitkeep
│      ├─image
│      │      .gitkeep
│      └─js
│              .gitkeep
├─router
│      .gitkeep
│      router.go               # 根据 config 配置内容生成server实例，然后Group 路由表，后续路由设定也在这里
└─template
        .gitkeep
</code></pre> 
<p>这个框架很有特点，把server内容分为<code>api/dao/model/service</code>几个部分，编写代码时，只需要按照框架设定编写就可以，并且会有很多好处。</p> 
<blockquote> 
 <p>api: 用来与router.go 配合，完成路由与接口处理工作。一般使用model下的struct进行API参数验证，然后调用service进行数据处理，然后返回json结果<br> dao: 通过<code>gf gen dao</code>命令可以通过数据库反向生成各个表的ORM接口(internal文件夹内部文件不能改)，方便在此基础上完善与数据库交互功能实现<br> model: 一般<code>gf gen dao</code>命令在这里生成一个model.go文件，存储了struct和ORM/json映射关系。用户可以在此处创新自己其他用途的model文件<br> service: 小功能的集合处，真正实现的地方。这里包含所有的中间件、特殊服务、数据处理等。</p> 
</blockquote> 
<p>docker文件夹，document文件夹，i18n文件夹看名字就知道用途，等用的时候再参考。<br> public用来存放使用template或者编译好的web站点静态文件。</p> 
<h4><a id="_131"></a>配置项目数据</h4> 
<p>一个完整的配置数据如下：</p> 
<pre><code class="prism language-conf">[server]
    # 基本配置
    address             = ":80"                        # 本地监听地址。默认":80"
    httpsAddr           = ":443"                       # TLS/HTTPS配置，同时需要配置证书和密钥。默认关闭
    httpsCertPath       = ""                           # TLS/HTTPS证书文件本地路径，建议使用绝对路径。默认关闭
    httpsKeyPath        = ""                           # TLS/HTTPS密钥文件本地路径，建议使用绝对路径。默认关闭
    readTimeout         = "60s"                        # 请求读取超时时间，一般不需要配置。默认为60秒
    writeTimeout        = "0"                          # 数据返回写入超时时间，一般不需要配置。默认不超时（0）
    idleTimeout         = "60s"                        # 仅当Keep-Alive开启时有效，请求闲置时间。默认为60秒
    maxHeaderBytes      = "10240"                      # 请求Header大小限制（Byte）。默认为10KB
    keepAlive           = true                         # 是否开启Keep-Alive功能。默认true
    serverAgent         = "GoFrame HTTP Server"        # 服务端Agent信息。默认为"GoFrame HTTP Server"

    # 静态服务配置
    indexFiles          = ["index.html","index.htm"]   # 自动首页静态文件检索。默认为["index.html", "index.htm"]
    indexFolder         = false                        # 当访问静态文件目录时，是否展示目录下的文件列表。默认关闭，那么请求将返回403
    serverRoot          = "./statics"                  # 静态文件服务的目录根路径，配置时自动开启静态文件服务。默认关闭
    searchPaths         = ["./public/www","./www"]     # 提供静态文件服务时额外的文件搜索路径，当根路径找不到时则按照顺序在搜索目录查找。默认关闭
    fileServerEnabled   = false                        # 静态文件服务总开关。默认false

    # Cookie配置
    cookieMaxAge        = "30d"              # Cookie有效期。默认为365天
    cookiePath          = "/"                # Cookie有效路径。默认为"/"表示全站所有路径下有效
    cookieDomain        = ""                 # Cookie有效域名。默认为当前配置Cookie时的域名

    # Sessions配置
    sessionMaxAge       = "24h"              # Session有效期。默认为24小时
    sessionIdName       = "quabg-sess"       # SessionId的键名名称。默认为gfsessionid
    sessionCookieOutput = true               # Session特性开启时，是否将SessionId返回到Cookie中。默认true
    sessionPath         = "./data/sessions"  # Session存储的文件目录路径。默认为当前系统临时目录下的gsessions目录

    # Logging配置,指的是服务器本身的
    logPath             = "./data/logs/"     # 日志文件存储目录路径，建议使用绝对路径。默认为空，表示关闭
    logStdout           = true               # 日志是否输出到终端。默认为true
    errorStack          = true               # 当Server捕获到异常时是否记录堆栈信息到日志中。默认为true
    errorLogEnabled     = true               # 是否记录异常日志信息到日志中。默认为true
    errorLogPattern     = "ser_err-{Ymd}.log"# 异常错误日志文件格式。默认为"error-{Ymd}.log"
    accessLogEnabled    = false              # 是否记录访问日志。默认为false
    accessLogPattern    = "ser_acc-{Ymd}.log"# 访问日志文件格式。默认为"access-{Ymd}.log"

    # PProf配置
    pprofEnabled        = false              # 是否开启PProf性能调试特性。默认为false
    pprofPattern        = ""                 # 开启PProf时有效，表示PProf特性的页面访问路径，对当前Server绑定的所有域名有效。

    # 其他配置
    clientMaxBodySize   = 8102410240         # 客户端最大Body上传限制大小，影响文件上传大小(Byte)。默认为8*1024*1024=8MB *10=80M
    formParsingMemory   = 1048576            # 解析表单时的缓冲区大小(Byte)，一般不需要配置。默认为1024*1024=1MB
    nameToUriType       = 0                  # 路由注册中使用对象注册时的路由生成规则。默认为0
    routeOverWrite      = false              # 当遇到重复路由注册时是否强制覆盖。默认为false，重复路由存在时将会在启动时报错退出
    dumpRouterMap       = true               # 是否在Server启动时打印所有的路由列表。默认为true
    graceful            = false              # 是否开启平滑重启特性，开启时将会在本地增加10000的本地TCP端口用于进程间通信。默认false             
    gracefulTimeout     = 2                  # 父进程在平滑重启后多少秒退出，默认2秒。若请求耗时大于该值，可能会导致请求中断

# gf gen and build
[gfcli]
    [[gfcli.gen.dao]]
        link   = "mysql:admin:admin123@tcp(127.0.0.1:3306)/db_test"
        removePrefix = "t_"
        jsonCase = "CamelLower"
        gJsonSupport = true

    [gfcli.build]
        name     = "quabg"
        arch     = "amd64"
        system   = "linux,windows"
        mod      = "none"
        cgo      = 0
        pack     = ""
        version  = ""
        output   = "./bin"
        extra    = ""

# 业务logger组件配置
[logger]
    path                 = "./data/logs/"  # 日志文件路径。默认为空，表示关闭，仅输出到终端
    file                 = "c_{Y-m-d}.log" # 日志文件格式。默认为"{Y-m-d}.log"
    prefix               = ""              # 日志内容输出前缀。默认为空
    level                = "all"           # 日志输出级别
    ctxKeys              = []              # Context上下文变量名称，自动打印Context的变量到日志中。默认为空
    headerPrint          = true            # 是否打印日志的头信息。默认true
    stdoutPrint          = true            # 日志是否同时输出到终端。默认true
    rotateSize           = 0               # 按照日志文件大小对文件进行滚动切分。默认为0，表示关闭滚动切分特性
    rotateExpire         = 0               # 按照日志文件时间间隔对文件滚动切分。默认为0，表示关闭滚动切分特性
    rotateBackupLimit    = 0               # 按照切分的文件数量清理切分文件，当滚动切分特性开启时有效。默认为0，表示不备份，切分则删除
    rotateBackupExpire   = 0               # 按照切分的文件有效期清理切分文件，当滚动切分特性开启时有效。默认为0，表示不备份，切分则删除
    rotateBackupCompress = 0               # 滚动切分文件的压缩比（0-9）。默认为0，表示不压缩
    rotateCheckInterval  = "1h"            # 滚动切分的时间检测间隔，一般不需要设置。默认为1小时
    writerColorEnable    = false           # 日志文件是否带上颜色。默认false，表示不带颜色

# Database.
[database]
    link      = "mysql:admin:admin123@tcp(127.0.0.1:3306)/db_test"
    debug     = true
    charset   = "utf8"
    ctxStrict = false
    # Database logger.
    [database.logger]
        Path   = ""
        Level  = "error"
        Stdout = true

# User config for tcp server
[tcpserver]
    Address = ":20012"
    MqAddress = "tcp://127.0.0.1:1883"             # MQTT 服务器地址
    MqPrefix = "/test/dev/"                        # 设备发送 tx， 设备接收 rx
    MqUser = "test"
    MqPwd = "Mqtt_test"
</code></pre> 
<p>其中</p> 
<ul><li>gf tool部分完整参数参考说明参见<a href="https://goframe.org/pages/viewpage.action?pageId=3673173" rel="nofollow">link</a>。</li><li>ORM Database <a href="https://goframe.org/pages/viewpage.action?pageId=1114245" rel="nofollow">完整参考</a></li></ul> 
<h4><a id="_248"></a>数据表构建</h4> 
<p>受限查看数据服务器编码信息:</p> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%character%'</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'collation%'</span><span class="token punctuation">;</span>
</code></pre> 
<p>为了对unicode编码支持良好，更多使用utf8mb4/utf8mb4_0900_ai_ci编码.</p> 
<p>创建表</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>db_test<span class="token punctuation">`</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8mb4'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8mb4_bin'</span><span class="token punctuation">;</span>
<span class="token keyword">USE</span> <span class="token punctuation">`</span>db_test<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token comment">--------------------------------用户相关信息-------------------------------------------</span>

<span class="token comment">-- user 角色表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_user
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>      <span class="token keyword">integer</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">comment</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'用户名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>pwd<span class="token punctuation">`</span>     nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'加盐后的密码MD5'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>phone<span class="token punctuation">`</span>   nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'用户手机号码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>email<span class="token punctuation">`</span>   nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>  <span class="token keyword">default</span> <span class="token string">''</span>         <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'用户邮箱'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>salt<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>                  <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'密码salt'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>state<span class="token punctuation">`</span>   <span class="token keyword">int</span>          <span class="token keyword">default</span> <span class="token number">1</span>            <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'用户状态,0冻结,1激活'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>role<span class="token punctuation">`</span>    <span class="token keyword">int</span>          <span class="token keyword">default</span> <span class="token number">1</span>            <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'角色Index'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span><span class="token keyword">group</span><span class="token punctuation">`</span>   <span class="token keyword">int</span>          <span class="token keyword">default</span> <span class="token number">1</span>            <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'组Index'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>crt_tm<span class="token punctuation">`</span>  <span class="token keyword">int</span>          <span class="token keyword">default</span> <span class="token number">0</span>            <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'创建时间戳'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>extras<span class="token punctuation">`</span>  json                              <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'附加信息'</span>
    <span class="token comment">-- `wechat`  nvarchar(2555)  default ''    not null comment '微信关联ID',</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">10000</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">comment</span> <span class="token string">'用户信息表'</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_user <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>pwd<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>phone<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>email<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>salt<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>state<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token keyword">group</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>crt_tm<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>extras<span class="token punctuation">`</span><span class="token punctuation">)</span> 
    <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'110110'</span><span class="token punctuation">,</span> <span class="token string">'01234567890'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'123123'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1640923199</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- role 角色表</span>
<span class="token comment">-- 部分场景可以直接省略为 0,1,2,3 来区分权限</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_role
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>      <span class="token keyword">integer</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">comment</span> <span class="token string">'角色ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'角色名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>description<span class="token punctuation">`</span> nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                      <span class="token keyword">comment</span> <span class="token string">'角色描述'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>extras<span class="token punctuation">`</span>  json                              <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'附加信息'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">10</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">comment</span> <span class="token string">'角色信息表'</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_role <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>extras<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'站长'</span><span class="token punctuation">,</span> <span class="token string">'组拥有者，可使用所有功能'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_role <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>extras<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">'管理员'</span><span class="token punctuation">,</span> <span class="token string">'管理员，可以增删改查大部分功能'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_role <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>extras<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">'普通用户'</span><span class="token punctuation">,</span> <span class="token string">'普通用户，可以访问控制，不能修改信息'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- group 用户组/组织信息</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_group
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>      <span class="token keyword">integer</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">comment</span> <span class="token string">'组ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'组名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>description<span class="token punctuation">`</span> nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                      <span class="token keyword">comment</span> <span class="token string">'组描述'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>extras<span class="token punctuation">`</span>  json                              <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'附加信息'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">comment</span> <span class="token string">'组信息表'</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_group <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>extras<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'默认组'</span><span class="token punctuation">,</span> <span class="token string">'默认的组织，修改后使用'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-------------------------------网站相关信息--------------------------------------------</span>

<span class="token comment">-- 导航相关信息配置</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_nav
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>      <span class="token keyword">integer</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">comment</span> <span class="token string">'navi menu ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'导航名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>keyword<span class="token punctuation">`</span> nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'English simple key word'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>role<span class="token punctuation">`</span>    <span class="token keyword">int</span>           <span class="token keyword">default</span> <span class="token number">0</span>           <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'菜单所有权,0不限制,其他进行匹配'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span><span class="token keyword">level</span><span class="token punctuation">`</span>   <span class="token keyword">int</span>           <span class="token keyword">default</span> <span class="token number">0</span>           <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'菜单层次等级'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>pid<span class="token punctuation">`</span>     <span class="token keyword">int</span>           <span class="token keyword">default</span> <span class="token number">0</span>           <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'父级菜单ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>icon<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'图标'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>extras<span class="token punctuation">`</span>  json                              <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'附加信息'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">comment</span> <span class="token string">'菜单信息表'</span><span class="token punctuation">;</span>

<span class="token comment">-- 网站对应组信息表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_group_cfg
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>      <span class="token keyword">integer</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">comment</span> <span class="token string">'config ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'配置名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>title<span class="token punctuation">`</span>   nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'网站名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>gid<span class="token punctuation">`</span>     <span class="token keyword">int</span>           <span class="token keyword">default</span> <span class="token number">0</span>           <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'配置拥有组ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>logo<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'图标'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>extras<span class="token punctuation">`</span>  json                              <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'附加信息'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">comment</span> <span class="token string">'网站配置信息表'</span><span class="token punctuation">;</span>


<span class="token comment">--------------------------------业务相关信息-------------------------------------------</span>
<span class="token comment">-- devices 设备表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_dev
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>      <span class="token keyword">integer</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">comment</span> <span class="token string">'设备ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'设备名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>uid<span class="token punctuation">`</span>     nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'设备UID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>pwd<span class="token punctuation">`</span>     nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'通信密码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>state<span class="token punctuation">`</span>   <span class="token keyword">int</span>          <span class="token keyword">default</span> <span class="token number">0</span>            <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'通信状态,0未激活,1激活'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>gid<span class="token punctuation">`</span>     <span class="token keyword">int</span>                           <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'Goup ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span>    <span class="token keyword">int</span>                           <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'设备类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>crt_tm<span class="token punctuation">`</span>  <span class="token keyword">int</span>          <span class="token keyword">default</span> <span class="token number">0</span>            <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'创建时间戳'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>extras<span class="token punctuation">`</span>  json                              <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'附加信息'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">200001</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">comment</span> <span class="token string">'设备信息表'</span><span class="token punctuation">;</span>

<span class="token comment">-- submods 设备模块表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_submod
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>      <span class="token keyword">integer</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">comment</span> <span class="token string">'模块ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>    nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>                 <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'模块名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>idx<span class="token punctuation">`</span>     <span class="token keyword">int</span>                           <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'模块的子Idx'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span>    <span class="token keyword">int</span>                           <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'模块类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>crt_tm<span class="token punctuation">`</span>  <span class="token keyword">int</span>          <span class="token keyword">default</span> <span class="token number">0</span>            <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'创建时间戳'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>extras<span class="token punctuation">`</span>  json                              <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'附加信息'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">comment</span> <span class="token string">'设备子模块信息表'</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后在项目根目录下，使用gf工具生成dao文件<code>gf gen dao</code>, <code>gf run main.go</code>:</p> 
<pre><code class="prism language-bash"><span class="token operator">|</span>   Dockerfile
<span class="token operator">|</span>   go.mod
<span class="token operator">|</span>   go.sum
<span class="token operator">|</span>   main.go
<span class="token operator">|</span>   README.MD
<span class="token operator">|</span>
+---app
<span class="token operator">|</span>   +---api
<span class="token operator">|</span>   <span class="token operator">|</span>       hello.go
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   +---dao
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>   .gitkeep
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>   dev.go
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>   group.go
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>   group_cfg.go
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>   nav.go
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>   role.go
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>   submod.go
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>   user.go
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token punctuation">\</span>---internal
<span class="token operator">|</span>   <span class="token operator">|</span>           dev.go
<span class="token operator">|</span>   <span class="token operator">|</span>           group.go
<span class="token operator">|</span>   <span class="token operator">|</span>           group_cfg.go
<span class="token operator">|</span>   <span class="token operator">|</span>           nav.go
<span class="token operator">|</span>   <span class="token operator">|</span>           role.go
<span class="token operator">|</span>   <span class="token operator">|</span>           submod.go
<span class="token operator">|</span>   <span class="token operator">|</span>           user.go
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   +---model
<span class="token operator">|</span>   <span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>   <span class="token operator">|</span>       model.go
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token punctuation">\</span>---service
<span class="token operator">|</span>           .gitkeep
<span class="token operator">|</span>
+---boot
<span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>       boot.go
<span class="token operator">|</span>
+---config
<span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>       config.toml
<span class="token operator">|</span>
+---data
<span class="token operator">|</span>   +---logs
<span class="token operator">|</span>   <span class="token operator">|</span>       <span class="token number">2021</span>-12-30.log
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token punctuation">\</span>---sessions
<span class="token operator">|</span>       <span class="token punctuation">\</span>---default
+---docker
<span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>
+---document
<span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>
+---i18n
<span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>
+---logs
<span class="token operator">|</span>       <span class="token number">2021</span>-12-27.log
<span class="token operator">|</span>
+---packed
<span class="token operator">|</span>       packed.go
<span class="token operator">|</span>
+---public
<span class="token operator">|</span>   +---html
<span class="token operator">|</span>   <span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   +---plugin
<span class="token operator">|</span>   <span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token punctuation">\</span>---resource
<span class="token operator">|</span>       +---css
<span class="token operator">|</span>       <span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span>       +---image
<span class="token operator">|</span>       <span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span>       <span class="token punctuation">\</span>---js
<span class="token operator">|</span>               .gitkeep
<span class="token operator">|</span>
+---router
<span class="token operator">|</span>       .gitkeep
<span class="token operator">|</span>       router.go
<span class="token operator">|</span>
<span class="token punctuation">\</span>---template
        .gitkeep
</code></pre> 
<p>可以看到，工具在dao文件夹下为dev,group,group_cfg,nav,role,submod,user等表生成了对应的db封装，在model文件夹下生成了结构体和ORM/JSON映射。</p> 
<p>当run起来后，产生了我们配置的logs和session文件夹，里面存放运行时log内容和session文件。</p> 
<p>到此，一个web后端所需要的所有数据都已经准备完毕，下面就是API和中间件的设计了。</p> 
<h4><a id="_454"></a>路由</h4> 
<p>一个正常的web站点，逃不开<code>用户/鉴权/权限/api</code>这四个基础话题，这里都简单说明。</p> 
<h5><a id="1_API_457"></a>1. API</h5> 
<ul><li>API使用分层设计方式</li><li>基于JSON的POST模式进行设计</li><li>内部使用各种中间件进行鉴权认证一类的功能</li><li>如果有文档需求，在代码完成后，参考GF官方推荐方式进行集成。</li><li>API接口支持跨域</li></ul> 
<p>API的返回信息参考如下格式</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"code"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment">// 1000 正常，1001 常规错误，1002 鉴权错误，1003 内部错误...</span>
    <span class="token string">"msg"</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token comment">// 提示信息，在非1000时，可以根据这个提示用户行为</span>
    <span class="token string">"data"</span><span class="token operator">:</span> object<span class="token operator">/</span>array<span class="token punctuation">,</span>  <span class="token comment">// 动态数据，根据请求接口而定</span>
    <span class="token string">"notify"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment">// 服务器给客户端推送的消息，一般可以不适用  </span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中，json字段命名规范参考于<code>gf gen dao -h</code>,使用<code>CamelLower</code>风格，即除了首歌单词外，首字母大写，其他小写。</p> 
<table><thead><tr><th>Case</th><th>Example</th></tr></thead><tbody><tr><td>Camel</td><td>AnyKindOfString</td></tr><tr><td>CamelLower</td><td>anyKindOfString</td></tr><tr><td>Snake</td><td>any_kind_of_string</td></tr><tr><td>SnakeScreaming</td><td>ANY_KIND_OF_STRING</td></tr><tr><td>SnakeFirstUpper</td><td>rgb_code_md5</td></tr><tr><td>Kebab</td><td>any-kind-of-string</td></tr><tr><td>KebabScreaming</td><td>ANY-KIND-OF-STRING</td></tr></tbody></table> 
<h5><a id="2__484"></a>2. 鉴权</h5> 
<p>目前有很多鉴权方式，JWT和Token是两种比较常见的，网络上有各种讨论他们的优缺点，这里不作为考虑的重点，我们选用一种折衷方式的简单实现：</p> 
<ul><li>鉴权认证信息放在HTTP Header部分，使用 Authorization 字段传递鉴权信息，web或者客户端自行选择存储方式。</li><li>鉴权认证信息格式使用JWT token方式，内部存储部分不敏感信息，需要的时候在服务端进行再次认证/查询。</li><li>鉴权信息包含salt信息，在服务器除了验证密钥，还与缓存的用户salt数据核对，发现不匹配时，说明此用户token失效。</li></ul> 
<p>对于所有的请求，如果服务器没有异常，正常返回200，客户端根据json中的code进行错误处理。</p> 
<p>对于websocket服务，需要考虑token传递问题和心跳问题，所以优化：</p> 
<ul><li>token可以根据实际情况在url或者header传递</li><li>nginx等服务需要添加超时比实际业务更长一点 <a href="https://juejin.cn/post/6893466053020811271" rel="nofollow">参考link</a></li></ul> 
<pre><code class="prism language-conf">http {
    server {
        location /ws {
            root   html;
            index  index.html index.htm;
            proxy_pass xxx.xxx.xxx.xx:9527;
            proxy_http_version 1.1;
            proxy_connect_timeout 4s;
            proxy_read_timeout 700s;      # 需要比业务心跳更长一点
            proxy_send_timeout 12s;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
    }
}
</code></pre> 
<ul><li>websocket接口层与API的接口层，尽量一致，方便后续做SDK</li></ul> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"request"</span><span class="token operator">:</span> <span class="token string">"/api/user/login"</span><span class="token punctuation">,</span>
    <span class="token string">"header"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"body"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/73/b7/3KkA6HNP_o.png" alt="Auth"></p> 
<h5><a id="3__523"></a>3. 用户</h5> 
<p>用户基础信息通过专用接口返回，通过role区分返回信息多少。通过group区分组织，然后通过group_cfg来获取单独网站配置信息，通过role的nav的绑定关系，确定菜单导航显示的功能。</p> 
<p>用户的登陆暂不考虑第三方问题。</p> 
<p><strong>后期缺少auth2和支付相关功能</strong></p> 
<h5><a id="4__530"></a>4. 权限</h5> 
<p>权限目前只通过role base确定，不支持定制。<br> 权限大多对于定制化业务，需要设计的管理方式也不一致，不通用。</p> 
<h5><a id="Code_534"></a>Code</h5> 
<p>鉴权部分需要通过中间件，存放在context中，统一处理。</p> 
<p>如下时一个常用的几个中间件：</p> 
<pre><code class="prism language-golang"> file:  model/context.go

const (
	ContextKey = "ReqCtx" // 上下文变量存储键名
)

// Context 请求上下文结构
type Context struct {
	Session    *ghttp.Session  // 当前Session管理对象
	ReqUserCtx *ContextUserReq // 上下文用户信息
}

// ContextUserReq 用户请求过来时，提取 token信息，填充此结构。后续使用时，可以追加新的类型
type ContextUserReq struct {
	Token string `json:"-"`     // Header or parameter token
	Id    int    `json:"id"`    // 用户ID
	Salt  string `json:"salt"`  // Salt,需要与服务器salt比对
	Role  int    `json:"role"`  // 用户角色
	Group int    `json:"group"` // 用户组
}

 file: service/context.go

// Context 上下文管理服务, 类型在model.Context 中定义
var Context = new(contextService)

type contextService struct{}

// Init 初始化上下文对象指针到上下文对象中，以便后续的请求流程中可以修改。请求开始时调用初始化
func (s *contextService) Init(r *ghttp.Request, customCtx *model.Context) {
	r.SetCtxVar(model.ContextKey, customCtx)
}

// Get 获得上下文变量，如果没有设置，那么返回nil
func (s *contextService) Get(ctx context.Context) *model.Context {
	value := ctx.Value(model.ContextKey)
	if value == nil {
		return nil
	}
	if localCtx, ok := value.(*model.Context); ok {
		return localCtx
	}
	return nil
}

// SetUser 将上下文信息设置到上下文请求中，注意是完整覆盖
func (s *contextService) SetUser(ctx context.Context, ctxUser *model.ContextUserReq) {
	s.Get(ctx).ReqUserCtx = ctxUser
}

 file: middleware.go
// Middleware 中间件管理服务
var Middleware = new(middlewareService)

type middlewareService struct{}

// Ctx 上下文对象提取. 这里初始化，jwt时进行认证
func (s *middlewareService) Ctx(r *ghttp.Request) {
	reqCtx := &amp;model.Context{
		Session:    r.Session,
		ReqUserCtx: nil,
	}
	Context.Init(r, reqCtx) //在进行jwt认证时，会重新设置ReqUserCtx
	r.Middleware.Next()
}

// JwtAuth JWT 鉴权中间件，JWT+Token方式认证
func (s *middlewareService) JwtAuth(r *ghttp.Request) {
	if _, err := AuthHandler(r); err == nil {
        // 根据实际情况，处理Salt的核对
		// 这里暂不做处理
		r.Middleware.Next()
	} else {
		_ = r.Response.WriteJson(MakeJsonErr(err.Error()))
	}
}

// CORS 允许接口跨域请求
func (s *middlewareService) CORS(r *ghttp.Request) {
	r.Response.CORSDefault()
	r.Middleware.Next()
}
</code></pre> 
<p>一个参考认证的结构:<br> https://goframe.org/pages/viewpage.action?pageId=7302150<br> https://goframe.org/pages/viewpage.action?pageId=1114367</p> 
<p>Context定义</p> 
<pre><code class="prism language-go"><span class="token comment">// Context 上下文管理服务, 类型在model.Context 中定义</span>
<span class="token keyword">var</span> Context <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>contextService<span class="token punctuation">)</span>

<span class="token keyword">type</span> contextService <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">// Init 初始化上下文对象指针到上下文对象中，以便后续的请求流程中可以修改。请求开始时调用初始化</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>contextService<span class="token punctuation">)</span> <span class="token function">Init</span><span class="token punctuation">(</span>r <span class="token operator">*</span>ghttp<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> customCtx <span class="token operator">*</span>model<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	r<span class="token punctuation">.</span><span class="token function">SetCtxVar</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>ContextKey<span class="token punctuation">,</span> customCtx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get 获得上下文变量，如果没有设置，那么返回nil</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>contextService<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>model<span class="token punctuation">.</span>Context <span class="token punctuation">{<!-- --></span>
	value <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>ContextKey<span class="token punctuation">)</span>
	<span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> localCtx<span class="token punctuation">,</span> ok <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> localCtx
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// SetUser 将上下文信息设置到上下文请求中，注意是完整覆盖</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>contextService<span class="token punctuation">)</span> <span class="token function">SetUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctxUser <span class="token operator">*</span>model<span class="token punctuation">.</span>ContextUserReq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	s<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span>ReqUserCtx <span class="token operator">=</span> ctxUser
<span class="token punctuation">}</span>
</code></pre> 
<p>JWT 不使用 gf-jwt，因为那个fork gin-jwt 并且很久不更新，原始代码有问题，所以参考如下，自己做一个：</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"errors"</span>
	<span class="token string">"github.com/gogf/gf/frame/g"</span>
	<span class="token string">"github.com/gogf/gf/net/ghttp"</span>
	jwt <span class="token string">"github.com/golang-jwt/jwt"</span>
	<span class="token string">"quabg/app/model"</span>
	<span class="token string">"strings"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token comment">// https://blog.csdn.net/shachao888/article/details/111072282</span>
<span class="token comment">// type StandardClaims struct {<!-- --></span>
<span class="token comment">// 	Audience  string `json:"aud,omitempty"` //该JWT所面向的用户</span>
<span class="token comment">// 	ExpiresAt int64  `json:"exp,omitempty"` //token什么时候过期</span>
<span class="token comment">// 	Id        string `json:"jti,omitempty"` //ID为web token提供唯一标识</span>
<span class="token comment">// 	IssuedAt  int64  `json:"iat,omitempty"` //在什么时候签发的token</span>
<span class="token comment">// 	Issuer    string `json:"iss,omitempty"` //该JWT的签发者</span>
<span class="token comment">// 	NotBefore int64  `json:"nbf,omitempty"` //token在此时间之前不能被接收处理</span>
<span class="token comment">// 	Subject   string `json:"sub,omitempty"` //</span>
<span class="token comment">// }</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	_jwtSecret <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	_jwtSecret <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">Cfg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token string">"jwtKey"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Claims <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	model<span class="token punctuation">.</span>ContextUserReq
	jwt<span class="token punctuation">.</span>StandardClaims
<span class="token punctuation">}</span>

<span class="token comment">// AuthHandler 接收http请求，解析token相关内容，然后给出token body</span>
<span class="token keyword">func</span> <span class="token function">AuthHandler</span><span class="token punctuation">(</span>r <span class="token operator">*</span>ghttp<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Claims<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// token from header Authorization or query parameter token</span>
	token <span class="token operator">:=</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token punctuation">{<!-- --></span>
		token <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">GetQueryString</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"缺少token相关参数"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// split header token  =&gt; Bearer/Basic TEphZXI6MTIzNDU2</span>
		token <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
		tks <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>tks<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"token格式错误"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		token <span class="token operator">=</span> tks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// parse</span>
	cla<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ParseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// check time</span>
		<span class="token keyword">if</span> cla<span class="token punctuation">.</span>ExpiresAt <span class="token operator">&lt;</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"token已过期"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// update content</span>
	Context<span class="token punctuation">.</span><span class="token function">SetUser</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cla<span class="token punctuation">.</span>ContextUserReq<span class="token punctuation">)</span>
	<span class="token keyword">return</span> cla<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>

<span class="token comment">// GenerateToken 产生token的函数</span>
<span class="token keyword">func</span> <span class="token function">GenerateToken</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> role<span class="token punctuation">,</span> group <span class="token builtin">int</span><span class="token punctuation">,</span> salt <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	nowTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	expireTime <span class="token operator">:=</span> nowTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">24</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>

	claims <span class="token operator">:=</span> Claims<span class="token punctuation">{<!-- --></span>
		model<span class="token punctuation">.</span>ContextUserReq<span class="token punctuation">{<!-- --></span>
			Id<span class="token punctuation">:</span>    id<span class="token punctuation">,</span>
			Salt<span class="token punctuation">:</span>  salt<span class="token punctuation">,</span>
			Role<span class="token punctuation">:</span>  role<span class="token punctuation">,</span>
			Group<span class="token punctuation">:</span> group<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		jwt<span class="token punctuation">.</span>StandardClaims<span class="token punctuation">{<!-- --></span>
			ExpiresAt<span class="token punctuation">:</span> expireTime<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			Issuer<span class="token punctuation">:</span>    <span class="token string">"gf-server"</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// make</span>
	tokenClaims <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">NewWithClaims</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>SigningMethodHS256<span class="token punctuation">,</span> claims<span class="token punctuation">)</span>
	token<span class="token punctuation">,</span> err <span class="token operator">:=</span> tokenClaims<span class="token punctuation">.</span><span class="token function">SignedString</span><span class="token punctuation">(</span>_jwtSecret<span class="token punctuation">)</span>
	<span class="token keyword">return</span> token<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>

<span class="token comment">// ParseToken 验证token的函数</span>
<span class="token keyword">func</span> <span class="token function">ParseToken</span><span class="token punctuation">(</span>token <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Claims<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	tokenClaims<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseWithClaims</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Claims<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> _jwtSecret<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> tokenClaims <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> claims<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tokenClaims<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Claims<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> tokenClaims<span class="token punctuation">.</span>Valid <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> claims<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// error</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>最终路由规则：</p> 
<pre><code class="prism language-golang">func init() {
	s := g.Server()
	s.Group("/api", func(group *ghttp.RouterGroup) {
		group.Middleware(service.Middleware.CORS, service.Middleware.Ctx)

		// API 文档和调试接口
		// ...
		
		// 不需要Auth, 但需要验证码
		group.POST("/user/reg", nil)   // 根据实际情况开放
		group.POST("/user/login", nil) // 登录
		group.POST("/user/find", nil)  // 查找账户信息，短信或邮件发送

		// User
		group.Group("/user", func(group *ghttp.RouterGroup) {
			group.Middleware(service.Middleware.JwtAuth)

			group.POST("/reset_pwd", nil)
			group.POST("/get", nil)     // 获取用户信息
			group.POST("/get_all", nil) // 获取用户信息，包含分组，导航，分组配置等
			group.POST("/edit", nil)    // 修改部分用户信息
			// 子用户管理 【管理员和站长权限】
			group.Group("/sub", func(group *ghttp.RouterGroup) {
				group.POST("/list", nil) // 获取所有用户信息
				group.POST("/add", nil)  // 获取添加子用户
				group.POST("/edit", nil) // 修改子用户信息，ID=-1意味新增
				group.POST("/del", nil)  // 删除子用户
			})
		})
		// Role，站长/管理员/普通用户
		group.Group("/role", func(group *ghttp.RouterGroup) {
			group.Middleware(service.Middleware.JwtAuth)

			group.POST("/list", nil) // 获取信息列表
			group.POST("/get", nil)  // 获取ID对应信息
			//group.POST("/edit", nil)  // 修改配置信息，ID=-1意味着新增
			//group.POST("/del", nil) // 删除ID对应信息
			// cfg -&gt; nav
			group.Group("/nav", func(group *ghttp.RouterGroup) {
				group.POST("/list", nil) // 获取信息列表
				group.POST("/get", nil)  // 获取ID对应信息
				group.POST("/edit", nil) // 修改配置信息，ID=-1意味着新增 【管理员】
				//group.POST("/del", nil) // 删除ID对应信息
			})
		})
		// Group，分组/组织
		group.Group("/group", func(group *ghttp.RouterGroup) {
			group.Middleware(service.Middleware.JwtAuth)

			group.POST("/list", nil) // 获取信息列表，只有【站长】有此权限
			group.POST("/get", nil)  // 获取ID对应信息
			group.POST("/edit", nil) // 修改配置信息，ID=-1意味着新增，只有【管理员】有此权限
			group.POST("/del", nil)  // 删除ID对应信息，只有【站长】有此权限
			group.POST("/cfg", nil)  // 修改group的网站配置信息，只有【管理员】有此权限
		})
		// 短信，微信等后台服务
		group.Group("/util", func(group *ghttp.RouterGroup) {
			group.Middleware(service.Middleware.JwtAuth)

			group.POST("/msg_sms", nil)    // 推送信息到短信
			group.POST("/msg_qq", nil)     // 推送信息到QQ
			group.POST("/msg_wechat", nil) // 推送信息到微信
		})
		// 业务相关部分，根据实际情况使用
		// dev
		// submod
	})
}
</code></pre> 
<h5><a id="_835"></a>验证码</h5> 
<p>使用自己生成的<code>go get -u github.com/mojocn/base64Captcha</code></p> 
<pre><code class="prism language-golang">// Captcha 中间件管理服务
var Captcha = new(captchaService)

func init() {
	//init rand seed
	rand.Seed(time.Now().UnixNano())
	// captcha
	Captcha.Store = base64Captcha.NewMemoryStore(1024, 10*time.Minute)
	Captcha.Driver = base64Captcha.NewDriverString(
		150,
		300,
		0,
		0,
		4,
		"%#=qwe23456789rtyupasdfghjkzxcvbnm",
		&amp;color.RGBA{0, 0, 0, 0},
		nil,
		[]string{},
	)
}

// captchaService captcha basic information.
type captchaService struct {
	Driver *base64Captcha.DriverString
	Store  base64Captcha.Store
}

// GenerateIdAndImage 生成一组验证码
func (c *captchaService) GenerateIdAndImage() (string, string, string, error) {
	id, content, answer := c.Driver.GenerateIdQuestionAnswer()
	item, err := c.Driver.DrawCaptcha(content)
	if err != nil {
		return "", "", "", err
	}
	err = c.Store.Set(id, answer)
	if err != nil {
		return "", "", "", err
	}
	b64s := item.EncodeB64string()
	return id, b64s, answer, nil
}

// VerifyIdAndAns 验证Id和answer
func (c *captchaService) VerifyIdAndAns(id, ans string) bool {
	return c.Store.Verify(id, ans, true)
}
</code></pre> 
<h3><a id="_886"></a>本片后记</h3> 
<p>因为GF框架最近更新到2.0，对于API文档和请求处理接口更友好，整体组织形式也发生了变化，所以，后续依据2.0框架完成。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/47735f59aeaf405f3166e010280e160b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Reactor模型你知道都有哪些吗？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/eb0de1e097b69acb33bf61031e733c08/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何用gitee的pull request交作业？网页端5步轻松完成</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>