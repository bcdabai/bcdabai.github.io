<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>117.Django-缓存redis - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="117.Django-缓存redis" />
<meta property="og:description" content="1. 概述 ​ 动态网站的基本权衡是，它们是动态的。每次用户请求页面时，Web服务器都会进行各种计算 - 从数据库查询到模板呈现再到业务逻辑 - 以创建站点访问者看到的页面。从处理开销的角度来看，这比标准的文件读取文件系统服务器要耗时多了。对于大多数Web应用程序来说，这种开销并不是什么大问题。因为大多数Web应用程序只是中小型网站，没有拥有一流的流量。但对于中到高流量的站点，尽可能减少开销是至关重要的，这就是缓存的用武之地。缓存某些内容是为了保存昂贵计算的结果，这样就不必在下次执行计算。
​ Django框架带有一个强大的缓存系统，可以保存动态页面，因此不必为每个请求计算它们。Django提供不同级别的缓存粒度：可以缓存特定视图的输出，也可以只缓存页面中难以生成的部分或者可以缓存整个站点。
​ Redis，是一个内存数据库（现在已经支持内存数据持久化到硬盘当中，重新启动时，会自动从硬盘进行加载），由于其性能极高，因此经常作为中间件、缓存使用。
​ 本文档介绍就是Django框架使用Redis数据库来应用缓存框架
2. Windows开发环境下安装并使用Redis 之前已经有学习过在Linux环境下使用Redis，这里就试试看使用Windows
​ redis默认不支持windows，由于一般开发环境在windows，因为需要使用第三方团队维护的windows版本，下载地址：
​ window开发环境使用redis的安装包地址
推荐使用稳定版本
​ 直接减压压缩包，安装好之后，启动redis
​ 启动redis（如果没有配置环境变量，到解压好的文件夹中启用）：
redis-server 连接redis数据库（另开一个终端！！！！）
redis-cli 核心配置，在redis.windows.conf下
绑定IP：如果需要远程访问，可以将此注释，或绑定一个真是IP bind 127.0.0.1 端口：默认为6379 port 6379 日志文件 logfile &#34;Logs/redis_log.txt&#34; 数据库个数 databases 16 基本命令
检测 redis 服务是否启动 PING 设置键值对: set uname baizhan 取出键值对: get uname 删除键值对： del uname 查看所有键值对： keys * 删除所有的键值对 flushall 运行结果：
3. 应用redis缓存 ​ django中应用redis，目前一般使用第三方库 django-redis
​ 安装：pip install django-redis" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c1ffcdbe56dee7a13b3a8602b9e31b7e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-29T19:37:27+08:00" />
<meta property="article:modified_time" content="2022-11-29T19:37:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">117.Django-缓存redis</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1. 概述</h2> 
<p>​ 动态网站的基本权衡是，它们是动态的。每次用户请求页面时，Web服务器都会进行各种计算 - 从数据库查询到模板呈现再到业务逻辑 - 以创建站点访问者看到的页面。从处理开销的角度来看，这比标准的文件读取文件系统服务器要耗时多了。对于大多数Web应用程序来说，这种开销并不是什么大问题。因为大多数Web应用程序只是中小型网站，没有拥有一流的流量。但对于中到高流量的站点，尽可能减少开销是至关重要的，这就是缓存的用武之地。缓存某些内容是为了保存昂贵计算的结果，这样就不必在下次执行计算。</p> 
<p>​ Django框架带有一个强大的缓存系统，可以保存动态页面，因此不必为每个请求计算它们。Django提供不同级别的缓存粒度：可以缓存特定视图的输出，也可以只缓存页面中难以生成的部分或者可以缓存整个站点。</p> 
<p>​ Redis，是一个内存数据库（现在已经支持内存数据持久化到硬盘当中，重新启动时，会自动从硬盘进行加载），由于其性能极高，因此经常作为中间件、缓存使用。</p> 
<p>​ 本文档介绍就是Django框架使用Redis数据库来应用缓存框架</p> 
<h2><a id="2_WindowsRedis_12"></a>2. Windows开发环境下安装并使用Redis</h2> 
<p><strong>之前已经有学习过在Linux环境下使用Redis，这里就试试看使用Windows</strong></p> 
<p>​ redis默认不支持windows，由于一般开发环境在windows，因为需要使用第三方团队维护的windows版本，下载地址：</p> 
<p>​ <a href="https://github.com/tporadowski/redis/releases">window开发环境使用redis的安装包地址</a></p> 
<p>推荐使用稳定版本<br> <img src="https://images2.imgbox.com/ec/1e/zgWgwiGM_o.png" alt="在这里插入图片描述"></p> 
<p>​ 直接减压压缩包，安装好之后，启动redis</p> 
<p>​ 启动redis（如果没有配置环境变量，到解压好的文件夹中启用）：</p> 
<pre><code class="prism language-powershell">redis-server
</code></pre> 
<p><img src="https://images2.imgbox.com/59/e0/40Cn2r3o_o.png" alt="在这里插入图片描述"></p> 
<p>连接redis数据库（另开一个终端！！！！）</p> 
<pre><code class="prism language-powershell">redis-<span class="token function">cli</span>
</code></pre> 
<p>核心配置，在redis.windows.conf下</p> 
<pre><code class="prism language-powershell">绑定IP：如果需要远程访问，可以将此注释，或绑定一个真是IP
bind 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1

端口：默认为6379
port 6379

日志文件
logfile <span class="token string">"Logs/redis_log.txt"</span>

数据库个数
databases 16

</code></pre> 
<p>基本命令</p> 
<pre><code class="prism language-powershell">检测 redis 服务是否启动
PING

设置键值对:
<span class="token function">set</span> uname baizhan

取出键值对:
get uname

删除键值对：
<span class="token function">del</span> uname

查看所有键值对：
keys <span class="token operator">*</span>

删除所有的键值对
flushall
</code></pre> 
<p>运行结果：</p> 
<p><img src="https://images2.imgbox.com/a4/a2/zsoMbmbq_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_redis_81"></a>3. 应用redis缓存</h2> 
<p>​ django中应用redis，目前一般使用第三方库 django-redis</p> 
<p>​ 安装：pip install django-redis</p> 
<h3><a id="31_settings_89"></a>3.1 settings配置</h3> 
<pre><code class="prism language-python">CACHES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># default 是缓存名，可以配置多个缓存</span>
    <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment"># 应用 django-redis 库的 RedisCache 缓存类</span>
        <span class="token string">"BACKEND"</span><span class="token punctuation">:</span> <span class="token string">"django_redis.cache.RedisCache"</span><span class="token punctuation">,</span>
        <span class="token comment"># 配置正确的 ip和port</span>
        <span class="token string">"LOCATION"</span><span class="token punctuation">:</span> <span class="token string">"redis://127.0.0.1:6379"</span><span class="token punctuation">,</span>
        <span class="token string">"OPTIONS"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment"># redis客户端类</span>
            <span class="token string">"CLIENT_CLASS"</span><span class="token punctuation">:</span> <span class="token string">"django_redis.client.DefaultClient"</span><span class="token punctuation">,</span>
            <span class="token comment"># redis连接池的关键字参数</span>
            <span class="token string">"CONNECTION_POOL_KWARGS"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"max_connections"</span><span class="token punctuation">:</span> <span class="token number">100</span>
            <span class="token punctuation">}</span>
            <span class="token comment"># 如果 redis 设置了密码，那么这里需要设置对应的密码，如果redis没有设置密码，那么这里也不设置</span>
            <span class="token comment"># "PASSWORD": "123456",</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    
<span class="token punctuation">}</span>
</code></pre> 
<p>更多配置项：</p> 
<ul><li> <p>LOCATION：设置连接url，譬如：“redis://127.0.0.1:6379/0”，如果要设置redis主从连接，设置列表：[“redis://127.0.0.1:6379/1”, “redis://127.0.0.1:6378/1”]，第一个连接是 master 服务器</p> </li><li> <p>TIMEOUT：缓存的超时时间，单位秒，默认是 300秒，如果为None，表示缓存永不超时，如果为0，表示缓存立刻超时，相当于不使用缓存</p> </li><li> <p>LOCATION：支持使用 本地url符号作为连接，</p> <p>支持三种 URL scheme :</p> 
  <ol><li>redis://: 普通的 TCP 套接字连接 - redis://[:password]@localhost:6379/0</li><li>rediss://: SSL 包裹的 TCP 套接字连接 - rediss://[:password]@localhost:6379/0</li><li>unix://: Unix 域套接字连接 - unix://[:password]@/path/to/socket.sock?db=0</li></ol> <p>但是密码放在url中，不是很安全，所以建议使用示例中的方式</p> </li><li> <p>OPTIONS：</p> 
  <ul><li> <p>SOCKET_CONNECT_TIMEOUT：建立连接超时时间，单位秒</p> </li><li> <p>SOCKET_TIMEOUT：连接建立后，读写超时时间，单位秒</p> </li><li> <p>COMPRESSOR：默认不使用压缩，指定压缩的类，譬如"django_redis.compressors.zlib.ZlibCompressor"</p> </li><li> <p>IGNORE_EXCEPTIONS：默认为False，当Redis仅用于缓存时，连接异常或关闭后，忽略异常，不触发异常，可以设置为True，也可以全局设置 DJANGO_REDIS_LOG_IGNORED_EXCEPTIONS=True</p> </li><li> <p>PICKLE_VERSION：序列化使用的是pickle，默认情况下使用最新的pickle版本，这里可以设置指定版本号（设置为 -1 也是指最新版本）</p> </li><li> <p>CONNECTION_POOL_CLASS：设置自定义的连接池类</p> </li><li> <p>PARSER_CLASS：redis.connection.HiredisParser，可以这样设置，使用C写的redis客户端，性能更好</p> </li><li> <p>CLIENT_CLASS：设置一些特殊客户端类，譬如：</p> <p>分片客户端：</p> <pre><code class="prism language-python">CACHES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"BACKEND"</span><span class="token punctuation">:</span> <span class="token string">"django_redis.cache.RedisCache"</span><span class="token punctuation">,</span>
        <span class="token string">"LOCATION"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"redis://127.0.0.1:6379/1"</span><span class="token punctuation">,</span>
            <span class="token string">"redis://127.0.0.1:6379/2"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"OPTIONS"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"CLIENT_CLASS"</span><span class="token punctuation">:</span> <span class="token string">"django_redis.client.ShardClient"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>集群客户端：</p> <pre><code class="prism language-python">CACHES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"BACKEND"</span><span class="token punctuation">:</span> <span class="token string">"django_redis.cache.RedisCache"</span><span class="token punctuation">,</span>
        <span class="token string">"LOCATION"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"redis://127.0.0.1:6379/1"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"OPTIONS"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"CLIENT_CLASS"</span><span class="token punctuation">:</span> <span class="token string">"django_redis.client.HerdClient"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>SERIALIZER：设置序列化，如 “django_redis.serializers.json.JSONSerializer”</p> </li></ul> </li></ul> 
<p>全局配置，即设置在settings最外层的配置项：</p> 
<pre><code class="prism language-python"><span class="token comment"># 给所有缓存配置相同的忽略行为</span>
DJANGO_REDIS_LOG_IGNORED_EXCEPTIONS  <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 设置指定的 logger 输出日志， 需要设置logger</span>
DJANGO_REDIS_LOGGER <span class="token operator">=</span> <span class="token string">'some.specified.logger'</span>
</code></pre> 
<h3><a id="32_redis_198"></a>3.2 手动操作redis</h3> 
<p>通过配置获取django_redis的get_redis_connection，进行操作，如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django_redis <span class="token keyword">import</span> get_redis_connection

conn <span class="token operator">=</span> get_redis_connection<span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">)</span>  <span class="token comment"># redis.client.StrictRedis</span>
<span class="token comment"># 支持所有redis的接口</span>
conn<span class="token punctuation">.</span>hset<span class="token punctuation">(</span><span class="token string">'hash_test'</span><span class="token punctuation">,</span><span class="token string">'k1'</span><span class="token punctuation">,</span><span class="token string">'v1'</span><span class="token punctuation">)</span>

<span class="token comment"># 也可以手动将数据清除</span>
get_redis_connection<span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flushall<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 得知连接池的连接数</span>
get_redis_connection<span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>connection_pool
</code></pre> 
<p>运行结果</p> 
<p><img src="https://images2.imgbox.com/28/1d/y4JJPSKm_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c7/be/KvQuWQ7t_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33__222"></a>3.3 全站缓存</h3> 
<p>主要使用两个中间件实现：</p> 
<ul><li> <p>FetchFromCacheMiddleware ：从缓存中读取数据</p> 
  <ul><li>缓存状态为200的GET和HEAD请求的响应（除非响应头中设置不进行缓存）</li><li>对具有不同查询参数的相同URL的请求的响应被认为是各自不同的页面，并且被分别单独缓存。</li><li>该中间件会使用与对应的GET请求相同的响应头来回答HEAD请求，即可以为HEAD请求返回缓存的GET响应。</li></ul> </li><li> <p>UpdateCacheMiddleware ：将数据更新到缓存中</p> 
  <ul><li> <p>该中间件会自动在每个响应中设置几个headers：</p> 
    <ul><li>设置Expires为当前日期/时间 加上 定义的CACHE_MIDDLEWARE_SECONDS值，GMT时间</li><li>设置响应的Cache-Control的max-age，值是定义的CACHE_MIDDLEWARE_SECONDS值。</li></ul> </li><li> <p>如果视图设置了自己的缓存时间（即设置了Cache-Control 的max age），那么页面将被缓存直到到期时间，而不是CACHE_MIDDLEWARE_SECONDS。</p> <p>使用装饰器 django.views.decorators.cache可以设置视图的到期时间（使用cache_control()装饰器，代码：@cache_control(max_age=3600)）或禁用视图的缓存（使用never_cache()装饰器，代码：@never_cache）</p> </li><li> <p>如果USE_I18N设置为True，则生成的缓存key将包含当前语言的名称，这样可以轻松缓存多语言网站，而无需自己创建缓存密钥。</p> </li><li> <p>如果 USE_L10N设置为True 并且 USE_TZ被设置为True，缓存key也会包括当前语言</p> </li></ul> </li></ul> 
<p>在settings的中间件中设置：</p> 
<pre><code class="prism language-python">MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.middleware.cache.UpdateCacheMiddleware'</span><span class="token punctuation">,</span>
    
    <span class="token comment"># 其他中间件...</span>
    
    <span class="token string">'django.middleware.cache.FetchFromCacheMiddleware'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>PS：UpdateCacheMiddleware必须是第一个中间件，FetchFromCacheMiddleware必须是最后一个中间件</p> 
<p>然后，将以下必需设置添加到Django的settings文件中：</p> 
<ul><li>CACHE_MIDDLEWARE_ALIAS - 用于存储的缓存别名。</li><li>CACHE_MIDDLEWARE_SECONDS - 每个页面应缓存的秒数。</li><li>CACHE_MIDDLEWARE_KEY_PREFIX - 用于生成缓存key的前缀，如果使用相同的Django安装在多个站点之间共享缓存，请将其设置为站点名称或此Django实例特有的其他字符串，以防止发生密钥冲突。如果你不在乎，请使用空字符串。</li></ul> 
<p><strong>应用测试</strong><br> 在settings中</p> 
<pre><code class="prism language-python">MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

ROOT_URLCONF <span class="token operator">=</span> <span class="token string">'redis_study.urls'</span>

TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.template.backends.django.DjangoTemplates'</span><span class="token punctuation">,</span>
        <span class="token string">'DIRS'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'APP_DIRS'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">'django.template.context_processors.debug'</span><span class="token punctuation">,</span>
                <span class="token string">'django.template.context_processors.request'</span><span class="token punctuation">,</span>
                <span class="token string">'django.contrib.auth.context_processors.auth'</span><span class="token punctuation">,</span>
                <span class="token string">'django.contrib.messages.context_processors.messages'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

WSGI_APPLICATION <span class="token operator">=</span> <span class="token string">'redis_study.wsgi.application'</span>


<span class="token comment"># Database</span>
<span class="token comment"># https://docs.djangoproject.com/en/3.2/ref/settings/#databases</span>

DATABASES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'django.db.backends.sqlite3'</span><span class="token punctuation">,</span>
        <span class="token string">'NAME'</span><span class="token punctuation">:</span> BASE_DIR <span class="token operator">/</span> <span class="token string">'db.sqlite3'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment"># Password validation</span>
<span class="token comment"># https://docs.djangoproject.com/en/3.2/ref/settings/#auth-password-validators</span>

AUTH_PASSWORD_VALIDATORS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">'NAME'</span><span class="token punctuation">:</span> <span class="token string">'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">'NAME'</span><span class="token punctuation">:</span> <span class="token string">'django.contrib.auth.password_validation.NumericPasswordValidator'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token comment"># 配置redis缓存</span>
CACHES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># default 是缓存名，可以配置多个缓存</span>
    <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment"># 应用 django-redis 库的 RedisCache 缓存类</span>
        <span class="token string">"BACKEND"</span><span class="token punctuation">:</span> <span class="token string">"django_redis.cache.RedisCache"</span><span class="token punctuation">,</span>
        <span class="token comment"># 配置正确的 ip和port</span>
        <span class="token string">"LOCATION"</span><span class="token punctuation">:</span> <span class="token string">"redis://127.0.0.1:6379"</span><span class="token punctuation">,</span>
        <span class="token string">"OPTIONS"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment"># redis客户端类</span>
            <span class="token string">"CLIENT_CLASS"</span><span class="token punctuation">:</span> <span class="token string">"django_redis.client.DefaultClient"</span><span class="token punctuation">,</span>
            <span class="token comment"># redis连接池的关键字参数</span>
            <span class="token string">"CONNECTION_POOL_KWARGS"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"max_connections"</span><span class="token punctuation">:</span> <span class="token number">100</span>
            <span class="token punctuation">}</span>
            <span class="token comment"># 如果 redis 设置了密码，那么这里需要设置对应的密码，如果redis没有设置密码，那么这里也不设置</span>
            <span class="token comment"># "PASSWORD": "123456",</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 全栈缓存配置</span>
CACHE_MIDDLEWARE_ALIAS <span class="token operator">=</span> <span class="token string">'default'</span> <span class="token comment"># 用户存储的缓存别名</span>
CACHE_MIDDLEWARE_SECONDS <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment"># 缓存的秒数</span>
CACHE_MIDDLEWARE_KEY_PREFIX <span class="token operator">=</span> <span class="token string">''</span> <span class="token comment"># 生成缓存的前缀</span>
</code></pre> 
<p>在views中</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time
<span class="token comment"># @never_cache # 禁用缓存</span>
<span class="token keyword">def</span> <span class="token function">global_cache_test</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'全栈缓存测试，时间戳t:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>t<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>PS：</strong> 若不添加中间件的时候，刷新页面，在规定时间内，时间是不会发生变化的，会被保存到redis中，二次刷新时，从redis中读取。过期后无法进行读取<br> <img src="https://images2.imgbox.com/60/6f/SlwDCbzI_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="34__369"></a>3.4 视图函数缓存</h3> 
<ol><li>通过装饰器cache_page</li></ol> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@cache_page</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> cache<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">,</span> key_prefix<span class="token operator">=</span><span class="token string">'redis_app_view_cache_test'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">view_cache_test</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> num<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'视图缓存测试,时间戳t:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>t<span class="token punctuation">}</span></span><span class="token string">, num:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<p>说明：</p> 
<ul><li> <p>cache_page除了默认的timeout参数外，还有两个可选的关键字参数</p> 
  <ul><li>cache，示例代码：@cache_page(60 * 15, cache=“special_cache”)， 该cache指向settings中配置的缓存的名称，默认是"default"</li><li>key_prefix：缓存key的前缀，与CACHE_MIDDLEWARE_KEY_PREFIX功能相同</li></ul> </li><li> <p>如果多个url指向同一个视图函数，会为每个url建立一个单独的缓存，例如：</p> </li></ul> 
<ol start="2"><li> <p>通过urls中配置cache_page</p> <p>在URLconf中指定视图缓存，而不是在视图函数上硬编码装饰器，可以进一步解耦缓存和视图函数之间的关系，使用起来更灵活</p> </li></ol> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>cache <span class="token keyword">import</span> cache_page
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'connect_redis_test/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>connect_redis_test<span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'global_cache_test/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>global_cache_test<span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'view_cache_test/&lt;int:num&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>view_cache_test<span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'view_cache/'</span><span class="token punctuation">,</span> cache_page<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">(</span>views<span class="token punctuation">.</span>view_cache_test<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/91/12/MQMJtciq_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="35__414"></a>3.5 模板文件缓存</h3> 
<p>​ 使用cache模板标记缓存模板片段</p> 
<ol><li>引入TemplateTag</li></ol> 
<pre><code class="prism language-python">  <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> load cache <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>使用缓存</li></ol> 
<pre><code class="prism language-python">  <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> cache <span class="token number">5000</span> cache_key <span class="token operator">%</span><span class="token punctuation">}</span>
         缓存内容
  <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endcache <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>说明：</p> 
<p>cache最少两个参数：</p> 
<ul><li> <p>5000： 缓存超时时间，单位秒，如果为None，那么就是永久缓存</p> </li><li> <p>cache_key：缓存的key，不能使用变量，只是一个字符串（不要引号），相当于CACHE_MIDDLEWARE_KEY_PREFIX</p> </li></ul> 
<p><strong>应用：</strong></p> 
<pre><code class="prism language-xml"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
{% load cache %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    {% cache 20 template_cache_key %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>使用模板文件缓存<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>时间戳：{<!-- -->{time}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    {% endcache %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e0/4f/VAOMoOqm_o.png" alt="在这里插入图片描述"></p> 
<p>可以通过将一个或多个附加参数（可以是带或不带过滤器的变量，变量个数可以是多个，如：{% cache 500 sidebar var1 var2 var3 … %}）传递给 cache 来唯一标识缓存片段来执行此操作，示例如下：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> load cache <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> cache <span class="token number">500</span> sidebar request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username <span class="token operator">%</span><span class="token punctuation">}</span>
    指定登录用户的侧边栏
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endcache <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>如果USE_I18N设置为True，每站点中间件缓存将根据语言进行区分，对于cache模板标记，可以使用模板中可用的特定于 转换的变量 来实现相同的结果，示例如下：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> load i18n <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> load cache <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> get_current_language <span class="token keyword">as</span> LANGUAGE_CODE <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> cache <span class="token number">600</span> welcome LANGUAGE_CODE <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> trans <span class="token string">"Welcome to example.com"</span> <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endcache <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>缓存超时可以是模板变量，使用变量可以避免多次使用同一个值，示例（假设my_timeout设置为 600）：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> cache my_timeout sidebar <span class="token operator">%</span><span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endcache <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>默认情况下，cache将尝试使用名为“template_fragments”的缓存。如果不存在此缓存，则使用默认的default缓存。可以通过using关键字参数指定使用的缓存，该关键字参数必须是标记的最后一个参数，示例：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> cache <span class="token number">300</span> cache_key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> using<span class="token operator">=</span><span class="token string">"localcache"</span> <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>PS：指定不存在的 缓存名 会报错</p> 
<p><strong>使用超参数在路由中：</strong><br> 会当成多个路径，分别保存。但是时间保存的值不发生变化<br> <img src="https://images2.imgbox.com/5e/90/UlX0BNGX_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-xml"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
{% load cache %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    {% cache 20 template_cache_key n %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>使用模板文件缓存<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>时间戳：{<!-- -->{time}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>n:{<!-- -->{n}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    {% endcache %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">template_cache</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    context <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'time'</span><span class="token punctuation">:</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'n'</span><span class="token punctuation">:</span>n<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'redis_app/template_cache.html'</span><span class="token punctuation">,</span>context<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="36__543"></a>3.6 低级缓存</h3> 
<p>有时不想缓存整个页面数据，而只是想缓存某些费时查询并且基本不会改变的数据，可以通过一个简单的低级缓存API实现，该API可以缓存任何可以安全pickle的Python对象：字符串，字典，模型对象列表等</p> 
<ol><li> <p>django.core.cache.caches</p> <pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>cache <span class="token keyword">import</span> caches
cache1 <span class="token operator">=</span> caches<span class="token punctuation">[</span><span class="token string">'myalias'</span><span class="token punctuation">]</span>
cache2 <span class="token operator">=</span> caches<span class="token punctuation">[</span><span class="token string">'myalias'</span><span class="token punctuation">]</span>
<span class="token comment"># 判断为True</span>
<span class="token keyword">if</span> cache1 <span class="token keyword">is</span> cache2<span class="token punctuation">:</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <p>说明：</p> 
  <ul><li> <p>可以通过CACHES类似字典一样的方式访问settings中配置的缓存，在同一个线程中重复请求相同的别名将返回相同的对象</p> </li><li> <p>如果指定的 myalias 不存在，将引发 InvalidCacheBackendError</p> </li><li> <p>为了线程安全性，为会每个线程返回缓存的不同实例</p> </li><li> <p>作为快捷方式， 默认缓存(default)可以使用 django.core.cache.cache ：</p> <pre><code class="prism language-python"><span class="token comment"># 使用 default 缓存</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>cache <span class="token keyword">import</span> cache

<span class="token comment"># 上面的cache等同于下面的写法</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>cache <span class="token keyword">import</span> caches
cache <span class="token operator">=</span> caches<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span>
</code></pre> </li></ul> </li><li> <p>django.core.cache.cache</p> </li></ol> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>cache <span class="token keyword">import</span> cache

<span class="token comment"># 使用 redis 的一般用法</span>
cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">'manul_set'</span><span class="token punctuation">,</span> <span class="token string">'ok'</span><span class="token punctuation">)</span>
manul_set <span class="token operator">=</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'manul_set'</span><span class="token punctuation">)</span>

<span class="token comment"># 可以手动设置 timeout，如果不指定timeout，默认是 300秒</span>
cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>

<span class="token comment"># 可以获取key的超时设置（ttl：time to live）</span>
<span class="token comment"># 返回值的3种情况：</span>
<span class="token comment"># 0： key 不存在 (或已过期)</span>
<span class="token comment"># None： key 存在但没有设置过期</span>
<span class="token comment"># ttl： 任何有超时设置的 key 的超时值</span>
cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">)</span>
cache<span class="token punctuation">.</span>ttl<span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span> <span class="token comment"># 得到 25 </span>
cache<span class="token punctuation">.</span>ttl<span class="token punctuation">(</span><span class="token string">"not-existent"</span><span class="token punctuation">)</span> <span class="token comment"># 得到 0</span>

<span class="token comment"># 让一个值永久存在</span>
cache<span class="token punctuation">.</span>persist<span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span>
cache<span class="token punctuation">.</span>ttl<span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span> <span class="token comment"># 得到 None</span>

<span class="token comment"># 指定一个新的过期时间</span>
cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"bar"</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">)</span>
cache<span class="token punctuation">.</span>ttl<span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span> <span class="token comment"># 得到 22</span>
cache<span class="token punctuation">.</span>expire<span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
cache<span class="token punctuation">.</span>ttl<span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span> <span class="token comment"># 得到 5</span>

<span class="token comment"># 支持 redis 分布式锁， 使用 上下文管理器 分配锁</span>
<span class="token keyword">with</span> cache<span class="token punctuation">.</span>lock<span class="token punctuation">(</span><span class="token string">"somekey"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    do_some_thing<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token comment"># 使用全局通配符的方式来检索或者删除键</span>
cache<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token string">"foo_*"</span><span class="token punctuation">)</span>  <span class="token comment"># 返回所有匹配的值, 如 ["foo_1", "foo_2"]</span>

<span class="token comment"># 使用 iter_keys 取代keys 得到 一个迭代器</span>
cache<span class="token punctuation">.</span>iter_keys<span class="token punctuation">(</span><span class="token string">"foo_*"</span><span class="token punctuation">)</span>  <span class="token comment"># 得到一个迭代器</span>
<span class="token builtin">next</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>iter_keys<span class="token punctuation">(</span><span class="token string">"foo_*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 得到 foo_1</span>

<span class="token comment"># 删除 键</span>
cache<span class="token punctuation">.</span>delete_pattern<span class="token punctuation">(</span><span class="token string">"foo_*"</span><span class="token punctuation">)</span>  <span class="token comment"># 支持通配符</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/50/d8/aEiXhc60_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="37__626"></a>3.7 低级缓存的应用</h3> 
<ol><li>视图函数</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> HttpResponse
<span class="token keyword">from</span> django_redis <span class="token keyword">import</span> get_redis_connection
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>cache <span class="token keyword">import</span> never_cache<span class="token punctuation">,</span> cache_page
<span class="token comment"># 低级缓存测试</span>
<span class="token keyword">from</span> common<span class="token punctuation">.</span>lower_level_cache <span class="token keyword">import</span> get_lower_level_func
<span class="token keyword">def</span> <span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'lower_level_cache'</span>

<span class="token keyword">def</span> <span class="token function">lower_level_cache</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># result = get_result()</span>
    result <span class="token operator">=</span> get_lower_level_func<span class="token punctuation">(</span><span class="token string">'str_key'</span><span class="token punctuation">,</span> get_result<span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'低级缓存result:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

</code></pre> 
<ol start="2"><li> <p>缓存函数</p> <p>在公共包中创建py文件，定义缓存函数</p> </li></ol> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>cache <span class="token keyword">import</span> cache
<span class="token comment"># 用于缓存数据</span>
<span class="token keyword">def</span> <span class="token function">get_lower_level_func</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    key:缓存key
    func:调用的函数名, 用于缓存数据的名称
    args:可变参数
    kwargs:关键字参数
    '''</span>
    <span class="token keyword">with</span> cache<span class="token punctuation">.</span>lock<span class="token punctuation">(</span>key<span class="token operator">+</span><span class="token string">'_lock'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> key<span class="token punctuation">:</span>
            <span class="token comment">#从低级缓存根据key获取值</span>
            result <span class="token operator">=</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> result<span class="token punctuation">:</span>
                <span class="token keyword">return</span> result
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># 调用函数获取结果</span>
                result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
                <span class="token comment"># 将调用的结果存放到缓存中</span>
                cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>result<span class="token punctuation">)</span>
                <span class="token keyword">return</span> result

</code></pre> 
<p><img src="https://images2.imgbox.com/eb/1a/uTEjBICg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="38_session_681"></a>3.8 session缓存</h3> 
<pre><code class="prism language-python"><span class="token comment"># 配置session的引擎为cache</span>
SESSION_ENGINE <span class="token operator">=</span> <span class="token string">'django.contrib.sessions.backends.cache'</span>
<span class="token comment"># 此处别名依赖缓存的设置</span>
SESSION_CACHE_ALIAS <span class="token operator">=</span> <span class="token string">'default'</span>  
</code></pre> 
<ol><li>路由配置</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>cache <span class="token keyword">import</span> cache_page
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views
app_name <span class="token operator">=</span> <span class="token string">'redis_app'</span>
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'login/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>login<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'index/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

</code></pre> 
<ol start="2"><li>视图函数</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> HttpResponse<span class="token punctuation">,</span> redirect
<span class="token keyword">from</span> django_redis <span class="token keyword">import</span> get_redis_connection
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>cache <span class="token keyword">import</span> never_cache<span class="token punctuation">,</span> cache_page
<span class="token comment"># session缓存</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'redis_app/login.html'</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        uname <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'uname'</span><span class="token punctuation">)</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> uname <span class="token operator">==</span> <span class="token string">'root'</span> <span class="token keyword">and</span> password <span class="token operator">==</span> <span class="token string">'root'</span><span class="token punctuation">:</span><span class="token comment"># 固定账号密码，测试用</span>
            <span class="token comment"># 登录成功</span>
            <span class="token comment"># 将用户名存放到session</span>
            request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'uname'</span><span class="token punctuation">]</span> <span class="token operator">=</span> uname
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'redis_app:index'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'redis_app:login'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    uname <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'uname'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> uname<span class="token punctuation">:</span> <span class="token comment"># 跳转到主页</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'redis_app/index.html'</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token string">'uname'</span><span class="token punctuation">:</span>uname<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'redis_app:login'</span><span class="token punctuation">)</span>


</code></pre> 
<ol start="3"><li> <p>页面</p> <p>login.html页面</p> <pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{%url 'redis_app:login'%}<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% csrf_token %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>用户名：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>uname<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>index.html页面</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>欢迎{<!-- -->{uname}}登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>运行结果</p> </li></ol> 
<p><img src="https://images2.imgbox.com/df/e2/ZEWyYwFq_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9bb779f9ba6c15b54499784ce41b5599/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Android App】GPS获取定位经纬度和根据经纬度获取详细地址讲解及实战（附源码和演示 超详细）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/89770bafb39c404d8bc0915a770a2524/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java之okhttp3请求方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>