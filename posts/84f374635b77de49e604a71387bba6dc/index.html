<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>花卉识别(tensorflow) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="花卉识别(tensorflow)" />
<meta property="og:description" content="参考教材：人工智能导论(第4版) 王万良 高等教育出版社
实验环境：Python3.6 &#43; Tensor flow 1.12
人工智能导论实验导航 实验一：斑马问题 https://blog.csdn.net/weixin_46291251/article/details/122246347
实验二：图像恢复 https://blog.csdn.net/weixin_46291251/article/details/122561220
实验三：花卉识别 https://blog.csdn.net/weixin_46291251/article/details/122561505
实验四：手写体生成 https://blog.csdn.net/weixin_46291251/article/details/122576478
实验源码： xxx
3.1实验介绍 3.1.1实验背景 深度学习为人工智能核心技术，本章主要围绕深度学习涉及的全连接神经网络、卷积神经网络和对抗神经网络而开设的实验。
卷积神经网络（Convolutional Neural Networks, CNN）是一类包含卷积计算且具有深度结构的前馈神经网络（Feedforward Neural Networks），是深度学习（deep learning）的代表算法之一 。卷积神经网络具有表征学习（representation learning）能力，能够按其阶层结构对输入信息进行平移不变分类（shift-invariant classification）
3.1.2实验目的 本章实验的主要目的是掌握深度学习相关基础知识点，了解深度学习相关基础知识，经典全连接神经网络、卷积神经网络和对抗神经网络。掌握不同神经网络架构的设计原理，熟悉使用Tensorflow 2.1深度学习框架实现深度学习实验的一般流程。
3.1.3实验简介 随着电子技术的迅速发展,人们使用便携数码设备(如手机、相机等)获取花卉图像越来越方便,如何自动识别花卉种类受到了广泛的关注。由于花卉所处背景的复杂性,以及花卉自身的类间相似性和类内多样性,利用传统的手工提取特征进行图像分类的方法,并不能很好地解决花卉图像分类这一问题。
本实验基于卷积神经网络实现的花卉识别实验与传统图像分类方法不同,卷积神经网络无需人工提取特征,可以根据输入图像,自动学习包含丰富语义信息的特征,得到更为全面的花卉图像特征描述,可以很好地表达图像不同类别的信息。
3.2概要设计 本实验将用户在客户端选取的花卉图像作为输入，运行花卉识别模型，实时返回识别结果作为输出结果并显示给用户。
3.2.1功能结构 花卉识别实验总体设计如下图所示，该实验可以划分为数据处理、模型构建、图像识别三个主要的子实验。
其中数据处理子实验包括数据集划分、图像预处理两个部分；
模型构建子实验主要包括模型定义、模型训练以及模型部署三个部分；
图像识别子实验内容主要包括读取花卉图像、运行推断模型进行图像特征提取，输出模型识别结果三个部分。
3.2.2体系结构 按照体系结构划分，整个实验的体系结构可以划分为三部分，分别为模型训练、模型保存和模型推理，如图5-3所示。各层侧重点各不相同。
训练层运行在安装有tensorflow框架的服务器，最好配置计算加速卡。
推断层运行于开发环境，能够支持卷积神经网络的加速。
展示层运行于客户端应用程序，能够完成图像选择并实时显示推断层的计算结果。
各层之间存在单向依赖关系。推断层需要的网络模型由训练层提供，并根据需要进行必要的格式转换或加速重构。相应的，展示层要显示的元数据需要由推断层计算得到。
3.3详细设计 3.3.1导入实验环境 步骤 1导入相应的模块 skimage包主要用于图像数据的处理，在该实验当中， io模块主要用于图像数据的读取（imread）和输出（imshow）操作，transform模块主要用于改变图像的大小（resize函数）；
glob包主要用于查找符合特定规则的文件路径名，跟使用windows下的文件搜索相似；
os模块主要用于处理文件和目录，比如：获取当前目录下文件，删除制定文件，改变目录，查看文件大小等；
tensorflow是目前业界最流行的深度学习框架之一，在图像，语音，文本，目标检测等领域都有深入的应用，也是该实验的核心，主要用于定义占位符，定义变量，创建卷积神经网络模型；numpy是一个基于python的科学计算包，在该实验中主要用来处理数值运算；
time模块主要用于处理时间系列的数据，在该实验主要用于返回当前时间戳，计算脚本每个epoch运行所需要的时间。
# 导入模块 # -*- coding:uft-8 #from skimage import glob import os import cv2 import tensorflow as tf from tensorflow." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/84f374635b77de49e604a71387bba6dc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-10T11:37:33+08:00" />
<meta property="article:modified_time" content="2022-02-10T11:37:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">花卉识别(tensorflow)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>参考教材：人工智能导论(第4版) 王万良 高等教育出版社<br> 实验环境：Python3.6 + Tensor flow 1.12</p> 
</blockquote> 
<p><kbd> <mark>人工智能导论实验导航</mark> </kbd></p> 
<p><mark>实验一：斑马问题</mark> <a href="https://blog.csdn.net/weixin_46291251/article/details/122246347">https://blog.csdn.net/weixin_46291251/article/details/122246347</a></p> 
<p><mark>实验二：图像恢复</mark> <a href="https://blog.csdn.net/weixin_46291251/article/details/122561220">https://blog.csdn.net/weixin_46291251/article/details/122561220</a></p> 
<p><mark>实验三：花卉识别</mark> <a href="https://blog.csdn.net/weixin_46291251/article/details/122561505">https://blog.csdn.net/weixin_46291251/article/details/122561505</a></p> 
<p><mark>实验四：手写体生成</mark> <a href="https://blog.csdn.net/weixin_46291251/article/details/122576478">https://blog.csdn.net/weixin_46291251/article/details/122576478</a></p> 
<p><mark>实验源码：</mark> xxx</p> 
<h2><a id="31_14"></a>3.1实验介绍</h2> 
<h3><a id="311_15"></a>3.1.1实验背景</h3> 
<p>深度学习为人工智能核心技术，本章主要围绕深度学习涉及的全连接神经网络、卷积神经网络和对抗神经网络而开设的实验。<br> 卷积神经网络（Convolutional Neural Networks, CNN）是一类包含卷积计算且具有深度结构的前馈神经网络（Feedforward Neural Networks），是深度学习（deep learning）的代表算法之一 。卷积神经网络具有表征学习（representation learning）能力，能够按其阶层结构对输入信息进行平移不变分类（shift-invariant classification）</p> 
<h3><a id="312_18"></a>3.1.2实验目的</h3> 
<p>本章实验的主要目的是掌握深度学习相关基础知识点，了解深度学习相关基础知识，经典全连接神经网络、卷积神经网络和对抗神经网络。掌握不同神经网络架构的设计原理，熟悉使用Tensorflow 2.1深度学习框架实现深度学习实验的一般流程。</p> 
<h3><a id="313_21"></a>3.1.3实验简介</h3> 
<p>随着电子技术的迅速发展,人们使用便携数码设备(如手机、相机等)获取花卉图像越来越方便,如何自动识别花卉种类受到了广泛的关注。由于花卉所处背景的复杂性,以及花卉自身的类间相似性和类内多样性,利用传统的手工提取特征进行图像分类的方法,并不能很好地解决花卉图像分类这一问题。<img src="https://images2.imgbox.com/61/9f/e2Vrgpj1_o.png" alt="在这里插入图片描述"></p> 
<p>本实验基于卷积神经网络实现的花卉识别实验与传统图像分类方法不同,卷积神经网络无需人工提取特征,可以根据输入图像,自动学习包含丰富语义信息的特征,得到更为全面的花卉图像特征描述,可以很好地表达图像不同类别的信息。</p> 
<h2><a id="32_28"></a>3.2概要设计</h2> 
<p>本实验将用户在客户端选取的花卉图像作为输入，运行花卉识别模型，实时返回识别结果作为输出结果并显示给用户。</p> 
<h3><a id="321_30"></a>3.2.1功能结构</h3> 
<p>花卉识别实验总体设计如下图所示，该实验可以划分为数据处理、模型构建、图像识别三个主要的子实验。<br> 其中数据处理子实验包括数据集划分、图像预处理两个部分；<br> 模型构建子实验主要包括模型定义、模型训练以及模型部署三个部分；<br> 图像识别子实验内容主要包括读取花卉图像、运行推断模型进行图像特征提取，输出模型识别结果三个部分。<img src="https://images2.imgbox.com/64/5b/Vtog0oYv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="322_39"></a>3.2.2体系结构</h3> 
<p>按照体系结构划分，整个实验的体系结构可以划分为三部分，分别为模型训练、模型保存和模型推理，如图5-3所示。各层侧重点各不相同。<br> 训练层运行在安装有tensorflow框架的服务器，最好配置计算加速卡。<br> 推断层运行于开发环境，能够支持卷积神经网络的加速。<br> 展示层运行于客户端应用程序，能够完成图像选择并实时显示推断层的计算结果。<br> 各层之间存在单向依赖关系。推断层需要的网络模型由训练层提供，并根据需要进行必要的格式转换或加速重构。相应的，展示层要显示的元数据需要由推断层计算得到。<br> <img src="https://images2.imgbox.com/2f/9f/cwRpzEgc_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="33_49"></a>3.3详细设计</h2> 
<h3><a id="331_50"></a>3.3.1导入实验环境</h3> 
<h4><a id="_1_51"></a>步骤 1导入相应的模块</h4> 
<p>skimage包主要用于图像数据的处理，在该实验当中， io模块主要用于图像数据的读取（imread）和输出（imshow）操作，transform模块主要用于改变图像的大小（resize函数）；<br> glob包主要用于查找符合特定规则的文件路径名，跟使用windows下的文件搜索相似；<br> os模块主要用于处理文件和目录，比如：获取当前目录下文件，删除制定文件，改变目录，查看文件大小等；<br> tensorflow是目前业界最流行的深度学习框架之一，在图像，语音，文本，目标检测等领域都有深入的应用，也是该实验的核心，主要用于定义占位符，定义变量，创建卷积神经网络模型；numpy是一个基于python的科学计算包，在该实验中主要用来处理数值运算；<br> time模块主要用于处理时间系列的数据，在该实验主要用于返回当前时间戳，计算脚本每个epoch运行所需要的时间。</p> 
<pre><code class="prism language-python"><span class="token comment"># 导入模块</span>
<span class="token comment"># -*- coding:uft-8</span>
<span class="token comment">#from  skimage  </span>
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> os
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span>  tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras <span class="token keyword">import</span> layers<span class="token punctuation">,</span> optimizers<span class="token punctuation">,</span> datasets<span class="token punctuation">,</span> Sequential
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
</code></pre> 
<h4><a id="_2_72"></a>步骤 2设置初始化环境</h4> 
<pre><code class="prism language-python"><span class="token comment"># 数据集的地址，改为自己的图片文件地址</span>
path <span class="token operator">=</span> <span class="token string">'./flower_photos/'</span>
<span class="token comment"># 缩放图片大小为100*100，C为通道，彩色图片数值为3</span>
w <span class="token operator">=</span> <span class="token number">100</span>
h <span class="token operator">=</span> <span class="token number">100</span>
c <span class="token operator">=</span> <span class="token number">3</span>

types <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 所有花的种类数,也是标签的个数</span>
flower <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'bee'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'blackberry'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'blanket'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'bougainvillea'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">'bromelia'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">'foxglove'</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="332_88"></a>3.3.2数据准备</h3> 
<p>这里通过os.listdir判断给定目录下的是文件还是文件夹，如果是文件夹，那么就进入读取其中的所有文件，这些图像对应的标签就是他们所属的文件夹的编号，遍历完所有子文件夹(这里不限制文件夹数目，可以动态的识别出文件夹)之后便完成了数据集的读取，函数返回读取到的所有图片和图片对应的标签。</p> 
<pre><code class="prism language-python"><span class="token comment"># 读取图片</span>
<span class="token keyword">def</span> <span class="token function">read_img</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> types
    <span class="token keyword">global</span> flower
    imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"路径不正确"</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> s <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nfolder  "</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
        f_label <span class="token operator">=</span> s<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        flower<span class="token punctuation">[</span>types<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># flower[f_label]=s.split("_")[0]</span>

        s <span class="token operator">=</span> path <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"/"</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 只读文件夹</span>
            <span class="token keyword">continue</span>

        types <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment"># 数据集数目加1</span>

        <span class="token keyword">for</span> im <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
            im <span class="token operator">=</span> s <span class="token operator">+</span> im
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\r\tloading :%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> io<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>im<span class="token punctuation">)</span>
            img <span class="token operator">=</span> transform<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
            imgs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token comment"># labels.append(f_label)</span>
            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>types <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="333_129"></a>3.3.3构建花卉识别模型</h3> 
<p>CNN训练模型<br> 模型尺寸分析：卷积层全都采用了补0，所以经过卷积层长和宽不变，只有深度加深。池化层全都没有补0，所以经过池化层长和宽均减小，深度不变。<br> 模型尺寸变化：100×100×3-&gt;100×100×32-&gt;50×50×32-&gt;50×50×64-&gt;25×25×64-&gt;25×25×128-&gt;12×12×128-&gt;12×12×128-&gt;6×6×128<br> 本文的CNN模型比较简单，后续完全可以通过增大模型复杂度或者改参数调试以及对图像进行预处理来提高准确率。</p> 
<p>下面列出网络模型的部分：<br> 这里首先用tf.getvariable创建新的tensorflow变量并用tf.tf.constant_initializer<br> 和tf.constant_initializer初始化为(stddev=0.1)和（0.0）<br> 然后用 tf.nn.conv2d创建2维卷积层步长参数为[1,1,1,1]，卷积方式为’SAME’<br> 然后用线性整流函数relu进行处理</p> 
<pre><code class="prism language-python">   <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'layer1-conv1'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        conv1_weights <span class="token operator">=</span> 			tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"weight"</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        conv1_biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"bias"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        conv1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> conv1_weights<span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>
        relu1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv1<span class="token punctuation">,</span> conv1_biases<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>下面类似：</p> 
<pre><code class="prism language-python"><span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'layer11-fc3'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        fc3_weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"weight"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                      initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> regularizer <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>add_to_collection<span class="token punctuation">(</span><span class="token string">'losses'</span><span class="token punctuation">,</span> regularizer<span class="token punctuation">(</span>fc3_weights<span class="token punctuation">)</span><span class="token punctuation">)</span>
        fc3_biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"bias"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        logit <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc2<span class="token punctuation">,</span> fc3_weights<span class="token punctuation">)</span> <span class="token operator">+</span> fc3_biases
</code></pre> 
<p>下面是池化操作：利用tf.nn.max_pool完成，池化窗口大小为[1,2,2,1]，填充方式为VALID表示不填充，窗口在每一个维度上滑动的步长为[1,2,2,1]</p> 
<pre><code class="prism language-python"><span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">"layer4-pool2"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pool2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>relu2<span class="token punctuation">,</span> ksize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="334_171"></a>3.3.4训练并保存模型</h3> 
<p>下面给出部分训练模型的代码：</p> 
<p>训练过程中输出每一次训练的train loss 、train acc、val loss、val acc用于分析训练的效果。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># training</span>
        train_loss<span class="token punctuation">,</span> train_acc<span class="token punctuation">,</span> n_batch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token keyword">for</span> x_train_a<span class="token punctuation">,</span> y_train_a <span class="token keyword">in</span> minibatches<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            _<span class="token punctuation">,</span> err<span class="token punctuation">,</span> ac <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>train_op<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> acc<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span> x_train_a<span class="token punctuation">,</span> y_<span class="token punctuation">:</span> y_train_a<span class="token punctuation">}</span><span class="token punctuation">)</span>
            train_loss <span class="token operator">+=</span> err
            train_acc <span class="token operator">+=</span> ac
            n_batch <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--第"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"次训练:"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> n_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>train_acc<span class="token punctuation">)</span> <span class="token operator">/</span> n_batch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>

        <span class="token comment"># validation</span>
        val_loss<span class="token punctuation">,</span> val_acc<span class="token punctuation">,</span> n_batch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token keyword">for</span> x_val_a<span class="token punctuation">,</span> y_val_a <span class="token keyword">in</span> minibatches<span class="token punctuation">(</span>x_val<span class="token punctuation">,</span> y_val<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            err<span class="token punctuation">,</span> ac <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>loss<span class="token punctuation">,</span> acc<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span> x_val_a<span class="token punctuation">,</span> y_<span class="token punctuation">:</span> y_val_a<span class="token punctuation">}</span><span class="token punctuation">)</span>
            val_loss <span class="token operator">+=</span> err
            val_acc <span class="token operator">+=</span> ac
            n_batch <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>val_loss<span class="token punctuation">)</span> <span class="token operator">/</span> n_batch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>val_acc<span class="token punctuation">)</span> <span class="token operator">/</span> n_batch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="335_204"></a>3.3.5识别花卉</h3> 
<p>首先创建用于读取测试的花卉图片的函数，该函数读取测试文件夹中的所有图片并以np.array的形式返回。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_test_img</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    cv_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> im <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        im <span class="token operator">=</span> path <span class="token operator">+</span> im
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\rrecognizing :%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> io<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>im<span class="token punctuation">)</span>
        img <span class="token operator">=</span> transform<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
        imgs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        cv_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span><span class="token punctuation">,</span> cv_data
</code></pre> 
<p>然后就可以利用上述训练得到的判别器来判断所给的图像的标签。然后就可以根据得到的标签输出花的名字</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">recog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token string">'./data/TestImages/'</span>
    model_path <span class="token operator">=</span> <span class="token string">"./model/"</span>

    data<span class="token punctuation">,</span> cv_datas <span class="token operator">=</span> get_test_img<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
        saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>import_meta_graph<span class="token punctuation">(</span>model_path <span class="token operator">+</span> <span class="token string">'model.ckpt.meta'</span><span class="token punctuation">)</span>
        saver<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>sess<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>latest_checkpoint<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

        graph <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_default_graph<span class="token punctuation">(</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"x:0"</span><span class="token punctuation">)</span>
        feed_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span> data<span class="token punctuation">}</span>

        logits <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"logits_eval:0"</span><span class="token punctuation">)</span>
        classification_result <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> feed_dict<span class="token punctuation">)</span>

        <span class="token comment"># 打印出预测矩阵</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>classification_result<span class="token punctuation">)</span>
        <span class="token comment"># 打印出预测矩阵每一行最大值的索引</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>classification_result<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 根据索引通过字典对应花的分类</span>
        output <span class="token operator">=</span> tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>classification_result<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"朵花预测: label:"</span><span class="token punctuation">,</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"\t"</span><span class="token punctuation">,</span> flower<span class="token punctuation">[</span>output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            font <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX
            img <span class="token operator">=</span> cv_datas<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> flower<span class="token punctuation">[</span>output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> font<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token comment"># cv2.imshow(flower[output[i]],img)</span>
            <span class="token comment"># cv2.waitKey(0)  # # 使图片停留用于观察，没有这一行代码，图片会在展示瞬间后消失</span>
</code></pre> 
<p>由于待识别的图片一共有六张，所以将其排列在一个两行三列的图片之中。<br> 使用pyplot的subplot即可实现，遍历所有图片并分别将图片放第i个位置处。</p> 
<pre><code class="prism language-python">        <span class="token comment"># 下面改用pyplot绘图以让结果显示在一张图片中</span>
        pyplot<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>  <span class="token comment"># 使用subplot()构建子图，第一个参数5表示每列有5张图，第二个参数表示每行有6张图，1+i表示第(1+i张图)</span>
        pyplot<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭坐标轴("on"为显示坐标轴)</span>
        pyplot<span class="token punctuation">.</span>title<span class="token punctuation">(</span>flower<span class="token punctuation">[</span>output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        pyplot<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray_r'</span><span class="token punctuation">)</span>  <span class="token comment"># 使用imshow()函数画出训练集相应图片原始像素数据，参数cmap = gray表示黑底白字图像，这边使用"gray_r"表示白底黑字图</span>
pyplot<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'res.png'</span><span class="token punctuation">)</span>  <span class="token comment"># 保存图片</span>
pyplot<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="34_270"></a>3.4运行测试</h2> 
<p>首先读取数据集，由下图可见，程序依次读取了六个文件夹，并从每个文件夹中读取了多张图片。<img src="https://images2.imgbox.com/f0/18/7oUVfMcA_o.png" alt="在这里插入图片描述"></p> 
<p>然后开始训练，这里输出了：训练集损失值、:训练集准确率、测试集损失值、测试集准确率这几个指标，通过观察数值变化可以发现：<br> train loss不断减小<br> Train acc不断增大直至为1并稳定为1<br> Val loss 大体上不断减小，但后半部分稍有波动<br> Val acc 大体上不断增大，但后半部分稍有波动</p> 
<p>以上说明网络正在学习，状态良好。<br> <img src="https://images2.imgbox.com/d8/da/nJFrlGCW_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/7b/d5/In8m0aUG_o.png" alt="在这里插入图片描述"></p> 
<p>然后输出识别出的花卉对应的标签以及名称：<br> 第1朵花预测: Label: 0 bee<br> 第2朵花预测: Label: 1 bLackberry<br> 第3朵花预测: Label: 2 bLanket<br> 第4朵花预测: Label: 3 bougainvillea<br> 第5朵花预测: Label: 4 bromelia<br> 第6朵花预测: Label: 5 foxgLove<br> <img src="https://images2.imgbox.com/5c/aa/5YQ7ClpC_o.png" alt="在这里插入图片描述"></p> 
<p>然后将图片和名称显示在一张图片内方便观察。<br> <img src="https://images2.imgbox.com/6f/e6/bx0IAZR6_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/51280e9769134d515b326ab464b93fb9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Git merge 出现 refusing to merge unrelated histories</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/00402ec53f35196cf90dde58091842b8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用61850网关实现modbus和电力iec61850协议的转换</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>