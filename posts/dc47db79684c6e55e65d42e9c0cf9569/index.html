<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>es基本操作整理 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="es基本操作整理" />
<meta property="og:description" content="POST 请求是没有幂等性的，PUT请求是有幂等性的
查看集群状态
GET /_cat/health?v
GET /_cluster/health?v
查看集群节点列表
GET /_cat/nodes?v
查看所有索引
GET /_cat/indices?v
查看单个索引结构信息
GET /indexName?pretty=true
创建索引
PUT /shopping
查询索引
GET /shopping
删除索引
DELETE /shopping
创建文档
POST /shopping/_doc { &#34;title&#34;:“小米utro”， “category”:&#34;小米&#34;， “images”:&#34;&#34;, &#34;price&#34;:4999 } //上面的创建是使用es默认的id，也可以自定义,结果中的_id就是1001 PUT /shopping/_doc/1001 { &#34;title&#34;:“小米utro”， “category”:&#34;小米&#34;， “images”:&#34;&#34;, &#34;price&#34;:4999 } 主键查询文档
GET /shopping/_doc/1001
全部查询
GET /shopping/_search
GET /shopping/_search?pretty=true
GET /shopping/_search?q=category:小米&amp;pretty=true
完全修改
PUT /shopping/_doc/1001 { &#34;title&#34;:“小米mix”， “category”:&#34;小米&#34;， “images”:&#34;&#34;, &#34;price&#34;:4999 } 局部修改
POST /shopping/_update/1001 { &#34;doc&#34;:{ &#34;title&#34;:“华为手机”， }	} 删除文档" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dc47db79684c6e55e65d42e9c0cf9569/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-11T11:03:48+08:00" />
<meta property="article:modified_time" content="2021-04-11T11:03:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">es基本操作整理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>POST 请求是没有幂等性的，PUT请求是有幂等性的</p> 
</blockquote> 
<p>查看集群状态</p> 
<p><code>GET /_cat/health?v</code></p> 
<p><code>GET /_cluster/health?v</code></p> 
<p>查看集群节点列表</p> 
<p><code>GET /_cat/nodes?v</code></p> 
<p>查看所有索引</p> 
<p><code>GET /_cat/indices?v</code></p> 
<p>查看单个索引结构信息</p> 
<p><code>GET /indexName?pretty=true</code></p> 
<p>创建索引</p> 
<p><code>PUT /shopping</code></p> 
<p>查询索引</p> 
<p><code>GET /shopping</code></p> 
<p>删除索引</p> 
<p><code>DELETE /shopping</code></p> 
<p>创建文档</p> 
<pre><code>POST /shopping/_doc
{
	"title":“小米utro”，
	“category”:"小米"，
	“images”:"",
	"price":4999
}

//上面的创建是使用es默认的id，也可以自定义,结果中的_id就是1001
PUT /shopping/_doc/1001
{
	"title":“小米utro”，
	“category”:"小米"，
	“images”:"",
	"price":4999
}
</code></pre> 
<p>主键查询文档</p> 
<p><code>GET /shopping/_doc/1001</code></p> 
<p>全部查询</p> 
<p><code>GET /shopping/_search</code></p> 
<p><code>GET /shopping/_search?pretty=true</code></p> 
<p><code>GET /shopping/_search?q=category:小米&amp;pretty=true</code></p> 
<p>完全修改</p> 
<pre><code>PUT /shopping/_doc/1001
{
	"title":“小米mix”，
	“category”:"小米"，
	“images”:"",
	"price":4999
}
</code></pre> 
<p>局部修改</p> 
<pre><code>POST /shopping/_update/1001
{
	"doc":{
	 	"title":“华为手机”，
	}	
}
</code></pre> 
<p>删除文档</p> 
<p><code>DELETE /shopping/_doc/1001</code>上</p> 
<h4><a id="_94"></a>查询</h4> 
<p>条件查询</p> 
<pre><code>GET /shopping/_search
{
	"query":{
		"match":{
			"category":"小米"
		}
		
	}
}
</code></pre> 
<p>查询所有</p> 
<pre><code>GET /shopping/_search
{
	"query":{
		"match_all":{	
		}
	}
}
</code></pre> 
<p>分页查询</p> 
<pre><code>GET /shopping/_search
{
	"query":{
		"match_all":{	
		}
	},
	"from":0,
	"seze":2,
	"_source":["title"],
	"sort":{
		"price":{
			"order":"asc/desc"
		}
	}
}
</code></pre> 
<p>多条件查询</p> 
<pre><code>{
	"query":{
		"bool":{	
			"must/should/must_not":[
				{
					"match":{
						"category":"小米"
					}
				}，{
					“match”:{
						"price":1999
					}
				}
			]
		}
	}
}
</code></pre> 
<p>过滤查询</p> 
<pre><code>{
	"query":{
		"bool":{	
			"should":[
				{
					"match":{
						"category":"小米"
					}
				}，{
					“match”:{
						"category":"华为"
					}
				}
			]，
			"filter":{
				"range":{
					"price":{
						"gt":5000
					}				
				}
			}
		}
	}
}
</code></pre> 
<p>完全匹配不分词(小米不会被拆分)</p> 
<pre><code>{
	"query":{
		"match_phrase":{
			"category":"小米"
		}
	}
}
</code></pre> 
<p>高亮显示</p> 
<pre><code>{
	"query":{
		"match_phrase":{
			"category":"小米"
		},
		"highlight":{
			"fields":{
				"category":{}
			}
		}
	}
}
</code></pre> 
<p>聚合操作</p> 
<pre><code>{
	"aggs":{	//聚合操作
		"price_group":{//名称，随意起名
			"terms":{//分组
				"field":"price"//分组字段
			}
		}
	}
}

//求平均值
{
	"aggs":{	//聚合操作
		"price_avg":{//名称，随意起名
			"avg":{//分组
				"field":"price"//分组字段
			}
		}
	},
	"size":0//不要原始数据
}
</code></pre> 
<p>映射关系</p> 
<pre><code>//创建索引
PUT /user
//构造映射关系
PUT /user/_mapping
{
	"properties":{
		"name":{
			"type":"text",//text可以被分词
			"index":true //是否可以被索引
		},"sex":{
			"type":"keyworld",
			"index":true
		},"tel":{
			"type":"keyworld",
			"index":false  //不能被查询，作为搜索条件
		},
	}
}

PUT /user/_create/1001
{
	"name":"",
	"sex":"",
	"tel":
}
</code></pre> 
<p>查看映射关系</p> 
<p><code>GET /user/_mapping</code></p> 
<p>windows集群，修改config/elasticsearch.yml</p> 
<pre><code>### 节点1
# 集群名称
cluster.name: my-applicetion
# 节点名称
node.name: node-1001
# 主节点
node.master: true
# 数据节点
node.data: true
# 主机名称
network.host: localhost
#端口号
http.port: 9200
#通信端口
transport.tcp.port:9301
# 跨域
http.cors.enabled:true
http.cors.allow-origin: "*"
</code></pre> 
<pre><code>### 节点2
# 集群名称
cluster.name: my-applicetion
# 节点名称
node.name: node-1002

# 数据节点
node.data: true
# 主机名称
network.host: localhost
#端口号
http.port: 9201
#通信端口
transport.tcp.port:9302
# 跨域
http.cors.enabled:true
http.cors.allow-origin: "*"

# 查找模块，查找主节点
discovery.seed_hosts:["localhost:9301"]
discovery.zen.fd.ping_timeout: 1m
discovery.zen.fd.ping_retries: 5

</code></pre> 
<blockquote> 
 <p>补充</p> 
</blockquote> 
<pre><code>#主节点
node.master:true
#数据节点
node.data: true
# 预处理节点
node.ingest:true

主节点可以作为数据节点但应当减少主节点数据处理的工作量，一般将主节点与数据节点分开，也就是三者同时一般只有一个为true (不是必须的，master和data可以同时为true)
</code></pre> 
<p>创建多分片索引</p> 
<pre><code>PUT /users
{
	"settings":{
		"number_of_shards":3,
		"number_of_replicas":1
	}
}
</code></pre> 
<p>修改副本数量</p> 
<pre><code># 主分片的数目在创建索引的时候就已经定下来了，之后不能再修改，所以我们只能修改副本数量

PUT /users/_settings
{
	"number_of_replicas":2
}
</code></pre> 
<p>指定分析器查看分词效果</p> 
<pre><code>GET /_analyze
{
	"analyzer":"standard", //使用标准分词
	"text":"test an analyze"
}

GET /_analyze
{
	"analyzer":"ik_max_word", //使用标准分词
	"text":"测试单词"
}
</code></pre> 
<ul><li> <p>ik_max_word 会将文本做最细粒度的拆分</p> </li><li> <p>ik_smart 会将文本做最粗粒度的拆分</p> </li></ul> 
<p>es写数据的流程</p> 
<pre><code>1. 客户端请求集群节点（任意） 协调节点
2. 协调节点将请求转换到制定的节点
3. 主分片需要将数据保存
4. 主分片将数据发送给副本
5. 副本保存成功后进行反馈
6. 主分片进行反馈
7. 客户端获得反馈
</code></pre> 
<p>es获取数据流程</p> 
<pre><code>1. 客户端发送查询请求到协调节点
2. 协调节点计算数据所在的分片以及全部的副本
3. 为了负载均衡，可以轮询所有的节点
4. 将请求转发给具体的节点
5. 节点返回查询结果，将结果反馈给客户端
</code></pre> 
<p>es 更新一个文档</p> 
<pre><code>1. 客户端发送一个更新请求到协调文档
2. 协调节点将请求转发到主分片
3. 主分片不断尝试写入（可能有其他写入，需要等待，锁的概念）
4. 主分片将数据同步给副本
</code></pre> 
<ul><li>分片是将数据的水平拆分（可以结合mysql的分表来理解 ），副本 是对数据的备份</li><li>写文档：分片选择 hash(id)%分片数</li><li>分片控制：用户可以访问任何一个节点获取数据，这个节点称之为协调节点</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/90c829514f046467858dd45ca393e237/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于es的一些问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/772af4e4de840dc220eba8ccd21c55e4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">L1-028 判断素数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>