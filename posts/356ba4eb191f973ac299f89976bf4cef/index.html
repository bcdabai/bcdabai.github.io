<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>苍穹外卖-day10 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="苍穹外卖-day10" />
<meta property="og:description" content="苍穹外卖-day10 本项目学自黑马程序员的《苍穹外卖》项目，是瑞吉外卖的Plus版本
功能更多，更加丰富。
结合资料，和自己对学习过程中的一些看法和问题解决情况上传课件笔记
视频：https://www.bilibili.com/video/BV1TP411v7v6/?spm_id_from=333.337.search-card.all.click
资料：关注黑马程序员公众号----&gt;回复：苍穹外卖
一起学习，一起加油
【可以使用ApiFox代替YApi来导入的接口文档】
🙂 🙃 😉 😌 😍 🥰 😘 😗 😙 😚 😋 😛 😝 😜 🤪 🤨 🧐 🤓 😎 🤩 🥳
1、可以学习Spring Task和WebSocket
2、实现来单提醒和用户催单
文章目录 苍穹外卖-day101. Spring Task1.1 介绍1.2 cron表达式1.3 入门案例1.3.1 Spring Task使用步骤1.3.2 代码开发1.3.3 功能测试 2.订单状态定时处理2.1 需求分析2.2 代码开发2.3 功能测试 3. WebSocket3.1 介绍3.2 入门案例3.2.1 案例分析3.2.2 代码开发3.2.3 功能测试 4. 来单提醒4.1 需求分析和设计4.2 代码开发4.3 功能测试4.4 代码提交 5. 客户催单5.1 需求分析和设计5.2 代码开发5.2.1 Controller层5.2.2 Service层接口5.2.3 Service层实现类 5.3 功能测试5.4 代码提交 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/356ba4eb191f973ac299f89976bf4cef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-02T10:54:33+08:00" />
<meta property="article:modified_time" content="2023-08-02T10:54:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">苍穹外卖-day10</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="day10_0"></a>苍穹外卖-day10</h2> 
<blockquote> 
 <p>本项目学自黑马程序员的《苍穹外卖》项目，是瑞吉外卖的Plus版本<br> 功能更多，更加丰富。<br> 结合资料，和自己对学习过程中的一些看法和问题解决情况上传课件笔记<br> 视频：https://www.bilibili.com/video/BV1TP411v7v6/?spm_id_from=333.337.search-card.all.click<br> 资料：关注黑马程序员公众号----&gt;回复：苍穹外卖</p> 
</blockquote> 
<blockquote> 
 <p>一起学习，一起加油<br> 【可以使用ApiFox代替YApi来导入的接口文档】<br> 🙂 🙃 😉 😌 😍 🥰 😘 😗 😙 😚 😋 😛 😝 😜 🤪 🤨 🧐 🤓 😎 🤩 🥳<br> 1、可以学习Spring Task和WebSocket<br> 2、实现来单提醒和用户催单</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#day10_0" rel="nofollow">苍穹外卖-day10</a></li><li><ul><li><a href="#1_Spring_Task_18" rel="nofollow">1. Spring Task</a></li><li><ul><li><a href="#11__20" rel="nofollow">1.1 介绍</a></li><li><a href="#12_cron_40" rel="nofollow">1.2 cron表达式</a></li><li><a href="#13__104" rel="nofollow">1.3 入门案例</a></li><li><ul><li><a href="#131_Spring_Task_106" rel="nofollow">1.3.1 Spring Task使用步骤</a></li><li><a href="#132__116" rel="nofollow">1.3.2 代码开发</a></li><li><a href="#133__177" rel="nofollow">1.3.3 功能测试</a></li></ul> 
   </li></ul> 
   </li><li><a href="#2_187" rel="nofollow">2.订单状态定时处理</a></li><li><ul><li><a href="#21__189" rel="nofollow">2.1 需求分析</a></li><li><a href="#22__210" rel="nofollow">2.2 代码开发</a></li><li><a href="#23__313" rel="nofollow">2.3 功能测试</a></li></ul> 
   </li><li><a href="#3_WebSocket_350" rel="nofollow">3. WebSocket</a></li><li><ul><li><a href="#31__352" rel="nofollow">3.1 介绍</a></li><li><a href="#32__385" rel="nofollow">3.2 入门案例</a></li><li><ul><li><a href="#321__387" rel="nofollow">3.2.1 案例分析</a></li><li><a href="#322__409" rel="nofollow">3.2.2 代码开发</a></li><li><a href="#323__633" rel="nofollow">3.2.3 功能测试</a></li></ul> 
   </li></ul> 
   </li><li><a href="#4__646" rel="nofollow">4. 来单提醒</a></li><li><ul><li><a href="#41__648" rel="nofollow">4.1 需求分析和设计</a></li><li><a href="#42__670" rel="nofollow">4.2 代码开发</a></li><li><a href="#43__720" rel="nofollow">4.3 功能测试</a></li><li><a href="#44__756" rel="nofollow">4.4 代码提交</a></li></ul> 
   </li><li><a href="#5__757" rel="nofollow">5. 客户催单</a></li><li><ul><li><a href="#51__759" rel="nofollow">5.1 需求分析和设计</a></li><li><a href="#52__788" rel="nofollow">5.2 代码开发</a></li><li><ul><li><a href="#521_Controller_790" rel="nofollow">5.2.1 Controller层</a></li><li><a href="#522_Service_811" rel="nofollow">5.2.2 Service层接口</a></li><li><a href="#523_Service_825" rel="nofollow">5.2.3 Service层实现类</a></li></ul> 
    </li><li><a href="#53__868" rel="nofollow">5.3 功能测试</a></li><li><a href="#54__898" rel="nofollow">5.4 代码提交</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1_Spring_Task_18"></a>1. Spring Task</h3> 
<h4><a id="11__20"></a>1.1 介绍</h4> 
<p><strong>Spring Task</strong> 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。</p> 
<p><strong>定位：定时任务框架</strong></p> 
<p><strong>作用：定时自动执行某段Java代码</strong><br> 为什么要在Java程序中使用Spring Task？</p> 
<p><strong>应用场景：</strong></p> 
<p>1). 信用卡每月还款提醒<br> 2). 银行贷款每月还款提醒<br> 3). 火车票售票系统处理未支付订单<br> 4). 入职纪念日为用户发送通知</p> 
<p>**强调：**只要是需要定时处理的场景都可以使用Spring Task</p> 
<h4><a id="12_cron_40"></a>1.2 cron表达式</h4> 
<p><strong>cron表达式</strong>其实就是一个字符串，通过cron表达式可以<strong>定义任务触发的时间</strong></p> 
<p><strong>构成规则：分为6或7个域，由空格分隔开，每个域代表一个含义</strong></p> 
<p>每个域的含义分别为：秒、分钟、小时、日、月、周、年(可选)</p> 
<p><strong>举例：</strong></p> 
<p>2022年10月12日上午9点整 对应的cron表达式为：<strong>0 0 9 12 10 ? 2022</strong></p> 
<p><img src="https://images2.imgbox.com/52/6b/NQX5E1Ro_o.png" alt="在这里插入图片描述"></p> 
<p><strong>说明：<strong>一般</strong>日</strong>和<strong>周</strong>的值不同时设置，其中一个设置，另一个用？表示。</p> 
<p>**比如：**描述2月份的最后一天，最后一天具体是几号呢？可能是28号，也有可能是29号，所以就不能写具体数字。</p> 
<p>为了描述这些信息，提供一些特殊的字符。这些具体的细节，我们就不用自己去手写，因为这个cron表达式，它其实有在线生成器。</p> 
<p>cron表达式在线生成器：https://cron.qqe2.com/</p> 
<p><img src="https://images2.imgbox.com/94/96/Cr6JmnzF_o.png" alt="在这里插入图片描述"></p> 
<p>可以直接在这个网站上面，只要根据自己的要求去生成corn表达式即可。所以一般就不用自己去编写这个表达式。</p> 
<p><strong>通配符：</strong></p> 
<p>* 表示所有值；</p> 
<p>? 表示未说明的值，即不关心它为何值；</p> 
<p>- 表示一个指定的范围；</p> 
<p>, 表示附加一个可能值；</p> 
<p>/ 符号前表示开始时间，符号后表示每次递增的值；</p> 
<p><strong>cron表达式案例：</strong></p> 
<p>*/5 * * * * ? 每隔5秒执行一次</p> 
<p>0 */1 * * * ? 每隔1分钟执行一次</p> 
<p>0 0 5-15 * * ? 每天5-15点整点触发</p> 
<p>0 0/3 * * * ? 每三分钟触发一次</p> 
<p>0 0-5 14 * * ? 在每天下午2点到下午2:05期间的每1分钟触发</p> 
<p>0 0/5 14 * * ? 在每天下午2点到下午2:55期间的每5分钟触发</p> 
<p>0 0/5 14,18 * * ? 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发</p> 
<p>0 0/30 9-17 * * ? 朝九晚五工作时间内每半小时</p> 
<p>0 0 10,14,16 * * ? 每天上午10点，下午2点，4点</p> 
<h4><a id="13__104"></a>1.3 入门案例</h4> 
<h5><a id="131_Spring_Task_106"></a>1.3.1 Spring Task使用步骤</h5> 
<p>1). 导入maven坐标 spring-context（已存在）</p> 
<p>2). 启动类添加注解 @EnableScheduling 开启任务调度</p> 
<p>3). 自定义定时任务类</p> 
<h5><a id="132__116"></a>1.3.2 代码开发</h5> 
<p><strong>编写定时任务类：</strong></p> 
<p>进入sky-server模块中</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>task</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Scheduled</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义定时任务类
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 定时任务 每隔5秒触发一次
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0/5 * * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"定时任务开始执行：{}"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>开启任务调度：</strong></p> 
<p>启动类添加注解 @EnableScheduling</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableCaching</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableScheduling</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableTransactionManagement</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span> <span class="token comment">//开启注解方式的事务管理</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token annotation punctuation">@EnableScheduling</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkyApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SkyApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"server started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="133__177"></a>1.3.3 功能测试</h5> 
<p>启动服务，查看日志</p> 
<p><img src="https://images2.imgbox.com/b8/d7/L8S4yNnr_o.png" alt="在这里插入图片描述"></p> 
<p>每隔5秒执行一次。</p> 
<h3><a id="2_187"></a>2.订单状态定时处理</h3> 
<h4><a id="21__189"></a>2.1 需求分析</h4> 
<p>用户下单后可能存在的情况：</p> 
<ul><li>下单后未支付，订单一直处于**“待支付”**状态</li><li>用户收货后管理端未点击完成按钮，订单一直处于**“派送中”**状态</li></ul> 
<p><img src="https://images2.imgbox.com/97/ba/Jb3OWjUB_o.png" alt="在这里插入图片描述"></p> 
<p>支付超时的订单如何处理？ 派送中的订单一直不点击完成如何处理？</p> 
<p>对于上面两种情况需要通过<strong>定时任务</strong>来修改订单状态，具体逻辑为：</p> 
<ul><li>通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”</li><li>通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”</li></ul> 
<h4><a id="22__210"></a>2.2 代码开发</h4> 
<p><strong>1). 自定义定时任务类OrderTask（待完善）：</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>task</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义定时任务，实现订单状态定时处理
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderTask</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 处理支付超时订单
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 * * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processTimeoutOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理支付超时订单：{}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 处理“派送中”状态的订单
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 0 1 * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processDeliveryOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理派送中订单：{}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>2). 在OrderMapper接口中扩展方法:</strong></p> 
<pre><code class="prism language-java">	<span class="token comment">/**
     * 根据状态和下单时间查询订单
     * @param status
     * @param orderTime
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from orders where status = #{status} and order_time &lt; #{orderTime}"</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">getByStatusAndOrdertimeLT</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span> orderTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>3). 完善定时任务类的processTimeoutOrder方法：</strong></p> 
<pre><code class="prism language-java">	<span class="token comment">/**
     * 处理支付超时订单
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 * * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processTimeoutOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理支付超时订单：{}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusMinutes</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// select * from orders where status = 1 and order_time &lt; 当前时间-15分钟</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> ordersList <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getByStatusAndOrdertimeLT</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">PENDING_PAYMENT</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ordersList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ordersList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            ordersList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>order <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                order<span class="token punctuation">.</span><span class="token function">setCancelReason</span><span class="token punctuation">(</span><span class="token string">"支付超时，自动取消"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                order<span class="token punctuation">.</span><span class="token function">setCancelTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                orderMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>4). 完善定时任务类的processDeliveryOrder方法：</strong></p> 
<pre><code class="prism language-java">	<span class="token comment">/**
     * 处理“派送中”状态的订单
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 0 1 * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processDeliveryOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理派送中订单：{}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// select * from orders where status = 4 and order_time &lt; 当前时间-1小时</span>
        <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusMinutes</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> ordersList <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getByStatusAndOrdertimeLT</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">DELIVERY_IN_PROGRESS</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>ordersList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ordersList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            ordersList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>order <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                orderMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="23__313"></a>2.3 功能测试</h4> 
<p>可以通过如下方式进行测试：</p> 
<ul><li>查看控制台sql</li><li>查看数据库中数据变化</li></ul> 
<p><strong>支付超时的订单测试：</strong></p> 
<p><strong>1). 查看订单表</strong></p> 
<p>有一条订单，状态为1。订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</p> 
<p><img src="https://images2.imgbox.com/52/7c/UaHm0ZEk_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2). 开启定时任务</strong></p> 
<p>启动服务，观察控制台日志。处理支付超时订单任务每隔1分钟执行一次。</p> 
<p><img src="https://images2.imgbox.com/b9/9b/I8bh3ep5_o.png" alt="在这里插入图片描述"></p> 
<p><strong>3). 再次查看订单表</strong></p> 
<p>状态已更改为6，已取消。</p> 
<p><img src="https://images2.imgbox.com/fb/9a/kWaSbim5_o.png" alt="在这里插入图片描述"></p> 
<p>证明定时任务已生效。</p> 
<p><strong>处理“派送中”状态的订单任务</strong>测试自已完成，测试步骤和上述一致。可适当修改cron表达式，改变任务执行频率，方便测试。</p> 
<h3><a id="3_WebSocket_350"></a>3. WebSocket</h3> 
<h4><a id="31__352"></a>3.1 介绍</h4> 
<p>WebSocket 是基于 TCP 的一种新的<strong>网络协议</strong>。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建<strong>持久性</strong>的连接， 并进行<strong>双向</strong>数据传输。</p> 
<p><strong>HTTP协议和WebSocket协议对比：</strong></p> 
<ul><li>HTTP是<strong>短连接</strong></li><li>WebSocket是<strong>长连接</strong></li><li>HTTP通信是<strong>单向</strong>的，基于请求响应模式</li><li>WebSocket支持<strong>双向</strong>通信</li><li>HTTP和WebSocket底层都是TCP连接</li></ul> 
<p><img src="https://images2.imgbox.com/0a/6b/ziOVfLDP_o.png" alt="在这里插入图片描述"></p> 
<p><strong>思考：既然WebSocket支持双向通信，功能看似比HTTP强大，那么我们是不是可以基于WebSocket开发所有的业务功能？</strong></p> 
<p><strong>WebSocket缺点：</strong></p> 
<p>服务器长期维护长连接需要一定的成本<br> 各个浏览器支持程度不一<br> WebSocket 是长连接，受网络限制比较大，需要处理好重连</p> 
<p><strong>结论：WebSocket并不能完全取代HTTP，它只适合在特定的场景下使用</strong></p> 
<p><strong>WebSocket应用场景：</strong></p> 
<p>1). 视频弹幕<br> 2). 网页聊天<br> 3). 体育实况更新<br> 4). 股票基金报价实时更新</p> 
<h4><a id="32__385"></a>3.2 入门案例</h4> 
<h5><a id="321__387"></a>3.2.1 案例分析</h5> 
<p><strong>需求：实现浏览器与服务器全双工通信。浏览器既可以向服务器发送消息，服务器也可主动向浏览器推送消息。</strong></p> 
<p><strong>效果展示：</strong></p> 
<p><img src="https://images2.imgbox.com/db/e0/zCcVNb7j_o.png" alt="在这里插入图片描述"></p> 
<p><strong>实现步骤：</strong></p> 
<p>1). 直接使用websocket.html页面作为WebSocket客户端</p> 
<p>2). 导入WebSocket的maven坐标</p> 
<p>3). 导入WebSocket服务端组件WebSocketServer，用于和客户端通信</p> 
<p>4). 导入配置类WebSocketConfiguration，注册WebSocket的服务端组件</p> 
<p>5). 导入定时任务类WebSocketTask，定时向客户端推送数据</p> 
<h5><a id="322__409"></a>3.2.2 代码开发</h5> 
<p>1). 定义websocket.html页面(资料中已提供)</p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">HTML</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>WebSocket Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>发送消息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">closeWebSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>关闭连接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> websocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> clientId <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//判断当前浏览器是否支持WebSocket</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'WebSocket'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//连接WebSocket节点</span>
        websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">"ws://localhost:8080/ws/"</span><span class="token operator">+</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Not support websocket'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//连接发生错误的回调方法</span>
    websocket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">setMessageInnerHTML</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//连接成功建立的回调方法</span>
    websocket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">setMessageInnerHTML</span><span class="token punctuation">(</span><span class="token string">"连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//接收到消息的回调方法</span>
    websocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">setMessageInnerHTML</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//连接关闭的回调方法</span>
    websocket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">setMessageInnerHTML</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将消息显示在网页上</span>
    <span class="token keyword">function</span> <span class="token function">setMessageInnerHTML</span><span class="token punctuation">(</span><span class="token parameter">innerHTML</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> innerHTML <span class="token operator">+</span> <span class="token string">'&lt;br/&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//发送消息</span>
    <span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> message <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
	<span class="token comment">//关闭连接</span>
    <span class="token keyword">function</span> <span class="token function">closeWebSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2). 导入maven坐标</p> 
<p>在sky-server模块pom.xml中已定义</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-websocket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>3). 定义WebSocket服务端组件(资料中已提供)</p> 
<p>直接导入到sky-server模块即可</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>websocket</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">OnClose</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">OnMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">OnOpen</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">Session</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">PathParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerEndpoint</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * WebSocket服务
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span><span class="token string">"/ws/{sid}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketServer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//存放会话对象</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> sessionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 连接建立成功调用的方法
     */</span>
    <span class="token annotation punctuation">@OnOpen</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端："</span> <span class="token operator">+</span> sid <span class="token operator">+</span> <span class="token string">"建立连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sessionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 收到客户端消息后调用的方法
     *
     * @param message 客户端发送过来的消息
     */</span>
    <span class="token annotation punctuation">@OnMessage</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到来自客户端："</span> <span class="token operator">+</span> sid <span class="token operator">+</span> <span class="token string">"的信息:"</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 连接关闭调用的方法
     *
     * @param sid
     */</span>
    <span class="token annotation punctuation">@OnClose</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接断开:"</span> <span class="token operator">+</span> sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sessionMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 群发
     *
     * @param message
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendToAllClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> sessions <span class="token operator">=</span> sessionMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Session</span> session <span class="token operator">:</span> sessions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//服务器向客户端发送消息</span>
                session<span class="token punctuation">.</span><span class="token function">getBasicRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendText</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>4). 定义配置类，注册WebSocket的服务端组件(从资料中直接导入即可)</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>server<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">ServerEndpointExporter</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * WebSocket配置类，用于注册WebSocket的Bean
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketConfiguration</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServerEndpointExporter</span> <span class="token function">serverEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServerEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>5). 定义定时任务类，定时向客户端推送数据(从资料中直接导入即可)</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>task</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">WebSocketServer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Scheduled</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span><span class="token class-name">DateTimeFormatter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketTask</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WebSocketServer</span> webSocketServer<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 通过WebSocket每隔5秒向客户端发送消息
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0/5 * * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessageToClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        webSocketServer<span class="token punctuation">.</span><span class="token function">sendToAllClient</span><span class="token punctuation">(</span><span class="token string">"这是来自服务端的消息："</span> <span class="token operator">+</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="323__633"></a>3.2.3 功能测试</h5> 
<p>启动服务，打开websocket.html页面</p> 
<p><strong>浏览器向服务器发送数据：</strong></p> 
<p><img src="https://images2.imgbox.com/e6/3d/FBEZMp9G_o.png" alt="在这里插入图片描述"></p> 
<p><strong>服务器向浏览器间隔5秒推送数据：</strong></p> 
<p><img src="https://images2.imgbox.com/97/9b/ZeE9XfOD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4__646"></a>4. 来单提醒</h3> 
<h4><a id="41__648"></a>4.1 需求分析和设计</h4> 
<p>用户下单并且支付成功后，需要第一时间通知外卖商家。通知的形式有如下两种：</p> 
<ul><li> <p>语音播报 <img src="https://images2.imgbox.com/86/2f/iLYMm4KH_o.png" alt=""></p> </li><li> <p>弹出提示框</p> </li></ul> 
<p><img src="https://images2.imgbox.com/37/c4/ZTs1jxlE_o.png" alt="在这里插入图片描述"></p> 
<p><strong>设计思路：</strong></p> 
<ul><li>通过WebSocket实现管理端页面和服务端保持长连接状态</li><li>当客户支付后，调用WebSocket的相关API实现服务端向客户端推送消息</li><li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</li><li>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content 
  <ul><li>type 为消息类型，1为来单提醒 2为客户催单</li><li>orderId 为订单id</li><li>content 为消息内容</li></ul> </li></ul> 
<h4><a id="42__670"></a>4.2 代码开发</h4> 
<p><strong>在OrderServiceImpl中注入WebSocketServer对象，修改paySuccess方法，加入如下代码：</strong></p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WebSocketServer</span> webSocketServer<span class="token punctuation">;</span>
	<span class="token comment">/**
     * 支付成功，修改订单状态
     *
     * @param outTradeNo
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">paySuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> outTradeNo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前登录用户id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">BaseContext</span><span class="token punctuation">.</span><span class="token function">getCurrentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据订单号查询当前用户的订单</span>
        <span class="token class-name">Orders</span> ordersDB <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getByNumberAndUserId</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span>
        <span class="token class-name">Orders</span> orders <span class="token operator">=</span> <span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>ordersDB<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">TO_BE_CONFIRMED</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">payStatus</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">PAID</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">checkoutTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//</span>
        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消息类型，1表示来单提醒</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"orderId"</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"订单号："</span> <span class="token operator">+</span> outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//通过WebSocket实现来单提醒，向客户端浏览器推送消息</span>
        webSocketServer<span class="token punctuation">.</span><span class="token function">sendToAllClient</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">///</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 根据订单号和用户id查询订单
     * @param orderNumber
     * @param userId
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from orders where number = #{orderNumber} and user_id= #{userId}"</span><span class="token punctuation">)</span>
    <span class="token class-name">Orders</span> <span class="token function">getByNumberAndUserId</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNumber<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="43__720"></a>4.3 功能测试</h4> 
<p>可以通过如下方式进行测试：</p> 
<ul><li>查看浏览器调试工具数据交互过程</li><li>前后端联调</li></ul> 
<p><strong>1). 登录管理端后台</strong></p> 
<p>登录成功后，浏览器与服务器建立长连接</p> 
<p><img src="https://images2.imgbox.com/35/0d/k85eCgrv_o.png" alt="在这里插入图片描述"></p> 
<p>查看控制台日志</p> 
<p><img src="https://images2.imgbox.com/11/9e/RaQstQ5s_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2). 小程序端下单支付</strong></p> 
<p>修改回调地址，利用内网穿透获取域名</p> 
<p><img src="https://images2.imgbox.com/e6/3e/JfDyYRVF_o.png" alt="在这里插入图片描述"></p> 
<p>下单支付</p> 
<p><strong>3). 查看来单提醒</strong></p> 
<p>支付成功后，后台收到来单提醒，并有语音播报</p> 
<p><img src="https://images2.imgbox.com/98/ff/D30z5HqE_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="44__756"></a>4.4 代码提交</h4> 
<h3><a id="5__757"></a>5. 客户催单</h3> 
<h4><a id="51__759"></a>5.1 需求分析和设计</h4> 
<p>用户在小程序中点击催单按钮后，需要第一时间通知外卖商家。通知的形式有如下两种：</p> 
<ul><li> <p>语音播报 <img src="https://images2.imgbox.com/18/33/P4iV3d79_o.png" alt=""></p> </li><li> <p>弹出提示框</p> </li></ul> 
<p><img src="https://images2.imgbox.com/b7/81/cPKGiLZ0_o.png" alt="在这里插入图片描述"></p> 
<p><strong>设计思路：</strong></p> 
<ul><li>通过WebSocket实现管理端页面和服务端保持长连接状态</li><li>当用户点击催单按钮后，调用WebSocket的相关API实现服务端向客户端推送消息</li><li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报<br> 约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content 
  <ul><li>type 为消息类型，1为来单提醒 2为客户催单</li><li>orderId 为订单id</li><li>content 为消息内容</li></ul> </li></ul> 
<p>当用户点击催单按钮时，向服务端发送请求。</p> 
<p><strong>接口设计(催单)：</strong></p> 
<p><img src="https://images2.imgbox.com/cd/eb/ZKujOuDS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="52__788"></a>5.2 代码开发</h4> 
<h5><a id="521_Controller_790"></a>5.2.1 Controller层</h5> 
<p><strong>根据用户催单的接口定义，在user/OrderController中创建催单方法：</strong></p> 
<pre><code class="prism language-java">	<span class="token comment">/**
     * 用户催单
     *
     * @param id
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/reminder/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"用户催单"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">reminder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        orderService<span class="token punctuation">.</span><span class="token function">reminder</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="522_Service_811"></a>5.2.2 Service层接口</h5> 
<p><strong>在OrderService接口中声明reminder方法：</strong></p> 
<pre><code class="prism language-java">	<span class="token comment">/**
     * 用户催单
     * @param id
     */</span>
    <span class="token keyword">void</span> <span class="token function">reminder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="523_Service_825"></a>5.2.3 Service层实现类</h5> 
<p><strong>在OrderServiceImpl中实现reminder方法：</strong></p> 
<pre><code class="prism language-java">	<span class="token comment">/**
     * 用户催单
     *
     * @param id
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reminder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 查询订单是否存在</span>
        <span class="token class-name">Orders</span> orders <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orders <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderBusinessException</span><span class="token punctuation">(</span><span class="token class-name">MessageConstant</span><span class="token punctuation">.</span><span class="token constant">ORDER_NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//基于WebSocket实现催单</span>
        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2代表用户催单</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"orderId"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"订单号："</span> <span class="token operator">+</span> orders<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webSocketServer<span class="token punctuation">.</span><span class="token function">sendToAllClient</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>5.2.4 Mapper层</p> 
<p><strong>在OrderMapper中添加getById：</strong></p> 
<pre><code class="prism language-java">	<span class="token comment">/**
     * 根据id查询订单
     * @param id
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from orders where id=#{id}"</span><span class="token punctuation">)</span>
    <span class="token class-name">Orders</span> <span class="token function">getById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="53__868"></a>5.3 功能测试</h4> 
<p>可以通过如下方式进行测试：</p> 
<ul><li>查看浏览器调试工具数据交互过程</li><li>前后端联调</li></ul> 
<p><strong>1). 登录管理端后台</strong></p> 
<p>登录成功后，浏览器与服务器建立长连接</p> 
<p><img src="https://images2.imgbox.com/f9/13/knhsmpnk_o.png" alt="在这里插入图片描述"></p> 
<p>查看控制台日志</p> 
<p><img src="https://images2.imgbox.com/c9/7a/qFxAbn2f_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2). 用户进行催单</strong></p> 
<p>用户可在订单列表或者订单详情，进行催单</p> 
<p><img src="https://images2.imgbox.com/47/71/fup0iKrp_o.png" alt="在这里插入图片描述"></p> 
<p><strong>3). 查看催单提醒</strong></p> 
<p>既有催单弹窗，同时语音播报 <img src="https://images2.imgbox.com/e9/72/QqnsaExp_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="54__898"></a>5.4 代码提交</h4>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cf66e0072ec1ebe70a6460c80ed99d3e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java灵活操作Http请求（hutool）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/87d1e2ec3a686783cd3efe039732fb69/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux(二)---------网络命令学习（ifconfig命令）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>