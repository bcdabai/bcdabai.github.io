<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Java集合（一）集合框架概述 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Java集合（一）集合框架概述" />
<meta property="og:description" content="文章目录 一、集合框架1.1 集合体系*1.2 迭代器1.2.1 Iterator迭代器1.2.2 ListIterator迭代器1.2.3 两者的区别 1.3 线程安全*1.3.1 线程安全的集合1.3.2 线程不安全的集合 1.4 两种fail机制1.4.1 fail-fast机制*1.4.2 不同情形下的fail-fast1.4.3 解决fail-fast的方法1.3.3 fail-safe机制* 1.5 集合相关问题1.5.1 集合和数组的区别1.5.2 怎么确保一个集合不能被修改1.5.3 为何没有像Iterator.add()这样的方法，向集合中添加元素1.5.4 集合框架中的泛型有什么优点1.5.5 用哪两种方式来实现集合的排序1.5.6 集合框架使用注意事项 二、Collections工具类2.1 排序相关方法2.1.1 Collections.sort的底层实现2.1.2 Collections.sort的两种形式2.1.3 Comparable*2.1.4 Comparator*2.1.5 Comparable和Comparator的区别* 2.2 查找替换方法2.3 同步控制方法2.4 使用Collections的最佳实践 本系列文章：
Java集合（一）集合框架概述
Java集合（二）List、ArrayList、LinkedList
Java集合（三）CopyOnWriteArrayList、Vector、Stack
Java集合（四）Map、HashMap
Java集合（五）LinkedHashMap、TreeMap
Java集合（六）Hashtable、ConcurrentHashMap
Java集合（七）Set、HashSet、LinkedHashSet、TreeSet
Java集合（八）BlockingQueue、ArrayBlockingQueue、LinkedBlockingQueue、PriorityBlockingQueue、DelayQueue
一、集合框架 集合框架：用于存储数据的容器。集合框架是为表示和操作集合而规定的一种统一的标准的体系结构。任何集合框架都包含三大块内容：
1、接口
表示集合的抽象数据类型。接口允许我们操作集合时不必关注具体实现，从而达到“多态”。在面向对象编程语言中，接口通常用来形成规范。2、实现
集合接口的具体实现，是重用性很高的数据结构。3、算法
在一个实现了某个集合框架中的接口的对象身上完成某种有用的计算的方法，例如查找、排序等。这些算法通常是多态的，因为相同的方法可以在同一个接口被多个类实现时有不同的表现。 常见的集合对比：
1.1 集合体系* Collection接口和Map接口是所有集合框架的父接口。
Collection接口的父接口是Iterable接口，Collection接口的子接口包括：Set接口、List接口和Queue接口。
1、Collection体系
由上图可知：Collection继承了Iterable，Iterable中有3个方法： //获取迭代器 Iterator&lt;T&gt; iterator(); //for each循环 default void forEach(Consumer&lt;? super T&gt; action); //并行迭代器循环 default Spliterator&lt;T&gt; spliterator(); Iterator是迭代器接口，定义了几个迭代操作的方法，也就是需要具体的实现类去实现的迭代器逻辑：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/45b0fad283a6a94464f0c81706747cc8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-26T19:47:11+08:00" />
<meta property="article:modified_time" content="2024-01-26T19:47:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java集合（一）集合框架概述</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_13" rel="nofollow">一、集合框架</a></li><li><ul><li><a href="#11__24" rel="nofollow">1.1 集合体系*</a></li><li><a href="#12__95" rel="nofollow">1.2 迭代器</a></li><li><ul><li><a href="#121_Iterator_96" rel="nofollow">1.2.1 Iterator迭代器</a></li><li><a href="#122__ListIterator_120" rel="nofollow">1.2.2 ListIterator迭代器</a></li><li><a href="#123__143" rel="nofollow">1.2.3 两者的区别</a></li></ul> 
    </li><li><a href="#13__150" rel="nofollow">1.3 线程安全*</a></li><li><ul><li><a href="#131__152" rel="nofollow">1.3.1 线程安全的集合</a></li><li><a href="#132__167" rel="nofollow">1.3.2 线程不安全的集合</a></li></ul> 
    </li><li><a href="#14_fail_169" rel="nofollow">1.4 两种fail机制</a></li><li><ul><li><a href="#141__failfast_170" rel="nofollow">1.4.1 fail-fast机制*</a></li><li><a href="#142___failfast_227" rel="nofollow">1.4.2 不同情形下的fail-fast</a></li><li><a href="#143__failfast_303" rel="nofollow">1.4.3 解决fail-fast的方法</a></li><li><a href="#133__failsafe_353" rel="nofollow">1.3.3 fail-safe机制*</a></li></ul> 
    </li><li><a href="#15__365" rel="nofollow">1.5 集合相关问题</a></li><li><ul><li><a href="#151__366" rel="nofollow">1.5.1 集合和数组的区别</a></li><li><a href="#152__372" rel="nofollow">1.5.2 怎么确保一个集合不能被修改</a></li><li><a href="#153_Iteratoradd_381" rel="nofollow">1.5.3 为何没有像Iterator.add()这样的方法，向集合中添加元素</a></li><li><a href="#154__383" rel="nofollow">1.5.4 集合框架中的泛型有什么优点</a></li><li><a href="#155__385" rel="nofollow">1.5.5 用哪两种方式来实现集合的排序</a></li><li><a href="#156__388" rel="nofollow">1.5.6 集合框架使用注意事项</a></li></ul> 
   </li></ul> 
   </li><li><a href="#Collections_409" rel="nofollow">二、Collections工具类</a></li><li><ul><li><a href="#21__415" rel="nofollow">2.1 排序相关方法</a></li><li><ul><li><a href="#211_Collectionssort_428" rel="nofollow">2.1.1 Collections.sort的底层实现</a></li><li><a href="#212_Collectionssort_434" rel="nofollow">2.1.2 Collections.sort的两种形式</a></li><li><a href="#213_Comparable_445" rel="nofollow">2.1.3 Comparable*</a></li><li><a href="#214_Comparator_515" rel="nofollow">2.1.4 Comparator*</a></li><li><a href="#215_ComparableComparator_559" rel="nofollow">2.1.5 Comparable和Comparator的区别*</a></li></ul> 
    </li><li><a href="#22__574" rel="nofollow">2.2 查找替换方法</a></li><li><a href="#23__591" rel="nofollow">2.3 同步控制方法</a></li><li><a href="#24__Collections_604" rel="nofollow">2.4 使用Collections的最佳实践</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>  本系列文章：<br>     Java集合（一）集合框架概述<br>     <a href="https://blog.csdn.net/m0_37741420/article/details/107013695" title="With a Title">Java集合（二）List、ArrayList、LinkedList</a><br>     <a href="https://blog.csdn.net/m0_37741420/article/details/107032686" title="With a Title">Java集合（三）CopyOnWriteArrayList、Vector、Stack</a><br>     <a href="https://blog.csdn.net/m0_37741420/article/details/112424663" title="With a Title">Java集合（四）Map、HashMap</a><br>     <a href="https://blog.csdn.net/m0_37741420/article/details/123614527" title="With a Title">Java集合（五）LinkedHashMap、TreeMap</a><br>     <a href="https://blog.csdn.net/m0_37741420/article/details/135028798" title="With a Title">Java集合（六）Hashtable、ConcurrentHashMap</a><br>     <a href="https://blog.csdn.net/m0_37741420/article/details/112407684" title="With a Title">Java集合（七）Set、HashSet、LinkedHashSet、TreeSet</a><br>     <a href="https://blog.csdn.net/m0_37741420/article/details/120335698" title="With a Title">Java集合（八）BlockingQueue、ArrayBlockingQueue、LinkedBlockingQueue、PriorityBlockingQueue、DelayQueue</a></p> 
<h3><a id="_13"></a>一、集合框架</h3> 
<p>  <strong>集合框架</strong>：用于存储数据的容器。集合框架是为表示和操作集合而规定的一种统一的标准的体系结构。任何集合框架都包含三大块内容：</p> 
<ul><li><strong>1、接口</strong><br>   表示集合的抽象数据类型。接口允许我们操作集合时不必关注具体实现，从而达到“多态”。在面向对象编程语言中，接口通常用来形成规范。</li><li><strong>2、实现</strong><br>   集合接口的具体实现，是重用性很高的数据结构。</li><li><strong>3、算法</strong><br>   在一个实现了某个集合框架中的接口的对象身上完成某种有用的计算的方法，例如查找、排序等。这些算法通常是多态的，因为相同的方法可以在同一个接口被多个类实现时有不同的表现。</li></ul> 
<p>  常见的集合对比：<br> <img src="https://images2.imgbox.com/09/f3/XkAhSJfZ_o.png" alt=""></p> 
<h4><a id="11__24"></a>1.1 集合体系*</h4> 
<p>  Collection接口和Map接口是所有集合框架的父接口。<br>   Collection接口的父接口是Iterable接口，Collection接口的子接口包括：Set接口、List接口和Queue接口。</p> 
<ul><li><strong>1、Collection体系</strong><br> <img src="https://images2.imgbox.com/f4/27/OmoPyQXj_o.png" alt=""><br>   由上图可知：Collection继承了Iterable，Iterable中有3个方法：</li></ul> 
<pre><code class="prism language-java">	<span class="token comment">//获取迭代器</span>
	<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//for each循环</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//并行迭代器循环</span>
	<span class="token keyword">default</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">spliterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  Iterator是迭代器接口，定义了几个迭代操作的方法，也就是需要具体的实现类去实现的迭代器逻辑：</p> 
<pre><code class="prism language-java">	<span class="token comment">//询问是否还有下一个元素，返回true表示有，反之表示没有</span>
	<span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获取下一个元素</span>
	<span class="token class-name">E</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//删除上次调用next()方法时返回的元素</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//遍历所有元素</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">forEachRemaining</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span>
</code></pre> 
<p>  可以看出，<code>实现了Collection接口的实现类(即List、Set、Queue的实现类)，都既支持for each循环；又支持迭代器循环(要自己实现迭代器逻辑)</code>。</p> 
<ul><li> <p><strong>2、Map体系</strong><br> <img src="https://images2.imgbox.com/6b/c4/kxn9xXwY_o.png" alt=""></p> </li><li> <p><strong>3、List、Set、Map的特征</strong></p> </li></ul> 
<table><thead><tr><th align="left">集合类</th><th align="left">特点</th><th align="left">遍历</th></tr></thead><tbody><tr><td align="left">List</td><td align="left">有序（元素存入集合的顺序和取出的顺序一致）；<br>元素可以重复；<br>可以插入多个Null元素；<br>元素都有索引。</td><td align="left">支持for循环，也就是通过下标来遍历；<br>也可以用迭代器遍历。</td></tr><tr><td align="left">Set</td><td align="left">无序（存入和取出顺序有可能不一致）；<br>元素不可以重复；<br>只允许存入一个null元素；<br>必须保证元素唯一性。</td><td align="left">只能用迭代方式遍历，因为无序，无法用下标来取得想要的值。</td></tr><tr><td align="left">Map</td><td align="left">键值对集合，存储键、值和之间的映射。<br>Key无序，唯一；<br>value不要求有序，允许重复。</td><td align="left">底层实现也是List，所以也支持for循环，也就是通过下标来遍历；<br>也可以用迭代器。</td></tr></tbody></table> 
<ul><li><strong>4、List、Set、Map的常见实现类</strong></li></ul> 
<table><thead><tr><th align="left">接口</th><th align="left">常用实现类</th></tr></thead><tbody><tr><td align="left">Map</td><td align="left">HashMap、LinkedHashMap、Hashtable、ConcurrentHashMap</td></tr><tr><td align="left">Set</td><td align="left">HashSet、LinkedHashSet</td></tr><tr><td align="left">List</td><td align="left">ArrayList、LinkedList、Stack</td></tr><tr><td align="left">Queue</td><td align="left">ArrayBlockingQueue、LinkedBlockingQueue</td></tr></tbody></table> 
<ul><li><strong>5、List、Set、Map的底层实现方式</strong></li></ul> 
<p>  List实现类底层实现方式：</p> 
<table><thead><tr><th align="left">集合类</th><th align="left">底层实现</th></tr></thead><tbody><tr><td align="left">Arraylist</td><td align="left">Object数组</td></tr><tr><td align="left">Vector</td><td align="left">Object数组</td></tr><tr><td align="left">LinkedList</td><td align="left">双向链表(JDK1.6之前为循环链表，JDK1.7取消了循环)</td></tr></tbody></table> 
<p>  Set实现类底层实现方式：</p> 
<table><thead><tr><th align="left">集合类</th><th align="left">底层实现</th></tr></thead><tbody><tr><td align="left">HashSet</td><td align="left">基于HashMap实现，用HashMap来保存元素</td></tr><tr><td align="left">LinkedHashSet</td><td align="left">LinkedHashSet继承HashSet，基于LinkedHashMap实现</td></tr><tr><td align="left">TreeSet</td><td align="left">红黑树(自平衡的排序二叉树)</td></tr></tbody></table> 
<p>  Map实现类底层实现方式：</p> 
<table><thead><tr><th align="left">集合类</th><th align="left">底层实现</th></tr></thead><tbody><tr><td align="left">HashMap</td><td align="left">JDK1.8之前HashMap由数组+链表组成的，数组是HashMap的主体，链表则是主要为了解决哈希冲突而存在。JDK1.8以后链表在元素较多时，可以转化为红黑树</td></tr><tr><td align="left">LinkedHashMap</td><td align="left">LinkedHashMap继承HashMap，所以它的底层仍然是由数组和链表或红黑树组成。另外，LinkedHashMap 在上面结构的基础上，增加了一条双向链表，使得上面的结构可以保持键值对的插入顺序。同时通过对链表进行相应的操作，实现了访问顺序（LRU）相关逻辑</td></tr><tr><td align="left">Hashtable</td><td align="left">和HashMap相似，由数组+链表组成，数组是Hashtable的主体，链表则是主要为了解决哈希冲突而存在</td></tr><tr><td align="left">TreeMap</td><td align="left">红黑树（平衡二叉排序树）</td></tr></tbody></table> 
<h4><a id="12__95"></a>1.2 迭代器</h4> 
<h5><a id="121_Iterator_96"></a>1.2.1 Iterator迭代器</h5> 
<p>  Iterator对象称为迭代器，迭代器可以对集合进行遍历（只能即单向遍历）。<br>   迭代器在代码里就是一个接口：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//集合中是否还有元素,有则返回true，否则返回fasle</span>
	<span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//第一次调用Iterator的next()方法时，它返回序列的第一个元素;</span>
	<span class="token comment">//其他情况使用next()获得序列中的下一个元素.</span>
	<span class="token class-name">E</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//删除进一次通过next()方法获取的元素</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"remove"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  Iterator使用示例：</p> 
<pre><code class="prism language-java">	<span class="token comment">//迭代器循环</span>
    <span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="122__ListIterator_120"></a>1.2.2 ListIterator迭代器</h5> 
<p>  ListIterator是Collection框架中的一个接口；是用于扩展Iterator接口的。<code>ListIterator，可以向前和向后遍历集合的元素，还可以添加、删除或修改集合中的任何元素</code>。<br>   ListIterator迭代器包含的方法：</p> 
<pre><code class="prism language-java">	<span class="token comment">//如果列表迭代器后面还有元素，则返回 true，否则返回false</span>
	<span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//返回列表中ListIterator指向位置后面的元素</span>
	<span class="token class-name">E</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//以逆向遍历列表，列表迭代器前面还有元素，则返回 true，否则返回false</span>
	<span class="token keyword">boolean</span> <span class="token function">hasPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//返回列表中ListIterator指向位置前面的元素</span>
	<span class="token class-name">E</span> <span class="token function">previous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//返回列表中ListIterator所需位置后面元素的索引</span>
	<span class="token keyword">int</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//返回列表中ListIterator所需位置前面元素的索引</span>
	<span class="token keyword">int</span> <span class="token function">previousIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//从列表中删除next()或previous()返回的最后一个元素</span>
	<span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//从列表中将next()或previous()返回的最后一个元素返回的最后一个元素更改为指定元素e</span>
	<span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将指定的元素插入列表，插入位置为迭代器当前位置之前</span>
	<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="123__143"></a>1.2.3 两者的区别</h5> 
<table><thead><tr><th align="left"></th><th align="left">Iterator</th><th align="left">ListIterator</th></tr></thead><tbody><tr><td align="left">遍历</td><td align="left">可以遍历所有集合，如Map，List，Set；但只能在向前方向上遍历集合中的元素。</td><td align="left">只能遍历List实现的对象，可以向前和向后遍历集合中的元素。</td></tr><tr><td align="left">添加元素</td><td align="left">无法向集合中添加元素</td><td align="left">可以向集合添加元素</td></tr><tr><td align="left">修改元素</td><td align="left">无法修改集合中的元素</td><td align="left">可以使用set方法修改集合中的元素</td></tr><tr><td align="left">是否可以获取元素索引</td><td align="left">无法获取集合中元素的索引</td><td align="left">可以获取集合中元素的索引</td></tr></tbody></table> 
<h4><a id="13__150"></a>1.3 线程安全*</h4> 
<p>  简单来说，如果代码在多线程下执行和在单线程下执行永远都能获得一样的结果，那么就是线程安全的；反之则是线程不安全。</p> 
<h5><a id="131__152"></a>1.3.1 线程安全的集合</h5> 
<p>  线程安全集合类可以分为三大类：</p> 
<ul><li><strong>1、遗留的线程安全集合</strong><br>   Hashtable、Vector（直接使用synchronized来保证线程安全，不建议使用，性能差）。<br>   Stack。</li><li><strong>2、使用Collections封装的线程安全集合</strong><br>   如：Collections.synchronizedList、Collections.synchronizedMap、Collections.synchronizedSet（不建议使用，性能差）。</li><li><strong>3、java.util.concurrent.</strong>*<br>   即JUC目录下的并发容器，包含三类关键词：Blocking、CopyOnWrite、Concurrent（建议使用，性能好）。<br>   1、Blocking：大部分实现基于锁，并提供用来阻塞的方法，如BlockingQueue阻塞队列，非常适合用于作为数据共享的通道。<br>   2、CopyOnWrite：拷贝读写，用空间换时间；<br>   3、Concurrent：内部很多操作使用CAS优化，一般可以提供较高吞吐量。</li></ul> 
<blockquote> 
 <p>ConcurrentHashMap：线程安全的HashMap。<br> CopyOnWriteArrayList：线程安全的List，在读多写少的场合性能非常好，远远好于Vector。<br> ConcurrentSkipListMap: 跳表实现的Map，使用跳表的数据结构进行快速查找。</p> 
</blockquote> 
<h5><a id="132__167"></a>1.3.2 线程不安全的集合</h5> 
<p>  即没有使用同步或并发策略的集合。这类集合在日常开发中也使用的较多，如：HashMap、ArrayList、LinkedList、HashSet、TreeSet、TreeMap。</p> 
<h4><a id="14_fail_169"></a>1.4 两种fail机制</h4> 
<h5><a id="141__failfast_170"></a>1.4.1 fail-fast机制*</h5> 
<p>  实现fail-fast机制的集合都是强一致性的，在各种遍历（不管是forEach遍历，还是iterator获取迭代器进行迭代）之前，都会提取保存modCount的值，用于后面每一次迭代/遍历前进行比较，不一致则抛出并发修改异常(ConcurrentModificationException)，终止遍历。<br>   <code>除了JUC目录下的并发集合，Collection中所有Iterator的实现类（如常见的ArrayList、LinkedList、HashMap）都是按fail-fast来设计的，这些集合都是线程不安全的</code>。</p> 
<p>  以ArrayList为例，有多处代码都能抛出ConcurrentModificationException：</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Itr</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//迭代器游标</span>
        <span class="token keyword">int</span> cursor<span class="token punctuation">;</span>     
        <span class="token comment">//最后一个元素索引为-1</span>
        <span class="token keyword">int</span> lastRet <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
        <span class="token comment">//初始化"期望的modCount"expectedModCount，如果在迭代过程中集合元素</span>
        <span class="token comment">//发生了变化，则modCount就会跟着变化，此时用expectedModCount和modCount</span>
        <span class="token comment">//比较，就能知道这次集合元素变化</span>
        <span class="token keyword">int</span> expectedModCount <span class="token operator">=</span> modCount<span class="token punctuation">;</span>
		<span class="token comment">//是否还有下一个元素</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> cursor <span class="token operator">!=</span> size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取下一个元素</span>
        <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> cursor<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elementData <span class="token operator">=</span> <span class="token class-name">ArrayList</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>elementData<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> elementData<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cursor <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> elementData<span class="token punctuation">[</span>lastRet <span class="token operator">=</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//删除元素</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">ArrayList</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>lastRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cursor <span class="token operator">=</span> lastRet<span class="token punctuation">;</span>
                lastRet <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                expectedModCount <span class="token operator">=</span> modCount<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IndexOutOfBoundsException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//省略一些代码</span>
		<span class="token comment">//检测在迭代过程中，集合元素是否发生了变化</span>
        <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>modCount <span class="token operator">!=</span> expectedModCount<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  modCount表示对ArrayList中元素真正的修改次数，对ArrayList内容的修改都将增加这个值，在迭代器初始化过程中会将这个值赋给迭代器的expectedModCount。<br>   在迭代过程中，会判断modCount跟expectedModCount是否相等，如果不相等就表示ArrayList里的元素已经被修改，此时就会抛出ConcurrentModificationException异常。<br>   上述代码中，<code>modCount声明为volatile，保证线程之间修改的可见性</code>。</p> 
<h5><a id="142___failfast_227"></a>1.4.2 不同情形下的fail-fast</h5> 
<ul><li><strong>多线程下的fail-fast</strong><br>   常见的情形：存在两个线程（线程1、线程2），线程1通过Iterator在遍历集合A中的元素，在某个时候线程2增删了集合A中的数据，那么这个时候程序就会抛出ConcurrentModificationException异常，从而产生fail-fast事件。示例：</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FailFastTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread1</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{<!-- --></span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> s <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
	                   <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	               <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	               <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
               <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread2</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"thread2:"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                          list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
	                   <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	               <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	               <span class="token punctuation">}</span>
                    i <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
               list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token class-name">MyThread1</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">MyThread2</span> thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          thread1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"thread1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          thread2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"thread2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  启动两个线程，其中一个线程1对list进行迭代，另一个线程2在线程1的迭代过程中remove一个元素，结果也是抛出了ConcurrentModificationException：<br> <img src="https://images2.imgbox.com/40/f2/FnzLicV0_o.png" alt=""></p> 
<ul><li><strong>单线程下的fail-fast</strong><br>   当然，不仅是多个线程，单个线程也会出现fail-fast机制，因为在单线程下也可能会修改集合里的元素数量，导致modCount改变。<br>   单线程下的fail-fast示例：</li></ul> 
<pre><code class="prism language-java">	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         i <span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  并使用迭代器遍历ArrayList集合，在遍历过程中，remove一个元素，这个时候，就会发生fail-fast。<br> <img src="https://images2.imgbox.com/6b/40/ghjT6CtO_o.png" alt=""></p> 
<h5><a id="143__failfast_303"></a>1.4.3 解决fail-fast的方法</h5> 
<ul><li><strong>1、将线程不安全的集合转换成线程安全的集合</strong><br>   比如使用Collections.synchronizedXxx将线程不安全的集合转换成线程安全的集合。示例：</li></ul> 
<pre><code class="prism language-java">	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> synchronizedList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><strong>2、直接使用线程安全的集合</strong><br>   使用JUC目录下的线程安全类。如CopyOnWriteArrayList替换ArrayList，CopyOnWriteArrayList的所有可变操作（add、set等）都是通过对底层数组进行一次新的复制来实现的。示例：</li></ul> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//替换为</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  CopyOnWriterArrayList在是使用上跟 ArrayList几乎一样， CopyOnWriter是写时复制的容器(COW)，在读写时是线程安全的。该容器在对add和remove等操作时，并不是在原数组上进行修改，而是将原数组拷贝一份，在新数组上进行修改，待完成后，才将指向旧数组的引用指向新数组，所以对于 CopyOnWriterArrayList在迭代过程并不会发生fail-fast现象。<code>CopyOnWrite容器只能保证数据的最终一致性，不能保证数据的实时一致性</code>。</p> 
<ul><li><strong>3、 不要使用集合自身的删除方法，而使用集合中迭代器的删除方法</strong><br>   以ArrayList为例，迭代器的remove方法代码：</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ArrayList</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>lastRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cursor <span class="token operator">=</span> lastRet<span class="token punctuation">;</span>
        lastRet <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        expectedModCount <span class="token operator">=</span> modCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IndexOutOfBoundsException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  可以看到，迭代器里的remove方法不会修改modCount的值，并且不会对后面的遍历造成影响。但是该方法remove不能指定元素，只能remove当前遍历过的那个元素，这也是该方法的局限性。使用迭代器里remove方法示例：</p> 
<pre><code class="prism language-java">
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//迭代器的remove()方法</span>
         <span class="token punctuation">}</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         i <span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="133__failsafe_353"></a>1.3.3 fail-safe机制*</h5> 
<p>  <code>JUC目录下的集合用的是fail-safe机制，该机制允许在遍历集合元素的同时增删元素</code>。不过不同的集合，实现原理不一样，接下来以CopyOnWriteArrayList、ConcurrentHashMap为例解释。</p> 
<ul><li><strong>CopyOnWriteArrayList</strong><br>   CopyOnWriteArrayList的实现方式是每次更新操作都会复制一份出来并替换原来的Object数组，不会影响到创建迭代器时拿到的Object数组的迭代遍历，写操作也不会阻塞读操作。<br>   CopyOnWriteArrayList的迭代器和for遍历并没有检测并发修改异常的操作，但是迭代器的set()、add()、remove()会抛出UnsupportedOperationException的异常。也就是说遍历只支持读操作，读和写操作的是两个集合。<br>   CopyOnWriteArrayList是弱一致性的，允许迭代时修改数据，代价是迭代时看到的可能不是最新的数据，保证了可用性。</li><li><strong>ConcurrentHashMap</strong><br>   ConcurrentHashMap的keys()、values()、entrySet()同样也没有检测并发修改的操作。<br>   keySet()、entrySet()支持添加删除操作。<br>   ConcurrentHashMap中节点的val和next都是volatile修饰的，如果变化发生在已遍历过的部分，迭代器就不会反映出来，而如果变化发生在未遍历过的部分，迭代器就会发现并反映出来。也就是说用volatile保证了数据在多线程情况下的可见性。</li><li><strong>总结</strong><br>   <code>JUC包下的容器都是fail-safe，都是在数据的一致性跟可用性中选择了可用性，允许出现数据的短期不一致，但是保证最终数据的一致性</code>。</li></ul> 
<h4><a id="15__365"></a>1.5 集合相关问题</h4> 
<h5><a id="151__366"></a>1.5.1 集合和数组的区别</h5> 
<table><thead><tr><th align="left"></th><th align="left">集合</th><th align="left">数组</th></tr></thead><tbody><tr><td align="left">长度是否可变</td><td align="left">可变</td><td align="left">不可变</td></tr><tr><td align="left">存储的数据类型</td><td align="left">只能存储引用数据类型</td><td align="left">可以存储基本数据类型，也可以存储引用数据类型</td></tr><tr><td align="left">存储的元素是否类型一致</td><td align="left">可以是不同类型的数据</td><td align="left">必须是同一个类型的数据</td></tr></tbody></table> 
<h5><a id="152__372"></a>1.5.2 怎么确保一个集合不能被修改</h5> 
<p>  可以使用Collections.unmodifiableCollection(Collection c) 方法来创建一个只读集合，这样改变集合的任何操作都会抛出Java. lang. UnsupportedOperationException异常。 示例：</p> 
<pre><code class="prism language-java">	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	list<span class="token punctuation">.</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clist <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span> <span class="token function">unmodifiableCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	clist<span class="token punctuation">.</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 运行时此行报错</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span> out<span class="token punctuation">.</span> <span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="153_Iteratoradd_381"></a>1.5.3 为何没有像Iterator.add()这样的方法，向集合中添加元素</h5> 
<p>  语义不明。因为Iterator的协议不能确保迭代的次序，添加元素时无法确定添加的位置。</p> 
<h5><a id="154__383"></a>1.5.4 集合框架中的泛型有什么优点</h5> 
<p>  确保同一集合里存储的是相同类型的元素，避免使用集合中的元素类型不一致时产生ClassCastException。</p> 
<h5><a id="155__385"></a>1.5.5 用哪两种方式来实现集合的排序</h5> 
<p>  1、直接使用排好序的集合，如TreeSet或TreeMap。<br>   2、也可以使用有顺序的的集合，如List，然后通过Collections.sort()排序。</p> 
<h5><a id="156__388"></a>1.5.6 集合框架使用注意事项</h5> 
<ul><li><strong>1、根据需要选择正确的集合类型</strong></li><li><strong>2、集合初始化时，指定集合初始值大小</strong><br>   如HashMap使用HashMap(int initialCapacity) 初始化，如果暂时无法确定集合大小，那么指定默认值(16)即可。这样可以减少由于扩容导致的性能损耗。</li><li><strong>3、使用JDK提供的不可变类(如Integer、String)作为Map的key</strong><br>   可以避免自己实现hashCode()和equals()。</li><li><strong>4、使用集合转数组的方法，必须使用集合的toArray(T[ ] array)，传入的是类型完全一致、长度为0的空数组</strong><br>   反例：直接使用toArray无参方法存在问题，此方法返回值只能是Object[ ]类，在进行类型转换时，可能会出现ClassCastException错误。<br>   正例：</li></ul> 
<pre><code class="prism language-java">	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"qwe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  说明：使用toArray带参方法，数组空间大小的length：</p> 
<blockquote> 
 <p>1） 等于0，动态创建与size相同的数组，性能最好。<br> 2） 大于0但小于size，重新创建大小等于size的数组，增加GC负担。<br> 3） 等于size，在高并发情况下，数组创建完成之后，size正在变大的情况下，负面影响与2相同。<br> 4） 大于size，空间浪费，且在size处插null值，存在NPE隐患。</p> 
</blockquote> 
<h3><a id="Collections_409"></a>二、Collections工具类</h3> 
<p>  Collections是一个集合工具类，作用就是为集合框架提供某些功能实现。<br>   Collections工具类常用方法：<br>    1）排序。<br>    2）查找、替换。<br>    3）同步控制。不推荐，需要线程安全的集合类型时，可以使用JUC包下的并发集合。</p> 
<h4><a id="21__415"></a>2.1 排序相关方法</h4> 
<pre><code class="prism language-java">	<span class="token comment">//反转</span>
	<span class="token keyword">void</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">)</span>
	<span class="token comment">//随机排序</span>
	<span class="token keyword">void</span> <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">)</span>
	<span class="token comment">//按自然排序的升序排序</span>
	<span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">)</span>
	<span class="token comment">//定制排序，由Comparator控制排序逻辑</span>
	<span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">,</span> <span class="token class-name">Comparator</span> c<span class="token punctuation">)</span>
	<span class="token comment">//交换两个索引位置的元素</span>
	<span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">,</span> <span class="token keyword">int</span> i <span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="211_Collectionssort_428"></a>2.1.1 Collections.sort的底层实现</h5> 
<p>  在JDK1.6中，Collections.sort方法使用的是MergeSort(归并排序)；在JDK1.7中，Collections.sort的内部实现换成了TimeSort。<br>   Timsort是结合了合并排序（merge sort）和插入排序（insertion sort）而得出的排序算法。</p> 
<ul><li><strong>Timsort的核心过程</strong><br>   1、数组个数小于32的情况使用二分插入排序。<br>   2、数组大于32时， 先算出一个合适的大小，在将输入按其升序和降序特点进行了分区。排序的输入的单位不是一个个单独的数字，而是一个个的分区。其中每一个分区叫一个run。针对这些run序列，每次拿一个run出来按规则进行合并。每次合并会将两个run合并成一个run。合并的结果保存到栈中。合并直到消耗掉所有的run，这时将栈上剩余的 run合并到只剩一个run为止。这时这个仅剩的run便是排好序的结果。</li></ul> 
<h5><a id="212_Collectionssort_434"></a>2.1.2 Collections.sort的两种形式</h5> 
<p>  Collections.sort方法有两种重载的形式：第一种要求传入的待排序容器中存放的对象必须实现Comparable接口以实现元素的比较；第二种不强制性的要求容器中的元素必须可比较，但是要求传入第二个参数，参数是Comparator接口的子类型（需要重写compare方法实现元素的比较），相当于一个定义的排序规则。<br>   这两种排序方式对集合元素的要求，在Collections的源码中也可以看出：</p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span>
</code></pre> 
<ul><li><strong>Comparable和Comparator</strong><br>   Comparable出自java.lang包，有个compareTo(Object obj)方法用来排序。<br>   Comparator出自java.util包，有个compare(Object obj1, Object obj2)方法用来排序。<br>   一般需要对一个集合使用自定义排序时，就至少要实现上面的2个接口之一。</li></ul> 
<h5><a id="213_Comparable_445"></a>2.1.3 Comparable*</h5> 
<p>  <code>Comparable可以认为是一个内比较器</code>，实现了Comparable接口的类所产生的对象，就可以和同类型对象比较。实现Comparable接口需要重写compareTo方法，compareTo方法也被称为<code>自然比较方法</code>。compareTo方法的返回值是int，有三种情况：</p> 
<blockquote> 
 <ol><li>对象a大于对象b（compareTo方法里面的对象），那么返回正整数。</li><li>对象a等于对象b（compareTo方法里面的对象），那么返回0。</li><li>对象a小于对象b（compareTo方法里面的对象），那么返回负整数。</li></ol> 
</blockquote> 
<p>  Comparable接口使用示例：</p> 
<pre><code class="prism language-java"><span class="token comment">//实体类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> name<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> age<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//重写compareTo方法实现按年龄来排序</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Person</span> o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">&gt;</span> o<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">&lt;</span> o<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  测试类：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>

    	<span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> pdata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	pdata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	pdata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	pdata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	pdata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"赵六"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"xiaohong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 得到key的值的同时得到key所对应的值</span>
    	<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> pdata<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Person</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  结果：</p> 
<blockquote> 
 <p>5-赵六<br> 10-王五<br> 20-李四<br> 30-张三</p> 
</blockquote> 
<h5><a id="214_Comparator_515"></a>2.1.4 Comparator*</h5> 
<p>  <code>Comparator可以认为是一个外比较器</code>，有两种情况可以使用实现Comparator接口的方式：</p> 
<blockquote> 
 <ol><li>一个对象不支持自己和自己比较（没有实现Comparable接口），但是又想对两个对象进行比较。</li><li>一个对象实现了Comparable接口，但是开发者认为compareTo方法中的比较方式并不是自己想要的那种比较方式。</li></ol> 
</blockquote> 
<p>  Comparator接口里面有一个compare方法，方法有两个参数<strong>T o1</strong>和<strong>T o2</strong>。这两个参数是泛型的表示方式，分别表示待比较的两个对象，方法返回值和Comparable接口一样是int，有三种情况：</p> 
<blockquote> 
 <ol><li>o1大于o2，返回正整数。</li><li>o1等于o2，返回0。</li><li>o1小于o3，返回负整数。</li></ol> 
</blockquote> 
<p>  示例：</p> 
<pre><code class="prism language-java">    	<span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> arrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"原始数组:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    	<span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"原始排序:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 定制排序</span>
    	<span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    		<span class="token annotation punctuation">@Override</span>
    		<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> o1<span class="token punctuation">,</span> <span class="token class-name">Integer</span> o2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    			<span class="token keyword">return</span> o2<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span>
    	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"定制排序："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  结果：</p> 
<blockquote> 
 <p>原始数组:<br> [-1, 3, 3, -5, 7, 4, -9, -7]<br> 原始排序:<br> [-9, -7, -5, -1, 3, 3, 4, 7]<br> 定制排序：<br> [7, 4, 3, 3, -1, -5, -7, -9]</p> 
</blockquote> 
<h5><a id="215_ComparableComparator_559"></a>2.1.5 Comparable和Comparator的区别*</h5> 
<p>  Comparable和Comparator接口都可以用来实现集合中元素的比较、排序。<br>   像Integer、String等这些基本类型的Java封装类都已经实现了Comparable接口，这些类对象本身就支持元素比较，直接调用Collections.sort()就可以对集合中元素的排序。<br>   而自定义类的List序列，当这个对象不支持元素比较或者元素比较函数不能满足要求时，就需要写一个比较器(即写一个实现了Comparator的类)来完成两个对象之间大小的比较。</p> 
<p>  Comparable和Comparator的具体区别：</p> 
<table><thead><tr><th align="left">参数</th><th align="left">Comparable</th><th align="left">Comparator</th></tr></thead><tbody><tr><td align="left">排序逻辑</td><td align="left"><code>排序逻辑必须在待排序对象的类中，所以称为自然排序</code></td><td align="left">排序逻辑在另一个类中实现</td></tr><tr><td align="left">实现接口</td><td align="left">实现Comparable接口</td><td align="left">实现Comparator接口</td></tr><tr><td align="left">排序方法</td><td align="left">int compareTo(Object o1)</td><td align="left">int compare(Object o1,Object o2)</td></tr><tr><td align="left">触发排序方式</td><td align="left">Collections.sort(List list)</td><td align="left">Collections.sort(List list, Comparator com)</td></tr><tr><td align="left">接口所在包</td><td align="left">java.lang</td><td align="left">java.util</td></tr><tr><td align="left">耦合性</td><td align="left">强</td><td align="left">弱(不修改原有代码，扩展性好)</td></tr></tbody></table> 
<h4><a id="22__574"></a>2.2 查找替换方法</h4> 
<pre><code class="prism language-java">	<span class="token comment">//对List进行二分查找，返回索引，List必须是有序的</span>
	<span class="token keyword">int</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span>
	<span class="token comment">//根据元素的自然顺序，返回最大的元素</span>
	<span class="token keyword">int</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Collection</span> coll<span class="token punctuation">)</span>
	<span class="token comment">//根据定制排序，返回最大元素，排序规则由Comparatator类控制</span>
	<span class="token keyword">int</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Collection</span> coll<span class="token punctuation">,</span> <span class="token class-name">Comparator</span> c<span class="token punctuation">)</span>
	<span class="token comment">//用指定的元素代替指定list中的所有元素</span>
	<span class="token keyword">void</span> <span class="token function">fill</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span>
	<span class="token comment">//统计元素出现次数</span>
	<span class="token keyword">int</span> <span class="token function">frequency</span><span class="token punctuation">(</span><span class="token class-name">Collection</span> c<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">)</span>
	<span class="token comment">//统计target在list中第一次出现的索引，找不到则返回-1</span>
	<span class="token keyword">int</span> <span class="token function">indexOfSubList</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">,</span> <span class="token class-name">List</span> target<span class="token punctuation">)</span>
	<span class="token comment">//用新元素替换旧元素</span>
	<span class="token keyword">boolean</span> <span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token class-name">List</span> list<span class="token punctuation">,</span> <span class="token class-name">Object</span> oldVal<span class="token punctuation">,</span> <span class="token class-name">Object</span> newVal<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="23__591"></a>2.3 同步控制方法</h4> 
<p>  Collections提供了多个synchronizedXxx()方法，该方法可以将指定集合（如：HashSet、TreeSet、ArrayList、LinkedList、HashMap、TreeMap等）包装成线程同步的集合，从而解决多线程并发访问集合时的线程安全问题。 示例：</p> 
<pre><code class="prism language-java">	<span class="token comment">//返回指定Collection支持的线程安全的Collection</span>
	<span class="token function">synchronizedCollection</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> 
	<span class="token comment">//返回指定List支持的线程安全的List</span>
	<span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span>
	<span class="token comment">//返回由指定Map支持的线程安全的Map</span>
	<span class="token function">synchronizedMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> m<span class="token punctuation">)</span>
	<span class="token comment">//返回指定Set支持的线程安全的set</span>
	<span class="token function">synchronizedSet</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> s<span class="token punctuation">)</span> 
</code></pre> 
<p>  不过不建议这些方法，因为效率低，需要线程安全的集合类型时请考虑使用JUC包下的并发集合，如：CopyOnWriteArrayList 、ConcurrentHashMap 、CopyOnWriteArraySet。</p> 
<h4><a id="24__Collections_604"></a>2.4 使用Collections的最佳实践</h4> 
<p>  1）使用正确的集合类。如不需要同步列表，使用ArrayList而不是Vector。<br>   2）优先使用并发集合，而不是对集合进行同步。<br>   3）使用接口代表和访问集合，如使用List存储ArrayList，使用Map存储HashMap等等。<br>   4）使用迭代器来循环集合。<br>   5）使用集合的时候使用泛型。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/37b22062b770a3bbec4fc93512a098f1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">x-cmd pkg | haxor-news - Hacker News CLI</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/49684fb705706ec72bed0e68367938aa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java集合（三）CopyOnWriteArrayList、Vector、Stack</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>