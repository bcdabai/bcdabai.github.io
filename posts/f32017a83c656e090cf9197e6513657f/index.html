<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docker学习（一）在Docker容器中部署一个基于TCP的简单Java应用——Windows - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Docker学习（一）在Docker容器中部署一个基于TCP的简单Java应用——Windows" />
<meta property="og:description" content="Docker学习（一）Docker入门、部署一个简单的基于TCP的Java应用——Windows 目录环境准备安装Dcoker运行hello-world部署自己的java应用准备可运行jar包为Docker容器准备java环境构建镜像并运行 附录 目录 在上云计算这门课——Docker部署实验，因为要求是部署自己的java应用，就做个平平无奇java的TCP应用部署的笔记和分享。
环境准备 操作系统：Windows10专业版使用软件：Docker-for-windows 19.03.8、Eclipse photon（其他java ide也可以） 安装Dcoker 安装过程中忘记截图了，这篇文章写得就挺详细的，跟着安装应该不会有大问题: https://www.runoob.com/docker/windows-docker-install.html
注意事项：
1） Windows家庭版需要先安装Docker ToolBox。防止Windows的平台虚拟化与Docker ToolBox互相冲突：控制面板–&gt;程序和功能–&gt;启用或关闭Windows功能–&gt;Windows功能–&gt;关闭Virtual Machine Platform、Windows Hyper-V platform。
2） Windows专业版在安装之前需要在本地先开启Windows自带的Hyper-V服务，开启后重启电脑服务才能生效。
3） VMware的虚拟机服务与Hyper-V不能并存，这时候你开启虚拟机会出现下面的报错。解决办法…后续尝试了再补充吧…
补充：由于目前用的Hyper-V和VMware的虚拟化技术无法兼容，还是分开用吧……其他人的答案也是启动的时候选择加载Hyper-V还是VMware，既然不能同时用就需要用谁再开吧，但是看到VMware的20H1好像支持同时使用，期待后面的版本吧。
Dcoker 成功安装后，使用dcoker --version查看可安装的Dcoekr版本，验证Docker是否成功安装：
运行hello-world 在CMD运行命令docker run hello-world ，成功运行的情况截图如下：
如果出现拉取超时导致失败的情况，一般是网络问题，再次运行该命令可以成功，或者搜索net/http: TLS handshake timeout更换国内的镜像源：
部署自己的java应用 准备可运行jar包 1. 项目结构
编写自己的java应用，一个非常简单的项目(之前学java写的代码逻辑可能不太严谨凑合用吧)，项目结构如下：
2. Server.java
package tcp; /* 服务器接收客户端发送的in.txt文件中的内容，并向out.txt中写入 * 当连接服务器的客户端数量达到5时不再接受连接，关闭服务器的socket */ import java.io.DataInputStream; import java.io.File; import java.io.FileOutputStream; import java.io.IOException; import java.io.InputStream; import java.net.ServerSocket; import java.net.Socket; import java.util.Scanner; public class Server { public static int client_num = 0;//初始化客户端连接数量 private static int MAX_NUM = 5;//可连接的客户端数量上限为5 public static boolean flag = true;//flag用于表示是否接受连接 public static void main(String[] args) { ServerSocket server = null; try { server = new ServerSocket(6666); // 监听6666端口的服务器Socket } catch (IOException e1) { System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f32017a83c656e090cf9197e6513657f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-21T18:45:36+08:00" />
<meta property="article:modified_time" content="2020-04-21T18:45:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Docker学习（一）在Docker容器中部署一个基于TCP的简单Java应用——Windows</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Docker学习（一）Docker入门、部署一个简单的基于TCP的Java应用——Windows</h4> 
 <ul><li><a href="#_1" rel="nofollow">目录</a></li><li><ul><li><a href="#_5" rel="nofollow">环境准备</a></li><li><a href="#Dcoker_8" rel="nofollow">安装Dcoker</a></li><li><a href="#helloworld_21" rel="nofollow">运行hello-world</a></li><li><a href="#java_26" rel="nofollow">部署自己的java应用</a></li><li><ul><li><a href="#jar_28" rel="nofollow">准备可运行jar包</a></li><li><a href="#Dockerjava_205" rel="nofollow">为Docker容器准备java环境</a></li><li><a href="#_210" rel="nofollow">构建镜像并运行</a></li></ul> 
   </li><li><a href="#_244" rel="nofollow">附录</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>目录</h2> 
<p>在上云计算这门课——Docker部署实验，因为要求是部署自己的java应用，就做个<strong>平平无奇java的TCP应用</strong>部署的笔记和分享。</p> 
<h3><a id="_5"></a>环境准备</h3> 
<ol><li>操作系统：Windows10专业版</li><li>使用软件：Docker-for-windows 19.03.8、Eclipse photon（其他java ide也可以）</li></ol> 
<h3><a id="Dcoker_8"></a>安装Dcoker</h3> 
<ol><li> <p>安装过程中忘记截图了，这篇文章写得就挺详细的，跟着安装应该不会有大问题: <a href="https://www.runoob.com/docker/windows-docker-install.html" rel="nofollow">https://www.runoob.com/docker/windows-docker-install.html</a></p> </li><li> <p>注意事项：<br> 1） Windows家庭版需要先安装Docker ToolBox。防止Windows的平台虚拟化与Docker ToolBox互相冲突：<strong>控制面板–&gt;程序和功能–&gt;启用或关闭Windows功能–&gt;Windows功能–&gt;关闭Virtual Machine Platform、Windows Hyper-V platform</strong>。<br> 2） Windows专业版在安装之前需要在本地先开启Windows自带的Hyper-V服务，开启后重启电脑服务才能生效。<br> 3） VMware的虚拟机服务与Hyper-V不能并存，这时候你开启虚拟机会出现下面的报错。解决办法…后续尝试了再补充吧…<br> 补充：由于目前用的Hyper-V和VMware的虚拟化技术无法兼容，还是分开用吧……其他人的答案也是启动的时候选择加载Hyper-V还是VMware，既然不能同时用就需要用谁再开吧，但是看到VMware的<a href="https://blogs.vmware.com/workstation/2020/01/vmware-workstation-tech-preview-20h1.html" rel="nofollow">20H1</a>好像支持同时使用，期待后面的版本吧。<br> <img src="https://images2.imgbox.com/f6/b3/OKKU7Bjd_o.png" alt="VMware的报错" width="400"><img src="https://images2.imgbox.com/24/98/tKdV4lZc_o.png" alt="VMware20H1" width="700"></p> </li><li> <p>Dcoker 成功安装后，使用<code>dcoker --version</code>查看可安装的Dcoekr版本，验证Docker是否成功安装：<br> <img src="https://images2.imgbox.com/d8/9f/osU6TdEu_o.png" alt="Dcocker安装版本测试" width="400"></p> </li></ol> 
<h3><a id="helloworld_21"></a>运行hello-world</h3> 
<ol><li>在CMD运行命令<code>docker run hello-world</code> ，成功运行的情况截图如下：<br> <img src="https://images2.imgbox.com/a2/70/vPSTRlEc_o.png" alt="在这里插入图片描述"></li><li>如果出现拉取超时导致失败的情况，一般是网络问题，再次运行该命令可以成功，或者搜索<strong>net/http: TLS handshake timeout</strong>更换国内的镜像源：<br> <img src="https://images2.imgbox.com/cf/ea/c98eh7aW_o.png" alt="拉取报错"></li></ol> 
<h3><a id="java_26"></a>部署自己的java应用</h3> 
<hr> 
<h4><a id="jar_28"></a>准备可运行jar包</h4> 
<p><strong>1. 项目结构</strong><br> 编写自己的java应用，一个非常简单的项目(之前学java写的代码逻辑可能不太严谨凑合用吧)，项目结构如下：<br> <img src="https://images2.imgbox.com/7f/5e/IfH9hZvB_o.png" alt="在这里插入图片描述" width="300"><br> <strong>2. Server.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> tcp<span class="token punctuation">;</span>

<span class="token comment">/* 服务器接收客户端发送的in.txt文件中的内容，并向out.txt中写入
 * 当连接服务器的客户端数量达到5时不再接受连接，关闭服务器的socket */</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>DataInputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ServerSocket<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Socket<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Scanner<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> client_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//初始化客户端连接数量</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MAX_NUM <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//可连接的客户端数量上限为5</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//flag用于表示是否接受连接</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		
		ServerSocket server <span class="token operator">=</span> null<span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 监听6666端口的服务器Socket</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ERROR:In Server Socket Creation."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Listening on port 6666"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 输出监听端口号</span>

		<span class="token comment">/* 达到一定数量的客户端连接后拒绝连接，否则始终保持监听连接状态 */</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 	
			<span class="token keyword">if</span> <span class="token punctuation">(</span>client_num <span class="token operator">==</span> MAX_NUM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>		
				flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				Socket socket <span class="token operator">=</span> null<span class="token punctuation">;</span>	<span class="token comment">// 创建服务于当前连接的socket</span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					socket <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">// 接受一个客户端的连接请求</span>
					client_num<span class="token operator">++</span><span class="token punctuation">;</span>
					
					System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Client "</span> <span class="token operator">+</span> client_num <span class="token operator">+</span> <span class="token string">" connected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出连接的客户号</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				serverThread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">serverThread</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>client_num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个新的线程进行服务</span>
				thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开启服务线程</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">/*关闭服务器socket，不再接受连接请求，但是还有未完成工作的服务线程*/</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 当连接的客户端数量达到5时关闭整个服务器</span>
			System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Max connection,server closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">serverThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> client_num<span class="token punctuation">;</span><span class="token comment">// 每个服务线程所服务的客户序号</span>
	<span class="token keyword">private</span> Socket socket<span class="token punctuation">;</span><span class="token comment">// 每个服务线程私有的socket</span>

	<span class="token keyword">public</span> <span class="token function">serverThread</span><span class="token punctuation">(</span>Socket socket<span class="token punctuation">,</span><span class="token keyword">int</span> client_num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>client_num <span class="token operator">=</span> client_num<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span> socket<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			String path <span class="token operator">=</span> <span class="token string">"out.txt"</span><span class="token punctuation">;</span>
			<span class="token keyword">byte</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			InputStream in <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收来自客户端的输入数据流</span>
			DataInputStream dis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span> 
			Scanner scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			File file2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写入文件，如果不存在则创建一个新文件</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file2<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
	                file2<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span>
	        FileOutputStream fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        
	        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           
	        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">=</span> dis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        
			<span class="token comment">//写完数据后关闭相关的流</span>
			scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			dis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\tSocket "</span> <span class="token operator">+</span> client_num <span class="token operator">+</span> <span class="token string">" closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span>  e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3. Client.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> tcp<span class="token punctuation">;</span>
<span class="token comment">/*客户端向6666号端口发起连接请求，传输in.txt文件内容*/</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>BufferedInputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ByteArrayOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileInputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>OutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Socket<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Scanner<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Socket socket <span class="token operator">=</span> null<span class="token punctuation">;</span>
		Scanner scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//用于读取文件流中的内容   </span>
		String path <span class="token operator">=</span> <span class="token string">"in.txt"</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Conneted to server."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			
			OutputStream out  <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 客户端的输出数据流</span>
			<span class="token comment">//文件--》缓冲--》字节流--》字节数组--》由socket的输出流发送</span>
			<span class="token comment">//从文件读取数据为字节流</span>
			BufferedInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
	        ByteArrayOutputStream output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
	     	     
	        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      
	        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>      
	            output<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>      
	        <span class="token punctuation">}</span>      
	        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
	     
	        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> output<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将读取的字节流转换为字节数组      </span>
	        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Sent bytes :"</span> <span class="token operator">+</span> content<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>   
            
	        <span class="token comment">//客户端输入write之后向服务器发送数据</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
				out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将字节数组写到输出流中进行发送</span>
			<span class="token punctuation">}</span>
			
			<span class="token comment">//客户端输入end关闭当前client的socket连接</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\tSocket closed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>4. 将服务端代码导出为可运行jar包</strong></p> 
<ul><li>编译两个类并顺利运行后导出，在Eclipse中，按照<code>File--&gt;Export--&gt;输入jar--&gt;选择Runnable JAR file--&gt;Next</code>的顺序：<br> <img src="https://images2.imgbox.com/5d/66/PMby7Y9i_o.png" alt="导出可运行jar包" width="600"></li><li>选择你要导出的类和保存的位置，选一个空的文件夹方便后面整理Docker需要的文件，为你导出的包自定义名字：<br> <img src="https://images2.imgbox.com/6f/40/09LJ37a1_o.png" alt="在这里插入图片描述" width="600"></li><li>提示：如果想测试导出jar包是否成功，则同时导出client的jar包，在cmd中使用<code>java -jar server-demo1.jar(你的jar包名称)</code>，同时打开另一个cmd使用<code>java -jar client-demo1.jar(你的jar包名称)</code>测试导出后的情况。</li><li>在运行客户端之前记得创建自己的<code>in.txt</code>写入内容，在eclipse里面客户端运行的情况和实验用的in.txt内容如下:<br> <img src="https://images2.imgbox.com/fb/88/QXQSxjzn_o.png" alt="在这里插入图片描述" width="500"></li></ul> 
<h4><a id="Dockerjava_205"></a>为Docker容器准备java环境</h4> 
<ol><li>由于本项目只需一个可以运行jvm的环境，所以理论上只需要jre的镜像也能运行，为了后面的开发方便我拉取了一个jdk8的镜像，当然你也可以把自己机器上的环境打包成一个镜像。运行<code>docker search jdk</code>可以看到一些别人已经打包好的镜像，我选了Oracle的jdk8，也就是这个在<strong>gmaslowski</strong>库里的：<br> <img src="https://images2.imgbox.com/72/2a/506JbcVo_o.png" alt="搜索可用jdk" width="800"></li><li>使用<code>docker pull gmaslowski/jdk</code>拉取到本地，<code>docker images</code>查看本地现在有的镜像：<br> <img src="https://images2.imgbox.com/7c/0f/WGHsFf9m_o.png" alt="在这里插入图片描述" width="600"></li></ol> 
<h4><a id="_210"></a>构建镜像并运行</h4> 
<p><strong>1. 为镜像创建Dockerfile</strong><br> 在导出jar包的文件夹中创建一个Dcokerfile.txt，用于构建镜像，文件内容如下：</p> 
<pre><code class="prism language-text">#指定以该jdk为基础镜像来构建这个app的镜像
FROM gmaslowski/jdk

#WORKDIR用于指定容器的的一个目录，容器启动时执行的命令会在该目录下执行
WORKDIR /

#将当前的测试jar复制到容器的根目录下
ADD . /

#暴露容器端口为50051，Docker镜像告知Docker宿主机docker镜像监听了50051端口
EXPOSE 50051

#指定容器启动的时候执行的命令
ENTRYPOINT ["java","-jar","server-demo1.jar"]
</code></pre> 
<p><strong>2.从Dcokerfile构建镜像</strong></p> 
<ul><li>进入存有Dockerfile的文件夹中，运行<code>docker build -t server_demo1 -f ./Dockerfile.txt .</code>来构建镜像，不要忘记最后的<code>.</code></li><li>命令中<code>-t</code>参数后面写你要创建的镜像名称，<code>-f</code>后写Dockerfile，Dockerfile的位置要相对于你cmd启动路径。<br> <img src="https://images2.imgbox.com/c7/99/ar6msY2n_o.png" alt="在这里插入图片描述" width="600"></li><li>控制台输出的都是Dockerfile里语句的执行过程，最后可能会出现图中的<code>SECURITY WRNING</code>，说在windows构建镜像时用了非windows的主机，在这里并不影响运行，略。</li></ul> 
<p><strong>3.运行容器</strong></p> 
<ul><li>使用<code>docker images</code>查看镜像，找到刚刚创建的镜像名称（没错的话就是你<code>-t</code>后面的名字…）</li><li>使用命令<code>docker run -p 4000:6666 server_demo1</code>来运行创建容器并运行，<code>-p</code>做了一个指定的端口映射，将对宿主机<code>4000</code>号端口的访问转发到容器的<code>6666</code>号端口。这里端口的选取是因为写Server程序的时候开启了6666号端口，而主机的端口只要从65536个里选一个没有被占用的。别写成大写的P，那是内部端口随机映射到主机端口，写了的话就注意看映射到了哪个端口灵活处理。</li><li>首先起服务器，然后直接在Eclipse中运行客户端就行。这里我之前想得太复杂，还想做一个客户端的镜像，然后就陷入怎么通信的问题（修改固定IP和自定义桥接网络……），唉，虽然走了很多弯路，但还是学到了知识鸭！——不要在ddl当天放飞自我地发散👻。<br> <img src="https://images2.imgbox.com/15/93/W3jQFcC4_o.png" alt="跑一哈！" width="600"></li><li>既然我们做了端口映射，就要把客户端代码里连接的时候端口改成<code>4000</code>，运行情况和前面打成jar包里贴的一样。</li><li>为了测试数据是否成功发送，还需要查看容器内部文件的接收情况。运行命令<code>docker ps -a</code>查看所有的容器运行情况，找到<code>serve_demov1</code>的<code>容器ID</code>，再<code>docker exec -it 容器ID /bin/sh</code>进入容器内部。这个问题上大部分人会说使用“<code>exec……/bin/bash</code>”,或者attach，但是我这就无效，初步了解是由于镜像是基于alpine构建的，所以没有这个bash文件夹，而是sh？好的，如果你用这一条找不到就换<code>docker exec -it 容器ID /bin/bash</code>🤥<br> <img src="https://images2.imgbox.com/e2/af/Zy0fdHML_o.png" alt="在这里插入图片描述" width="600"><br> 到这里就做完了，下次还是要做容器间的通信！</li></ul> 
<h3><a id="_244"></a>附录</h3> 
<ul><li>过程中频繁使用到的基本docker命令有：</li></ul> 
<ol><li><code>docker images</code>查看所有的镜像</li><li><code>docker ps</code>默认情况下，该命令仅显示正在运行的容器</li><li><code>docker ps -a</code>查看所有的容器运行情况</li><li><code>docker build -t 镜像名称 -f 创建用的Dockerfile .</code>用于从该Dockerfile构建镜像</li><li><code>docker run -p 主机端口：容器端口 镜像名称</code>通过端口映射，在运行镜像的同时创建同名容器并运行</li><li><code>docker stop 容器ID</code>停止正在运行的容器，先停止才能删除</li><li><code>docker start 容器ID</code>重新启动已经停止运行的容器</li><li><code>docker rm container 容器ID</code>删除容器</li><li><code>docker rmi 镜像ID</code>删除镜像，在删除镜像前要先删除有以来的镜像，举例：先删server_demo1再删jdk</li></ol> 
<ul><li>学习参考</li></ul> 
<ol><li><a href="https://docs.docker.com/engine/reference/run/" rel="nofollow">Docker官方文档</a></li><li><a href="http://www.dockerinfo.net/dockerfile%E4%BB%8B%E7%BB%8D" rel="nofollow">Dockerfile学习</a></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8d8e1c348e480e188e4bb5b30fd310c6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">tf.estimator.Estimator的使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/da524825dd40486eff01726cb123bfd1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Git管理项目,git的基本操作语法加注释</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>