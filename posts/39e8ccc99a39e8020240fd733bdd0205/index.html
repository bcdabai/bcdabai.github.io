<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用RGBD相机实现YOLOv3目标识别并测距，获取物体三维坐标 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用RGBD相机实现YOLOv3目标识别并测距，获取物体三维坐标" />
<meta property="og:description" content="设备环境：Ubuntu18.04 &#43; ros melodic
相机：乐视相机（乐视遗产，和奥比中光的Astra Pro同方案，便宜）
1. 首先要安装一部分依赖
sudo apt install ros-$ROS_DISTRO-rgbd-launch ros-$ROS_DISTRO-libuvc ros-$ROS_DISTRO-libuvc-camera ros-$ROS_DISTRO-libuvc-ros
2. 我建议建立一个空的工作空间，供调试(当然，也可以放入自己原有的ros工作空间)
mkdir -p ~/astra_ws/src
3. 从github下载astra的包并安装（也可以ros命令安装，这里采用github下载再编译）
cd ~/astra_ws/src
git clone https://github.com/orbbec/ros_astra_camera
roscd astro_camera
sudo sh ./scripts/create_udev_rules
随后进行编译
cd ..
catkin_make --pkg astra_camera
4. 插上相机的USB线，再
lsusb
得到输出
Bus 001 Device 019: ID 2bc5:0502 # RGB模块
Bus 001 Device 018: ID 2bc5:0403 # 深度模块
根据本机信息修改launch文件
找到ros_astra_camera/launch文件夹下的astropro.launch进行修改
将默认的0x0501改为刚才lsusb得到的0x0502
修改launch无需重新编译，但需要source一下
5. 查看相机原始数据
source devel/setup.bash
roslaunch astra_camera astrapro.launch" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/39e8ccc99a39e8020240fd733bdd0205/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-21T16:10:02+08:00" />
<meta property="article:modified_time" content="2022-05-21T16:10:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用RGBD相机实现YOLOv3目标识别并测距，获取物体三维坐标</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">设备环境：</span><span style="color:#000000;">Ubuntu18.04 + ros melodic</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">相机：乐视相机（乐视遗产，和奥比中光的</span><span style="color:#000000;">Astra Pro</span><span style="color:#000000;">同方案，便宜）</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#0451a5;">1.</span> <span style="color:#000000;">首先要安装一部分依赖</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo apt install ros-$ROS_DISTRO-rgbd-launch ros-$ROS_DISTRO-libuvc ros-$ROS_DISTRO-libuvc-camera ros-$ROS_DISTRO-libuvc-ros</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#0451a5;">2.</span> <span style="color:#000000;">我建议建立一个空的工作空间，供调试</span><span style="color:#000000;">(</span><span style="color:#000000;">当然，也可以放入自己原有的</span><span style="color:#000000;">ros</span><span style="color:#000000;">工作空间</span><span style="color:#000000;">)</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">mkdir -p ~/astra_ws/src</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#0451a5;">3.</span> <span style="color:#000000;">从</span><span style="color:#000000;">github</span><span style="color:#000000;">下载</span><span style="color:#000000;">astra</span><span style="color:#000000;">的包并安装（也可以</span><span style="color:#000000;">ros</span><span style="color:#000000;">命令安装，这里采用</span><span style="color:#000000;">github</span><span style="color:#000000;">下载再编译）</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">cd ~/astra_ws/src</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">git clone https://github.com/orbbec/ros_astra_camera</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">roscd astro_camera</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo sh ./scripts/create_udev_rules</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">随后进行编译</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">cd ..</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">catkin_make --pkg astra_camera</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#0451a5;">4.</span> <span style="color:#000000;">插上相机的</span><span style="color:#000000;">USB</span><span style="color:#000000;">线，再</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">lsusb</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">得到输出</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">Bus 001 Device 019: ID 2bc5:0502 # RGB</span><span style="color:#000000;">模块</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">Bus 001 Device 018: ID 2bc5:0403 # </span><span style="color:#000000;">深度模块</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">根据本机信息修改</span><span style="color:#000000;">launch</span><span style="color:#000000;">文件</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">找到</span><span style="color:#000000;">ros_astra_camera/launch</span><span style="color:#000000;">文件夹下的</span><span style="color:#000000;">astropro.launch</span><span style="color:#000000;">进行修改</span></span></p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="382" src="https://images2.imgbox.com/0c/3c/8jjmPuAo_o.png" width="266"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">将默认的</span><span style="color:#000000;">0x0501</span><span style="color:#000000;">改为刚才</span><span style="color:#000000;">lsusb</span><span style="color:#000000;">得到的</span><span style="color:#000000;">0x0502</span></span><br><img alt="" height="216" src="https://images2.imgbox.com/54/ed/fuPppndQ_o.png" width="791"><br><span style="background-color:#ffffff;"><span style="color:#000000;">修改</span><span style="color:#000000;">launch</span><span style="color:#000000;">无需重新编译，但需要</span><span style="color:#000000;">source</span><span style="color:#000000;">一下</span></span></p> 
<p style="margin-left:0;text-align:left;"><br><span style="background-color:#ffffff;"><span style="color:#0451a5;">5.</span> <span style="color:#000000;">查看相机原始数据</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">source devel/setup.bash</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">roslaunch astra_camera astrapro.launch</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">终端会弹出大量调试信息，主要注意有无红色，黄色的警告也可以自己看一下要不要修改</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">然后另开一个新的终端</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">rosrun rviz rviz</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">通过</span><span style="color:#000000;"> add by topic</span><span style="color:#000000;">添加</span><span style="color:#000000;">image</span><span style="color:#000000;">数据即可，需要深度图还是</span><span style="color:#000000;">RGB</span><span style="color:#000000;">均可自行选择</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#0451a5;">6.</span> <span style="color:#000000;">查看点云数据</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">(</span><span style="color:#000000;">忘记截图了，也不是刚需，埋个坑待更新</span><span style="color:#000000;">)</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#0451a5;">7.</span> <span style="color:#000000;">下载</span><span style="color:#000000;">darknet-ros</span><span style="color:#000000;">并编译</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">cd ~/astra_ws/src</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">git clone https://github.com/leggedrobotics/darknet_ros</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">cd ..</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">catkin_make -DCMAKE_BUILD_TYPE=Release</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">这部分需要等待较长时间，系统会自动检查并下载</span><span style="color:#000000;">yolo</span><span style="color:#000000;">的权重文件，看着很像假死，建议耐心等待</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#0451a5;">8.</span> <span style="color:#000000;">修改</span><span style="color:#000000;">darket_ros</span><span style="color:#000000;">中订阅的图像话题</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">首先查看当前的图像数据发布话题</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">rostopic list</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">然后记住，再在</span><span style="color:#000000;">darket_ros/config/ros.yaml</span><span style="color:#000000;">中进行修改</span></span></p> 
<p style="margin-left:0;text-align:left;"><br><img alt="" height="182" src="https://images2.imgbox.com/6f/c6/RTVXBuIF_o.png" width="315"><br><img alt="" height="170" src="https://images2.imgbox.com/78/6f/5Y3otTEF_o.png" width="469"><br><br><span style="background-color:#ffffff;"><span style="color:#0451a5;">9.</span> <span style="color:#000000;">运行</span><span style="color:#000000;">astro</span><span style="color:#000000;">和</span><span style="color:#000000;">darknet</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">source devel/setup.bash</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">roslaunch astra_camera astrapro.launch</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">另开一个终端</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">source devel/setup.bash</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">roslaunch darknet_ros darknet_ros.launch</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">正常的话会弹出一个对话框，名称为</span><span style="color:#000000;">YOLO</span><span style="color:#000000;">，大概效果如图</span></span></p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="916" src="https://images2.imgbox.com/c8/66/J27Na6Yv_o.jpg" width="1189"></p> 
<p style="margin-left:0;text-align:left;"><br><span style="background-color:#ffffff;"><span style="color:#000000;">需要修改权重为自己的数据集的话，可以修改如下文件</span></span></p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="588" src="https://images2.imgbox.com/63/c6/GlHbzrbk_o.png" width="1200"><br><br><span style="background-color:#ffffff;"><span style="color:#0451a5;">10.</span> <span style="color:#000000;">修改</span><span style="color:#000000;">YoloObjectDetector.cpp</span><span style="color:#000000;">和</span><span style="color:#000000;">image.c</span><span style="color:#000000;">，增加对应的测距和三维坐标计算</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="304" src="https://images2.imgbox.com/84/3b/3d1RVMir_o.png" width="247"></p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="33" src="https://images2.imgbox.com/6e/77/AmK8wAt4_o.png" width="354"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">（这部分当时改代码改的太乱了，就不贴代码了，大概思路是，首先将</span><span style="color:#000000;">RGB</span><span style="color:#000000;">图和深度图进行配准，然后在修改</span><span style="color:#000000;">YoloObjectDetector</span><span style="color:#000000;">中，在回调函数用</span><span style="color:#000000;">bridge</span><span style="color:#000000;">搞一个深度图的副本，然后在</span><span style="color:#000000;">YOLOv3</span><span style="color:#000000;">检测完，对满足阈值条件的目标进行测距）</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">测距部分我使用了</span><span style="color:#000000;">5</span><span style="color:#000000;">个点取均值，不然容易出现</span><span style="color:#000000;">nan</span><span style="color:#000000;">的情况，也不好适应不规则物体（具体取哪</span><span style="color:#000000;">5</span><span style="color:#000000;">个点应该需要返校后更详细的测试）</span></span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="265" src="https://images2.imgbox.com/77/5c/OQVyD4nK_o.png" width="757"><img alt="" height="436" src="https://images2.imgbox.com/4b/0f/KqMIuex7_o.png" width="529"></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">放一个大概的效果动图（测距暂时显示在终端了，加在图上应该会更直观一点）</span></span></p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="360" src="https://images2.imgbox.com/8f/35/5CPFHY3c_o.gif" width="640"></p> 
<p>测试当时是在笔记本的GTX1050测的，帧率低的可怜，返校之后放到xavier nx试了一下，无tensorRT加速的情况下又20帧左右，但由于项目移交学弟处理了，所以后续没有再更新这篇文章了</p> 
<p></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">参考过的博客链接：</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">https://blog.csdn.net/Arcann/article/details/109495134</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">https://blog.csdn.net/qq_42145185/article/details/105730256</span></span></p> 
<p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#000000;">https://blog.csdn.net/qq_40700822/article/details/118523941</span></span></p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/be854245f76db130e7426a1379078607/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2022最新iApp源码(破解ZIP密码)&#43;已编译的成品</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bc67a01ce5707ea459d03f38ea4ccfdd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">中国地图和世界地图</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>