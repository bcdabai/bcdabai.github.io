<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>大数据框架之Hive：第8章 函数 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="大数据框架之Hive：第8章 函数" />
<meta property="og:description" content="第8章 函数 8.1 函数简介 Hive会将常用的逻辑封装成函数给用户进行使用，类似于Java中的函数。
好处：避免用户反复写逻辑，可以直接拿来使用。
重点：用户需要知道函数叫什么，能做什么。
Hive提供了大量的内置函数，按照其特点可大致分为如下几类：单行函数、聚合函数、炸裂函数、窗口函数。
以下命令可用于查询所有内置函数的相关信息。
1）查看系统内置函数
hive&gt; show functions; 2）查看内置函数用法
hive&gt; desc function upper; 3）查看内置函数详细信息
hive&gt; desc function extended upper; 8.2 单行函数 单行函数的特点是一进一出，即输入一行，输出一行。
单行函数按照功能可分为如下几类: 日期函数、字符串函数、集合函数、数学函数、流程控制函数等。
8.2.1 算术运算函数 运算符描述A&#43;BA和B 相加A-BA减去BA*BA和B 相乘A/BA除以BA%BA对B取余A&amp;BA和B按位取与ABA^BA和B按位取异或~AA按位取反 案例实操：查询出所有员工的薪水后加1显示。
hive (default)&gt; select sal &#43; 1 from emp; 8.2.2 数值函数 1）round：四舍五入
hive&gt; select round(3.3); 3 2）ceil：向上取整
hive&gt; select ceil(3.1) ; 4 3）floor：向下取整
hive&gt; select floor(4.8); 4 8.2.3 字符串函数 1）substring：截取字符串
语法一：substring(string A, int start)
返回值：string" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5a3b3cc70f1fe4942e2b00859b841514/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-12T17:06:17+08:00" />
<meta property="article:modified_time" content="2023-03-12T17:06:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">大数据框架之Hive：第8章 函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="8__0"></a>第8章 函数</h2> 
<h3><a id="81__2"></a>8.1 函数简介</h3> 
<p>Hive会将常用的逻辑封装成<strong>函数</strong>给用户进行使用，类似于Java中的函数。</p> 
<p><strong>好处</strong>：避免用户反复写逻辑，可以直接拿来使用。</p> 
<p><strong>重点</strong>：用户需要知道函数叫什么，能做什么。</p> 
<p>Hive提供了大量的内置函数，按照其特点可大致分为如下几类：单行函数、聚合函数、炸裂函数、窗口函数。</p> 
<p>以下命令可用于查询所有内置函数的相关信息。</p> 
<p><strong>1）查看系统内置函数</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> show functions<span class="token punctuation">;</span>
</code></pre> 
<p><strong>2）查看内置函数用法</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> desc <span class="token keyword">function</span> upper<span class="token punctuation">;</span>
</code></pre> 
<p><strong>3）查看内置函数详细信息</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> desc <span class="token keyword">function</span> extended upper<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="82%C2%A0_32"></a>8.2 单行函数</h3> 
<p><strong>单行函数的特点是一进一出，即输入一行，输出一行。</strong></p> 
<p><strong>单行函数按照功能可分为如下几类: 日期函数、字符串函数、集合函数、数学函数、流程控制函数等。</strong></p> 
<h4><a id="821__38"></a>8.2.1 算术运算函数</h4> 
<table><thead><tr><th>运算符</th><th>描述</th></tr></thead><tbody><tr><td>A+B</td><td>A和B 相加</td></tr><tr><td>A-B</td><td>A减去B</td></tr><tr><td>A*B</td><td>A和B 相乘</td></tr><tr><td>A/B</td><td>A除以B</td></tr><tr><td>A%B</td><td>A对B取余</td></tr><tr><td>A&amp;B</td><td>A和B按位取与</td></tr><tr><td>A</td><td>B</td></tr><tr><td>A^B</td><td>A和B按位取异或</td></tr><tr><td>~A</td><td>A按位取反</td></tr></tbody></table> 
<p>案例实操：查询出所有员工的薪水后加1显示。</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> sal + <span class="token number">1</span> from emp<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="822%C2%A0_58"></a>8.2.2 数值函数</h4> 
<p><strong>1）round：四舍五入</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> round<span class="token punctuation">(</span><span class="token number">3.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token number">3</span>
</code></pre> 
<p><strong>2）ceil：向上取整</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> ceil<span class="token punctuation">(</span><span class="token number">3.1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>   
<span class="token number">4</span>
</code></pre> 
<p><strong>3）floor：向下取整</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> floor<span class="token punctuation">(</span><span class="token number">4.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">4</span>
</code></pre> 
<h4><a id="823%C2%A0_81"></a>8.2.3 字符串函数</h4> 
<p><strong>1）substring：截取字符串</strong></p> 
<p>语法一：<code>substring(string A, int start)</code></p> 
<p>返回值：string</p> 
<p>说明：返回字符串A从start位置到结尾的字符串</p> 
<p>语法二：<code>substring(string A, int start, int len)</code></p> 
<p>返回值：string</p> 
<p>说明：返回字符串A从start位置开始，长度为len的字符串</p> 
<p>案例实操：</p> 
<p>（1）获取第二个字符以后的所有字符</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> substring<span class="token punctuation">(</span><span class="token string">"atguigu"</span>,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">tguigu
</code></pre> 
<p>（2）获取倒数第三个字符以后的所有字符</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> substring<span class="token punctuation">(</span><span class="token string">"atguigu"</span>,-3<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">igu
</code></pre> 
<p>（3）从第3个字符开始，向后获取2个字符</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> substring<span class="token punctuation">(</span><span class="token string">"atguigu"</span>,3,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">gu
</code></pre> 
<p><strong>2）replace ：替换</strong></p> 
<p>语法：<code>replace(string A, string B, string C)</code></p> 
<p>返回值：string</p> 
<p>说明：将字符串A中的子字符串B替换为C。</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> replace<span class="token punctuation">(</span><span class="token string">'atguigu'</span>, <span class="token string">'a'</span>, <span class="token string">'A'</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> Atguigu
</code></pre> 
<p><strong>3）regexp_replace：正则替换</strong></p> 
<p>语法：<code>regexp_replace(string A, string B, string C)</code></p> 
<p>返回值：string</p> 
<p>说明：将字符串A中的符合java正则表达式B的部分替换为C。注意，在有些情况下要使用转义字符。</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> regexp_replace<span class="token punctuation">(</span><span class="token string">'100-200'</span>, <span class="token string">'(\\d+)'</span>, <span class="token string">'num'</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> num-num
</code></pre> 
<p><strong>4）regexp：正则匹配</strong></p> 
<p>语法：<code>字符串 regexp 正则表达式</code></p> 
<p>返回值：boolean</p> 
<p>说明：若字符串符合正则表达式，则返回true，否则返回false。</p> 
<p>（1）正则匹配成功，输出true</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token string">'dfsaaaa'</span> regexp <span class="token string">'dfsa+'</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token boolean">true</span>
</code></pre> 
<p>（2）正则匹配失败，输出false</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token string">'dfsaaaa'</span> regexp <span class="token string">'dfsb+'</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token boolean">false</span>
</code></pre> 
<p><strong>5）repeat：重复字符串</strong></p> 
<p>语法：<code>repeat(string A, int n)</code></p> 
<p>返回值：string</p> 
<p>说明：将字符串A重复n遍。</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> repeat<span class="token punctuation">(</span><span class="token string">'123'</span>, <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token number">123123123</span>
</code></pre> 
<p><strong>6）split ：字符串切割</strong></p> 
<p>语法：<code>split(string str, string pat)</code></p> 
<p>返回值：array</p> 
<p>说明：按照正则表达式pat匹配到的内容分割str，分割后的字符串，以数组的形式返回。</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> split<span class="token punctuation">(</span><span class="token string">'a-b-c-d'</span>,<span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">"a"</span>,<span class="token string">"b"</span>,<span class="token string">"c"</span>,<span class="token string">"d"</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>7）nvl ：替换null值</strong></p> 
<p>语法：<code>nvl(A,B)</code></p> 
<p>说明：若A的值不为null，则返回A，否则返回B。****</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> nvl<span class="token punctuation">(</span>null,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token number">1</span>
</code></pre> 
<p><strong>8）concat ：拼接字符串</strong></p> 
<p>语法：<code>concat(string A, string B, string C, ……)</code></p> 
<p>返回：string</p> 
<p>说明：将A,B,C……等字符拼接为一个字符串</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">'beijing'</span>,<span class="token string">'-'</span>,<span class="token string">'shanghai'</span>,<span class="token string">'-'</span>,<span class="token string">'shenzhen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> beijing-shanghai-shenzhen
</code></pre> 
<p><strong>9）concat_ws：以指定分隔符拼接字符串或者字符串数组</strong></p> 
<p>语法：<code>concat_ws(string A, string…| array(string))</code></p> 
<p>返回值：string</p> 
<p>说明：使用分隔符A拼接多个字符串，或者一个数组的所有元素。</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span>select concat_ws<span class="token punctuation">(</span><span class="token string">'-'</span>,<span class="token string">'beijing'</span>,<span class="token string">'shanghai'</span>,<span class="token string">'shenzhen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> beijing-shanghai-shenzhen
hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">'-'</span>,array<span class="token punctuation">(</span><span class="token string">'beijing'</span>,<span class="token string">'shenzhen'</span>,<span class="token string">'shanghai'</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> beijing-shanghai-shenzhen
</code></pre> 
<p><strong>10）get_json_object：解析json字符串</strong></p> 
<p>语法：<code>get_json_object(string json_string, string path)</code></p> 
<p>返回值：string</p> 
<p>说明：解析json的字符串json_string，返回path指定的内容。如果输入的json字符串无效，那么返回NULL。</p> 
<p>案例实操：</p> 
<p><strong>（1）获取json数组里面的json具体数据</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> get_json_object<span class="token punctuation">(</span><span class="token string">'[{"name":"大海海","sex":"男","age":"25"},{"name":"小宋宋","sex":"男","age":"47"}]'</span>,<span class="token string">'$.[0].name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> 大海海
</code></pre> 
<p><strong>（2）获取json数组里面的数据</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> get_json_object<span class="token punctuation">(</span><span class="token string">'[{"name":"大海海","sex":"男","age":"25"},{"name":"小宋宋","sex":"男","age":"47"}]'</span>,<span class="token string">'$.[0]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"大海海"</span>,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"age"</span><span class="token builtin class-name">:</span><span class="token string">"25"</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="824%C2%A0_334"></a>8.2.4 日期函数</h4> 
<p><strong>1）unix_timestamp：返回当前或指定时间的时间戳</strong></p> 
<p>语法：<code>unix_timestamp()</code></p> 
<p>返回值：bigint</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> unix_timestamp<span class="token punctuation">(</span><span class="token string">'2022/08/08 08-08-08'</span>,<span class="token string">'yyyy/MM/dd HH-mm-ss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">1659946088</span>
</code></pre> 
<p>说明：-前面是日期后面是指，日期传进来的具体格式</p> 
<p><strong>2）from_unixtime：转化UNIX时间戳（从 1970-01-01 00:00:00 UTC 到指定时间的秒数）到当前时区的时间格式</strong></p> 
<p>语法：<code>from_unixtime(bigint unixtime[, string format])</code></p> 
<p>返回值：string</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1659946088</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>-08-08 08:08:08
</code></pre> 
<p><strong>3）current_date：当前日期</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> current_date<span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>-07-11
</code></pre> 
<p><strong>4）current_timestamp：当前的日期加时间，<strong>并且精确的毫秒</strong></strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> current_timestamp<span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>-07-11 <span class="token number">15</span>:32:22.402
</code></pre> 
<p><strong>5）month：获取日期中的月</strong></p> 
<p>语法：<code>month (string date)</code></p> 
<p>返回值：int</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> month<span class="token punctuation">(</span><span class="token string">'2022-08-08 08:08:08'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">8</span>
</code></pre> 
<p><strong>6）day：获取日期中的日</strong></p> 
<p>语法：<code>day (string date)</code></p> 
<p>返回值：int</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> day<span class="token punctuation">(</span><span class="token string">'2022-08-08 08:08:08'</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">8</span>
</code></pre> 
<p><strong>7）hour：获取日期中的小时</strong></p> 
<p>语法：<code>hour (string date)</code></p> 
<p>返回值：int</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> hour<span class="token punctuation">(</span><span class="token string">'2022-08-08 08:08:08'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">8</span>
</code></pre> 
<p><strong>8）datediff：两个日期相差的天数（结束日期减去开始日期的天数）</strong></p> 
<p>语法：<code>datediff(string enddate, string startdate)</code></p> 
<p>返回值：int</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> datediff<span class="token punctuation">(</span><span class="token string">'2021-08-08'</span>,<span class="token string">'2022-10-09'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">-427
</code></pre> 
<p><strong>9）date_add：日期加天数</strong></p> 
<p>语法：<code>date_add(string startdate, int days)</code></p> 
<p>返回值：string</p> 
<p>说明：返回开始日期 startdate 增加 days 天后的日期</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> date_add<span class="token punctuation">(</span><span class="token string">'2022-08-08'</span>,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>-08-10
</code></pre> 
<p><strong>10）date_sub：日期减天数</strong></p> 
<p>语法：<code>date_sub (string startdate, int days)</code></p> 
<p>返回值：string</p> 
<p>说明：返回开始日期startdate减少days天后的日期。</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> date_sub<span class="token punctuation">(</span><span class="token string">'2022-08-08'</span>,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>-08-06
</code></pre> 
<p><strong>11）date_format:将标准日期解析成指定格式字符串</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token string">'2022-08-08'</span>,<span class="token string">'yyyy年-MM月-dd日'</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>年-08月-08日
</code></pre> 
<h4><a id="825__522"></a>8.2.5 流程控制函数</h4> 
<p><strong>1）case when：条件判断函数</strong></p> 
<p>语法一：<code>case when a then b [when c then d]* [else e] end</code></p> 
<p>返回值：T</p> 
<p>说明：如果a为true，则返回b；如果c为true，则返回d；否则返回 e</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token keyword">case</span> when <span class="token assign-left variable">1</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'tom'</span> when <span class="token assign-left variable">2</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'mary'</span> <span class="token keyword">else</span> <span class="token string">'tim'</span> end from tabl eName<span class="token punctuation">;</span>
</code></pre> 
<p>mary</p> 
<p>语法二： <code>case a when b then c [when d then e]* [else f] end</code></p> 
<p>返回值: T</p> 
<p>说明：如果a等于b，那么返回c；如果a等于d，那么返回e；否则返回f</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token keyword">case</span> <span class="token number">100</span> when <span class="token number">50</span> <span class="token keyword">then</span> <span class="token string">'tom'</span> when <span class="token number">100</span> <span class="token keyword">then</span> <span class="token string">'mary'</span> <span class="token keyword">else</span> <span class="token string">'tim'</span> end from t ableName<span class="token punctuation">;</span>
</code></pre> 
<p>mary</p> 
<p><strong>2）if: 条件判断，类似于Java中三元运算符</strong></p> 
<p>语法：<code>if（boolean testCondition, T valueTrue, T valueFalseOrNull）</code></p> 
<p>返回值：T</p> 
<p>说明：当条件testCondition为true时，返回valueTrue；否则返回valueFalseOrNull</p> 
<p>（1）条件满足，输出正确</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> if<span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">&gt;</span> <span class="token number">5</span>,<span class="token string">'正确'</span>,<span class="token string">'错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：正确</p> 
<p>（2）条件满足，输出错误</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> if<span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">&lt;</span> <span class="token number">5</span>,<span class="token string">'正确'</span>,<span class="token string">'错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：错误</p> 
<h4><a id="826%C2%A0_574"></a>8.2.6 集合函数</h4> 
<p><strong>1）size：集合中元素的个数</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> size<span class="token punctuation">(</span>friends<span class="token punctuation">)</span> from <span class="token builtin class-name">test</span><span class="token punctuation">;</span>  --2/2  每一行数据中的friends集合里的个数
</code></pre> 
<p><strong>2）map：创建map集合</strong></p> 
<p>语法：map (key1, value1, key2, value2, …)</p> 
<p>说明：根据输入的key和value对构建map类型</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> map<span class="token punctuation">(</span><span class="token string">'xiaohai'</span>,1,<span class="token string">'dahai'</span>,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token string">"xiaohai"</span>:1,<span class="token string">"dahai"</span>:2<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3）map_keys： 返回map中的key</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> map_keys<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token string">'xiaohai'</span>,1,<span class="token string">'dahai'</span>,2<span class="token punctuation">))</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">"xiaohai"</span>,<span class="token string">"dahai"</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>4）map_values: 返回map中的value</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> map_values<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token string">'xiaohai'</span>,1,<span class="token string">'dahai'</span>,2<span class="token punctuation">))</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">1,2</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>5）array 声明array集合</strong></p> 
<p>语法：array(val1, val2, …)</p> 
<p>说明：根据输入的参数构建数组array类</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> array<span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2'</span>,<span class="token string">'3'</span>,<span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">"1"</span>,<span class="token string">"2"</span>,<span class="token string">"3"</span>,<span class="token string">"4"</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>6）array_contains: 判断array中是否包含某个元素</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> array_contains<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token string">'a'</span>,<span class="token string">'b'</span>,<span class="token string">'c'</span>,<span class="token string">'d'</span><span class="token punctuation">)</span>,<span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token boolean">true</span>
</code></pre> 
<p><strong>7）sort_array：将array中的元素排序</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> sort_array<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token string">'a'</span>,<span class="token string">'d'</span>,<span class="token string">'c'</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">"a"</span>,<span class="token string">"c"</span>,<span class="token string">"d"</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>8）struct声明struct中的各属性</strong></p> 
<p>语法：struct(val1, val2, val3, …)</p> 
<p>说明：根据输入的参数构建结构体struct类</p> 
<p>案例实操：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> struct<span class="token punctuation">(</span><span class="token string">'name'</span>,<span class="token string">'age'</span>,<span class="token string">'weight'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token string">"col1"</span><span class="token builtin class-name">:</span><span class="token string">"name"</span>,<span class="token string">"col2"</span><span class="token builtin class-name">:</span><span class="token string">"age"</span>,<span class="token string">"col3"</span><span class="token builtin class-name">:</span><span class="token string">"weight"</span><span class="token punctuation">}</span>
</code></pre> 
<p><strong>9）named_struct声明struct的属性和值</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> named_struct<span class="token punctuation">(</span><span class="token string">'name'</span>,<span class="token string">'xiaosong'</span>,<span class="token string">'age'</span>,18,<span class="token string">'weight'</span>,80<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"xiaosong"</span>,<span class="token string">"age"</span>:18,<span class="token string">"weight"</span>:80<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="827%C2%A0_696"></a>8.2.7 案例演示</h4> 
<p><strong>1. 数据准备</strong></p> 
<p><strong>1）表结构</strong></p> 
<table><thead><tr><th>name</th><th>sex</th><th>birthday</th><th>hiredate</th><th>job</th><th>salary</th><th>bonus</th><th>friends</th><th>children</th></tr></thead><tbody><tr><td>张无忌</td><td>男</td><td>1980/02/12</td><td>2022/08/09</td><td>销售</td><td>3000</td><td>12000</td><td>[阿朱，小昭]</td><td>{张小无:8,张小忌:9}</td></tr><tr><td>赵敏</td><td>女</td><td>1982/05/18</td><td>2022/09/10</td><td>行政</td><td>9000</td><td>2000</td><td>[阿三，阿四]</td><td>{赵小敏:8}</td></tr><tr><td>黄蓉</td><td>女</td><td>1982/04/13</td><td>2022/06/11</td><td>行政</td><td>12000</td><td>Null</td><td>[东邪，西毒]</td><td>{郭芙:5,郭襄:4}</td></tr></tbody></table> 
<p><strong>2）建表语句</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> 
create  table  employee<span class="token punctuation">(</span>
    name string,  --姓名
    sex  string,  --性别
    birthday string, --出生年月
    hiredate string, --入职日期
    job string,   --岗位
    salary double, --薪资
    bonus double,  --奖金
    friends array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>, --朋友
    children map<span class="token operator">&lt;</span>string,int<span class="token operator">&gt;</span> --孩子
<span class="token punctuation">)</span>
</code></pre> 
<p><strong>3）插入数据</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> insert into employee  
  values<span class="token punctuation">(</span><span class="token string">'张无忌'</span>,<span class="token string">'男'</span>,<span class="token string">'1980/02/12'</span>,<span class="token string">'2022/08/09'</span>,<span class="token string">'销售'</span>,3000,12000,array<span class="token punctuation">(</span><span class="token string">'阿朱'</span>,<span class="token string">'小昭'</span><span class="token punctuation">)</span>,map<span class="token punctuation">(</span><span class="token string">'张小无'</span>,8,<span class="token string">'张小忌'</span>,9<span class="token punctuation">))</span>,
        <span class="token punctuation">(</span><span class="token string">'赵敏'</span>,<span class="token string">'女'</span>,<span class="token string">'1982/05/18'</span>,<span class="token string">'2022/09/10'</span>,<span class="token string">'行政'</span>,9000,2000,array<span class="token punctuation">(</span><span class="token string">'阿三'</span>,<span class="token string">'阿四'</span><span class="token punctuation">)</span>,map<span class="token punctuation">(</span><span class="token string">'赵小敏'</span>,8<span class="token punctuation">))</span>,
        <span class="token punctuation">(</span><span class="token string">'宋青书'</span>,<span class="token string">'男'</span>,<span class="token string">'1981/03/15'</span>,<span class="token string">'2022/04/09'</span>,<span class="token string">'研发'</span>,18000,1000,array<span class="token punctuation">(</span><span class="token string">'王五'</span>,<span class="token string">'赵六'</span><span class="token punctuation">)</span>,map<span class="token punctuation">(</span><span class="token string">'宋小青'</span>,7,<span class="token string">'宋小书'</span>,5<span class="token punctuation">))</span>,
        <span class="token punctuation">(</span><span class="token string">'周芷若'</span>,<span class="token string">'女'</span>,<span class="token string">'1981/03/17'</span>,<span class="token string">'2022/04/10'</span>,<span class="token string">'研发'</span>,18000,1000,array<span class="token punctuation">(</span><span class="token string">'王五'</span>,<span class="token string">'赵六'</span><span class="token punctuation">)</span>,map<span class="token punctuation">(</span><span class="token string">'宋小青'</span>,7,<span class="token string">'宋小书'</span>,5<span class="token punctuation">))</span>,
        <span class="token punctuation">(</span><span class="token string">'郭靖'</span>,<span class="token string">'男'</span>,<span class="token string">'1985/03/11'</span>,<span class="token string">'2022/07/19'</span>,<span class="token string">'销售'</span>,2000,13000,array<span class="token punctuation">(</span><span class="token string">'南帝'</span>,<span class="token string">'北丐'</span><span class="token punctuation">)</span>,map<span class="token punctuation">(</span><span class="token string">'郭芙'</span>,5,<span class="token string">'郭襄'</span>,4<span class="token punctuation">))</span>,
        <span class="token punctuation">(</span><span class="token string">'黄蓉'</span>,<span class="token string">'女'</span>,<span class="token string">'1982/12/13'</span>,<span class="token string">'2022/06/11'</span>,<span class="token string">'行政'</span>,12000,null,array<span class="token punctuation">(</span><span class="token string">'东邪'</span>,<span class="token string">'西毒'</span><span class="token punctuation">)</span>,map<span class="token punctuation">(</span><span class="token string">'郭芙'</span>,5,<span class="token string">'郭襄'</span>,4<span class="token punctuation">))</span>,
        <span class="token punctuation">(</span><span class="token string">'杨过'</span>,<span class="token string">'男'</span>,<span class="token string">'1988/01/30'</span>,<span class="token string">'2022/08/13'</span>,<span class="token string">'前台'</span>,5000,null,array<span class="token punctuation">(</span><span class="token string">'郭靖'</span>,<span class="token string">'黄蓉'</span><span class="token punctuation">)</span>,map<span class="token punctuation">(</span><span class="token string">'杨小过'</span>,2<span class="token punctuation">))</span>,
        <span class="token punctuation">(</span><span class="token string">'小龙女'</span>,<span class="token string">'女'</span>,<span class="token string">'1985/02/12'</span>,<span class="token string">'2022/09/24'</span>,<span class="token string">'前台'</span>,6000,null,array<span class="token punctuation">(</span><span class="token string">'张三'</span>,<span class="token string">'李四'</span><span class="token punctuation">)</span>,map<span class="token punctuation">(</span><span class="token string">'杨小过'</span>,2<span class="token punctuation">))</span>
</code></pre> 
<p><strong>2. 需求</strong></p> 
<p><strong>1）统计每个月的入职人数</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>month</th><th>cnt</th></tr></thead><tbody><tr><td>4</td><td>2</td></tr><tr><td>6</td><td>1</td></tr><tr><td>7</td><td>1</td></tr><tr><td>8</td><td>2</td></tr><tr><td>9</td><td>2</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
  month<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>hiredate,<span class="token string">'/'</span>,<span class="token string">'-'</span><span class="token punctuation">))</span> as month,
  count<span class="token punctuation">(</span>*<span class="token punctuation">)</span> as cnt
from
  employee
group by
  month<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>hiredate,<span class="token string">'/'</span>,<span class="token string">'-'</span><span class="token punctuation">))</span>
</code></pre> </li></ul> 
<p><strong>2）查询每个人的年龄（年 + 月）</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>name</th><th>age</th></tr></thead><tbody><tr><td>张无忌</td><td>42年8月</td></tr><tr><td>赵敏</td><td>40年5月</td></tr><tr><td>宋青书</td><td>41年7月</td></tr><tr><td>周芷若</td><td>41年7月</td></tr><tr><td>郭靖</td><td>37年7月</td></tr><tr><td>黄蓉</td><td>39年10月</td></tr><tr><td>杨过</td><td>34年9月</td></tr><tr><td>小龙女</td><td>37年8月</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash">-- 转换日期
<span class="token keyword">select</span>
  name,
  replace<span class="token punctuation">(</span>birthday,<span class="token string">'/'</span>,<span class="token string">'-'</span><span class="token punctuation">)</span> birthday
from
  employee  t1

-- 求出年和月
<span class="token keyword">select</span>
  name,
  year<span class="token punctuation">(</span>current_date<span class="token punctuation">(</span><span class="token punctuation">))</span>-year<span class="token punctuation">(</span>t1.birthday<span class="token punctuation">)</span> year,
  month<span class="token punctuation">(</span>current_date<span class="token punctuation">(</span><span class="token punctuation">))</span>-month<span class="token punctuation">(</span>t1.birthday<span class="token punctuation">)</span> month
from
  <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
      name,
      replace<span class="token punctuation">(</span>birthday,<span class="token string">'/'</span>,<span class="token string">'-'</span><span class="token punctuation">)</span> birthday
    from
      employee
<span class="token punctuation">)</span>t1 t2

-- 根据月份正负决定年龄

<span class="token keyword">select</span>
  name,
  concat<span class="token punctuation">(</span>if<span class="token punctuation">(</span>month<span class="token operator">&gt;=</span><span class="token number">0</span>,year,year-1<span class="token punctuation">)</span>,<span class="token string">'年'</span>,if<span class="token punctuation">(</span>month<span class="token operator">&gt;=</span><span class="token number">0</span>,month,12+month<span class="token punctuation">)</span>,<span class="token string">'月'</span><span class="token punctuation">)</span> age
from
  <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
      name,
      year<span class="token punctuation">(</span>current_date<span class="token punctuation">(</span><span class="token punctuation">))</span>-year<span class="token punctuation">(</span>t1.birthday<span class="token punctuation">)</span> year,
      month<span class="token punctuation">(</span>current_date<span class="token punctuation">(</span><span class="token punctuation">))</span>-month<span class="token punctuation">(</span>t1.birthday<span class="token punctuation">)</span> month
    from
      <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
          name,
          replace<span class="token punctuation">(</span>birthday,<span class="token string">'/'</span>,<span class="token string">'-'</span><span class="token punctuation">)</span> birthday
        from
          employee
    <span class="token punctuation">)</span>t1
<span class="token punctuation">)</span>t2
</code></pre> </li></ul> 
<p><strong>3）按照薪资，奖金的和进行倒序排序，如果奖金为null，置位0</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>name</th><th>sal</th></tr></thead><tbody><tr><td>周芷若</td><td>19000</td></tr><tr><td>宋青书</td><td>19000</td></tr><tr><td>郭靖</td><td>15000</td></tr><tr><td>张无忌</td><td>15000</td></tr><tr><td>黄蓉</td><td>12000</td></tr><tr><td>赵敏</td><td>11000</td></tr><tr><td>小龙女</td><td>6000</td></tr><tr><td>杨过</td><td>5000</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
  name,
  salary + nvl<span class="token punctuation">(</span>bonus,0<span class="token punctuation">)</span> sal
from
  employee
order by
   sal desc
</code></pre> </li></ul> 
<p><strong>4）查询每个人有多少个朋友</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>name</th><th>cnt</th></tr></thead><tbody><tr><td>张无忌</td><td>2</td></tr><tr><td>赵敏</td><td>2</td></tr><tr><td>宋青书</td><td>2</td></tr><tr><td>周芷若</td><td>2</td></tr><tr><td>郭靖</td><td>2</td></tr><tr><td>黄蓉</td><td>2</td></tr><tr><td>杨过</td><td>2</td></tr><tr><td>小龙女</td><td>2</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span> 
name,
size<span class="token punctuation">(</span>friends<span class="token punctuation">)</span> cnt
from 
employee<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p><strong>5）查询每个人的孩子的姓名</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>name</th><th>ch_name</th></tr></thead><tbody><tr><td>张无忌</td><td>[“张小无”,“张小忌”]</td></tr><tr><td>赵敏</td><td>[“赵小敏”]</td></tr><tr><td>宋青书</td><td>[“宋小青”,“宋小书”]</td></tr><tr><td>周芷若</td><td>[“宋小青”,“宋小书”]</td></tr><tr><td>郭靖</td><td>[“郭芙”,“郭襄”]</td></tr><tr><td>黄蓉</td><td>[“郭芙”,“郭襄”]</td></tr><tr><td>杨过</td><td>[“杨小过”]</td></tr><tr><td>小龙女</td><td>[“杨小过”]</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash">hive<span class="token operator">&gt;</span>
<span class="token keyword">select</span> 
name,
map_keys<span class="token punctuation">(</span>children<span class="token punctuation">)</span> ch_name
from 
employee<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p><strong>6）查询每个岗位男女各多少人</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>job</th><th>male</th><th>female</th></tr></thead><tbody><tr><td>前台</td><td>1</td><td>1</td></tr><tr><td>研发</td><td>1</td><td>1</td></tr><tr><td>行政</td><td>0</td><td>2</td></tr><tr><td>销售</td><td>2</td><td>0</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
  job,
  sum<span class="token punctuation">(</span>if<span class="token punctuation">(</span>sex<span class="token operator">=</span><span class="token string">'男'</span>,1,0<span class="token punctuation">))</span> male,
  sum<span class="token punctuation">(</span>if<span class="token punctuation">(</span>sex<span class="token operator">=</span><span class="token string">'女'</span>,1,0<span class="token punctuation">))</span> female
from
  employee
group by 
  job
</code></pre> </li></ul> 
<h3><a id="83%C2%A0_940"></a>8.3 高级聚合函数</h3> 
<p>多进一出 （多行传入，一个行输出）。</p> 
<p><strong>1）普通聚合 count/sum… 见第6章 6.2.4</strong></p> 
<p><strong>2）collect_list 收集并形成list集合，结果不去重</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span>
<span class="token keyword">select</span> 
  sex,
  collect_list<span class="token punctuation">(</span>job<span class="token punctuation">)</span>
from
  employee
group by 
  sex
</code></pre> 
<p>结果：</p> 
<pre><code class="prism language-sql">女 <span class="token punctuation">[</span><span class="token string">"行政"</span><span class="token punctuation">,</span><span class="token string">"研发"</span><span class="token punctuation">,</span><span class="token string">"行政"</span><span class="token punctuation">,</span><span class="token string">"前台"</span><span class="token punctuation">]</span>
男 <span class="token punctuation">[</span><span class="token string">"销售"</span><span class="token punctuation">,</span><span class="token string">"研发"</span><span class="token punctuation">,</span><span class="token string">"销售"</span><span class="token punctuation">,</span><span class="token string">"前台"</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>3）collect_set 收集并形成set集合，结果去重</strong></p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span>
<span class="token keyword">select</span> 
  sex,
  collect_set<span class="token punctuation">(</span>job<span class="token punctuation">)</span>
from
  employee
group by 
  sex
</code></pre> 
<p>结果：</p> 
<pre><code class="prism language-bash">女 <span class="token punctuation">[</span><span class="token string">"行政"</span>,<span class="token string">"研发"</span>,<span class="token string">"前台"</span><span class="token punctuation">]</span>
男 <span class="token punctuation">[</span><span class="token string">"销售"</span>,<span class="token string">"研发"</span>,<span class="token string">"前台"</span><span class="token punctuation">]</span>
</code></pre> 
<h4><a id="831__986"></a>8.3.1 案例演示</h4> 
<p><strong>1）每个月的入职人数以及姓名</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> 
<span class="token keyword">select</span>
  month<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>hiredate,<span class="token string">'/'</span>,<span class="token string">'-'</span><span class="token punctuation">))</span> as month,
  count<span class="token punctuation">(</span>*<span class="token punctuation">)</span> as cn,
  Collect_list<span class="token punctuation">(</span>name<span class="token punctuation">)</span> as name_list
from
  employee
group by
  month<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>hiredate,<span class="token string">'/'</span>,<span class="token string">'-'</span><span class="token punctuation">))</span>
</code></pre> </li></ul> 
<p>结果：</p> 
<pre><code class="prism language-bash">month  cn  name_list
<span class="token number">4</span>	    <span class="token number">2</span>	<span class="token punctuation">[</span><span class="token string">"宋青书"</span>,<span class="token string">"周芷若"</span><span class="token punctuation">]</span>
<span class="token number">6</span>	    <span class="token number">1</span>	<span class="token punctuation">[</span><span class="token string">"黄蓉"</span><span class="token punctuation">]</span>
<span class="token number">7</span>	    <span class="token number">1</span>	<span class="token punctuation">[</span><span class="token string">"郭靖"</span><span class="token punctuation">]</span>
<span class="token number">8</span>	    <span class="token number">2</span>	<span class="token punctuation">[</span><span class="token string">"张无忌"</span>,<span class="token string">"杨过"</span><span class="token punctuation">]</span>
<span class="token number">9</span>	    <span class="token number">2</span>	<span class="token punctuation">[</span><span class="token string">"赵敏"</span>,<span class="token string">"小龙女"</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="84__1015"></a>8.4 炸裂函数</h3> 
<h4><a id="841__1017"></a>8.4.1 概述</h4> 
<p><strong>UDTF</strong></p> 
<p><img src="https://images2.imgbox.com/86/1b/8yphOhaN_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/3d/3c/cULjdyvU_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/06/c8/7yaZK7YY_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/70/cc/wb8WoODJ_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/54/07/F3rxS4Tg_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/a5/f0/eTk2FWEa_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/43/25/XHJHALhU_o.png" alt="Untitled"></p> 
<h4><a id="842%C2%A0_1035"></a>8.4.2 案例演示</h4> 
<p><strong>1.数据准备</strong></p> 
<p><strong>1）表结构</strong></p> 
<table><thead><tr><th>movie</th><th>category</th></tr></thead><tbody><tr><td>《疑犯追踪》</td><td>悬疑，动作，科幻，剧情</td></tr><tr><td>《Lie to me》</td><td>悬疑，警匪，动作，心理，剧情</td></tr><tr><td>《战狼2》</td><td>战争，动作，灾难</td></tr></tbody></table> 
<p><strong>2）建表语句</strong></p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span>
create table movie_info<span class="token punctuation">(</span>
    movie string,     --电影名称
    category string   --电影分类
<span class="token punctuation">)</span> 
row <span class="token function">format</span> delimited fields terminated by <span class="token string">"<span class="token entity" title="\t">\t</span>"</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>3）装载语句</strong></p> 
<pre><code class="prism language-bash">insert overwrite table movie_info
values <span class="token punctuation">(</span><span class="token string">"《疑犯追踪》"</span>, <span class="token string">"悬疑,动作,科幻,剧情"</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">"《Lie to me》"</span>, <span class="token string">"悬疑,警匪,动作,心理,剧情"</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">"《战狼2》"</span>, <span class="token string">"战争,动作,灾难"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>2.需求</strong></p> 
<p><strong>1）需求说明</strong></p> 
<p><strong>根据上述电影信息表，统计各分类的电影数量，期望结果如下：</strong></p> 
<table><thead><tr><th>剧情</th><th>2</th></tr></thead><tbody><tr><td>动作</td><td>3</td></tr><tr><td>心理</td><td>1</td></tr><tr><td>悬疑</td><td>2</td></tr><tr><td>战争</td><td>1</td></tr><tr><td>灾难</td><td>1</td></tr><tr><td>科幻</td><td>1</td></tr><tr><td>警匪</td><td>1</td></tr></tbody></table> 
<p><strong>2）答案</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
    cate,
    count<span class="token punctuation">(</span>*<span class="token punctuation">)</span>
from
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        movie,
        cate
    from
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            movie,
            split<span class="token punctuation">(</span>category,<span class="token string">','</span><span class="token punctuation">)</span> cates
        from movie_info
    <span class="token punctuation">)</span>t1 lateral view explode<span class="token punctuation">(</span>cates<span class="token punctuation">)</span> tmp as cate
<span class="token punctuation">)</span>t2
group by cate<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h3><a id="85%C2%A0_1107"></a>8.5 窗口函数（开窗函数）</h3> 
<h4><a id="851__1109"></a>8.5.1 概述</h4> 
<p><img src="https://images2.imgbox.com/28/a9/uNPiOq3D_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/9e/f7/63qnaZin_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/7f/f4/PXslRFba_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/fb/0c/yX8yAp7m_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/92/e5/lXiJToRu_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/cd/93/K96ANZwZ_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/df/32/Dx3XtU49_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/37/87/aLoV2HF0_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/07/24/nNBa1PEp_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/4d/93/CVlvRJvc_o.png" alt="Untitled"></p> 
<p><img src="https://images2.imgbox.com/91/86/VgLYijGC_o.png" alt="Untitled"></p> 
<h4><a id="852__1133"></a>8.5.2 常用窗口函数</h4> 
<p>按照功能，常用窗口可划分为如下几类：聚合函数、跨行取值函数、排名函数。</p> 
<p><strong>1）聚合函数</strong></p> 
<p>max：最大值。</p> 
<p>min：最小值。</p> 
<p>sum：求和。</p> 
<p>avg：平均值。</p> 
<p>count：计数。</p> 
<p><strong>2）跨行取值函数</strong></p> 
<p><strong>（1）lead和lag</strong></p> 
<p><img src="https://images2.imgbox.com/90/ed/sMFtBsxv_o.png" alt="Untitled"></p> 
<p><strong>注：lag和lead函数不支持自定义窗口。</strong></p> 
<p><strong>（2）first_value和last_value</strong></p> 
<p><img src="https://images2.imgbox.com/65/71/FTQhKV3R_o.png" alt="Untitled"></p> 
<p><strong>3）排名函数</strong></p> 
<p><img src="https://images2.imgbox.com/71/91/StdoQpK5_o.png" alt="Untitled"></p> 
<p>注：<strong>rank 、dense_rank、row_number不支持自定义窗口。</strong></p> 
<h4><a id="853__1167"></a>8.5.3 案例演示</h4> 
<p><strong>1.数据准备</strong></p> 
<p><strong>1）表结构</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th></tr></thead><tbody><tr><td>1</td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td></tr><tr><td>2</td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td></tr><tr><td>3</td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td></tr><tr><td>4</td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td></tr><tr><td>5</td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td></tr></tbody></table> 
<p><strong>2）建表语句</strong></p> 
<pre><code class="prism language-bash">create table order_info
<span class="token punctuation">(</span>
    order_id     string, --订单id
    user_id      string, -- 用户id
    user_name    string, -- 用户姓名
    order_date   string, -- 下单日期
    order_amount int     -- 订单金额
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>3）装载语句</strong></p> 
<pre><code class="prism language-bash">insert overwrite table order_info
values <span class="token punctuation">(</span><span class="token string">'1'</span>, <span class="token string">'1001'</span>, <span class="token string">'小元'</span>, <span class="token string">'2022-01-01'</span>, <span class="token string">'10'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'2'</span>, <span class="token string">'1002'</span>, <span class="token string">'小海'</span>, <span class="token string">'2022-01-02'</span>, <span class="token string">'15'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'3'</span>, <span class="token string">'1001'</span>, <span class="token string">'小元'</span>, <span class="token string">'2022-02-03'</span>, <span class="token string">'23'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'4'</span>, <span class="token string">'1002'</span>, <span class="token string">'小海'</span>, <span class="token string">'2022-01-04'</span>, <span class="token string">'29'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'5'</span>, <span class="token string">'1001'</span>, <span class="token string">'小元'</span>, <span class="token string">'2022-01-05'</span>, <span class="token string">'46'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'6'</span>, <span class="token string">'1001'</span>, <span class="token string">'小元'</span>, <span class="token string">'2022-04-06'</span>, <span class="token string">'42'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'7'</span>, <span class="token string">'1002'</span>, <span class="token string">'小海'</span>, <span class="token string">'2022-01-07'</span>, <span class="token string">'50'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'8'</span>, <span class="token string">'1001'</span>, <span class="token string">'小元'</span>, <span class="token string">'2022-01-08'</span>, <span class="token string">'50'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'9'</span>, <span class="token string">'1003'</span>, <span class="token string">'小辉'</span>, <span class="token string">'2022-04-08'</span>, <span class="token string">'62'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'10'</span>, <span class="token string">'1003'</span>, <span class="token string">'小辉'</span>, <span class="token string">'2022-04-09'</span>, <span class="token string">'62'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'11'</span>, <span class="token string">'1004'</span>, <span class="token string">'小猛'</span>, <span class="token string">'2022-05-10'</span>, <span class="token string">'12'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'12'</span>, <span class="token string">'1003'</span>, <span class="token string">'小辉'</span>, <span class="token string">'2022-04-11'</span>, <span class="token string">'75'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'13'</span>, <span class="token string">'1004'</span>, <span class="token string">'小猛'</span>, <span class="token string">'2022-06-12'</span>, <span class="token string">'80'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'14'</span>, <span class="token string">'1003'</span>, <span class="token string">'小辉'</span>, <span class="token string">'2022-04-13'</span>, <span class="token string">'94'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>2.需求</strong></p> 
<p><strong>1）统计每个用户截至每次下单的累积下单总额</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>sum_so_far</th></tr></thead><tbody><tr><td>1</td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>10</td></tr><tr><td>5</td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>56</td></tr><tr><td>8</td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>106</td></tr><tr><td>3</td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>129</td></tr><tr><td>6</td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>171</td></tr><tr><td>2</td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>15</td></tr><tr><td>4</td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>44</td></tr><tr><td>7</td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>94</td></tr><tr><td>9</td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>62</td></tr><tr><td>10</td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>124</td></tr><tr><td>12</td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>199</td></tr><tr><td>14</td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>293</td></tr><tr><td>11</td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>12</td></tr><tr><td>13</td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>92</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
    order_id,
    user_id,
    user_name,
    order_date,
    order_amount,
    sum<span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by user_id order by order_date rows between unbounded preceding and current row<span class="token punctuation">)</span> sum_so_far
from order_info<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p><strong>2）统计每个用户截至每次下单的当月累积下单总额</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>sum_so_far</th></tr></thead><tbody><tr><td>1</td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>10</td></tr><tr><td>5</td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>56</td></tr><tr><td>8</td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>106</td></tr><tr><td>3</td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>23</td></tr><tr><td>6</td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>42</td></tr><tr><td>2</td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>15</td></tr><tr><td>4</td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>44</td></tr><tr><td>7</td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>94</td></tr><tr><td>9</td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>62</td></tr><tr><td>10</td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>124</td></tr><tr><td>12</td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>199</td></tr><tr><td>14</td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>293</td></tr><tr><td>11</td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>12</td></tr><tr><td>13</td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>80</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
    order_id,
    user_id,
    user_name,
    order_date,
    order_amount,
    sum<span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by user_id,substring<span class="token punctuation">(</span>order_date,1,7<span class="token punctuation">)</span> order by order_date rows between unbounded preceding and current row<span class="token punctuation">)</span> sum_so_far
from order_info<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p><strong>3）统计每个用户每次下单距离上次下单相隔的天数（首次下单按0天算）</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>diff</th></tr></thead><tbody><tr><td>1</td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>0</td></tr><tr><td>5</td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>4</td></tr><tr><td>8</td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>3</td></tr><tr><td>3</td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>26</td></tr><tr><td>6</td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>62</td></tr><tr><td>2</td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>0</td></tr><tr><td>4</td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>2</td></tr><tr><td>7</td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>3</td></tr><tr><td>9</td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>0</td></tr><tr><td>10</td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>1</td></tr><tr><td>12</td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>2</td></tr><tr><td>14</td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>2</td></tr><tr><td>11</td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>0</td></tr><tr><td>13</td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>33</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
    order_id,
    user_id,
    user_name,
    order_date,
    order_amount,
    nvl<span class="token punctuation">(</span>datediff<span class="token punctuation">(</span>order_date,last_order_date<span class="token punctuation">)</span>,0<span class="token punctuation">)</span> <span class="token function">diff</span>
from
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        order_id,
        user_id,
        user_name,
        order_date,
        order_amount,
        lag<span class="token punctuation">(</span>order_date,1,null<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by user_id order by order_date<span class="token punctuation">)</span> last_order_date
    from order_info
<span class="token punctuation">)</span>t1
</code></pre> </li></ul> 
<p><strong>4）查询所有下单记录以及每个用户的每个下单记录所在月份的首/末次下单日期</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>first_date</th><th>last_date</th></tr></thead><tbody><tr><td>1</td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>2022-01-01</td><td>2022-01-08</td></tr><tr><td>5</td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>2022-01-01</td><td>2022-01-08</td></tr><tr><td>8</td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>2022-01-01</td><td>2022-01-08</td></tr><tr><td>3</td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>2022-02-03</td><td>2022-02-03</td></tr><tr><td>6</td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>2022-04-06</td><td>2022-04-06</td></tr><tr><td>2</td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>2022-01-02</td><td>2022-01-07</td></tr><tr><td>4</td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>2022-01-02</td><td>2022-01-07</td></tr><tr><td>7</td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>2022-01-02</td><td>2022-01-07</td></tr><tr><td>9</td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>2022-04-08</td><td>2022-04-13</td></tr><tr><td>10</td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>2022-04-08</td><td>2022-04-13</td></tr><tr><td>12</td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>2022-04-08</td><td>2022-04-13</td></tr><tr><td>14</td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>2022-04-08</td><td>2022-04-13</td></tr><tr><td>11</td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>2022-05-10</td><td>2022-05-10</td></tr><tr><td>13</td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>2022-06-12</td><td>2022-06-12</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
    order_id,
    user_id,
    user_name,
    order_date,
    order_amount,
    first_value<span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by user_id,substring<span class="token punctuation">(</span>order_date,1,7<span class="token punctuation">)</span> order by order_date<span class="token punctuation">)</span> first_date,
    last_value<span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by user_id,substring<span class="token punctuation">(</span>order_date,1,7<span class="token punctuation">)</span> order by order_date rows between unbounded preceding and unbounded following<span class="token punctuation">)</span> last_date
from order_info<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p><strong>5）为每个用户的所有下单记录按照订单金额进行排名</strong></p> 
<p><strong>（1）期望结果</strong></p> 
<table><thead><tr><th>order_id</th><th>user_id</th><th>user_name</th><th>order_date</th><th>order_amount</th><th>rk</th><th>drk</th><th>rn</th></tr></thead><tbody><tr><td>8</td><td>1001</td><td>小元</td><td>2022-01-08</td><td>50</td><td>1</td><td>1</td><td>1</td></tr><tr><td>5</td><td>1001</td><td>小元</td><td>2022-01-05</td><td>46</td><td>2</td><td>2</td><td>2</td></tr><tr><td>6</td><td>1001</td><td>小元</td><td>2022-04-06</td><td>42</td><td>3</td><td>3</td><td>3</td></tr><tr><td>3</td><td>1001</td><td>小元</td><td>2022-02-03</td><td>23</td><td>4</td><td>4</td><td>4</td></tr><tr><td>1</td><td>1001</td><td>小元</td><td>2022-01-01</td><td>10</td><td>5</td><td>5</td><td>5</td></tr><tr><td>7</td><td>1002</td><td>小海</td><td>2022-01-07</td><td>50</td><td>1</td><td>1</td><td>1</td></tr><tr><td>4</td><td>1002</td><td>小海</td><td>2022-01-04</td><td>29</td><td>2</td><td>2</td><td>2</td></tr><tr><td>2</td><td>1002</td><td>小海</td><td>2022-01-02</td><td>15</td><td>3</td><td>3</td><td>3</td></tr><tr><td>14</td><td>1003</td><td>小辉</td><td>2022-04-13</td><td>94</td><td>1</td><td>1</td><td>1</td></tr><tr><td>12</td><td>1003</td><td>小辉</td><td>2022-04-11</td><td>75</td><td>2</td><td>2</td><td>2</td></tr><tr><td>9</td><td>1003</td><td>小辉</td><td>2022-04-08</td><td>62</td><td>3</td><td>3</td><td>3</td></tr><tr><td>10</td><td>1003</td><td>小辉</td><td>2022-04-09</td><td>62</td><td>3</td><td>3</td><td>4</td></tr><tr><td>13</td><td>1004</td><td>小猛</td><td>2022-06-12</td><td>80</td><td>1</td><td>1</td><td>1</td></tr><tr><td>11</td><td>1004</td><td>小猛</td><td>2022-05-10</td><td>12</td><td>2</td><td>2</td><td>2</td></tr></tbody></table> 
<p><strong>（2）需求实现</strong></p> 
<ul><li> <p>code</p> <pre><code class="prism language-bash"><span class="token keyword">select</span>
    order_id,
    user_id,
    user_name,
    order_date,
    order_amount,
    rank<span class="token punctuation">(</span><span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by user_id order by order_amount desc<span class="token punctuation">)</span> rk,
    dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by user_id order by order_amount desc<span class="token punctuation">)</span> drk,
    row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by user_id order by order_amount desc<span class="token punctuation">)</span> rn
from order_info<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p>TopN</p> 
<pre><code>select
    order_id,
    user_id,
    user_name,
    order_date,
    order_amount,
    rk
from
(select
    order_id,
    user_id,
    user_name,
    order_date,
    order_amount,
    rank() over(partition by user_id order by order_amount desc) rk
from order_info)t1
where rk &lt;=3;
</code></pre> 
<h3><a id="86%C2%A0_1431"></a>8.6 自定义函数</h3> 
<p><strong>1）Hive自带了一些函数，比如：max/min等，但是数量有限，自己可以通过自定义UDF来方便的扩展。</strong></p> 
<p><strong>2）当Hive提供的内置函数无法满足你的业务处理需要时，此时就可以考虑使用用户自定义函数（UDF：user-defined function）。</strong></p> 
<p><strong>3）根据用户自定义函数类别分为以下三种：</strong></p> 
<ul><li><strong>UDF（User-Defined-Function）</strong>：一进一出。</li><li><strong>UDAF（User-Defined Aggregation Function）</strong>：用户自定义聚合函数，多进一出。类似于：count/max/min</li><li><strong>UDTF（User-Defined Table-Generating Functions）</strong>：用户自定义表生成函数，一进多出。如lateral view explode()</li></ul> 
<p><strong>4）官方文档地址</strong></p> 
<p><a href="https://cwiki.apache.org/confluence/display/Hive/HivePlugins" rel="nofollow">https://cwiki.apache.org/confluence/display/Hive/HivePlugins</a></p> 
<p><strong>5）编程步骤</strong></p> 
<p>（1）继承Hive提供的类</p> 
<p><code>org.apache.hadoop.hive.ql.udf.generic.GenericUDF</code></p> 
<p><code>org.apache.hadoop.hive.ql.udf.generic.GenericUDTF;</code></p> 
<p>（2）实现类中的抽象方法</p> 
<p>（3）在hive的命令行窗口创建函数</p> 
<p>添加jar。</p> 
<pre><code class="prism language-bash"><span class="token function">add</span> jar linux_jar_path
</code></pre> 
<p>创建function。</p> 
<pre><code class="prism language-bash">create <span class="token punctuation">[</span>temporary<span class="token punctuation">]</span> <span class="token keyword">function</span> <span class="token punctuation">[</span>dbname.<span class="token punctuation">]</span>function_name AS class_name<span class="token punctuation">;</span>
</code></pre> 
<p>（4）在hive的命令行窗口删除函数</p> 
<pre><code class="prism language-bash">drop <span class="token punctuation">[</span>temporary<span class="token punctuation">]</span> <span class="token keyword">function</span> <span class="token punctuation">[</span>if exists<span class="token punctuation">]</span> <span class="token punctuation">[</span>dbname.<span class="token punctuation">]</span>function_name<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="87_UDF_1477"></a>8.7 自定义UDF函数</h3> 
<p><strong>0）需求</strong></p> 
<p>自定义一个UDF实现计算给定基本数据类型的长度，例如：</p> 
<pre><code class="prism language-bash">hive<span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> my_len<span class="token punctuation">(</span><span class="token string">"abcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span>
</code></pre> 
<p><strong>1）创建一个Maven工程Hive</strong></p> 
<p><strong>2）导入依赖</strong></p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependencies<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.hive<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>hive-exec<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">3.1</span>.<span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>/version<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependencies<span class="token operator">&gt;</span>
</code></pre> 
<p><strong>3）创建一个类</strong></p> 
<pre><code class="prism language-bash">package com.atguigu.hive.udf<span class="token punctuation">;</span>

<span class="token function">import</span> org.apache.hadoop.hive.ql.exec.UDFArgumentException<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hive.ql.exec.UDFArgumentLengthException<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hive.ql.exec.UDFArgumentTypeException<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hive.ql.metadata.HiveException<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hive.ql.udf.generic.GenericUDF<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hive.serde2.objectinspector.ObjectInspector<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hive.serde2.objectinspector.PrimitiveObjectInspector<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hive.serde2.objectinspector.primitive.PrimitiveObjectInspectorFactory<span class="token punctuation">;</span>

/**
 * 我们需计算一个要给定基本数据类型的长度
 */
public class MyUDF extends GenericUDF <span class="token punctuation">{<!-- --></span>
    /**
     * 判断传进来的参数的类型和长度
     * 约定返回的数据类型
     */
    @Override
    public ObjectInspector initialize<span class="token punctuation">(</span>ObjectInspector<span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> throws UDFArgumentException <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments.length <span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw  new UDFArgumentLengthException<span class="token punctuation">(</span><span class="token string">"只接受一个参数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ObjectInspector argument <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>argument.getCategory<span class="token punctuation">(</span><span class="token punctuation">)</span>.equals<span class="token punctuation">(</span>ObjectInspector.Category.PRIMITIVE<span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
            throw  new UDFArgumentTypeException<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"只接受基本数据类型的参数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        PrimitiveObjectInspector primitiveObjectInspector <span class="token operator">=</span> <span class="token punctuation">(</span>PrimitiveObjectInspector<span class="token punctuation">)</span> argument<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>primitiveObjectInspector.getPrimitiveCategory<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>  PrimitiveObjectInspector.PrimitiveCategory.STRING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw  new UDFArgumentTypeException<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"只接受String类型的参数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">return</span> PrimitiveObjectInspectorFactory.javaIntObjectInspector<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    /**
     * 解决具体逻辑的
     */
    @Override
    public Object evaluate<span class="token punctuation">(</span>DeferredObject<span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> throws HiveException <span class="token punctuation">{<!-- --></span>

        Object o <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        if<span class="token punctuation">(</span>o<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token builtin class-name">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token builtin class-name">return</span> o.toString<span class="token punctuation">(</span><span class="token punctuation">)</span>.length<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    // 用于获取解释的字符串
    public String getDisplayString<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>4）创建临时函数</strong></p> 
<p>（1）打成jar包上传到服务器/opt/module/hive/datas/myudf.jar</p> 
<p>（2）将jar包添加到hive的classpath，临时生效</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">add</span> jar /opt/module/hive/datas/myudf.jar<span class="token punctuation">;</span>
</code></pre> 
<p>（3）创建临时函数与开发好的java class关联</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> 
create temporary <span class="token keyword">function</span> my_len 
as <span class="token string">"com.atguigu.hive.udf.MyUDF"</span><span class="token punctuation">;</span>
</code></pre> 
<p>（4）即可在hql中使用自定义的临时函数</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> 
<span class="token keyword">select</span> 
    ename,
    my_len<span class="token punctuation">(</span>ename<span class="token punctuation">)</span> ename_len 
from emp<span class="token punctuation">;</span>
</code></pre> 
<p>（5）删除临时函数</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> drop temporary <span class="token keyword">function</span> my_len<span class="token punctuation">;</span>
</code></pre> 
<p>注意：临时函数只跟会话有关系，跟库没有关系。只要创建临时函数的会话不断，在当前会话下，任意一个库都可以使用，其他会话全都不能使用。</p> 
<ul><li><strong>创建永久函数</strong></li></ul> 
<p>（1）创建永久函数</p> 
<p>注意：因为add jar本身也是临时生效，所以在创建永久函数的时候，需要制定路径（并且因为元数据的原因，这个路径还得是HDFS上的路径）。</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> 
create <span class="token keyword">function</span> my_len2 
as <span class="token string">"com.atguigu.hive.udf.MyUDF"</span> 
using jar <span class="token string">"hdfs://hadoop102:8020/udf/myudf.jar"</span><span class="token punctuation">;</span>
</code></pre> 
<p>（2）即可在hql中使用自定义的永久函数</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> 
<span class="token keyword">select</span> 
    ename,
    my_len2<span class="token punctuation">(</span>ename<span class="token punctuation">)</span> ename_len 
from emp<span class="token punctuation">;</span>
</code></pre> 
<p>（3）删除永久函数</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> drop <span class="token keyword">function</span> my_len2<span class="token punctuation">;</span>
</code></pre> 
<p>注意：永久函数跟会话没有关系，创建函数的会话断了以后，其他会话也可以使用。</p> 
<p>永久函数创建的时候，在函数名之前需要自己加上库名，如果不指定库名的话，会默认把当前库的库名给加上。</p> 
<p>永久函数使用的时候，需要在指定的库里面操作，或者在其他库里面使用的话加上，<strong>库名.函数名。</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cbd022c764cd37bee848c617b92c3e3a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">广东专升本C语言程序设计（完结）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/abc1ed6aef4f19ec2ce0077197e51c74/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IDEA 控制台输出中文乱码的简单解决方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>