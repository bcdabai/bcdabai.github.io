<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>看书标记【R语言数据分析项目精解：理论、方法、实战 9】 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="看书标记【R语言数据分析项目精解：理论、方法、实战 9】" />
<meta property="og:description" content="看书标记——R语言 Chapter 9 文本挖掘——点评数据展示策略9.1项目背景、目标和方案9.1.1项目背景9.1.2项目目标9.1.3项目方案1.建立评论文本质量量化指标2.建立用户相似度模型3.对用户评论进行情感性分析 9.2项目技术理论简介9.2.1评论文本质量量化指标模型1.主题覆盖量2.评论文本分词数量3.评论点赞数4.评论中的照片数5.评论分值偏移 9.2.2用户相似度模型1.pearson相关系数2.欧几里得距离3.夹角余弦相似度4.马氏距离 9.2.3情感性分析1.文本挖掘基础知识2.基于规则情感性分析方法3.词汇极性判断4.关键词提取 9.2.4R语言实例代码1.分词2.配置词典3.增加自定义词典4.增加停用词词典5.关键词提取TF-IDF6.词性标注 9.3项目实践9.3.1若干自定义函数1.数据清理3.分词 9.3.2文本质量量化指标模型9.3.3用户相似度模型9.3.4情感词分析1.导入评论数据并清洗分词2.关联情感词、否定词和程度副词3.对片段进行窗口期判定及综合打分 9.3.5总结 【R语言数据分析项目精解：理论、方法、实战 9】 Chapter 9 文本挖掘——点评数据展示策略 9.1项目背景、目标和方案 9.1.1项目背景 评论内容无效、评论数据千人一面，有必要对评论显示策略做出一定的调整
9.1.2项目目标 (1）对评论文本的质量进行监控和量化，将一些无效评论的显示顺序滞后。
(2）制定用户相似度模型，将用户的评论给与他相似的用户看，达到千人百面的效果。
(3）对评论所表达的情感进行分析，综合评分和情感两个方面对评论进行排序。
9.1.3项目方案 1.建立评论文本质量量化指标 对评论文本进行分析，评论文本质量量化指标主要考虑如下几个因素。
(1）主题覆盖量
主要考虑评论文本中对产品专有主题的覆盖情况。
(2）评论文本分词数量
评论文本写得越详细、内容越多，对访问者的帮助可能就越大，删除过渡词后，看剩余文本单词的数量，数量越多，该条评论的信息量就越大。
(3）评论点赞数
评论点赞数越多，该条评论对用户就越有用。
(4）评论中的照片数量
很好理解，有照片的评论显然要比没有照片的评论更加真实和有用。
(5）评论分值偏移
用户给该产品人为打的一个主观评价分，但并不是评分分值越高，该条评论的质量就越高，若用户的打分有失公允，那么该条评论的质量也就不算高了。
2.建立用户相似度模型 用户行为及用户属性，相似度计算，建立相似度模型
3.对用户评论进行情感性分析 基于词典的情感分析对评论文本进行分析。
9.2项目技术理论简介 9.2.1评论文本质量量化指标模型 1.主题覆盖量 指定五个主题，每个主题都有收集对应的相关词汇用于描述相关主题。每涉及一项主题为0.2，满分为1。
2.评论文本分词数量 去除停用词，得到相对真实的论文文本，然后分词，统计词频，最后计算五分位数，每个分位数区间的数从小到大赋予0.2、0.4、0.6、0.8、1分。
3.评论点赞数 计算评论点赞数，也计算五分位数，然后赋值0~1分。
4.评论中的照片数 有照片记为1分，反之为0。
5.评论分值偏移 评论分值偏移就是计算评论分值与所有评论中位数的偏移程度。首先计算所有评分的中位数，然后计算每个分值与中位数的差值绝对值，接着分别计算这些差值绝对值的20%、40%、60%、80%分位数，最后以如下标准计分（依中心递减）：在中位数加减20%分位数内为1分、在中位数减去40%分位数和中位数减去20%分位数之间及中位数加上20%分位数和中位数加上40%分位数之间的记为0.8分，以此类推，在每个区间依次递减0.6、0.4和0.2分，而之所以选择中位数作为中心点是为了防止异常值的影响，针对主题也可以与需求方商讨赋予不同的权重。
9.2.2用户相似度模型 用户相似度模型可以让用户优先看到与之相似的用户的评论数，关于相似度的计算，本质上就是计算两个向量的距离，两个向量的距离越近，它们的相似度就越大。
1.pearson相关系数 衡量两个定距变量线性相关性的统计量，优缺点：皮尔逊相关系数较易理解且计算方便，但是在使用过程中需要假设数据是成对地取自于正态分布，并且从指标的几何意义上来说，它反映了两个向量线性方向的相关关系（成比例关系），非线性的相关关系无法体现。
2.欧几里得距离 优缺点：欧几里德距离是所有距离公式中广为人知且最简单的一种，但是就大部分统计问题而言，其效果不甚理想。每个维度对其贡献都是相等的，并且容易受单位量纲的影响，没有考虑到总体变异对距离远近的关联。为了弥补单位量纲上的差异，可以先对每个维度做标准化处理，然后计算欧几里德距离。
3.夹角余弦相似度 与欧几里得距离不同，夹角余弦相似度侧重于两向量之间方向差异的度量，对量纲上的铭感度较小，所以适用于对绝对数值不敏感、主观评价等数据。
4.马氏距离 本质上是数据协方差距离，考虑了不同维度之间的关系。优缺点：马氏距离去除了各维度之间的相关性，这点也是马氏距离最大的优点。若两个向量中多个维度相关性较高，则某个维度的影响会被多次使用，这显然会对最后的结果产生误差。
9.2.3情感性分析 1.文本挖掘基础知识 （1）分词模型：最大概率模型、隐马尔科夫模型、混合模型
（2）词典：若干单词组成的库，可在知网词典获取停用词、副词、否定词
2.基于规则情感性分析方法 针对每个片段判断其情感极性得分，汇总计算得到情感累计得分：
3.词汇极性判断 介绍一种算法SO-PMI，可以有效地从大量词汇中找出那些接近正向或负向的情感词，然后人为地进行最终判定，从而大大减少人工识别的时间。具体步骤如下（选自《基于平滑SO-PMI算法的微博情感词典构建方法研究》）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/78871b3f242bbdb5e0c500d0691c7afe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-21T21:07:51+08:00" />
<meta property="article:modified_time" content="2024-01-21T21:07:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">看书标记【R语言数据分析项目精解：理论、方法、实战 9】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>看书标记——R语言</h4> 
 <ul><li><a href="#Chapter_9__2" rel="nofollow">Chapter 9 文本挖掘——点评数据展示策略</a></li><li><ul><li><ul><li><a href="#91_3" rel="nofollow">9.1项目背景、目标和方案</a></li><li><ul><li><a href="#911_4" rel="nofollow">9.1.1项目背景</a></li><li><a href="#912_6" rel="nofollow">9.1.2项目目标</a></li><li><a href="#913_10" rel="nofollow">9.1.3项目方案</a></li><li><ul><li><a href="#1_11" rel="nofollow">1.建立评论文本质量量化指标</a></li><li><a href="#2_23" rel="nofollow">2.建立用户相似度模型</a></li><li><a href="#3_25" rel="nofollow">3.对用户评论进行情感性分析</a></li></ul> 
    </li></ul> 
    </li><li><a href="#92_27" rel="nofollow">9.2项目技术理论简介</a></li><li><ul><li><a href="#921_28" rel="nofollow">9.2.1评论文本质量量化指标模型</a></li><li><ul><li><a href="#1_29" rel="nofollow">1.主题覆盖量</a></li><li><a href="#2_31" rel="nofollow">2.评论文本分词数量</a></li><li><a href="#3_33" rel="nofollow">3.评论点赞数</a></li><li><a href="#4_35" rel="nofollow">4.评论中的照片数</a></li><li><a href="#5_37" rel="nofollow">5.评论分值偏移</a></li></ul> 
     </li><li><a href="#922_39" rel="nofollow">9.2.2用户相似度模型</a></li><li><ul><li><a href="#1pearson_41" rel="nofollow">1.pearson相关系数</a></li><li><a href="#2_43" rel="nofollow">2.欧几里得距离</a></li><li><a href="#3_45" rel="nofollow">3.夹角余弦相似度</a></li><li><a href="#4_47" rel="nofollow">4.马氏距离</a></li></ul> 
     </li><li><a href="#923_49" rel="nofollow">9.2.3情感性分析</a></li><li><ul><li><a href="#1_50" rel="nofollow">1.文本挖掘基础知识</a></li><li><a href="#2_53" rel="nofollow">2.基于规则情感性分析方法</a></li><li><a href="#3_56" rel="nofollow">3.词汇极性判断</a></li><li><a href="#4_58" rel="nofollow">4.关键词提取</a></li></ul> 
     </li><li><a href="#924R_60" rel="nofollow">9.2.4R语言实例代码</a></li><li><ul><li><a href="#1_62" rel="nofollow">1.分词</a></li><li><a href="#2_90" rel="nofollow">2.配置词典</a></li><li><a href="#3_102" rel="nofollow">3.增加自定义词典</a></li><li><a href="#4_117" rel="nofollow">4.增加停用词词典</a></li><li><a href="#5TFIDF_126" rel="nofollow">5.关键词提取TF-IDF</a></li><li><a href="#6_139" rel="nofollow">6.词性标注</a></li></ul> 
    </li></ul> 
    </li><li><a href="#93_149" rel="nofollow">9.3项目实践</a></li><li><ul><li><a href="#931_150" rel="nofollow">9.3.1若干自定义函数</a></li><li><ul><li><a href="#1_151" rel="nofollow">1.数据清理</a></li><li><a href="#3_198" rel="nofollow">3.分词</a></li></ul> 
     </li><li><a href="#932_219" rel="nofollow">9.3.2文本质量量化指标模型</a></li><li><a href="#933_348" rel="nofollow">9.3.3用户相似度模型</a></li><li><a href="#934_372" rel="nofollow">9.3.4情感词分析</a></li><li><ul><li><a href="#1_373" rel="nofollow">1.导入评论数据并清洗分词</a></li><li><a href="#2_402" rel="nofollow">2.关联情感词、否定词和程度副词</a></li><li><a href="#3_414" rel="nofollow">3.对片段进行窗口期判定及综合打分</a></li></ul> 
     </li><li><a href="#935_500" rel="nofollow">9.3.5总结</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<br> 【R语言数据分析项目精解：理论、方法、实战 9】 
<p></p> 
<h2><a id="Chapter_9__2"></a>Chapter 9 文本挖掘——点评数据展示策略</h2> 
<h4><a id="91_3"></a>9.1项目背景、目标和方案</h4> 
<h5><a id="911_4"></a>9.1.1项目背景</h5> 
<p>评论内容无效、评论数据千人一面，有必要对评论显示策略做出一定的调整</p> 
<h5><a id="912_6"></a>9.1.2项目目标</h5> 
<p>(1）对评论文本的质量进行监控和量化，将一些无效评论的显示顺序滞后。<br> (2）制定用户相似度模型，将用户的评论给与他相似的用户看，达到千人百面的效果。<br> (3）对评论所表达的情感进行分析，综合评分和情感两个方面对评论进行排序。</p> 
<h5><a id="913_10"></a>9.1.3项目方案</h5> 
<h6><a id="1_11"></a>1.建立评论文本质量量化指标</h6> 
<p>对评论文本进行分析，评论文本质量量化指标主要考虑如下几个因素。<br> (1）主题覆盖量<br> 主要考虑评论文本中对产品专有主题的覆盖情况。<br> (2）评论文本分词数量<br> 评论文本写得越详细、内容越多，对访问者的帮助可能就越大，删除过渡词后，看剩余文本单词的数量，数量越多，该条评论的信息量就越大。<br> (3）评论点赞数<br> 评论点赞数越多，该条评论对用户就越有用。<br> (4）评论中的照片数量<br> 很好理解，有照片的评论显然要比没有照片的评论更加真实和有用。<br> (5）评论分值偏移<br> 用户给该产品人为打的一个主观评价分，但并不是评分分值越高，该条评论的质量就越高，若用户的打分有失公允，那么该条评论的质量也就不算高了。</p> 
<h6><a id="2_23"></a>2.建立用户相似度模型</h6> 
<p>用户行为及用户属性，相似度计算，建立相似度模型</p> 
<h6><a id="3_25"></a>3.对用户评论进行情感性分析</h6> 
<p>基于词典的情感分析对评论文本进行分析。</p> 
<h4><a id="92_27"></a>9.2项目技术理论简介</h4> 
<h5><a id="921_28"></a>9.2.1评论文本质量量化指标模型</h5> 
<h6><a id="1_29"></a>1.主题覆盖量</h6> 
<p>指定五个主题，每个主题都有收集对应的相关词汇用于描述相关主题。每涉及一项主题为0.2，满分为1。</p> 
<h6><a id="2_31"></a>2.评论文本分词数量</h6> 
<p><strong>去除停用词</strong>，得到相对真实的论文文本，然后<strong>分词</strong>，统计词频，最后计算五分位数，每个分位数区间的数从小到大赋予0.2、0.4、0.6、0.8、1分。</p> 
<h6><a id="3_33"></a>3.评论点赞数</h6> 
<p>计算评论点赞数，也计算五分位数，然后赋值0~1分。</p> 
<h6><a id="4_35"></a>4.评论中的照片数</h6> 
<p>有照片记为1分，反之为0。</p> 
<h6><a id="5_37"></a>5.评论分值偏移</h6> 
<p>评论分值偏移就是计算评论分值与所有评论中位数的偏移程度。首先计算所有评分的中位数，然后计算每个分值与中位数的差值绝对值，接着分别计算这些差值绝对值的20%、40%、60%、80%分位数，最后以如下标准计分（依中心递减）：在中位数加减20%分位数内为1分、在中位数减去40%分位数和中位数减去20%分位数之间及中位数加上20%分位数和中位数加上40%分位数之间的记为0.8分，以此类推，在每个区间依次递减0.6、0.4和0.2分，而之所以选择中位数作为中心点是为了防止异常值的影响，针对主题也可以与需求方商讨赋予不同的权重。</p> 
<h5><a id="922_39"></a>9.2.2用户相似度模型</h5> 
<p>用户相似度模型可以让用户优先看到与之相似的用户的评论数，关于相似度的计算，本质上就是计算两个向量的距离，两个向量的距离越近，它们的相似度就越大。</p> 
<h6><a id="1pearson_41"></a>1.pearson相关系数</h6> 
<p>衡量两个定距变量线性相关性的统计量，优缺点：皮尔逊相关系数较易理解且计算方便，但是在使用过程中需要假设数据是成对地取自于<strong>正态分布</strong>，并且从指标的几何意义上来说，它反映了两个向量<strong>线性方向</strong>的相关关系（成比例关系），非线性的相关关系无法体现。</p> 
<h6><a id="2_43"></a>2.欧几里得距离</h6> 
<p>优缺点：欧几里德距离是所有距离公式中广为人知且最简单的一种，但是就大部分统计问题而言，其效果不甚理想。每个维度对其贡献都是相等的，并且容易受单位量纲的影响，没有考虑到总体变异对距离远近的关联。为了弥补单位量纲上的差异，可以先对每个维度做标准化处理，然后计算欧几里德距离。</p> 
<h6><a id="3_45"></a>3.夹角余弦相似度</h6> 
<p>与欧几里得距离不同，夹角余弦相似度侧重于两向量之间方向差异的度量，对量纲上的铭感度较小，所以适用于<strong>对绝对数值不敏感、主观评价</strong>等数据。</p> 
<h6><a id="4_47"></a>4.马氏距离</h6> 
<p>本质上是数据协方差距离，考虑了不同维度之间的关系。优缺点：马氏距离<strong>去除了各维度之间的相关性</strong>，这点也是马氏距离最大的优点。若两个向量中多个维度相关性较高，则某个维度的影响会被多次使用，这显然会对最后的结果产生误差。</p> 
<h5><a id="923_49"></a>9.2.3情感性分析</h5> 
<h6><a id="1_50"></a>1.文本挖掘基础知识</h6> 
<p>（1）分词模型：最大概率模型、隐马尔科夫模型、混合模型<br> （2）词典：若干单词组成的库，可在<a href="http://www.keenage.com/html/c_bulletin_2007.htm" rel="nofollow">知网词典</a>获取停用词、副词、否定词</p> 
<h6><a id="2_53"></a>2.基于规则情感性分析方法</h6> 
<p>针对每个片段判断其情感极性得分，汇总计算得到情感累计得分：<br> <img src="https://images2.imgbox.com/91/d5/xkJe3WoO_o.png" alt="情感累计得分公式"></p> 
<h6><a id="3_56"></a>3.词汇极性判断</h6> 
<p>介绍一种算法<strong>SO-PMI</strong>，可以有效地从大量词汇中找出那些接近正向或负向的情感词，然后人为地进行最终判定，从而大大减少人工识别的时间。具体步骤如下（选自《基于平滑SO-PMI算法的微博情感词典构建方法研究》）。</p> 
<h6><a id="4_58"></a>4.关键词提取</h6> 
<p><strong>TF-IDF</strong>（词频-逆文档频率），依据TF给单词赋予IDF的权重，结果从大到小排序得到关键性排序列表，TF-IDF与词在文档中出现的次数呈正比，与该词在整个语句中出现次数成反比。这种算法的优点为：简单快速，结果比较符合实际情况。这种算法也有相应的缺点：单纯以“词频”衡量一个词的重要性不够全面，有时重要的词可能出现的次数并不多，而且这种算法<strong>无法体现词的位置信息</strong>，出现位置靠前的词与出现位置靠后的词，都被视为重要性相同，这是不正确的（一种解决方法是，对全文的第一段和每一段的第一句话给予较大的权重）。</p> 
<h5><a id="924R_60"></a>9.2.4R语言实例代码</h5> 
<p>中文常用的是“jiebaR”程序包。</p> 
<h6><a id="1_62"></a>1.分词</h6> 
<p>worker()<br> type："mix"混合模型、"mp"最大概率模型、"hmm"HMM模型、"query"索引模型<br> dict：DICTPATH系统词典<br> hmm：HMMPATH，HMM模型路径<br> user：USERPATH用户词典<br> idf：IDFPATH ，idf词典<br> stop_word：STOPPATH停用词词典<br> write：T，是否将文件分词结果写入文件，默认为FALSE<br> qmax：20，最大成词的字符数，默认为20个字符<br> topn：5，关键词数，默认为5个<br> encoding：“UTF-8”，输入文件的编码，默认为UTF-8<br> detect：T，是否编码检查,默认为 TRUE<br> symbol：F，是否保留符号，默认为FALSE<br> lines：1e+05，每次读取文件为最大行数<br> output：NULL，输出路径<br> bylines：F，按行输出<br> user_weight：“max”，用户权重</p> 
<pre><code class="prism language-r"><span class="token comment">#加载包</span>
install.packages<span class="token punctuation">(</span><span class="token string">"jiebaR"</span><span class="token punctuation">)</span>
library<span class="token punctuation">(</span><span class="token string">"jiebaR"</span><span class="token punctuation">)</span>

<span class="token comment">#加载分词环境</span>
wk<span class="token operator">&lt;-</span>worker<span class="token punctuation">(</span><span class="token punctuation">)</span>
wk<span class="token punctuation">[</span><span class="token string">'爸妈第一次出国，很放心，他们告诉我会很开心，我就心满意足了'</span><span class="token punctuation">]</span>
wk   <span class="token comment">#查看分词引擎配置</span>
</code></pre> 
<h6><a id="2_90"></a>2.配置词典</h6> 
<pre><code class="prism language-r">show_dictpath<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#查看默认词典位置</span>
dir<span class="token punctuation">(</span>show_dictpath<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#查看目录</span>

<span class="token comment">#打开系统词典文件jieba.dict.utf8，并打印前10行</span>
scan<span class="token punctuation">(</span>file<span class="token operator">=</span><span class="token string">"C:/Program Files/R/R3.2.5/library/jiebaRD/dict/jieba.dict.utf8"</span><span class="token punctuation">,</span>what<span class="token operator">=</span>character<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nlines<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>fileEncoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>


<span class="token comment">#打开用户自定义词典文件user.dict.utf8，并打印前10行</span>
scan<span class="token punctuation">(</span>file<span class="token operator">=</span><span class="token string">"C:/Program Files/R/R3.2.5/library/jiebaRD/dict/user.dict.utf8"</span><span class="token punctuation">,</span>what<span class="token operator">=</span>character<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nlines<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>fileEncoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="3_102"></a>3.增加自定义词典</h6> 
<p>需要针对添加某些特定的词，即用户自定义词典。（自定义词典在TXT文件中，需要UTF-8编码，词典中第一行读不进去，需要从第二行开始读）</p> 
<pre><code class="prism language-r"><span class="token comment">#增加自定义词典</span>
wk<span class="token punctuation">[</span><span class="token string">"我喜欢量子号的邮轮"</span><span class="token punctuation">]</span>

<span class="token comment">#设定空间默认路径</span>
setwd<span class="token punctuation">(</span><span class="token string">"C:\\Users\\用户路径"</span><span class="token punctuation">)</span>
<span class="token comment">#用户自定义词典名称</span>
userdic<span class="token operator">&lt;-</span><span class="token string">'trip_dic.txt'</span>
<span class="token comment">#加载分词引擎，导入自定义词典</span>
wk <span class="token operator">=</span> worker<span class="token punctuation">(</span>user<span class="token operator">=</span>userdic<span class="token punctuation">,</span>bylines<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>lines<span class="token operator">=</span><span class="token number">5000000</span><span class="token punctuation">)</span>
<span class="token comment">#分词</span>
wk<span class="token punctuation">[</span><span class="token string">"我喜欢量子号的邮轮"</span><span class="token punctuation">]</span>
</code></pre> 
<h6><a id="4_117"></a>4.增加停用词词典</h6> 
<p>进一步对文本数据进行处理</p> 
<pre><code class="prism language-r"><span class="token comment">#用户自定义词典和停用词词典名称</span>
userdic<span class="token operator">&lt;-</span><span class="token string">'trip_dic.txt'</span>
stopword<span class="token operator">&lt;-</span><span class="token string">'stopword_adj.txt'</span>
wk <span class="token operator">=</span> worker<span class="token punctuation">(</span>user<span class="token operator">=</span>userdic<span class="token punctuation">,</span>stop_word<span class="token operator">=</span>stopword<span class="token punctuation">,</span>bylines<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>lines<span class="token operator">=</span><span class="token number">5000000</span><span class="token punctuation">)</span>   <span class="token comment">#加载分词引擎，导入自定义词典</span>
wk<span class="token punctuation">[</span><span class="token string">"我喜欢量子号的邮轮"</span><span class="token punctuation">]</span>
</code></pre> 
<h6><a id="5TFIDF_126"></a>5.关键词提取TF-IDF</h6> 
<pre><code class="prism language-r"><span class="token comment">#jiebaR</span>
 userdic<span class="token operator">&lt;-</span><span class="token string">'trip_dic.txt'</span>     <span class="token comment">#用户自定义词典名称</span>
 stopword<span class="token operator">&lt;-</span><span class="token string">'stopword_adj.txt'</span>  
 wk <span class="token operator">&lt;-</span> worker<span class="token punctuation">(</span>user<span class="token operator">=</span>userdic<span class="token punctuation">,</span>stop_word<span class="token operator">=</span>stopword<span class="token punctuation">,</span>lines<span class="token operator">=</span><span class="token number">5000000</span><span class="token punctuation">)</span>   <span class="token comment">#加载分词引擎，导入自定义词典</span>
 segment<span class="token operator">&lt;-</span>wk<span class="token punctuation">[</span><span class="token string">"R的极客理想系列文章，涵盖了R的思想，使用，工具，创新等的一系列要点，以我个人的学习和体验去诠释R的强大。"</span><span class="token punctuation">]</span>    <span class="token comment">#分词</span>
 segment
  freq<span class="token punctuation">(</span>segment<span class="token punctuation">)</span>    <span class="token comment">#计算词频</span>
keys<span class="token operator">&lt;-</span>worker<span class="token punctuation">(</span><span class="token string">"keywords"</span><span class="token punctuation">,</span>topn<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>   <span class="token comment">#设置关键词数量</span>
vector_keywords<span class="token punctuation">(</span>segment<span class="token punctuation">,</span>keys<span class="token punctuation">)</span>     <span class="token comment">#计算关键词分值</span>
</code></pre> 
<p>TF-IDF的计算</p> 
<h6><a id="6_139"></a>6.词性标注</h6> 
<p>SO-PMI算法的第一步是找出相应词性的词汇，可以在work函数中设置tag来输出词性。</p> 
<pre><code class="prism language-r"><span class="token comment">#用户自定义词典名称</span>
 userdic<span class="token operator">&lt;-</span><span class="token string">'trip_dic.txt'</span>
 stopword<span class="token operator">&lt;-</span><span class="token string">'stopword_adj.txt'</span>
 wk <span class="token operator">=</span> worker<span class="token punctuation">(</span>user<span class="token operator">=</span>userdic<span class="token punctuation">,</span>stop_word<span class="token operator">=</span>stopword<span class="token punctuation">,</span><span class="token string">"tag"</span><span class="token punctuation">,</span>lines<span class="token operator">=</span><span class="token number">5000000</span><span class="token punctuation">)</span>    <span class="token comment">#加载分词引擎，导入自定义词典</span>
 segment<span class="token operator">&lt;-</span>wk<span class="token punctuation">[</span><span class="token string">"爸妈第一次出国，很放心，他们告诉我会很开心，我就心满意足了"</span><span class="token punctuation">]</span>   <span class="token comment">#分词</span>
segment
</code></pre> 
<h4><a id="93_149"></a>9.3项目实践</h4> 
<h5><a id="931_150"></a>9.3.1若干自定义函数</h5> 
<h6><a id="1_151"></a>1.数据清理</h6> 
<p>“脏数据”指类似于url、空格、换行符、时间、英文字母、空值、字符长度过小等。</p> 
<pre><code class="prism language-r"><span class="token comment">######################################################################</span>
<span class="token comment">#函数功能：清理文本数据</span>
<span class="token comment">#参数说明text：文本向量</span>
dataclean<span class="token operator">&lt;-</span><span class="token keyword">function</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     text<span class="token operator">&lt;-</span>  gsub<span class="token punctuation">(</span>pattern<span class="token operator">=</span><span class="token string">"http:[a-zA-Z\\/\\.0-9]+"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span>   <span class="token comment">#去除url</span>
     text <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">,</span> replacement <span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>   <span class="token comment">#gsub是字符替换函数，去空格</span>
     text <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"\t|\r|\v|\f|\n|\\\t"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>        <span class="token comment">#有时需要使用\\\t    </span>
     text<span class="token operator">&lt;-</span>  gsub<span class="token punctuation">(</span>pattern<span class="token operator">=</span><span class="token string">"([0-9]{4}年)?([0-9]*月)?[0-9]{1,}日"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span>
     text<span class="token operator">&lt;-</span>  gsub<span class="token punctuation">(</span>pattern<span class="token operator">=</span><span class="token string">"([0-9]{4}年)"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span>
     text<span class="token operator">&lt;-</span>  gsub<span class="token punctuation">(</span>pattern<span class="token operator">=</span><span class="token string">"([0-9]{1,}月)"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span>
     text<span class="token operator">&lt;-</span>  gsub<span class="token punctuation">(</span>pattern<span class="token operator">=</span><span class="token string">"[0-9]{1,}"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span>
     text <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"[a-zA-Z]"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>   <span class="token comment">#清除英文字符</span>
     text <span class="token operator">&lt;-</span> text<span class="token punctuation">[</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">]</span>       <span class="token comment">#清除对应sentence里面的空值（文本内容），要先执行文本名  </span>
     text <span class="token operator">&lt;-</span> text<span class="token punctuation">[</span><span class="token operator">!</span>nchar<span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">]</span>       <span class="token comment">#文本长度过小</span>
     return<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">##### 2.分句并打上相应标号</span>

<span class="token comment">######################################################################</span>
<span class="token comment">#函数功能：分片段并打上标识</span>
<span class="token comment">#参数说明：text：文本向量</span>
splitsentence<span class="token operator">&lt;-</span><span class="token keyword">function</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   commentdata<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>id<span class="token operator">=</span>seq<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>length<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>term<span class="token operator">=</span>text<span class="token punctuation">)</span>
   commentdata<span class="token operator">$</span>term<span class="token operator">&lt;-</span>as.character<span class="token punctuation">(</span>commentdata<span class="token operator">$</span>term<span class="token punctuation">)</span>
   <span class="token comment">#以标点符号作为分隔符把句子分成片段</span>
   subcon<span class="token operator">&lt;-</span>strsplit<span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token string">",|\\.|!|\\?|;|~|，|。|！|\\？|；|～|…|﹏﹏|。。。。。。|\\.\\.\\.\\.\\.\\."</span><span class="token punctuation">)</span>
   temp<span class="token operator">&lt;-</span>unlist<span class="token punctuation">(</span>lapply<span class="token punctuation">(</span>subcon<span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#计算每条评论片段数</span>
   id<span class="token operator">&lt;-</span>rep<span class="token punctuation">(</span>commentdata<span class="token operator">$</span>id<span class="token punctuation">,</span>temp<span class="token punctuation">)</span>    <span class="token comment">#生成每条评论标号，标号数量和片段数相同</span>
   term<span class="token operator">&lt;-</span>unlist<span class="token punctuation">(</span>subcon<span class="token punctuation">)</span>       <span class="token comment">#把片段结果对象变成向量</span>

   <span class="token comment">#打上分句id</span>
   groupid<span class="token operator">&lt;-</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     subid<span class="token operator">&lt;-</span>seq<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>x<span class="token punctuation">)</span>
     return<span class="token punctuation">(</span>subid<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">#生成片段标识</span>
   subid<span class="token operator">&lt;-</span>paste<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">"-"</span><span class="token punctuation">,</span>unlist<span class="token punctuation">(</span>lapply<span class="token punctuation">(</span>temp<span class="token punctuation">,</span>groupid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>seq<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
   subcondata<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>id<span class="token operator">=</span>id<span class="token punctuation">,</span>term<span class="token operator">=</span>term<span class="token punctuation">,</span>subid<span class="token operator">=</span>subid<span class="token punctuation">)</span>
   subcondata<span class="token operator">$</span>term<span class="token operator">&lt;-</span>as.character<span class="token punctuation">(</span>subcondata<span class="token operator">$</span>term<span class="token punctuation">)</span>
   subcondata<span class="token operator">$</span>subid<span class="token operator">&lt;-</span>as.character<span class="token punctuation">(</span>subcondata<span class="token operator">$</span>subid<span class="token punctuation">)</span>
   return<span class="token punctuation">(</span>subcondata<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>根据标点符号分段，为每个片段打上标签用于识别是否属于一条评论。</p> 
<h6><a id="3_198"></a>3.分词</h6> 
<pre><code class="prism language-r"><span class="token comment">######################################################################</span>
<span class="token comment">#函数功能：分词</span>
<span class="token comment">#参数说明：useridc：用户自定义词典文件名、stopword：停用词词典文件名、subdf：数据框，需要分词的数据，每一行为一条文本片段</span>
library<span class="token punctuation">(</span><span class="token string">"jiebaR"</span><span class="token punctuation">)</span>
  segword_trn<span class="token operator">&lt;-</span><span class="token keyword">function</span><span class="token punctuation">(</span>userdic<span class="token punctuation">,</span>stopword<span class="token punctuation">,</span>subdf<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  wk <span class="token operator">=</span> worker<span class="token punctuation">(</span>user<span class="token operator">=</span>userdic<span class="token punctuation">,</span>stop_word<span class="token operator">=</span>stopword<span class="token punctuation">,</span><span class="token string">'tag'</span><span class="token punctuation">,</span>bylines<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>lines<span class="token operator">=</span><span class="token number">5000000</span><span class="token punctuation">)</span>     <span class="token comment">#载入分词空间</span>
  tt<span class="token operator">&lt;-</span>wk<span class="token punctuation">[</span>subdf<span class="token operator">$</span>term<span class="token punctuation">]</span>     <span class="token comment">#分词函数</span>
  temp_fc<span class="token operator">&lt;-</span>unlist<span class="token punctuation">(</span>lapply<span class="token punctuation">(</span>tt<span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">#给每个分词标号</span>
  id_fc<span class="token operator">&lt;-</span>rep<span class="token punctuation">(</span>subdf<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token string">"subid"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>temp_fc<span class="token punctuation">)</span>
  term_fc<span class="token operator">&lt;-</span>unlist<span class="token punctuation">(</span>tt<span class="token punctuation">)</span>
  segterm_fc<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>id<span class="token operator">=</span>id_fc<span class="token punctuation">,</span>term<span class="token operator">=</span>term_fc<span class="token punctuation">,</span>cx<span class="token operator">=</span>names<span class="token punctuation">(</span>unlist<span class="token punctuation">(</span>tt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  segterm_fc<span class="token operator">$</span>id<span class="token operator">&lt;-</span>as.character<span class="token punctuation">(</span>segterm_fc<span class="token operator">$</span>id<span class="token punctuation">)</span>
  segterm_fc<span class="token operator">$</span>term<span class="token operator">&lt;-</span>as.character<span class="token punctuation">(</span>segterm_fc<span class="token operator">$</span>term<span class="token punctuation">)</span>
  segterm_fc<span class="token operator">$</span>cx<span class="token operator">&lt;-</span>as.character<span class="token punctuation">(</span>segterm_fc<span class="token operator">$</span>cx<span class="token punctuation">)</span>
  segterm_fc<span class="token operator">$</span>id_tot<span class="token operator">&lt;-</span>as.numeric<span class="token punctuation">(</span>unlist<span class="token punctuation">(</span>lapply<span class="token punctuation">(</span>strsplit<span class="token punctuation">(</span>segterm_fc<span class="token operator">$</span>id<span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  return<span class="token punctuation">(</span>segterm_fc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>载入jiebaR包》载入分词空间及自定义词典和停用词词典》wk函数分词》打标号辨识是否为同一评论。</p> 
<h5><a id="932_219"></a>9.3.2文本质量量化指标模型</h5> 
<pre><code class="prism language-r">library<span class="token punctuation">(</span><span class="token string">"jiebaR"</span><span class="token punctuation">)</span>
library<span class="token punctuation">(</span>plyr<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>dplyr<span class="token punctuation">)</span>

userdic<span class="token operator">&lt;-</span><span class="token string">'trip_dic.txt'</span>        <span class="token comment">#用户字典</span>
stopword<span class="token operator">&lt;-</span><span class="token string">'stopword_adj.txt'</span>   <span class="token comment">#停止词</span>
qualitydic<span class="token operator">&lt;-</span><span class="token string">'质量标准.csv'</span>     <span class="token comment">#质量标准</span>
qualityword<span class="token operator">&lt;-</span>read.csv<span class="token punctuation">(</span>qualitydic<span class="token punctuation">,</span>header<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>stringsAsFactors<span class="token operator">=</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span>    <span class="token comment">#导入质量指标相关词词典</span>
content<span class="token operator">&lt;-</span>read.csv<span class="token punctuation">(</span><span class="token string">"评论数据.csv"</span><span class="token punctuation">,</span>header<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>stringsAsFactors<span class="token operator">=</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span>    <span class="token comment">#导入文本</span>
commenttext<span class="token operator">&lt;-</span>content<span class="token operator">$</span>term
commenttext<span class="token operator">&lt;-</span>dataclean<span class="token punctuation">(</span>commenttext<span class="token punctuation">)</span>   <span class="token comment">#数据清理</span>
subcondata<span class="token operator">&lt;-</span>splitsentence<span class="token punctuation">(</span>commenttext<span class="token punctuation">)</span>   <span class="token comment">#分句并转换成数据框并且表上subid</span>
segworddata<span class="token operator">&lt;-</span>segword_trn<span class="token punctuation">(</span>userdic<span class="token punctuation">,</span>stopword<span class="token punctuation">,</span>subcondata<span class="token punctuation">)</span>   <span class="token comment">#分词</span>




<span class="token comment">#文本质量评分</span>
<span class="token comment">#1、主题覆盖量</span>
qualitterm<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>segworddata<span class="token punctuation">,</span>qualityword<span class="token punctuation">)</span>
qualitynum<span class="token operator">&lt;-</span>as.data.frame<span class="token punctuation">(</span>qualitterm <span class="token percent-operator operator">%&gt;%</span> group_by<span class="token punctuation">(</span>id_tot<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> summarise<span class="token punctuation">(</span>n_distinct<span class="token punctuation">(</span>class<span class="token punctuation">,</span>na.rm<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
names<span class="token punctuation">(</span>qualitynum<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token string">"quality_num"</span>
qualitynum<span class="token operator">$</span>qualitynum_flag<span class="token operator">&lt;-</span>qualitynum<span class="token operator">$</span>quality_num
attach<span class="token punctuation">(</span>qualitynum<span class="token punctuation">)</span>
qualitynum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>quality_num <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>qualitynum_flag<span class="token operator">&lt;-</span><span class="token number">0.2</span>
qualitynum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>quality_num <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>qualitynum_flag<span class="token operator">&lt;-</span><span class="token number">0.4</span>
qualitynum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>quality_num <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>qualitynum_flag<span class="token operator">&lt;-</span><span class="token number">0.6</span>
qualitynum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>quality_num <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>qualitynum_flag<span class="token operator">&lt;-</span><span class="token number">0.8</span>
qualitynum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>quality_num <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>qualitynum_flag<span class="token operator">&lt;-</span><span class="token number">1</span>
detach<span class="token punctuation">(</span>qualitynum<span class="token punctuation">)</span>


<span class="token comment">#2 文本分词数量</span>
segwordnum<span class="token operator">&lt;-</span>as.data.frame<span class="token punctuation">(</span>segworddata <span class="token percent-operator operator">%&gt;%</span> group_by<span class="token punctuation">(</span>id_tot<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> summarise<span class="token punctuation">(</span>n_distinct<span class="token punctuation">(</span>term<span class="token punctuation">,</span>na.rm<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
names<span class="token punctuation">(</span>segwordnum<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token string">"segword_num"</span>

segword_num<span class="token operator">&lt;-</span>segwordnum<span class="token operator">$</span>segword_num
segword_num_q2<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>segword_num<span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span>
segword_num_q4<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>segword_num<span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">)</span>
segword_num_q6<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>segword_num<span class="token punctuation">,</span><span class="token number">0.6</span><span class="token punctuation">)</span>
segword_num_q8<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>segword_num<span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">)</span>
segword_num_q10<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>segword_num<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>

segwordnum<span class="token operator">$</span>segwordnum_flag<span class="token operator">&lt;-</span>segwordnum<span class="token operator">$</span>segword_num

attach<span class="token punctuation">(</span>segwordnum<span class="token punctuation">)</span>
segwordnum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>segword_num <span class="token operator">&gt;=</span><span class="token number">0</span> <span class="token operator">&amp;</span> segword_num <span class="token operator">&lt;=</span>segword_num_q2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>segwordnum_flag<span class="token operator">&lt;-</span><span class="token number">0.2</span>
segwordnum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>segword_num <span class="token operator">&gt;</span> segword_num_q2 <span class="token operator">&amp;</span> segword_num <span class="token operator">&lt;=</span> segword_num_q4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>segwordnum_flag<span class="token operator">&lt;-</span><span class="token number">0.4</span>
segwordnum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>segword_num <span class="token operator">&gt;</span> segword_num_q4 <span class="token operator">&amp;</span> segword_num <span class="token operator">&lt;=</span> segword_num_q6<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>segwordnum_flag<span class="token operator">&lt;-</span><span class="token number">0.6</span>
segwordnum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>segword_num <span class="token operator">&gt;</span> segword_num_q6 <span class="token operator">&amp;</span> segword_num <span class="token operator">&lt;=</span> segword_num_q8<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>segwordnum_flag<span class="token operator">&lt;-</span><span class="token number">0.8</span>
segwordnum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>segword_num <span class="token operator">&gt;</span> segword_num_q8 <span class="token operator">&amp;</span> segword_num <span class="token operator">&lt;=</span> segword_num_q10<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>segwordnum_flag<span class="token operator">&lt;-</span><span class="token number">1</span>
detach<span class="token punctuation">(</span>segwordnum<span class="token punctuation">)</span>



<span class="token comment">#3 评论点赞数</span>
positive_num<span class="token operator">&lt;-</span>content<span class="token operator">$</span>positivenum
positive_num_q2<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>positive_num<span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
positive_num_q4<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>positive_num<span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
positive_num_q6<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>positive_num<span class="token punctuation">,</span><span class="token number">0.6</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
positive_num_q8<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>positive_num<span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
positive_num_q10<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>positive_num<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>

positivenum<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>id_tot<span class="token operator">=</span>content<span class="token operator">$</span>id<span class="token punctuation">,</span>positive_num<span class="token operator">=</span>content<span class="token operator">$</span>positivenum<span class="token punctuation">,</span>positivenum_flag<span class="token operator">=</span>positive_num<span class="token punctuation">)</span>

attach<span class="token punctuation">(</span>positivenum<span class="token punctuation">)</span>
positivenum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>positive_num <span class="token operator">&gt;=</span><span class="token number">0</span> <span class="token operator">&amp;</span> positive_num <span class="token operator">&lt;=</span>positive_num_q2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>positivenum_flag<span class="token operator">&lt;-</span><span class="token number">0.2</span>
positivenum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>positive_num <span class="token operator">&gt;</span> positive_num_q2 <span class="token operator">&amp;</span> positive_num <span class="token operator">&lt;=</span> positive_num_q4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>positivenum_flag<span class="token operator">&lt;-</span><span class="token number">0.4</span>
positivenum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>positive_num <span class="token operator">&gt;</span> positive_num_q4 <span class="token operator">&amp;</span> positive_num <span class="token operator">&lt;=</span> positive_num_q6<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>positivenum_flag<span class="token operator">&lt;-</span><span class="token number">0.6</span>
positivenum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>positive_num <span class="token operator">&gt;</span> positive_num_q6 <span class="token operator">&amp;</span> positive_num <span class="token operator">&lt;=</span> positive_num_q8<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>positivenum_flag<span class="token operator">&lt;-</span><span class="token number">0.8</span>
positivenum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>positive_num <span class="token operator">&gt;</span> positive_num_q8 <span class="token operator">&amp;</span> positive_num <span class="token operator">&lt;=</span> positive_num_q10<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>positivenum_flag<span class="token operator">&lt;-</span><span class="token number">1</span>
detach<span class="token punctuation">(</span>positivenum<span class="token punctuation">)</span>


<span class="token comment">#4 评论中照片数量</span>
photonum<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>id_tot<span class="token operator">=</span>content<span class="token operator">$</span>id<span class="token punctuation">,</span>isphoto<span class="token operator">=</span>content<span class="token operator">$</span>isphoto<span class="token punctuation">,</span>photo_flag<span class="token operator">=</span>content<span class="token operator">$</span>isphoto<span class="token punctuation">)</span>

attach<span class="token punctuation">(</span>photonum<span class="token punctuation">)</span>
photonum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>isphoto <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>photo_flag<span class="token operator">&lt;-</span><span class="token number">0</span>
photonum<span class="token punctuation">[</span>which<span class="token punctuation">(</span>isphoto <span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>photo_flag<span class="token operator">&lt;-</span><span class="token number">1</span>
detach<span class="token punctuation">(</span>photonum<span class="token punctuation">)</span>


<span class="token comment">#5评论分值偏移</span>
score_num<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>id_tot<span class="token operator">=</span>content<span class="token operator">$</span>id<span class="token punctuation">,</span>score<span class="token operator">=</span>content<span class="token operator">$</span>score<span class="token punctuation">,</span>score_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
score<span class="token operator">&lt;-</span>content<span class="token operator">$</span>score
median_score<span class="token operator">&lt;-</span>median<span class="token punctuation">(</span>score<span class="token punctuation">)</span>
diffscore<span class="token operator">&lt;-</span>abs<span class="token punctuation">(</span>score<span class="token operator">-</span>median_score<span class="token punctuation">)</span>

diffscore_q2<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>diffscore<span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
diffscore_q4<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>diffscore<span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
diffscore_q6<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>diffscore<span class="token punctuation">,</span><span class="token number">0.6</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
diffscore_q8<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>diffscore<span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
diffscore_q10<span class="token operator">&lt;-</span>quantile<span class="token punctuation">(</span>diffscore<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.001</span>
<span class="token comment">###+0.001是为了避免集合空集的情况</span>
attach<span class="token punctuation">(</span>score_num<span class="token punctuation">)</span>
score_num<span class="token punctuation">[</span>which<span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">-</span>diffscore_q2 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">+</span>diffscore_q2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>score_flag<span class="token operator">&lt;-</span><span class="token number">1</span>
score_num<span class="token punctuation">[</span>which<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">-</span>diffscore_q4 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">-</span>diffscore_q2<span class="token punctuation">)</span>
                <span class="token operator">|</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">+</span>diffscore_q2 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">+</span>diffscore_q4<span class="token punctuation">)</span>
               <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>score_flag<span class="token operator">&lt;-</span><span class="token number">0.8</span>
score_num<span class="token punctuation">[</span>which<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">-</span>diffscore_q6 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">-</span>diffscore_q4<span class="token punctuation">)</span>
                <span class="token operator">|</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">+</span>diffscore_q4 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">+</span>diffscore_q6<span class="token punctuation">)</span>
               <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>score_flag<span class="token operator">&lt;-</span><span class="token number">0.6</span>
score_num<span class="token punctuation">[</span>which<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">-</span>diffscore_q8 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">-</span>diffscore_q6<span class="token punctuation">)</span>
                <span class="token operator">|</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">+</span>diffscore_q6 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">+</span>diffscore_q8<span class="token punctuation">)</span>
               <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>score_flag<span class="token operator">&lt;-</span><span class="token number">0.4</span>
score_num<span class="token punctuation">[</span>which<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">-</span>diffscore_q10 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">-</span>diffscore_q8<span class="token punctuation">)</span>
                <span class="token operator">|</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span>median_score<span class="token operator">+</span>diffscore_q8 <span class="token operator">&amp;</span> score<span class="token operator">&lt;=</span>median_score<span class="token operator">+</span>diffscore_q10<span class="token punctuation">)</span>
               <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token operator">$</span>score_flag<span class="token operator">&lt;-</span><span class="token number">0.2</span>
detach<span class="token punctuation">(</span>score_num<span class="token punctuation">)</span>



<span class="token comment">#6 整合评论分</span>
qualityscore<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>qualitynum<span class="token punctuation">,</span>segwordnum<span class="token punctuation">)</span>
qualityscore<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>qualityscore<span class="token punctuation">,</span>positivenum<span class="token punctuation">)</span>
qualityscore<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>qualityscore<span class="token punctuation">,</span>photonum<span class="token punctuation">)</span>
qualityscore<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>qualityscore<span class="token punctuation">,</span>score_num<span class="token punctuation">)</span>
qualityscore<span class="token operator">&lt;-</span>qualityscore<span class="token punctuation">[</span><span class="token punctuation">,</span>c<span class="token punctuation">(</span><span class="token string">"id_tot"</span><span class="token punctuation">,</span><span class="token string">"qualitynum_flag"</span><span class="token punctuation">,</span><span class="token string">"segwordnum_flag"</span><span class="token punctuation">,</span><span class="token string">"positivenum_flag"</span><span class="token punctuation">,</span><span class="token string">"photo_flag"</span><span class="token punctuation">,</span><span class="token string">"score_flag"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

attach<span class="token punctuation">(</span>qualityscore<span class="token punctuation">)</span>
qualityscore<span class="token operator">$</span>score_tot<span class="token operator">&lt;-</span>qualitynum_flag<span class="token operator">*</span><span class="token number">0.3</span><span class="token operator">+</span>segwordnum_flag<span class="token operator">*</span><span class="token number">0.2</span><span class="token operator">+</span>positivenum_flag<span class="token operator">*</span><span class="token number">0.2</span><span class="token operator">+</span>photo_flag<span class="token operator">*</span><span class="token number">0.2</span><span class="token operator">+</span>score_flag<span class="token operator">*</span><span class="token number">0.1</span>
detach<span class="token punctuation">(</span>qualityscore<span class="token punctuation">)</span>

qualityscore<span class="token punctuation">[</span>order<span class="token punctuation">(</span>qualityscore<span class="token operator">$</span>score_tot<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span>
</code></pre> 
<p>可以具体查看一下得分较高的评论原文。</p> 
<h5><a id="933_348"></a>9.3.3用户相似度模型</h5> 
<p><img src="https://images2.imgbox.com/95/41/5vzsYupU_o.png" alt="选标签"></p> 
<pre><code class="prism language-r">uiddesc<span class="token operator">&lt;-</span>read.csv<span class="token punctuation">(</span><span class="token string">"用户数据.csv"</span><span class="token punctuation">,</span>header<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>stringsAsFactors<span class="token operator">=</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span>   <span class="token comment">#导入用户特征数据</span>

<span class="token comment">#计算欧式距离</span>
eu_dist<span class="token operator">&lt;-</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  dist<span class="token operator">&lt;-</span>sqrt<span class="token punctuation">(</span>sum<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  return <span class="token punctuation">(</span>dist<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
sample_uid<span class="token operator">&lt;-</span>c<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment">#新用户</span>
simindex_chain<span class="token operator">&lt;-</span>c<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#建立相似度初始向量</span>
<span class="token comment">#计算新用户与每个评论用户相似度</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>uiddesc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    eudist<span class="token operator">&lt;-</span>eu_dist<span class="token punctuation">(</span>sample_uid<span class="token punctuation">,</span>unlist<span class="token punctuation">(</span>uiddesc<span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">###欧式距离</span>
    simindex<span class="token operator">&lt;-</span><span class="token number">1</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>eudist<span class="token punctuation">)</span>
    simindex_chain<span class="token operator">&lt;-</span>c<span class="token punctuation">(</span>simindex_chain<span class="token punctuation">,</span>simindex<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">#相似度结果</span>
simiindex_df<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>id<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>uiddesc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>simindex<span class="token operator">=</span>simindex_chain<span class="token punctuation">)</span>
simiindex_df<span class="token punctuation">[</span>order<span class="token punctuation">(</span><span class="token operator">-</span>simiindex_df<span class="token operator">$</span>simindex<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span>
</code></pre> 
<p>根据得分，用户将会优先看到排名在前面的用户的评论。</p> 
<h5><a id="934_372"></a>9.3.4情感词分析</h5> 
<h6><a id="1_373"></a>1.导入评论数据并清洗分词</h6> 
<pre><code class="prism language-r">library<span class="token punctuation">(</span><span class="token string">"jiebaR"</span><span class="token punctuation">)</span>
library<span class="token punctuation">(</span>plyr<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>dplyr<span class="token punctuation">)</span>
userdic<span class="token operator">&lt;-</span><span class="token string">'trip_dic.txt'</span>        <span class="token comment">#用户字典</span>
stopword<span class="token operator">&lt;-</span><span class="token string">'stopword_adj.txt'</span>   <span class="token comment">#停止词</span>
postivedic<span class="token operator">&lt;-</span><span class="token string">"postive.txt"</span>      <span class="token comment">#正向情感词</span>
negtivedic<span class="token operator">&lt;-</span><span class="token string">"nagative.txt"</span>     <span class="token comment">#负向情感词</span>
advworddic<span class="token operator">&lt;-</span><span class="token string">"程度副词.csv"</span>     <span class="token comment">#程度副词字典</span>
denyworddic<span class="token operator">&lt;-</span><span class="token string">"否定词.csv"</span>      <span class="token comment">#否定词字典</span>

<span class="token comment">#导入情感词并附上权重</span>
postive<span class="token operator">=</span>readLines<span class="token punctuation">(</span>postivedic<span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
nagtive<span class="token operator">=</span>readLines<span class="token punctuation">(</span>negtivedic<span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
pos<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>term<span class="token operator">=</span>postive<span class="token punctuation">,</span>weight<span class="token operator">=</span>rep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>length<span class="token punctuation">(</span>postive<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
neg<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>term<span class="token operator">=</span>nagtive<span class="token punctuation">,</span>weight<span class="token operator">=</span>rep<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>length<span class="token punctuation">(</span>nagtive<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
posneg_tot<span class="token operator">&lt;-</span>rbind<span class="token punctuation">(</span>pos<span class="token punctuation">,</span>neg<span class="token punctuation">)</span>

advword<span class="token operator">&lt;-</span>read.csv<span class="token punctuation">(</span>advworddic<span class="token punctuation">,</span>header<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>stringsAsFactors<span class="token operator">=</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span>   <span class="token comment">#导入程度副词、否定词</span>
denyword<span class="token operator">&lt;-</span>read.csv<span class="token punctuation">(</span>denyworddic<span class="token punctuation">,</span>header<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>stringsAsFactors<span class="token operator">=</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span>

content<span class="token operator">&lt;-</span>read.csv<span class="token punctuation">(</span><span class="token string">"评论数据.csv"</span><span class="token punctuation">,</span>header<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span>stringsAsFactors<span class="token operator">=</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span>  <span class="token comment">#导入文本</span>
commenttext<span class="token operator">&lt;-</span>content<span class="token operator">$</span>term

commenttext<span class="token operator">&lt;-</span>dataclean<span class="token punctuation">(</span>commenttext<span class="token punctuation">)</span>   <span class="token comment">#数据清理</span>
subcondata<span class="token operator">&lt;-</span>splitsentence<span class="token punctuation">(</span>commenttext<span class="token punctuation">)</span>  <span class="token comment">#分句并转换成数据框并且表上subid</span>
segworddata<span class="token operator">&lt;-</span>segword_trn<span class="token punctuation">(</span>userdic<span class="token punctuation">,</span>stopword<span class="token punctuation">,</span>subcondata<span class="token punctuation">)</span>   <span class="token comment">#分词</span>
</code></pre> 
<h6><a id="2_402"></a>2.关联情感词、否定词和程度副词</h6> 
<pre><code class="prism language-r"><span class="token comment">#关联情感词、程度副词和否定词</span>
tstterm<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>segworddata<span class="token punctuation">,</span>posneg_tot<span class="token punctuation">)</span>
tstterm<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>tstterm<span class="token punctuation">,</span>advword<span class="token punctuation">)</span>
names<span class="token punctuation">(</span>tstterm<span class="token punctuation">)</span><span class="token punctuation">[</span>length<span class="token punctuation">(</span>names<span class="token punctuation">(</span>tstterm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token string">"adv_score"</span>    
tstterm<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>tstterm<span class="token punctuation">,</span>denyword<span class="token punctuation">,</span>by<span class="token operator">=</span><span class="token string">'term'</span><span class="token punctuation">)</span>
names<span class="token punctuation">(</span>tstterm<span class="token punctuation">)</span><span class="token punctuation">[</span>length<span class="token punctuation">(</span>names<span class="token punctuation">(</span>tstterm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token string">"deny_score"</span>
tstterm<span class="token operator">$</span>adv_score<span class="token punctuation">[</span><span class="token operator">!</span>complete.cases<span class="token punctuation">(</span>tstterm<span class="token operator">$</span>adv_score<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token operator">-</span><span class="token number">999</span>
tstterm<span class="token operator">$</span>deny_score<span class="token punctuation">[</span><span class="token operator">!</span>complete.cases<span class="token punctuation">(</span>tstterm<span class="token operator">$</span>deny_score<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token operator">-</span><span class="token number">999</span>
tstterm<span class="token operator">$</span>id_tot<span class="token operator">&lt;-</span>as.numeric<span class="token punctuation">(</span>gsub<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>tstterm<span class="token operator">$</span>id_tot<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="3_414"></a>3.对片段进行窗口期判定及综合打分</h6> 
<pre><code class="prism language-r"><span class="token comment">#####################################################################</span>
<span class="token comment">#函数功能：对片段进行情感性打分</span>
<span class="token comment">#参数说明：idname：片段标号、fliename：带有否定词、副词和正负情感词的文本</span>
word_segment <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>idname<span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
    <span class="token comment">#-- 打行号</span>
    <span class="token comment">#抽取片段</span>
    filepart <span class="token operator">=</span> subset<span class="token punctuation">(</span>filename<span class="token punctuation">,</span>id<span class="token operator">==</span>idname<span class="token punctuation">)</span>
    <span class="token comment">#对片段中每个分词打上id</span>
    wordfile <span class="token operator">=</span> data.frame<span class="token punctuation">(</span>
       filepart
      <span class="token punctuation">,</span>idx<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>filepart<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    wordindex <span class="token operator">=</span> wordfile<span class="token operator">$</span>idx<span class="token punctuation">[</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>wordfile<span class="token operator">$</span>weight<span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token comment">#找出正负情感词在片段中的位置</span>
        <span class="token comment">#-- 上下限表</span>
    citeration <span class="token operator">=</span> data.frame<span class="token punctuation">(</span>
                            wordindex
                           <span class="token punctuation">,</span>left  <span class="token operator">=</span> wordindex<span class="token operator">-</span><span class="token number">3</span>
                           <span class="token punctuation">,</span>right <span class="token operator">=</span> wordindex<span class="token operator">+</span><span class="token number">3</span>
                           <span class="token punctuation">,</span>leftidx <span class="token operator">=</span> c<span class="token punctuation">(</span>wordindex<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span>head<span class="token punctuation">(</span>wordindex<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                           <span class="token punctuation">,</span>rightidx <span class="token operator">=</span> c<span class="token punctuation">(</span>tail<span class="token punctuation">(</span>wordindex<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>wordindex<span class="token punctuation">[</span>length<span class="token punctuation">(</span>wordindex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span>
                           <span class="token punctuation">,</span>left_up<span class="token operator">=</span>c<span class="token punctuation">(</span>tail<span class="token punctuation">(</span>wordindex<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>wordindex<span class="token punctuation">[</span>length<span class="token punctuation">(</span>wordindex<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span>
                           <span class="token punctuation">)</span>

   <span class="token comment">#窗口期判定函数</span>
   computevalue <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>citeration<span class="token punctuation">,</span>wordindex<span class="token punctuation">,</span>filepart<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         left <span class="token operator">=</span> ifelse<span class="token punctuation">(</span>citeration<span class="token operator">$</span>left<span class="token punctuation">[</span>wordindex<span class="token operator">==</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>citeration<span class="token operator">$</span>left<span class="token punctuation">[</span>wordindex<span class="token operator">==</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
         right<span class="token operator">=</span> citeration<span class="token operator">$</span>right<span class="token punctuation">[</span>wordindex<span class="token operator">==</span>i<span class="token punctuation">]</span>
         leftidx<span class="token operator">=</span> ifelse<span class="token punctuation">(</span>citeration<span class="token operator">$</span>leftidx<span class="token punctuation">[</span>wordindex<span class="token operator">==</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>citeration<span class="token operator">$</span>leftidx<span class="token punctuation">[</span>wordindex<span class="token operator">==</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
         rightidx<span class="token operator">=</span> citeration<span class="token operator">$</span>rightidx<span class="token punctuation">[</span>wordindex<span class="token operator">==</span>i<span class="token punctuation">]</span>
         left_up<span class="token operator">=</span>citeration<span class="token operator">$</span>left_up<span class="token punctuation">[</span>wordindex<span class="token operator">==</span>i<span class="token punctuation">]</span>
         wdidx<span class="token operator">=</span>citeration<span class="token operator">$</span>wordindex<span class="token punctuation">[</span>wordindex<span class="token operator">==</span>i<span class="token punctuation">]</span>
  
         result <span class="token operator">=</span> cbind<span class="token punctuation">(</span>
                        ifelse<span class="token punctuation">(</span>right<span class="token operator">&lt;</span>rightidx
                              <span class="token punctuation">,</span>max<span class="token punctuation">(</span><span class="token punctuation">(</span>filepart<span class="token operator">$</span>adv_score<span class="token punctuation">[</span>max<span class="token punctuation">(</span>left<span class="token punctuation">,</span>leftidx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>max<span class="token punctuation">(</span>wdidx<span class="token punctuation">,</span>left_up<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>na.rm<span class="token operator">=</span>T<span class="token punctuation">)</span>
                              <span class="token punctuation">,</span>max<span class="token punctuation">(</span>filepart<span class="token operator">$</span>adv_score<span class="token punctuation">[</span>max<span class="token punctuation">(</span>left<span class="token punctuation">,</span>leftidx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>wdidx<span class="token punctuation">]</span><span class="token punctuation">,</span>na.rm<span class="token operator">=</span>T<span class="token punctuation">)</span>
                              <span class="token punctuation">)</span>
                       <span class="token punctuation">,</span>ifelse<span class="token punctuation">(</span>right<span class="token operator">&lt;</span>rightidx
                              <span class="token punctuation">,</span>max<span class="token punctuation">(</span>filepart<span class="token operator">$</span>deny_score<span class="token punctuation">[</span>max<span class="token punctuation">(</span>left<span class="token punctuation">,</span>leftidx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>max<span class="token punctuation">(</span>wdidx<span class="token punctuation">,</span>left_up<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>na.rm<span class="token operator">=</span>T<span class="token punctuation">)</span>
                              <span class="token punctuation">,</span>max<span class="token punctuation">(</span>filepart<span class="token operator">$</span>deny_score<span class="token punctuation">[</span>max<span class="token punctuation">(</span>left<span class="token punctuation">,</span>leftidx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>wdidx<span class="token punctuation">]</span><span class="token punctuation">,</span>na.rm<span class="token operator">=</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span>
                              <span class="token punctuation">)</span>
        return<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
                           
    <span class="token comment">#--计算值</span>
    result <span class="token operator">=</span> data.frame<span class="token punctuation">(</span>t<span class="token punctuation">(</span>sapply<span class="token punctuation">(</span>wordindex<span class="token punctuation">,</span>computevalue<span class="token punctuation">,</span>citeration<span class="token punctuation">,</span>wordindex<span class="token punctuation">,</span>filepart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    names<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">'adv'</span><span class="token punctuation">,</span><span class="token string">'deny'</span><span class="token punctuation">)</span>

    final_result <span class="token operator">=</span> data.frame<span class="token punctuation">(</span>
       id<span class="token operator">=</span>idname 
      <span class="token punctuation">,</span>posneg<span class="token operator">=</span>filepart<span class="token operator">$</span>weight<span class="token punctuation">[</span>wordindex<span class="token punctuation">]</span>
      <span class="token punctuation">,</span>result
      <span class="token punctuation">)</span>

    return<span class="token punctuation">(</span>final_result<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">#####################################################################</span>
<span class="token comment">#函数功能：综合计算每条评论总得分</span>
<span class="token comment">#参数说明：texttb：评论文本（打上情感词、否定词和副词标签后的）</span>

<span class="token comment">#情感词综合打分</span>
valuefun<span class="token operator">&lt;-</span><span class="token keyword">function</span><span class="token punctuation">(</span>texttb<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">#抽取正负情感词所在的片段</span>
  idnotnull<span class="token operator">&lt;-</span>data.frame<span class="token punctuation">(</span>id<span class="token operator">=</span>unique<span class="token punctuation">(</span>texttb<span class="token operator">$</span>id<span class="token punctuation">[</span>complete.cases<span class="token punctuation">(</span>texttb<span class="token operator">$</span>weight<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  idnotnull<span class="token operator">$</span>id<span class="token operator">&lt;-</span>as.character<span class="token punctuation">(</span>idnotnull<span class="token operator">$</span>id<span class="token punctuation">)</span>
  tstterm_nnid<span class="token operator">&lt;-</span>join<span class="token punctuation">(</span>texttb<span class="token punctuation">,</span>idnotnull<span class="token punctuation">,</span>type<span class="token operator">=</span><span class="token string">"inner"</span><span class="token punctuation">)</span>

  word_index<span class="token operator">&lt;-</span>unique<span class="token punctuation">(</span>tstterm_nnid<span class="token operator">$</span>id<span class="token punctuation">)</span>
  
  system.time<span class="token punctuation">(</span>score_combine<span class="token operator">&lt;-</span>lapply<span class="token punctuation">(</span>word_index<span class="token punctuation">,</span>word_segment<span class="token punctuation">,</span>tstterm_nnid<span class="token punctuation">)</span><span class="token punctuation">)</span>
  score_combine_tb<span class="token operator">&lt;-</span>do.call<span class="token punctuation">(</span><span class="token string">"rbind"</span><span class="token punctuation">,</span> score_combine<span class="token punctuation">)</span> 
  score_combine_tb<span class="token operator">$</span>id<span class="token operator">&lt;-</span>as.character<span class="token punctuation">(</span>score_combine_tb<span class="token operator">$</span>id<span class="token punctuation">)</span>
  score_combine_tb<span class="token operator">$</span>adv<span class="token punctuation">[</span>score_combine_tb<span class="token operator">$</span>adv<span class="token operator">==</span><span class="token operator">-</span><span class="token number">999</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token number">1</span>
  score_combine_tb<span class="token operator">$</span>deny<span class="token punctuation">[</span>score_combine_tb<span class="token operator">$</span>deny<span class="token operator">==</span><span class="token operator">-</span><span class="token number">999</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token number">1</span>
  score_combine_tb<span class="token operator">$</span>value<span class="token operator">&lt;-</span>score_combine_tb<span class="token operator">$</span>posneg<span class="token operator">*</span>score_combine_tb<span class="token operator">$</span>adv<span class="token operator">*</span>score_combine_tb<span class="token operator">$</span>deny
  subconvalue<span class="token operator">&lt;-</span>aggregate<span class="token punctuation">(</span>score_combine_tb<span class="token operator">$</span>value<span class="token punctuation">,</span>by<span class="token operator">=</span>list<span class="token punctuation">(</span>score_combine_tb<span class="token operator">$</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>sum<span class="token punctuation">)</span>
  subconvalue<span class="token operator">$</span>idtot<span class="token operator">&lt;-</span>as.numeric<span class="token punctuation">(</span>unlist<span class="token punctuation">(</span>lapply<span class="token punctuation">(</span>strsplit<span class="token punctuation">(</span>subconvalue<span class="token operator">$</span>Group.<span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  commentvalue<span class="token operator">&lt;-</span>aggregate<span class="token punctuation">(</span>subconvalue<span class="token operator">$</span>x<span class="token punctuation">,</span>by<span class="token operator">=</span>list<span class="token punctuation">(</span>subconvalue<span class="token operator">$</span>idtot<span class="token punctuation">)</span><span class="token punctuation">,</span>sum<span class="token punctuation">)</span>
  names<span class="token punctuation">(</span>commentvalue<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token string">'id'</span>
  commentvalue<span class="token operator">$</span>x<span class="token operator">&lt;-</span>round<span class="token punctuation">(</span>commentvalue<span class="token operator">$</span>x<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
  return<span class="token punctuation">(</span>commentvalue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
system.time<span class="token punctuation">(</span>valuetb<span class="token operator">&lt;-</span>valuefun<span class="token punctuation">(</span>tstterm<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="935_500"></a>9.3.5总结</h5> 
<p>至此，可以根据用户相似度，让用户看到与他相似用户的评论，并且可以按照文本质量评分及情感性分值根据产品策略进行排序。从技术运维的角度来说，算法的结束并不是技术的终结，后期自定义词库及调整打分权重都需要分析师根据实际样本做出调整，在数据分析领域永远没有完结的项目，除非业务被终结了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7100608f44faf9c1cb70fbcc953ec009/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">看书笔记【R语言数据分析项目精解：理论、方法、实战 8】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1f5880c5ca8b6e24ac8d5546dfc4db68/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">PIG框架学习3——Redisson 实现业务接口幂等</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>