<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>阿里云OSS代码集成部分问题分析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="阿里云OSS代码集成部分问题分析" />
<meta property="og:description" content="公司内部开发了一个文件相关的应用，由于服务器带宽限制导致多个用户同时上传或者下载文件时速度很慢，遂将文件迁移至阿里云OSS服务器。下面是迁移的过程中遇到的部分问题。
问题1. 跨域错误 错误信息如下：
Access to XMLHttpRequest at &#39;http://xxx.oss-cn-hangzhou.aliyuncs.com/test/logo.jpg&#39; from origin &#39;http://192.168.29.131:8080&#39; has been blocked by CORS policy: Response to preflight request doesn&#39;t pass access control check: No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource. 该问题按照以下步骤正确配置跨域规则。
登录OSS管理控制台。单击Bucket 列表，然后单击目标Bucket名称。在左侧导航栏，选择数据安全 &gt; 跨域设置。在跨域设置页面，单击创建规则。在创建跨域规则面板，按以下说明配置各项参数，其他参数保留默认配置。 来源：设置为*。允许Methods：选中GET、POST、PUT、DELETE、HEAD。允许Headers：设置为*。暴露Headers：设置为指定值或者不填。 单击确定。 问题2. Access denied by authorizer’s policy. 具体错误代码如下：
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;Error&gt; &lt;Code&gt;AccessDenied&lt;/Code&gt; &lt;Message&gt;Access denied by authorizer&#39;s policy.&lt;/Message&gt; &lt;RequestId&gt;655EED1451FCAD1916A298B4&lt;/RequestId&gt; &lt;HostId&gt;xxx.oss-cn-hangzhou.aliyuncs.com&lt;/HostId&gt; &lt;AccessDeniedDetail&gt; &lt;PolicyType&gt;SessionPolicy&lt;/PolicyType&gt; &lt;AuthPrincipalOwnerId&gt;1883463381918383&lt;/AuthPrincipalOwnerId&gt; &lt;AuthPrincipalType&gt;AssumedRoleUser&lt;/AuthPrincipalType&gt; &lt;AuthPrincipalDisplayName&gt;devram:251264809289383873&lt;/AuthPrincipalDisplayName&gt; &lt;NoPermissionType&gt;ImplicitDeny&lt;/NoPermissionType&gt; &lt;AuthAction&gt;oss:PutObject&lt;/AuthAction&gt; &lt;/AccessDeniedDetail&gt; &lt;EC&gt;0003-00000301&lt;/EC&gt; &lt;RecommendDoc&gt;https://api." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e5f03a6986e1477890445b67ed393bcf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-05T09:45:59+08:00" />
<meta property="article:modified_time" content="2023-12-05T09:45:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">阿里云OSS代码集成部分问题分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>公司内部开发了一个文件相关的应用，由于服务器带宽限制导致多个用户同时上传或者下载文件时速度很慢，遂将文件迁移至阿里云OSS服务器。下面是迁移的过程中遇到的部分问题。</p> 
</blockquote> 
<h3><a id="1__3"></a>问题1. 跨域错误</h3> 
<p>错误信息如下：</p> 
<pre><code>Access to XMLHttpRequest at 'http://xxx.oss-cn-hangzhou.aliyuncs.com/test/logo.jpg' from origin 'http://192.168.29.131:8080' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.
</code></pre> 
<p>该问题按照以下步骤正确配置跨域规则。</p> 
<ol><li>登录<a href="https://oss.console.aliyun.com/?spm=a2c4g.11186623.0.0.2a971be1qrYtuH" rel="nofollow">OSS管理控制台</a>。</li><li>单击<strong>Bucket 列表</strong>，然后单击目标Bucket名称。</li><li>在左侧导航栏，选择<strong>数据安全</strong> &gt; <strong>跨域设置</strong>。</li><li>在<strong>跨域设置</strong>页面，单击<strong>创建规则</strong>。</li><li>在<strong>创建跨域规则</strong>面板，按以下说明配置各项参数，其他参数保留默认配置。 
  <ul><li><strong>来源</strong>：设置为<code>*</code>。</li><li><strong>允许Methods</strong>：选中<code>GET</code>、<code>POST</code>、<code>PUT</code>、<code>DELETE</code>、<code>HEAD</code>。</li><li><strong>允许Headers</strong>：设置为<code>*</code>。</li><li><strong>暴露Headers</strong>：设置为指定值或者不填。</li></ul> </li><li>单击<strong>确定</strong>。</li></ol> 
<h3><a id="2_Access_denied_by_authorizers_policy_20"></a>问题2. Access denied by authorizer’s policy.</h3> 
<p>具体错误代码如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Error</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Code</span><span class="token punctuation">&gt;</span></span>AccessDenied<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Code</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Message</span><span class="token punctuation">&gt;</span></span>Access denied by authorizer's policy.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Message</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RequestId</span><span class="token punctuation">&gt;</span></span>655EED1451FCAD1916A298B4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RequestId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HostId</span><span class="token punctuation">&gt;</span></span>xxx.oss-cn-hangzhou.aliyuncs.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HostId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AccessDeniedDetail</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PolicyType</span><span class="token punctuation">&gt;</span></span>SessionPolicy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PolicyType</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthPrincipalOwnerId</span><span class="token punctuation">&gt;</span></span>1883463381918383<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthPrincipalOwnerId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthPrincipalType</span><span class="token punctuation">&gt;</span></span>AssumedRoleUser<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthPrincipalType</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthPrincipalDisplayName</span><span class="token punctuation">&gt;</span></span>devram:251264809289383873<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthPrincipalDisplayName</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NoPermissionType</span><span class="token punctuation">&gt;</span></span>ImplicitDeny<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>NoPermissionType</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthAction</span><span class="token punctuation">&gt;</span></span>oss:PutObject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthAction</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AccessDeniedDetail</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EC</span><span class="token punctuation">&gt;</span></span>0003-00000301<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EC</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>https://api.aliyun.com/troubleshoot?q=0003-00000301<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Error</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="_41"></a>问题解析：</h4> 
<p>Web端上传文件至OSS服务器，为避免暴露阿里云账号访问密钥（AccessKey ID和AccessKey Secret），通常临时访问凭证的方式执行OSS相关操作。<br> 临时访问凭证包括临时访问密钥（AccessKey ID和AccessKey Secret）和安全令牌（SecurityToken）。<br> 在获取访问密钥（AccessKey ID和AccessKey Secret）和安全令牌（SecurityToken）时，需要制定策略（Policy），而策略中则指定了权限以及资源目录等内容。如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"Version"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{<!-- --></span>
           <span class="token string-property property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
           <span class="token string-property property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
             <span class="token string">"oss:PutObject"</span> <span class="token comment">// 上传文件权限</span>
           <span class="token punctuation">]</span><span class="token punctuation">,</span>
           <span class="token string-property property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
             <span class="token string">"acs:oss:*:*:examplebucket/xxx/*"</span><span class="token punctuation">,</span> <span class="token comment">// examplebucket为bucket名称，其中xxx为上传文件目录</span>
           <span class="token punctuation">]</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注意：需要配置Action以及Resource，并且Resource中指定的目录需要与实际目录一致</strong><br> 详细解决方案见：<a href="https://api.aliyun.com/troubleshoot?q=0003-00000301" rel="nofollow">https://api.aliyun.com/troubleshoot?q=0003-00000301</a></p> 
<h3><a id="3_The_security_token_you_provided_has_expired_64"></a>问题3. The security token you provided has expired.</h3> 
<p>详细错误代码如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Error</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Code</span><span class="token punctuation">&gt;</span></span>SecurityTokenExpired<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Code</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Message</span><span class="token punctuation">&gt;</span></span>The security token you provided has expired.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Message</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RequestId</span><span class="token punctuation">&gt;</span></span>655EED5451FCAD1916A298B4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RequestId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HostId</span><span class="token punctuation">&gt;</span></span>xxx.oss-cn-hangzhou.aliyuncs.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HostId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SecurityToken</span><span class="token punctuation">&gt;</span></span>CAISowJ1q6Ft5B2yfSjIr5xxxx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SecurityToken</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EC</span><span class="token punctuation">&gt;</span></span>0002-00000007<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EC</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>https://api.aliyun.com/troubleshoot?q=0002-00000007<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Error</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>获取访问密钥（AccessKey ID和AccessKey Secret）和安全令牌（SecurityToken）时需要指定一个有效时间，超时即失效，再次上传文件则会报如上信息。<br> WEB端<code>aliyun-oss-sdk-6.18.0.min.js</code>创建OSS上传对象，可以指定刷新token方法，如下：</p> 
<pre><code class="prism language-javascript"> <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// yourRegion填写Bucket所在地域。以华东1（杭州）为例，yourRegion填写为oss-cn-hangzhou。</span>
    <span class="token literal-property property">region</span><span class="token operator">:</span> <span class="token string">"yourRegion"</span><span class="token punctuation">,</span>
    <span class="token comment">// 从STS服务获取的临时访问密钥（AccessKey ID和AccessKey Secret）。</span>
    <span class="token literal-property property">accessKeyId</span><span class="token operator">:</span> <span class="token string">"yourAccessKeyId"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">accessKeySecret</span><span class="token operator">:</span> <span class="token string">"yourAccessKeySecret"</span><span class="token punctuation">,</span>
    <span class="token comment">// 从STS服务获取的安全令牌（SecurityToken）。</span>
    <span class="token literal-property property">stsToken</span><span class="token operator">:</span> <span class="token string">"yourSecurityToken"</span><span class="token punctuation">,</span>
    <span class="token comment">// 填写Bucket名称。</span>
    <span class="token literal-property property">bucket</span><span class="token operator">:</span> <span class="token string">"examplebucket"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">retryMax</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 需指定retryMax，否则refreshSTSToken无法执行</span>
    <span class="token function-variable function">refreshSTSToken</span><span class="token operator">:</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 向您搭建的STS服务获取临时访问凭证。</span>
      <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'xxx/xxxx/get-token'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">accessKeyId</span><span class="token operator">:</span> info<span class="token punctuation">.</span>accessKeyId<span class="token punctuation">,</span>
        <span class="token literal-property property">accessKeySecret</span><span class="token operator">:</span> info<span class="token punctuation">.</span>accessKeySecret<span class="token punctuation">,</span>
        <span class="token literal-property property">stsToken</span><span class="token operator">:</span> info<span class="token punctuation">.</span>securityToken
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 刷新临时访问凭证的时间间隔，单位为毫秒。</span>
    <span class="token literal-property property">refreshSTSTokenInterval</span><span class="token operator">:</span> <span class="token number">1000</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>指定<code>refreshSTSToken</code>方法后，在执行文件上传时若token超时，则会自动刷新token并上传文件。值得注意的时单单指定<code>refreshSTSToken</code>方法并不会达成预期效果，需要同时指定<code>retryMax</code>参数才行（参考issue：<a href="https://github.com/ali-sdk/ali-oss/issues/1179">https://github.com/ali-sdk/ali-oss/issues/1179</a>）。</p> 
<h3><a id="4__106"></a>问题4. 部分文件无法预览、下载</h3> 
<p>部分类型文件（如pdf）文件无法在浏览器中预览或下载，错误截图如下：<img src="https://images2.imgbox.com/8c/63/9VZTu6lj_o.png" alt="在这里插入图片描述"><br> 登录OSS服务器后台管理平台，在文件列表查看文件，发现文件类型不是预期的类型：<br> <img src="https://images2.imgbox.com/2f/fe/v0ImmD6z_o.png" alt="在这里插入图片描述"><br> 出现该问题大概率是由于上传文件时指定的<code>Content-Type</code>错误造成的，上传文件不指定<code>Content-Type</code>即可。</p> 
<h3><a id="5__112"></a>问题5. 浏览器下载文件错误</h3> 
<p>通过<code>OSS.signatureUrl</code>方法转换的url，通过浏览器地址栏访问下载报<code>AccessDenied</code>错误。详细错误如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Error</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Code</span><span class="token punctuation">&gt;</span></span>AccessDenied<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Code</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Message</span><span class="token punctuation">&gt;</span></span>Access denied by authorizer's policy.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Message</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RequestId</span><span class="token punctuation">&gt;</span></span>65600B6235EB2631229B98CB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RequestId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HostId</span><span class="token punctuation">&gt;</span></span>xxx.oss-cn-hangzhou.aliyuncs.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HostId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AccessDeniedDetail</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PolicyType</span><span class="token punctuation">&gt;</span></span>SessionPolicy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PolicyType</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthPrincipalOwnerId</span><span class="token punctuation">&gt;</span></span>1883463381918303<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthPrincipalOwnerId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthPrincipalType</span><span class="token punctuation">&gt;</span></span>AssumedRoleUser<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthPrincipalType</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthPrincipalDisplayName</span><span class="token punctuation">&gt;</span></span>devram:251264809289383873<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthPrincipalDisplayName</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NoPermissionType</span><span class="token punctuation">&gt;</span></span>ImplicitDeny<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>NoPermissionType</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthAction</span><span class="token punctuation">&gt;</span></span>oss:GetObject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthAction</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AccessDeniedDetail</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EC</span><span class="token punctuation">&gt;</span></span>0003-00000301<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EC</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>https://api.aliyun.com/troubleshoot?q=0003-00000301<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Error</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>由错误信息中的<code>&lt;AuthAction&gt;oss:GetObject&lt;/AuthAction&gt;</code>可知获取访问密钥（AccessKey ID和AccessKey Secret）和安全令牌（SecurityToken）时未配置<code>GetObject</code>权限。在获取密钥和安全令牌时指定<code>GetObject</code>权限即可。如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"Version"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{<!-- --></span>
           <span class="token string-property property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
           <span class="token string-property property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
             <span class="token string">"oss:PutObject"</span><span class="token punctuation">,</span> <span class="token comment">// 上传文件权限</span>
             <span class="token string">"oss:GetObject"</span> <span class="token comment">// 下载文件权限</span>
           <span class="token punctuation">]</span><span class="token punctuation">,</span>
           <span class="token string-property property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
             <span class="token string">"acs:oss:*:*:examplebucket/xxx/*"</span><span class="token punctuation">,</span> <span class="token comment">// examplebucket为bucket名称，其中xxx为上传文件目录</span>
           <span class="token punctuation">]</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6_PutObjectSignatureDoesNotMatch_151"></a>问题6. 上传文件（PutObject）错误：SignatureDoesNotMatch</h3> 
<p>具体错误信息如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Error</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Code</span><span class="token punctuation">&gt;</span></span>SignatureDoesNotMatch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Code</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Message</span><span class="token punctuation">&gt;</span></span>The request signature we calculated does not match the signature you provided. Check your key and signing method.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Message</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RequestId</span><span class="token punctuation">&gt;</span></span>656155B635EB263982354AF5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RequestId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HostId</span><span class="token punctuation">&gt;</span></span>xxx.oss-cn-hangzhou.aliyuncs.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HostId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OSSAccessKeyId</span><span class="token punctuation">&gt;</span></span>STS.NXVCU7dhZXdzwmZjAVBDnFPB2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OSSAccessKeyId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SignatureProvided</span><span class="token punctuation">&gt;</span></span>rJ7d1McbT/JvVV2QrenR9DwS+r4=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SignatureProvided</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StringToSign</span><span class="token punctuation">&gt;</span></span>PUT

image/jpeg
Sat, 25 Nov 2023 02:02:30 GMT
x-oss-security-token:CAISsQJ1q6...
/mybucket/dir/11/20231123152500353242.jpg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StringToSign</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StringToSignBytes</span><span class="token punctuation">&gt;</span></span>50 ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StringToSignBytes</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EC</span><span class="token punctuation">&gt;</span></span>0002-00000040<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EC</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>https://api.aliyun.com/troubleshoot?q=0002-00000040<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Error</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>出现以上错误，根据错误信息中的链接：<a href="https://api.aliyun.com/troubleshoot?q=0002-00000040" rel="nofollow">https://api.aliyun.com/troubleshoot?q=0002-00000040</a> 排查，可能原因是<code>AccessKey ID</code>与<code>AccessKey Secret</code>填写错误导致，可以使用<code>AccessKey ID</code>与<code>AccessKey Secret</code>登录ossbrowser来验证正确性。具体步骤，请参见<a href="https://help.aliyun.com/document_detail/209974.html" rel="nofollow">安装并登录ossbrowser</a>。<br> 但是，在部分场合下<code>AccessKey ID</code>与<code>AccessKey Secret</code>设置正确，调用<code>PutObject</code>接口依然会报如上错误，这就比较坑了，在官网文件中也找不到相关的解释。查询了网上部分开发者的解释，可能是如下原因：</p> 
<ol><li><code>AccessKey ID</code>与<code>AccessKey Secret</code>前后包含了空格</li><li>endpoint配置错误（如：endpoint中混入多余的空格、斜杠），正确的格式应该是：<em>https://oss-cn-hangzhou.aliyuncs.com</em> ，具体可以在<a href="https://help.aliyun.com/zh/oss/user-guide/regions-and-endpoints#concept-zt4-cvy-5db" rel="nofollow">https://help.aliyun.com/zh/oss/user-guide/regions-and-endpoints#concept-zt4-cvy-5db</a> 中查找对应的endpoint。</li><li>objectName不规范，如objectName长度超过1023个字节，且不能以<code>/</code>、<code>\</code>以及<code>.</code>开头</li></ol> 
<h3><a id="7__179"></a>问题7. 图片上传后，访问缩略图再访问原图，显示的还是缩略图</h3> 
<p>问题现象如下：<br> <img src="https://images2.imgbox.com/e6/7b/C4Cw7jp8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e3/b2/nXj4ftpj_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6c/6e/SlC82siK_o.png" alt="在这里插入图片描述"><br> 大概率是CDN做了缓存导致的。<br> 解决方法：cdn控制台，找到域名（xxx.xxxxxx.cn），性能优化这里，将忽略参数的配置删除即可。<br> 而对于已经缓存的图片，需要将访问的文件/图片刷新。具体操作是在CDN管理&gt;刷新预热里，输入对应的url进行刷新操作即可。<br> <img src="https://images2.imgbox.com/b3/3b/nHcdlPbP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8_SecurityTokenExpired_188"></a>问题8. 下载文件报<code>SecurityTokenExpired</code>错误</h3> 
<p>前端通过<code>client.client.signatureUrl(objectName)</code>生成下载链接，再浏览器通过该链接下载文件，可能会报<code>SecurityTokenExpired</code>错误，具体错误信息如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Error</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Code</span><span class="token punctuation">&gt;</span></span>SecurityTokenExpired<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Code</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Message</span><span class="token punctuation">&gt;</span></span>The security token you provided has expired.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Message</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RequestId</span><span class="token punctuation">&gt;</span></span>652E74D33D19C03130C4CB62<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RequestId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HostId</span><span class="token punctuation">&gt;</span></span>xxx.oss-cn-hangzhou.aliyuncs.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HostId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SecurityToken</span><span class="token punctuation">&gt;</span></span>CAISxAJ1q6Ft5B4dyfS...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SecurityToken</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EC</span><span class="token punctuation">&gt;</span></span>0002-00000007<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EC</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>https://api.aliyun.com/troubleshoot?q=0002-00000007<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecommendDoc</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Error</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>错误信息很简单，<code>SecurityTokenExpired</code>指的就是<code>SecurityToken</code>已经过期，需要重新请求一个<code>SecurityToken</code>即可。在实际情况下，当<code>SecurityToken</code>过期再去通过调用<code>client.signatureUrl()</code>生成的链接去下载文件，还可能会报<code>AccessKey ID不存在</code>或者<code>InvalidAccessKeyID</code>的错误，出现该错误，解决方案也是重新请求一个<code>SecurityToken</code>即可。<br> 在这里我比较疑惑的是，通过<code>client.put()</code>上传文件，若<code>SecurityToken</code>过期，则会自动调用<code>refreshSTSToken</code>方法进行刷新token操作，而<code>client.signatureUrl()</code>则不会自动刷新token。<br> 有了疑问之后，就去翻<code>signatureUrl</code>的源码：<a href="https://github.com/ali-sdk/ali-oss/blob/master/lib/common/object/signatureUrl.js">https://github.com/ali-sdk/ali-oss/blob/master/lib/common/object/signatureUrl.js</a> ，发现曾经的某个版本，<code>signatureUrl</code>方法是带有刷新token操作的，具体代码点击这里：<a href="https://github.com/ali-sdk/ali-oss/commit/374231c9c1dcc5ed1312a2d19915b0894e3b964a#diff-96d41084308d1bba6abbdff9229ab13d216ffa78f742337acd5afd25d35caaf5R26">https://github.com/ali-sdk/ali-oss/commit/374231c9c1dcc5ed1312a2d19915b0894e3b964a#diff-96d41084308d1bba6abbdff9229ab13d216ffa78f742337acd5afd25d35caaf5R26</a> ，但是在后续的版本中，<code>signatureUrl</code>方法移除了刷新操作。<br> 幸运的是在翻Git的过程中，发现与<a href="https://github.com/ali-sdk/ali-oss/blob/master/lib/common/object/signatureUrl.js">signatureUrl.js</a>同目录的组件里，有另外一个名为<a href="https://github.com/ali-sdk/ali-oss/blob/master/lib/common/object/asyncSignatureUrl.js">asyncSignatureUrl.js</a>的组件，点进去看里面代码的逻辑，正是之前<code>signatureUrl.js</code>组件里类似，包含刷新token操作的代码。<br> 遂将项目里调用<code>client.signatureUrl()</code>的代码，替换成<code>client.asyncSignatureUrl()</code>，实际效果是token过期后，会自动进行刷新操作。😄</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a368f56bfaaf1b6684d3e6b5e31395c4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">windows 安装两个mysql</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2e8d529ca248a12da8f157af8d42f264/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vmvb中ubuntu打不开terminal</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>