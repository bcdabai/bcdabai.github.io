<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ASP.NET Core高级之认证与授权(二)--JWT认证前后端完整实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ASP.NET Core高级之认证与授权(二)--JWT认证前后端完整实现" />
<meta property="og:description" content="阅读本文你的收获 了解JWT身份认证的流程了解基于JWT身份认证和Session身份认证的区别学习如何在ASP.NET Core WebAPI项目中封装JWT认证功能 在上文ASP.NET Core高级之认证与授权(一)–JWT入门-颁发、验证令牌中演示了JWT认证的一个入门案例，本文是一个基于JWT认证的完整的前后端实现代码案例。
一、基于JWT的用户认证 JWT身份认证的流程 在认证的时候，当用户用他们的凭证成功登录以后，一个JSON Web Token将会被返回。此后，token就是用户凭证了，你必须非常小心以防止出现安全问题。一般而言，你保存令牌的时候不应该超过你所需要它的时间。
无论何时用户想要访问受保护的路由或者资源的时候，用户代理（通常是浏览器）都应该带上JWT，典型的，通常放在Authorization header中，用Bearer schema。
上图流程说明：
用户携带用户名和密码请求认证服务器校验用户账号密码，成功则提供一个token给客户端客户端存储token，并且在随后的每一次请求中都带着它服务器校验token有效则返回数据，无效则返回401状态码； 二、基于JWT身份认证和Session身份认证的区别 基于Session的身份认证的缺点 会话信息会占用服务器
每次用户认证通过以后，服务器需要创建一条记录保存用户信息，通常是在内存中，随着认证通过的用户越来越多，服务器的在这里的开销就会越来越大。
难以扩展
由于Session是在服务器的内存中的，这就带来一些扩展性的问题。
跨域共享难
当我们想要扩展我们的应用，让我们的数据被多个移动设备使用时，我们必须考虑跨资源共享（如使用Redis）问题。当使用AJAX调用从另一个域名下获取资源时，我们可能会遇到禁止请求的问题。
安全性差
客户端要存Cookie来保存SessionId，所以 用户很容易受到CSRF攻击。
基于JWT令牌的身份认证的优缺点 优点：
简单轻巧
JWT生成的token字符串是轻量级，json风格，比较简单。
减轻服务器压力
它是无状态的，JWT方式将用户状态分散到了客户端中，服务器或者Session中不会存储任何用户信息。明显减轻服务端的内存压力。
容易做分布式
没有会话信息意味着应用程序可以根据需要扩展和添加更多的机器，而不必担心用户登录的位置；
缺点：
JWT token一旦签发，无法修改无法更新token有效期，用户登录状态刷新较难实现无法销毁一个token，服务端不能对用户状态进行绝对控制不包含权限控制 三、JWT前后端完整实现关键代码 开发环境：
操作系统： Windows 10 专业版
平台版本是：.NET 6
开发框架：ASP.NET Core WebApi、Vue2&#43;ElementUI
开发工具：Visual Studio 2022
1. JWT的选项配置 在appsetting.json文件中，配置JWT选项参数，这样做的好处是，使用者在发布后任然可以修改JWT的参数，如过期时间，密钥等。
&#34;JWTTokenOption&#34;: { &#34;Issuer&#34;: &#34;WLW&#34;, //Token发布者 &#34;Audience&#34;: &#34;EveryTestOne&#34;, //Token接受者 &#34;IssuerSigningKey&#34;: &#34;WLW!@#%^99825949&#34;, //秘钥可以构建服务器认可的token；签名秘钥长度最少16 &#34;AccessTokenExpiresMinutes&#34;: &#34;30&#34; //过期时间30分钟 } 为了在ASP." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c0ecb76d44c8aaa7f80775db71c491c0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T18:04:15+08:00" />
<meta property="article:modified_time" content="2024-01-10T18:04:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ASP.NET Core高级之认证与授权(二)--JWT认证前后端完整实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>阅读本文你的收获</h3> 
<ol><li>了解JWT身份认证的流程</li><li>了解基于JWT身份认证和Session身份认证的区别</li><li>学习如何在ASP.NET Core WebAPI项目中封装JWT认证功能</li></ol> 
<p>在上文<a href="https://blog.csdn.net/ousetuhou/article/details/135392012">ASP.NET Core高级之认证与授权(一)–JWT入门-颁发、验证令牌</a>中演示了JWT认证的一个入门案例，本文是一个基于JWT认证的完整的前后端实现代码案例。</p> 
<h3><a id="JWT_6"></a>一、基于JWT的用户认证</h3> 
<h4><a id="JWT_7"></a>JWT身份认证的流程</h4> 
<p>在认证的时候，当用户用他们的凭证成功登录以后，一个JSON Web Token将会被返回。此后，token就是用户凭证了，你必须非常小心以防止出现安全问题。一般而言，你保存令牌的时候不应该超过你所需要它的时间。</p> 
<p>无论何时用户想要访问受保护的路由或者资源的时候，用户代理（通常是浏览器）都应该带上JWT，典型的，通常放在Authorization header中，用Bearer schema。</p> 
<p><img src="https://images2.imgbox.com/6b/f9/FIyDwkGT_o.png" alt="JWT认证流程">上图流程说明：</p> 
<ol><li>用户携带用户名和密码请求认证</li><li>服务器校验用户账号密码，成功则提供一个token给客户端</li><li>客户端存储token，并且在随后的每一次请求中都带着它</li><li>服务器校验token有效则返回数据，无效则返回401状态码；</li></ol> 
<h3><a id="JWTSession_20"></a>二、基于JWT身份认证和Session身份认证的区别</h3> 
<h4><a id="Session_21"></a>基于Session的身份认证的缺点</h4> 
<p><img src="https://images2.imgbox.com/6d/8c/gBgqce7x_o.png" alt="在这里插入图片描述"></p> 
<ul><li> <p>会话信息会占用服务器</p> <p>每次用户认证通过以后，服务器需要创建一条记录保存用户信息，通常是在内存中，随着认证通过的用户越来越多，服务器的在这里的开销就会越来越大。</p> </li><li> <p>难以扩展</p> <p>由于Session是在服务器的内存中的，这就带来一些扩展性的问题。</p> </li><li> <p>跨域共享难</p> <p>当我们想要扩展我们的应用，让我们的数据被多个移动设备使用时，我们必须考虑跨资源共享（如使用Redis）问题。当使用AJAX调用从另一个域名下获取资源时，我们可能会遇到禁止请求的问题。</p> </li><li> <p>安全性差</p> <p>客户端要存Cookie来保存SessionId，所以 用户很容易受到CSRF攻击。</p> </li></ul> 
<h4><a id="JWT_41"></a>基于JWT令牌的身份认证的优缺点</h4> 
<p><img src="https://images2.imgbox.com/d5/be/fjCZ405P_o.png" alt="在这里插入图片描述"><br> 优点：</p> 
<ul><li> <p>简单轻巧</p> <p>JWT生成的token字符串是轻量级，json风格，比较简单。</p> </li><li> <p>减轻服务器压力</p> <p>它是无状态的，JWT方式将用户状态分散到了客户端中，服务器或者Session中不会存储任何用户信息。明显减轻服务端的内存压力。</p> </li><li> <p>容易做分布式</p> <p>没有会话信息意味着应用程序可以根据需要扩展和添加更多的机器，而不必担心用户登录的位置；</p> </li></ul> 
<p>缺点：</p> 
<ul><li>JWT token一旦签发，无法修改</li><li>无法更新token有效期，用户登录状态刷新较难实现</li><li>无法销毁一个token，服务端不能对用户状态进行绝对控制</li><li>不包含权限控制</li></ul> 
<h3><a id="JWT_64"></a>三、JWT前后端完整实现关键代码</h3> 
<p>开发环境：</p> 
<blockquote> 
 <p>操作系统： Windows 10 专业版<br> 平台版本是：.NET 6<br> 开发框架：ASP.NET Core WebApi、Vue2+ElementUI<br> 开发工具：Visual Studio 2022</p> 
</blockquote> 
<h4><a id="1_JWT_72"></a>1. JWT的选项配置</h4> 
<p>在appsetting.json文件中，配置JWT选项参数，这样做的好处是，使用者在发布后任然可以修改JWT的参数，如过期时间，密钥等。</p> 
<pre><code class="prism language-json">  <span class="token string-property property">"JWTTokenOption"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"Issuer"</span><span class="token operator">:</span> <span class="token string">"WLW"</span><span class="token punctuation">,</span>                        <span class="token comment">//Token发布者</span>
    <span class="token string-property property">"Audience"</span><span class="token operator">:</span> <span class="token string">"EveryTestOne"</span><span class="token punctuation">,</span>             <span class="token comment">//Token接受者</span>
    <span class="token string-property property">"IssuerSigningKey"</span><span class="token operator">:</span> <span class="token string">"WLW!@#%^99825949"</span><span class="token punctuation">,</span> <span class="token comment">//秘钥可以构建服务器认可的token；签名秘钥长度最少16</span>
    <span class="token string-property property">"AccessTokenExpiresMinutes"</span><span class="token operator">:</span> <span class="token string">"30"</span>       <span class="token comment">//过期时间30分钟</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>为了在ASP.NET Core WebAPI项目中读出JWT选项参数，首先定义一个用于保存JWT选项的模型类：</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 用来保存jwt的配置信息</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTokenOption</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Token发布者</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Issuer <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// oken接受者</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Audience <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 秘钥</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> IssuerSigningKey <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 过期时间</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> AccessTokenExpiresMinutes <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在Program.cs中通过以下方式，读取JWT配置选项：</p> 
<pre><code class="prism language-csharp"><span class="token comment">//获取jwt配置项</span>
<span class="token class-name"><span class="token keyword">var</span></span> jwtTokenConfig <span class="token operator">=</span> builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"JWTTokenOption"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Get</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JwtTokenOption<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>jwtTokenConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//注册单例服务，以便后续调用</span>
</code></pre> 
<h4><a id="2_Jwt_118"></a>2. 配置Jwt身份认证方式</h4> 
<p>在Program.cs中进行服务注册，配置身份验证的模式为JwtBearer。</p> 
<blockquote> 
 <p>安装Microsoft.AspNetCore.Authentication.JwtBearer这个nuget包</p> 
</blockquote> 
<pre><code class="prism language-csharp">
<span class="token comment">//配置JwtBearer身份认证服务</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>opts<span class="token operator">=&gt;</span>
<span class="token punctuation">{<!-- --></span>
    opts<span class="token punctuation">.</span>DefaultAuthenticateScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span> <span class="token comment">//认证模式</span>
    opts<span class="token punctuation">.</span>DefaultChallengeScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>    <span class="token comment">//质询模式</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>   <span class="token comment">//对JwtBearer进行配置</span>
    x <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        x<span class="token punctuation">.</span>RequireHttpsMetadata <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//设置元数据地址或权限是否需要HTTP</span>
        x<span class="token punctuation">.</span>SaveToken <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//Token验证参数</span>
        x<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">//是否验证Issuer</span>
            ValidIssuer <span class="token operator">=</span> jwtTokenConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
            ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>jwtTokenConfig<span class="token punctuation">.</span>IssuerSigningKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ValidateAudience <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ValidAudience <span class="token operator">=</span> jwtTokenConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
            ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ClockSkew <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//对token过期时间验证的允许时间</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//如果jwt过期，在返回的header中加入Token-Expired字段为true，前端在获取返回header时判断</span>
        x<span class="token punctuation">.</span>Events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtBearerEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            OnAuthenticationFailed <span class="token operator">=</span> context <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Exception<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">SecurityTokenExpiredException</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Token-Expired"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="3_JWT_163"></a>3. 编写生成JWT令牌的帮助类</h4> 
<p>首先，定义相关的一些模型类，如下：</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 存放Token 跟过期时间的模型类</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TnToken</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// token字符串</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> TokenStr <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// token过期时间</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> Expires <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 返回信息模型类</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResponseModel</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 返回码</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Code <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 消息</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Msg <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 数据</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> Data <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Token信息</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TnToken</span> TokenInfo <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// token工具类的接口，方便使用依赖注入，很简单提供两个常用的方法</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ITokenHelper</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 根据一个对象通过反射提供负载，生成token  </span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;</span>
    <span class="token comment">/// &lt;param name="user"&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token return-type class-name">TnToken</span> <span class="token generic-method"><span class="token function">CreateToken</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 根据键值对提供负载，生成token</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="keyValuePairs"&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token return-type class-name">TnToken</span> <span class="token function">CreateToken</span><span class="token punctuation">(</span><span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> keyValuePairs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>以上接口的实现类如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>Jwt</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Newtonsoft<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Cryptography</span><span class="token punctuation">;</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// Token帮助类</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenHelper</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ITokenHelper</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//依赖注入配置项</span>
    <span class="token comment">//private readonly IOptions&lt;JwtTokenOption&gt; _options;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">JwtTokenOption</span> _options<span class="token punctuation">;</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 构造方法</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="options"&gt;&lt;/param&gt;</span>
    <span class="token keyword">public</span> <span class="token function">TokenHelper</span><span class="token punctuation">(</span><span class="token class-name">JwtTokenOption</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 根据一个对象通过反射提供负载，生成token  </span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;</span>
    <span class="token comment">/// &lt;param name="user"&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TnToken</span> <span class="token generic-method"><span class="token function">CreateToken</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//定义声明的集合</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//用反射把数据提供给它</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> entity<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">object</span></span> obj <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">value</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            claims<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//根据声明 生成token字符串</span>
        <span class="token keyword">return</span> <span class="token function">CreateTokenString</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 根据键值对提供负载，生成token</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="keyValuePairs"&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TnToken</span> <span class="token function">CreateToken</span><span class="token punctuation">(</span><span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> keyValuePairs<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//定义声明的集合</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> keyValuePairs<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            claims<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> item<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//根据声明 生成token字符串</span>
        <span class="token keyword">return</span> <span class="token function">CreateTokenString</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 私有方法，用于生成Token字符串</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="claims"&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">private</span> <span class="token return-type class-name">TnToken</span> <span class="token function">CreateTokenString</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//过期时间</span>
        <span class="token class-name">DateTime</span> expires <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMinutes</span><span class="token punctuation">(</span>_options<span class="token punctuation">.</span>AccessTokenExpiresMinutes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">issuer</span><span class="token punctuation">:</span> _options<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">audience</span><span class="token punctuation">:</span> _options<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">claims</span><span class="token punctuation">:</span> claims<span class="token punctuation">,</span>           <span class="token comment">//携带的荷载</span>
            notBefore<span class="token punctuation">:</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">,</span>  <span class="token comment">//token生成时间</span>
            expires<span class="token punctuation">:</span> expires<span class="token punctuation">,</span>         <span class="token comment">//token过期时间</span>
            signingCredentials<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>_options<span class="token punctuation">.</span>IssuerSigningKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TnToken</span>
        <span class="token punctuation">{<!-- --></span>
            Expires <span class="token operator">=</span> expires<span class="token punctuation">,</span>
            TokenStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="4_Token_338"></a>4. 在用户登录方法中，签发Token</h4> 
<pre><code class="prism language-csharp"><span class="token comment">//定义实例tokenHelper实例</span>
<span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ITokenHelper</span> _tokenHelper<span class="token punctuation">;</span>
<span class="token comment">//构造函数注入ITokenHelper实例 略</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 登录功能</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name="user"&gt;&lt;/param&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token class-name">UserLoginDto</span> user<span class="token punctuation">)</span> <span class="token comment">//（1） 后端登录：账号密码的验证</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//对输入参数user进行验证，略</span>
 	
    <span class="token comment">//定义一个响应信息的对象</span>
    <span class="token class-name">ResponseModel</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResponseModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//检查用户是否存在(MD5对密码进行加密）</span>
    <span class="token class-name"><span class="token keyword">var</span></span> userInfo <span class="token operator">=</span> _userService<span class="token punctuation">.</span><span class="token function">CheckUserAndPwd</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>LoginName<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Pwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> keyValuePairs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">{<!-- --></span> <span class="token string">"LoginName"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>LoginName <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span> <span class="token string">"SuperAdmin"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">}</span> <span class="token comment">//假定用户属于SuperAdmin角色</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>Msg <span class="token operator">=</span> <span class="token string">"登录成功"</span><span class="token punctuation">;</span>
        
        <span class="token comment">//（2） 后端：帮助类来生成JWT字符串，JWT字符串返回给浏览器</span>
        res<span class="token punctuation">.</span>TokenInfo <span class="token operator">=</span> _tokenHelper<span class="token punctuation">.</span><span class="token function">CreateToken</span><span class="token punctuation">(</span>keyValuePairs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        res<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>Msg <span class="token operator">=</span> <span class="token string">"用户名或密码不正确"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Unauthorized</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//401的错误码</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="5_API_383"></a>5. 给API接口加身份授权锁</h4> 
<p>在Api控制器或者方法上，加[Authorize]特性，需要引用命名空间：</p> 
<blockquote> 
 <p>using Microsoft.AspNetCore.Authorization；</p> 
</blockquote> 
<ul><li>[Authorize]加在控制器上，则该控制器下所有API方法需要身份授权后才能访问；</li><li>[Authorize]加在方法上，则仅该方法需要身份授权后才能访问。</li></ul> 
<p>另外，有一个[AllowAnonymous]特性，加在Api控制器或者方法上，允许匿名访问该Api或者控制器下所有Api方法。</p> 
<p>Api资源被锁保护起来之后，如果没有登录直接访问，则会报401的错误。在Swagger中测试截图如下：<br> <img src="https://images2.imgbox.com/4a/e6/SDLJyHWr_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="6_SwaggerToken_398"></a>6. Swagger中进行Token的测试</h4> 
<p>（1）在Program.cs的配置Swagger服务：</p> 
<pre><code class="prism language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
	<span class="token class-name"><span class="token keyword">var</span></span> basePath <span class="token operator">=</span> AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">;</span>  <span class="token comment">//获取应用程序的所在目录</span>
    <span class="token comment">//或者用下面的方式也能获取</span>
    <span class="token class-name"><span class="token keyword">var</span></span> basePath2 <span class="token operator">=</span>Path<span class="token punctuation">.</span><span class="token function">GetDirectoryName</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Program</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">.</span>Location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token class-name"><span class="token keyword">var</span></span> xmlPath <span class="token operator">=</span> System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> <span class="token string">"XfTech.Demo.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//拼接XML文件所在路径</span>
    
	<span class="token comment">//让Swagger显示方法、类的XML注释信息</span>
	c<span class="token punctuation">.</span><span class="token function">IncludeXmlComments</span><span class="token punctuation">(</span>xmlPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//设置Swagger文档参数</span>
	c<span class="token punctuation">.</span><span class="token function">SwaggerDoc</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiInfo</span>
	<span class="token punctuation">{<!-- --></span>
		Title <span class="token operator">=</span> <span class="token string">"XfTech.Demo"</span><span class="token punctuation">,</span>
		Version <span class="token operator">=</span> <span class="token string">"v1"</span><span class="token punctuation">,</span>
		Description <span class="token operator">=</span> <span class="token string">"Asp.Net Core6 WebApi开发实战"</span><span class="token punctuation">,</span>  <span class="token comment">//描述信息</span>
		Contact <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiContact</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//开发者信息</span>
		<span class="token punctuation">{<!-- --></span>
			Name <span class="token operator">=</span> <span class="token string">"物联网大联盟"</span><span class="token punctuation">,</span>               <span class="token comment">//开发者姓名</span>
			Email <span class="token operator">=</span> <span class="token string">"99825949@qq.com"</span><span class="token punctuation">,</span>    <span class="token comment">//email地址</span>
			Url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"https://blog.csdn.net/ousetuhou?type=blog"</span><span class="token punctuation">)</span> <span class="token comment">//作者的主页网站</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//开启Authorize权限按钮</span>
	c<span class="token punctuation">.</span><span class="token function">AddSecurityDefinition</span><span class="token punctuation">(</span><span class="token string">"JWTBearer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Description <span class="token operator">=</span> <span class="token string">"这是方式一(直接在输入框中输入认证信息，不需要在开头添加Bearer) "</span><span class="token punctuation">,</span>
		Name <span class="token operator">=</span> <span class="token string">"Authorization"</span><span class="token punctuation">,</span>        <span class="token comment">//jwt默认的参数名称</span>
		In <span class="token operator">=</span> ParameterLocation<span class="token punctuation">.</span>Header<span class="token punctuation">,</span>  <span class="token comment">//jwt默认存放Authorization信息的位置(请求头中)</span>
		Type <span class="token operator">=</span> SecuritySchemeType<span class="token punctuation">.</span>Http<span class="token punctuation">,</span>
		Scheme <span class="token operator">=</span> <span class="token string">"Bearer"</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//定义JwtBearer认证方式二</span>
	<span class="token comment">//options.AddSecurityDefinition("JwtBearer", new OpenApiSecurityScheme()</span>
	<span class="token comment">//{<!-- --></span>
	<span class="token comment">//    Description = "这是方式二(JWT授权(数据将在请求头中进行传输) 直接在下框中输入Bearer {token}（注意两者之间是一个空格）)",</span>
	<span class="token comment">//    Name = "Authorization",//jwt默认的参数名称</span>
	<span class="token comment">//    In = ParameterLocation.Header,//jwt默认存放Authorization信息的位置(请求头中)</span>
	<span class="token comment">//    Type = SecuritySchemeType.ApiKey</span>
	<span class="token comment">//});</span>
	<span class="token comment">//声明一个Scheme，注意下面的Id要和上面AddSecurityDefinition中的参数name一致</span>
	<span class="token class-name"><span class="token keyword">var</span></span> scheme <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
	<span class="token punctuation">{<!-- --></span>
		Reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			Id <span class="token operator">=</span> <span class="token string">"JWTBearer"</span><span class="token punctuation">,</span>  <span class="token comment">//这个名字与上面的一样</span>
			Type <span class="token operator">=</span> ReferenceType<span class="token punctuation">.</span>SecurityScheme
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//注册全局认证（所有的接口都可以使用认证）</span>
	c<span class="token punctuation">.</span><span class="token function">AddSecurityRequirement</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityRequirement</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">{<!-- --></span> scheme<span class="token punctuation">,</span> Array<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Empty</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
</code></pre> 
<p>（2） 测试登录接口，输入正确的账号和密码，接口返回JWT令牌<br> <img src="https://images2.imgbox.com/c3/4f/7El9k5Rl_o.png" alt="在这里插入图片描述">（3）点击“Authorize”按钮，在对话框中输入上一步获取到的令牌<br> <img src="https://images2.imgbox.com/4e/bd/quX1KGy2_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/3b/b0/HLX9Xxbu_o.png" alt="在这里插入图片描述">（4）输入令牌后关闭对话框，右边的小锁为锁住的状态。接下来调用业务模块的Api会自动讲JWT令牌携带上。<br> <img src="https://images2.imgbox.com/9c/c0/KQUTmMkP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="VueJWT_461"></a>四、Vue前台使用JWT认证进行安全防护</h3> 
<p>登录页面的布局略。以下只演示如何获取并缓存JWT令牌，以及在每个请求的时候携带上JWT令牌。</p> 
<h4><a id="1_sessionStorageJWT_463"></a>1. 登录成功后，用sessionStorage保存JWT令牌</h4> 
<pre><code class="prism language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$http</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	<span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">"/api/Account/Login"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">"post"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">data</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>loginForm<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$message</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	   sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'jwtToken'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>tokenInfo<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span> <span class="token comment">//保存到浏览器缓存</span>
	   <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span> <span class="token comment">//跳转到首页</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="2_axios_479"></a>2. 发送请求前，用axios拦截器添加以下请求头</h4> 
<blockquote> 
 <p>Authorization: Bearer <em>jwt令牌字符串</em></p> 
</blockquote> 
<pre><code class="prism language-javascript"><span class="token comment">// 在main.js中 添加请求拦截器</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 在发送请求之前做些什么</span>
  <span class="token keyword">var</span> tkn <span class="token operator">=</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">"jwtToken"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>tkn<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authorization <span class="token operator">=</span> <span class="token string">'Bearer '</span> <span class="token operator">+</span> tkn
  <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 对请求错误做些什么</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<p>本次对这个JWT认证进行了一个完整的封装演示。如果本文对你有帮助的话，请点赞+评论+关注，或者转发给需要的朋友。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd1a688d661132f278ad4714cf33beab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【软件项目管理_软件工程】软件项目管理课后相关习题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6d602b7f01839ac0efef1b8fae13d6d1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">若依开源框架介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>