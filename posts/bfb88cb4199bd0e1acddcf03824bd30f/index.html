<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>iOS线程通信和进程通信的例子（NSMachPort和NSTask，NSPipe） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="iOS线程通信和进程通信的例子（NSMachPort和NSTask，NSPipe）" />
<meta property="og:description" content="原创：http://blog.csdn.net/yxh265/article/details/51483822
iOS线程间的通信 iOS中，两个线程之间要想互相通信，可以使用：NSMachPort 下面是例子
#define kMsg1 100 #define kMsg2 101 - (void)viewDidLoad { [super viewDidLoad]; //1. 创建主线程的port // 子线程通过此端口发送消息给主线程 NSPort *myPort = [NSMachPort port]; //2. 设置port的代理回调对象 myPort.delegate = self; //3. 把port加入runloop，接收port消息 [[NSRunLoop currentRunLoop] addPort:myPort forMode:NSDefaultRunLoopMode]; NSLog(@&#34;---myport %@&#34;, myPort); //4. 启动次线程,并传入主线程的port MyWorkerClass *work = [[MyWorkerClass alloc] init]; [NSThread detachNewThreadSelector:@selector(launchThreadWithPort:) toTarget:work withObject:myPort]; } - (void)handlePortMessage:(NSMessagePort*)message{ NSLog(@&#34;接到子线程传递的消息！%@&#34;,message); //1. 消息id NSUInteger msgId = [[message valueForKeyPath:@&#34;msgid&#34;] integerValue]; //2. 当前主线程的port NSPort *localPort = [message valueForKeyPath:@&#34;localPort&#34;]; //3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/bfb88cb4199bd0e1acddcf03824bd30f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-05-23T18:33:14+08:00" />
<meta property="article:modified_time" content="2016-05-23T18:33:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">iOS线程通信和进程通信的例子（NSMachPort和NSTask，NSPipe）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>原创：<a href="http://blog.csdn.net/yxh265/article/details/51483822">http://blog.csdn.net/yxh265/article/details/51483822</a></p> 
<h4 id="ios线程间的通信">iOS线程间的通信</h4> 
<p>iOS中，两个线程之间要想互相通信，可以使用：NSMachPort <br> 下面是例子</p> 
<pre class="prettyprint"><code class=" hljs objectivec"><span class="hljs-preprocessor">#define kMsg1 100</span>
<span class="hljs-preprocessor">#define kMsg2 101</span>

- (<span class="hljs-keyword">void</span>)viewDidLoad {
    [<span class="hljs-keyword">super</span> viewDidLoad];

    <span class="hljs-comment">//1. 创建主线程的port</span>
    <span class="hljs-comment">// 子线程通过此端口发送消息给主线程</span>
    NSPort *myPort = [NSMachPort port];

    <span class="hljs-comment">//2. 设置port的代理回调对象</span>
    myPort<span class="hljs-variable">.delegate</span> = <span class="hljs-keyword">self</span>;

    <span class="hljs-comment">//3. 把port加入runloop，接收port消息</span>
    [[NSRunLoop currentRunLoop] addPort:myPort forMode:NSDefaultRunLoopMode];

    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"---myport %@"</span>, myPort);
    <span class="hljs-comment">//4. 启动次线程,并传入主线程的port</span>
    MyWorkerClass *work = [[MyWorkerClass alloc] init];
    [<span class="hljs-built_in">NSThread</span> detachNewThreadSelector:<span class="hljs-keyword">@selector</span>(launchThreadWithPort:)
                             toTarget:work
                           withObject:myPort];
}
- (<span class="hljs-keyword">void</span>)handlePortMessage:(NSMessagePort*)message{

    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"接到子线程传递的消息！%@"</span>,message);

    <span class="hljs-comment">//1. 消息id</span>
    NSUInteger msgId = [[message valueForKeyPath:@<span class="hljs-string">"msgid"</span>] integerValue];

    <span class="hljs-comment">//2. 当前主线程的port</span>
    NSPort *localPort = [message valueForKeyPath:@<span class="hljs-string">"localPort"</span>];

    <span class="hljs-comment">//3. 接收到消息的port（来自其他线程）</span>
    NSPort *remotePort = [message valueForKeyPath:@<span class="hljs-string">"remotePort"</span>];

    <span class="hljs-keyword">if</span> (msgId == kMsg1)
    {
        <span class="hljs-comment">//向子线的port发送消息</span>
        [remotePort sendBeforeDate:[<span class="hljs-built_in">NSDate</span> date]
                             msgid:kMsg2
                        components:<span class="hljs-literal">nil</span>
                              from:localPort
                          reserved:<span class="hljs-number">0</span>];

    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msgId == kMsg2){
        <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"操作2....\n"</span>);
    }
}</code></pre> 
<p>MyWorkerClass</p> 
<pre class="prettyprint"><code class=" hljs java">#<span class="hljs-keyword">import</span> <span class="hljs-string">"MyWorkerClass.h"</span>

<span class="hljs-annotation">@interface</span> MyWorkerClass() &lt;NSMachPortDelegate&gt; {
    NSPort *remotePort;
    NSPort *myPort;
}
<span class="hljs-annotation">@end</span>

#define kMsg1 <span class="hljs-number">100</span>
#define kMsg2 <span class="hljs-number">101</span>

<span class="hljs-annotation">@implementation</span> MyWorkerClass


- (<span class="hljs-keyword">void</span>)launchThreadWithPort:(NSPort *)port {

    <span class="hljs-annotation">@autoreleasepool</span> {

        <span class="hljs-comment">//1. 保存主线程传入的port</span>
        remotePort = port;

        <span class="hljs-comment">//2. 设置子线程名字</span>
        [[NSThread currentThread] setName:@<span class="hljs-string">"MyWorkerClassThread"</span>];

        <span class="hljs-comment">//3. 开启runloop</span>
        [[NSRunLoop currentRunLoop] run];

        <span class="hljs-comment">//4. 创建自己port</span>
        myPort = [NSPort port];

        <span class="hljs-comment">//5.</span>
        myPort.delegate = self;

        <span class="hljs-comment">//6. 将自己的port添加到runloop</span>
        <span class="hljs-comment">//作用1、防止runloop执行完毕之后推出</span>
        <span class="hljs-comment">//作用2、接收主线程发送过来的port消息</span>
        [[NSRunLoop currentRunLoop] addPort:myPort forMode:NSDefaultRunLoopMode];



        <span class="hljs-comment">//7. 完成向主线程port发送消息</span>
        [self sendPortMessage];


    }
}

<span class="hljs-javadoc">/**
 *   完成向主线程发送port消息
 */</span>
- (<span class="hljs-keyword">void</span>)sendPortMessage {

    NSMutableArray *array  =[[NSMutableArray alloc]initWithArray:@[@<span class="hljs-string">"1"</span>,@<span class="hljs-string">"2"</span>]];
    <span class="hljs-comment">//发送消息到主线程，操作1</span>
    [remotePort sendBeforeDate:[NSDate date]
                         msgid:kMsg1
                    components:array
                          from:myPort
                      reserved:<span class="hljs-number">0</span>];

    <span class="hljs-comment">//发送消息到主线程，操作2</span>
    <span class="hljs-comment">//    [remotePort sendBeforeDate:[NSDate date]</span>
    <span class="hljs-comment">//                         msgid:kMsg2</span>
    <span class="hljs-comment">//                    components:nil</span>
    <span class="hljs-comment">//                          from:myPort</span>
    <span class="hljs-comment">//                      reserved:0];</span>
}


#pragma mark - NSPortDelegate

<span class="hljs-javadoc">/**
 *  接收到主线程port消息
 */</span>
- (<span class="hljs-keyword">void</span>)handlePortMessage:(NSPortMessage *)message
{
    NSLog(@<span class="hljs-string">"接收到父线程的消息...\n"</span>);

    <span class="hljs-comment">//    unsigned int msgid = [message msgid];</span>
    <span class="hljs-comment">//    NSPort* distantPort = nil;</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">//    if (msgid == kCheckinMessage)</span>
    <span class="hljs-comment">//    {<!-- --></span>
    <span class="hljs-comment">//        distantPort = [message sendPort];</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">//    }</span>
    <span class="hljs-comment">//    else if(msgid == kExitMessage)</span>
    <span class="hljs-comment">//    {<!-- --></span>
    <span class="hljs-comment">//        CFRunLoopStop((__bridge CFRunLoopRef)[NSRunLoop currentRunLoop]);</span>
    <span class="hljs-comment">//    }</span>
}

<span class="hljs-annotation">@end</span></code></pre> 
<p>以上就可以完成一个线程间的数据通信。</p> 
<h4 id="ios进程间的通信越狱时用到">iOS进程间的通信（越狱时用到）</h4> 
<p>先创建一个命令行工程，建一个简单的子项目。名为：taskchild</p> 
<pre class="prettyprint"><code class=" hljs objectivec"><span class="hljs-preprocessor">#import <span class="hljs-title">&lt;UIKit/UIKit.h&gt;</span></span>
<span class="hljs-preprocessor">#import <span class="hljs-title">&lt;Foundation/Foundation.h&gt;</span></span>
<span class="hljs-preprocessor">#include &lt;stdio.h&gt;</span>


<span class="hljs-keyword">int</span> main (<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[])
{

    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"receive value arg %d %s %s"</span>, argc, argv[<span class="hljs-number">0</span>], argv[<span class="hljs-number">1</span>]);

    sleep(<span class="hljs-number">10</span>);

    <span class="hljs-comment">// insert code here...</span>
    printf(<span class="hljs-string">"Hello, World!\n"</span>);
    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"Hello, World"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre> 
<p>再创建一个有界面的主项目。进程通信部分代码。需要引用头文件：NSTask.h见下面的引用</p> 
<pre class="prettyprint"><code class=" hljs objectivec">    <span class="hljs-built_in">NSString</span>* string = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:@<span class="hljs-string">"taskchild"</span> ofType:<span class="hljs-literal">nil</span>];<span class="hljs-comment">//taskchild是所要启动的名字二进制文件名,上面建的子项目。</span>
    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"%@"</span>,string);

    NSTask *task;
    task = [[NSTask alloc ]init];
    [task setLaunchPath:string];

    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"This is NSTask with ping command......\n"</span>);
    <span class="hljs-built_in">NSArray</span> *arguments;
    arguments = [<span class="hljs-built_in">NSArray</span> arrayWithObjects:@<span class="hljs-string">"22"</span>, <span class="hljs-literal">nil</span>];
    [task setArguments:arguments];

    NSPipe *pipe;
    pipe = [NSPipe pipe];
    [task setStandardOutput:pipe];

    NSFileHandle *file;
    file = [pipe fileHandleForReading];

    [task launch];

    NSData *data;
    data = [file readDataToEndOfFile];

    string = [[<span class="hljs-built_in">NSString</span> alloc]initWithData:data encoding:NSUTF8StringEncoding];

    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"get child value :%@"</span>,string);</code></pre> 
<h4 id="引用">引用</h4> 
<p><a href="https://github.com/sbxfc/RunLoops">RunLoops</a> <br> <a href="https://github.com/obaby/NSTask-4-iOS">NSTask-4-iOS</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/52b4bd65d8e5ee1a9b00d17a77cb11ba/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">媒体查询使用方法@media</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e71dc54a25968ea762137f53892a5be4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SetUnhandledExceptionFilter让程序优雅的崩溃（转）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>