<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>KubeSphere中集成ApiSix - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="KubeSphere中集成ApiSix" />
<meta property="og:description" content="KubeSphere中集成ApiSix 一、Apache APISIX 介绍 Apache APISIX 是一款开源的高性能、动态云原生网关，由深圳支流科技有限公司于 2019 年捐赠给 Apache 基金会，当前已经成为 Apache 基金会的顶级开源项目，也是 GitHub 上最活跃的网关项目。Apache APISIX 当前已经覆盖了 API 网关，LB，Kubernetes Ingress，Service Mesh 等多种场景。
二、部署Apache APISIX Ingress Controller 2.1 进入企业空间添加应用仓库 首先还是先要添加 Apache APISIX Helm Chart 仓库，推荐用这种自管理的方式来保障仓库内容是得到及时同步的。我们选定一个企业空间后，通过「应用管理」下面的「应用仓库」来添加如下一个 Apache APISIX 的仓库（仓库 URL：https://charts.apiseven.com）。
2.2 创建项目部署apisix 接下来我们创建一个名为 apisix-system 的项目。进入项目页面后，选择在「应用负载」中创建「应用」的方式来部署 Apache APISIX，并选择 apisix 应用模版开始进行部署。
为何是部署 Apache APISIX 应用的 Helm Chart，而不是直接部署 Apache APISIX Ingress Controller?
这是因为 Apache APISIX Ingress Controller 目前和 Apache APISIX 网关是强关联的（如下图所示），且目前通过 Apache APISIX Helm Charts 同时部署 Apache APISIX Gateway &#43; Dashboard &#43; Ingress Controller 是最方便的，因此本文推荐直接使用 Apache APISIX 的 Helm Chart 进行整套组件的部署。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4a72b2a04d207bc9d2862b8c7ff7db5d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-13T14:34:18+08:00" />
<meta property="article:modified_time" content="2023-02-13T14:34:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">KubeSphere中集成ApiSix</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="KubeSphereApiSix_0"></a>KubeSphere中集成ApiSix</h2> 
<h2><a id="Apache_APISIX__2"></a>一、Apache APISIX 介绍</h2> 
<p>Apache APISIX 是一款开源的高性能、动态云原生网关，由深圳支流科技有限公司于 2019 年捐赠给 Apache 基金会，当前已经成为 Apache 基金会的顶级开源项目，也是 GitHub 上最活跃的网关项目。Apache APISIX 当前已经覆盖了 <a href="https://so.csdn.net/so/search?q=API&amp;spm=1001.2101.3001.7020">API</a> 网关，LB，Kubernetes Ingress，Service Mesh 等多种场景。</p> 
<h2><a id="Apache_APISIX_Ingress_Controller_8"></a>二、部署Apache APISIX Ingress Controller</h2> 
<h3><a id="21__12"></a>2.1 进入企业空间添加应用仓库</h3> 
<p>首先还是先要添加 Apache APISIX Helm Chart 仓库，推荐用这种自管理的方式来保障仓库内容是得到及时同步的。我们选定一个企业空间后，通过「应用管理」下面的「应用仓库」来添加如下一个 Apache APISIX 的仓库（仓库 URL：<code>https://charts.apiseven.com</code>）。</p> 
<p><img src="https://images2.imgbox.com/a4/97/YB3jZWdJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1b/40/8X4XCwgp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/76/16/1CSE1MZI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d3/ee/1TTA84Cq_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/95/72/Pftp68co_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/31/29/dmEu7ZOo_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22_apisix_31"></a>2.2 创建项目部署apisix</h3> 
<p>接下来我们创建一个名为 <code>apisix-system</code> 的项目。进入项目页面后，选择在「应用负载」中创建「应用」的方式来部署 Apache APISIX，并选择 <code>apisix</code> 应用模版开始进行部署。</p> 
<p><img src="https://images2.imgbox.com/26/cf/bkCKXFZJ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/08/d0/gCm7CvKa_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b7/77/eb8rq18b_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/24/fe/22GU2oae_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7d/52/HIyet3q4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9b/23/fZT8SFGb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5a/67/1oec6E5X_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>为何是部署 Apache APISIX 应用的 Helm Chart，而不是直接部署 Apache APISIX Ingress Controller?</p> 
 <p>这是因为 Apache APISIX Ingress Controller 目前和 Apache APISIX 网关是强关联的（如下图所示），且目前通过 Apache APISIX Helm Charts 同时部署 Apache APISIX Gateway + Dashboard + Ingress Controller 是最方便的，因此本文推荐直接使用 Apache APISIX 的 Helm Chart 进行整套组件的部署。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/88/49/5TJGa2zp_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c3/06/gDc5J9VE_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/13/db/1KsOoaLE_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>将应用命名为 <code>apisix</code> 以避免多个组件（Gateway, Dashboard, Ingress Controller）的工作负载及服务名称产生不匹配的情况</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/cf/6a/EG01Caem_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>在安装步骤中编辑的「应用设置」的部分，请参照以下配置进行填写</p> 
</blockquote> 
<pre><code class="prism language-powershell">以下方式gateway使用nodeport方式访问
<span class="token comment">#</span>
<span class="token comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="token comment"># contributor license agreements.  See the NOTICE file distributed with</span>
<span class="token comment"># this work for additional information regarding copyright ownership.</span>
<span class="token comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="token comment"># (the "License"); you may not use this file except in compliance with</span>
<span class="token comment"># the License.  You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>

global:
  <span class="token comment"># e.g.</span>
  <span class="token comment"># imagePullSecrets:</span>
  <span class="token comment">#   - my-registry-secrets</span>
  <span class="token comment">#   - other-registry-secrets</span>
  <span class="token comment">#</span>
  imagePullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>

apisix:
  <span class="token comment"># Enable or disable Apache APISIX itself</span>
  <span class="token comment"># Set it to false and ingress-controller.enabled=true will deploy only ingress-controller</span>
  enabled: true

  <span class="token comment"># Enable nginx IPv6 resolver</span>
  enableIPv6: true

  <span class="token comment"># Whether the APISIX version number should be shown in Server header</span>
  enableServerTokens: true

  <span class="token comment"># Use Pod metadata.uid as the APISIX id.</span>
  setIDFromPodUID: false

  customLuaSharedDicts: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># - name: foo</span>
    <span class="token comment">#   size: 10k</span>
    <span class="token comment"># - name: bar</span>
    <span class="token comment">#   size: 1m</span>
  luaModuleHook:
    enabled: false
    <span class="token comment"># extend lua_package_path to load third party code</span>
    luaPath: <span class="token string">""</span>
    <span class="token comment"># the hook module which will be used to inject third party code into APISIX</span>
    <span class="token comment"># use the lua require style like: "module.say_hello"</span>
    hookPoint: <span class="token string">""</span>
    <span class="token comment"># configmap that stores the codes</span>
    configMapRef:
      name: <span class="token string">""</span>
      <span class="token comment"># mounts decides how to mount the codes to the container.</span>
      mounts:
        <span class="token operator">-</span> key: <span class="token string">""</span>
          path: <span class="token string">""</span>

  <span class="token comment"># Defines how apisix handles routing:</span>
  <span class="token comment"># - radixtree_uri: match route by uri(base on radixtree)</span>
  <span class="token comment"># - radixtree_host_uri: match route by host + uri(base on radixtree)</span>
  <span class="token comment"># - radixtree_uri_with_parameter: match route by uri with parameters</span>
  httpRouter: radixtree_uri

  enableCustomizedConfig: false
  customizedConfig: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  image:
    repository: apache/apisix
    pullPolicy: IfNotPresent
    <span class="token comment"># Overrides the image tag whose default is the chart appVersion.</span>
    tag: 2<span class="token punctuation">.</span>15<span class="token punctuation">.</span>0-alpine

  <span class="token comment"># Use a `DaemonSet` or `Deployment`</span>
  kind: Deployment
  <span class="token comment"># kind is DaemonSet, replicaCount not become effective</span>
  replicaCount: 1

  priorityClassName: <span class="token string">""</span>
  podAnnotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  podSecurityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># fsGroup: 2000</span>
  securityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># capabilities:</span>
    <span class="token comment">#   drop:</span>
    <span class="token comment">#   - ALL</span>
    <span class="token comment"># readOnlyRootFilesystem: true</span>
    <span class="token comment"># runAsNonRoot: true</span>
    <span class="token comment"># runAsUser: 1000</span>

  <span class="token comment"># See https://kubernetes.io/docs/tasks/run-application/configure-pdb/ for more details</span>
  podDisruptionBudget:
    enabled: false
    minAvailable: 90%
    maxUnavailable: 1

  resources: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># We usually recommend not to specify default resources and to leave this as a conscious</span>
    <span class="token comment"># choice for the user. This also increases chances charts run on environments with little</span>
    <span class="token comment"># resources, such as Minikube. If you do want to specify resources, uncomment the following</span>
    <span class="token comment"># lines, adjust them as necessary, and remove the curly braces after 'resources:'.</span>
    <span class="token comment"># limits:</span>
    <span class="token comment">#   cpu: 100m</span>
    <span class="token comment">#   memory: 128Mi</span>
    <span class="token comment"># requests:</span>
    <span class="token comment">#   cpu: 100m</span>
    <span class="token comment">#   memory: 128Mi</span>
  hostNetwork: false

  nodeSelector: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  tolerations: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  affinity: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token comment"># timezone is the timezone where apisix uses.</span>
  <span class="token comment"># For example: "UTC" or "Asia/Shanghai"</span>
  <span class="token comment"># This value will be set on apisix container's environment variable TZ.</span>
  <span class="token comment"># You may need to set the timezone to be consistent with your local time zone,</span>
  <span class="token comment"># otherwise the apisix's logs may used to retrieve event maybe in wrong timezone.</span>
  timezone: <span class="token string">""</span>

  <span class="token comment"># extraEnvVars An array to add extra env vars</span>
  <span class="token comment"># e.g:</span>
  <span class="token comment"># extraEnvVars:</span>
  <span class="token comment">#   - name: FOO</span>
  <span class="token comment">#     value: "bar"</span>
  <span class="token comment">#   - name: FOO2</span>
  <span class="token comment">#     valueFrom:</span>
  <span class="token comment">#       secretKeyRef:</span>
  <span class="token comment">#         name: SECRET_NAME</span>
  <span class="token comment">#         key: KEY</span>
  extraEnvVars: <span class="token punctuation">[</span><span class="token punctuation">]</span>

nameOverride: <span class="token string">""</span>
fullnameOverride: <span class="token string">""</span>

serviceAccount:
  create: false
  annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  name: <span class="token string">""</span>

rbac:
  create: false

gateway:
  <span class="token function">type</span>: NodePort  注意此处，现在默认是NodePort类型，后期可修改。
  <span class="token comment"># If you want to keep the client source IP, you can set this to Local.</span>
  <span class="token comment"># ref: https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip</span>
  externalTrafficPolicy: Cluster
  <span class="token comment"># type: LoadBalancer</span>
  <span class="token comment"># annotations:</span>
  <span class="token comment">#   service.beta.kubernetes.io/aws-load-balancer-type: nlb</span>
  externalIPs: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  http:
    enabled: true
    servicePort: 80
    containerPort: 9080
  tls:
    enabled: false
    servicePort: 443
    containerPort: 9443
    existingCASecret: <span class="token string">""</span>
    certCAFilename: <span class="token string">""</span>
    http2:
      enabled: true
    sslProtocols: <span class="token string">"TLSv1.2 TLSv1.3"</span>
  <span class="token comment"># L4 proxy (TCP/UDP)</span>
  stream:
    enabled: false
    only: false
    tcp: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    udp: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  ingress:
    enabled: false
    annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      <span class="token comment"># kubernetes.io/ingress.class: nginx</span>
      <span class="token comment"># kubernetes.io/tls-acme: "true"</span>
    hosts:
      <span class="token operator">-</span> host: apisix<span class="token punctuation">.</span>local
        paths: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    tls: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">#  - secretName: apisix-tls</span>
  <span class="token comment">#    hosts:</span>
  <span class="token comment">#      - chart-example.local</span>

admin:
  <span class="token comment"># Enable Admin API</span>
  enabled: true
  <span class="token comment"># admin service type</span>
  <span class="token function">type</span>: ClusterIP
  <span class="token comment"># loadBalancerIP: a.b.c.d</span>
  <span class="token comment"># loadBalancerSourceRanges:</span>
  <span class="token comment">#   - "143.231.0.0/16"</span>
  externalIPs: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">#</span>
  port: 9180
  servicePort: 9180
  <span class="token comment"># Admin API support CORS response headers</span>
  cors: true
  <span class="token comment"># Admin API credentials</span>
  credentials:
    admin: edd1c9f034335f136f87ad84b625c8f1
    viewer: 4054f7cf07e344346cd3f287985e76a2

  allow:
    <span class="token comment"># The client IP CIDR allowed to access Apache APISIX Admin API service.</span>
    ipList:
      <span class="token operator">-</span> 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/0 修改后可以在任意节点访问

nginx:
  workerRlimitNofile: <span class="token string">"20480"</span>
  workerConnections: <span class="token string">"10620"</span>
  workerProcesses: auto
  enableCPUAffinity: true
  envs: <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># APISIX plugins to be enabled</span>
plugins:
  <span class="token operator">-</span> api-breaker
  <span class="token operator">-</span> authz-keycloak
  <span class="token operator">-</span> basic-auth
  <span class="token operator">-</span> batch-requests
  <span class="token operator">-</span> consumer-restriction
  <span class="token operator">-</span> cors
  <span class="token operator">-</span> <span class="token function">echo</span>
  <span class="token operator">-</span> fault-injection
  <span class="token operator">-</span> file-logger
  <span class="token operator">-</span> grpc-transcode
  <span class="token operator">-</span> hmac-auth
  <span class="token operator">-</span> http-logger
  <span class="token operator">-</span> ip-restriction
  <span class="token operator">-</span> ua-restriction
  <span class="token operator">-</span> jwt-auth
  <span class="token operator">-</span> kafka-logger
  <span class="token operator">-</span> key-auth
  <span class="token operator">-</span> <span class="token function">limit-conn</span>
  <span class="token operator">-</span> <span class="token function">limit-count</span>
  <span class="token operator">-</span> <span class="token function">limit-req</span>
  <span class="token operator">-</span> node-status
  <span class="token operator">-</span> openid-connect
  <span class="token operator">-</span> authz-casbin
  <span class="token operator">-</span> prometheus
  <span class="token operator">-</span> proxy-cache
  <span class="token operator">-</span> proxy-mirror
  <span class="token operator">-</span> proxy-rewrite
  <span class="token operator">-</span> redirect
  <span class="token operator">-</span> referer-restriction
  <span class="token operator">-</span> <span class="token function">request-id</span>
  <span class="token operator">-</span> <span class="token function">request-validation</span>
  <span class="token operator">-</span> response-rewrite
  <span class="token operator">-</span> serverless-post-<span class="token keyword">function</span>
  <span class="token operator">-</span> serverless-pre-<span class="token keyword">function</span>
  <span class="token operator">-</span> <span class="token function">sls</span><span class="token operator">-</span>logger
  <span class="token operator">-</span> syslog
  <span class="token operator">-</span> tcp-logger
  <span class="token operator">-</span> udp-logger
  <span class="token operator">-</span> uri-blocker
  <span class="token operator">-</span> wolf-rbac
  <span class="token operator">-</span> zipkin
  <span class="token operator">-</span> traffic-split
  <span class="token operator">-</span> gzip
  <span class="token operator">-</span> real-ip
  <span class="token operator">-</span> ext-plugin-pre-req
  <span class="token operator">-</span> ext-plugin-post-req
  <span class="token operator">-</span> server-info  添加此行，以便配合dashboard展示服务信息
stream_plugins:
  <span class="token operator">-</span> mqtt-proxy
  <span class="token operator">-</span> ip-restriction
  <span class="token operator">-</span> <span class="token function">limit-conn</span>

pluginAttrs: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

extPlugin:
  enabled: false
  cmd: <span class="token punctuation">[</span><span class="token string">"/path/to/apisix-plugin-runner/runner"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">]</span>

wasmPlugins:
  enabled: false
  plugins: <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># customPlugins allows you to mount your own HTTP plugins.</span>
customPlugins:
  enabled: false
  <span class="token comment"># the lua_path that tells APISIX where it can find plugins,</span>
  <span class="token comment"># note the last ';' is required.</span>
  luaPath: <span class="token string">"/opts/custom_plugins/?.lua"</span>
  plugins:
    <span class="token comment"># plugin name.</span>
    <span class="token operator">-</span> name: <span class="token string">"prometheus"</span>   填写插件名称
      <span class="token comment"># plugin attrs</span>
      attrs:   添加如下内容
        export_addr:
        ip: 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
        port: 9091
      <span class="token comment"># plugin codes can be saved inside configmap object.</span>
      configMap:
        <span class="token comment"># name of configmap.</span>
        name: <span class="token string">"prometheus"</span> 填写configmap名称
        <span class="token comment"># since keys in configmap is flat, mountPath allows to define the mount</span>
        <span class="token comment"># path, so that plugin codes can be mounted hierarchically.</span>
        mounts:
          <span class="token operator">-</span> key: <span class="token string">""</span>
            path: <span class="token string">""</span>
          <span class="token operator">-</span> key: <span class="token string">""</span>
            path: <span class="token string">""</span>

updateStrategy: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token comment"># type: RollingUpdate</span>

extraVolumes: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># - name: extras</span>
<span class="token comment">#   emptyDir: {}</span>

extraVolumeMounts: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># - name: extras</span>
<span class="token comment">#   mountPath: /usr/share/extras</span>
<span class="token comment">#   readOnly: true</span>

extraInitContainers: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># - name: init-myservice</span>
<span class="token comment">#   image: busybox:1.28</span>
<span class="token comment">#   command: ['sh', '-c', "until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done"]</span>

discovery:
  enabled: false
  registry: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># Integration service discovery registry. E.g eureka\dns\nacos\consul_kv</span>
    <span class="token comment"># reference:</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/#configuration-for-eureka</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/dns/#service-discovery-via-dns</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/consul_kv/#configuration-for-consul-kv</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/nacos/#configuration-for-nacos</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/kubernetes/#configuration</span>
    <span class="token comment">#</span>
    <span class="token comment"># an eureka example:</span>
    <span class="token comment"># ```</span>
    <span class="token comment"># eureka:</span>
    <span class="token comment">#   host:</span>
    <span class="token comment">#     - "http://${username}:${password}@${eureka_host1}:${eureka_port1}"</span>
    <span class="token comment">#     - "http://${username}:${password}@${eureka_host2}:${eureka_port2}"</span>
    <span class="token comment">#   prefix: "/eureka/"</span>
    <span class="token comment">#   fetch_interval: 30</span>
    <span class="token comment">#   weight: 100</span>
    <span class="token comment">#   timeout:</span>
    <span class="token comment">#     connect: 2000</span>
    <span class="token comment">#     send: 2000</span>
    <span class="token comment">#     read: 5000</span>
    <span class="token comment"># ```</span>
    <span class="token comment">#</span>
    <span class="token comment"># the minimal Kubernetes example:</span>
    <span class="token comment"># ```</span>
    <span class="token comment"># kubernetes: {}</span>
    <span class="token comment"># ```</span>
    <span class="token comment">#</span>
    <span class="token comment"># The prerequisites for the above minimal Kubernetes example:</span>
    <span class="token comment">#  1. [Optional] Set `.serviceAccount.create` to `true` to create a dedicated ServiceAccount.</span>
    <span class="token comment">#     It is recommended to do so, otherwise the default ServiceAccount "default" will be used.</span>
    <span class="token comment">#  2. [Required] Set `.rbac.create` to `true` to create and bind the necessary RBAC resources.</span>
    <span class="token comment">#     This grants the ServiceAccount in use to List-Watch Kubernetes Endpoints resources.</span>
    <span class="token comment">#  3. [Required] Include the following environment variables in `.nginx.envs` to pass them into</span>
    <span class="token comment">#     nginx worker processes (https://nginx.org/en/docs/ngx_core_module.html#env):</span>
    <span class="token comment">#      - KUBERNETES_SERVICE_HOST</span>
    <span class="token comment">#      - KUBERNETES_SERVICE_PORT</span>
    <span class="token comment">#     This is for allowing the default `host` and `port` of `.discovery.registry.kubernetes.service`.</span>

<span class="token comment"># access log and error log configuration</span>
logs:
  enableAccessLog: true
  accessLog: <span class="token string">"/dev/stdout"</span>
  accessLogFormat: <span class="token string">'$remote_addr - $remote_user [$time_local] $http_host \"$request\" $status $body_bytes_sent $request_time \"$http_referer\" \"$http_user_agent\" $upstream_addr $upstream_status $upstream_response_time \"$upstream_scheme://$upstream_host$upstream_uri\"'</span>
  accessLogFormatEscape: default
  errorLog: <span class="token string">"/dev/stderr"</span>
  errorLogLevel: <span class="token string">"warn"</span>

dns:
  resolvers:
    <span class="token operator">-</span> 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1
    <span class="token operator">-</span> 172<span class="token punctuation">.</span>20<span class="token punctuation">.</span>0<span class="token punctuation">.</span>10
    <span class="token operator">-</span> 114<span class="token punctuation">.</span>114<span class="token punctuation">.</span>114<span class="token punctuation">.</span>114
    <span class="token operator">-</span> 223<span class="token punctuation">.</span>5<span class="token punctuation">.</span>5<span class="token punctuation">.</span>5
    <span class="token operator">-</span> 1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1
    <span class="token operator">-</span> 8<span class="token punctuation">.</span>8<span class="token punctuation">.</span>8<span class="token punctuation">.</span>8
  validity: 30
  timeout: 5

initContainer:
  image: busybox
  tag: 1<span class="token punctuation">.</span>28

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

<span class="token comment"># Custom configuration snippet.</span>
configurationSnippet:
  main: <span class="token punctuation">|</span>

  httpStart: <span class="token punctuation">|</span>

  httpEnd: <span class="token punctuation">|</span>

  httpSrv: <span class="token punctuation">|</span>

  httpAdmin: <span class="token punctuation">|</span>

  stream: <span class="token punctuation">|</span>

<span class="token comment"># Observability configuration.</span>
<span class="token comment"># ref: https://apisix.apache.org/docs/apisix/plugins/prometheus/</span>
serviceMonitor:
  enabled: true 开启
  <span class="token comment"># namespace where the serviceMonitor is deployed, by default, it is the same as the namespace of the apisix</span>
  namespace: <span class="token string">"apisix-system"</span> 填写命名空间
  <span class="token comment"># name of the serviceMonitor, by default, it is the same as the apisix fullname</span>
  name: <span class="token string">""</span>
  <span class="token comment"># interval at which metrics should be scraped</span>
  interval: 15s
  <span class="token comment"># path of the metrics endpoint</span>
  path: <span class="token operator">/</span>apisix/prometheus/metrics
  <span class="token comment"># prefix of the metrics</span>
  metricPrefix: apisix_
  <span class="token comment"># container port where the metrics are exposed</span>
  containerPort: 9091
  <span class="token comment"># @param serviceMonitor.labels ServiceMonitor extra labels</span>
  labels: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token comment"># @param serviceMonitor.annotations ServiceMonitor annotations</span>
  annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment"># etcd configuration</span>
<span class="token comment"># use the FQDN address or the IP of the etcd</span>
etcd:
  <span class="token comment"># install etcd(v3) by default, set false if do not want to install etcd(v3) together</span>
  enabled: true
  host:
    <span class="token comment"># host or ip e.g. http://172.20.128.89:2379</span>
    <span class="token operator">-</span> http:<span class="token operator">/</span><span class="token operator">/</span>etcd<span class="token punctuation">.</span>host:2379
  prefix: <span class="token string">"/apisix"</span>
  timeout: 30

  <span class="token comment"># if etcd.enabled is true, set more values of bitnami/etcd helm chart</span>
  auth:
    rbac:
      <span class="token comment"># No authentication by default</span>
      create: false
      user: <span class="token string">""</span>
      password: <span class="token string">""</span>
    tls:
      enabled: false
      existingSecret: <span class="token string">""</span>
      certFilename: <span class="token string">""</span>
      certKeyFilename: <span class="token string">""</span>
      verify: true
      sni: <span class="token string">""</span>

  service:
    port: 2379

  replicaCount: 1

dashboard:   开启并添加如下内容<span class="token punctuation">,</span>实现访问
  enabled: true
  service:
    <span class="token function">type</span>: NodePort

ingress-controller:     开启并添加如下内容，实现监控。
  enabled: true
  config:
    apisix:
      serviceNamespace: apisix-system
  ServiceMonitor:
    enabled: true
    namespace: <span class="token string">'apisix-system'</span>
    interval: 15s

vault:
  enabled: false
  host: <span class="token string">""</span>
  timeout: 10
  token: <span class="token string">""</span>
  prefix: <span class="token string">""</span>
</code></pre> 
<pre><code class="prism language-powershell">以下内容gateway带有openELB分配IP地址功能：
<span class="token comment">#</span>
<span class="token comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="token comment"># contributor license agreements.  See the NOTICE file distributed with</span>
<span class="token comment"># this work for additional information regarding copyright ownership.</span>
<span class="token comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="token comment"># (the "License"); you may not use this file except in compliance with</span>
<span class="token comment"># the License.  You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>

global:
  <span class="token comment"># e.g.</span>
  <span class="token comment"># imagePullSecrets:</span>
  <span class="token comment">#   - my-registry-secrets</span>
  <span class="token comment">#   - other-registry-secrets</span>
  <span class="token comment">#</span>
  imagePullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>

apisix:
  <span class="token comment"># Enable or disable Apache APISIX itself</span>
  <span class="token comment"># Set it to false and ingress-controller.enabled=true will deploy only ingress-controller</span>
  enabled: true

  <span class="token comment"># Enable nginx IPv6 resolver</span>
  enableIPv6: true

  <span class="token comment"># Whether the APISIX version number should be shown in Server header</span>
  enableServerTokens: true

  <span class="token comment"># Use Pod metadata.uid as the APISIX id.</span>
  setIDFromPodUID: false

  customLuaSharedDicts: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># - name: foo</span>
    <span class="token comment">#   size: 10k</span>
    <span class="token comment"># - name: bar</span>
    <span class="token comment">#   size: 1m</span>
  luaModuleHook:
    enabled: false
    <span class="token comment"># extend lua_package_path to load third party code</span>
    luaPath: <span class="token string">""</span>
    <span class="token comment"># the hook module which will be used to inject third party code into APISIX</span>
    <span class="token comment"># use the lua require style like: "module.say_hello"</span>
    hookPoint: <span class="token string">""</span>
    <span class="token comment"># configmap that stores the codes</span>
    configMapRef:
      name: <span class="token string">""</span>
      <span class="token comment"># mounts decides how to mount the codes to the container.</span>
      mounts:
        <span class="token operator">-</span> key: <span class="token string">""</span>
          path: <span class="token string">""</span>

  <span class="token comment"># Defines how apisix handles routing:</span>
  <span class="token comment"># - radixtree_uri: match route by uri(base on radixtree)</span>
  <span class="token comment"># - radixtree_host_uri: match route by host + uri(base on radixtree)</span>
  <span class="token comment"># - radixtree_uri_with_parameter: match route by uri with parameters</span>
  httpRouter: radixtree_uri

  enableCustomizedConfig: false
  customizedConfig: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  image:
    repository: apache/apisix
    pullPolicy: IfNotPresent
    <span class="token comment"># Overrides the image tag whose default is the chart appVersion.</span>
    tag: 2<span class="token punctuation">.</span>15<span class="token punctuation">.</span>0-alpine

  <span class="token comment"># Use a `DaemonSet` or `Deployment`</span>
  kind: Deployment
  <span class="token comment"># kind is DaemonSet, replicaCount not become effective</span>
  replicaCount: 1

  priorityClassName: <span class="token string">""</span>
  podAnnotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  podSecurityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># fsGroup: 2000</span>
  securityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># capabilities:</span>
    <span class="token comment">#   drop:</span>
    <span class="token comment">#   - ALL</span>
    <span class="token comment"># readOnlyRootFilesystem: true</span>
    <span class="token comment"># runAsNonRoot: true</span>
    <span class="token comment"># runAsUser: 1000</span>

  <span class="token comment"># See https://kubernetes.io/docs/tasks/run-application/configure-pdb/ for more details</span>
  podDisruptionBudget:
    enabled: false
    minAvailable: 90%
    maxUnavailable: 1

  resources: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># We usually recommend not to specify default resources and to leave this as a conscious</span>
    <span class="token comment"># choice for the user. This also increases chances charts run on environments with little</span>
    <span class="token comment"># resources, such as Minikube. If you do want to specify resources, uncomment the following</span>
    <span class="token comment"># lines, adjust them as necessary, and remove the curly braces after 'resources:'.</span>
    <span class="token comment"># limits:</span>
    <span class="token comment">#   cpu: 100m</span>
    <span class="token comment">#   memory: 128Mi</span>
    <span class="token comment"># requests:</span>
    <span class="token comment">#   cpu: 100m</span>
    <span class="token comment">#   memory: 128Mi</span>
  hostNetwork: false

  nodeSelector: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  tolerations: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  affinity: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token comment"># timezone is the timezone where apisix uses.</span>
  <span class="token comment"># For example: "UTC" or "Asia/Shanghai"</span>
  <span class="token comment"># This value will be set on apisix container's environment variable TZ.</span>
  <span class="token comment"># You may need to set the timezone to be consistent with your local time zone,</span>
  <span class="token comment"># otherwise the apisix's logs may used to retrieve event maybe in wrong timezone.</span>
  timezone: <span class="token string">"Asia/Shanghai"</span>

  <span class="token comment"># extraEnvVars An array to add extra env vars</span>
  <span class="token comment"># e.g:</span>
  <span class="token comment"># extraEnvVars:</span>
  <span class="token comment">#   - name: FOO</span>
  <span class="token comment">#     value: "bar"</span>
  <span class="token comment">#   - name: FOO2</span>
  <span class="token comment">#     valueFrom:</span>
  <span class="token comment">#       secretKeyRef:</span>
  <span class="token comment">#         name: SECRET_NAME</span>
  <span class="token comment">#         key: KEY</span>
  extraEnvVars: <span class="token punctuation">[</span><span class="token punctuation">]</span>

nameOverride: <span class="token string">""</span>
fullnameOverride: <span class="token string">""</span>

serviceAccount:
  create: false
  annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  name: <span class="token string">""</span>

rbac:
  create: false

gateway:
  <span class="token comment"># type: NodePort</span>
  <span class="token comment"># If you want to keep the client source IP, you can set this to Local.</span>
  <span class="token comment"># ref: https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip</span>
  externalTrafficPolicy: Cluster
  <span class="token function">type</span>: LoadBalancer
  annotations:
    lb<span class="token punctuation">.</span>kubesphere<span class="token punctuation">.</span>io/v1alpha1: openelb
    protocol<span class="token punctuation">.</span>openelb<span class="token punctuation">.</span>kubesphere<span class="token punctuation">.</span>io/v1alpha1: layer2
    eip<span class="token punctuation">.</span>openelb<span class="token punctuation">.</span>kubesphere<span class="token punctuation">.</span>io/v1alpha2: layer2-eip
  externalIPs: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  http:
    enabled: true
    servicePort: 80
    containerPort: 9080
  tls:
    enabled: false
    servicePort: 443
    containerPort: 9443
    existingCASecret: <span class="token string">""</span>
    certCAFilename: <span class="token string">""</span>
    http2:
      enabled: true
    sslProtocols: <span class="token string">"TLSv1.2 TLSv1.3"</span>
  <span class="token comment"># L4 proxy (TCP/UDP)</span>
  stream:
    enabled: false
    only: false
    tcp: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    udp: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  ingress:
    enabled: false
    annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      <span class="token comment"># kubernetes.io/ingress.class: nginx</span>
      <span class="token comment"># kubernetes.io/tls-acme: "true"</span>
    hosts:
      <span class="token operator">-</span> host: apisix<span class="token punctuation">.</span>local
        paths: <span class="token punctuation">[</span><span class="token punctuation">]</span>
    tls: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">#  - secretName: apisix-tls</span>
  <span class="token comment">#    hosts:</span>
  <span class="token comment">#      - chart-example.local</span>

admin:
  <span class="token comment"># Enable Admin API</span>
  enabled: true
  <span class="token comment"># admin service type</span>
  <span class="token function">type</span>: ClusterIP
  <span class="token comment"># loadBalancerIP: a.b.c.d</span>
  <span class="token comment"># loadBalancerSourceRanges:</span>
  <span class="token comment">#   - "143.231.0.0/16"</span>
  externalIPs: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">#</span>
  port: 9180
  servicePort: 9180
  <span class="token comment"># Admin API support CORS response headers</span>
  cors: true
  <span class="token comment"># Admin API credentials</span>
  credentials:
    admin: edd1c9f034335f136f87ad84b625c8f1
    viewer: 4054f7cf07e344346cd3f287985e76a2

  allow:
    <span class="token comment"># The client IP CIDR allowed to access Apache APISIX Admin API service.</span>
    ipList:
      <span class="token operator">-</span> 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/0

nginx:
  workerRlimitNofile: <span class="token string">"20480"</span>
  workerConnections: <span class="token string">"10620"</span>
  workerProcesses: auto
  enableCPUAffinity: true
  envs: <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># APISIX plugins to be enabled</span>
plugins:
  <span class="token operator">-</span> api-breaker
  <span class="token operator">-</span> authz-keycloak
  <span class="token operator">-</span> basic-auth
  <span class="token operator">-</span> batch-requests
  <span class="token operator">-</span> consumer-restriction
  <span class="token operator">-</span> cors
  <span class="token operator">-</span> <span class="token function">echo</span>
  <span class="token operator">-</span> fault-injection
  <span class="token operator">-</span> file-logger
  <span class="token operator">-</span> grpc-transcode
  <span class="token operator">-</span> hmac-auth
  <span class="token operator">-</span> http-logger
  <span class="token operator">-</span> ip-restriction
  <span class="token operator">-</span> ua-restriction
  <span class="token operator">-</span> jwt-auth
  <span class="token operator">-</span> kafka-logger
  <span class="token operator">-</span> key-auth
  <span class="token operator">-</span> <span class="token function">limit-conn</span>
  <span class="token operator">-</span> <span class="token function">limit-count</span>
  <span class="token operator">-</span> <span class="token function">limit-req</span>
  <span class="token operator">-</span> node-status
  <span class="token operator">-</span> openid-connect
  <span class="token operator">-</span> authz-casbin
  <span class="token operator">-</span> prometheus
  <span class="token operator">-</span> proxy-cache
  <span class="token operator">-</span> proxy-mirror
  <span class="token operator">-</span> proxy-rewrite
  <span class="token operator">-</span> redirect
  <span class="token operator">-</span> referer-restriction
  <span class="token operator">-</span> <span class="token function">request-id</span>
  <span class="token operator">-</span> <span class="token function">request-validation</span>
  <span class="token operator">-</span> response-rewrite
  <span class="token operator">-</span> serverless-post-<span class="token keyword">function</span>
  <span class="token operator">-</span> serverless-pre-<span class="token keyword">function</span>
  <span class="token operator">-</span> <span class="token function">sls</span><span class="token operator">-</span>logger
  <span class="token operator">-</span> syslog
  <span class="token operator">-</span> tcp-logger
  <span class="token operator">-</span> udp-logger
  <span class="token operator">-</span> uri-blocker
  <span class="token operator">-</span> wolf-rbac
  <span class="token operator">-</span> zipkin
  <span class="token operator">-</span> traffic-split
  <span class="token operator">-</span> gzip
  <span class="token operator">-</span> real-ip
  <span class="token operator">-</span> ext-plugin-pre-req
  <span class="token operator">-</span> ext-plugin-post-req
  <span class="token operator">-</span> server-info
stream_plugins:
  <span class="token operator">-</span> mqtt-proxy
  <span class="token operator">-</span> ip-restriction
  <span class="token operator">-</span> <span class="token function">limit-conn</span>

pluginAttrs: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

extPlugin:
  enabled: false
  cmd: <span class="token punctuation">[</span><span class="token string">"/path/to/apisix-plugin-runner/runner"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">]</span>

wasmPlugins:
  enabled: false
  plugins: <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># customPlugins allows you to mount your own HTTP plugins.</span>
customPlugins:
  enabled: false
  <span class="token comment"># the lua_path that tells APISIX where it can find plugins,</span>
  <span class="token comment"># note the last ';' is required.</span>
  luaPath: <span class="token string">"/opts/custom_plugins/?.lua"</span>
  plugins:
    <span class="token comment"># plugin name.</span>
    <span class="token operator">-</span> name: <span class="token string">"prometheus"</span>
      <span class="token comment"># plugin attrs</span>
      attrs:
        export_addr:
        ip: 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
        port: 9091
      <span class="token comment"># plugin codes can be saved inside configmap object.</span>
      configMap:
        <span class="token comment"># name of configmap.</span>
        name: <span class="token string">"prometheus"</span>
        <span class="token comment"># since keys in configmap is flat, mountPath allows to define the mount</span>
        <span class="token comment"># path, so that plugin codes can be mounted hierarchically.</span>
        mounts:
          <span class="token operator">-</span> key: <span class="token string">""</span>
            path: <span class="token string">""</span>
          <span class="token operator">-</span> key: <span class="token string">""</span>
            path: <span class="token string">""</span>

updateStrategy: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token comment"># type: RollingUpdate</span>

extraVolumes: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># - name: extras</span>
<span class="token comment">#   emptyDir: {}</span>

extraVolumeMounts: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># - name: extras</span>
<span class="token comment">#   mountPath: /usr/share/extras</span>
<span class="token comment">#   readOnly: true</span>

extraInitContainers: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># - name: init-myservice</span>
<span class="token comment">#   image: busybox:1.28</span>
<span class="token comment">#   command: ['sh', '-c', "until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done"]</span>

discovery:
  enabled: false
  registry: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># Integration service discovery registry. E.g eureka\dns\nacos\consul_kv</span>
    <span class="token comment"># reference:</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/#configuration-for-eureka</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/dns/#service-discovery-via-dns</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/consul_kv/#configuration-for-consul-kv</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/nacos/#configuration-for-nacos</span>
    <span class="token comment"># https://apisix.apache.org/docs/apisix/discovery/kubernetes/#configuration</span>
    <span class="token comment">#</span>
    <span class="token comment"># an eureka example:</span>
    <span class="token comment"># ```</span>
    <span class="token comment"># eureka:</span>
    <span class="token comment">#   host:</span>
    <span class="token comment">#     - "http://${username}:${password}@${eureka_host1}:${eureka_port1}"</span>
    <span class="token comment">#     - "http://${username}:${password}@${eureka_host2}:${eureka_port2}"</span>
    <span class="token comment">#   prefix: "/eureka/"</span>
    <span class="token comment">#   fetch_interval: 30</span>
    <span class="token comment">#   weight: 100</span>
    <span class="token comment">#   timeout:</span>
    <span class="token comment">#     connect: 2000</span>
    <span class="token comment">#     send: 2000</span>
    <span class="token comment">#     read: 5000</span>
    <span class="token comment"># ```</span>
    <span class="token comment">#</span>
    <span class="token comment"># the minimal Kubernetes example:</span>
    <span class="token comment"># ```</span>
    <span class="token comment"># kubernetes: {}</span>
    <span class="token comment"># ```</span>
    <span class="token comment">#</span>
    <span class="token comment"># The prerequisites for the above minimal Kubernetes example:</span>
    <span class="token comment">#  1. [Optional] Set `.serviceAccount.create` to `true` to create a dedicated ServiceAccount.</span>
    <span class="token comment">#     It is recommended to do so, otherwise the default ServiceAccount "default" will be used.</span>
    <span class="token comment">#  2. [Required] Set `.rbac.create` to `true` to create and bind the necessary RBAC resources.</span>
    <span class="token comment">#     This grants the ServiceAccount in use to List-Watch Kubernetes Endpoints resources.</span>
    <span class="token comment">#  3. [Required] Include the following environment variables in `.nginx.envs` to pass them into</span>
    <span class="token comment">#     nginx worker processes (https://nginx.org/en/docs/ngx_core_module.html#env):</span>
    <span class="token comment">#      - KUBERNETES_SERVICE_HOST</span>
    <span class="token comment">#      - KUBERNETES_SERVICE_PORT</span>
    <span class="token comment">#     This is for allowing the default `host` and `port` of `.discovery.registry.kubernetes.service`.</span>

<span class="token comment"># access log and error log configuration</span>
logs:
  enableAccessLog: true
  accessLog: <span class="token string">"/dev/stdout"</span>
  accessLogFormat: <span class="token string">'$remote_addr - $remote_user [$time_local] $http_host \"$request\" $status $body_bytes_sent $request_time \"$http_referer\" \"$http_user_agent\" $upstream_addr $upstream_status $upstream_response_time \"$upstream_scheme://$upstream_host$upstream_uri\"'</span>
  accessLogFormatEscape: default
  errorLog: <span class="token string">"/dev/stderr"</span>
  errorLogLevel: <span class="token string">"warn"</span>

dns:
  resolvers:
    <span class="token operator">-</span> 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1
    <span class="token operator">-</span> 172<span class="token punctuation">.</span>20<span class="token punctuation">.</span>0<span class="token punctuation">.</span>10
    <span class="token operator">-</span> 114<span class="token punctuation">.</span>114<span class="token punctuation">.</span>114<span class="token punctuation">.</span>114
    <span class="token operator">-</span> 223<span class="token punctuation">.</span>5<span class="token punctuation">.</span>5<span class="token punctuation">.</span>5
    <span class="token operator">-</span> 1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1
    <span class="token operator">-</span> 8<span class="token punctuation">.</span>8<span class="token punctuation">.</span>8<span class="token punctuation">.</span>8
  validity: 30
  timeout: 5

initContainer:
  image: busybox
  tag: 1<span class="token punctuation">.</span>28

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

<span class="token comment"># Custom configuration snippet.</span>
configurationSnippet:
  main: <span class="token punctuation">|</span>

  httpStart: <span class="token punctuation">|</span>

  httpEnd: <span class="token punctuation">|</span>

  httpSrv: <span class="token punctuation">|</span>

  httpAdmin: <span class="token punctuation">|</span>

  stream: <span class="token punctuation">|</span>

<span class="token comment"># Observability configuration.</span>
<span class="token comment"># ref: https://apisix.apache.org/docs/apisix/plugins/prometheus/</span>
serviceMonitor:
  enabled: true
  <span class="token comment"># namespace where the serviceMonitor is deployed, by default, it is the same as the namespace of the apisix</span>
  namespace: <span class="token string">"apisix-system"</span>
  <span class="token comment"># name of the serviceMonitor, by default, it is the same as the apisix fullname</span>
  name: <span class="token string">""</span>
  <span class="token comment"># interval at which metrics should be scraped</span>
  interval: 15s
  <span class="token comment"># path of the metrics endpoint</span>
  path: <span class="token operator">/</span>apisix/prometheus/metrics
  <span class="token comment"># prefix of the metrics</span>
  metricPrefix: apisix_
  <span class="token comment"># container port where the metrics are exposed</span>
  containerPort: 9091
  <span class="token comment"># @param serviceMonitor.labels ServiceMonitor extra labels</span>
  labels: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token comment"># @param serviceMonitor.annotations ServiceMonitor annotations</span>
  annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment"># etcd configuration</span>
<span class="token comment"># use the FQDN address or the IP of the etcd</span>
etcd:
  <span class="token comment"># install etcd(v3) by default, set false if do not want to install etcd(v3) together</span>
  enabled: true
  host:
    <span class="token comment"># host or ip e.g. http://172.20.128.89:2379</span>
    <span class="token operator">-</span> http:<span class="token operator">/</span><span class="token operator">/</span>etcd<span class="token punctuation">.</span>host:2379
  prefix: <span class="token string">"/apisix"</span>
  timeout: 30

  <span class="token comment"># if etcd.enabled is true, set more values of bitnami/etcd helm chart</span>
  auth:
    rbac:
      <span class="token comment"># No authentication by default</span>
      create: false
      user: <span class="token string">""</span>
      password: <span class="token string">""</span>
    tls:
      enabled: false
      existingSecret: <span class="token string">""</span>
      certFilename: <span class="token string">""</span>
      certKeyFilename: <span class="token string">""</span>
      verify: true
      sni: <span class="token string">""</span>

  service:
    port: 2379

  replicaCount: 1

dashboard:
  enabled: true
  service:
    <span class="token function">type</span>: NodePort

ingress-controller: 
  enabled: true
  config:
    apisix:
      serviceNamespace: apisix-system
  ServiceMonitor:
    enabled: true
    namespace: <span class="token string">'apisix-system'</span>
    interval: 15s

vault:
  enabled: false
  host: <span class="token string">""</span>
  timeout: 10
  token: <span class="token string">""</span>
  prefix: <span class="token string">""</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4d/bf/4TmIkA5C_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dc/ed/cQz3MChE_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>部署成功后，点击应用名称进入详情页面，可以在「资源状态」标签页下看到如下的服务部署和工作状态运行状态展示。</p> 
</blockquote> 
<h3><a id="23__Apache_APISIX_Dashboard__1068"></a>2.3 使用 Apache APISIX Dashboard 了解系统信息</h3> 
<p>Apache APISIX 应用部署完成后，首先我们通过 Apache APISIX Dashboard 来检验一下 Apache APISIX 网关的当前状态。从「应用负载」的「服务」页面，我们可以找到 <code>apisix-dashboard</code> 的服务，由于我们在应用配置中已经为 Dashboard 开启了 NodePort，所以这里我们可以直接通过 NodePort 端口来访问 Dashboard。</p> 
<p><img src="https://images2.imgbox.com/3e/b7/319iEEBF_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>使用默认的用户名及密码 <code>admin</code> 登录 Apache APISIX Dashboard，可以进入「系统信息」页面即可查看到我们当前连接管理的「Apache APISIX 节点」的信息。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/5e/10/Q6d1wXeP_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a5/86/yQl1XmIe_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_Apache_APISIX_Ingress_Controller_1093"></a>三、使用 Apache APISIX Ingress Controller</h2> 
<h3><a id="31__1097"></a>3.1 创建应用及服务</h3> 
<p><img src="https://images2.imgbox.com/16/71/w7wtmxEW_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a9/b2/cqGMM9yE_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/80/91/nhdUoN7c_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/42/33/KlvmNPvM_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/43/a3/tvdCylLc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/13/3f/VvNUcicD_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/06/65/8RKzVn7x_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/61/7Ji0rwLJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3a/78/IFxvPznj_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/06/d8/PTgyxZrA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32__1127"></a>3.2 创建应用路由</h3> 
<p><img src="https://images2.imgbox.com/fe/7d/nmlIspao_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c9/07/p4dOglZl_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ee/f0/b1N1BYdd_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b1/e4/oa7UBt8N_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>上图域名应该为 web1.msb.com</p> 
</blockquote> 
<p>其添加 <code>kubernetes.io/ingress.class</code>: <code>apisix</code> 的键值。</p> 
<p><img src="https://images2.imgbox.com/e1/08/BUAHp3LF_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e7/98/YhPykpdl_o.png" alt="在这里插入图片描述"></p> 
<p>创建完成后如何验证应用路由生效呢？首先，我们可以回到 Apache APISIX Dashboard，进入「路由」页面，可以看到新建的应用路由已经被 Apache APISIX Ingress Controller 识别之后自动添加到了 Apache APISIX 网关中，在「上游」页面也可以看到自动创建的一个上游条目。</p> 
<p><img src="https://images2.imgbox.com/10/92/KZhQvEyT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/59/1b/k8ef2MAJ_o.png" alt="在这里插入图片描述"></p> 
<p>然后我们回到 <code>apisix-system</code> 项目的「服务」页面，找到 <code>apisix-gateway</code> 服务对应的端口，由此访问 <code>&lt;应用路由指定的域名&gt;:&lt;apisix-gateway 外部访问端口&gt;</code>（例如此处为 <code>web1.msb.com:31532</code>）即可访问到 <code>kubemsb-web1-route</code> 应用路由所关联的后台服务。</p> 
<pre><code class="prism language-powershell">添加域名解析

<span class="token namespace">[root@dnsserver ~]</span><span class="token comment"># cat  /var/named/msb.com.zone</span>
<span class="token variable">$TTL</span> 1D
@       IN SOA  msb<span class="token punctuation">.</span>com admin<span class="token punctuation">.</span>msb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> <span class="token punctuation">(</span>
                                        0       <span class="token punctuation">;</span> serial
                                        1D      <span class="token punctuation">;</span> refresh
                                        1H      <span class="token punctuation">;</span> retry
                                        1W      <span class="token punctuation">;</span> expire
                                        3H <span class="token punctuation">)</span>    <span class="token punctuation">;</span> minimum
@       NS      ns<span class="token punctuation">.</span>msb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>
ns      A       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>145
harbor  A       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>146

web1    A       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>141  解析到集群节点IP地址

</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@dnsserver ~]</span><span class="token comment"># systemctl restart named</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@k8s-master01 ~]</span><span class="token comment"># curl http://web1.msb.com:31532</span>
&lt;<span class="token operator">!</span>DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;<span class="token operator">/</span>title&gt;
&lt;style&gt;
html <span class="token punctuation">{<!-- --></span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{<!-- --></span> width: 35em<span class="token punctuation">;</span> margin: 0 auto<span class="token punctuation">;</span>
font-family: Tahoma<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
&lt;<span class="token operator">/</span>style&gt;
&lt;<span class="token operator">/</span>head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;<span class="token operator">/</span>h1&gt;
&lt;p&gt;<span class="token keyword">If</span> you see this page<span class="token punctuation">,</span> the nginx web server is successfully installed and
working<span class="token punctuation">.</span> Further configuration is required<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>p&gt;

&lt;p&gt;<span class="token keyword">For</span> online documentation and support please refer to
&lt;a href=<span class="token string">"http://nginx.org/"</span>&gt;nginx<span class="token punctuation">.</span>org&lt;<span class="token operator">/</span>a&gt;<span class="token punctuation">.</span>&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="token string">"http://nginx.com/"</span>&gt;nginx<span class="token punctuation">.</span>com&lt;<span class="token operator">/</span>a&gt;<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="token keyword">for</span> <span class="token keyword">using</span> nginx<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>em&gt;&lt;<span class="token operator">/</span>p&gt;
&lt;<span class="token operator">/</span>body&gt;
&lt;<span class="token operator">/</span>html&gt;
</code></pre> 
<h2><a id="OpenELBApache_APISIX_1222"></a>四、使用OpenELB结合Apache APISIX实现访问</h2> 
<p><img src="https://images2.imgbox.com/27/8c/xQ8Llsy6_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a9/9f/7VNKNrLc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/eb/d0/Z2hNQo0X_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c7/0c/kohv9Ap5_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/12/30/zXB75uSE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/15/24/A4PAwiJ8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">    lb<span class="token punctuation">.</span>kubesphere<span class="token punctuation">.</span>io/v1alpha1: openelb
    protocol<span class="token punctuation">.</span>openelb<span class="token punctuation">.</span>kubesphere<span class="token punctuation">.</span>io/v1alpha1: layer2
    eip<span class="token punctuation">.</span>openelb<span class="token punctuation">.</span>kubesphere<span class="token punctuation">.</span>io/v1alpha2: layer2-eip
</code></pre> 
<p><img src="https://images2.imgbox.com/c8/4e/su7SI0l2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3a/54/t0Mg275z_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@dnsserver ~]</span><span class="token comment"># cat /var/named/msb.com.zone</span>
<span class="token variable">$TTL</span> 1D
@       IN SOA  msb<span class="token punctuation">.</span>com admin<span class="token punctuation">.</span>msb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> <span class="token punctuation">(</span>
                                        0       <span class="token punctuation">;</span> serial
                                        1D      <span class="token punctuation">;</span> refresh
                                        1H      <span class="token punctuation">;</span> retry
                                        1W      <span class="token punctuation">;</span> expire
                                        3H <span class="token punctuation">)</span>    <span class="token punctuation">;</span> minimum
@       NS      ns<span class="token punctuation">.</span>msb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>
ns      A       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>145
harbor  A       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>146
web1    A       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>72
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@dnsserver ~]</span><span class="token comment"># systemctl restart named</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@k8s-master01 ~]</span><span class="token comment"># curl http://web1.msb.com</span>
&lt;<span class="token operator">!</span>DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;<span class="token operator">/</span>title&gt;
&lt;style&gt;
html <span class="token punctuation">{<!-- --></span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{<!-- --></span> width: 35em<span class="token punctuation">;</span> margin: 0 auto<span class="token punctuation">;</span>
font-family: Tahoma<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
&lt;<span class="token operator">/</span>style&gt;
&lt;<span class="token operator">/</span>head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;<span class="token operator">/</span>h1&gt;
&lt;p&gt;<span class="token keyword">If</span> you see this page<span class="token punctuation">,</span> the nginx web server is successfully installed and
working<span class="token punctuation">.</span> Further configuration is required<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>p&gt;

&lt;p&gt;<span class="token keyword">For</span> online documentation and support please refer to
&lt;a href=<span class="token string">"http://nginx.org/"</span>&gt;nginx<span class="token punctuation">.</span>org&lt;<span class="token operator">/</span>a&gt;<span class="token punctuation">.</span>&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="token string">"http://nginx.com/"</span>&gt;nginx<span class="token punctuation">.</span>com&lt;<span class="token operator">/</span>a&gt;<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="token keyword">for</span> <span class="token keyword">using</span> nginx<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>em&gt;&lt;<span class="token operator">/</span>p&gt;
&lt;<span class="token operator">/</span>body&gt;
&lt;<span class="token operator">/</span>html&gt;
</code></pre> 
<h2><a id="_Apache_APISIX__1302"></a>五、自定义监控 Apache APISIX 网关</h2> 
<p>Apache APISIX 网关可用之后其实是缺少像原生集群或项目网关这样自带的状态监控能力的，但这个我们也可以通过 Apache APISIX 的 Prometheus 插件以及 KubeSphere 自带的自定义监控能力来弥补。</p> 
<h3><a id="51__Apache_APISIX__Prometheus__1310"></a>5.1 暴露 Apache APISIX 网关的 Prometheus 监控指标</h3> 
<p>由于我们在部署 Apache APISIX 应用时已经开启了 Prometheus 插件，所以这里我们只需要把 Prometheus 监控指标的接口暴露出来即可。进入 <code>apisix-system</code> 项目，在「工作负载」页面找到 <code>apisix</code> 并进入部署详情页面，随后在左侧操作面板的「更多操作」中选择「编辑设置」。</p> 
<p><img src="https://images2.imgbox.com/a7/30/HAUwlkSr_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c1/b8/ITbZY6Iu_o.png" alt="在这里插入图片描述"></p> 
<p>在弹出的「编辑设置」面板中，进入到 <code>apisix</code> 容器的编辑界面，找到「端口设置」，添加一个新的名为 <code>prom</code> 的端口映射到容器的 <code>9091</code> 端口，保存后 <code>apisix</code> 工作负载会重启。</p> 
<p><img src="https://images2.imgbox.com/1a/d8/PW324i2Z_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/50/36/f8yvCcfM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5a/47/3Q18hTGZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/68/5a/SimLCHPe_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="52__Apache_APISIX__ServiceMonitor_1338"></a>5.2 为 Apache APISIX 网关监控指标创建 ServiceMonitor</h3> 
<p>下面我们需要将已暴露的指标接口接入到 KubeSphere 自带的 Prometheus 中使之可被访问（被抓取指标数据），由于 KubeSphere 是通过 Prometheus Operator 来维护内部的 Prometheus 系统的，所以最方便的方式自然是直接创建一个 ServiceMonitor 资源来实现指标接口的接入。</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@k8s-master01 ~]</span><span class="token comment"># cat sm.yaml</span>

apiVersion: monitoring<span class="token punctuation">.</span>coreos<span class="token punctuation">.</span>com/v1
kind: ServiceMonitor
metadata:
  name: apisix
  namespace: apisix-system
spec:
  endpoints:
    <span class="token operator">-</span> scheme: http
      targetPort: prometheus
      path: <span class="token operator">/</span>apisix/prometheus/metrics
      interval: 15s
  namespaceSelector:
    matchNames:
      <span class="token operator">-</span> apisix-system
  selector:
    matchLabels:
      app<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/name: apisix
      app<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/version: 2<span class="token punctuation">.</span>15<span class="token punctuation">.</span>0
      helm<span class="token punctuation">.</span>sh/chart: apisix-0<span class="token punctuation">.</span>11<span class="token punctuation">.</span>2
</code></pre> 
<p>使用 <code>kubectl apply -f your_service_monitor.yaml</code> 创建这个 ServiceMonitor 资源。创建成功后，如果有集群管理权限，也可以在集群的 CRD 管理页面中搜索查看 ServiceMonitor 资源并找到名为 <code>apisix</code> 的自定义资源，也可以在这里做后续的 YAML 修改。</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@k8s-master01 ~]</span><span class="token comment"># kubectl apply -f sm.yaml</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f8/7e/1HgP5uG3_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/79/22/YJ82cA1X_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="53__Apache_APISIX__1384"></a>5.3 将 Apache APISIX 网关指标接入自定义监控面板</h3> 
<p>下面我们在项目左侧菜单列表中找到「监控告警」中的「自定义监控」，开始「创建」自定义监控面板。</p> 
<p><img src="https://images2.imgbox.com/15/f5/2vvjrbLz_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/18/6e/5G6FlXR0_o.png" alt="在这里插入图片描述"></p> 
<p>在弹出窗口中填入「名称」，选择「自定义」监控模版，并进入「下一步」的监控面板创建。</p> 
<p><img src="https://images2.imgbox.com/fa/d7/tpFU8biJ_o.png" alt="在这里插入图片描述"></p> 
<p>进入编辑页面后现在左侧点击 <code>+</code> 区域，在右侧的「数据」区域进行 Prometheus 监控指标的配置，例如这里我们可以用 <code>sum(apisix_nginx_http_current_connections)</code> 来统计 Apache APISIX 网关实时的连接总数。</p> 
<p><img src="https://images2.imgbox.com/b8/4d/toMz1q1B_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/33/78/biTEzBeX_o.png" alt="在这里插入图片描述"></p> 
<p>保存后在页面右下角找到「+ 添加监控项」，我们选择「折线图」来创建一个 <code>Nginx connection state</code> 指标：使用 <code>sum(apisix_nginx_http_current_connections) by (state)</code> 作为指标、<code>{<!-- -->{state}}</code> 用作图例名称、选择「图例类型」为堆叠图，即可得到类似如下的图表显示效果。保存模版后即可得到您的第一个自定义监控面板！</p> 
<p><img src="https://images2.imgbox.com/72/e6/TAWFj5IB_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/78/68/ueDsuXC2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/de/fd/GvWdBEXA_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/10/78/KsQJh6g4_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/7d/0a/JAgKtLST_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a6/b6/oaKPbMGY_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>Apache APISIX 网关目前提供的 Prometheus 指标可以参见官方文档的 可有的指标部分。</p> 
</blockquote> 
<p>由于指标配置起来还是比较麻烦的，推荐在集群层面的「自定义监控」中直接导入 Apache APISIX Grafana 模版（下载 JSON 通过「本地上传」进行导入）。</p> 
<blockquote> 
 <p>Apache APISIX Grafana 模版: <em>https://grafana.com/grafana/dashboards/11719</em></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/9d/3d/J0wbHgn0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c8/f0/5amy9Wjh_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/58/a3/8AMExqFx_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/4a/f1/5ymc79Th_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/72/d2/ugkeyxSD_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/30/30/XQNZMGin_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b9/d4/gVkafryX_o.png" alt="在这里插入图片描述"></p> 
<p>参考：https://blog.csdn.net/alex_yangchuansheng/article/details/121600884</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/34ca10cea5309efc9678aeb20dd8d0d4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">k8s集群中部署微服务项目前端代理服务 Nginx</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f19e571f50383b79b5fc44e5b58bf02f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue3使用vis绘制甘特图制作timeline可拖动时间轴，时间轴中文化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>