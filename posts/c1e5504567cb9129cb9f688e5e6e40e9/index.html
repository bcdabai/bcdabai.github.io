<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android Framework å¸¸è§è§£å†³æ–¹æ¡ˆï¼ˆ25-2ï¼‰å®šåˆ¶CPUSETè§£å†³æ–¹æ¡ˆ-systemä¿®æ”¹åŠç¼–è¯‘éƒ¨åˆ†è°ƒæ•´ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android Framework å¸¸è§è§£å†³æ–¹æ¡ˆï¼ˆ25-2ï¼‰å®šåˆ¶CPUSETè§£å†³æ–¹æ¡ˆ-systemä¿®æ”¹åŠç¼–è¯‘éƒ¨åˆ†è°ƒæ•´" />
<meta property="og:description" content="1 åŸç†è¯´æ˜ è¿™ä¸ªæ–¹æ¡ˆæœ‰å¦‚ä¸‹åŸºæœ¬éœ€æ±‚ï¼š
æ„å»ºè‡ªå®šä¹‰CPUSETï¼Œ/dev/cpusetä¸­åŒ…å«ä¸€ä¸ªå…¨æ–°çš„cpusetåˆ†ç»„ã€‚ä¸”å¯ä»¥é€šè¿‡set_cpuset_policyå’Œset_sched_policyæ¥å£å¯ä»¥è®¾ç½®è‡ªå®šä¹‰CPUSETã€‚å¼€æœºå¯åŠ¨åå¯ä»¥é€šè¿‡zygoteåˆ¤å®šæ¥å¯¹ç‰¹å®šçš„åº”ç”¨è¿›ç¨‹è®¾ç½®CPUSETï¼Œå¹¶ä¸€ç›´ä¿æŒï¼Œä¸”ä¿è¯è‡ªå®šä¹‰CPUSETä¸å—å…¶ä»–CPUSETå½±å“ï¼ŒæŒç»­ç‹¬ç«‹ã€‚ åŸç†ä¸Šå› ä¸ºä¿®æ”¹ä»£ç æ¶‰åŠéƒ¨åˆ†è¾ƒå¤šï¼Œå› æ­¤å…±åˆ†3ä¸ªéƒ¨åˆ†ï¼š
frameworkä¿®æ”¹ï¼šæ·»åŠ SCHED GROUPå’ŒTHREAD GROUPï¼ˆTHREAD_GROUP_å¯¹åº”SP_ï¼‰çš„æ”¯æŒï¼Œä¸”æ”¯æŒå¼€æœºå¯åŠ¨åç›´æ¥è®¾ç½®ã€‚applyOomAdjLSPçš„åˆ¤å®šä¿æŒä¸å˜ã€‚systemä¿®æ”¹ï¼šæ·»åŠ SP_CUSTOMçš„æ”¯æŒåŠset_cpuset_policyå’Œset_sched_policyæ¥å£ç­‰æ”¯æŒï¼ŒåŒæ—¶ä¿®æ”¹task_profiles.jsonï¼Œæ·»åŠ SP_CUSTOM CPUSETçš„æ”¯æŒã€‚init.rcä¿®æ”¹åŠç¼–è¯‘éƒ¨åˆ†è°ƒæ•´ï¼šå¯¹è‡ªå®šä¹‰cpusetèŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œvndkéƒ¨åˆ†ç¼–è¯‘éœ€è¦é‡æ–°è°ƒæ•´æ–¹æ¡ˆä»¥åŠä¸ä¿®æ”¹VNDKå¦‚ä½•ä¿è¯ç¼–è¯‘é€šè¿‡ã€‚ ç”±äºä¿®æ”¹ä¸­æ¶‰åŠä»£ç é‡è¿‡å¤§ï¼Œè¿™é‡Œæ‹†åˆ†æˆä¸¤èŠ‚è¿›è¡Œå±•ç¤ºã€‚æœ¬ç« èŠ‚ä¸»è¦é’ˆå¯¹ç¬¬2éƒ¨åˆ†å’Œç¬¬3éƒ¨åˆ†ä¿®æ”¹è¿›è¡Œè¯´æ˜ã€‚ä¸Šä¸€ç¯‡æ–‡ç« ğŸ‘‡
Android Framework å¸¸è§è§£å†³æ–¹æ¡ˆï¼ˆ25-1ï¼‰å®šåˆ¶CPUSETè§£å†³æ–¹æ¡ˆ-frameworkéƒ¨åˆ†ä¿®æ”¹
ä¸»è¦å¯¹ç¬¬1éƒ¨åˆ†ä¿®æ”¹è¿›è¡Œè¯´æ˜ã€‚
2 ä¿®æ”¹æ–¹æ¡ˆï¼ˆAndroid Sï¼‰ 2.1 systeméƒ¨åˆ†ä¿®æ”¹ é’ˆå¯¹systemåˆ†åŒºä¿®æ”¹ã€‚å…·ä½“ä¿®æ”¹æ–¹æ¡ˆå¦‚ä¸‹ï¼ˆè¿™é‡Œä»¥Sç‰ˆæœ¬ä¿®æ”¹ä¸ºä¸»ï¼ŒQå’ŒRæœ‰ä¸€äº›å·®å¼‚ä½†åŸç†ä¸å˜ï¼‰ï¼š
åœ¨$AOSP/system/core/libprocessgroup/include/processgroup/sched_policy.hæ–‡ä»¶ä¸­ä¿®æ”¹ï¼š
/* Keep in sync with THREAD_GROUP_* in frameworks/base/core/java/android/os/Process.java */ typedef enum { SP_DEFAULT = -1, SP_BACKGROUND = 0, SP_FOREGROUND = 1, SP_SYSTEM = 2, SP_AUDIO_APP = 3, SP_AUDIO_SYS = 4, SP_TOP_APP = 5, SP_RT_APP = 6, SP_RESTRICTED = 7, &#43; SP_CUSTOM = 8, SP_CNT, SP_MAX = SP_CNT - 1, SP_SYSTEM_DEFAULT = SP_FOREGROUND, } SchedPolicy; è¿™é‡Œæ³¨æ„ï¼ŒæŒ‰ç…§é¡ºåºå¡«å†™ä¿®æ”¹ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºåç»­ä¼šç”¨åˆ°SP_CNTå’ŒSP_MAXè¿™ä¸¤ä¸ªå˜é‡ï¼Œä»£ç ä¸­è¿˜ä¼šæœ‰è®¸å¤šçš„éå†æ“ä½œï¼Œå› æ­¤æœ€å¥½é‡‡ç”¨ç´¯åŠ æ–¹æ¡ˆï¼Œä¸è¦è®¾ç½®å…¶ä»–å€¼ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c1e5504567cb9129cb9f688e5e6e40e9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T13:35:41+08:00" />
<meta property="article:modified_time" content="2024-01-10T13:35:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android Framework å¸¸è§è§£å†³æ–¹æ¡ˆï¼ˆ25-2ï¼‰å®šåˆ¶CPUSETè§£å†³æ–¹æ¡ˆ-systemä¿®æ”¹åŠç¼–è¯‘éƒ¨åˆ†è°ƒæ•´</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1 åŸç†è¯´æ˜</h2> 
<p>è¿™ä¸ªæ–¹æ¡ˆæœ‰å¦‚ä¸‹åŸºæœ¬éœ€æ±‚ï¼š</p> 
<ul><li>æ„å»ºè‡ªå®šä¹‰CPUSETï¼Œ/dev/cpusetä¸­åŒ…å«ä¸€ä¸ªå…¨æ–°çš„cpusetåˆ†ç»„ã€‚ä¸”å¯ä»¥é€šè¿‡set_cpuset_policyå’Œset_sched_policyæ¥å£å¯ä»¥è®¾ç½®è‡ªå®šä¹‰CPUSETã€‚</li><li>å¼€æœºå¯åŠ¨åå¯ä»¥é€šè¿‡zygoteåˆ¤å®šæ¥å¯¹ç‰¹å®šçš„åº”ç”¨è¿›ç¨‹è®¾ç½®CPUSETï¼Œå¹¶ä¸€ç›´ä¿æŒï¼Œä¸”ä¿è¯è‡ªå®šä¹‰CPUSETä¸å—å…¶ä»–CPUSETå½±å“ï¼ŒæŒç»­ç‹¬ç«‹ã€‚</li></ul> 
<p>åŸç†ä¸Šå› ä¸ºä¿®æ”¹ä»£ç æ¶‰åŠéƒ¨åˆ†è¾ƒå¤šï¼Œå› æ­¤å…±åˆ†3ä¸ªéƒ¨åˆ†ï¼š</p> 
<ol><li>frameworkä¿®æ”¹ï¼šæ·»åŠ SCHED GROUPå’ŒTHREAD GROUPï¼ˆTHREAD_GROUP_å¯¹åº”SP_ï¼‰çš„æ”¯æŒï¼Œä¸”æ”¯æŒå¼€æœºå¯åŠ¨åç›´æ¥è®¾ç½®ã€‚applyOomAdjLSPçš„åˆ¤å®šä¿æŒä¸å˜ã€‚</li><li>systemä¿®æ”¹ï¼šæ·»åŠ SP_CUSTOMçš„æ”¯æŒåŠset_cpuset_policyå’Œset_sched_policyæ¥å£ç­‰æ”¯æŒï¼ŒåŒæ—¶ä¿®æ”¹task_profiles.jsonï¼Œæ·»åŠ SP_CUSTOM CPUSETçš„æ”¯æŒã€‚</li><li>init.rcä¿®æ”¹åŠç¼–è¯‘éƒ¨åˆ†è°ƒæ•´ï¼šå¯¹è‡ªå®šä¹‰cpusetèŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œvndkéƒ¨åˆ†ç¼–è¯‘éœ€è¦é‡æ–°è°ƒæ•´æ–¹æ¡ˆä»¥åŠä¸ä¿®æ”¹VNDKå¦‚ä½•ä¿è¯ç¼–è¯‘é€šè¿‡ã€‚</li></ol> 
<p><span style="color:#956fe7;">ç”±äºä¿®æ”¹ä¸­æ¶‰åŠä»£ç é‡è¿‡å¤§ï¼Œè¿™é‡Œæ‹†åˆ†æˆä¸¤èŠ‚è¿›è¡Œå±•ç¤ºã€‚æœ¬ç« èŠ‚ä¸»è¦é’ˆå¯¹ç¬¬2éƒ¨åˆ†å’Œç¬¬3éƒ¨åˆ†ä¿®æ”¹è¿›è¡Œè¯´æ˜ã€‚ä¸Šä¸€ç¯‡æ–‡ç« ğŸ‘‡</span></p> 
<p><a href="https://blog.csdn.net/vviccc/article/details/135487983" title="Android Framework å¸¸è§è§£å†³æ–¹æ¡ˆï¼ˆ25-1ï¼‰å®šåˆ¶CPUSETè§£å†³æ–¹æ¡ˆ-frameworkéƒ¨åˆ†ä¿®æ”¹">Android Framework å¸¸è§è§£å†³æ–¹æ¡ˆï¼ˆ25-1ï¼‰å®šåˆ¶CPUSETè§£å†³æ–¹æ¡ˆ-frameworkéƒ¨åˆ†ä¿®æ”¹</a></p> 
<p><span style="color:#956fe7;">ä¸»è¦å¯¹ç¬¬1éƒ¨åˆ†ä¿®æ”¹è¿›è¡Œè¯´æ˜ã€‚</span></p> 
<h2>2 ä¿®æ”¹æ–¹æ¡ˆ<span style="color:#956fe7;">ï¼ˆAndroid Sï¼‰</span></h2> 
<h3>2.1 systeméƒ¨åˆ†ä¿®æ”¹</h3> 
<p>é’ˆå¯¹systemåˆ†åŒºä¿®æ”¹ã€‚å…·ä½“ä¿®æ”¹æ–¹æ¡ˆå¦‚ä¸‹<span style="color:#956fe7;">ï¼ˆè¿™é‡Œä»¥Sç‰ˆæœ¬ä¿®æ”¹ä¸ºä¸»ï¼ŒQå’ŒRæœ‰ä¸€äº›å·®å¼‚ä½†åŸç†ä¸å˜ï¼‰</span>ï¼š</p> 
<p>åœ¨$AOSP/system/core/libprocessgroup/include/processgroup/sched_policy.hæ–‡ä»¶ä¸­ä¿®æ”¹ï¼š</p> 
<pre><code class="language-cpp">/* Keep in sync with THREAD_GROUP_* in frameworks/base/core/java/android/os/Process.java */
typedef enum {
    SP_DEFAULT = -1,
    SP_BACKGROUND = 0,
    SP_FOREGROUND = 1,
    SP_SYSTEM = 2,
    SP_AUDIO_APP = 3,
    SP_AUDIO_SYS = 4,
    SP_TOP_APP = 5,
    SP_RT_APP = 6,
    SP_RESTRICTED = 7,
+    SP_CUSTOM = 8,
    SP_CNT,
    SP_MAX = SP_CNT - 1,
    SP_SYSTEM_DEFAULT = SP_FOREGROUND,
} SchedPolicy;</code></pre> 
<p>è¿™é‡Œæ³¨æ„ï¼ŒæŒ‰ç…§é¡ºåºå¡«å†™ä¿®æ”¹ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºåç»­ä¼šç”¨åˆ°SP_CNTå’ŒSP_MAXè¿™ä¸¤ä¸ªå˜é‡ï¼Œä»£ç ä¸­è¿˜ä¼šæœ‰è®¸å¤šçš„éå†æ“ä½œï¼Œå› æ­¤æœ€å¥½é‡‡ç”¨ç´¯åŠ æ–¹æ¡ˆï¼Œä¸è¦è®¾ç½®å…¶ä»–å€¼ã€‚</p> 
<p>æœ¬æ–¹æ¡ˆçš„ä¿®æ”¹æ¯”è¾ƒå…¨é¢ï¼Œå³æ”¯æŒset_cpuset_policyï¼Œä¹Ÿå…¼å®¹åˆ°set_sched_policyï¼Œåœ¨å®é™…æ“ä½œä¸­ï¼Œå¯æ ¹æ®éœ€è¦åªä¿®æ”¹å…¶ä¸­ä¸€ä¸ªå³å¯ã€‚</p> 
<p>åœ¨$AOSP/system/core/libprocessgroup/sched_policy.cppæ–‡ä»¶ä¸­ä¿®æ”¹ï¼š</p> 
<pre><code class="language-cpp">//ä¿®æ”¹set_cpuset_policyï¼Œæ·»åŠ SP_CUSTOMçš„å¤„ç†
int set_cpuset_policy(int tid, SchedPolicy policy) {
    if (tid == 0) {
        tid = GetThreadId();
    }
    policy = _policy(policy);

    switch (policy) {
        case SP_BACKGROUND:
            return SetTaskProfiles(tid, {"CPUSET_SP_BACKGROUND", "BlkIOBackground"}, true) ? 0 : -1;
        case SP_FOREGROUND:
            return SetTaskProfiles(tid, {"CPUSET_SP_FOREGROUND", "BlkIOForeground"}, true) ? 0 : -1;
        case SP_AUDIO_APP:
        case SP_AUDIO_SYS:
            return SetTaskProfiles(tid, {"CPUSET_SP_FOREGROUND", "AudioAppCapacity", "BlkIOForeground"}, true) ? 0 : -1;
        case SP_TOP_APP:
            return SetTaskProfiles(tid, {"CPUSET_SP_TOP_APP", "BlkIOBackground"}, true) ? 0 : -1;
        case SP_SYSTEM:
            return SetTaskProfiles(tid, {"CPUSET_SP_SYSTEM", "BlkIOForeground"}, true) ? 0 : -1;
        case SP_RESTRICTED:
            return SetTaskProfiles(tid, {"CPUSET_SP_RESTRICTED"}, true) ? 0 : -1;
+        case SP_CUSTOM:
+            return SetTaskProfiles(tid, {"CPUSET_SP_CUSTOM"}, true) ? 0 : -1;
        default:
            break;
    }

    return 0;
}

//ä¿®æ”¹set_sched_policyï¼Œæ·»åŠ SP_CUSTOMçš„å¤„ç†
int set_sched_policy(int tid, SchedPolicy policy) {
//...
#if POLICY_DEBUG //æ³¨æ„ï¼šè¿™ä¸€æ®µçš„ä¿®æ”¹ä¸»è¦æ˜¯è°ƒè¯•ä½¿ç”¨ï¼ŒåŠŸèƒ½å®ç°ä¸Šå¯ä»¥ä¸æ·»åŠ è¯¥éƒ¨åˆ†
//...
    switch (policy) {
        case SP_BACKGROUND:
            SLOGD("vvv tid %d (%s)", tid, thread_name);
            break;
        case SP_FOREGROUND:
        case SP_AUDIO_APP:
        case SP_AUDIO_SYS:
        case SP_TOP_APP:
            SLOGD("^^^ tid %d policy %d (%s)", tid, policy, thread_name);
            break;
        case SP_SYSTEM:
            SLOGD("/// tid %d (%s)", tid, thread_name);
            break;
        case SP_RT_APP:
            SLOGD("RT  tid %d (%s)", tid, thread_name);
            break;
+        case SP_CUSTOM:
+            SLOGD("CUSTOM|xxx tid %d (%s)", tid, thread_name);
+            break;
        default:
            SLOGD("??? tid %d (%s)", tid, thread_name);
            break;
    }
#endif
//...
    switch (policy) {
        case SP_BACKGROUND:
            return SetTaskProfiles(tid, {"SCHED_SP_BACKGROUND", "BlkIOBackground"}, true) ? 0 : -1;
        case SP_FOREGROUND:
        case SP_AUDIO_APP:
        case SP_AUDIO_SYS:
            return SetTaskProfiles(tid, {"SCHED_SP_FOREGROUND", "BlkIOForeground"}, true) ? 0 : -1;
        case SP_TOP_APP:
            return SetTaskProfiles(tid, {"SCHED_SP_TOP_APP", "BlkIOForeground"}, true) ? 0 : -1;
        case SP_SYSTEM:
            return SetTaskProfiles(tid, {"SCHED_SP_SYSTEM"}, true) ? 0 : -1;
        case SP_RT_APP:
            return SetTaskProfiles(tid, {"SCHED_SP_RT_APP", "BlkIOForeground"}, true) ? 0 : -1;
        case SP_CUSTOM:
            return SetTaskProfiles(tid, {"SCHED_SP_CUSTOM"}, true) ? 0 : -1;
        default:
            return SetTaskProfiles(tid, {"SCHED_SP_DEFAULT"}, true) ? 0 : -1;
    }

    return 0;

}
//ä¿®æ”¹get_sched_policy_from_groupï¼Œæ·»åŠ SP_CUSTOMçš„å¤„ç†
static int get_sched_policy_from_group(const std::string&amp; group, SchedPolicy* policy) {
    if (group.empty()) {
        *policy = SP_FOREGROUND;
    } else if (group == "foreground") {
        *policy = SP_FOREGROUND;
    } else if (group == "system-background") {
        *policy = SP_SYSTEM;
    } else if (group == "background") {
        *policy = SP_BACKGROUND;
    } else if (group == "top-app") {
        *policy = SP_TOP_APP;
    } else if (group == "restricted") {
        *policy = SP_RESTRICTED;
    } else if (group == "audio-app") {
        *policy = SP_AUDIO_APP;
    } else if (group == "custom") {
        *policy = SP_CUSTOM;
    } else {
        errno = ERANGE;
        return -1;
    }
    return 0;
}

//ä¿®æ”¹get_sched_policy_nameï¼Œæ·»åŠ SP_CUSTOMçš„å¤„ç†
const char* get_sched_policy_name(SchedPolicy policy) {
    policy = _policy(policy);
    static const char* const kSchedPolicyNames[] = {
            [SP_BACKGROUND] = "bg", [SP_FOREGROUND] = "fg", [SP_SYSTEM] = "  ",
            [SP_AUDIO_APP] = "aa",  [SP_AUDIO_SYS] = "as",  [SP_TOP_APP] = "ta",
            [SP_RT_APP] = "rt",     [SP_RESTRICTED] = "rs",[SP_CUSTOM] = "ct",
    };
    static_assert(arraysize(kSchedPolicyNames) == SP_CNT, "missing name");
    if (policy &lt; SP_BACKGROUND || policy &gt;= SP_CNT) {
        return nullptr;
    }
    return kSchedPolicyNames[policy];
}

//ä¿®æ”¹get_cpuset_policy_profile_nameï¼Œæ·»åŠ SP_CUSTOMçš„å¤„ç†
const char* get_cpuset_policy_profile_name(SchedPolicy policy) {
    /*
     *  cpuset profile array for:
     *  SP_DEFAULT(-1), SP_BACKGROUND(0), SP_FOREGROUND(1),
     *  SP_SYSTEM(2), SP_AUDIO_APP(3), SP_AUDIO_SYS(4),
-     *  SP_TOP_APP(5), SP_RT_APP(6), SP_RESTRICTED(7),
+     *  SP_TOP_APP(5), SP_RT_APP(6), SP_RESTRICTED(7), SP_CUSTOM(8)
     *  index is policy + 1
     *  this need keep in sync with SchedPolicy enum
     */
    static constexpr const char* kCpusetProfiles[SP_CNT + 1] = {
            "CPUSET_SP_DEFAULT", "CPUSET_SP_BACKGROUND", "CPUSET_SP_FOREGROUND",
            "CPUSET_SP_SYSTEM",  "CPUSET_SP_FOREGROUND", "CPUSET_SP_FOREGROUND",
-            "CPUSET_SP_TOP_APP", "CPUSET_SP_DEFAULT",    "CPUSET_SP_RESTRICTED"
+            "CPUSET_SP_TOP_APP", "CPUSET_SP_DEFAULT",    "CPUSET_SP_RESTRICTED","CPUSET_SP_CUSTOM"};
    if (policy &lt; SP_DEFAULT || policy &gt;= SP_CNT) {
        return nullptr;
    }
    return kCpusetProfiles[policy + 1];
}

//ä¿®æ”¹get_sched_policy_profile_nameï¼Œæ·»åŠ SP_CUSTOMçš„å¤„ç†
const char* get_sched_policy_profile_name(SchedPolicy policy) {
    /*
     *  sched profile array for:
     *  SP_DEFAULT(-1), SP_BACKGROUND(0), SP_FOREGROUND(1),
     *  SP_SYSTEM(2), SP_AUDIO_APP(3), SP_AUDIO_SYS(4),
-     *  SP_TOP_APP(5), SP_RT_APP(6), SP_RESTRICTED(7),
+     *  SP_TOP_APP(5), SP_RT_APP(6), SP_RESTRICTED(7),SP_CUSTOM(8)
     *  index is policy + 1
     *  this need keep in sync with SchedPolicy enum
     */
    static constexpr const char* kSchedProfiles[SP_CNT + 1] = {
            "SCHED_SP_DEFAULT", "SCHED_SP_BACKGROUND", "SCHED_SP_FOREGROUND",
            "SCHED_SP_SYSTEM",  "SCHED_SP_FOREGROUND", "SCHED_SP_FOREGROUND",
-            "SCHED_SP_TOP_APP", "SCHED_SP_RT_APP",     "SCHED_SP_DEFAULT"
+            "SCHED_SP_TOP_APP", "SCHED_SP_RT_APP",     "SCHED_SP_DEFAULT","SCHED_SP_CUSTOM"};
    if (policy &lt; SP_DEFAULT || policy &gt;= SP_CNT) {
        return nullptr;
    }
    return kSchedProfiles[policy + 1];
}</code></pre> 
<p>ä»¥ä¸Š2éƒ¨åˆ†ä¸»è¦æ˜¯é€»è¾‘çš„ä¿®æ”¹ï¼Œæ¥ä¸‹æ¥æ˜¯é…ç½®æ–‡ä»¶çš„ä¿®æ”¹ï¼Œåœ¨$AOSP/system/core/libprocessgroup/profiles/task_profiles.jsonæ–‡ä»¶ä¸­ä¿®æ”¹ï¼š</p> 
<pre><code class="language-css">{
  "Attributes": [
    {
      "Name": "LowCapacityCPUs",
      "Controller": "cpuset",
      "File": "background/cpus"
    },
    ...
+    {
+      "Name": "CustomCPUs",
+      "Controller": "cpuset",
+      "File": "custom/cpus"
+    },
    ...
    {
      "Name": "FreezerState",
      "Controller": "freezer",
      "File": "cgroup.freeze"
    }
  ],
  "Profiles": [
    {
      "Name": "HighEnergySaving",
      "Actions": [
        {
          "Name": "JoinCgroup",
          "Params":
          {
            "Controller": "cpu",
            "Path": "background"
          }
        }
      ]
    },
    ...
+    {
+      "Name": "CustomPerformance",
+      "Actions" : [
+        {
+          "Name" : "JoinCgroup",
+          "Params" :
+          {
+            "Controller": "cpuset",
+            "Path": "custom"
+          }
+        }
+      ]
+    },
    ...
    {
      "Name": "SystemMemoryProcess",
      "Actions": [
        {
          "Name": "JoinCgroup",
          "Params":
          {
            "Controller": "memory",
            "Path": "system"
          }
        }
      ]
    }
  ],
  
  "AggregateProfiles": [
    {
      "Name": "SCHED_SP_DEFAULT",
      "Profiles": [ "TimerSlackNormal" ]
    },
    ...
    {
      "Name": "SCHED_SP_RT_APP",
      "Profiles": [ "RealtimePerformance", "MaxIoPriority", "TimerSlackNormal" ]
    },
+    {
+      "Name": "SCHED_SP_CUSTOM",
+      "Profiles": [ "CUSTOMPerformance" ]
+    },
    ...
+    {
+      "Name": "CPUSET_SP_CUSTOM",
+      "Profiles": [ "CUSTOMPerformance" ]
+    },
    ...
     {
      "Name": "Dex2OatBootComplete",
      "Profiles": [ "Dex2oatPerformance", "LowIoPriority", "TimerSlackHigh" ]
    }
  ]
}</code></pre> 
<p>è‡³æ­¤ï¼Œsystemç›¸å…³ä¿®æ”¹å°±ç»“æŸäº†ã€‚ä¸»è¦æ˜¯SP_CUSTOMç›¸å…³é€»è¾‘çš„æ·»åŠ ï¼Œé…ç½®æ–‡ä»¶task_profiles.jsonçš„ä¿®æ”¹ï¼Œæ¥å£set_cpuset_policyå’Œset_sched_policyçš„æ”¯æŒç­‰ã€‚</p> 
<h3>2.2 init.rcåŠç¼–è¯‘éƒ¨åˆ†è°ƒæ•´</h3> 
<p>Â ä¸ºæ·»åŠ cpusetç›¸å…³èŠ‚ç‚¹ï¼Œéœ€è¦ä¿®æ”¹init.rcæ–‡ä»¶ï¼Œè¿™é‡Œæ ¹æ®androidæºç çš„éœ€è¦è°ƒæ•´åˆ°å¯¹åº”çš„rcä¸­æ·»åŠ å³å¯ã€‚å…·ä½“init.rcä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p> 
<pre><code class="language-bash">#ç¬¬ä¸€éƒ¨åˆ†ï¼šon initä¸­æ·»åŠ ï¼š
...
+#custom add start
+    mkdir /dev/stune/custom
+    chown system system /dev/stune/custom
+    chown system system /dev/stune/custom/tasks
+    chmod 0664 /dev/stune/custom/tasks
+    mkdir /dev/cpuset/custom
+    copy /dev/cpuset/cpus /dev/cpuset/custom/cpus
+    copy /dev/cpuset/mems /dev/cpuset/custom/mems
+    chown system system /dev/cpuset/custom
+    chown system system /dev/cpuset/custom/tasks
+    chown system system /dev/cpuset/custom/cgroup.procs
+    chmod 0664 /dev/cpuset/custom/tasks
+    chmod 0664 /dev/cpuset/custom/cgroup.procs
+#custom add end
...
#ç¬¬äºŒéƒ¨åˆ†ï¼šç³»ç»Ÿå¯åŠ¨å®Œæˆåæ·»åŠ , è¿™é‡Œç»‘å®šçš„æ˜¯456ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼š
+#custom add start
+on property:sys.boot_completed=1
+   write /dev/cpuset/custom/cpus 4-6
+   write /dev/cpuset/custom/mems 0
+#custom add end</code></pre> 
<p>è¿™é‡Œä¸»è¦æ˜¯é€šè¿‡init.rcæ–‡ä»¶æ·»åŠ cpusetç›¸å…³èŠ‚ç‚¹ï¼Œä»¥åŠä¿®æ”¹cpusetç›¸å…³èŠ‚ç‚¹çš„æƒé™å’Œownerï¼Œä»¥åŠå†™å…¥å€¼æ“ä½œã€‚è¿™æ ·ï¼Œåœ¨å¼€æœºå¯åŠ¨åå°±å¯ä»¥åœ¨/dev/cpuset/ç›®å½•ä¸‹çœ‹åˆ°è‡ªå®šä¹‰cpusetå¯¹åº”çš„customèŠ‚ç‚¹ã€‚</p> 
<p>è‡³æ­¤ä»£ç å’Œé…ç½®æ–‡ä»¶éƒ½å·²ç»ä¿®æ”¹å®Œäº†ã€‚</p> 
<p>æ¥ä¸‹æ¥å°±éœ€è¦ç¼–è¯‘äº†ï¼Œä½†æ˜¯ç¼–è¯‘è¿™é‡Œè¦é¿å…vndkæŠ¥é”™çš„é—®é¢˜ï¼Œéœ€è¦æœ‰å…ˆæ‰§è¡Œå¦‚ä¸‹è„šæœ¬å†…å®¹ï¼š</p> 
<pre><code class="language-bash">source build/envsetup.sh &amp;&amp; lunch xxx
cd ./development/vndk/tools/header-checker/utils/
#è¿™é‡Œçš„xxxä¸€èˆ¬æ˜¯æŒ‡out/target/productä¹‹åçš„è·¯å¾„
./create_reference_dumps.py -l libprocessgroup -product xxx</code></pre> 
<p>é‡æ–°ç¼–è¯‘vndkï¼Œå¦åˆ™ä¼šå‡ºç°å¦‚ä¸‹ç±»ä¼¼çš„ç¼–è¯‘é”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<pre><code class="language-bash">error: VNDK library: XXX
******************************************************
error: Please update ABI references with: $ANDROID_BUILD_TOP/development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libprocessgroup
ninja failed with: exit status 1
#### failed to build some targets ####</code></pre> 
<p></p> 
<h3></h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3ea820f60ffd34cbab1c089062ba9e0b/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">å¦‚ä½•åœ¨ä¸€å¼ å›¾é‡ŒåŒæ—¶æ˜¾ç¤ºä¸¤ä¸ªä¸‰ç»´å›¾</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3a636474b983643f43935642bb4e06d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">dockerä¹‹dockerFile</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>