<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>m3u8加密文件原理及下载脚本 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="m3u8加密文件原理及下载脚本" />
<meta property="og:description" content="一、加密ts文件解密 #EXTM3U #EXT-X-VERSION:3 #EXT-X-MEDIA-SEQUENCE:0 #EXT-X-ALLOW-CACHE:YES #EXT-X-TARGETDURATION:13 #EXT-X-KEY:METHOD=AES-128,URI=&#34;https://j-island.net/movie/hls_key/s/857401e309d8a032c3bb18f4b09b8db2/?f=jj_20190401_hihijets_004&#34;,IV=0xaa3dcf6a7acb92ff4fb08d9b3b3d6f51 #EXTINF:12.078733, https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400000.ts #EXTINF:9.009000, https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400001.ts #EXTINF:9.009000, https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400002.ts #EXTINF:12.012000, https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400003.ts #EXTINF:9.009000, https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400004.ts #EXTINF:2.002000, https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400005.ts #EXT-X-ENDLIST m3u8视频另一种下载方式 如上图中用ts链接直接下载下来的ts视频文件是加密的（为什么要下加密的？虽然加密但是下载速度快啊）。
#EXT-X-KEY 字段已经写明了加密方式是AES-128，key通过URI获取，IV也有。
#EXT-X-KEY: METHOD=AES-128, URI=&#34;https://j-island.net/movie/hls_key/s/857401e309d8a032c3bb18f4b09b8db2/?f=jj_20190401_hihijets_004&#34;, IV=0xaa3dcf6a7acb92ff4fb08d9b3b3d6f51 那怎么解密呢？
1.复制URI地址到网页，你将秒速自动下载得到一个16字节文件 2.打开终端，打开该文件查看16进制：
打开二进制key
vi -b /路径/key文件 输入“ :%!xxd”再把二进制文件切换到16进制
00000000: 283d cc2d 3747 e965 0a81 ead3 1e04 fa8a (=.-7G.e........ 获取到key就是 283dcc2d3747e9650a81ead31e04fa8a 3.打开终端，转化
openssl aes-128-cbc -d -in /路径/media_0.ts -out /路径/media_decryptd_0.ts -nosalt -iv $iv -K $strkey *media_0.ts* : 加密ts文件（无法播放） *media_decryptd_0.ts* : 解密后ts文件（可以直接播放） *$iv* : aa3dcf6a7acb92ff4fb08d9b3b3d6f51（#EXT-X-KEY字段中获取，注意去掉0x） *$strkey* : 283dcc2d3747e9650a81ead31e04fa8a（上一步获得）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9e673cce84971e66bf043686b63048ae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-11T21:20:23+08:00" />
<meta property="article:modified_time" content="2022-05-11T21:20:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">m3u8加密文件原理及下载脚本</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、加密ts文件解密</h2> 
<pre><code>#EXTM3U
#EXT-X-VERSION:3
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-ALLOW-CACHE:YES
#EXT-X-TARGETDURATION:13
#EXT-X-KEY:METHOD=AES-128,URI="https://j-island.net/movie/hls_key/s/857401e309d8a032c3bb18f4b09b8db2/?f=jj_20190401_hihijets_004",IV=0xaa3dcf6a7acb92ff4fb08d9b3b3d6f51
#EXTINF:12.078733,
https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400000.ts
#EXTINF:9.009000,
https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400001.ts
#EXTINF:9.009000,
https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400002.ts
#EXTINF:12.012000,
https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400003.ts
#EXTINF:9.009000,
https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400004.ts
#EXTINF:2.002000,
https://j-island.stream2.johnnys-net.jp/j-island/jj_20190401_hihijets_004/jj_20190401_hihijets_00400005.ts
#EXT-X-ENDLIST</code></pre> 
<p><strong>m3u8视频另一种下载方式</strong> 如上图中用ts链接直接下载下来的ts视频文件是加密的（为什么要下加密的？虽然加密但是下载速度快啊）。</p> 
<p><em>#EXT-X-KEY</em> 字段已经写明了加密方式是AES-128，key通过URI获取，IV也有。</p> 
<pre><code>#EXT-X-KEY:
METHOD=AES-128,
URI="https://j-island.net/movie/hls_key/s/857401e309d8a032c3bb18f4b09b8db2/?f=jj_20190401_hihijets_004",
IV=0xaa3dcf6a7acb92ff4fb08d9b3b3d6f51</code></pre> 
<pre></pre> 
<p><strong>那怎么解密呢？</strong></p> 
<p>1.复制URI地址到网页，你将秒速自动下载得到一个16字节文件 2.打开终端，打开该文件查看16进制：</p> 
<ul><li> <p>打开二进制key</p> </li></ul> 
<pre><code>vi -b /路径/key文件</code></pre> 
<ul><li> <p>输入“ :%!xxd”再把二进制文件切换到16进制</p> </li></ul> 
<pre>00000000: 283d cc2d 3747 e965 0a81 ead3 1e04 fa8a  (=.-7G.e........</pre> 
<p>获取到key就是 <em>283dcc2d3747e9650a81ead31e04fa8a</em> 3.打开终端，转化</p> 
<pre><code>openssl aes-128-cbc -d -in /路径/media_0.ts -out /路径/media_decryptd_0.ts -nosalt -iv $iv -K $strkey</code></pre> 
<p>*<strong>media_0.ts*</strong> : 加密ts文件（无法播放） *<strong>media_decryptd_0.ts*</strong> : 解密后ts文件（可以直接播放） *<strong>$iv*</strong> : <em>aa3dcf6a7acb92ff4fb08d9b3b3d6f51</em>（#EXT-X-KEY字段中获取，注意去掉0x） *<strong>$strkey*</strong> : <em>283dcc2d3747e9650a81ead31e04fa8a</em>（上一步获得）</p> 
<p>例子：</p> 
<pre><code>openssl aes-128-cbc -d -in /Users/用户名/Downloads/001.ts -out /Users/用户名/Downloads/001_dec.ts -nosalt -iv aa3dcf6a7acb92ff4fb08d9b3b3d6f51 -K 283dcc2d3747e9650a81ead31e04fa8a</code></pre> 
<p>命令执行完秒速转化（也可能我文件特别短，都切成ts了，一般都不长吧…… 4.到对应路径下去，就能看到转化成功到ts视频了</p> 
<h2>二、案例</h2> 
<p></p> 
<h3>1、m3u8文件</h3> 
<pre>通过连接：

</pre> 
<pre><code>https://XXXXXXX/video/20210713/48466f15b9094154a3dc405efd5b54fd/cloudv-transfer/555555552773r8qq5556n265646r92r4_e8f05058b8c14e679738b91d96fa6d60_0_3.m3u8?t=1652097774&amp;k=a062691ead867c707b07b5c6caf87385&amp;vid=9e74e191017a1000dd3e822700000000&amp;r=a8aede38018010004b91ff8f00000000</code></pre> 
<pre>下载文件内容如下
​
​

</pre> 
<pre><code>#EXTM3U
#EXT-X-VERSION:3
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-ALLOW-CACHE:YES
#EXT-X-TARGETDURATION:11
#EXT-X-KEY:METHOD=AES-128,URI="https://api.cloudv.haplat.net/vod/videoManage/getHlsKeyByVideoId?cid=882006&amp;t=1652097774&amp;k=a062691ead867c707b07b5c6caf87385&amp;vid=9e74e191017a1000dd3e822700000000&amp;r=a8aede38018010004b91ff8f00000000",IV=0x993181d25c49657b7b6bfeff30f13d8c
#EXTINF:1.200000,
a08a0c0364dc4000b46560e905564520_0000000.ts
#EXTINF:1.000000,
a08a0c0364dc4000b46560e905564520_0000001.ts</code></pre> 
<pre>​</pre> 
<h3>2、key值</h3> 
<pre><code>https://api.cloudv.haplat.net/vod/videoManage/getHlsKeyByVideoId?cid=882006&amp;t=1652097774&amp;k=a062691ead867c707b07b5c6caf87385&amp;vid=9e74e191017a1000dd3e822700000000&amp;r=a8aede38018010004b91ff8f00000000</code></pre> 
<pre>找到请求的返回值


​将字符串进行16进制编码</pre> 
<p> </p> 
<p><img alt="" height="426" src="https://images2.imgbox.com/4c/ee/sYpd7AlT_o.png" width="529"></p> 
<p></p> 
<p></p> 
<p></p> 
<h3>3 、下载ts文件</h3> 
<p><img alt="" height="288" src="https://images2.imgbox.com/aa/1f/PHreKnVC_o.png" width="1200"></p> 
<p></p> 
<p></p> 
<p>通过分析，ts下载网址为</p> 
<pre>https://xxxxxxx/video/20210713/48466f15b9094154a3dc405efd5b54fd/cloudv-transfer/a08a0c0364dc4000b46560e905564520_0000000.ts
​
构造ts的下载网址为https://xxxxxxx/video/20210713/48466f15b9094154a3dc405efd5b54fd/cloudv-transfer/ + m3u8文件中的数据</pre> 
<h3>4、解码</h3> 
<p>下载的ts为加密后的，需要进行解码，采用openssl解码</p> 
<pre><code class="language-bash">openssl aes-128-cbc -d -in 0.ts -out 0_1.ts -nosalt -iv 993181d25c49657b7b6bfeff30f13d8c -K f370739f5a517a4724c677a73e156126</code></pre> 
<pre>​5脚本：</pre> 
<pre><code class="language-python">#!C:\Python3.7
# -*- coding:utf-8 -*-
# coding=utf-8
import requests
import os
headers = {
    "User - Agent": "Mozilla / 5.0(Windows NT 10.0;WOW64) AppleWebKit / 537.36(KHTML, like Gecko) Chrome / 84.0.4147.105 Safari / 537.36"
    }


def download(baseurl,file_m3u8,path_in):
    url_list=[]
    with open(file_m3u8,"r") as f:
        for r in f.readlines():
            if ".ts" in r :
                url_list.append(r.replace("\n","").strip())
    # print(url_list)

    for r in url_list:
        url = baseurl+r
        filename=os.path.join(path_in,r.split("_")[1])
        # print(url,filename)
        try:
            re = requests.get(url=url,headers=headers)
        except Exception as e:
            print(e)
            pass
        with open(filename,"ab") as f:
            f.write(re.content)
            print("[*]download:"+filename)


def mergeFileToMP4(pathname):
    os.chdir(pathname)
    cmd = "copy /b *.ts new.tmp"
    os.system(cmd)
    os.system('del /Q *.ts')
    os.system('del /Q *.mp4')
    os.rename("new.tmp", "new.mp4")
    os.chdir('..')
    print("merge file is :",str(os.path.join(pathname,"new.mp4")))

def key_test(key):
    print(len(key))
    key_hex=""
    for c in key:
        tem=hex(ord(c))[2:]
        key_hex=key_hex+tem
    print(key_hex)
    return  key_hex

def decode_openssl(key,iv,path_in,path_out):
    for file in os.listdir(path_in):
        file_in=os.path.join(path_in,file)
        file_out = os.path.join(path_out,file)
        # print(file_in,file_out)
        cmd=f"openssl aes-128-cbc -d -in {file_in} -out {file_out} -nosalt -iv {iv} -K {key}"
        print(cmd)
        os.system(cmd)

def clear_ts(path):
    os.chdir(path)
    os.system("del /Q *.ts")

def main(baseurl,key,iv,file_m3u8):
    # print("main")
    basepath = os.path.split(file_m3u8)[0]
    basepath_in = os.path.join(basepath, "in")
    basepath_out = os.path.join(basepath, "out")
    if not os.path.exists(basepath_in):
        os.mkdir(basepath_in)
    if not os.path.exists(basepath_out):
        os.mkdir(basepath_out)

    download(baseurl=baseurl, file_m3u8=file_m3u8,path_in=basepath_in)
    key = key_test(key)
    decode_openssl(key,iv,basepath_in,basepath_out)
    mergeFileToMP4(basepath_out)
    clear_ts(basepath_in)



if __name__ == '__main__':
    # https://xxxxxxx/video/20210713/ea044c31965940559162b816ec8e152a/cloudv-transfer/a08a0bff11c84000b465638605564520_0000001.ts
    baseurl="https://xxxxxxxxx/video/20210713/ea044c31965940559162b816ec8e152a/cloudv-transfer/"
    key="±úx£Ú:êh'ÿs{câ"
    iv="131f71ed838a8019b731be5b7f2a1703"
    file_m3u8="./jixian/3.m3u8"
    file_m3u8 = os.path.join(os.getcwd(),file_m3u8)
    if(os.path.exists(file_m3u8)):
        main(baseurl,key,iv,file_m3u8)
    else:
        print("[-]"+file_m3u8+" not found:\n")
    # download(baseurl)


</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/080c54176bc2c297bfede72a30e65275/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">（ICCV-2021）通过有效的全局-局部特征表示和局部时间聚合进行步态识别（三）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/adff600fab5323a40d4a02b8356a8aa1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux系统级程序设计-3</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>