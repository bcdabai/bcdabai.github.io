<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FFmpeg之AVFormat - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="FFmpeg之AVFormat" />
<meta property="og:description" content="文章目录 一、概述二、解封装流程三、重要结构体3.1、AVFormatContext3.2、AVInputFormat3.3、AVOutputFormat3.4、AVStream 四、重要函数分析4.1、avformat_alloc_context4.2、avformat_open_input4.2.1、init_input4.2.2、av_probe_input_format2 4.3、avformat_find_stream_info4.4、av_read_frame4.4.1、read_frame_internal4.4.2、ff_read_packet4.4.3、parse_packet 4.5、avformat_seek_file4.6、av_seek_frame4.6.1、seek_frame_internal4.6.2、seek_frame_byte 4.7、avformat_close_input 五、实例 团队博客: 汽车电子社区
一、概述 avformat中实现了目前多媒体领域中的几乎所有封装格式，可以封装，可以解封装（也叫解复用），根据需求不同，所支持的也有所不同，ffmpeg能否支持一种封装格式的视频的封装与解封装，完全取决于这个库，例如mp4、flv、mkv等容器的封装与解封装；又或者RTMP、RTSP、TCP、UDP等协议的封装与解封装；关于封装与解封装的操作，对CPU的消耗不会特别严重，因为封装与解封装不涉及到复杂的计算，更多的是I/O，如果希望增加自己定制的封装格式的话，需要在libavformat中增加自己的对应的format模块。通过代码的文件结构可以看得出来。
二、解封装流程 1、avformat_alloc_context()：负责申请一个AVFormatContext结构的内存,并进行简单初始化。
2、avformat_open_input()：打开输入音/视频文件。
3、avformat_find_stream_info()：获取音视频文件信息。
4、av_read_frame()：读取音视频包。
5、avformat_seek_file()：定位文件。
6、av_seek_frame()：定位文件。
7、avformat_free_context()：释放该结构里的所有东西以及该结构本身。
8、avformat_close_input()：关闭解复用器。关闭后就不再需要使用avformat_free_context 进行释放。
三、重要结构体 3.1、AVFormatContext AVFormatContext是FFmpeg中一个非常重要的结构体，它包含了一个完整的媒体文件或媒体流的所有信息。在FFmpeg中，每一个AVFormatContext结构体都对应着一个媒体文件或媒体流。当我们使用FFmpe对媒体文件或者媒体流的解码、编码或者转换时，都是基于AVFormatContext结构体进行操作的。
AVFormatContext结构体包含的信息很多，其中最重要的时AVInputFormat和AVOutputFormat，它们分表代表输入和输出的格式，包含了所有支持的编解码器、封装格式、容器格式等信息。在使用FFmpeg进行媒体文件或者媒体流的解码、编码或者转换时，我们需要根据不同的输入和输出格式来选择合适的VInputFormat和AVOutputFormat。
除了AVInputFormat和AVOutputFormat以外，AVFormatContext还包含了一些其它的信息，比如AVStream，它表示一个媒体流的所有信息，包括媒体流的类型、编码方式、采样率、帧率等；AVCodecContext表示一个编解码器的所有信息，包括编解码器的类型、编解码方式、采样率、帧率等等；AVDictionary它是一个字典类型的结构体，用于存储一些额外的元数据信息，比如媒体文件的标题、作者、描述等等。
typedef struct AVFormatContext { /** * A class for logging and @ref avoptions. Set by avformat_alloc_context(). * Exports (de)muxer private options if they exist. */ const AVClass *av_class; /** * The input container format. * * Demuxing only, set by avformat_open_input(). */ const struct AVInputFormat *iformat; /** * The output container format." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cbb7c34c44dbf4b52bc636bf3f786e59/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-15T17:50:48+08:00" />
<meta property="article:modified_time" content="2024-01-15T17:50:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FFmpeg之AVFormat</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">一、概述</a></li><li><a href="#_11" rel="nofollow">二、解封装流程</a></li><li><a href="#_22" rel="nofollow">三、重要结构体</a></li><li><ul><li><a href="#31AVFormatContext_23" rel="nofollow">3.1、AVFormatContext</a></li><li><a href="#32AVInputFormat_2487" rel="nofollow">3.2、AVInputFormat</a></li><li><a href="#33AVOutputFormat_2648" rel="nofollow">3.3、AVOutputFormat</a></li><li><a href="#34AVStream_2683" rel="nofollow">3.4、AVStream</a></li></ul> 
  </li><li><a href="#_2874" rel="nofollow">四、重要函数分析</a></li><li><ul><li><a href="#41avformat_alloc_context_2875" rel="nofollow">4.1、avformat_alloc_context</a></li><li><a href="#42avformat_open_input_2979" rel="nofollow">4.2、avformat_open_input</a></li><li><ul><li><a href="#421init_input_3143" rel="nofollow">4.2.1、init_input</a></li><li><a href="#422av_probe_input_format2_3195" rel="nofollow">4.2.2、av_probe_input_format2</a></li></ul> 
   </li><li><a href="#43avformat_find_stream_info_3221" rel="nofollow">4.3、avformat_find_stream_info</a></li><li><a href="#44av_read_frame_3920" rel="nofollow">4.4、av_read_frame</a></li><li><ul><li><a href="#441read_frame_internal_4023" rel="nofollow">4.4.1、read_frame_internal</a></li><li><a href="#442ff_read_packet_4240" rel="nofollow">4.4.2、ff_read_packet</a></li><li><a href="#443parse_packet_4367" rel="nofollow">4.4.3、parse_packet</a></li></ul> 
   </li><li><a href="#45avformat_seek_file_4487" rel="nofollow">4.5、avformat_seek_file</a></li><li><a href="#46av_seek_frame_4567" rel="nofollow">4.6、av_seek_frame</a></li><li><ul><li><a href="#461seek_frame_internal_4594" rel="nofollow">4.6.1、seek_frame_internal</a></li><li><a href="#462seek_frame_byte_4649" rel="nofollow">4.6.2、seek_frame_byte</a></li></ul> 
   </li><li><a href="#47avformat_close_input_4674" rel="nofollow">4.7、avformat_close_input</a></li></ul> 
  </li><li><a href="#_4715" rel="nofollow">五、实例</a></li></ul> 
</div> 
<p></p> 
<hr> 
<p>  <strong>团队博客:</strong> <a href="https://bbs.csdn.net/forums/automotive-electronics"><strong>汽车电子社区</strong></a></p> 
<hr> 
<h2><a id="_5"></a>一、概述</h2> 
<p>  avformat中实现了目前多媒体领域中的几乎所有封装格式，可以封装，可以解封装（也叫解复用），根据需求不同，所支持的也有所不同，ffmpeg能否支持一种封装格式的视频的封装与解封装，完全取决于这个库，例如mp4、flv、mkv等容器的封装与解封装；又或者RTMP、RTSP、TCP、UDP等协议的封装与解封装；关于封装与解封装的操作，对CPU的消耗不会特别严重，因为封装与解封装不涉及到复杂的计算，更多的是I/O，如果希望增加自己定制的封装格式的话，需要在libavformat中增加自己的对应的format模块。通过代码的文件结构可以看得出来。<br> <img src="https://images2.imgbox.com/16/e7/bcih9Dnl_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/52/fb/ZisO34NL_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_11"></a>二、解封装流程</h2> 
<p><img src="https://images2.imgbox.com/10/f4/yq1BDiOJ_o.png" alt="[图片]"></p> 
<p>  1、avformat_alloc_context()：负责申请一个AVFormatContext结构的内存,并进行简单初始化。<br>   2、avformat_open_input()：打开输入音/视频文件。<br>   3、avformat_find_stream_info()：获取音视频文件信息。<br>   4、av_read_frame()：读取音视频包。<br>   5、avformat_seek_file()：定位文件。<br>   6、av_seek_frame()：定位文件。<br>   7、avformat_free_context()：释放该结构里的所有东西以及该结构本身。<br>   8、avformat_close_input()：关闭解复用器。关闭后就不再需要使用avformat_free_context 进行释放。</p> 
<h2><a id="_22"></a>三、重要结构体</h2> 
<h3><a id="31AVFormatContext_23"></a>3.1、AVFormatContext</h3> 
<p>  AVFormatContext是FFmpeg中一个非常重要的结构体，它包含了一个完整的媒体文件或媒体流的所有信息。在FFmpeg中，每一个AVFormatContext结构体都对应着一个媒体文件或媒体流。当我们使用FFmpe对媒体文件或者媒体流的解码、编码或者转换时，都是基于AVFormatContext结构体进行操作的。<br>   AVFormatContext结构体包含的信息很多，其中最重要的时AVInputFormat和AVOutputFormat，它们分表代表输入和输出的格式，包含了所有支持的编解码器、封装格式、容器格式等信息。在使用FFmpeg进行媒体文件或者媒体流的解码、编码或者转换时，我们需要根据不同的输入和输出格式来选择合适的VInputFormat和AVOutputFormat。<br>   除了AVInputFormat和AVOutputFormat以外，AVFormatContext还包含了一些其它的信息，比如AVStream，它表示一个媒体流的所有信息，包括媒体流的类型、编码方式、采样率、帧率等；AVCodecContext表示一个编解码器的所有信息，包括编解码器的类型、编解码方式、采样率、帧率等等；AVDictionary它是一个字典类型的结构体，用于存储一些额外的元数据信息，比如媒体文件的标题、作者、描述等等。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * A class for logging and @ref avoptions. Set by avformat_alloc_context().
     * Exports (de)muxer private options if they exist.
     */</span>
    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>av_class<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The input container format.
     *
     * Demuxing only, set by avformat_open_input().
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVInputFormat</span> <span class="token operator">*</span>iformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The output container format.
     *
     * Muxing only, must be set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVOutputFormat</span> <span class="token operator">*</span>oformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Format private data. This is an AVOptions-enabled struct
     * if and only if iformat/oformat.priv_class is not NULL.
     *
     * - muxing: set by avformat_write_header()
     * - demuxing: set by avformat_open_input()
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>priv_data<span class="token punctuation">;</span>

    <span class="token comment">/**
     * I/O context.
     *
     * - demuxing: either set by the user before avformat_open_input() (then
     *             the user must close it manually) or set by avformat_open_input().
     * - muxing: set by the user before avformat_write_header(). The caller must
     *           take care of closing / freeing the IO context.
     *
     * Do NOT set this field if AVFMT_NOFILE flag is set in
     * iformat/oformat.flags. In such a case, the (de)muxer will handle
     * I/O in some other way and this field will be NULL.
     */</span>
    AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">;</span>

    <span class="token comment">/* stream info */</span>
    <span class="token comment">/**
     * Flags signalling stream properties. A combination of AVFMTCTX_*.
     * Set by libavformat.
     */</span>
    <span class="token keyword">int</span> ctx_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of elements in AVFormatContext.streams.
     *
     * Set by avformat_new_stream(), must not be modified by any other code.
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_streams<span class="token punctuation">;</span>
    <span class="token comment">/**
     * A list of all streams in the file. New streams are created with
     * avformat_new_stream().
     *
     * - demuxing: streams are created by libavformat in avformat_open_input().
     *             If AVFMTCTX_NOHEADER is set in ctx_flags, then new streams may also
     *             appear in av_read_frame().
     * - muxing: streams are created by the user before avformat_write_header().
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    AVStream <span class="token operator">*</span><span class="token operator">*</span>streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * input or output URL. Unlike the old filename field, this field has no
     * length restriction.
     *
     * - demuxing: set by avformat_open_input(), initialized to an empty
     *             string if url parameter was NULL in avformat_open_input().
     * - muxing: may be set by the caller before calling avformat_write_header()
     *           (or avformat_init_output() if that is called first) to a string
     *           which is freeable by av_free(). Set to an empty string if it
     *           was NULL in avformat_init_output().
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Position of the first frame of the component, in
     * AV_TIME_BASE fractional seconds. NEVER set this value directly:
     * It is deduced from the AVStream values.
     *
     * Demuxing only, set by libavformat.
     */</span>
    <span class="token keyword">int64_t</span> start_time<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Duration of the stream, in AV_TIME_BASE fractional
     * seconds. Only set this value if you know none of the individual stream
     * durations and also do not set any of them. This is deduced from the
     * AVStream values if not set.
     *
     * Demuxing only, set by libavformat.
     */</span>
    <span class="token keyword">int64_t</span> duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Total stream bitrate in bit/s, 0 if not
     * available. Never set it directly if the file_size and the
     * duration are known as FFmpeg can compute it automatically.
     */</span>
    <span class="token keyword">int64_t</span> bit_rate<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> packet_size<span class="token punctuation">;</span>
    <span class="token keyword">int</span> max_delay<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags modifying the (de)muxer behaviour. A combination of AVFMT_FLAG_*.
     * Set by the user before avformat_open_input() / avformat_write_header().
     */</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_GENPTS</span>       <span class="token expression"><span class="token number">0x0001</span> </span><span class="token comment">///&lt; Generate missing pts even if it requires parsing future frames.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNIDX</span>       <span class="token expression"><span class="token number">0x0002</span> </span><span class="token comment">///&lt; Ignore index.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NONBLOCK</span>     <span class="token expression"><span class="token number">0x0004</span> </span><span class="token comment">///&lt; Do not block when reading packets from input.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNDTS</span>       <span class="token expression"><span class="token number">0x0008</span> </span><span class="token comment">///&lt; Ignore DTS on frames that contain both DTS &amp; PTS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOFILLIN</span>     <span class="token expression"><span class="token number">0x0010</span> </span><span class="token comment">///&lt; Do not infer any values from other values, just return what is stored in the container</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOPARSE</span>      <span class="token expression"><span class="token number">0x0020</span> </span><span class="token comment">///&lt; Do not use AVParsers, you also must set AVFMT_FLAG_NOFILLIN as the fillin code works on frames and no parsing -&gt; no frames. Also seeking to frames can not work if parsing to find frame boundaries has been disabled</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOBUFFER</span>     <span class="token expression"><span class="token number">0x0040</span> </span><span class="token comment">///&lt; Do not buffer frames when possible</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_CUSTOM_IO</span>    <span class="token expression"><span class="token number">0x0080</span> </span><span class="token comment">///&lt; The caller has supplied a custom AVIOContext, don't avio_close() it.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_DISCARD_CORRUPT</span>  <span class="token expression"><span class="token number">0x0100</span> </span><span class="token comment">///&lt; Discard frames marked corrupted</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FLUSH_PACKETS</span>    <span class="token expression"><span class="token number">0x0200</span> </span><span class="token comment">///&lt; Flush the AVIOContext every packet.</span></span>
<span class="token comment">/**
 * When muxing, try to avoid writing any random/volatile data to the output.
 * This includes any random IDs, real-time timestamps/dates, muxer version, etc.
 *
 * This flag is mainly intended for testing.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_BITEXACT</span>         <span class="token expression"><span class="token number">0x0400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SORT_DTS</span>    <span class="token expression"><span class="token number">0x10000</span> </span><span class="token comment">///&lt; try to interleave outputted packets by dts (using this flag can slow demuxing down)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FAST_SEEK</span>   <span class="token expression"><span class="token number">0x80000</span> </span><span class="token comment">///&lt; Enable fast, but inaccurate seeks for some formats</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_SHORTEST</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SHORTEST</span>   <span class="token expression"><span class="token number">0x100000</span> </span><span class="token comment">///&lt; Stop muxing when the shortest stream stops.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_AUTO_BSF</span>   <span class="token expression"><span class="token number">0x200000</span> </span><span class="token comment">///&lt; Add bitstream filters as requested by the muxer</span></span>

    <span class="token comment">/**
     * Maximum number of bytes read from input in order to determine stream
     * properties. Used when reading the global header and in
     * avformat_find_stream_info().
     *
     * Demuxing only, set by the caller before avformat_open_input().
     *
     * @note this is \e not  used for determining the \ref AVInputFormat
     *       "input format"
     * @sa format_probesize
     */</span>
    <span class="token keyword">int64_t</span> probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum duration (in AV_TIME_BASE units) of the data read
     * from input in avformat_find_stream_info().
     * Demuxing only, set by the caller before avformat_find_stream_info().
     * Can be set to 0 to let avformat choose using a heuristic.
     */</span>
    <span class="token keyword">int64_t</span> max_analyze_duration<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    <span class="token keyword">int</span> keylen<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_programs<span class="token punctuation">;</span>
    AVProgram <span class="token operator">*</span><span class="token operator">*</span>programs<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced video codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> video_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced audio codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> audio_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced subtitle codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> subtitle_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum amount of memory in bytes to use for the index of each stream.
     * If the index exceeds this size, entries will be discarded as
     * needed to maintain a smaller size. This can lead to slower or less
     * accurate seeking (depends on demuxer).
     * Demuxers for which a full in-memory index is mandatory will ignore
     * this.
     * - muxing: unused
     * - demuxing: set by user
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_index_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum amount of memory in bytes to use for buffering frames
     * obtained from realtime capture devices.
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_picture_buffer<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of chapters in AVChapter array.
     * When muxing, chapters are normally written in the file header,
     * so nb_chapters should normally be initialized before write_header
     * is called. Some muxers (e.g. mov and mkv) can also write chapters
     * in the trailer.  To write chapters in the trailer, nb_chapters
     * must be zero when write_header is called and non-zero when
     * write_trailer is called.
     * - muxing: set by user
     * - demuxing: set by libavformat
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_chapters<span class="token punctuation">;</span>
    AVChapter <span class="token operator">*</span><span class="token operator">*</span>chapters<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Metadata that applies to the whole file.
     *
     * - demuxing: set by libavformat in avformat_open_input()
     * - muxing: may be set by the caller before avformat_write_header()
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    AVDictionary <span class="token operator">*</span>metadata<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Start time of the stream in real world time, in microseconds
     * since the Unix epoch (00:00 1st January 1970). That is, pts=0 in the
     * stream was captured at this real world time.
     * - muxing: Set by the caller before avformat_write_header(). If set to
     *           either 0 or AV_NOPTS_VALUE, then the current wall-time will
     *           be used.
     * - demuxing: Set by libavformat. AV_NOPTS_VALUE if unknown. Note that
     *             the value may become known after some number of frames
     *             have been received.
     */</span>
    <span class="token keyword">int64_t</span> start_time_realtime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The number of frames used for determining the framerate in
     * avformat_find_stream_info().
     * Demuxing only, set by the caller before avformat_find_stream_info().
     */</span>
    <span class="token keyword">int</span> fps_probe_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Error recognition; higher values will detect more errors but may
     * misdetect some more or less valid parts as errors.
     * Demuxing only, set by the caller before avformat_open_input().
     */</span>
    <span class="token keyword">int</span> error_recognition<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Custom interrupt callbacks for the I/O layer.
     *
     * demuxing: set by the user before avformat_open_input().
     * muxing: set by the user before avformat_write_header()
     * (mainly useful for AVFMT_NOFILE formats). The callback
     * should also be passed to avio_open2() if it's used to
     * open the file.
     */</span>
    AVIOInterruptCB interrupt_callback<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags to enable debugging.
     */</span>
    <span class="token keyword">int</span> debug<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FF_FDEBUG_TS</span>        <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum buffering duration for interleaving.
     *
     * To ensure all the streams are interleaved correctly,
     * av_interleaved_write_frame() will wait until it has at least one packet
     * for each stream before actually writing any packets to the output file.
     * When some streams are "sparse" (i.e. there are large gaps between
     * successive packets), this can result in excessive buffering.
     *
     * This field specifies the maximum difference between the timestamps of the
     * first and the last packet in the muxing queue, above which libavformat
     * will output a packet regardless of whether it has queued a packet for all
     * the streams.
     *
     * Muxing only, set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">int64_t</span> max_interleave_delta<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Allow non-standard and experimental extension
     * @see AVCodecContext.strict_std_compliance
     */</span>
    <span class="token keyword">int</span> strict_std_compliance<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags indicating events happening on the file, a combination of
     * AVFMT_EVENT_FLAG_*.
     *
     * - demuxing: may be set by the demuxer in avformat_open_input(),
     *   avformat_find_stream_info() and av_read_frame(). Flags must be cleared
     *   by the user once the event has been handled.
     * - muxing: may be set by the user after avformat_write_header() to
     *   indicate a user-triggered event.  The muxer will clear the flags for
     *   events it has handled in av_[interleaved]_write_frame().
     */</span>
    <span class="token keyword">int</span> event_flags<span class="token punctuation">;</span>
<span class="token comment">/**
 * - demuxing: the demuxer read new metadata from the file and updated
 *   AVFormatContext.metadata accordingly
 * - muxing: the user updated AVFormatContext.metadata and wishes the muxer to
 *   write it into the file
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_EVENT_FLAG_METADATA_UPDATED</span> <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum number of packets to read while waiting for the first timestamp.
     * Decoding only.
     */</span>
    <span class="token keyword">int</span> max_ts_probe<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Avoid negative timestamps during muxing.
     * Any value of the AVFMT_AVOID_NEG_TS_* constants.
     * Note, this works better when using av_interleaved_write_frame().
     * - muxing: Set by user
     * - demuxing: unused
     */</span>
    <span class="token keyword">int</span> avoid_negative_ts<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_AUTO</span>             <span class="token expression"><span class="token operator">-</span><span class="token number">1</span> </span><span class="token comment">///&lt; Enabled when required by target format</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_DISABLED</span>          <span class="token expression"><span class="token number">0</span> </span><span class="token comment">///&lt; Do not shift timestamps even when they are negative.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_NON_NEGATIVE</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">///&lt; Shift timestamps so they are non negative</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_ZERO</span>         <span class="token expression"><span class="token number">2</span> </span><span class="token comment">///&lt; Shift timestamps so that they start at 0</span></span>

    <span class="token comment">/**
     * Transport stream id.
     * This will be moved into demuxer private options. Thus no API/ABI compatibility
     */</span>
    <span class="token keyword">int</span> ts_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Audio preload in microseconds.
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> audio_preload<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Max chunk time in microseconds.
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> max_chunk_duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Max chunk size in bytes
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> max_chunk_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * forces the use of wallclock timestamps as pts/dts of packets
     * This has undefined results in the presence of B frames.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> use_wallclock_as_timestamps<span class="token punctuation">;</span>

    <span class="token comment">/**
     * avio flags, used to force AVIO_FLAG_DIRECT.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> avio_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The duration field can be estimated through various ways, and this field can be used
     * to know how the duration was estimated.
     * - encoding: unused
     * - decoding: Read by user
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVDurationEstimationMethod</span> duration_estimation_method<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Skip initial bytes when opening stream
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int64_t</span> skip_initial_bytes<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Correct single timestamp overflows
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> correct_ts_overflow<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Force seeking to any (also non key) frames.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> seek2any<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flush the I/O context after each packet.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> flush_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * format probing score.
     * The maximal score is AVPROBE_SCORE_MAX, its set when the demuxer probes
     * the format.
     * - encoding: unused
     * - decoding: set by avformat, read by user
     */</span>
    <span class="token keyword">int</span> probe_score<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum number of bytes read from input in order to identify the
     * \ref AVInputFormat "input format". Only used when the format is not set
     * explicitly by the caller.
     *
     * Demuxing only, set by the caller before avformat_open_input().
     *
     * @sa probesize
     */</span>
    <span class="token keyword">int</span> format_probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed decoders.
     * If NULL then all are allowed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>codec_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed demuxers.
     * If NULL then all are allowed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>format_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * IO repositioned flag.
     * This is set by avformat when the underlaying IO context read pointer
     * is repositioned, for example when doing byte based seeking.
     * Demuxers can use the flag to detect such changes.
     */</span>
    <span class="token keyword">int</span> io_repositioned<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced video codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>video_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced audio codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>audio_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced subtitle codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>subtitle_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced data codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>data_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of bytes to be written as padding in a metadata header.
     * Demuxing: Unused.
     * Muxing: Set by user via av_format_set_metadata_header_padding.
     */</span>
    <span class="token keyword">int</span> metadata_header_padding<span class="token punctuation">;</span>

    <span class="token comment">/**
     * User data.
     * This is a place for some private data of the user.
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Callback used by devices to communicate with application.
     */</span>
    av_format_control_message control_message_cb<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Output timestamp offset, in microseconds.
     * Muxing: set by user
     */</span>
    <span class="token keyword">int64_t</span> output_ts_offset<span class="token punctuation">;</span>

    <span class="token comment">/**
     * dump format separator.
     * can be ", " or "\n      " or anything else
     * - muxing: Set by user.
     * - demuxing: Set by user.
     */</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>dump_separator<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced Data codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> data_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed protocols.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>protocol_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A callback for opening new IO streams.
     *
     * Whenever a muxer or a demuxer needs to open an IO stream (typically from
     * avformat_open_input() for demuxers, but for certain formats can happen at
     * other times as well), it will call this callback to obtain an IO context.
     *
     * @param s the format context
     * @param pb on success, the newly opened IO context should be returned here
     * @param url the url to open
     * @param flags a combination of AVIO_FLAG_*
     * @param options a dictionary of additional options, with the same
     *                semantics as in avio_open2()
     * @return 0 on success, a negative AVERROR code on failure
     *
     * @note Certain muxers and demuxers do nesting, i.e. they open one or more
     * additional internal format contexts. Thus the AVFormatContext pointer
     * passed to this callback may be different from the one facing the caller.
     * It will, however, have the same 'opaque' field.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span><span class="token operator">*</span>pb<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> flags<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVFORMAT_IO_CLOSE</span></span>
    <span class="token comment">/**
     * A callback for closing the streams opened with AVFormatContext.io_open().
     *
     * @deprecated use io_close2
     */</span>
    attribute_deprecated
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/**
     * ',' separated list of disallowed protocols.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>protoctypedef <span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * A class for logging and @ref avoptions. Set by avformat_alloc_context().
     * Exports (de)muxer private options if they exist.
     */</span>
    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>av_class<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The input container format.
     *
     * Demuxing only, set by avformat_open_input().
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVInputFormat</span> <span class="token operator">*</span>iformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The output container format.
     *
     * Muxing only, must be set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVOutputFormat</span> <span class="token operator">*</span>oformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Format private data. This is an AVOptions-enabled struct
     * if and only if iformat/oformat.priv_class is not NULL.
     *
     * - muxing: set by avformat_write_header()
     * - demuxing: set by avformat_open_input()
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>priv_data<span class="token punctuation">;</span>

    <span class="token comment">/**
     * I/O context.
     *
     * - demuxing: either set by the user before avformat_open_input() (then
     *             the user must close it manually) or set by avformat_open_input().
     * - muxing: set by the user before avformat_write_header(). The caller must
     *           take care of closing / freeing the IO context.
     *
     * Do NOT set this field if AVFMT_NOFILE flag is set in
     * iformat/oformat.flags. In such a case, the (de)muxer will handle
     * I/O in some other way and this field will be NULL.
     */</span>
    AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">;</span>

    <span class="token comment">/* stream info */</span>
    <span class="token comment">/**
     * Flags signalling stream properties. A combination of AVFMTCTX_*.
     * Set by libavformat.
     */</span>
    <span class="token keyword">int</span> ctx_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of elements in AVFormatContext.streams.
     *
     * Set by avformat_new_stream(), must not be modified by any other code.
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_streams<span class="token punctuation">;</span>
    <span class="token comment">/**
     * A list of all streams in the file. New streams are created with
     * avformat_new_stream().
     *
     * - demuxing: streams are created by libavformat in avformat_open_input().
     *             If AVFMTCTX_NOHEADER is set in ctx_flags, then new streams may also
     *             appear in av_read_frame().
     * - muxing: streams are created by the user before avformat_write_header().
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    AVStream <span class="token operator">*</span><span class="token operator">*</span>streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * input or output URL. Unlike the old filename field, this field has no
     * length restriction.
     *
     * - demuxing: set by avformat_open_input(), initialized to an empty
     *             string if url parameter was NULL in avformat_open_input().
     * - muxing: may be set by the caller before calling avformat_write_header()
     *           (or avformat_init_output() if that is called first) to a string
     *           which is freeable by av_free(). Set to an empty string if it
     *           was NULL in avformat_init_output().
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Position of the first frame of the component, in
     * AV_TIME_BASE fractional seconds. NEVER set this value directly:
     * It is deduced from the AVStream values.
     *
     * Demuxing only, set by libavformat.
     */</span>
    <span class="token keyword">int64_t</span> start_time<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Duration of the stream, in AV_TIME_BASE fractional
     * seconds. Only set this value if you know none of the individual stream
     * durations and also do not set any of them. This is deduced from the
     * AVStream values if not set.
     *
     * Demuxing only, set by libavformat.
     */</span>
    <span class="token keyword">int64_t</span> duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Total stream bitrate in bit/s, 0 if not
     * available. Never set it directly if the file_size and the
     * duration are known as FFmpeg can compute it automatically.
     */</span>
    <span class="token keyword">int64_t</span> bit_rate<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> packet_size<span class="token punctuation">;</span>
    <span class="token keyword">int</span> max_delay<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags modifying the (de)muxer behaviour. A combination of AVFMT_FLAG_*.
     * Set by the user before avformat_open_input() / avformat_write_header().
     */</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_GENPTS</span>       <span class="token expression"><span class="token number">0x0001</span> </span><span class="token comment">///&lt; Generate missing pts even if it requires parsing future frames.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNIDX</span>       <span class="token expression"><span class="token number">0x0002</span> </span><span class="token comment">///&lt; Ignore index.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NONBLOCK</span>     <span class="token expression"><span class="token number">0x0004</span> </span><span class="token comment">///&lt; Do not block when reading packets from input.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNDTS</span>       <span class="token expression"><span class="token number">0x0008</span> </span><span class="token comment">///&lt; Ignore DTS on frames that contain both DTS &amp; PTS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOFILLIN</span>     <span class="token expression"><span class="token number">0x0010</span> </span><span class="token comment">///&lt; Do not infer any values from other values, just return what is stored in the container</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOPARSE</span>      <span class="token expression"><span class="token number">0x0020</span> </span><span class="token comment">///&lt; Do not use AVParsers, you also must set AVFMT_FLAG_NOFILLIN as the fillin code works on frames and no parsing -&gt; no frames. Also seeking to frames can not work if parsing to find frame boundaries has been disabled</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOBUFFER</span>     <span class="token expression"><span class="token number">0x0040</span> </span><span class="token comment">///&lt; Do not buffer frames when possible</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_CUSTOM_IO</span>    <span class="token expression"><span class="token number">0x0080</span> </span><span class="token comment">///&lt; The caller has supplied a custom AVIOContext, don't avio_close() it.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_DISCARD_CORRUPT</span>  <span class="token expression"><span class="token number">0x0100</span> </span><span class="token comment">///&lt; Discard frames marked corrupted</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FLUSH_PACKETS</span>    <span class="token expression"><span class="token number">0x0200</span> </span><span class="token comment">///&lt; Flush the AVIOContext every packet.</span></span>
<span class="token comment">/**
 * When muxing, try to avoid writing any random/volatile data to the output.
 * This includes any random IDs, real-time timestamps/dates, muxer version, etc.
 *
 * This flag is mainly intended for testing.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_BITEXACT</span>         <span class="token expression"><span class="token number">0x0400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SORT_DTS</span>    <span class="token expression"><span class="token number">0x10000</span> </span><span class="token comment">///&lt; try to interleave outputted packets by dts (using this flag can slow demuxing down)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FAST_SEEK</span>   <span class="token expression"><span class="token number">0x80000</span> </span><span class="token comment">///&lt; Enable fast, but inaccurate seeks for some formats</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_SHORTEST</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SHORTEST</span>   <span class="token expression"><span class="token number">0x100000</span> </span><span class="token comment">///&lt; Stop muxing when the shortest stream stops.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_AUTO_BSF</span>   <span class="token expression"><span class="token number">0x200000</span> </span><span class="token comment">///&lt; Add bitstream filters as requested by the muxer</span></span>

    <span class="token comment">/**
     * Maximum number of bytes read from input in order to determine stream
     * properties. Used when reading the global header and in
     * avformat_find_stream_info().
     *
     * Demuxing only, set by the caller before avformat_open_input().
     *
     * @note this is \e not  used for determining the \ref AVInputFormat
     *       "input format"
     * @sa format_probesize
     */</span>
    <span class="token keyword">int64_t</span> probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum duration (in AV_TIME_BASE units) of the data read
     * from input in avformat_find_stream_info().
     * Demuxing only, set by the caller before avformat_find_stream_info().
     * Can be set to 0 to let avformat choose using a heuristic.
     */</span>
    <span class="token keyword">int64_t</span> max_analyze_duration<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    <span class="token keyword">int</span> keylen<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_programs<span class="token punctuation">;</span>
    AVProgram <span class="token operator">*</span><span class="token operator">*</span>programs<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced video codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> video_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced audio codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> audio_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced subtitle codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> subtitle_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum amount of memory in bytes to use for the index of each stream.
     * If the index exceeds this size, entries will be discarded as
     * needed to maintain a smaller size. This can lead to slower or less
     * accurate seeking (depends on demuxer).
     * Demuxers for which a full in-memory index is mandatory will ignore
     * this.
     * - muxing: unused
     * - demuxing: set by user
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_index_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum amount of memory in bytes to use for buffering frames
     * obtained from realtime capture devices.
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_picture_buffer<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of chapters in AVChapter array.
     * When muxing, chapters are normally written in the file header,
     * so nb_chapters should normally be initialized before write_header
     * is called. Some muxers (e.g. mov and mkv) can also write chapters
     * in the trailer.  To write chapters in the trailer, nb_chapters
     * must be zero when write_header is called and non-zero when
     * write_trailer is called.
     * - muxing: set by user
     * - demuxing: set by libavformat
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_chapters<span class="token punctuation">;</span>
    AVChapter <span class="token operator">*</span><span class="token operator">*</span>chapters<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Metadata that applies to the whole file.
     *
     * - demuxing: set by libavformat in avformat_open_input()
     * - muxing: may be set by the caller before avformat_write_header()
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    AVDictionary <span class="token operator">*</span>metadata<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Start time of the stream in real world time, in microseconds
     * since the Unix epoch (00:00 1st January 1970). That is, pts=0 in the
     * stream was captured at this real world time.
     * - muxing: Set by the caller before avformat_write_header(). If set to
     *           either 0 or AV_NOPTS_VALUE, then the current wall-time will
     *           be used.
     * - demuxing: Set by libavformat. AV_NOPTS_VALUE if unknown. Note that
     *             the value may become known after some number of frames
     *             have been received.
     */</span>
    <span class="token keyword">int64_t</span> start_time_realtime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The number of frames used for determining the framerate in
     * avformat_find_stream_info().
     * Demuxing only, set by the caller before avformat_find_stream_info().
     */</span>
    <span class="token keyword">int</span> fps_probe_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Error recognition; higher values will detect more errors but may
     * misdetect some more or less valid parts as errors.
     * Demuxing only, set by the caller before avformat_open_input().
     */</span>
    <span class="token keyword">int</span> error_recognition<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Custom interrupt callbacks for the I/O layer.
     *
     * demuxing: set by the user before avformat_open_input().
     * muxing: set by the user before avformat_write_header()
     * (mainly useful for AVFMT_NOFILE formats). The callback
     * should also be passed to avio_open2() if it's used to
     * open the file.
     */</span>
    AVIOInterruptCB interrupt_callback<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags to enable debugging.
     */</span>
    <span class="token keyword">int</span> debug<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FF_FDEBUG_TS</span>        <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum buffering duration for interleaving.
     *
     * To ensure all the streams are interleaved correctly,
     * av_interleaved_write_frame() will wait until it has at least one packet
     * for each stream before actually writing any packets to the output file.
     * When some streams are "sparse" (i.e. there are large gaps between
     * successive packets), this can result in excessive buffering.
     *
     * This field specifies the maximum difference between the timestamps of the
     * first and the last packet in the muxing queue, above which libavformat
     * will output a packet regardless of whether it has queued a packet for all
     * the streams.
     *
     * Muxing only, set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">int64_t</span> max_interleave_delta<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Allow non-standard and experimental extension
     * @see AVCodecContext.strict_std_compliance
     */</span>
    <span class="token keyword">int</span> strict_std_compliance<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags indicating events happening on the file, a combination of
     * AVFMT_EVENT_FLAG_*.
     *
     * - demuxing: may be set by the demuxer in avformat_open_input(),
     *   avformat_find_stream_info() and av_read_frame(). Flags must be cleared
     *   by the user once the event has been handled.
     * - muxing: may be set by the user after avformat_write_header() to
     *   indicate a user-triggered event.  The muxer will clear the flags for
     *   events it has handled in av_[interleaved]_write_frame().
     */</span>
    <span class="token keyword">int</span> event_flags<span class="token punctuation">;</span>
<span class="token comment">/**
 * - demuxing: the demuxer read new metadata from the file and updated
 *   AVFormatContext.metadata accordingly
 * - muxing: the user updated AVFormatContext.metadata and wishes the muxer to
 *   write it into the file
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_EVENT_FLAG_METADATA_UPDATED</span> <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum number of packets to read while waiting for the first timestamp.
     * Decoding only.
     */</span>
    <span class="token keyword">int</span> max_ts_probe<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Avoid negative timestamps during muxing.
     * Any value of the AVFMT_AVOID_NEG_TS_* constants.
     * Note, this works better when using av_interleaved_write_frame().
     * - muxing: Set by user
     * - demuxing: unused
     */</span>
    <span class="token keyword">int</span> avoid_negative_ts<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_AUTO</span>             <span class="token expression"><span class="token operator">-</span><span class="token number">1</span> </span><span class="token comment">///&lt; Enabled when required by target format</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_DISABLED</span>          <span class="token expression"><span class="token number">0</span> </span><span class="token comment">///&lt; Do not shift timestamps even when they are negative.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_NON_NEGATIVE</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">///&lt; Shift timestamps so they are non negative</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_ZERO</span>         <span class="token expression"><span class="token number">2</span> </span><span class="token comment">///&lt; Shift timestamps so that they start at 0</span></span>

    <span class="token comment">/**
     * Transport stream id.
     * This will be moved into demuxer private options. Thus no API/ABI compatibility
     */</span>
    <span class="token keyword">int</span> ts_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Audio preload in microseconds.
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> audio_preload<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Max chunk time in microseconds.
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> max_chunk_duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Max chunk size in bytes
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> max_chunk_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * forces the use of wallclock timestamps as pts/dts of packets
     * This has undefined results in the presence of B frames.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> use_wallclock_as_timestamps<span class="token punctuation">;</span>

    <span class="token comment">/**
     * avio flags, used to force AVIO_FLAG_DIRECT.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> avio_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The duration field can be estimated through various ways, and this field can be used
     * to know how the duration was estimated.
     * - encoding: unused
     * - decoding: Read by user
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVDurationEstimationMethod</span> duration_estimation_method<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Skip initial bytes when opening stream
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int64_t</span> skip_initial_bytes<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Correct single timestamp overflows
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> correct_ts_overflow<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Force seeking to any (also non key) frames.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> seek2any<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flush the I/O context after each packet.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> flush_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * format probing score.
     * The maximal score is AVPROBE_SCORE_MAX, its set when the demuxer probes
     * the format.
     * - encoding: unused
     * - decoding: set by avformat, read by user
     */</span>
    <span class="token keyword">int</span> probe_score<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum number of bytes read from input in order to identify the
     * \ref AVInputFormat "input format". Only used when the format is not set
     * explicitly by the caller.
     *
     * Demuxing only, set by the caller before avformat_open_input().
     *
     * @sa probesize
     */</span>
    <span class="token keyword">int</span> format_probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed decoders.
     * If NULL then all are allowed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>codec_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed demuxers.
     * If NULL then all are allowed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>format_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * IO repositioned flag.
     * This is set by avformat when the underlaying IO context read pointer
     * is repositioned, for example when doing byte based seeking.
     * Demuxers can use the flag to detect such changes.
     */</span>
    <span class="token keyword">int</span> io_repositioned<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced video codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>video_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced audio codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>audio_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced subtitle codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>subtitle_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced data codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>data_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of bytes to be written as padding in a metadata header.
     * Demuxing: Unused.
     * Muxing: Set by user via av_format_set_metadata_header_padding.
     */</span>
    <span class="token keyword">int</span> metadata_header_padding<span class="token punctuation">;</span>

    <span class="token comment">/**
     * User data.
     * This is a place for some private data of the user.
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Callback used by devices to communicate with application.
     */</span>
    av_format_control_message control_message_cb<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Output timestamp offset, in microseconds.
     * Muxing: set by user
     */</span>
    <span class="token keyword">int64_t</span> output_ts_offset<span class="token punctuation">;</span>

    <span class="token comment">/**
     * dump format separator.
     * can be ", " or "\n      " or anything else
     * - muxing: Set by user.
     * - demuxing: Set by user.
     */</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>dump_separator<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced Data codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> data_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed protocols.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>protocol_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A callback for opening new IO streams.
     *
     * Whenever a muxer or a demuxer needs to open an IO stream (typically from
     * avformat_open_input() for demuxers, but for certain formats can happen at
     * other times as well), it will call this callback to obtain an IO context.
     *
     * @param s the format context
     * @param pb on success, the newly opened IO context should be returned here
     * @param url the url to open
     * @param flags a combination of AVIO_FLAG_*
     * @param options a dictionary of additional options, with the same
     *                semantics as in avio_open2()
     * @return 0 on success, a negative AVERROR code on failure
     *
     * @note Certain muxers and demuxers do nesting, i.e. they open one or more
     * additional internal format contexts. Thus the AVFormatContext pointer
     * passed to this callback may be different from the one facing the caller.
     * It will, however, have the same 'opaque' field.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span><span class="token operator">*</span>pb<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> flags<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVFORMAT_IO_CLOSE</span></span>
    <span class="token comment">/**
     * A callback for closing the streams opened with AVFormatContext.io_open().
     *
     * @deprecated use io_close2
     */</span>
    attribute_deprecated
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/**
     * ',' separated list of disallowed protocols.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>protocol_blacklist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The maximum number of streams.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> max_streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Skip duration calcuation in estimate_timings_from_pts.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> skip_estimate_duration_from_pts<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum number of packets that can be probed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> max_probe_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A callback for closing the streams opened with AVFormatContext.io_open().
     *
     * Using this is preferred over io_close, because this can return an error.
     * Therefore this callback is used instead of io_close by the generic
     * libavformat code if io_close is NULL or the default.
     *
     * @param s the format context
     * @param pb IO context to be closed and freed
     * @return 0 on success, a negative AVERROR code on failure
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> AVFormatContext<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * A class for logging and @ref avoptions. Set by avformat_alloc_context().
     * Exports (de)muxer private options if they exist.
     */</span>
    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>av_class<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The input container format.
     *
     * Demuxing only, set by avformat_open_input().
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVInputFormat</span> <span class="token operator">*</span>iformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The output container format.
     *
     * Muxing only, must be set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVOutputFormat</span> <span class="token operator">*</span>oformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Format private data. This is an AVOptions-enabled struct
     * if and only if iformat/oformat.priv_class is not NULL.
     *
     * - muxing: set by avformat_write_header()
     * - demuxing: set by avformat_open_input()
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>priv_data<span class="token punctuation">;</span>

    <span class="token comment">/**
     * I/O context.
     *
     * - demuxing: either set by the user before avformat_open_input() (then
     *             the user must close it manually) or set by avformat_open_input().
     * - muxing: set by the user before avformat_write_header(). The caller must
     *           take care of closing / freeing the IO context.
     *
     * Do NOT set this field if AVFMT_NOFILE flag is set in
     * iformat/oformat.flags. In such a case, the (de)muxer will handle
     * I/O in some other way and this field will be NULL.
     */</span>
    AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">;</span>

    <span class="token comment">/* stream info */</span>
    <span class="token comment">/**
     * Flags signalling stream properties. A combination of AVFMTCTX_*.
     * Set by libavformat.
     */</span>
    <span class="token keyword">int</span> ctx_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of elements in AVFormatContext.streams.
     *
     * Set by avformat_new_stream(), must not be modified by any other code.
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_streams<span class="token punctuation">;</span>
    <span class="token comment">/**
     * A list of all streams in the file. New streams are created with
     * avformat_new_stream().
     *
     * - demuxing: streams are created by libavformat in avformat_open_input().
     *             If AVFMTCTX_NOHEADER is set in ctx_flags, then new streams may also
     *             appear in av_read_frame().
     * - muxing: streams are created by the user before avformat_write_header().
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    AVStream <span class="token operator">*</span><span class="token operator">*</span>streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * input or output URL. Unlike the old filename field, this field has no
     * length restriction.
     *
     * - demuxing: set by avformat_open_input(), initialized to an empty
     *             string if url parameter was NULL in avformat_open_input().
     * - muxing: may be set by the caller before calling avformat_write_header()
     *           (or avformat_init_output() if that is called first) to a string
     *           which is freeable by av_free(). Set to an empty string if it
     *           was NULL in avformat_init_output().
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Position of the first frame of the component, in
     * AV_TIME_BASE fractional seconds. NEVER set this value directly:
     * It is deduced from the AVStream values.
     *
     * Demuxing only, set by libavformat.
     */</span>
    <span class="token keyword">int64_t</span> start_time<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Duration of the stream, in AV_TIME_BASE fractional
     * seconds. Only set this value if you know none of the individual stream
     * durations and also do not set any of them. This is deduced from the
     * AVStream values if not set.
     *
     * Demuxing only, set by libavformat.
     */</span>
    <span class="token keyword">int64_t</span> duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Total stream bitrate in bit/s, 0 if not
     * available. Never set it directly if the file_size and the
     * duration are known as FFmpeg can compute it automatically.
     */</span>
    <span class="token keyword">int64_t</span> bit_rate<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> packet_size<span class="token punctuation">;</span>
    <span class="token keyword">int</span> max_delay<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags modifying the (de)muxer behaviour. A combination of AVFMT_FLAG_*.
     * Set by the user before avformat_open_input() / avformat_write_header().
     */</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_GENPTS</span>       <span class="token expression"><span class="token number">0x0001</span> </span><span class="token comment">///&lt; Generate missing pts even if it requires parsing future frames.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNIDX</span>       <span class="token expression"><span class="token number">0x0002</span> </span><span class="token comment">///&lt; Ignore index.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NONBLOCK</span>     <span class="token expression"><span class="token number">0x0004</span> </span><span class="token comment">///&lt; Do not block when reading packets from input.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNDTS</span>       <span class="token expression"><span class="token number">0x0008</span> </span><span class="token comment">///&lt; Ignore DTS on frames that contain both DTS &amp; PTS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOFILLIN</span>     <span class="token expression"><span class="token number">0x0010</span> </span><span class="token comment">///&lt; Do not infer any values from other values, just return what is stored in the container</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOPARSE</span>      <span class="token expression"><span class="token number">0x0020</span> </span><span class="token comment">///&lt; Do not use AVParsers, you also must set AVFMT_FLAG_NOFILLIN as the fillin code works on frames and no parsing -&gt; no frames. Also seeking to frames can not work if parsing to find frame boundaries has been disabled</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOBUFFER</span>     <span class="token expression"><span class="token number">0x0040</span> </span><span class="token comment">///&lt; Do not buffer frames when possible</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_CUSTOM_IO</span>    <span class="token expression"><span class="token number">0x0080</span> </span><span class="token comment">///&lt; The caller has supplied a custom AVIOContext, don't avio_close() it.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_DISCARD_CORRUPT</span>  <span class="token expression"><span class="token number">0x0100</span> </span><span class="token comment">///&lt; Discard frames marked corrupted</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FLUSH_PACKETS</span>    <span class="token expression"><span class="token number">0x0200</span> </span><span class="token comment">///&lt; Flush the AVIOContext every packet.</span></span>
<span class="token comment">/**
 * When muxing, try to avoid writing any random/volatile data to the output.
 * This includes any random IDs, real-time timestamps/dates, muxer version, etc.
 *
 * This flag is mainly intended for testing.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_BITEXACT</span>         <span class="token expression"><span class="token number">0x0400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SORT_DTS</span>    <span class="token expression"><span class="token number">0x10000</span> </span><span class="token comment">///&lt; try to interleave outputted packets by dts (using this flag can slow demuxing down)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FAST_SEEK</span>   <span class="token expression"><span class="token number">0x80000</span> </span><span class="token comment">///&lt; Enable fast, but inaccurate seeks for some formats</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_SHORTEST</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SHORTEST</span>   <span class="token expression"><span class="token number">0x100000</span> </span><span class="token comment">///&lt; Stop muxing when the shortest stream stops.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_AUTO_BSF</span>   <span class="token expression"><span class="token number">0x200000</span> </span><span class="token comment">///&lt; Add bitstream filters as requested by the muxer</span></span>

    <span class="token comment">/**
     * Maximum number of bytes read from input in order to determine stream
     * properties. Used when reading the global header and in
     * avformat_find_stream_info().
     *
     * Demuxing only, set by the caller before avformat_open_input().
     *
     * @note this is \e not  used for determining the \ref AVInputFormat
     *       "input format"
     * @sa format_probesize
     */</span>
    <span class="token keyword">int64_t</span> probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum duration (in AV_TIME_BASE units) of the data read
     * from input in avformat_find_stream_info().
     * Demuxing only, set by the caller before avformat_find_stream_info().
     * Can be set to 0 to let avformat choose using a heuristic.
     */</span>
    <span class="token keyword">int64_t</span> max_analyze_duration<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    <span class="token keyword">int</span> keylen<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_programs<span class="token punctuation">;</span>
    AVProgram <span class="token operator">*</span><span class="token operator">*</span>programs<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced video codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> video_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced audio codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> audio_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced subtitle codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> subtitle_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum amount of memory in bytes to use for the index of each stream.
     * If the index exceeds this size, entries will be discarded as
     * needed to maintain a smaller size. This can lead to slower or less
     * accurate seeking (depends on demuxer).
     * Demuxers for which a full in-memory index is mandatory will ignore
     * this.
     * - muxing: unused
     * - demuxing: set by user
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_index_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum amount of memory in bytes to use for buffering frames
     * obtained from realtime capture devices.
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_picture_buffer<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of chapters in AVChapter array.
     * When muxing, chapters are normally written in the file header,
     * so nb_chapters should normally be initialized before write_header
     * is called. Some muxers (e.g. mov and mkv) can also write chapters
     * in the trailer.  To write chapters in the trailer, nb_chapters
     * must be zero when write_header is called and non-zero when
     * write_trailer is called.
     * - muxing: set by user
     * - demuxing: set by libavformat
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_chapters<span class="token punctuation">;</span>
    AVChapter <span class="token operator">*</span><span class="token operator">*</span>chapters<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Metadata that applies to the whole file.
     *
     * - demuxing: set by libavformat in avformat_open_input()
     * - muxing: may be set by the caller before avformat_write_header()
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    AVDictionary <span class="token operator">*</span>metadata<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Start time of the stream in real world time, in microseconds
     * since the Unix epoch (00:00 1st January 1970). That is, pts=0 in the
     * stream was captured at this real world time.
     * - muxing: Set by the caller before avformat_write_header(). If set to
     *           either 0 or AV_NOPTS_VALUE, then the current wall-time will
     *           be used.
     * - demuxing: Set by libavformat. AV_NOPTS_VALUE if unknown. Note that
     *             the value may become known after some number of frames
     *             have been received.
     */</span>
    <span class="token keyword">int64_t</span> start_time_realtime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The number of frames used for determining the framerate in
     * avformat_find_stream_info().
     * Demuxing only, set by the caller before avformat_find_stream_info().
     */</span>
    <span class="token keyword">int</span> fps_probe_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Error recognition; higher values will detect more errors but may
     * misdetect some more or less valid parts as errors.
     * Demuxing only, set by the caller before avformat_open_input().
     */</span>
    <span class="token keyword">int</span> error_recognition<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Custom interrupt callbacks for the I/O layer.
     *
     * demuxing: set by the user before avformat_open_input().
     * muxing: set by the user before avformat_write_header()
     * (mainly useful for AVFMT_NOFILE formats). The callback
     * should also be passed to avio_open2() if it's used to
     * open the file.
     */</span>
    AVIOInterruptCB interrupt_callback<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags to enable debugging.
     */</span>
    <span class="token keyword">int</span> debug<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FF_FDEBUG_TS</span>        <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum buffering duration for interleaving.
     *
     * To ensure all the streams are interleaved correctly,
     * av_interleaved_write_frame() will wait until it has at least one packet
     * for each stream before actually writing any packets to the output file.
     * When some streams are "sparse" (i.e. there are large gaps between
     * successive packets), this can result in excessive buffering.
     *
     * This field specifies the maximum difference between the timestamps of the
     * first and the last packet in the muxing queue, above which libavformat
     * will output a packet regardless of whether it has queued a packet for all
     * the streams.
     *
     * Muxing only, set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">int64_t</span> max_interleave_delta<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Allow non-standard and experimental extension
     * @see AVCodecContext.strict_std_compliance
     */</span>
    <span class="token keyword">int</span> strict_std_compliance<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags indicating events happening on the file, a combination of
     * AVFMT_EVENT_FLAG_*.
     *
     * - demuxing: may be set by the demuxer in avformat_open_input(),
     *   avformat_find_stream_info() and av_read_frame(). Flags must be cleared
     *   by the user once the event has been handled.
     * - muxing: may be set by the user after avformat_write_header() to
     *   indicate a user-triggered event.  The muxer will clear the flags for
     *   events it has handled in av_[interleaved]_write_frame().
     */</span>
    <span class="token keyword">int</span> event_flags<span class="token punctuation">;</span>
<span class="token comment">/**
 * - demuxing: the demuxer read new metadata from the file and updated
 *   AVFormatContext.metadata accordingly
 * - muxing: the user updated AVFormatContext.metadata and wishes the muxer to
 *   write it into the file
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_EVENT_FLAG_METADATA_UPDATED</span> <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum number of packets to read while waiting for the first timestamp.
     * Decoding only.
     */</span>
    <span class="token keyword">int</span> max_ts_probe<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Avoid negative timestamps during muxing.
     * Any value of the AVFMT_AVOID_NEG_TS_* constants.
     * Note, this works better when using av_interleaved_write_frame().
     * - muxing: Set by user
     * - demuxing: unused
     */</span>
    <span class="token keyword">int</span> avoid_negative_ts<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_AUTO</span>             <span class="token expression"><span class="token operator">-</span><span class="token number">1</span> </span><span class="token comment">///&lt; Enabled when required by target format</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_DISABLED</span>          <span class="token expression"><span class="token number">0</span> </span><span class="token comment">///&lt; Do not shift timestamps even when they are negative.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_NON_NEGATIVE</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">///&lt; Shift timestamps so they are non negative</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_ZERO</span>         <span class="token expression"><span class="token number">2</span> </span><span class="token comment">///&lt; Shift timestamps so that they start at 0</span></span>

    <span class="token comment">/**
     * Transport stream id.
     * This will be moved into demuxer private options. Thus no API/ABI compatibility
     */</span>
    <span class="token keyword">int</span> ts_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Audio preload in microseconds.
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> audio_preload<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Max chunk time in microseconds.
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> max_chunk_duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Max chunk size in bytes
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> max_chunk_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * forces the use of wallclock timestamps as pts/dts of packets
     * This has undefined results in the presence of B frames.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> use_wallclock_as_timestamps<span class="token punctuation">;</span>

    <span class="token comment">/**
     * avio flags, used to force AVIO_FLAG_DIRECT.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> avio_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The duration field can be estimated through various ways, and this field can be used
     * to know how the duration was estimated.
     * - encoding: unused
     * - decoding: Read by user
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVDurationEstimationMethod</span> duration_estimation_method<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Skip initial bytes when opening stream
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int64_t</span> skip_initial_bytes<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Correct single timestamp overflows
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> correct_ts_overflow<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Force seeking to any (also non key) frames.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> seek2any<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flush the I/O context after each packet.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> flush_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * format probing score.
     * The maximal score is AVPROBE_SCORE_MAX, its set when the demuxer probes
     * the format.
     * - encoding: unused
     * - decoding: set by avformat, read by user
     */</span>
    <span class="token keyword">int</span> probe_score<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum number of bytes read from input in order to identify the
     * \ref AVInputFormat "input format". Only used when the format is not set
     * explicitly by the caller.
     *
     * Demuxing only, set by the caller before avformat_open_input().
     *
     * @sa probesize
     */</span>
    <span class="token keyword">int</span> format_probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed decoders.
     * If NULL then all are allowed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>codec_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed demuxers.
     * If NULL then all are allowed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>format_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * IO repositioned flag.
     * This is set by avformat when the underlaying IO context read pointer
     * is repositioned, for example when doing byte based seeking.
     * Demuxers can use the flag to detect such changes.
     */</span>
    <span class="token keyword">int</span> io_repositioned<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced video codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>video_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced audio codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>audio_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced subtitle codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>subtitle_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced data codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>data_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of bytes to be written as padding in a metadata header.
     * Demuxing: Unused.
     * Muxing: Set by user via av_format_set_metadata_header_padding.
     */</span>
    <span class="token keyword">int</span> metadata_header_padding<span class="token punctuation">;</span>

    <span class="token comment">/**
     * User data.
     * This is a place for some private data of the user.
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Callback used by devices to communicate with application.
     */</span>
    av_format_control_message control_message_cb<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Output timestamp offset, in microseconds.
     * Muxing: set by user
     */</span>
    <span class="token keyword">int64_t</span> output_ts_offset<span class="token punctuation">;</span>

    <span class="token comment">/**
     * dump format separator.
     * can be ", " or "\n      " or anything else
     * - muxing: Set by user.
     * - demuxing: Set by user.
     */</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>dump_separator<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced Data codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> data_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed protocols.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>protocol_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A callback for opening new IO streams.
     *
     * Whenever a muxer or a demuxer needs to open an IO stream (typically from
     * avformat_open_input() for demuxers, but for certain formats can happen at
     * other times as well), it will call this callback to obtain an IO context.
     *
     * @param s the format context
     * @param pb on success, the newly opened IO context should be returned here
     * @param url the url to open
     * @param flags a combination of AVIO_FLAG_*
     * @param options a dictionary of additional options, with the same
     *                semantics as in avio_open2()
     * @return 0 on success, a negative AVERROR code on failure
     *
     * @note Certain muxers and demuxers do nesting, i.e. they open one or more
     * additional internal format contexts. Thus the AVFormatContext pointer
     * passed to this callback may be different from the one facing the caller.
     * It will, however, have the same 'opaque' field.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span><span class="token operator">*</span>pb<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> flags<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVFORMAT_IO_CLOSE</span></span>
    <span class="token comment">/**
     * A callback for closing the streams opened with AVFormatContext.io_open().
     *
     * @deprecated use io_close2
     */</span>
    attribute_deprecated
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/**
     * ',' separated list of disallowed protocols.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>protocol_blacklist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The maximum number of streams.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> max_streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Skip duration calcuation in estimate_timings_from_pts.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> skip_estimate_duration_from_pts<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum number of packets that can be probed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> max_probe_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A callback for closing the streams opened with AVFormatContext.io_open().
     *
     * Using this is preferred over io_close, because this can return an error.
     * Therefore this callback is used instead of io_close by the generic
     * libavformat code if io_close is NULL or the default.
     *
     * @param s the format context
     * @param pb IO context to be closed and freed
     * @return 0 on success, a negative AVERROR code on failure
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> AVFormatContext<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * A class for logging and @ref avoptions. Set by avformat_alloc_context().
     * Exports (de)muxer private options if they exist.
     */</span>
    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>av_class<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The input container format.
     *
     * Demuxing only, set by avformat_open_input().
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVInputFormat</span> <span class="token operator">*</span>iformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The output container format.
     *
     * Muxing only, must be set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVOutputFormat</span> <span class="token operator">*</span>oformat<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Format private data. This is an AVOptions-enabled struct
     * if and only if iformat/oformat.priv_class is not NULL.
     *
     * - muxing: set by avformat_write_header()
     * - demuxing: set by avformat_open_input()
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>priv_data<span class="token punctuation">;</span>

    <span class="token comment">/**
     * I/O context.
     *
     * - demuxing: either set by the user before avformat_open_input() (then
     *             the user must close it manually) or set by avformat_open_input().
     * - muxing: set by the user before avformat_write_header(). The caller must
     *           take care of closing / freeing the IO context.
     *
     * Do NOT set this field if AVFMT_NOFILE flag is set in
     * iformat/oformat.flags. In such a case, the (de)muxer will handle
     * I/O in some other way and this field will be NULL.
     */</span>
    AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">;</span>

    <span class="token comment">/* stream info */</span>
    <span class="token comment">/**
     * Flags signalling stream properties. A combination of AVFMTCTX_*.
     * Set by libavformat.
     */</span>
    <span class="token keyword">int</span> ctx_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of elements in AVFormatContext.streams.
     *
     * Set by avformat_new_stream(), must not be modified by any other code.
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_streams<span class="token punctuation">;</span>
    <span class="token comment">/**
     * A list of all streams in the file. New streams are created with
     * avformat_new_stream().
     *
     * - demuxing: streams are created by libavformat in avformat_open_input().
     *             If AVFMTCTX_NOHEADER is set in ctx_flags, then new streams may also
     *             appear in av_read_frame().
     * - muxing: streams are created by the user before avformat_write_header().
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    AVStream <span class="token operator">*</span><span class="token operator">*</span>streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * input or output URL. Unlike the old filename field, this field has no
     * length restriction.
     *
     * - demuxing: set by avformat_open_input(), initialized to an empty
     *             string if url parameter was NULL in avformat_open_input().
     * - muxing: may be set by the caller before calling avformat_write_header()
     *           (or avformat_init_output() if that is called first) to a string
     *           which is freeable by av_free(). Set to an empty string if it
     *           was NULL in avformat_init_output().
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Position of the first frame of the component, in
     * AV_TIME_BASE fractional seconds. NEVER set this value directly:
     * It is deduced from the AVStream values.
     *
     * Demuxing only, set by libavformat.
     */</span>
    <span class="token keyword">int64_t</span> start_time<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Duration of the stream, in AV_TIME_BASE fractional
     * seconds. Only set this value if you know none of the individual stream
     * durations and also do not set any of them. This is deduced from the
     * AVStream values if not set.
     *
     * Demuxing only, set by libavformat.
     */</span>
    <span class="token keyword">int64_t</span> duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Total stream bitrate in bit/s, 0 if not
     * available. Never set it directly if the file_size and the
     * duration are known as FFmpeg can compute it automatically.
     */</span>
    <span class="token keyword">int64_t</span> bit_rate<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> packet_size<span class="token punctuation">;</span>
    <span class="token keyword">int</span> max_delay<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags modifying the (de)muxer behaviour. A combination of AVFMT_FLAG_*.
     * Set by the user before avformat_open_input() / avformat_write_header().
     */</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_GENPTS</span>       <span class="token expression"><span class="token number">0x0001</span> </span><span class="token comment">///&lt; Generate missing pts even if it requires parsing future frames.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNIDX</span>       <span class="token expression"><span class="token number">0x0002</span> </span><span class="token comment">///&lt; Ignore index.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NONBLOCK</span>     <span class="token expression"><span class="token number">0x0004</span> </span><span class="token comment">///&lt; Do not block when reading packets from input.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_IGNDTS</span>       <span class="token expression"><span class="token number">0x0008</span> </span><span class="token comment">///&lt; Ignore DTS on frames that contain both DTS &amp; PTS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOFILLIN</span>     <span class="token expression"><span class="token number">0x0010</span> </span><span class="token comment">///&lt; Do not infer any values from other values, just return what is stored in the container</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOPARSE</span>      <span class="token expression"><span class="token number">0x0020</span> </span><span class="token comment">///&lt; Do not use AVParsers, you also must set AVFMT_FLAG_NOFILLIN as the fillin code works on frames and no parsing -&gt; no frames. Also seeking to frames can not work if parsing to find frame boundaries has been disabled</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_NOBUFFER</span>     <span class="token expression"><span class="token number">0x0040</span> </span><span class="token comment">///&lt; Do not buffer frames when possible</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_CUSTOM_IO</span>    <span class="token expression"><span class="token number">0x0080</span> </span><span class="token comment">///&lt; The caller has supplied a custom AVIOContext, don't avio_close() it.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_DISCARD_CORRUPT</span>  <span class="token expression"><span class="token number">0x0100</span> </span><span class="token comment">///&lt; Discard frames marked corrupted</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FLUSH_PACKETS</span>    <span class="token expression"><span class="token number">0x0200</span> </span><span class="token comment">///&lt; Flush the AVIOContext every packet.</span></span>
<span class="token comment">/**
 * When muxing, try to avoid writing any random/volatile data to the output.
 * This includes any random IDs, real-time timestamps/dates, muxer version, etc.
 *
 * This flag is mainly intended for testing.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_BITEXACT</span>         <span class="token expression"><span class="token number">0x0400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SORT_DTS</span>    <span class="token expression"><span class="token number">0x10000</span> </span><span class="token comment">///&lt; try to interleave outputted packets by dts (using this flag can slow demuxing down)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_FAST_SEEK</span>   <span class="token expression"><span class="token number">0x80000</span> </span><span class="token comment">///&lt; Enable fast, but inaccurate seeks for some formats</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_SHORTEST</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_SHORTEST</span>   <span class="token expression"><span class="token number">0x100000</span> </span><span class="token comment">///&lt; Stop muxing when the shortest stream stops.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_FLAG_AUTO_BSF</span>   <span class="token expression"><span class="token number">0x200000</span> </span><span class="token comment">///&lt; Add bitstream filters as requested by the muxer</span></span>

    <span class="token comment">/**
     * Maximum number of bytes read from input in order to determine stream
     * properties. Used when reading the global header and in
     * avformat_find_stream_info().
     *
     * Demuxing only, set by the caller before avformat_open_input().
     *
     * @note this is \e not  used for determining the \ref AVInputFormat
     *       "input format"
     * @sa format_probesize
     */</span>
    <span class="token keyword">int64_t</span> probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum duration (in AV_TIME_BASE units) of the data read
     * from input in avformat_find_stream_info().
     * Demuxing only, set by the caller before avformat_find_stream_info().
     * Can be set to 0 to let avformat choose using a heuristic.
     */</span>
    <span class="token keyword">int64_t</span> max_analyze_duration<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    <span class="token keyword">int</span> keylen<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_programs<span class="token punctuation">;</span>
    AVProgram <span class="token operator">*</span><span class="token operator">*</span>programs<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced video codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> video_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced audio codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> audio_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced subtitle codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> subtitle_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum amount of memory in bytes to use for the index of each stream.
     * If the index exceeds this size, entries will be discarded as
     * needed to maintain a smaller size. This can lead to slower or less
     * accurate seeking (depends on demuxer).
     * Demuxers for which a full in-memory index is mandatory will ignore
     * this.
     * - muxing: unused
     * - demuxing: set by user
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_index_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum amount of memory in bytes to use for buffering frames
     * obtained from realtime capture devices.
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_picture_buffer<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of chapters in AVChapter array.
     * When muxing, chapters are normally written in the file header,
     * so nb_chapters should normally be initialized before write_header
     * is called. Some muxers (e.g. mov and mkv) can also write chapters
     * in the trailer.  To write chapters in the trailer, nb_chapters
     * must be zero when write_header is called and non-zero when
     * write_trailer is called.
     * - muxing: set by user
     * - demuxing: set by libavformat
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb_chapters<span class="token punctuation">;</span>
    AVChapter <span class="token operator">*</span><span class="token operator">*</span>chapters<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Metadata that applies to the whole file.
     *
     * - demuxing: set by libavformat in avformat_open_input()
     * - muxing: may be set by the caller before avformat_write_header()
     *
     * Freed by libavformat in avformat_free_context().
     */</span>
    AVDictionary <span class="token operator">*</span>metadata<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Start time of the stream in real world time, in microseconds
     * since the Unix epoch (00:00 1st January 1970). That is, pts=0 in the
     * stream was captured at this real world time.
     * - muxing: Set by the caller before avformat_write_header(). If set to
     *           either 0 or AV_NOPTS_VALUE, then the current wall-time will
     *           be used.
     * - demuxing: Set by libavformat. AV_NOPTS_VALUE if unknown. Note that
     *             the value may become known after some number of frames
     *             have been received.
     */</span>
    <span class="token keyword">int64_t</span> start_time_realtime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The number of frames used for determining the framerate in
     * avformat_find_stream_info().
     * Demuxing only, set by the caller before avformat_find_stream_info().
     */</span>
    <span class="token keyword">int</span> fps_probe_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Error recognition; higher values will detect more errors but may
     * misdetect some more or less valid parts as errors.
     * Demuxing only, set by the caller before avformat_open_input().
     */</span>
    <span class="token keyword">int</span> error_recognition<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Custom interrupt callbacks for the I/O layer.
     *
     * demuxing: set by the user before avformat_open_input().
     * muxing: set by the user before avformat_write_header()
     * (mainly useful for AVFMT_NOFILE formats). The callback
     * should also be passed to avio_open2() if it's used to
     * open the file.
     */</span>
    AVIOInterruptCB interrupt_callback<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags to enable debugging.
     */</span>
    <span class="token keyword">int</span> debug<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FF_FDEBUG_TS</span>        <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum buffering duration for interleaving.
     *
     * To ensure all the streams are interleaved correctly,
     * av_interleaved_write_frame() will wait until it has at least one packet
     * for each stream before actually writing any packets to the output file.
     * When some streams are "sparse" (i.e. there are large gaps between
     * successive packets), this can result in excessive buffering.
     *
     * This field specifies the maximum difference between the timestamps of the
     * first and the last packet in the muxing queue, above which libavformat
     * will output a packet regardless of whether it has queued a packet for all
     * the streams.
     *
     * Muxing only, set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">int64_t</span> max_interleave_delta<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Allow non-standard and experimental extension
     * @see AVCodecContext.strict_std_compliance
     */</span>
    <span class="token keyword">int</span> strict_std_compliance<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flags indicating events happening on the file, a combination of
     * AVFMT_EVENT_FLAG_*.
     *
     * - demuxing: may be set by the demuxer in avformat_open_input(),
     *   avformat_find_stream_info() and av_read_frame(). Flags must be cleared
     *   by the user once the event has been handled.
     * - muxing: may be set by the user after avformat_write_header() to
     *   indicate a user-triggered event.  The muxer will clear the flags for
     *   events it has handled in av_[interleaved]_write_frame().
     */</span>
    <span class="token keyword">int</span> event_flags<span class="token punctuation">;</span>
<span class="token comment">/**
 * - demuxing: the demuxer read new metadata from the file and updated
 *   AVFormatContext.metadata accordingly
 * - muxing: the user updated AVFormatContext.metadata and wishes the muxer to
 *   write it into the file
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_EVENT_FLAG_METADATA_UPDATED</span> <span class="token expression"><span class="token number">0x0001</span></span></span>

    <span class="token comment">/**
     * Maximum number of packets to read while waiting for the first timestamp.
     * Decoding only.
     */</span>
    <span class="token keyword">int</span> max_ts_probe<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Avoid negative timestamps during muxing.
     * Any value of the AVFMT_AVOID_NEG_TS_* constants.
     * Note, this works better when using av_interleaved_write_frame().
     * - muxing: Set by user
     * - demuxing: unused
     */</span>
    <span class="token keyword">int</span> avoid_negative_ts<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_AUTO</span>             <span class="token expression"><span class="token operator">-</span><span class="token number">1</span> </span><span class="token comment">///&lt; Enabled when required by target format</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_DISABLED</span>          <span class="token expression"><span class="token number">0</span> </span><span class="token comment">///&lt; Do not shift timestamps even when they are negative.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_NON_NEGATIVE</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">///&lt; Shift timestamps so they are non negative</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVFMT_AVOID_NEG_TS_MAKE_ZERO</span>         <span class="token expression"><span class="token number">2</span> </span><span class="token comment">///&lt; Shift timestamps so that they start at 0</span></span>

    <span class="token comment">/**
     * Transport stream id.
     * This will be moved into demuxer private options. Thus no API/ABI compatibility
     */</span>
    <span class="token keyword">int</span> ts_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Audio preload in microseconds.
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> audio_preload<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Max chunk time in microseconds.
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> max_chunk_duration<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Max chunk size in bytes
     * Note, not all formats support this and unpredictable things may happen if it is used when not supported.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> max_chunk_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * forces the use of wallclock timestamps as pts/dts of packets
     * This has undefined results in the presence of B frames.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> use_wallclock_as_timestamps<span class="token punctuation">;</span>

    <span class="token comment">/**
     * avio flags, used to force AVIO_FLAG_DIRECT.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> avio_flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The duration field can be estimated through various ways, and this field can be used
     * to know how the duration was estimated.
     * - encoding: unused
     * - decoding: Read by user
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVDurationEstimationMethod</span> duration_estimation_method<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Skip initial bytes when opening stream
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int64_t</span> skip_initial_bytes<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Correct single timestamp overflows
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> correct_ts_overflow<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Force seeking to any (also non key) frames.
     * - encoding: unused
     * - decoding: Set by user
     */</span>
    <span class="token keyword">int</span> seek2any<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Flush the I/O context after each packet.
     * - encoding: Set by user
     * - decoding: unused
     */</span>
    <span class="token keyword">int</span> flush_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * format probing score.
     * The maximal score is AVPROBE_SCORE_MAX, its set when the demuxer probes
     * the format.
     * - encoding: unused
     * - decoding: set by avformat, read by user
     */</span>
    <span class="token keyword">int</span> probe_score<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum number of bytes read from input in order to identify the
     * \ref AVInputFormat "input format". Only used when the format is not set
     * explicitly by the caller.
     *
     * Demuxing only, set by the caller before avformat_open_input().
     *
     * @sa probesize
     */</span>
    <span class="token keyword">int</span> format_probesize<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed decoders.
     * If NULL then all are allowed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>codec_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed demuxers.
     * If NULL then all are allowed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>format_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * IO repositioned flag.
     * This is set by avformat when the underlaying IO context read pointer
     * is repositioned, for example when doing byte based seeking.
     * Demuxers can use the flag to detect such changes.
     */</span>
    <span class="token keyword">int</span> io_repositioned<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced video codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>video_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced audio codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>audio_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced subtitle codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>subtitle_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced data codec.
     * This allows forcing a specific decoder, even when there are multiple with
     * the same codec_id.
     * Demuxing: Set by user
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodec</span> <span class="token operator">*</span>data_codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of bytes to be written as padding in a metadata header.
     * Demuxing: Unused.
     * Muxing: Set by user via av_format_set_metadata_header_padding.
     */</span>
    <span class="token keyword">int</span> metadata_header_padding<span class="token punctuation">;</span>

    <span class="token comment">/**
     * User data.
     * This is a place for some private data of the user.
     */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Callback used by devices to communicate with application.
     */</span>
    av_format_control_message control_message_cb<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Output timestamp offset, in microseconds.
     * Muxing: set by user
     */</span>
    <span class="token keyword">int64_t</span> output_ts_offset<span class="token punctuation">;</span>

    <span class="token comment">/**
     * dump format separator.
     * can be ", " or "\n      " or anything else
     * - muxing: Set by user.
     * - demuxing: Set by user.
     */</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>dump_separator<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Forced Data codec_id.
     * Demuxing: Set by user.
     */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> data_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ',' separated list of allowed protocols.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>protocol_whitelist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A callback for opening new IO streams.
     *
     * Whenever a muxer or a demuxer needs to open an IO stream (typically from
     * avformat_open_input() for demuxers, but for certain formats can happen at
     * other times as well), it will call this callback to obtain an IO context.
     *
     * @param s the format context
     * @param pb on success, the newly opened IO context should be returned here
     * @param url the url to open
     * @param flags a combination of AVIO_FLAG_*
     * @param options a dictionary of additional options, with the same
     *                semantics as in avio_open2()
     * @return 0 on success, a negative AVERROR code on failure
     *
     * @note Certain muxers and demuxers do nesting, i.e. they open one or more
     * additional internal format contexts. Thus the AVFormatContext pointer
     * passed to this callback may be different from the one facing the caller.
     * It will, however, have the same 'opaque' field.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span><span class="token operator">*</span>pb<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> flags<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVFORMAT_IO_CLOSE</span></span>
    <span class="token comment">/**
     * A callback for closing the streams opened with AVFormatContext.io_open().
     *
     * @deprecated use io_close2
     */</span>
    attribute_deprecated
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/**
     * ',' separated list of disallowed protocols.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>protocol_blacklist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The maximum number of streams.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> max_streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Skip duration calcuation in estimate_timings_from_pts.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> skip_estimate_duration_from_pts<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum number of packets that can be probed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> max_probe_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A callback for closing the streams opened with AVFormatContext.io_open().
     *
     * Using this is preferred over io_close, because this can return an error.
     * Therefore this callback is used instead of io_close by the generic
     * libavformat code if io_close is NULL or the default.
     *
     * @param s the format context
     * @param pb IO context to be closed and freed
     * @return 0 on success, a negative AVERROR code on failure
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> AVFormatContext<span class="token punctuation">;</span>ol_blacklist<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The maximum number of streams.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> max_streams<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Skip duration calcuation in estimate_timings_from_pts.
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> skip_estimate_duration_from_pts<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Maximum number of packets that can be probed
     * - encoding: unused
     * - decoding: set by user
     */</span>
    <span class="token keyword">int</span> max_probe_packets<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A callback for closing the streams opened with AVFormatContext.io_open().
     *
     * Using this is preferred over io_close, because this can return an error.
     * Therefore this callback is used instead of io_close by the generic
     * libavformat code if io_close is NULL or the default.
     *
     * @param s the format context
     * @param pb IO context to be closed and freed
     * @return 0 on success, a negative AVERROR code on failure
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>io_close2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> AVFormatContext<span class="token punctuation">;</span>
</code></pre> 
<p>  1. <strong>nb_streams</strong>：表示容器中流的数量。<br>   2. <strong>streams</strong>：AVStream类型指针数组，每个元素代表一个流。每个AVStream结构体包含有该流的相信信息。<br>   3. <strong>duration</strong>：表示该容器的总时长，单位为微妙（可用的话）。<br>   4. <strong>iformat/oformat</strong>：分别表示输入格式和输出格式的AVInputFormat/AVOutFormat结构体指针。<br>   5. <strong>flags</strong>：包含有关容器选项的标志。常用标志包括AVFMT_NOFILE（不需要打开文件），AVFMT_FLOBALHEADER（向输出流写入全局标题），AVFMT——NOBINEARCH（禁用二进制搜索等）。<br>   6. <strong>pb</strong>：AVIOContest结构体类型，代表文件输入/输出流。它与AVFormatContext跟踪同一个文件，并提供对该文件的读写操作。pb由avion_open2()打开。<br>   7. <strong>metadata</strong>：包含元数据信息的AVDictionary类型指针，其中包含有关容器的任何其他信息，例如标题、作家、发行商等。<br>   8. <strong>filename</strong>：表示输入/输出文件名的字符串、通常只给调试和打印统计信息使用。</p> 
<h3><a id="32AVInputFormat_2487"></a>3.2、AVInputFormat</h3> 
<p>  AVInputFormat 是类似COM 接口的数据结构，表示输入文件容器格式，是解复用器（解封装）作用时读取媒体文件并将其拆分为数据块（数据包）。每个数据包，包含一个或者多个编码帧。着重于功能函数，一种文件容器格式对应一个AVInputFormat 结构，在程序运行时有多个实例，位于avoformat.h文件中。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVInputFormat</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * A comma separated list of short names for the format. New names
     * may be appended with a minor bump.
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Descriptive name for the format, meant to be more human-readable
     * than name. You should use the NULL_IF_CONFIG_SMALL() macro
     * to define it.
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>long_name<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Can use flags: AVFMT_NOFILE, AVFMT_NEEDNUMBER, AVFMT_SHOW_IDS,
     * AVFMT_NOTIMESTAMPS, AVFMT_GENERIC_INDEX, AVFMT_TS_DISCONT, AVFMT_NOBINSEARCH,
     * AVFMT_NOGENSEARCH, AVFMT_NO_BYTE_SEEK, AVFMT_SEEK_TO_PTS.
     */</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * If extensions are defined, then no probe is done. You should
     * usually not use extension format guessing because it is not
     * reliable enough
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>extensions<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodecTag</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span>codec_tag<span class="token punctuation">;</span>

    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>priv_class<span class="token punctuation">;</span> <span class="token comment">///&lt; AVClass for the private context</span>

    <span class="token comment">/**
     * Comma-separated list of mime types.
     * It is used check for matching mime types while probing.
     * @see av_probe_input_format2
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mime_type<span class="token punctuation">;</span>

    <span class="token comment">/*****************************************************************
     * No fields below this line are part of the public API. They
     * may not be used outside of libavformat and can be changed and
     * removed at will.
     * New public fields should be added right above.
     *****************************************************************
     */</span>
    <span class="token comment">/**
     * Raw demuxers store their codec ID here.
     */</span>
    <span class="token keyword">int</span> raw_codec_id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Size of private data so that it can be allocated in the wrapper.
     */</span>
    <span class="token keyword">int</span> priv_data_size<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Internal flags. See FF_FMT_FLAG_* in internal.h.
     */</span>
    <span class="token keyword">int</span> flags_internal<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Tell if a given file has a chance of being parsed as this format.
     * The buffer provided is guaranteed to be AVPROBE_PADDING_SIZE bytes
     * big so you do not have to check for that unless you need more.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> AVProbeData <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Read the format header and initialize the AVFormatContext
     * structure. Return 0 if OK. 'avformat_new_stream' should be
     * called to create new streams.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_header<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Read one packet and put it in 'pkt'. pts and flags are also
     * set. 'avformat_new_stream' can be called only if the flag
     * AVFMTCTX_NOHEADER is used and only in the calling thread (not in a
     * background thread).
     * @return 0 on success, &lt; 0 on error.
     *         Upon returning an error, pkt must be unreferenced by the caller.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_packet<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span><span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Close the stream. The AVFormatContext and AVStreams are not
     * freed by this function
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Seek to a given timestamp relative to the frames in
     * stream component stream_index.
     * @param stream_index Must not be -1.
     * @param flags Selects which direction should be preferred if no exact
     *              match is available.
     * @return &gt;= 0 on success (but not necessarily the new offset)
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_seek<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span><span class="token punctuation">,</span>
                     <span class="token keyword">int</span> stream_index<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Get the next timestamp in stream[stream_index].time_base units.
     * @return the timestamp or AV_NOPTS_VALUE if an error occurred
     */</span>
    <span class="token keyword">int64_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_timestamp<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> stream_index<span class="token punctuation">,</span>
                              <span class="token keyword">int64_t</span> <span class="token operator">*</span>pos<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> pos_limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Start/resume playing - only meaningful if using a network-based format
     * (RTSP).
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_play<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Pause playing - only meaningful if using a network-based format
     * (RTSP).
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_pause<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Seek to timestamp ts.
     * Seeking will be done so that the point from which all active streams
     * can be presented successfully will be closest to ts and within min/max_ts.
     * Active streams are all streams that have AVStream.discard &lt; AVDISCARD_ALL.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_seek2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> stream_index<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> min_ts<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> ts<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> max_ts<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Returns device list with it properties.
     * @see avdevice_list_devices() for more details.
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_device_list<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">AVFormatContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">AVDeviceInfoList</span> <span class="token operator">*</span>device_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> AVInputFormat<span class="token punctuation">;</span>
</code></pre> 
<p>  1. <strong>const char *name</strong>：格式名列表.也可以分配一个新名字。<br>   2. <strong>const char *long_name</strong>：格式的描述性名称，意味着比名称更易于阅读。<br>   3. <strong>int flags</strong>：可用的flag有: AVFMT_NOFILE, AVFMT_NEEDNUMBER, AVFMT_SHOW_IDS,AVFMT_GENERIC_INDEX, AVFMT_TS_DISCONT, AVFMT_NOBINSEARCH,AVFMT_NOGENSEARCH, AVFMT_NO_BYTE_SEEK, AVFMT_SEEK_TO_PTS。<br>   4. <strong>const char *extensions</strong>：文件扩展名。<br>   5. <strong>const AVClass *priv_class</strong>：一个模拟类型列表.用来在probe的时候check匹配的类型。<br>   6. <strong>struct AVInputFormat *next</strong>：用于把所有支持的输入文件容器格式连接成链表，便于遍历查找。<br>   7. <strong>int priv_data_size</strong>：标示具体的文件容器格式对应的Context 的大小。<br>   8. <strong>int (*read_probe)(AVProbeData *)</strong>：判断一个给定的文件是否有可能被解析为这种格式。 给定的buf足够大，所以你没有必要去检查它，除非你需要更多 。<br>   9. <strong>int (*read_header)(struct AVFormatContext *)</strong>：读取format头并初始化AVFormatContext结构体，如果成功，返回0。创建新的流需要调用avformat_new_stream。<br>   10. <strong>int (*read_header2)(struct AVFormatContext *, AVDictionary **options)</strong>：新加的函数指针，用于打开进一步嵌套输入的格式。<br>   11. <strong>int (*read_packet)(struct AVFormatContext *, AVPacket *pkt)</strong>：读取一个数据包并将其放在“pkt”中。 pts和flag也被设置。<br>   12. <strong>int (*read_close)(struct AVFormatContext *)</strong>：关闭流。AVFormatContext和Streams不会被此函数释放。<br>   13. <strong>int (*read_seek)(struct AVFormatContext *, int stream_index, int64_t timestamp, int flags)</strong><br>   14. <strong>int64_t (*read_timestamp)(struct AVFormatContext *s, int stream_index, int64_t *pos, int64_t pos_limit)</strong>：获取stream [stream_index] .time_base单位中的下一个时间戳。<br>   15. <strong>int (*read_play)(struct AVFormatContext *)</strong>：开始/继续播放 - 仅当使用基于网络的（RTSP）格式时才有意义。<br>   16. <strong>int (*read_pause)(struct AVFormatContext *)</strong>：暂停播放 - 仅当使用基于网络的（RTSP）格式时才有意义。<br>   17. <strong>int (*read_seek2)(struct AVFormatContext *s, int stream_index, int64_t min_ts, int64_t ts, int64_t max_ts, int flags)</strong>：寻求时间戳ts。<br>   18. <strong>int (*get_device_list)(struct AVFormatContext *s, struct AVDeviceInfoList *device_list)</strong>：返回设备列表及其属性。<br>   19. <strong>int (*create_device_capabilities)(struct AVFormatContext *s, struct AVDeviceCapabilitiesQuery *caps)</strong>：初始化设备能力子模块。<br>   20. <strong>int (*free_device_capabilities)(struct AVFormatContext *s, struct AVDeviceCapabilitiesQuery *caps)</strong>：释放设备能力子模块</p> 
<h3><a id="33AVOutputFormat_2648"></a>3.3、AVOutputFormat</h3> 
<p>  AVOutpufFormat与AVInputFormat类似，是类似COM 接口的数据结构，表示输出文件容器格式，着重于功能函数，位于Avoformat.h文件中。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVOutputFormat</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Descriptive name for the format, meant to be more human-readable
     * than name. You should use the NULL_IF_CONFIG_SMALL() macro
     * to define it.
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>long_name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mime_type<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>extensions<span class="token punctuation">;</span> <span class="token comment">/**&lt; comma-separated filename extensions */</span>
    <span class="token comment">/* output support */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> audio_codec<span class="token punctuation">;</span>    <span class="token comment">/**&lt; default audio codec */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> video_codec<span class="token punctuation">;</span>    <span class="token comment">/**&lt; default video codec */</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> subtitle_codec<span class="token punctuation">;</span> <span class="token comment">/**&lt; default subtitle codec */</span>
    <span class="token comment">/**
     * can use flags: AVFMT_NOFILE, AVFMT_NEEDNUMBER,
     * AVFMT_GLOBALHEADER, AVFMT_NOTIMESTAMPS, AVFMT_VARIABLE_FPS,
     * AVFMT_NODIMENSIONS, AVFMT_NOSTREAMS,
     * AVFMT_TS_NONSTRICT, AVFMT_TS_NEGATIVE
     */</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

    <span class="token comment">/**
     * List of supported codec_id-codec_tag pairs, ordered by "better
     * choice first". The arrays are all terminated by AV_CODEC_ID_NONE.
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">AVCodecTag</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span>codec_tag<span class="token punctuation">;</span>

    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>priv_class<span class="token punctuation">;</span> <span class="token comment">///&lt; AVClass for the private context</span>
<span class="token punctuation">}</span> AVOutputFormat<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="34AVStream_2683"></a>3.4、AVStream</h3> 
<p>  AVStream是存储每一个视频/音频流信息的结构体。本文分析一下该结构体里重要变量的含义和作用。该结构体位于avformat.h中，首先看一下结构体的定义：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AVStream</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * A class for @ref avoptions. Set on stream creation.
     */</span>
    <span class="token keyword">const</span> AVClass <span class="token operator">*</span>av_class<span class="token punctuation">;</span>

    <span class="token keyword">int</span> index<span class="token punctuation">;</span>    <span class="token comment">/**&lt; stream index in AVFormatContext */</span>
    <span class="token comment">/**
     * Format-specific stream ID.
     * decoding: set by libavformat
     * encoding: set by the user, replaced by libavformat if left unset
     */</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Codec parameters associated with this stream. Allocated and freed by
     * libavformat in avformat_new_stream() and avformat_free_context()
     * respectively.
     *
     * - demuxing: filled by libavformat on stream creation or in
     *             avformat_find_stream_info()
     * - muxing: filled by the caller before avformat_write_header()
     */</span>
    AVCodecParameters <span class="token operator">*</span>codecpar<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token operator">*</span>priv_data<span class="token punctuation">;</span>

    <span class="token comment">/**
     * This is the fundamental unit of time (in seconds) in terms
     * of which frame timestamps are represented.
     *
     * decoding: set by libavformat
     * encoding: May be set by the caller before avformat_write_header() to
     *           provide a hint to the muxer about the desired timebase. In
     *           avformat_write_header(), the muxer will overwrite this field
     *           with the timebase that will actually be used for the timestamps
     *           written into the file (which may or may not be related to the
     *           user-provided one, depending on the format).
     */</span>
    AVRational time_base<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Decoding: pts of the first frame of the stream in presentation order, in stream time base.
     * Only set this if you are absolutely 100% sure that the value you set
     * it to really is the pts of the first frame.
     * This may be undefined (AV_NOPTS_VALUE).
     * @note The ASF header does NOT contain a correct start_time the ASF
     * demuxer must NOT set this.
     */</span>
    <span class="token keyword">int64_t</span> start_time<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Decoding: duration of the stream, in stream time base.
     * If a source file does not specify a duration, but does specify
     * a bitrate, this value will be estimated from bitrate and file size.
     *
     * Encoding: May be set by the caller before avformat_write_header() to
     * provide a hint to the muxer about the estimated duration.
     */</span>
    <span class="token keyword">int64_t</span> duration<span class="token punctuation">;</span>

    <span class="token keyword">int64_t</span> nb_frames<span class="token punctuation">;</span>                 <span class="token comment">///&lt; number of frames in this stream if known or 0</span>

    <span class="token comment">/**
     * Stream disposition - a combination of AV_DISPOSITION_* flags.
     * - demuxing: set by libavformat when creating the stream or in
     *             avformat_find_stream_info().
     * - muxing: may be set by the caller before avformat_write_header().
     */</span>
    <span class="token keyword">int</span> disposition<span class="token punctuation">;</span>

    <span class="token keyword">enum</span> <span class="token class-name">AVDiscard</span> discard<span class="token punctuation">;</span> <span class="token comment">///&lt; Selects which packets can be discarded at will and do not need to be demuxed.</span>

    <span class="token comment">/**
     * sample aspect ratio (0 if unknown)
     * - encoding: Set by user.
     * - decoding: Set by libavformat.
     */</span>
    AVRational sample_aspect_ratio<span class="token punctuation">;</span>

    AVDictionary <span class="token operator">*</span>metadata<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Average framerate
     *
     * - demuxing: May be set by libavformat when creating the stream or in
     *             avformat_find_stream_info().
     * - muxing: May be set by the caller before avformat_write_header().
     */</span>
    AVRational avg_frame_rate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * For streams with AV_DISPOSITION_ATTACHED_PIC disposition, this packet
     * will contain the attached picture.
     *
     * decoding: set by libavformat, must not be modified by the caller.
     * encoding: unused
     */</span>
    AVPacket attached_pic<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVSTREAM_SIDE_DATA</span></span>
    <span class="token comment">/**
     * An array of side data that applies to the whole stream (i.e. the
     * container does not allow it to change between packets).
     *
     * There may be no overlap between the side data in this array and side data
     * in the packets. I.e. a given side data is either exported by the muxer
     * (demuxing) / set by the caller (muxing) in this array, then it never
     * appears in the packets, or the side data is exported / sent through
     * the packets (always in the first packet where the value becomes known or
     * changes), then it does not appear in this array.
     *
     * - demuxing: Set by libavformat when the stream is created.
     * - muxing: May be set by the caller before avformat_write_header().
     *
     * Freed by libavformat in avformat_free_context().
     *
     * @deprecated use AVStream's @ref AVCodecParameters.coded_side_data
     *             "codecpar side data".
     */</span>
    attribute_deprecated
    AVPacketSideData <span class="token operator">*</span>side_data<span class="token punctuation">;</span>
    <span class="token comment">/**
     * The number of elements in the AVStream.side_data array.
     *
     * @deprecated use AVStream's @ref AVCodecParameters.nb_coded_side_data
     *             "codecpar side data".
     */</span>
    attribute_deprecated
    <span class="token keyword">int</span>            nb_side_data<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/**
     * Flags indicating events happening on the stream, a combination of
     * AVSTREAM_EVENT_FLAG_*.
     *
     * - demuxing: may be set by the demuxer in avformat_open_input(),
     *   avformat_find_stream_info() and av_read_frame(). Flags must be cleared
     *   by the user once the event has been handled.
     * - muxing: may be set by the user after avformat_write_header(). to
     *   indicate a user-triggered event.  The muxer will clear the flags for
     *   events it has handled in av_[interleaved]_write_frame().
     */</span>
    <span class="token keyword">int</span> event_flags<span class="token punctuation">;</span>
<span class="token comment">/**
 * - demuxing: the demuxer read new metadata from the file and updated
 *     AVStream.metadata accordingly
 * - muxing: the user updated AVStream.metadata and wishes the muxer to write
 *     it into the file
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVSTREAM_EVENT_FLAG_METADATA_UPDATED</span> <span class="token expression"><span class="token number">0x0001</span></span></span>
<span class="token comment">/**
 * - demuxing: new packets for this stream were read from the file. This
 *   event is informational only and does not guarantee that new packets
 *   for this stream will necessarily be returned from av_read_frame().
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVSTREAM_EVENT_FLAG_NEW_PACKETS</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>

    <span class="token comment">/**
     * Real base framerate of the stream.
     * This is the lowest framerate with which all timestamps can be
     * represented accurately (it is the least common multiple of all
     * framerates in the stream). Note, this value is just a guess!
     * For example, if the time base is 1/90000 and all frames have either
     * approximately 3600 or 1800 timer ticks, then r_frame_rate will be 50/1.
     */</span>
    AVRational r_frame_rate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Number of bits in timestamps. Used for wrapping control.
     *
     * - demuxing: set by libavformat
     * - muxing: set by libavformat
     *
     */</span>
    <span class="token keyword">int</span> pts_wrap_bits<span class="token punctuation">;</span>
<span class="token punctuation">}</span> AVStream<span class="token punctuation">;</span>
</code></pre> 
<p>  <strong>分析：</strong><br> <img src="https://images2.imgbox.com/25/c7/mNrTeuMH_o.png" alt="在这里插入图片描述">   1. <strong>int index</strong>：在AVFormatContext中的流索引。<br>   2. <strong>int id</strong>：流id，例如音频流id 视频流id等，解封装的时候，由libavformat模块来赋值；加封装的时候，由用户设置，如果未设置，则用libavformat替换。、<br>   3. <strong>AVRational time_base</strong>：这是表示帧时间戳的基本时间单位(以秒为单位) 。<br>   4. <strong>int64_t duration</strong>：解码时:流的持续时间，以流的时间为基数。如果源文件没有指定持续时间，但指定了比特率，则该值将根据比特率和文件大小进行估计。使用该数值得出视频流的持续时间，计算方式 duration *(time_base.num/time_base.den) 秒。duration的数值有可能为空，所以一般情况下使用AVFormatContext的duration来计算时长。<br>   5. <strong>int64_t nb_frames</strong>：帧数。<br>   6. <strong>AVRational sample_aspect_ratio</strong>：样本比特率。<br>   7. <strong>AVRational avg_frame_rate</strong>：平均帧速率。<br>   8. <strong>AVCodecParameters *codecpar</strong>：与此流相关的编解码器参数。分别在avformat_new_stream()和avformat_free_context()中由libavformat分配和释放。</p> 
<h2><a id="_2874"></a>四、重要函数分析</h2> 
<h3><a id="41avformat_alloc_context_2875"></a>4.1、avformat_alloc_context</h3> 
<p>  源码位于：libavformat/options.c<br>   函数用来申请AVFormatContext类型变量并初始化默认参数。<br>   该函数用于分配空间创建一个AVFormatContext对象，并且强调使用  avformat_free_context方法来清理并释放该对象的空间。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> AVClass av_format_context_class <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 类的名字，通常它与 AVClass 关联的上下文结构体类型的名字相同。
     * 这里类名为"AVFormatContext"，说明该 AVClass 关联的上下文结构体为
     * AVFormatContext.
     */</span>
    <span class="token punctuation">.</span>class_name     <span class="token operator">=</span> <span class="token string">"AVFormatContext"</span><span class="token punctuation">,</span>
    <span class="token comment">/** 
     * 这里这个函数返回的是 AVFormatContext 中 iformat-&gt;name 
     * 或者 oformat-&gt;name 字符串.
     */</span>
    <span class="token punctuation">.</span>item_name      <span class="token operator">=</span> format_to_name<span class="token punctuation">,</span>
    <span class="token comment">/**
     * avformat_options 是一个 AVOption 结构体类的数组，
     * 该数组中的元素为 AVFormatContext 中的一个个字段，
     * 以后可以通过 av_opt_* 系列函数对 AVFormatContext
     * 中的字段进行操作。
     */</span>
    <span class="token punctuation">.</span>option         <span class="token operator">=</span> avformat_options<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>version        <span class="token operator">=</span> LIBAVUTIL_VERSION_INT<span class="token punctuation">,</span>
    <span class="token comment">/**
     * 返回下一个启用 AVOption 的子项
     */</span>
    <span class="token punctuation">.</span>child_next     <span class="token operator">=</span> format_child_next<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>child_class_iterate <span class="token operator">=</span> format_child_class_iterate<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>category       <span class="token operator">=</span> AV_CLASS_CATEGORY_MUXER<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_category   <span class="token operator">=</span> get_category<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">io_open_default</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span><span class="token operator">*</span>pb<span class="token punctuation">,</span>
                           <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> loglevel<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>url<span class="token punctuation">)</span> <span class="token operator">||</span>
        s<span class="token operator">-&gt;</span>iformat <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"image2"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        s<span class="token operator">-&gt;</span>oformat <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"image2"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        loglevel <span class="token operator">=</span> AV_LOG_DEBUG<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        loglevel <span class="token operator">=</span> AV_LOG_INFO<span class="token punctuation">;</span>

    <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> loglevel<span class="token punctuation">,</span> <span class="token string">"Opening \'%s\' for %s\n"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> flags <span class="token operator">&amp;</span> AVIO_FLAG_WRITE <span class="token operator">?</span> <span class="token string">"writing"</span> <span class="token operator">:</span> <span class="token string">"reading"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">ffio_open_whitelist</span><span class="token punctuation">(</span>pb<span class="token punctuation">,</span> url<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>interrupt_callback<span class="token punctuation">,</span> options<span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>protocol_whitelist<span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>protocol_blacklist<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVFORMAT_IO_CLOSE</span></span>
<span class="token keyword">void</span> <span class="token function">ff_format_io_close_default</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">avio_close</span><span class="token punctuation">(</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">io_close2_default</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">avio_close</span><span class="token punctuation">(</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

AVFormatContext <span class="token operator">*</span><span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FFFormatContext <span class="token operator">*</span><span class="token keyword">const</span> si <span class="token operator">=</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//使用av_malloc分配空间，分配空间的作用是存储数据</span>
    AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">;</span>    <span class="token comment">//创建一个AVFormatContext对象为s</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">//判断si是否为NILL，为空返回NULL</span>

    s <span class="token operator">=</span> <span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>pub<span class="token punctuation">;</span>
    s<span class="token operator">-&gt;</span>av_class <span class="token operator">=</span> <span class="token operator">&amp;</span>av_format_context_class<span class="token punctuation">;</span>
    s<span class="token operator">-&gt;</span>io_open  <span class="token operator">=</span> io_open_default<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVFORMAT_IO_CLOSE</span></span>
FF_DISABLE_DEPRECATION_WARNINGS
    s<span class="token operator">-&gt;</span>io_close <span class="token operator">=</span> ff_format_io_close_default<span class="token punctuation">;</span>
FF_ENABLE_DEPRECATION_WARNINGS
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    s<span class="token operator">-&gt;</span>io_close2<span class="token operator">=</span> io_close2_default<span class="token punctuation">;</span>

    <span class="token function">av_opt_set_defaults</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    si<span class="token operator">-&gt;</span>pkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    si<span class="token operator">-&gt;</span>parse_pkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-&gt;</span>pkt <span class="token operator">||</span> <span class="token operator">!</span>si<span class="token operator">-&gt;</span>parse_pkt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_SHORTEST</span></span>
    <span class="token comment">/* shortest_end:
     * 最短的流结束的时间戳 */</span>
    si<span class="token operator">-&gt;</span>shortest_end <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  1. 创建AVFormatContext，他可用于由框架分配的在上下文和所有内容 ，即分配解复用器上下文。<br>   2. 初始化io_open等函数指针，为init_input做准备。<br>   3. 并初始化option相关参数给s。</p> 
<h3><a id="42avformat_open_input_2979"></a>4.2、avformat_open_input</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span><span class="token operator">*</span>ps<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> AVInputFormat <span class="token operator">*</span>fmt<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFormatContext <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token operator">*</span>ps<span class="token punctuation">;</span>
    FFFormatContext <span class="token operator">*</span>si<span class="token punctuation">;</span>
    AVDictionary <span class="token operator">*</span>tmp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    ID3v2ExtraMeta <span class="token operator">*</span>id3v2_extra_meta <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    si <span class="token operator">=</span> <span class="token function">ffformatcontext</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>av_class<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Input context has not been properly allocated by avformat_alloc_context() and is not NULL either\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>
        s<span class="token operator">-&gt;</span>iformat <span class="token operator">=</span> fmt<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token function">av_dict_copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span> <span class="token operator">*</span>options<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span> <span class="token comment">// must be before any goto fail</span>
        s<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> AVFMT_FLAG_CUSTOM_IO<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">av_opt_set_dict</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>url <span class="token operator">=</span> <span class="token function">av_strdup</span><span class="token punctuation">(</span>filename <span class="token operator">?</span> filename <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">init_input</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
    s<span class="token operator">-&gt;</span>probe_score <span class="token operator">=</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>protocol_whitelist <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>pb <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>protocol_whitelist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s<span class="token operator">-&gt;</span>protocol_whitelist <span class="token operator">=</span> <span class="token function">av_strdup</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>protocol_whitelist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>protocol_whitelist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>protocol_blacklist <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>pb <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>protocol_blacklist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s<span class="token operator">-&gt;</span>protocol_blacklist <span class="token operator">=</span> <span class="token function">av_strdup</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>protocol_blacklist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>protocol_blacklist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>format_whitelist <span class="token operator">&amp;&amp;</span> <span class="token function">av_match_list</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>format_whitelist<span class="token punctuation">,</span> <span class="token char">','</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Format not on whitelist \'%s\'\n"</span><span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>format_whitelist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">avio_skip</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>skip_initial_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Check filename in case an image number is expected. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NEEDNUMBER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">av_filename_number_test</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    s<span class="token operator">-&gt;</span>duration <span class="token operator">=</span> s<span class="token operator">-&gt;</span>start_time <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>

    <span class="token comment">/* Allocate private data. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>priv_data_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>priv_data <span class="token operator">=</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>priv_data_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>priv_class<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> AVClass <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> s<span class="token operator">-&gt;</span>priv_data <span class="token operator">=</span> s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>priv_class<span class="token punctuation">;</span>
            <span class="token function">av_opt_set_defaults</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">av_opt_set_dict</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* e.g. AVFMT_NOFILE formats will not have an AVIOContext */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span>
        <span class="token function">ff_id3v2_read_dict</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>id3v2_meta<span class="token punctuation">,</span> ID3v2_DEFAULT_MAGIC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>id3v2_extra_meta<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_header<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span><span class="token function">read_header</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags_internal <span class="token operator">&amp;</span> FF_FMT_INIT_CLEANUP<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> close<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>metadata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s<span class="token operator">-&gt;</span>metadata    <span class="token operator">=</span> si<span class="token operator">-&gt;</span>id3v2_meta<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>id3v2_meta <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>id3v2_meta<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span> <span class="token string">"Discarding ID3 tags because more suitable tags were found.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>id3v2_meta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>id3v2_extra_meta<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"mp3"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"aac"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"tta"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"wav"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">ff_id3v2_parse_apic</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> id3v2_extra_meta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> close<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">ff_id3v2_parse_chapters</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> id3v2_extra_meta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> close<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">ff_id3v2_parse_priv</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> id3v2_extra_meta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> close<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"demuxer does not support additional id3 data, skipping\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ff_id3v2_free_extra_meta</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id3v2_extra_meta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">avformat_queue_attached_pictures</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> close<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>si<span class="token operator">-&gt;</span>data_offset<span class="token punctuation">)</span>
        si<span class="token operator">-&gt;</span>data_offset <span class="token operator">=</span> <span class="token function">avio_tell</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    si<span class="token operator">-&gt;</span>raw_packet_buffer_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">update_stream_avctx</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_dict_free</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>options <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>ps <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

close<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_close<span class="token punctuation">)</span>
        s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span><span class="token function">read_close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
fail<span class="token operator">:</span>
    <span class="token function">ff_id3v2_free_extra_meta</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id3v2_extra_meta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_CUSTOM_IO<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">avio_closep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>ps <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <strong>函数的形参：</strong><br>     <strong>ps</strong>：函数调用成功之后处理过的AVFormatContext结构体。<br>     <strong>file</strong>：打开的视音频流的URL。<br>     <strong>fmt</strong>：强制指定AVFormatContext中AVInputFormat的。这个参数一般情况下可以设置为NULL，这样FFmpeg可以自动检测AVInputFormat。<br>     <strong>options</strong>：附加的一些选项，一般情况下可以设置为NULL。<br>   在该函数中，FFMPEG完成了：<br>     1. 输入输出结构体AVIOContext的初始化；<br>     2. 输入数据的协议（例如RTMP，或者file）的识别（通过一套评分机制）：<br>       1. 判断文件名的后缀。<br>       2. 读取文件头的数据进行比对。<br>     3. 使用获得最高分的文件协议对应的URLProtocol，通过函数指针的方式，与FFMPEG连接（非专业用词）。<br>     4. 剩下的就是调用该URLProtocol的函数进行open,read等操作了 没看到相关的代码。<br> <img src="https://images2.imgbox.com/95/d3/UXrx7gfH_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="421init_input_3143"></a>4.2.1、init_input</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">init_input</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span>
                      AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    AVProbeData pd <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> filename<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> score <span class="token operator">=</span> AVPROBE_SCORE_RETRY<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> AVFMT_FLAG_CUSTOM_IO<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>iformat<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">av_probe_input_buffer2</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>iformat<span class="token punctuation">,</span> filename<span class="token punctuation">,</span>
                                          s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>format_probesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOFILE<span class="token punctuation">)</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span> <span class="token string">"Custom AVIOContext makes no sense and "</span>
                                      <span class="token string">"will be ignored with AVFMT_NOFILE format.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOFILE<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>iformat <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat <span class="token operator">=</span> <span class="token function">av_probe_input_format2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> score<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span><span class="token function">io_open</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> AVIO_FLAG_READ <span class="token operator">|</span> s<span class="token operator">-&gt;</span>avio_flags<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">av_probe_input_buffer2</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>iformat<span class="token punctuation">,</span> filename<span class="token punctuation">,</span>
                                  s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>format_probesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  这个函数在短短的几行代码中包含了好几个return，因此逻辑还是有点复杂的，我们可以梳理一下：在函数的开头的score变量是一个判决AVInputFormat的分数的门限值，如果最后得到的AVInputFormat的分数低于该门限值，就认为没有找到合适的AVInputFormat。<br>   FFmpeg内部判断封装格式的原理实际上是对每种AVInputFormat给出一个分数，满分是100分，越有可能正确的AVInputFormat给出的分数就越高。最后选择分数最高的AVInputFormat作为推测结果。<br>   score的值是一个宏定义AVPROBE_SCORE_RETRY，我们可以看一下它的定义：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVPROBE_SCORE_RETRY</span> <span class="token expression"><span class="token punctuation">(</span>AVPROBE_SCORE_MAX<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>  </span></span>
</code></pre> 
<p>  其中AVPROBE_SCORE_MAX是score的最大值，取值是100：</p> 
<pre><code class="prism language-cpp"> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AVPROBE_SCORE_MAX</span>       <span class="token expression"><span class="token number">100</span> </span><span class="token comment">///&lt; maximum score  </span></span>
</code></pre> 
<p>  由此我们可以得出score取值是25，即如果推测后得到的最佳AVInputFormat的分值低于25，就认为没有找到合适的AVInputFormat。<br>   整个函数的逻辑大体如下：<br>     1. 当使用了自定义的AVIOContext的时候（AVFormatContext中的AVIOContext不为空，即s-&gt;pb!=NULL），如果指定了AVInputFormat就直接返回，如果没有指定就调用av_probe_input_buffer2()推测AVInputFormat。这一情况出现的不算很多，但是当我们从内存中读取数据的时候（需要初始化自定义的AVIOContext），就会执行这一步骤。<br>     2. 在更一般的情况下，如果已经指定了AVInputFormat，就直接返回；如果没有指定AVInputFormat，就调用av_probe_input_format(NULL,…)根据文件路径判断文件格式。这里特意把av_probe_input_format()的第1个参数写成“NULL”，是为了强调这个时候实际上并没有给函数提供输入数据，此时仅仅通过文件路径推测AVInputFormat。<br>     3. 如果发现通过文件路径判断不出来文件格式，那么就需要打开文件探测文件格式了，这个时候会首先调用io_open()打开文件，然后调用av_probe_input_buffer2()推测AVInputFormat。</p> 
<h4><a id="422av_probe_input_format2_3195"></a>4.2.2、av_probe_input_format2</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">const</span> AVInputFormat <span class="token operator">*</span><span class="token function">av_probe_input_format2</span><span class="token punctuation">(</span><span class="token keyword">const</span> AVProbeData <span class="token operator">*</span>pd<span class="token punctuation">,</span>
                                            <span class="token keyword">int</span> is_opened<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>score_max<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> score_ret<span class="token punctuation">;</span>
    <span class="token keyword">const</span> AVInputFormat <span class="token operator">*</span>fmt <span class="token operator">=</span> <span class="token function">av_probe_input_format3</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> is_opened<span class="token punctuation">,</span> <span class="token operator">&amp;</span>score_ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>score_ret <span class="token operator">&gt;</span> <span class="token operator">*</span>score_max<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>score_max <span class="token operator">=</span> score_ret<span class="token punctuation">;</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  该函数用于根据输入数据查找合适的AVInputFormat。参数含义如下所示：<br>     <strong>pd</strong>：存储输入数据信息的AVProbeData结构体。<br>     <strong>is_opened</strong>：文件是否打开。<br>     <strong>score_max</strong>：判决AVInputFormat的门限值。只有某格式判决分数大于该门限值的时候，函数才会返回该封装格式，否则返回NULL。<br>   从函数中可以看出，av_probe_input_format2()调用了av_probe_input_format3()，并且增加了一个判断，当av_probe_input_format3()返回的分数大于score_max的时候，才会返回AVInputFormat，否则返回NULL。<br>   下面我们看一下av_probe_input_format3()<br>   从函数声明中可以看出，av_probe_input_format3()和av_probe_input_format2()的区别是函数的第3个参数不同：av_probe_input_format2()是一个分数的门限值，而av_probe_input_format3()是一个探测后的最匹配的格式的分数值。<br>   av_probe_input_format3函数最主要的部分是循环。该循环调用av_iformat_next()遍历（av_demuxer_iterate函数替代了av_iformat_next）FFmpeg中所有的AVInputFormat，并根据以下规则确定AVInputFormat和输入媒体数据的匹配分数（score，反应匹配程度）：<br>     1. 如果AVInputFormat中包含read_probe()，就调用read_probe()函数获取匹配分数（这一方法如果结果匹配的话，一般会获得AVPROBE_SCORE_MAX的分值，即100分）。如果不包含该函数，就使用av_match_ext()函数比较输入媒体的扩展名和AVInputFormat的扩展名是否匹配，如果匹配的话，设定匹配分数为AVPROBE_SCORE_EXTENSION（AVPROBE_SCORE_EXTENSION取值为50，即50分）。<br>     2. 使用av_match_name()比较输入媒体的mime_type和AVInputFormat的mime_type，如果匹配的话，设定匹配分数为AVPROBE_SCORE_MIME（AVPROBE_SCORE_MIME取值为75，即75分）。<br>     3. 如果该AVInputFormat的匹配分数大于此前的最大匹配分数，则记录当前的匹配分数为最大匹配分数，并且记录当前的AVInputFormat为最佳匹配的AVInputFormat。</p> 
<h3><a id="43avformat_find_stream_info_3221"></a>4.3、avformat_find_stream_info</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>ic<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FFFormatContext <span class="token operator">*</span><span class="token keyword">const</span> si <span class="token operator">=</span> <span class="token function">ffformatcontext</span><span class="token punctuation">(</span>ic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> read_size<span class="token punctuation">;</span>
    AVPacket <span class="token operator">*</span>pkt1 <span class="token operator">=</span> si<span class="token operator">-&gt;</span>pkt<span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> old_offset  <span class="token operator">=</span> <span class="token function">avio_tell</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// new streams might appear, no options for those</span>
    <span class="token keyword">int</span> orig_nb_streams <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span>
    <span class="token keyword">int</span> flush_codecs<span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> max_analyze_duration <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>max_analyze_duration<span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> max_stream_analyze_duration<span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> max_subtitle_analyze_duration<span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> probesize <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>probesize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> eof_reached <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>missing_streams <span class="token operator">=</span> <span class="token function">av_opt_ptr</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>priv_class<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token string">"missing_streams"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    flush_codecs <span class="token operator">=</span> probesize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> <span class="token string">"skip_clear"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> AV_OPT_SEARCH_CHILDREN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    max_stream_analyze_duration <span class="token operator">=</span> max_analyze_duration<span class="token punctuation">;</span>
    max_subtitle_analyze_duration <span class="token operator">=</span> max_analyze_duration<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>max_analyze_duration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        max_stream_analyze_duration <span class="token operator">=</span>
        max_analyze_duration        <span class="token operator">=</span> <span class="token number">5</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
        max_subtitle_analyze_duration <span class="token operator">=</span> <span class="token number">30</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"flv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            max_stream_analyze_duration <span class="token operator">=</span> <span class="token number">90</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"mpeg"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"mpegts"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            max_stream_analyze_duration <span class="token operator">=</span> <span class="token number">7</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FFIOContext <span class="token operator">*</span><span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token function">ffiocontext</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"Before avformat_find_stream_info() pos: %"</span>PRId64<span class="token string">" bytes read:%"</span>PRId64<span class="token string">" seeks:%d nb_streams:%d\n"</span><span class="token punctuation">,</span>
               <span class="token function">avio_tell</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token operator">-&gt;</span>bytes_read<span class="token punctuation">,</span> ctx<span class="token operator">-&gt;</span>seek_count<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>codec<span class="token punctuation">;</span>
        AVDictionary <span class="token operator">*</span>thread_opt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AVCodecContext <span class="token operator">*</span><span class="token keyword">const</span> avctx <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">;</span>

        <span class="token comment">/* check if the caller has overridden the codec id */</span>
        <span class="token comment">// only for the split stuff</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sti<span class="token operator">-&gt;</span>parser <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOPARSE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>request_probe <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sti<span class="token operator">-&gt;</span>parser <span class="token operator">=</span> <span class="token function">av_parser_init</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">==</span> AVSTREAM_PARSE_HEADERS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PARSER_FLAG_COMPLETE_FRAMES<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">==</span> AVSTREAM_PARSE_FULL_RAW<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PARSER_FLAG_USE_CODEC_TS<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_parsing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_VERBOSE<span class="token punctuation">,</span> <span class="token string">"parser not found for codec "</span>
                       <span class="token string">"%s, packets or times may be invalid.\n"</span><span class="token punctuation">,</span>
                       <span class="token function">avcodec_get_name</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>request_probe <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            sti<span class="token operator">-&gt;</span>avctx_inited <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        codec <span class="token operator">=</span> <span class="token function">find_probe_decoder</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Force thread count to 1 since the H.264 decoder will not extract
         * SPS and PPS to extradata during multi-threaded decoding. */</span>
        <span class="token function">av_dict_set</span><span class="token punctuation">(</span>options <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>thread_opt<span class="token punctuation">,</span> <span class="token string">"threads"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* Force lowres to 0. The decoder might reduce the video size by the
         * lowres factor, and we don't want that propagated to the stream's
         * codecpar */</span>
        <span class="token function">av_dict_set</span><span class="token punctuation">(</span>options <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>thread_opt<span class="token punctuation">,</span> <span class="token string">"lowres"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>codec_whitelist<span class="token punctuation">)</span>
            <span class="token function">av_dict_set</span><span class="token punctuation">(</span>options <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>thread_opt<span class="token punctuation">,</span> <span class="token string">"codec_whitelist"</span><span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>codec_whitelist<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Try to just open decoders, in case this is enough to get parameters.</span>
        <span class="token comment">// Also ensure that subtitle_header is properly set.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_codec_parameters</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>request_probe <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_SUBTITLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>codec <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>codec<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> options <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>thread_opt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                           <span class="token string">"Failed to open codec in %s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">)</span>
            <span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    read_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">;</span>
        AVStream <span class="token operator">*</span>st<span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span>sti<span class="token punctuation">;</span>
        AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">;</span>
        <span class="token keyword">int</span> analyzed_all_streams<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ff_check_interrupt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ic<span class="token operator">-&gt;</span>interrupt_callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> AVERROR_EXIT<span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"interrupted\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* check if one codec still needs to be handled */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> fps_analyze_framecount <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> count<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_codec_parameters</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">/* If the timebase is coarse (like the usual millisecond precision
             * of mkv), we need to analyze more frames to reliably arrive at
             * the correct fps. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_q2d</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0005</span><span class="token punctuation">)</span>
                fps_analyze_framecount <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tb_unreliable</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">)</span>
                fps_analyze_framecount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>fps_probe_size <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                fps_analyze_framecount <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>fps_probe_size<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_ATTACHED_PIC<span class="token punctuation">)</span>
                fps_analyze_framecount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">/* variable fps and no guess at the real fps */</span>
            count <span class="token operator">=</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOTIMESTAMPS<span class="token punctuation">)</span> <span class="token operator">?</span>
                       sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration_fields<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">:</span>
                       sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>duration_count<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">.</span>num <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> fps_analyze_framecount<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Look at the first 3 frames if there is evidence of frame delay</span>
            <span class="token comment">// but the decoder delay is not set.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>frame_delay_evidence <span class="token operator">&amp;&amp;</span> count <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>has_b_frames <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>extradata <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token operator">!</span>sti<span class="token operator">-&gt;</span>extract_extradata<span class="token punctuation">.</span>inited <span class="token operator">||</span> sti<span class="token operator">-&gt;</span>extract_extradata<span class="token punctuation">.</span>bsf<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">extract_extradata_check</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>first_dts <span class="token operator">==</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOTIMESTAMPS<span class="token punctuation">)</span> <span class="token operator">||</span> sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">==</span> AVSTREAM_PARSE_FULL_RAW<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                sti<span class="token operator">-&gt;</span>codec_info_nb_frames <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_ATTACHED_PIC<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> ic<span class="token operator">-&gt;</span>max_ts_probe<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO <span class="token operator">||</span>
                 st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        analyzed_all_streams <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>missing_streams <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">*</span>missing_streams<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                analyzed_all_streams <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment">/* NOTE: If the format has no header, then we need to read some
                 * packets to get most of the streams, so we cannot stop here. */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>ctx_flags <span class="token operator">&amp;</span> AVFMTCTX_NOHEADER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/* If we found the info for all the codecs, we can stop. */</span>
                    ret <span class="token operator">=</span> count<span class="token punctuation">;</span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"All info found\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    flush_codecs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token comment">/* We did not get all the codec info, but we read too much data. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>read_size <span class="token operator">&gt;=</span> probesize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> count<span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span>
                   <span class="token string">"Probe buffer size limit of %"</span>PRId64<span class="token string">" bytes reached\n"</span><span class="token punctuation">,</span> probesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">.</span>num <span class="token operator">&amp;&amp;</span>
                    sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>duration_count <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
                    st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO <span class="token operator">&amp;&amp;</span>
                    <span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"image2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                           <span class="token string">"Stream #%d: not enough frames to estimate rate; "</span>
                           <span class="token string">"consider increasing probesize\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* NOTE: A new stream can be added there if no header in file
         * (AVFMTCTX_NOHEADER). */</span>
        ret <span class="token operator">=</span> <span class="token function">read_frame_internal</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> pkt1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* EOF or error*/</span>
            eof_reached <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOBUFFER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">avpriv_packet_list_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">,</span>
                                         pkt1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> unref_then_goto_end<span class="token punctuation">;</span>

            pkt <span class="token operator">=</span> <span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">.</span>tail<span class="token operator">-&gt;</span>pkt<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            pkt <span class="token operator">=</span> pkt1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_ATTACHED_PIC<span class="token punctuation">)</span><span class="token punctuation">)</span>
            read_size <span class="token operator">+=</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>

        avctx <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sti<span class="token operator">-&gt;</span>avctx_inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> unref_then_goto_end<span class="token punctuation">;</span>
            sti<span class="token operator">-&gt;</span>avctx_inited <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>codec_info_nb_frames <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* check for non-increasing dts */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts <span class="token operator">&gt;=</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span>
                       <span class="token string">"Non-increasing DTS in stream %d: packet %d with DTS "</span>
                       <span class="token string">"%"</span>PRId64<span class="token string">", packet %d with DTS %"</span>PRId64<span class="token string">"\n"</span><span class="token punctuation">,</span>
                       st<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts_idx<span class="token punctuation">,</span>
                       sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>codec_info_nb_frames<span class="token punctuation">,</span>
                       pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts <span class="token operator">=</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts  <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/* Check for a discontinuity in dts. If the difference in dts
             * is more than 1000 times the average packet duration in the
             * sequence, we treat it as a discontinuity. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts_idx <span class="token operator">&gt;</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts_idx <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">&gt;</span>
                <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts     <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts<span class="token punctuation">)</span> <span class="token operator">/</span>
                <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts_idx <span class="token operator">-</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts_idx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                       <span class="token string">"DTS discontinuity in stream %d: packet %d with DTS "</span>
                       <span class="token string">"%"</span>PRId64<span class="token string">", packet %d with DTS %"</span>PRId64<span class="token string">"\n"</span><span class="token punctuation">,</span>
                       st<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts_idx<span class="token punctuation">,</span>
                       sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>codec_info_nb_frames<span class="token punctuation">,</span>
                       pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts <span class="token operator">=</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts  <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* update stored dts values */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts <span class="token operator">==</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts     <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts_idx <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>codec_info_nb_frames<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts     <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span>
            sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts_idx <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>codec_info_nb_frames<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>codec_info_nb_frames <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int64_t</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> limit<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> AV_TIME_BASE_Q<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> <span class="token function">FFMAX</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>codec_info_nb_frames<span class="token punctuation">,</span> <span class="token function">av_inv_q</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">)</span><span class="token punctuation">,</span> AV_TIME_BASE_Q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>   t <span class="token operator">==</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>codec_info_nb_frames <span class="token operator">&gt;</span> <span class="token number">30</span>
                <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts <span class="token operator">!=</span> AV_NOPTS_VALUE
                <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts  <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int64_t</span> dur <span class="token operator">=</span> <span class="token function">av_sat_sub64</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t <span class="token operator">=</span> <span class="token function">FFMAX</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>dur<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> AV_TIME_BASE_Q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>analyzed_all_streams<span class="token punctuation">)</span>                                limit <span class="token operator">=</span> max_analyze_duration<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_SUBTITLE<span class="token punctuation">)</span> limit <span class="token operator">=</span> max_subtitle_analyze_duration<span class="token punctuation">;</span>
            <span class="token keyword">else</span>                                                     limit <span class="token operator">=</span> max_stream_analyze_duration<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&gt;=</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_VERBOSE<span class="token punctuation">,</span> <span class="token string">"max_analyze_duration %"</span>PRId64<span class="token string">" reached at %"</span>PRId64<span class="token string">" microseconds st:%d\n"</span><span class="token punctuation">,</span>
                       limit<span class="token punctuation">,</span>
                       t<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOBUFFER<span class="token punctuation">)</span>
                    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>duration <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> <span class="token keyword">int</span> fields <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>codec_desc <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>codec_desc<span class="token operator">-&gt;</span>props <span class="token operator">&amp;</span> AV_CODEC_PROP_FIELDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_SUBTITLE <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>start_time <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">&gt;=</span> st<span class="token operator">-&gt;</span>start_time
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>pkt<span class="token operator">-&gt;</span>pts <span class="token operator">-</span> st<span class="token operator">-&gt;</span>start_time <span class="token operator">&lt;</span> INT64_MAX
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration <span class="token operator">=</span> <span class="token function">FFMIN</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts <span class="token operator">-</span> st<span class="token operator">-&gt;</span>start_time<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration <span class="token operator">+</span> pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span>
                    sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration <span class="token operator">+=</span> pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration_fields <span class="token operator">+=</span> sti<span class="token operator">-&gt;</span>parser <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">&amp;&amp;</span> fields
                                                         <span class="token operator">?</span> sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>repeat_pict <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_R_FRAME_RATE</span></span>
            <span class="token function">ff_rfps_add_frame</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>frame_delay_evidence <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>extradata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">extract_extradata</span><span class="token punctuation">(</span>si<span class="token punctuation">,</span> st<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> unref_then_goto_end<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* If still no information, we try to open the codec and to
         * decompress the frame. We try to avoid that in most cases as
         * it takes longer and uses more memory. For MPEG-4, we need to
         * decompress for QuickTime.
         *
         * If AV_CODEC_CAP_CHANNEL_CONF is set this will force decoding of at
         * least one frame of codec data, this makes sure the codec initializes
         * the channel configuration and does not only trust the values from
         * the container. */</span>
        <span class="token function">try_decode_frame</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span>
                         <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> orig_nb_streams<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOBUFFER<span class="token punctuation">)</span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        sti<span class="token operator">-&gt;</span>codec_info_nb_frames<span class="token operator">++</span><span class="token punctuation">;</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>eof_reached<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> stream_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stream_index <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> stream_index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AVStream <span class="token operator">*</span><span class="token keyword">const</span> st <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            AVCodecContext <span class="token operator">*</span><span class="token keyword">const</span> avctx <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token operator">-&gt;</span>avctx<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_codec_parameters</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>codec <span class="token operator">=</span> <span class="token function">find_probe_decoder</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>codec <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    AVDictionary <span class="token operator">*</span>opts <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>codec_whitelist<span class="token punctuation">)</span>
                        <span class="token function">av_dict_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opts<span class="token punctuation">,</span> <span class="token string">"codec_whitelist"</span><span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>codec_whitelist<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> stream_index <span class="token operator">&lt;</span> orig_nb_streams<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>stream_index<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>opts<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                               <span class="token string">"Failed to open codec in %s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// EOF already reached while reading the stream above.</span>
            <span class="token comment">// So continue with reoordering DTS with whatever delay we have.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">.</span>head <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">has_decode_delay_been_guessed</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">update_dts_from_pts</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flush_codecs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVPacket <span class="token operator">*</span>empty_pkt <span class="token operator">=</span> si<span class="token operator">-&gt;</span>pkt<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>empty_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* flush the decoders */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>found_decoder <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                err <span class="token operator">=</span> <span class="token function">try_decode_frame</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">,</span> empty_pkt<span class="token punctuation">,</span>
                                        <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> orig_nb_streams<span class="token punctuation">)</span>
                                        <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span>
                        <span class="token string">"decoding for stream %d failed\n"</span><span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">ff_rfps_calculate</span><span class="token punctuation">(</span>ic<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AVCodecContext <span class="token operator">*</span><span class="token keyword">const</span> avctx <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_id <span class="token operator">==</span> AV_CODEC_ID_RAWVIDEO <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>codec_tag <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>bits_per_coded_sample<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">uint32_t</span> tag<span class="token operator">=</span> <span class="token function">avcodec_pix_fmt_to_codec_tag</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avpriv_pix_fmt_find</span><span class="token punctuation">(</span>PIX_FMT_LIST_RAW<span class="token punctuation">,</span> tag<span class="token punctuation">)</span> <span class="token operator">==</span> avctx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">)</span>
                    avctx<span class="token operator">-&gt;</span>codec_tag<span class="token operator">=</span> tag<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* estimate average framerate if not set by demuxer */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration_fields <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>num <span class="token operator">&amp;&amp;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> best_fps      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">double</span> best_error <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>
                AVRational codec_frame_rate <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>framerate<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration        <span class="token operator">&gt;=</span> INT64_MAX <span class="token operator">/</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num <span class="token operator">/</span> <span class="token number">2</span><span class="token operator">||</span>
                    sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration_fields <span class="token operator">&gt;=</span> INT64_MAX <span class="token operator">/</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den <span class="token operator">||</span>
                    sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration        <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token function">av_reduce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>num<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                          sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration_fields <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int64_t</span><span class="token punctuation">)</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                          sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>codec_info_duration <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int64_t</span><span class="token punctuation">)</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* Round guessed framerate to a "standard" framerate if it's
                 * within 1% of the original estimate. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> MAX_STD_TIMEBASES<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    AVRational std_fps <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token function">get_std_framerate</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token number">1001</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">double</span> error       <span class="token operator">=</span> <span class="token function">fabs</span><span class="token punctuation">(</span><span class="token function">av_q2d</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">)</span> <span class="token operator">/</span>
                                              <span class="token function">av_q2d</span><span class="token punctuation">(</span>std_fps<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&lt;</span> best_error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        best_error <span class="token operator">=</span> error<span class="token punctuation">;</span>
                        best_fps   <span class="token operator">=</span> std_fps<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>prefer_codec_framerate <span class="token operator">&amp;&amp;</span> codec_frame_rate<span class="token punctuation">.</span>num <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> codec_frame_rate<span class="token punctuation">.</span>den <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        error       <span class="token operator">=</span> <span class="token function">fabs</span><span class="token punctuation">(</span><span class="token function">av_q2d</span><span class="token punctuation">(</span>codec_frame_rate<span class="token punctuation">)</span> <span class="token operator">/</span>
                                           <span class="token function">av_q2d</span><span class="token punctuation">(</span>std_fps<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&lt;</span> best_error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            best_error <span class="token operator">=</span> error<span class="token punctuation">;</span>
                            best_fps   <span class="token operator">=</span> std_fps<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>best_fps<span class="token punctuation">)</span>
                    <span class="token function">av_reduce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>num<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                              best_fps<span class="token punctuation">,</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token number">1001</span><span class="token punctuation">,</span> INT_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> AVCodecDescriptor <span class="token operator">*</span>desc <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>codec_desc<span class="token punctuation">;</span>
                AVRational mul <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> desc <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>desc<span class="token operator">-&gt;</span>props <span class="token operator">&amp;</span> AV_CODEC_PROP_FIELDS<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                AVRational  fr <span class="token operator">=</span> <span class="token function">av_mul_q</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>framerate<span class="token punctuation">,</span> mul<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>fr<span class="token punctuation">.</span>num <span class="token operator">&amp;&amp;</span> fr<span class="token punctuation">.</span>den <span class="token operator">&amp;&amp;</span> <span class="token function">av_cmp_q</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> <span class="token function">av_inv_q</span><span class="token punctuation">(</span>fr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    st<span class="token operator">-&gt;</span>r_frame_rate <span class="token operator">=</span> fr<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">.</span>num <span class="token operator">=</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den<span class="token punctuation">;</span>
                    st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">.</span>den <span class="token operator">=</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>framerate <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>framerate<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>display_aspect_ratio<span class="token punctuation">.</span>num <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>display_aspect_ratio<span class="token punctuation">.</span>den<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                AVRational hw_ratio <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> avctx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> avctx<span class="token operator">-&gt;</span>width <span class="token punctuation">}</span><span class="token punctuation">;</span>
                st<span class="token operator">-&gt;</span>sample_aspect_ratio <span class="token operator">=</span> <span class="token function">av_mul_q</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>display_aspect_ratio<span class="token punctuation">,</span>
                                                   hw_ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>bits_per_coded_sample<span class="token punctuation">)</span>
                avctx<span class="token operator">-&gt;</span>bits_per_coded_sample <span class="token operator">=</span>
                    <span class="token function">av_get_bits_per_sample</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// set stream disposition based on audio service type</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>audio_service_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_EFFECTS<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_CLEAN_EFFECTS<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_VISUALLY_IMPAIRED<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_VISUAL_IMPAIRED<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_HEARING_IMPAIRED<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_HEARING_IMPAIRED<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_COMMENTARY<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_COMMENT<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_KARAOKE<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_KARAOKE<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>probesize<span class="token punctuation">)</span>
        <span class="token function">estimate_timings</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> old_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> <span class="token string">"skip_clear"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> AV_OPT_SEARCH_CHILDREN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span>
        <span class="token comment">/* We could not have all the codec parameters before EOF. */</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errmsg<span class="token punctuation">;</span>

        <span class="token comment">/* if no packet was ever seen, update context now for has_codec_parameters */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sti<span class="token operator">-&gt;</span>avctx_inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO <span class="token operator">&amp;&amp;</span>
                st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>format <span class="token operator">==</span> AV_SAMPLE_FMT_NONE<span class="token punctuation">)</span>
                st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>format <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>sample_fmt<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_codec_parameters</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> <span class="token operator">&amp;</span>errmsg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">avcodec_string</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                   <span class="token string">"Could not find codec parameters for stream %d (%s): %s\n"</span>
                   <span class="token string">"Consider increasing the value for the 'analyzeduration' (%"</span>PRId64<span class="token string">") and 'probesize' (%"</span>PRId64<span class="token string">") options\n"</span><span class="token punctuation">,</span>
                   i<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> errmsg<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>max_analyze_duration<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>probesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">compute_chapters_end</span><span class="token punctuation">(</span>ic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>

    <span class="token comment">/* update the stream parameters from the internal codec contexts */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx_inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_from_context</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_buffer_size <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_max_rate <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span>
                sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_min_rate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                size_t cpb_size<span class="token punctuation">;</span>
                AVCPBProperties <span class="token operator">*</span>props <span class="token operator">=</span> <span class="token function">av_cpb_properties_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpb_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_buffer_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        props<span class="token operator">-&gt;</span>buffer_size <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_buffer_size<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_min_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        props<span class="token operator">-&gt;</span>min_bitrate <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_min_rate<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_max_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        props<span class="token operator">-&gt;</span>max_bitrate <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>rc_max_rate<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">av_packet_side_data_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>coded_side_data<span class="token punctuation">,</span>
                                                 <span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>nb_coded_side_data<span class="token punctuation">,</span>
                                                 AV_PKT_DATA_CPB_PROPERTIES<span class="token punctuation">,</span>
                                                 <span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>props<span class="token punctuation">,</span> cpb_size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token function">av_free</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        sti<span class="token operator">-&gt;</span>avctx_inited <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVSTREAM_SIDE_DATA</span></span>
FF_DISABLE_DEPRECATION_WARNINGS
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>nb_coded_side_data <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_assert0</span><span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>side_data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>st<span class="token operator">-&gt;</span>nb_side_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>side_data <span class="token operator">=</span> <span class="token function">av_calloc</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>nb_coded_side_data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>st<span class="token operator">-&gt;</span>side_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>side_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>nb_coded_side_data<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">uint8_t</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">av_memdup</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>coded_side_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span>
                                          st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>coded_side_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                st<span class="token operator">-&gt;</span>side_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>coded_side_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">;</span>
                st<span class="token operator">-&gt;</span>side_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>coded_side_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">;</span>
                st<span class="token operator">-&gt;</span>side_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
                st<span class="token operator">-&gt;</span>nb_side_data<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
FF_ENABLE_DEPRECATION_WARNINGS
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>

find_stream_info_err<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>info<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>duration_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sti<span class="token operator">-&gt;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">avcodec_close</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// FIXME: avcodec_close() frees AVOption settable fields which includes ch_layout,</span>
        <span class="token comment">//        so we need to restore it.</span>
        <span class="token function">av_channel_layout_copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_bsf_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sti<span class="token operator">-&gt;</span>extract_extradata<span class="token punctuation">.</span>bsf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FFIOContext <span class="token operator">*</span><span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token function">ffiocontext</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"After avformat_find_stream_info() pos: %"</span>PRId64<span class="token string">" bytes read:%"</span>PRId64<span class="token string">" seeks:%d frames:%d\n"</span><span class="token punctuation">,</span>
               <span class="token function">avio_tell</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token operator">-&gt;</span>bytes_read<span class="token punctuation">,</span> ctx<span class="token operator">-&gt;</span>seek_count<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

unref_then_goto_end<span class="token operator">:</span>
    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <strong>代码调用流程图：</strong><br> <img src="https://images2.imgbox.com/2e/25/9dsIJZGH_o.png" alt="在这里插入图片描述"><br>   <strong>代码详细分析：</strong><br>     在进行探测前下面这部分代码用来设置探测的时长，可以看到部分时长和格式强相关的，应该和文件本身关系比较大。</p> 
<pre><code class="prism language-cpp">max_stream_analyze_duration <span class="token operator">=</span> max_analyze_duration<span class="token punctuation">;</span>
max_subtitle_analyze_duration <span class="token operator">=</span> max_analyze_duration<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>max_analyze_duration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    max_stream_analyze_duration <span class="token operator">=</span>
    max_analyze_duration        <span class="token operator">=</span> <span class="token number">5</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
    max_subtitle_analyze_duration <span class="token operator">=</span> <span class="token number">30</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"flv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        max_stream_analyze_duration <span class="token operator">=</span> <span class="token number">90</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"mpeg"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"mpegts"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        max_stream_analyze_duration <span class="token operator">=</span> <span class="token number">7</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  然后就是循环遍历打开每个流的解码器，为后续解码做准备，这部分就是调用avcodec_find_decoder和avcodec_open2查找解码器和打开解码器，具体实现等到讲解码时再说。<br>   之后便是不断循环检测，循环内部会不断判断当前是否已经成功获取完整的流信息，成功或者超出探测时长上限的话就结束；否则就会从读取AVPacket和解码帧AVFrame，读取AVPacket和解码AVFrame分别是调用ff_read_packet和avcodec_send_packet,avcodec_receive_frame进行码流的读取和解码。<br>   estimate_timings用于估算当前媒体文件的时长，根据不同的格式会采取不同的方式：<br>     1. mpeg和mpegts会采用pts的方式估算，即调用estimate_timings_from_pts估算。<br>     2. 如果非情况1且流本身已经探测到一部分时长信息，则调用fill_all_stream_timings根据已有的时长相关信息进行统一。<br>     3. 其他情况调用estimate_timings_from_bit_rate，利用文件码流大小和码率估算。<br> timate_timings_from_pts核心就是累加AVPacket的时长，如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
    is_end <span class="token operator">=</span> found_duration<span class="token punctuation">;</span>
    offset <span class="token operator">=</span> filesize <span class="token operator">-</span> <span class="token punctuation">(</span>DURATION_MAX_READ_SIZE <span class="token operator">&lt;&lt;</span> retry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">avio_seek</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    read_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream <span class="token operator">*</span>st<span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span>sti<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>read_size <span class="token operator">&gt;=</span> DURATION_MAX_READ_SIZE <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">FFMAX</span><span class="token punctuation">(</span>retry <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">ff_read_packet</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        read_size <span class="token operator">+=</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
        st         <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sti        <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>start_time <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">||</span>
             sti<span class="token operator">-&gt;</span>first_dts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>duration <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">compute_frame_duration</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num<span class="token punctuation">,</span> <span class="token operator">&amp;</span>den<span class="token punctuation">,</span> st<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>den <span class="token operator">&amp;&amp;</span> num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    pkt<span class="token operator">-&gt;</span>duration <span class="token operator">=</span> <span class="token function">av_rescale_rnd</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>
                                       num <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int64_t</span><span class="token punctuation">)</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                                       den <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int64_t</span><span class="token punctuation">)</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">,</span>
                                       AV_ROUND_DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            duration <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">+</span> pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">;</span>
            found_duration <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>start_time <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
                duration <span class="token operator">-=</span> st<span class="token operator">-&gt;</span>start_time<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                duration <span class="token operator">-=</span> sti<span class="token operator">-&gt;</span>first_dts<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>duration <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>duration <span class="token operator">==</span> AV_NOPTS_VALUE <span class="token operator">||</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>last_duration<span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
                    <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>duration <span class="token operator">&lt;</span> duration <span class="token operator">&amp;&amp;</span> <span class="token function">FFABS</span><span class="token punctuation">(</span>duration <span class="token operator">-</span> sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>last_duration<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">60LL</span><span class="token operator">*</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den <span class="token operator">/</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    st<span class="token operator">-&gt;</span>duration <span class="token operator">=</span> duration<span class="token punctuation">;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>last_duration <span class="token operator">=</span> duration<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* check if all audio/video streams have valid duration */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_end<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        is_end <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> AVStream <span class="token operator">*</span><span class="token keyword">const</span> st <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>
                <span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>duration <span class="token operator">==</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
                        is_end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_end <span class="token operator">&amp;&amp;</span>
         offset <span class="token operator">&amp;&amp;</span>
         <span class="token operator">++</span>retry <span class="token operator">&lt;=</span> DURATION_MAX_RETRY<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="44av_read_frame_3920"></a>4.4、av_read_frame</h3> 
<p>  FFmpeg使用av_read_frame()方法读取音频流、视频流、字幕流，得到AVPacket数据包。FFmpeg官方提供的samples有使用示例，或者在ffplay.c代码中：打开文件/网络流后，while循环调用av_read_frame()读取帧数据，也就是解封装demux过程，直到文件末尾EOF。<br>   av_read_frame()的定义位于libavformat\utils.c，如下所示：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">av_read_frame</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FFFormatContext <span class="token operator">*</span><span class="token keyword">const</span> si <span class="token operator">=</span> <span class="token function">ffformatcontext</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> genpts <span class="token operator">=</span> s<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_GENPTS<span class="token punctuation">;</span>
    <span class="token keyword">int</span> eof <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    AVStream <span class="token operator">*</span>st<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>genpts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">.</span>head
              <span class="token operator">?</span> <span class="token function">avpriv_packet_list_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span>
              <span class="token operator">:</span> <span class="token function">read_frame_internal</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> return_packet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        PacketListEntry <span class="token operator">*</span>pktl <span class="token operator">=</span> si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">.</span>head<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pktl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AVPacket <span class="token operator">*</span>next_pkt <span class="token operator">=</span> <span class="token operator">&amp;</span>pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>next_pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> wrap_bits <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>next_pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>pts_wrap_bits<span class="token punctuation">;</span>
                <span class="token comment">// last dts seen for this stream. if any of packets following</span>
                <span class="token comment">// current one had no dts, we will set this to AV_NOPTS_VALUE.</span>
                <span class="token keyword">int64_t</span> last_dts <span class="token operator">=</span> next_pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span>
                <span class="token function">av_assert2</span><span class="token punctuation">(</span>wrap_bits <span class="token operator">&lt;=</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>pktl <span class="token operator">&amp;&amp;</span> next_pkt<span class="token operator">-&gt;</span>pts <span class="token operator">==</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">.</span>stream_index <span class="token operator">==</span> next_pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">&amp;&amp;</span>
                        <span class="token function">av_compare_mod</span><span class="token punctuation">(</span>next_pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">,</span> pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">.</span>dts<span class="token punctuation">,</span> <span class="token number">2ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>wrap_bits <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_compare_mod</span><span class="token punctuation">(</span>pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">.</span>pts<span class="token punctuation">,</span> pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">.</span>dts<span class="token punctuation">,</span> <span class="token number">2ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>wrap_bits <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// not B-frame</span>
                            next_pkt<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">.</span>dts<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>last_dts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// Once last dts was set to AV_NOPTS_VALUE, we don't change it.</span>
                            last_dts <span class="token operator">=</span> pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">.</span>dts<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    pktl <span class="token operator">=</span> pktl<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>eof <span class="token operator">&amp;&amp;</span> next_pkt<span class="token operator">-&gt;</span>pts <span class="token operator">==</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> last_dts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Fixing the last reference frame had none pts issue (For MXF etc).</span>
                    <span class="token comment">// We only do this when</span>
                    <span class="token comment">// 1. eof.</span>
                    <span class="token comment">// 2. we are not able to resolve a pts value for current packet.</span>
                    <span class="token comment">// 3. the packets for this stream at the end of the files had valid dts.</span>
                    next_pkt<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> last_dts <span class="token operator">+</span> next_pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                pktl <span class="token operator">=</span> si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* read packet from packet buffer, if there is data */</span>
            st <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>next_pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>next_pkt<span class="token operator">-&gt;</span>pts <span class="token operator">==</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>discard <span class="token operator">&lt;</span> AVDISCARD_ALL <span class="token operator">&amp;&amp;</span>
                  next_pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eof<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ret <span class="token operator">=</span> <span class="token function">avpriv_packet_list_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> return_packet<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        ret <span class="token operator">=</span> <span class="token function">read_frame_internal</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pktl <span class="token operator">&amp;&amp;</span> ret <span class="token operator">!=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                eof <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ret <span class="token operator">=</span> <span class="token function">avpriv_packet_list_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">,</span>
                                     pkt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

return_packet<span class="token operator">:</span>
    st <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_GENERIC_INDEX<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_PKT_FLAG_KEY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ff_reduce_index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_add_index_entry</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pos<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> AVINDEX_KEYFRAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_relative</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pkt<span class="token operator">-&gt;</span>dts <span class="token operator">-=</span> RELATIVE_TS_BASE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_relative</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pkt<span class="token operator">-&gt;</span>pts <span class="token operator">-=</span> RELATIVE_TS_BASE<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  av_read_frame()的调用链如下图所示：<br> <img src="https://images2.imgbox.com/52/51/4WVzFWjf_o.png" alt="在这里插入图片描述"><br>   可以从源代码中看出，av_read_frame()调用了read_frame_internal()。</p> 
<h4><a id="441read_frame_internal_4023"></a>4.4.1、read_frame_internal</h4> 
<p>  read_frame_internal 在ffmpeg中实现了将format格式的packet,最终转换成一帧帧的es流packet，并解析填充了packet的pts,dts等信息，为最终解码提供了重要的数据，read_frame_internal，调用ff_read_packet，每次只读取一个包，然后直到parser完这个包的所有数据，才开始读取下一个包，parser完的数据被保存在parser结构的数据缓冲中，这样即使ff_read_packet读取的下一包和前一包的流不一样，由于parser也不一样，所以实现了read_frame_internal这个函数调用，可以解析出不同流的es流,而read_frame_internal函数除非出错否则必须解析出一帧数据才能返回。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">read_frame_internal</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FFFormatContext <span class="token operator">*</span><span class="token keyword">const</span> si <span class="token operator">=</span> <span class="token function">ffformatcontext</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> got_packet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    AVDictionary <span class="token operator">*</span>metadata <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>got_packet <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>si<span class="token operator">-&gt;</span>parse_queue<span class="token punctuation">.</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream <span class="token operator">*</span>st<span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span>sti<span class="token punctuation">;</span>

        <span class="token comment">// 读取下一个数据包</span>
        ret <span class="token operator">=</span> <span class="token function">ff_read_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token comment">/* flush the parsers */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>need_parsing<span class="token punctuation">)</span>
                    <span class="token function">parse_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/* all remaining packets are now in parse_queue =&gt;
             * really terminate parsing */</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        st  <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>

        st<span class="token operator">-&gt;</span>event_flags <span class="token operator">|=</span> AVSTREAM_EVENT_FLAG_NEW_PACKETS<span class="token punctuation">;</span>

        <span class="token comment">/* update context if required */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_context_update<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_is_open</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"Demuxer context update while decoder is open, closing and trying to re-open\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">avcodec_close</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sti<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>found_decoder <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* close parser, because it depends on the codec */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>codec_id <span class="token operator">!=</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_parser_close</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sti<span class="token operator">-&gt;</span>parser <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            sti<span class="token operator">-&gt;</span>codec_desc <span class="token operator">=</span> <span class="token function">avcodec_descriptor_get</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            sti<span class="token operator">-&gt;</span>need_context_update <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span>
            pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span>
            pkt<span class="token operator">-&gt;</span>pts <span class="token operator">&lt;</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                   <span class="token string">"Invalid timestamps stream=%d, pts=%s, dts=%s, size=%d\n"</span><span class="token punctuation">,</span>
                   pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">,</span>
                   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>debug <span class="token operator">&amp;</span> FF_FDEBUG_TS<span class="token punctuation">)</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span>
                   <span class="token string">"ff_read_packet stream=%d, pts=%s, dts=%s, size=%d, duration=%"</span>PRId64<span class="token string">", flags=%d\n"</span><span class="token punctuation">,</span>
                   pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">,</span>
                   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sti<span class="token operator">-&gt;</span>parser <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOPARSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sti<span class="token operator">-&gt;</span>parser <span class="token operator">=</span> <span class="token function">av_parser_init</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_VERBOSE<span class="token punctuation">,</span> <span class="token string">"parser not found for codec "</span>
                       <span class="token string">"%s, packets or times may be invalid.\n"</span><span class="token punctuation">,</span>
                       <span class="token function">avcodec_get_name</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/* no parser available: just output the raw packets */</span>
                sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">=</span> AVSTREAM_PARSE_NONE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">==</span> AVSTREAM_PARSE_HEADERS<span class="token punctuation">)</span>
                sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PARSER_FLAG_COMPLETE_FRAMES<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">==</span> AVSTREAM_PARSE_FULL_ONCE<span class="token punctuation">)</span>
                sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PARSER_FLAG_ONCE<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">==</span> AVSTREAM_PARSE_FULL_RAW<span class="token punctuation">)</span>
                sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PARSER_FLAG_USE_CODEC_TS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">||</span> <span class="token operator">!</span>sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* no parsing needed: we just output the packet as is */</span>
            <span class="token function">compute_pkt_fields</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> AV_NOPTS_VALUE<span class="token punctuation">,</span> AV_NOPTS_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_GENERIC_INDEX<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_PKT_FLAG_KEY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">ff_reduce_index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">av_add_index_entry</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pos<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">,</span>
                                   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> AVINDEX_KEYFRAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            got_packet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>discard <span class="token operator">&lt;</span> AVDISCARD_ALL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">parse_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>sample_rate <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>bit_rate <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>bit_rate<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_OLD_CHANNEL_LAYOUT</span></span>
FF_DISABLE_DEPRECATION_WARNINGS
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>channels <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">.</span>nb_channels<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>channel_layout <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">.</span>order <span class="token operator">==</span> AV_CHANNEL_ORDER_NATIVE <span class="token operator">?</span>
                                           sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">.</span>u<span class="token punctuation">.</span>mask <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
FF_ENABLE_DEPRECATION_WARNINGS
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            ret <span class="token operator">=</span> <span class="token function">av_channel_layout_copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* free packet */</span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_PKT_FLAG_KEY<span class="token punctuation">)</span>
            sti<span class="token operator">-&gt;</span>skip_to_keyframe <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>skip_to_keyframe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            got_packet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>got_packet <span class="token operator">&amp;&amp;</span> si<span class="token operator">-&gt;</span>parse_queue<span class="token punctuation">.</span>head<span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token function">avpriv_packet_list_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>parse_queue<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> discard_padding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>first_discard_sample <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int64_t</span> pts <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token function">is_relative</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span> <span class="token operator">?</span> RELATIVE_TS_BASE <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> sample <span class="token operator">=</span> <span class="token function">ts_to_samples</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> duration <span class="token operator">=</span> <span class="token function">ts_to_samples</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> end_sample <span class="token operator">=</span> sample <span class="token operator">+</span> duration<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>duration <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> end_sample <span class="token operator">&gt;=</span> sti<span class="token operator">-&gt;</span>first_discard_sample <span class="token operator">&amp;&amp;</span>
                sample <span class="token operator">&lt;</span> sti<span class="token operator">-&gt;</span>last_discard_sample<span class="token punctuation">)</span>
                discard_padding <span class="token operator">=</span> <span class="token function">FFMIN</span><span class="token punctuation">(</span>end_sample <span class="token operator">-</span> sti<span class="token operator">-&gt;</span>first_discard_sample<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>start_skip_samples <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">==</span> RELATIVE_TS_BASE<span class="token punctuation">)</span><span class="token punctuation">)</span>
            sti<span class="token operator">-&gt;</span>skip_samples <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>start_skip_samples<span class="token punctuation">;</span>
        sti<span class="token operator">-&gt;</span>skip_samples <span class="token operator">=</span> <span class="token function">FFMAX</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>skip_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>skip_samples <span class="token operator">||</span> discard_padding<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">uint8_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">av_packet_new_side_data</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> AV_PKT_DATA_SKIP_SAMPLES<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">AV_WL32</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>skip_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">AV_WL32</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> discard_padding<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"demuxer injecting skip %u / discard %u\n"</span><span class="token punctuation">,</span>
                       <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span>sti<span class="token operator">-&gt;</span>skip_samples<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span>discard_padding<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sti<span class="token operator">-&gt;</span>skip_samples <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVSTREAM_SIDE_DATA</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>inject_global_side_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>nb_coded_side_data<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> AVPacketSideData <span class="token operator">*</span><span class="token keyword">const</span> src_sd <span class="token operator">=</span> <span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>coded_side_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">uint8_t</span> <span class="token operator">*</span>dst_data<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_packet_get_side_data</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> src_sd<span class="token operator">-&gt;</span>type<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>

                dst_data <span class="token operator">=</span> <span class="token function">av_packet_new_side_data</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> src_sd<span class="token operator">-&gt;</span>type<span class="token punctuation">,</span> src_sd<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dst_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span> <span class="token string">"Could not inject global side data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">memcpy</span><span class="token punctuation">(</span>dst_data<span class="token punctuation">,</span> src_sd<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> src_sd<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sti<span class="token operator">-&gt;</span>inject_global_side_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-&gt;</span>metafree<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> metaret <span class="token operator">=</span> <span class="token function">av_opt_get_dict_val</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"metadata"</span><span class="token punctuation">,</span> AV_OPT_SEARCH_CHILDREN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            s<span class="token operator">-&gt;</span>event_flags <span class="token operator">|=</span> AVFMT_EVENT_FLAG_METADATA_UPDATED<span class="token punctuation">;</span>
            <span class="token function">av_dict_copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>metadata<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_opt_set_dict_val</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"metadata"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> AV_OPT_SEARCH_CHILDREN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        si<span class="token operator">-&gt;</span>metafree <span class="token operator">=</span> metaret <span class="token operator">==</span> AVERROR_OPTION_NOT_FOUND<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>debug <span class="token operator">&amp;</span> FF_FDEBUG_TS<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span>
               <span class="token string">"read_frame_internal stream=%d, pts=%s, dts=%s, "</span>
               <span class="token string">"size=%d, duration=%"</span>PRId64<span class="token string">", flags=%d\n"</span><span class="token punctuation">,</span>
               pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">,</span>
               <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">,</span>
               pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* A demuxer might have returned EOF because of an IO error, let's
     * propagate this back to the user. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> AVERROR_EOF <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>pb <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>error <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>error <span class="token operator">!=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>error<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  read_frame_internal()代码比较长，这里只简单看一下它前面的部分。它前面部分有2步是十分关键的：<br>     1. 调用了ff_read_packet()从相应的AVInputFormat读取数据。<br>     2. 如果媒体频流需要使用AVCodecParser，则调用parse_packet()解析相应的AVPacket。<br>   下面我们分成分别看一下ff_read_packet()和parse_packet()的源代码。</p> 
<h4><a id="442ff_read_packet_4240"></a>4.4.2、ff_read_packet</h4> 
<p>  ff_read_packet函数也是会判断缓存是否有数据，若有则从缓存中取出，若没有，则调用demuxer的read_packet来读取数据。ff_read_packet()中最关键的地方就是调用了AVInputFormat的read_packet()方法。AVInputFormat的read_packet()是一个函数指针，指向当前的AVInputFormat的读取数据的函数，比如flv的flv_read_packet，flv_read_packet()的代码比较长，但是逻辑比较简单。它的主要功能就是根据FLV文件格式的规范，逐层解析Tag以及TagData，获取Tag以及TagData中的信息。<br>   ff_read_packet的缓存和av_read_frame函数里的缓存是不一样的，ff_read_packet的缓存为AVFormatInternal::raw_packet_buffer，在av_read_frame函数里缓存则为：<br>   AVFormatInternal::packet_buffer，简单的理解为在codec被识别之前用raw_packet_buffer缓存，codec识别后用packet_buffer。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">ff_read_packet</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FFFormatContext <span class="token operator">*</span><span class="token keyword">const</span> si <span class="token operator">=</span> <span class="token function">ffformatcontext</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_INIT_PACKET</span></span>
FF_DISABLE_DEPRECATION_WARNINGS
    pkt<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    pkt<span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">av_init_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
FF_ENABLE_DEPRECATION_WARNINGS
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token comment">/* 这里是不断从队列中取出一个pkt（raw buffer只要有数据）返回给上层和不断的读取数据加入到raw buffer */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        PacketListEntry <span class="token operator">*</span>pktl <span class="token operator">=</span> si<span class="token operator">-&gt;</span>raw_packet_buffer<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
        AVStream <span class="token operator">*</span>st<span class="token punctuation">;</span>
        FFStream <span class="token operator">*</span>sti<span class="token punctuation">;</span>
        <span class="token keyword">const</span> AVPacket <span class="token operator">*</span>pkt1<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pktl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* 得到AVPacket包 */</span>
            AVStream <span class="token operator">*</span><span class="token keyword">const</span> st <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">.</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>raw_packet_buffer_size <span class="token operator">&gt;=</span> s<span class="token operator">-&gt;</span>probesize<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err <span class="token operator">=</span> <span class="token function">probe_codec</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
            <span class="token comment">/* -1是probe完成，0是不要probe */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token operator">-&gt;</span>request_probe <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">avpriv_packet_list_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>raw_packet_buffer<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/* 归还队列空间 */</span>
                si<span class="token operator">-&gt;</span>raw_packet_buffer_size <span class="token operator">-=</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/*  0表示成功，小于0表示错误，pkt就在这里获取到。*/</span>
        err <span class="token operator">=</span> s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span><span class="token function">read_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Some demuxers return FFERROR_REDO when they consume
               data and discard it (ignored streams, junk, extradata).
               We must re-call the demuxer to get the real packet. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> FFERROR_REDO<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pktl <span class="token operator">||</span> err <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> err<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                AVStream <span class="token operator">*</span><span class="token keyword">const</span> st  <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>probe_packets <span class="token operator">||</span> sti<span class="token operator">-&gt;</span>request_probe <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err <span class="token operator">=</span> <span class="token function">probe_codec</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
                <span class="token function">av_assert0</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>request_probe <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        err <span class="token operator">=</span> <span class="token function">av_packet_make_refcounted</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/* 读取成功，判断是否需要丢弃 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_PKT_FLAG_CORRUPT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                   <span class="token string">"Packet corrupt (stream = %d, dts = %s)"</span><span class="token punctuation">,</span>
                   pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">,</span> <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_DISCARD_CORRUPT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span> <span class="token string">", dropping it.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span> <span class="token string">".\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">av_assert0</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span>s<span class="token operator">-&gt;</span>nb_streams <span class="token operator">&amp;&amp;</span>
                   <span class="token string">"Invalid stream index.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* 得到读取到的这个包所在的stream，以为pkt获取时间戳 */</span>
        st  <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">update_wrap_reference</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>pts_wrap_behavior <span class="token operator">==</span> AV_PTS_WRAP_SUB_OFFSET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// correct first time stamps to negative values</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_relative</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>first_dts<span class="token punctuation">)</span><span class="token punctuation">)</span>
                sti<span class="token operator">-&gt;</span>first_dts <span class="token operator">=</span> <span class="token function">wrap_timestamp</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>first_dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_relative</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>start_time<span class="token punctuation">)</span><span class="token punctuation">)</span>
                st<span class="token operator">-&gt;</span>start_time <span class="token operator">=</span> <span class="token function">wrap_timestamp</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_relative</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>cur_dts<span class="token punctuation">)</span><span class="token punctuation">)</span>
                sti<span class="token operator">-&gt;</span>cur_dts <span class="token operator">=</span> <span class="token function">wrap_timestamp</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>cur_dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pkt<span class="token operator">-&gt;</span>dts <span class="token operator">=</span> <span class="token function">wrap_timestamp</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkt<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> <span class="token function">wrap_timestamp</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">force_codec_ids</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* TODO: audio: time filter; video: frame reordering (pts != dts) */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>use_wallclock_as_timestamps<span class="token punctuation">)</span>
            pkt<span class="token operator">-&gt;</span>dts <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span><span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> AV_TIME_BASE_Q<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pktl <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>request_probe <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">avpriv_packet_list_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>raw_packet_buffer<span class="token punctuation">,</span>
                                     pkt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pkt1 <span class="token operator">=</span> <span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>raw_packet_buffer<span class="token punctuation">.</span>tail<span class="token operator">-&gt;</span>pkt<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>raw_packet_buffer_size <span class="token operator">+=</span> pkt1<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err <span class="token operator">=</span> <span class="token function">probe_codec</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">,</span> pkt1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="443parse_packet_4367"></a>4.4.3、parse_packet</h4> 
<p>  用于将输入流中的音视频信息按帧封装为packet对象，供进一步处理。需传入输入流上下文和用于装载数据的packet对象</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">parse_packet</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> stream_index<span class="token punctuation">,</span> <span class="token keyword">int</span> flush<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FFFormatContext <span class="token operator">*</span><span class="token keyword">const</span> si <span class="token operator">=</span> <span class="token function">ffformatcontext</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    AVPacket <span class="token operator">*</span>out_pkt <span class="token operator">=</span> si<span class="token operator">-&gt;</span>parse_pkt<span class="token punctuation">;</span>
    AVStream <span class="token operator">*</span>st <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    FFStream <span class="token operator">*</span><span class="token keyword">const</span> sti <span class="token operator">=</span> <span class="token function">ffstream</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>data <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> got_output <span class="token operator">=</span> flush<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>size <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flush <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> PARSER_FLAG_COMPLETE_FRAMES<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// preserve 0-size sync packets</span>
        <span class="token function">compute_pkt_fields</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> AV_NOPTS_VALUE<span class="token punctuation">,</span> AV_NOPTS_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>flush <span class="token operator">&amp;&amp;</span> got_output<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int64_t</span> next_pts <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">;</span>
        <span class="token keyword">int64_t</span> next_dts <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span>
        <span class="token keyword">int</span> len<span class="token punctuation">;</span>
        <span class="token comment">/* 真正去解析数据包 */</span>
        len <span class="token operator">=</span> <span class="token function">av_parser_parse2</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>avctx<span class="token punctuation">,</span>
                               <span class="token operator">&amp;</span>out_pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>out_pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">,</span> data<span class="token punctuation">,</span> size<span class="token punctuation">,</span>
                               pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

        pkt<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>dts <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
        pkt<span class="token operator">-&gt;</span>pos <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">/* increment read pointer */</span>
        <span class="token function">av_assert1</span><span class="token punctuation">(</span>data <span class="token operator">||</span> <span class="token operator">!</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data  <span class="token operator">=</span> len <span class="token operator">?</span> data <span class="token operator">+</span> len <span class="token operator">:</span> data<span class="token punctuation">;</span>
        size <span class="token operator">-=</span> len<span class="token punctuation">;</span>

        got_output <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>out_pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>buf <span class="token operator">&amp;&amp;</span> out_pkt<span class="token operator">-&gt;</span>data <span class="token operator">==</span> pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* reference pkt-&gt;buf only when out_pkt-&gt;data is guaranteed to point
             * to data in it and not in the parser's internal buffer. */</span>
            <span class="token comment">/* XXX: Ensure this is the case with all parsers when sti-&gt;parser-&gt;flags
             * is PARSER_FLAG_COMPLETE_FRAMES and check for that instead? */</span>
            out_pkt<span class="token operator">-&gt;</span>buf <span class="token operator">=</span> <span class="token function">av_buffer_ref</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_pkt<span class="token operator">-&gt;</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">av_packet_make_refcounted</span><span class="token punctuation">(</span>out_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>side_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            out_pkt<span class="token operator">-&gt;</span>side_data       <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>side_data<span class="token punctuation">;</span>
            out_pkt<span class="token operator">-&gt;</span>side_data_elems <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>side_data_elems<span class="token punctuation">;</span>
            pkt<span class="token operator">-&gt;</span>side_data          <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            pkt<span class="token operator">-&gt;</span>side_data_elems    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* set the duration */</span>
        out_pkt<span class="token operator">-&gt;</span>duration <span class="token operator">=</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> PARSER_FLAG_COMPLETE_FRAMES<span class="token punctuation">)</span> <span class="token operator">?</span> pkt<span class="token operator">-&gt;</span>duration <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>sample_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                out_pkt<span class="token operator">-&gt;</span>duration <span class="token operator">=</span>
                    <span class="token function">av_rescale_q_rnd</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>duration<span class="token punctuation">,</span>
                                     <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>sample_rate <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                     st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span>
                                     AV_ROUND_DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id <span class="token operator">==</span> AV_CODEC_ID_GIF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                out_pkt<span class="token operator">-&gt;</span>duration <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>duration<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        out_pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">=</span> st<span class="token operator">-&gt;</span>index<span class="token punctuation">;</span>
        out_pkt<span class="token operator">-&gt;</span>pts          <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>pts<span class="token punctuation">;</span>
        out_pkt<span class="token operator">-&gt;</span>dts          <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span>
        out_pkt<span class="token operator">-&gt;</span>pos          <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>pos<span class="token punctuation">;</span>
        out_pkt<span class="token operator">-&gt;</span>flags       <span class="token operator">|=</span> pkt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>AV_PKT_FLAG_DISCARD <span class="token operator">|</span> AV_PKT_FLAG_CORRUPT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>need_parsing <span class="token operator">==</span> AVSTREAM_PARSE_FULL_RAW<span class="token punctuation">)</span>
            out_pkt<span class="token operator">-&gt;</span>pos <span class="token operator">=</span> sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>frame_offset<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>key_frame <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>key_frame <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
             sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>pict_type <span class="token operator">==</span> AV_PICTURE_TYPE_I<span class="token punctuation">)</span><span class="token punctuation">)</span>
            out_pkt<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> AV_PKT_FLAG_KEY<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>key_frame <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> sti<span class="token operator">-&gt;</span>parser<span class="token operator">-&gt;</span>pict_type <span class="token operator">==</span>AV_PICTURE_TYPE_NONE <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>flags<span class="token operator">&amp;</span>AV_PKT_FLAG_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span>
            out_pkt<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> AV_PKT_FLAG_KEY<span class="token punctuation">;</span>

        <span class="token function">compute_pkt_fields</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">,</span> sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">,</span> out_pkt<span class="token punctuation">,</span> next_dts<span class="token punctuation">,</span> next_pts<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">avpriv_packet_list_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>parse_queue<span class="token punctuation">,</span>
                                     out_pkt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* end of the stream =&gt; close and free the parser */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_parser_close</span><span class="token punctuation">(</span>sti<span class="token operator">-&gt;</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sti<span class="token operator">-&gt;</span>parser <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

fail<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>out_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  最终是调用libavcodec/parser.c的av_parser_parse2()方法去解析数据包。</p> 
<h3><a id="45avformat_seek_file_4487"></a>4.5、avformat_seek_file</h3> 
<p>  在做音视频数据分析的时候，经常会遇到这样的需求，每隔5分钟抽取一帧数据进行分析。<br>   在做播放器开发的时候，也会遇到这种情况，就是拖动进度条跳转到某个位置进行播放。<br>   如果直接用 av_read_frame() 不断读数据，读到第 5 分钟的 AVPacket 才开始处理，其他读出来的 AVPacket 丢弃，这样做会带来非常大的磁盘IO。<br>   其实上面两种场景，都可以用同一个函数解决，那就是 avformat_seek_file()，这个函数类似于 Linux 的 lseek() ，设置文件的读取位置。<br>   只不过 avformat_seek_file() 是用于音视频文件的。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">avformat_seek_file</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> stream_index<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> min_ts<span class="token punctuation">,</span>
                       <span class="token keyword">int64_t</span> ts<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> max_ts<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>min_ts <span class="token operator">&gt;</span> ts <span class="token operator">||</span> max_ts <span class="token operator">&lt;</span> ts<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stream_index <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> stream_index <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>s<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>seek2any <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        flags <span class="token operator">|=</span> AVSEEK_FLAG_ANY<span class="token punctuation">;</span>
    flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>AVSEEK_FLAG_BACKWARD<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_seek2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
        <span class="token function">ff_read_frame_flush</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>nb_streams <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AVRational time_base <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>
            ts <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>ts<span class="token punctuation">,</span> AV_TIME_BASE_Q<span class="token punctuation">,</span> time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            min_ts <span class="token operator">=</span> <span class="token function">av_rescale_rnd</span><span class="token punctuation">(</span>min_ts<span class="token punctuation">,</span> time_base<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                                    time_base<span class="token punctuation">.</span>num <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int64_t</span><span class="token punctuation">)</span>AV_TIME_BASE<span class="token punctuation">,</span>
                                    AV_ROUND_UP   <span class="token operator">|</span> AV_ROUND_PASS_MINMAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
            max_ts <span class="token operator">=</span> <span class="token function">av_rescale_rnd</span><span class="token punctuation">(</span>max_ts<span class="token punctuation">,</span> time_base<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                                    time_base<span class="token punctuation">.</span>num <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int64_t</span><span class="token punctuation">)</span>AV_TIME_BASE<span class="token punctuation">,</span>
                                    AV_ROUND_DOWN <span class="token operator">|</span> AV_ROUND_PASS_MINMAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stream_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span><span class="token function">read_seek2</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> min_ts<span class="token punctuation">,</span>
                                     ts<span class="token punctuation">,</span> max_ts<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            ret <span class="token operator">=</span> <span class="token function">avformat_queue_attached_pictures</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// try to seek via read_timestamp()</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Fall back on old API if new is not implemented but old is.</span>
    <span class="token comment">// Note the old API has somewhat different semantics.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_seek <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> dir <span class="token operator">=</span> <span class="token punctuation">(</span>ts <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>min_ts <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>max_ts <span class="token operator">-</span> ts <span class="token operator">?</span> AVSEEK_FLAG_BACKWARD <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">av_seek_frame</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> flags <span class="token operator">|</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ts <span class="token operator">!=</span> min_ts <span class="token operator">&amp;&amp;</span> max_ts <span class="token operator">!=</span> ts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">av_seek_frame</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> dir <span class="token operator">?</span> max_ts <span class="token operator">:</span> min_ts<span class="token punctuation">,</span> flags <span class="token operator">|</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                ret <span class="token operator">=</span> <span class="token function">av_seek_frame</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> flags <span class="token operator">|</span> <span class="token punctuation">(</span>dir<span class="token operator">^</span>AVSEEK_FLAG_BACKWARD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// try some generic seek like seek_frame_generic() but with new ts semantics</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//unreachable</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>参数解释如下：</strong><br>     1. AVFormatContext *s，已经打开的容器示例。<br>     2. int stream_index，流索引，但是只有在 flags 包含 AVSEEK_FLAG_FRAME 的时候才是 设置某个流的读取位置。其他情况都只是把这个流的 time_base （时间基）作为参考。<br>     3. int64_t min_ts，跳转到的最小的时间，但是这个变量不一定是时间单位，也有可能是字节单位，也可能是帧数单位（第几帧）。<br>     4. int64_t ts，要跳转到的读取位置，单位同上。<br>     5. int64_t max_ts，跳转到的最大的时间，单位同上，通常填 INT64_MAX 即可。<br>     6. int flags，跳转的方式，有 4 个 flags，如下：<br>       1. AVSEEK_FLAG_BYTE，按字节大小进行跳转。<br>       2. AVSEEK_FLAG_FRAME，按帧数大小进行跳转。<br>       3. AVSEEK_FLAG_ANY，可以跳转到非关键帧的读取位置，但是解码会出现马赛克。<br>       4. AVSEEK_FLAG_BACKWARD，往 ts 的后面找关键帧，默认是往 ts 的前面找关键帧。<br>   通过代码可知avformat_seek_file函数最终还是调用av_seek_frame函数来实现跳转操作的。<br>   <strong>avformat_seek_file调用流程如下：</strong></p> 
<p><img src="https://images2.imgbox.com/d4/41/Xec9FdgA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="46av_seek_frame_4567"></a>4.6、av_seek_frame</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">av_seek_frame</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> stream_index<span class="token punctuation">,</span>
                  <span class="token keyword">int64_t</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_seek2 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_seek<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int64_t</span> min_ts <span class="token operator">=</span> INT64_MIN<span class="token punctuation">,</span> max_ts <span class="token operator">=</span> INT64_MAX<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AVSEEK_FLAG_BACKWARD<span class="token punctuation">)</span><span class="token punctuation">)</span>
            max_ts <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            min_ts <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">avformat_seek_file</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> min_ts<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> max_ts<span class="token punctuation">,</span>
                                  flags <span class="token operator">&amp;</span> <span class="token operator">~</span>AVSEEK_FLAG_BACKWARD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">seek_frame_internal</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token function">avformat_queue_attached_pictures</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  av_seek_frame函数首先判断是否存在iformat-&gt;read_seek2，如果存在就调用对应read_seek2()，如果不存在则调用seek_frame_internal()去执行seek操作：</p> 
<h4><a id="461seek_frame_internal_4594"></a>4.6.1、seek_frame_internal</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">seek_frame_internal</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> stream_index<span class="token punctuation">,</span>
                               <span class="token keyword">int64_t</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVStream <span class="token operator">*</span>st<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">/* 以字节数方式寻帧 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AVSEEK_FLAG_BYTE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NO_BYTE_SEEK<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">ff_read_frame_flush</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">seek_frame_byte</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stream_index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        stream_index <span class="token operator">=</span> <span class="token function">av_find_default_stream_index</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream_index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        st <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">/* timestamp for default must be expressed in AV_TIME_BASE units */</span>
        timestamp <span class="token operator">=</span> <span class="token function">av_rescale</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                               AV_TIME_BASE <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int64_t</span><span class="token punctuation">)</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* first, we try the format specific seek */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_seek<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ff_read_frame_flush</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span><span class="token function">read_seek</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_timestamp <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOBINSEARCH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* 以二分查找方式寻帧 */</span>
        <span class="token function">ff_read_frame_flush</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ff_seek_frame_binary</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOGENSEARCH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* 以通用方式寻帧 */</span>
        <span class="token function">ff_read_frame_flush</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">seek_frame_generic</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream_index<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  由此可见，该函数按照顺序有4个执行步骤：<br>     1. 以字节数方式寻帧；<br>     2. 以指定方式read_seek寻帧；<br>     3. 以二分查找方式寻帧；<br>     4. 以通用方式寻帧；</p> 
<h4><a id="462seek_frame_byte_4649"></a>4.6.2、seek_frame_byte</h4> 
<p>  我们看看byte方式的seek操作，直接调用avio_seek移动到指定位置：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">seek_frame_byte</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> stream_index<span class="token punctuation">,</span>
                           <span class="token keyword">int64_t</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FFFormatContext <span class="token operator">*</span><span class="token keyword">const</span> si <span class="token operator">=</span> <span class="token function">ffformatcontext</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> pos_min<span class="token punctuation">,</span> pos_max<span class="token punctuation">;</span>

    pos_min <span class="token operator">=</span> si<span class="token operator">-&gt;</span>data_offset<span class="token punctuation">;</span>
    pos_max <span class="token operator">=</span> <span class="token function">avio_size</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> pos_min<span class="token punctuation">)</span>
        pos <span class="token operator">=</span> pos_min<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&gt;</span> pos_max<span class="token punctuation">)</span>
        pos <span class="token operator">=</span> pos_max<span class="token punctuation">;</span>

    <span class="token function">avio_seek</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    s<span class="token operator">-&gt;</span>io_repositioned <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="47avformat_close_input_4674"></a>4.7、avformat_close_input</h3> 
<p>  该函数用于关闭一个AVFormatContext，一般情况下是和avformat_open_input()成对使用的。avformat_close_input()的声明位于libavformat\avformat.h，如下所示。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">avformat_close_input</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span><span class="token operator">*</span>ps<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">;</span>
    AVIOContext <span class="token operator">*</span>pb<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ps <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">*</span>ps<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    s  <span class="token operator">=</span> <span class="token operator">*</span>ps<span class="token punctuation">;</span>
    pb <span class="token operator">=</span> s<span class="token operator">-&gt;</span>pb<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"image2"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOFILE<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_CUSTOM_IO<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_close<span class="token punctuation">)</span>
            s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span><span class="token function">read_close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>ps <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">avio_close</span><span class="token punctuation">(</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <strong>函数调用关系图</strong><br> <img src="https://images2.imgbox.com/ee/d7/Lm7VdOJH_o.png" alt="在这里插入图片描述"><br>   从源代码中可以看出，avformat_close_input()主要做了以下几步工作：<br>     1. 调用AVInputFormat的read_close()方法关闭输入流。<br>     2. 调用avformat_free_context()释放AVFormatContext。<br>     3. 调用avio_close()关闭并且释放AVIOContext。</p> 
<p>  AVInputFormat-&gt; read_close()<br>     1. AVInputFormat的read_close()是一个函数指针，指向关闭输入流的函数。<br>     2. 不同的AVInputFormat包含有不同的read_close()方法。<br>     3. 例如，FLV格式对应的AVInputFormat的定义如下。</p> 
<h2><a id="_4715"></a>五、实例</h2> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span></span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 打开文件</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ifilename <span class="token operator">=</span> <span class="token string">"believe.flv"</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"in_filename = %s\n"</span><span class="token punctuation">,</span> ifilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// AVFormatContext是描述一个媒体文件或媒体流的构成和基本信息的结构体</span>
    AVFormatContext <span class="token operator">*</span>ifmt_ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>           <span class="token comment">// 输入文件的demux</span>
    <span class="token comment">// 打开文件，主要是探测协议类型，如果是网络文件则创建网络链接</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ifmt_ctx<span class="token punctuation">,</span> ifilename<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">av_strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open %s failed: %s\n"</span><span class="token punctuation">,</span> ifilename<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 2. 读取码流信息</span>
    ret <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>ifmt_ctx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//如果打开媒体文件失败，打印失败原因</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">av_strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"avformat_find_stream_info %s failed:%s\n"</span><span class="token punctuation">,</span> ifilename<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ifmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 3.打印总体信息</span>
    <span class="token function">printf_s</span><span class="token punctuation">(</span><span class="token string">"\n==== av_dump_format in_filename:%s ===\n"</span><span class="token punctuation">,</span> ifilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_dump_format</span><span class="token punctuation">(</span>ifmt_ctx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ifilename<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf_s</span><span class="token punctuation">(</span><span class="token string">"\n==== av_dump_format finish =======\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"media name:%s\n"</span><span class="token punctuation">,</span> ifmt_ctx<span class="token operator">-&gt;</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stream number:%d\n"</span><span class="token punctuation">,</span> ifmt_ctx<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  nb_streams媒体流数量</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"media average ratio:%lldkbps\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int64_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ifmt_ctx<span class="token operator">-&gt;</span>bit_rate<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  媒体文件的码率,单位为bps</span>
    <span class="token comment">// duration: 媒体文件时长，单位微妙</span>
    <span class="token keyword">int</span> total_seconds <span class="token operator">=</span> <span class="token punctuation">(</span>ifmt_ctx<span class="token operator">-&gt;</span>duration<span class="token punctuation">)</span> <span class="token operator">/</span> AV_TIME_BASE<span class="token punctuation">;</span>  <span class="token comment">// 1000us = 1ms, 1000ms = 1秒</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio duration: %02d:%02d:%02d\n"</span><span class="token punctuation">,</span>
           total_seconds <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>total_seconds <span class="token operator">%</span> <span class="token number">3600</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>total_seconds <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 4.读取码流信息</span>
    <span class="token comment">// 音频</span>
    <span class="token keyword">int</span> audioindex <span class="token operator">=</span> <span class="token function">av_find_best_stream</span><span class="token punctuation">(</span>ifmt_ctx<span class="token punctuation">,</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>audioindex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"av_find_best_stream %s eror."</span><span class="token punctuation">,</span> <span class="token function">av_get_media_type_string</span><span class="token punctuation">(</span>AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    AVStream <span class="token operator">*</span>audio_stream <span class="token operator">=</span> ifmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>audioindex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"----- Audio info:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: %d\n"</span><span class="token punctuation">,</span> audio_stream<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 序列号</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"samplarate: %d Hz\n"</span><span class="token punctuation">,</span> audio_stream<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 采样率</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sampleformat: %d\n"</span><span class="token punctuation">,</span> audio_stream<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 采样格式 AV_SAMPLE_FMT_FLTP:8</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio codec: %d\n"</span><span class="token punctuation">,</span> audio_stream<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 编码格式 AV_CODEC_ID_MP3:86017 AV_CODEC_ID_AAC:86018</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>audio_stream<span class="token operator">-&gt;</span>duration <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> audio_duration <span class="token operator">=</span> audio_stream<span class="token operator">-&gt;</span>duration <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>audio_stream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio duration: %02d:%02d:%02d\n"</span><span class="token punctuation">,</span>
               audio_duration <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>audio_duration <span class="token operator">%</span> <span class="token number">3600</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>audio_duration <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 视频</span>
    <span class="token keyword">int</span> videoindex <span class="token operator">=</span> <span class="token function">av_find_best_stream</span><span class="token punctuation">(</span>ifmt_ctx<span class="token punctuation">,</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoindex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"av_find_best_stream %s eror."</span><span class="token punctuation">,</span> <span class="token function">av_get_media_type_string</span><span class="token punctuation">(</span>AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    AVStream <span class="token operator">*</span>video_stream <span class="token operator">=</span> ifmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>videoindex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"----- Video info:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: %d\n"</span><span class="token punctuation">,</span> video_stream<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 序列号</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fps: %lf\n"</span><span class="token punctuation">,</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>video_stream<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 帧率</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"width: %d, height:%d \n"</span><span class="token punctuation">,</span> video_stream<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> video_stream<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"video codec: %d\n"</span><span class="token punctuation">,</span> video_stream<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 编码格式 AV_CODEC_ID_H264: 27</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>video_stream<span class="token operator">-&gt;</span>duration <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> video_duration <span class="token operator">=</span> video_stream<span class="token operator">-&gt;</span>duration <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>video_stream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio duration: %02d:%02d:%02d\n"</span><span class="token punctuation">,</span>
               video_duration <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>video_duration <span class="token operator">%</span> <span class="token number">3600</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>video_duration <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 5.提取码流</span>
    AVPacket <span class="token operator">*</span>pkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pkt_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> print_max_count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n-----av_read_frame start\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">av_read_frame</span><span class="token punctuation">(</span>ifmt_ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"av_read_frame end\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">if</span><span class="token punctuation">(</span>pkt_count<span class="token operator">++</span> <span class="token operator">&lt;</span> print_max_count<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">==</span> audioindex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio pts: %lld\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio dts: %lld\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio size: %d\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio pos: %lld\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio duration: %lf\n\n"</span><span class="token punctuation">,</span>
                       pkt<span class="token operator">-&gt;</span>duration <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>ifmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>audioindex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">==</span> videoindex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"video pts: %lld\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"video dts: %lld\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"video size: %d\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"video pos: %lld\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"video duration: %lf\n\n"</span><span class="token punctuation">,</span>
                       pkt<span class="token operator">-&gt;</span>duration <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>ifmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>videoindex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"unknown stream_index:\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 6.结束</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span>
        <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ifmt_ctx<span class="token punctuation">)</span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ifmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//加上这一句，防止程序打印完信息马上退出</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <strong>输出：</strong></p> 
<pre><code class="prism language-cpp">in_filename <span class="token operator">=</span> believe<span class="token punctuation">.</span>flv
 
<span class="token operator">==</span><span class="token operator">==</span> av_dump_format in_filename<span class="token operator">:</span>believe<span class="token punctuation">.</span>flv <span class="token operator">==</span><span class="token operator">=</span>
Input #<span class="token number">0</span><span class="token punctuation">,</span> flv<span class="token punctuation">,</span> from <span class="token char">'believe.flv'</span><span class="token operator">:</span>
  Metadata<span class="token operator">:</span>
    major_brand     <span class="token operator">:</span> isom
    minor_version   <span class="token operator">:</span> <span class="token number">512</span>
    compatible_brands<span class="token operator">:</span> isomiso2avc1mp41
    comment         <span class="token operator">:</span> www<span class="token punctuation">.</span>ieway<span class="token punctuation">.</span>cn
    encoder         <span class="token operator">:</span> Lavf58<span class="token punctuation">.</span><span class="token number">29.100</span>
  Duration<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">42.53</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">0.000000</span><span class="token punctuation">,</span> bitrate<span class="token operator">:</span> <span class="token number">286</span> kb<span class="token operator">/</span>s
    Stream #<span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span> Video<span class="token operator">:</span> <span class="token function">h264</span> <span class="token punctuation">(</span>Constrained Baseline<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">yuv420p</span><span class="token punctuation">(</span>progressive<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1920</span>x1080<span class="token punctuation">,</span> <span class="token number">150</span> kb<span class="token operator">/</span>s<span class="token punctuation">,</span> <span class="token number">14.46</span> fps<span class="token punctuation">,</span> <span class="token number">15</span> tbr<span class="token punctuation">,</span> <span class="token number">1</span>k tbn<span class="token punctuation">,</span> <span class="token number">30</span> tbc
    Stream #<span class="token number">0</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span> Audio<span class="token operator">:</span> <span class="token function">aac</span> <span class="token punctuation">(</span>LC<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">48000</span> Hz<span class="token punctuation">,</span> stereo<span class="token punctuation">,</span> fltp<span class="token punctuation">,</span> <span class="token number">128</span> kb<span class="token operator">/</span>s
 
<span class="token operator">==</span><span class="token operator">==</span> av_dump_format finish <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
 
media name<span class="token operator">:</span>believe<span class="token punctuation">.</span>flv
stream number<span class="token operator">:</span><span class="token number">2</span>
media average ratio<span class="token operator">:</span><span class="token number">279</span>kbps
audio duration<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">42</span>
 
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> Audio info<span class="token operator">:</span>
index<span class="token operator">:</span> <span class="token number">1</span>
samplarate<span class="token operator">:</span> <span class="token number">48000</span> Hz
sampleformat<span class="token operator">:</span> <span class="token number">8</span>
audio codec<span class="token operator">:</span> <span class="token number">86018</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> Video info<span class="token operator">:</span>
index<span class="token operator">:</span> <span class="token number">0</span>
fps<span class="token operator">:</span> <span class="token number">14.464286</span>
width<span class="token operator">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> height<span class="token operator">:</span><span class="token number">1080</span>
video codec<span class="token operator">:</span> <span class="token number">27</span>
 
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>av_read_frame start
audio pts<span class="token operator">:</span> <span class="token number">0</span>
audio dts<span class="token operator">:</span> <span class="token number">0</span>
audio size<span class="token operator">:</span> <span class="token number">341</span>
audio pos<span class="token operator">:</span> <span class="token number">502</span>
audio duration<span class="token operator">:</span> <span class="token number">0.021000</span>
 
video pts<span class="token operator">:</span> <span class="token number">14</span>
video dts<span class="token operator">:</span> <span class="token number">14</span>
video size<span class="token operator">:</span> <span class="token number">66736</span>
video pos<span class="token operator">:</span> <span class="token number">860</span>
video duration<span class="token operator">:</span> <span class="token number">0.066000</span>
 
audio pts<span class="token operator">:</span> <span class="token number">21</span>
audio dts<span class="token operator">:</span> <span class="token number">21</span>
audio size<span class="token operator">:</span> <span class="token number">341</span>
audio pos<span class="token operator">:</span> <span class="token number">67616</span>
audio duration<span class="token operator">:</span> <span class="token number">0.021000</span>
 
audio pts<span class="token operator">:</span> <span class="token number">43</span>
audio dts<span class="token operator">:</span> <span class="token number">43</span>
audio size<span class="token operator">:</span> <span class="token number">342</span>
audio pos<span class="token operator">:</span> <span class="token number">67974</span>
audio duration<span class="token operator">:</span> <span class="token number">0.021000</span>
 
audio pts<span class="token operator">:</span> <span class="token number">64</span>
audio dts<span class="token operator">:</span> <span class="token number">64</span>
audio size<span class="token operator">:</span> <span class="token number">341</span>
audio pos<span class="token operator">:</span> <span class="token number">68333</span>
audio duration<span class="token operator">:</span> <span class="token number">0.021000</span>
 
video pts<span class="token operator">:</span> <span class="token number">81</span>
video dts<span class="token operator">:</span> <span class="token number">81</span>
video size<span class="token operator">:</span> <span class="token number">580</span>
video pos<span class="token operator">:</span> <span class="token number">68691</span>
video duration<span class="token operator">:</span> <span class="token number">0.066000</span>
 
audio pts<span class="token operator">:</span> <span class="token number">85</span>
audio dts<span class="token operator">:</span> <span class="token number">85</span>
audio size<span class="token operator">:</span> <span class="token number">341</span>
audio pos<span class="token operator">:</span> <span class="token number">69291</span>
audio duration<span class="token operator">:</span> <span class="token number">0.021000</span>
 
audio pts<span class="token operator">:</span> <span class="token number">107</span>
audio dts<span class="token operator">:</span> <span class="token number">107</span>
audio size<span class="token operator">:</span> <span class="token number">342</span>
audio pos<span class="token operator">:</span> <span class="token number">69649</span>
audio duration<span class="token operator">:</span> <span class="token number">0.021000</span>
 
audio pts<span class="token operator">:</span> <span class="token number">128</span>
audio dts<span class="token operator">:</span> <span class="token number">128</span>
audio size<span class="token operator">:</span> <span class="token number">341</span>
audio pos<span class="token operator">:</span> <span class="token number">70008</span>
audio duration<span class="token operator">:</span> <span class="token number">0.021000</span>
 
video pts<span class="token operator">:</span> <span class="token number">147</span>
video dts<span class="token operator">:</span> <span class="token number">147</span>
video size<span class="token operator">:</span> <span class="token number">11289</span>
video pos<span class="token operator">:</span> <span class="token number">70366</span>
video duration<span class="token operator">:</span> <span class="token number">0.066000</span>
 
av_read_frame end
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/78391a8941bca3af83cb6f111b166e27/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PHY驱动调试之 --- MDIO/MDC接口22号和45号条款(一)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c7b3a70226c984f0431e40c78791e03f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">openssl3.2 - 官方demo学习 - mac - siphash.c</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>