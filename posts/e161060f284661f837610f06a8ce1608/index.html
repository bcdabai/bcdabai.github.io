<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于kafka(3.0版本之前)的日志收集 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于kafka(3.0版本之前)的日志收集" />
<meta property="og:description" content="基于kafka(3.0版本之前)的日志收集项目 什么是kafka 简介：
Kafka是由Apache软件基金会开发的一个开源流处理平台，由Scala和Java编写。Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者在网站中的所有动作流数据。 这种动作（网页浏览，搜索和其他用户的行动）是在现代网络上的许多社会功能的一个关键因素。 这些数据通常是由于吞吐量的要求而通过处理日志和日志聚合来解决。 对于像Hadoop一样的日志数据和离线分析系统，但又要求实时处理的限制，这是一个可行的解决方案。Kafka的目的是通过Hadoop的并行加载机制来统一线上和离线的消息处理，也是为了通过集群来提供实时的消息。
特性：
1、Kafka是一种高吞吐量的分布式发布订阅消息系统
2、通过O(1)的磁盘数据结构提供消息的持久化，这种结构对于即使数以TB的消息存储也能够保持长时间的稳定性能。
3、高吞吐量 ：即使是非常普通的硬件Kafka也可以支持每秒数百万的消息。
4、支持通过Kafka服务器和消费机集群来分区消息。
5、支持Hadoop并行数据加载。
原理图：
一、kafka搭建流程 1、环境准备 准备四台虚拟机（实验所用，所以将nginx就搭建在kafka服务器上，其中三台搭建kafka集群和nginx集群，一台搭建mysql）
主机IP地址nginx-kafka-1192.168.220.11nginx-kafka-2192.168.220.105nginx-kafka-3192.168.220.106mysql192.168.220.107 配置好dns
[root@nginx-kafka01 ~]# cat /etc/resolv.conf # Generated by NetworkManager nameserver 114.114.114.114 修改主机名，并且在每一台机器上都写好域名解析
# 修改主机名 vim /etc/hosthname hostname -F /etc/hostname # 每一台机器上都写好域名解析 vim /etc/hosts 192.168.220.11 nginx-kafka01 192.168.220.105 nginx-kafka02 192.168.220.109 nginx-kafka03 同步时间，并且关闭防火墙和selinux（每台机都要操作）
[root@nginx-kafka01 ~]# yum -y install chrony # 设置开机自启 disable 关闭开机自启 [root@nginx-kafka01 ~]# systemctl enable chronyd [root@nginx-kafka01 ~]# systemctl start chronyd # 设置时区 [root@nginx-kafka01 ~]# cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime # 永久关闭firewalld [root@nginx-kafka01 ~]# systemctl stop firewalld [root@nginx-kafka01 ~]# systemctl disable firewalld # 永久关闭selinux [root@nginx-kafka01 ~]# vim /etc/selinux/config 使SELINUX=disabled 2、nginx的安装（之前有安装搭建的博客） 3、kafka的安装 1、下载java环境，kafka是由java写的，需要java环境" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e161060f284661f837610f06a8ce1608/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-04T09:57:55+08:00" />
<meta property="article:modified_time" content="2023-08-04T09:57:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于kafka(3.0版本之前)的日志收集</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="kafka30_1"></a>基于kafka(3.0版本之前)的日志收集项目</h2> 
<h3><a id="kafka_3"></a>什么是kafka</h3> 
<p>简介：</p> 
<p>Kafka是由Apache软件基金会开发的一个开源流处理平台，由Scala和Java编写。Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者在网站中的所有动作流数据。 这种动作（网页浏览，搜索和其他用户的行动）是在现代网络上的许多社会功能的一个关键因素。 这些数据通常是由于吞吐量的要求而通过处理日志和日志聚合来解决。 对于像Hadoop一样的日志数据和离线分析系统，但又要求实时处理的限制，这是一个可行的解决方案。Kafka的目的是通过Hadoop的并行加载机制来统一线上和离线的消息处理，也是为了通过集群来提供实时的消息。</p> 
<p>特性：</p> 
<p>1、Kafka是一种高吞吐量的分布式发布订阅消息系统<br> 2、通过O(1)的磁盘数据结构提供消息的持久化，这种结构对于即使数以TB的消息存储也能够保持长时间的稳定性能。<br> 3、高吞吐量 ：即使是非常普通的硬件Kafka也可以支持每秒数百万的消息。<br> 4、支持通过Kafka服务器和消费机集群来分区消息。<br> 5、支持Hadoop并行数据加载。</p> 
<p>原理图：</p> 
<p><img src="https://images2.imgbox.com/d9/31/ZoQKIhNv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="kafka_20"></a>一、kafka搭建流程</h3> 
<h4><a id="1_22"></a>1、环境准备</h4> 
<p>准备四台虚拟机（实验所用，所以将nginx就搭建在kafka服务器上，其中三台搭建kafka集群和nginx集群，一台搭建mysql）</p> 
<table><thead><tr><th align="center">主机</th><th align="center">IP地址</th></tr></thead><tbody><tr><td align="center">nginx-kafka-1</td><td align="center">192.168.220.11</td></tr><tr><td align="center">nginx-kafka-2</td><td align="center">192.168.220.105</td></tr><tr><td align="center">nginx-kafka-3</td><td align="center">192.168.220.106</td></tr><tr><td align="center">mysql</td><td align="center">192.168.220.107</td></tr></tbody></table> 
<p>配置好dns</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/resolv.conf</span>
<span class="token comment"># Generated by NetworkManager</span>
nameserver <span class="token number">114.114</span>.114.114
</code></pre> 
<p>修改主机名，并且在每一台机器上都写好域名解析</p> 
<pre><code class="prism language-bash"><span class="token comment"># 修改主机名</span>
<span class="token function">vim</span>  /etc/hosthname
<span class="token function">hostname</span> <span class="token parameter variable">-F</span> /etc/hostname

<span class="token comment"># 每一台机器上都写好域名解析</span>
<span class="token function">vim</span>  /etc/hosts
<span class="token number">192.168</span>.220.11  nginx-kafka01
<span class="token number">192.168</span>.220.105  nginx-kafka02
<span class="token number">192.168</span>.220.109  nginx-kafka03
</code></pre> 
<p>同步时间，并且关闭防火墙和selinux（每台机都要操作）</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install chrony</span>
<span class="token comment"># 设置开机自启  disable 关闭开机自启</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable chronyd</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start chronyd</span>
<span class="token comment"># 设置时区</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span>

<span class="token comment"># 永久关闭firewalld</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl disable firewalld</span>

<span class="token comment"># 永久关闭selinux</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/selinux/config</span>
使SELINUX<span class="token operator">=</span>disabled
</code></pre> 
<h4><a id="2nginx_74"></a>2、nginx的安装（之前有安装搭建的博客）</h4> 
<h4><a id="3kafka_76"></a>3、kafka的安装</h4> 
<p>1、下载java环境，kafka是由java写的，需要java环境</p> 
<pre><code class="prism language-bash"><span class="token comment"># 下载安装Java环境</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># yum install java wget  -y</span>
</code></pre> 
<p>2、安装kafka的包，并且解压</p> 
<pre><code class="prism language-bash"><span class="token comment"># 安装kafka的包</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># yum install wget -y </span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirrors.bfsu.edu.cn/apache/kafka/2.8.1/kafka_2.12-2.8.1.tgz</span>

<span class="token comment"># 解压kafka的包</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># tar  xf  kafka_2.12-2.8.1.tgz</span>
<span class="token comment"># 创建/opt/kafka文件夹，将安装包都放在其下</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/kafka/</span>
<span class="token punctuation">[</span>root@nginx-kafka01 kafka<span class="token punctuation">]</span><span class="token comment"># ls</span>
kafka_2.12-2.8.1  kafka_2.12-2.8.1.tgz
</code></pre> 
<p>3、配置kafka</p> 
<pre><code class="prism language-bash"><span class="token comment"># 修改kafka_2.12-2.8.1/config/server.properties文件</span>
<span class="token comment"># kafka集群中每个服务器的broker.id不相同，我设置的nginx-kafka01主机为1，nginx-kafka02主机为2，nginx-kafka03主机为3</span>
<span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://nginx-kafka01:9092
<span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span><span class="token number">192.168</span>.220.11:2181,192.168.220.105:2181,192.168.220.106:2181
</code></pre> 
<h4><a id="4zookeeper_110"></a>4、zookeeper的安装</h4> 
<p>下载安装地址：<a href="https://archive.apache.org/dist/zookeeper/zookeeper-3.6.3/apache-zookeeper-3.6.3-bin.tar.gz" rel="nofollow">https://archive.apache.org/dist/zookeeper/zookeeper-3.6.3/apache-zookeeper-3.6.3-bin.tar.gz</a></p> 
<p>解压压缩包并修改配置文件</p> 
<pre><code class="prism language-bash"><span class="token comment"># 进入/opt/zookeeper/apache-zookeeper-3.6.3-bin/conf</span>
<span class="token comment"># 复制配置文件</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># cp zoo_sample.cfg zoo.cfg</span>
<span class="token comment"># 修改zoo.cfg, 添加如下三行：</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># vim zoo.cfg</span>
<span class="token assign-left variable">server.1</span><span class="token operator">=</span><span class="token number">192.168</span>.220.11:3888:4888
<span class="token assign-left variable">server.2</span><span class="token operator">=</span><span class="token number">192.168</span>.220.105:3888:4888
<span class="token assign-left variable">server.3</span><span class="token operator">=</span><span class="token number">192.168</span>.220.106:3888:4888

<span class="token comment"># 3888和4888都是端口  一个用于数据传输，一个用于检验存活性和选举</span>
</code></pre> 
<p>创建/tmp/zookeeper目录 ，在目录中添加myid文件，文件内容就是本机指定的zookeeper id内容</p> 
<pre><code class="prism language-bash"><span class="token comment"># 如：在192.168.220.11机器上</span>
<span class="token comment"># server是几myid就是几</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> /tmp/zookeeper/myid
</code></pre> 
<h4><a id="5zookeeperkafka_137"></a>5、启动zookeeper和kafka</h4> 
<p>注意：开启zk和kafka的时候，一定是先启动zk，再启动kafka<br> 关闭服务的时候，kafka先关闭，再关闭zk</p> 
<p>启动zookeeper</p> 
<pre><code class="prism language-bash"><span class="token comment"># 启动zookeeper</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># /opt/zookeeper/apache-zookeeper-3.6.3-bin/bin/zkServer.sh start</span>
/usr/bin/java
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/apache-zookeeper-3.6.3-bin/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Starting zookeeper <span class="token punctuation">..</span>. STARTED

<span class="token comment"># 查看zookeeper的状态</span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># /opt/zookeeper/apache-zookeeper-3.6.3-bin/bin/zkServer.sh status</span>
/bin/java
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/apache-zookeeper-3.6.3-bin/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: leader
<span class="token comment"># 其中只有一个leader，其余都为follower</span>
</code></pre> 
<p>启动kafka</p> 
<pre><code class="prism language-bash"><span class="token comment"># 启动kafka</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># /opt/kafka/kafka_2.12-2.8.1/bin/kafka-server-start.sh -daemon /opt/kafka/kafka_2.12-2.8.1/config/server.properties</span>

<span class="token comment"># 进入zookeeper查看kafka的是否搭建成功</span>
<span class="token punctuation">[</span>root@nginx-kafka01 ~<span class="token punctuation">]</span><span class="token comment"># /opt/zookeeper/apache-zookeeper-3.6.3-bin/bin/zkCli.sh</span>

<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token function">ls</span> /
<span class="token punctuation">[</span>admin, brokers, cluster, config, consumers, controller, controller_epoch, feature, isr_change_notification, latest_producer_id_block, log_dir_event_notification, sc, zookeeper<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token function">ls</span> /brokers 
<span class="token punctuation">[</span>ids, seqid, topics<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token function">ls</span> /brokers/ids 
<span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token comment"># 如果ids为[1, 2, 3]则代表kafka搭建启动成功</span>
</code></pre> 
<h3><a id="_180"></a>二、生产者消费者测试</h3> 
<p>首先创建一个分区为3，副本为3，名字叫zhang的标题，（通过broker2：192.168.220.105创建）</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka02 ~<span class="token punctuation">]</span><span class="token comment"># /opt/kafka/kafka_2.12-2.8.1/bin/kafka-topics.sh --create --zookeeper 192.168.220.105:2181 --replication-factor 3 --partitions 3 --topic zhang</span>
</code></pre> 
<h4><a id="_188"></a>生产者测试</h4> 
<p>broker2：192.168.220.105充当生产者，指定标题为zhang</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka02 ~<span class="token punctuation">]</span><span class="token comment"># /opt/kafka/kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list 192.168.220.105:9092 --topic zhang</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/63/60/qpQ8KCOC_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_198"></a>消费者测试</h4> 
<p>broker3：192.168.220.106充当消费者，指定标题为zhang，且从头开始消费</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># /opt/kafka/kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server 192.168.220.106:9092 --topic zhang --from-beginning</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/78/13/UzeWs8bj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="filebeat_207"></a>三、filebeat抓取日志</h3> 
<h4><a id="1filebeatnginx_209"></a>1、filebeat的安装（在装有nginx服务器上安装）</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 导入rpm包</span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span>

<span class="token comment"># 编辑vim /etc/yum.repos.d/fb.repo</span>
<span class="token punctuation">[</span>elastic-7.x<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>Elastic repository <span class="token keyword">for</span> <span class="token number">7</span>.x packages
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://artifacts.elastic.co/packages/7.x/yum
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://artifacts.elastic.co/GPG-KEY-elasticsearch
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">autorefresh</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">type</span><span class="token operator">=</span>rpm-md

<span class="token comment"># 采用yum安装</span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># yum install filebeat -y</span>

<span class="token comment"># 查看</span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># rpm -qa | grep filebeat  # 可以查看filebeat有没有安装  rpm -qa 是查看机器上安装的所有软件包</span>
filebeat-7.17.10-1.x86_64
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># rpm -ql filebeat		# 查看filebeat安装到哪里去了，牵扯的文件有哪些</span>
</code></pre> 
<h4><a id="2filebeat_234"></a>2、启动filebeat并设置开机自启</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 启动filebeat</span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start filebeat</span>
<span class="token comment"># 设置开机自启</span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable filebeat</span>

<span class="token comment"># 查看filebeat状态</span>
<span class="token comment"># 查看进程</span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># ps aux | grep filebeat</span>
root        <span class="token number">918</span>  <span class="token number">0.0</span>  <span class="token number">2.4</span> <span class="token number">1072904</span> <span class="token number">45428</span> ?       Ssl  <span class="token number">10</span>:25   <span class="token number">0</span>:08 /usr/share/filebeat/bin/filebeat <span class="token parameter variable">--environment</span> systemd <span class="token parameter variable">-c</span> /etc/filebeat/filebeat.yml <span class="token parameter variable">--path.home</span> /usr/share/filebeat <span class="token parameter variable">--path.config</span> /etc/filebeat <span class="token parameter variable">--path.data</span> /var/lib/filebeat <span class="token parameter variable">--path.logs</span> /var/log/filebeat
root     <span class="token number">108199</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span> <span class="token number">112832</span>   <span class="token number">988</span> pts/1    S+   <span class="token number">20</span>:52   <span class="token number">0</span>:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto filebeat
<span class="token comment"># 通过systemctl查看状态</span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status filebeat</span>
● filebeat.service - Filebeat sends log files to Logstash or directly to Elasticsearch.
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/filebeat.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since 二 <span class="token number">2023</span>-06-20 <span class="token number">10</span>:25:08 CST<span class="token punctuation">;</span> 10h ago
     Docs: https://www.elastic.co/beats/filebeat
 Main PID: <span class="token number">918</span> <span class="token punctuation">(</span>filebeat<span class="token punctuation">)</span>
    Tasks: <span class="token number">6</span>
   Memory: <span class="token number">45</span>.8M
   CGroup: /system.slice/filebeat.service
           └─918 /usr/share/filebeat/bin/filebeat <span class="token parameter variable">--environment</span> systemd <span class="token parameter variable">-c</span> /etc/filebeat/filebeat.yml <span class="token parameter variable">--path.home</span> /usr/share/filebeat <span class="token parameter variable">--path.config</span> /etc/filebeat <span class="token parameter variable">--path.data</span> /var/lib/f<span class="token punctuation">..</span>.

<span class="token number">6</span>月 <span class="token number">20</span> <span class="token number">20</span>:49:11 nginx-kafka03 filebeat<span class="token punctuation">[</span><span class="token number">918</span><span class="token punctuation">]</span>: <span class="token number">2023</span>-06-20T20:49:11.376+0800        INFO        <span class="token punctuation">[</span>monitoring<span class="token punctuation">]</span>        log/log.go:184        Non-zero metrics <span class="token keyword">in</span> the last 30s        <span class="token punctuation">{<!-- --></span><span class="token string">"monito...
6月 20 20:49:41 nginx-kafka03 filebeat[918]: 2023-06-20T20:49:41.377+0800        INFO        [monitoring]        log/log.go:184        Non-zero metrics in the last 30s        {"</span>monito<span class="token punctuation">..</span>.
<span class="token number">6</span>月 <span class="token number">20</span> <span class="token number">20</span>:50:11 nginx-kafka03 filebeat<span class="token punctuation">[</span><span class="token number">918</span><span class="token punctuation">]</span>: <span class="token number">2023</span>-06-20T20:50:11.385+0800        INFO        <span class="token punctuation">[</span>monitoring<span class="token punctuation">]</span>        log/log.go:184        Non-zero metrics <span class="token keyword">in</span> the last 30s        <span class="token punctuation">{<!-- --></span><span class="token string">"monito...
6月 20 20:50:41 nginx-kafka03 filebeat[918]: 2023-06-20T20:50:41.376+0800        INFO        [monitoring]        log/log.go:184        Non-zero metrics in the last 30s        {"</span>monito<span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.
Hint: Some lines were ellipsized, use <span class="token parameter variable">-l</span> to show <span class="token keyword">in</span> full.
</code></pre> 
<h4><a id="3filebeat_268"></a>3、配置filebeat的配置文件</h4> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/filebeat/filebeat.yml </span>
filebeat.inputs:
- type: log
  <span class="token comment"># Change to true to enable this input configuration.</span>
  enabled: <span class="token boolean">true</span>
  <span class="token comment"># Paths that should be crawled and fetched. Glob based paths.</span>
  paths:
    - /usr/local/nginx/logs/access.log
  <span class="token comment">#==========------------------------------kafka-----------------------------------</span>
output.kafka:
  hosts: <span class="token punctuation">[</span><span class="token string">"192.168.220.11:9092"</span>,<span class="token string">"192.168.220.105:9092"</span>,<span class="token string">"192.168.220.106:9092"</span><span class="token punctuation">]</span>
  topic: nginxlog
  keep_alive: 10s
  
<span class="token comment"># filebeat充当生产者，去取nginx中的日志即（/usr/local/nginx/logs/access.log）文件，取到过后将其推送给kafka集群即（hosts指定的三个kafka服务器），指定标题为nginxlog，并且设置每10秒推送一次。</span>
</code></pre> 
<h4><a id="4_288"></a>4、测试</h4> 
<p>1、首先清空nginx的日志文件（清除工作）</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka03 ~<span class="token punctuation">]</span><span class="token comment"># &gt;/usr/local/nginx/logs/access.log</span>
</code></pre> 
<p>2、创建主题nginxlog</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka02 ~<span class="token punctuation">]</span><span class="token comment"># /opt/kafka/kafka_2.12-2.8.1/bin/kafka-topics.sh --create --zookeeper 192.168.220.105:2181 --replication-factor 3 --partitions 1 --topic nginxlog</span>
</code></pre> 
<p>3、创建消费者（消费的是filebeat生产者抓取的nginx的log）</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka02 ~<span class="token punctuation">]</span><span class="token comment"># /opt/kafka/kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server 192.168.220.106:9092 --topic nginxlog --from-beginning</span>
OpenJDK <span class="token number">64</span>-Bit Server VM warning: If the number of processors is expected to increase from one, <span class="token keyword">then</span> you should configure the number of parallel GC threads appropriately using <span class="token parameter variable">-XX:ParallelGCThreads</span><span class="token operator">=</span>N
<span class="token punctuation">{<!-- --></span><span class="token string">"@timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2023-06-19T04:24:13.415Z"</span>,<span class="token string">"@metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"beat"</span><span class="token builtin class-name">:</span><span class="token string">"filebeat"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"_doc"</span>,<span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"7.17.10"</span><span class="token punctuation">}</span>,<span class="token string">"log"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"offset"</span>:4444,<span class="token string">"file"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"path"</span><span class="token builtin class-name">:</span><span class="token string">"/usr/local/nginx/logs/access.log"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"message"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.220.1 - - [19/Jun/2023:12:24:06 +0800] <span class="token entity" title='\"'>\"</span>GET / HTTP/1.1<span class="token entity" title='\"'>\"</span> 200 625 <span class="token entity" title='\"'>\"</span>-<span class="token entity" title='\"'>\"</span> <span class="token entity" title='\"'>\"</span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36<span class="token entity" title='\"'>\"</span>"</span>,<span class="token string">"input"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"log"</span><span class="token punctuation">}</span>,<span class="token string">"ecs"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"1.12.0"</span><span class="token punctuation">}</span>,<span class="token string">"host"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span><span class="token punctuation">}</span>,<span class="token string">"agent"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token builtin class-name">:</span><span class="token string">"a8249178-4c1c-46a3-93a0-7e42f0e925fe"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"filebeat"</span>,<span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"7.17.10"</span>,<span class="token string">"hostname"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span>,<span class="token string">"ephemeral_id"</span><span class="token builtin class-name">:</span><span class="token string">"d862d589-9ce0-4bb7-b06f-14e5a8914f24"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"@timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2023-06-19T04:24:20.429Z"</span>,<span class="token string">"@metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"beat"</span><span class="token builtin class-name">:</span><span class="token string">"filebeat"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"_doc"</span>,<span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"7.17.10"</span><span class="token punctuation">}</span>,<span class="token string">"input"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"log"</span><span class="token punctuation">}</span>,<span class="token string">"host"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span><span class="token punctuation">}</span>,<span class="token string">"agent"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token builtin class-name">:</span><span class="token string">"a8249178-4c1c-46a3-93a0-7e42f0e925fe"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"filebeat"</span>,<span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"7.17.10"</span>,<span class="token string">"hostname"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span>,<span class="token string">"ephemeral_id"</span><span class="token builtin class-name">:</span><span class="token string">"d862d589-9ce0-4bb7-b06f-14e5a8914f24"</span><span class="token punctuation">}</span>,<span class="token string">"ecs"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"1.12.0"</span><span class="token punctuation">}</span>,<span class="token string">"log"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"offset"</span>:4634,<span class="token string">"file"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"path"</span><span class="token builtin class-name">:</span><span class="token string">"/usr/local/nginx/logs/access.log"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"message"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.220.1 - - [19/Jun/2023:12:24:16 +0800] <span class="token entity" title='\"'>\"</span>GET /favicon.ico HTTP/1.1<span class="token entity" title='\"'>\"</span> 404 555 <span class="token entity" title='\"'>\"</span>http://192.168.220.106/<span class="token entity" title='\"'>\"</span> <span class="token entity" title='\"'>\"</span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36<span class="token entity" title='\"'>\"</span>"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"@timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2023-06-19T04:25:25.447Z"</span>,<span class="token string">"@metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"beat"</span><span class="token builtin class-name">:</span><span class="token string">"filebeat"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"_doc"</span>,<span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"7.17.10"</span><span class="token punctuation">}</span>,<span class="token string">"log"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"offset"</span>:4857,<span class="token string">"file"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"path"</span><span class="token builtin class-name">:</span><span class="token string">"/usr/local/nginx/logs/access.log"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"message"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.220.1 - - [19/Jun/2023:12:25:17 +0800] <span class="token entity" title='\"'>\"</span>GET / HTTP/1.1<span class="token entity" title='\"'>\"</span> 304 0 <span class="token entity" title='\"'>\"</span>-<span class="token entity" title='\"'>\"</span> <span class="token entity" title='\"'>\"</span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36<span class="token entity" title='\"'>\"</span>"</span>,<span class="token string">"input"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"log"</span><span class="token punctuation">}</span>,<span class="token string">"ecs"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"1.12.0"</span><span class="token punctuation">}</span>,<span class="token string">"host"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span><span class="token punctuation">}</span>,<span class="token string">"agent"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token builtin class-name">:</span><span class="token string">"a8249178-4c1c-46a3-93a0-7e42f0e925fe"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"filebeat"</span>,<span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"7.17.10"</span>,<span class="token string">"hostname"</span><span class="token builtin class-name">:</span><span class="token string">"nginx-kafka03"</span>,<span class="token string">"ephemeral_id"</span><span class="token builtin class-name">:</span><span class="token string">"d862d589-9ce0-4bb7-b06f-14e5a8914f24"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_312"></a>四、实现数据入库</h3> 
<h4><a id="1mysql_314"></a>1、mysql的安装（之前有安装搭建的博客）</h4> 
<h4><a id="2mysqlkafka_316"></a>2、在mysql创建存放kafka日志的数据库和表</h4> 
<pre><code class="prism language-sql">root<span class="token variable">@kafka</span> <span class="token number">21</span>:<span class="token number">31</span>  mysql<span class="token operator">&gt;</span><span class="token keyword">create</span> <span class="token keyword">database</span> kafka
root<span class="token variable">@kafka</span> <span class="token number">21</span>:<span class="token number">31</span>  mysql<span class="token operator">&gt;</span><span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> kafka              <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token number">6</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
root<span class="token variable">@kafka</span> <span class="token number">21</span>:<span class="token number">31</span>  mysql<span class="token operator">&gt;</span><span class="token keyword">use</span> kafka
root<span class="token variable">@kafka</span> <span class="token number">21</span>:<span class="token number">32</span>  mysql<span class="token operator">&gt;</span><span class="token keyword">create</span> <span class="token keyword">table</span> nginxlog<span class="token punctuation">(</span>id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span> dt <span class="token keyword">datetime</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> prov_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isp_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">charset</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
root<span class="token variable">@kafka</span> <span class="token number">21</span>:<span class="token number">31</span>  mysql<span class="token operator">&gt;</span><span class="token keyword">use</span> kafka
<span class="token keyword">Database</span> changed
root<span class="token variable">@kafka</span> <span class="token number">21</span>:<span class="token number">33</span>  mysql<span class="token operator">&gt;</span><span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+</span>
<span class="token operator">|</span> Tables_in_kafka <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+</span>
<span class="token operator">|</span> nginxlog        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="3pythonkafka_344"></a>3、编写python脚本实现kafka数据入库</h4> 
<p>脚本要求获取好的nginx日志，提取出ip，时间，带宽字段。提取出的ip字段通过淘宝的一个接口解析出省份和运营商。并且格式化时间字段 “2021-10-12 12:00:00”。后存入数据库</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token keyword">import</span> pymysql

taobao_url <span class="token operator">=</span> <span class="token string">"https://ip.taobao.com/outGetIpInfo?accessKey=alibaba-inc&amp;ip="</span>


<span class="token comment"># 查询ip地址的信息（省份和运营商isp），通过taobao网的接口</span>
<span class="token keyword">def</span> <span class="token function">resolv_ip</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>taobao_url <span class="token operator">+</span> ip<span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        tmp_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        prov <span class="token operator">=</span> tmp_dict<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"region"</span><span class="token punctuation">]</span>
        isp <span class="token operator">=</span> tmp_dict<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"isp"</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> prov<span class="token punctuation">,</span> isp
    <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>


<span class="token comment"># 将日志里读取的格式转换为我们指定的格式</span>
<span class="token keyword">def</span> <span class="token function">trans_time</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 把字符串转成时间格式</span>
    timeArray <span class="token operator">=</span> time<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> <span class="token string">"%d/%b/%Y:%H:%M:%S"</span><span class="token punctuation">)</span>
    <span class="token comment"># timeStamp = int(time.mktime(timeArray))</span>
    <span class="token comment"># 把时间格式转成字符串</span>
    new_time <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">,</span> timeArray<span class="token punctuation">)</span>
    <span class="token keyword">return</span> new_time


<span class="token comment"># 从kafka里获取数据，清洗为我们需要的ip，时间，带宽</span>
<span class="token keyword">from</span> pykafka <span class="token keyword">import</span> KafkaClient

client <span class="token operator">=</span> KafkaClient<span class="token punctuation">(</span>hosts<span class="token operator">=</span><span class="token string">"192.168.220.11:9092,192.168.220.105:9092,192.168.220.106:9092"</span><span class="token punctuation">)</span>
topic <span class="token operator">=</span> client<span class="token punctuation">.</span>topics<span class="token punctuation">[</span><span class="token string">'nginxlog'</span><span class="token punctuation">]</span>
balanced_consumer <span class="token operator">=</span> topic<span class="token punctuation">.</span>get_balanced_consumer<span class="token punctuation">(</span>
    consumer_group<span class="token operator">=</span><span class="token string">'testgroup'</span><span class="token punctuation">,</span>
    <span class="token comment"># 自动提交offset</span>
    auto_commit_enable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    zookeeper_connect<span class="token operator">=</span><span class="token string">'nginx-kafka01:2181,nginx-kafka02:2181,nginx-kafka03:2181'</span>
<span class="token punctuation">)</span>
<span class="token comment"># consumer = topic.get_simple_consumer()</span>
<span class="token keyword">for</span> message <span class="token keyword">in</span> balanced_consumer<span class="token punctuation">:</span>
    <span class="token keyword">if</span> message <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            line <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">.</span>value<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            log <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span>
            tmp_lst <span class="token operator">=</span> log<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
            ip <span class="token operator">=</span> tmp_lst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            dt <span class="token operator">=</span> tmp_lst<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            bt <span class="token operator">=</span> tmp_lst<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>
            dt <span class="token operator">=</span> trans_time<span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
            prov<span class="token punctuation">,</span> isp <span class="token operator">=</span> resolv_ip<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
            <span class="token keyword">if</span> prov <span class="token keyword">and</span> isp<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> prov<span class="token punctuation">,</span> isp<span class="token punctuation">)</span>
                md <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'192.168.220.107'</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">'zjx'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'123456'</span><span class="token punctuation">)</span>
                cur <span class="token operator">=</span> md<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
                cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'show databases;'</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'use kafka'</span><span class="token punctuation">)</span>
                cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'show tables;'</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'insert into nginxlog (dt,prov_name,isp_name) values ("%s","%s","%s")'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>dt<span class="token punctuation">,</span> prov<span class="token punctuation">,</span> isp<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    md<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"保存成功"</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> err<span class="token punctuation">:</span>
                    md<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
                md<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                cur<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
</code></pre> 
<p>执行脚本</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nginx-kafka02 ~<span class="token punctuation">]</span><span class="token comment"># python3 python_consumer.py</span>
</code></pre> 
<p>效果图</p> 
<p>脚本执行结果</p> 
<p><img src="https://images2.imgbox.com/bf/8e/RnonZFPO_o.png" alt="在这里插入图片描述"><br> 数据库入库结果<br> <img src="https://images2.imgbox.com/f2/d6/O3PQG8k9_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4230c164fbf272699b87f43670f8487c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">N: 无法安全地用该源进行更新，所以默认禁用该源。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b404462c83488c02f9845f08b137e35c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;STL中 vector和set容器的用法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>