<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32F103的CAN标准库分析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32F103的CAN标准库分析" />
<meta property="og:description" content="[1] CAN_DeInit 描述 将外设 CAN 的全部寄存器重设为缺省值。
函数源代码 void CAN_DeInit(CAN_TypeDef* CANx) { /* Check the parameters */ assert_param(IS_CAN_ALL_PERIPH(CANx)); if (CANx == CAN1) { /* Enable CAN1 reset state */ RCC_APB1PeriphResetCmd(RCC_APB1Periph_CAN1, ENABLE); //强制或释放APB1挂载的外设 /* Release CAN1 from reset state */ RCC_APB1PeriphResetCmd(RCC_APB1Periph_CAN1, DISABLE); } else { /* Enable CAN2 reset state */ RCC_APB1PeriphResetCmd(RCC_APB1Periph_CAN2, ENABLE); /* Release CAN2 from reset state */ RCC_APB1PeriphResetCmd(RCC_APB1Periph_CAN2, DISABLE); } } 分析 入参类型为CAN_TypeDef*，该数据类型是对CAN外设寄存器的抽象，具体如下。结构体成员与STM32参考手册中CAN章节列出的CAN寄存器逐一对应。
typedef struct { __IO uint32_t MCR; __IO uint32_t MSR; __IO uint32_t TSR; __IO uint32_t RF0R; __IO uint32_t RF1R; __IO uint32_t IER; __IO uint32_t ESR; __IO uint32_t BTR; uint32_t RESERVED0[88]; CAN_TxMailBox_TypeDef sTxMailBox[3]; CAN_FIFOMailBox_TypeDef sFIFOMailBox[2]; uint32_t RESERVED1[12]; __IO uint32_t FMR; __IO uint32_t FM1R; uint32_t RESERVED2; __IO uint32_t FS1R; uint32_t RESERVED3; __IO uint32_t FFA1R; uint32_t RESERVED4; __IO uint32_t FA1R; uint32_t RESERVED5[8]; #ifndef STM32F10X_CL CAN_FilterRegister_TypeDef sFilterRegister[14]; #else CAN_FilterRegister_TypeDef sFilterRegister[28]; #endif /* STM32F10X_CL */ } CAN_TypeDef; 函数内部首先利用断言机制assert_param判定入参是否合理，断言在标准库代码中随处可见，其主要用于代码调试阶段来debug，实现如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d78634a8ce28953d5d8e22c487413fa7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-22T22:47:50+08:00" />
<meta property="article:modified_time" content="2022-09-22T22:47:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32F103的CAN标准库分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_CAN_DeInit_0"></a>[1] CAN_DeInit</h2> 
<h4><a id="_1"></a>描述</h4> 
<p>将外设 CAN 的全部寄存器重设为缺省值。</p> 
<h4><a id="_3"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">CAN_DeInit</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>CANx <span class="token operator">==</span> CAN1<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Enable CAN1 reset state */</span>
    <span class="token function">RCC_APB1PeriphResetCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_CAN1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//强制或释放APB1挂载的外设</span>
    <span class="token comment">/* Release CAN1 from reset state */</span>
    <span class="token function">RCC_APB1PeriphResetCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_CAN1<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">/* Enable CAN2 reset state */</span>
    <span class="token function">RCC_APB1PeriphResetCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_CAN2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Release CAN2 from reset state */</span>
    <span class="token function">RCC_APB1PeriphResetCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_CAN2<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_27"></a>分析</h4> 
<p>入参类型为CAN_TypeDef*，该数据类型是对CAN外设寄存器的抽象，具体如下。结构体成员与STM32参考手册中CAN章节列出的CAN寄存器逐一对应。</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
  __IO <span class="token class-name">uint32_t</span> MCR<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> MSR<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> TSR<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> RF0R<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> RF1R<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> IER<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> ESR<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> BTR<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>  RESERVED0<span class="token punctuation">[</span><span class="token number">88</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  CAN_TxMailBox_TypeDef sTxMailBox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  CAN_FIFOMailBox_TypeDef sFIFOMailBox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>  RESERVED1<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> FMR<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> FM1R<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>  RESERVED2<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> FS1R<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>  RESERVED3<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> FFA1R<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>  RESERVED4<span class="token punctuation">;</span>
  __IO <span class="token class-name">uint32_t</span> FA1R<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>  RESERVED5<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">STM32F10X_CL</span></span>
  CAN_FilterRegister_TypeDef sFilterRegister<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  CAN_FilterRegister_TypeDef sFilterRegister<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* STM32F10X_CL */</span>  </span>
<span class="token punctuation">}</span> CAN_TypeDef<span class="token punctuation">;</span>
</code></pre> 
<p>函数内部首先利用断言机制assert_param判定入参是否合理，断言在标准库代码中随处可见，其主要用于代码调试阶段来debug，实现如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">USE_FULL_ASSERT</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">assert_param</span><span class="token expression"><span class="token punctuation">(</span>expr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token number">0</span> <span class="token operator">:</span> <span class="token function">assert_failed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* Exported functions ------------------------------------------------------- */</span>
  <span class="token keyword">void</span> <span class="token function">assert_failed</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> file<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">assert_param</span><span class="token expression"><span class="token punctuation">(</span>expr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* USE_FULL_ASSERT */</span></span>
</code></pre> 
<p>可见只有在宏USE_FULL_ASSERT有效时才真正起到“断言”的作用，而标准库一般默认将该宏屏蔽，所以在这里不起作用。而宏IS_CAN_ALL_PERIPH(PERIPH)的作用是判断外设PERIPH是否为CAN1或CAN2，是则返回1否则返回0，实现如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IS_CAN_ALL_PERIPH</span><span class="token expression"><span class="token punctuation">(</span>PERIPH<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PERIPH<span class="token punctuation">)</span> <span class="token operator">==</span> CAN1<span class="token punctuation">)</span> <span class="token operator">||</span> </span><span class="token punctuation">\</span>
                                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>PERIPH<span class="token punctuation">)</span> <span class="token operator">==</span> CAN2<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre> 
<p>然后具体设置CAN外设的复位，先强制复位再释放复位，无论是CAN1还是CAN2都一样。这里调用了库函数RCC_APB1PeriphResetCmd，它的含义是“强制或者释放低速 APB（APB1）外设复位”，其实现如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">RCC_APB1PeriphResetCmd</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> RCC_APB1Periph<span class="token punctuation">,</span> FunctionalState NewState<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_RCC_APB1_PERIPH</span><span class="token punctuation">(</span>RCC_APB1Periph<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>NewState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>NewState <span class="token operator">!=</span> DISABLE<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    RCC<span class="token operator">-&gt;</span>APB1RSTR <span class="token operator">|=</span> RCC_APB1Periph<span class="token punctuation">;</span> <span class="token comment">//把寄存器APB1RSTR中要复位的外设对应位置1</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    RCC<span class="token operator">-&gt;</span>APB1RSTR <span class="token operator">&amp;=</span> <span class="token operator">~</span>RCC_APB1Periph<span class="token punctuation">;</span> <span class="token comment">//把寄存器APB1RSTR中要复位的外设对应位置0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该函数的核心是操作RCC的APB1RSTR寄存器的相关位以实现强制复位或释放复位。查阅参考手册可知，该32位寄存器的不同位代表挂载在APB1下的各外设的复位情况，以CAN1为例，要想将其复位则函数实际执行的操作如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RCC_APB1Periph_CAN1</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x02000000</span><span class="token punctuation">)</span></span></span>
RCC<span class="token operator">-&gt;</span>APB1RSTR <span class="token operator">|=</span> RCC_APB1Periph_CAN1<span class="token punctuation">;</span>
</code></pre> 
<p>意味着将APB1RSTR的第25位CAN1RST置1，实现CAN1的复位。释放复位则是将APB1RSTR对应位置0。</p> 
<h2><a id="2_CAN_StructInit_103"></a>[2] CAN_StructInit</h2> 
<h4><a id="_104"></a>描述</h4> 
<p>把 CAN_InitStruct 中的每一个参数按缺省值填入。</p> 
<h4><a id="_106"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">CAN_StructInit</span><span class="token punctuation">(</span>CAN_InitTypeDef<span class="token operator">*</span> CAN_InitStruct<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Reset CAN init structure parameters values */</span>
  
  <span class="token comment">/* Initialize the time triggered communication mode */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_TTCM <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the automatic bus-off management */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_ABOM <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the automatic wake-up mode */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_AWUM <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the no automatic retransmission */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_NART <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the receive FIFO locked mode */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_RFLM <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the transmit FIFO priority */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_TXFP <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the CAN_Mode member */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_Mode <span class="token operator">=</span> CAN_Mode_Normal<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the CAN_SJW member */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_SJW <span class="token operator">=</span> CAN_SJW_1tq<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the CAN_BS1 member */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_BS1 <span class="token operator">=</span> CAN_BS1_4tq<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the CAN_BS2 member */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_BS2 <span class="token operator">=</span> CAN_BS2_3tq<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the CAN_Prescaler member */</span>
  CAN_InitStruct<span class="token operator">-&gt;</span>CAN_Prescaler <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_147"></a>分析</h4> 
<p>函数入参CAN_InitTypeDef*即CAN初始化结构体，包含了CAN相关的重要参数配置，包括外设时钟分频、工作模式、同步跳跃宽度、位段1和位段2宽度、时间触发模式开关、自动唤醒模式开关等等，结构体如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint16_t</span> CAN_Prescaler<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; Specifies the length of a time quantum. 
                                 It ranges from 1 to 1024. */</span>
  
  <span class="token class-name">uint8_t</span> CAN_Mode<span class="token punctuation">;</span>         <span class="token comment">/*!&lt; Specifies the CAN operating mode.
                                 This parameter can be a value of 
                                @ref CAN_operating_mode */</span>

  <span class="token class-name">uint8_t</span> CAN_SJW<span class="token punctuation">;</span>          <span class="token comment">/*!&lt; Specifies the maximum number of time quanta 
                                 the CAN hardware is allowed to lengthen or 
                                 shorten a bit to perform resynchronization.
                                 This parameter can be a value of 
                                 @ref CAN_synchronisation_jump_width */</span>

  <span class="token class-name">uint8_t</span> CAN_BS1<span class="token punctuation">;</span>          <span class="token comment">/*!&lt; Specifies the number of time quanta in Bit 
                                 Segment 1. This parameter can be a value of 
                                 @ref CAN_time_quantum_in_bit_segment_1 */</span>

  <span class="token class-name">uint8_t</span> CAN_BS2<span class="token punctuation">;</span>          <span class="token comment">/*!&lt; Specifies the number of time quanta in Bit 
                                 Segment 2.
                                 This parameter can be a value of 
                                 @ref CAN_time_quantum_in_bit_segment_2 */</span>
  
  FunctionalState CAN_TTCM<span class="token punctuation">;</span> <span class="token comment">/*!&lt; Enable or disable the time triggered 
                                 communication mode. This parameter can be set 
                                 either to ENABLE or DISABLE. */</span>
  
  FunctionalState CAN_ABOM<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Enable or disable the automatic bus-off 
                                  management. This parameter can be set either 
                                  to ENABLE or DISABLE. */</span>

  FunctionalState CAN_AWUM<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Enable or disable the automatic wake-up mode. 
                                  This parameter can be set either to ENABLE or 
                                  DISABLE. */</span>

  FunctionalState CAN_NART<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Enable or disable the no-automatic 
                                  retransmission mode. This parameter can be 
                                  set either to ENABLE or DISABLE. */</span>

  FunctionalState CAN_RFLM<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Enable or disable the Receive FIFO Locked mode.
                                  This parameter can be set either to ENABLE 
                                  or DISABLE. */</span>

  FunctionalState CAN_TXFP<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Enable or disable the transmit FIFO priority.
                                  This parameter can be set either to ENABLE 
                                  or DISABLE. */</span>
<span class="token punctuation">}</span> CAN_InitTypeDef<span class="token punctuation">;</span>
</code></pre> 
<p>函数内部实现很简单，仅仅是给初始化结构体的各个成员赋默认值而已。</p> 
<h2><a id="3_CAN_Init_201"></a>[3] CAN_Init</h2> 
<h4><a id="_202"></a>描述</h4> 
<p>根据 CAN_InitStruct 中指定的参数初始化外设 CAN 的寄存器。</p> 
<h4><a id="_204"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token class-name">uint8_t</span> <span class="token function">CAN_Init</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">,</span> CAN_InitTypeDef<span class="token operator">*</span> CAN_InitStruct<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint8_t</span> InitStatus <span class="token operator">=</span> CAN_InitStatus_Failed<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> wait_ack <span class="token operator">=</span> <span class="token number">0x00000000</span><span class="token punctuation">;</span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_TTCM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_ABOM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_AWUM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_NART<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_RFLM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_TXFP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_MODE</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_Mode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_SJW</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_SJW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_BS1</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_BS1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_BS2</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_BS2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_PRESCALER</span><span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_Prescaler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Exit from sleep mode */</span>
  CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_MCR_SLEEP<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清零CAN主控制寄存器CAN_MCR的第1位SLEEP，CAN退出睡眠模式</span>

  <span class="token comment">/* Request initialisation */</span>
  CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">|=</span> CAN_MCR_INRQ <span class="token punctuation">;</span> <span class="token comment">//设置CAN主控制寄存器CAN_MCR的第0位INRQ，CAN进入初始化模式</span>

  <span class="token comment">/* Wait the acknowledge */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>MSR <span class="token operator">&amp;</span> CAN_MSR_INAK<span class="token punctuation">)</span> <span class="token operator">!=</span> CAN_MSR_INAK<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wait_ack <span class="token operator">!=</span> INAK_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//读取CAN主状态寄存器CAN_MSR的第0位INAK，若为1则确认CAN进入初始化模式</span>
  <span class="token punctuation">{<!-- --></span>
    wait_ack<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Check acknowledge */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>MSR <span class="token operator">&amp;</span> CAN_MSR_INAK<span class="token punctuation">)</span> <span class="token operator">!=</span> CAN_MSR_INAK<span class="token punctuation">)</span> <span class="token comment">//CAN初始化失败返回</span>
  <span class="token punctuation">{<!-- --></span>
    InitStatus <span class="token operator">=</span> CAN_InitStatus_Failed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token comment">//CAN进入了初始化模式</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Set the time triggered communication mode */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_TTCM <span class="token operator">==</span> ENABLE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">|=</span> CAN_MCR_TTCM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_MCR_TTCM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set the automatic bus-off management */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_ABOM <span class="token operator">==</span> ENABLE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">|=</span> CAN_MCR_ABOM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_MCR_ABOM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set the automatic wake-up mode */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_AWUM <span class="token operator">==</span> ENABLE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">|=</span> CAN_MCR_AWUM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_MCR_AWUM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set the no automatic retransmission */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_NART <span class="token operator">==</span> ENABLE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">|=</span> CAN_MCR_NART<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_MCR_NART<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set the receive FIFO locked mode */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_RFLM <span class="token operator">==</span> ENABLE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">|=</span> CAN_MCR_RFLM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_MCR_RFLM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set the transmit FIFO priority */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_TXFP <span class="token operator">==</span> ENABLE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">|=</span> CAN_MCR_TXFP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_MCR_TXFP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set the bit timing register */</span>
    CANx<span class="token operator">-&gt;</span>BTR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_Mode <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">|</span> \
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_SJW <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> \
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_BS1 <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> \
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_BS2 <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">|</span> \
               <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_InitStruct<span class="token operator">-&gt;</span>CAN_Prescaler <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Request leave initialisation */</span>
    CANx<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_MCR_INRQ<span class="token punctuation">;</span> <span class="token comment">//CAN从初始化模式进入正常模式</span>

   <span class="token comment">/* Wait the acknowledge */</span>
   wait_ack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>MSR <span class="token operator">&amp;</span> CAN_MSR_INAK<span class="token punctuation">)</span> <span class="token operator">==</span> CAN_MSR_INAK<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wait_ack <span class="token operator">!=</span> INAK_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
     wait_ack<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

    <span class="token comment">/* ...and check acknowledged */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>MSR <span class="token operator">&amp;</span> CAN_MSR_INAK<span class="token punctuation">)</span> <span class="token operator">==</span> CAN_MSR_INAK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      InitStatus <span class="token operator">=</span> CAN_InitStatus_Failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      InitStatus <span class="token operator">=</span> CAN_InitStatus_Success <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* At this step, return the status of initialization */</span>
  <span class="token keyword">return</span> InitStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_337"></a>分析</h4> 
<p>通过清零CAN主控制寄存器CAN_MCR的第1位SLEEP，CAN退出睡眠模式，因为CAN在复位后就处于睡眠模式了。设置CAN主控制寄存器CAN_MCR的第0位INRQ，CAN进入初始化模式。接下来是初始化的确认，因为在上一步中设置INRQ后，相应地硬件会对CAN主状态寄存器CAN_MSR的INAK位置1，所以通过读取该位来判断CAN是否真正进入初始化模式。为保证判断准确此处进行了while循环等待处理。紧接着判断INAK，若初始化失败则返回失败状态，否则继续配置其它寄存器。对于初始化结构体中开关型的成员，设置或清零CAN_MCR寄存器中的对应位。对于其它数值型的成员，根据它们各自在CAN位时序寄存器CAN_BTR中的对应位置，经过不同的移位和按位或运算后写入CAN_BTR。<br> 配置完毕相关的寄存器后，CAN要从初始化模式进入正常模式，方法就是清零CAN_MCR的位INRQ，相应地硬件会把CAN_MSR的位INAK清零，同样的紧接着读取检查INAK位，若该位未能从1变成0则意味失败，若为0则说明CAN进入了正常模式，整个初始化过程成功，返回成功标志。</p> 
<h2><a id="4_CAN_FilterInit_340"></a>[4] CAN_FilterInit</h2> 
<h4><a id="_341"></a>描述</h4> 
<p>根据 CAN_FilterInitStruct 中指定的参数初始化外设CAN的寄存器。</p> 
<h4><a id="_343"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">CAN_FilterInit</span><span class="token punctuation">(</span>CAN_FilterInitTypeDef<span class="token operator">*</span> CAN_FilterInitStruct<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint32_t</span> filter_number_bit_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_FILTER_NUMBER</span><span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_FILTER_MODE</span><span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterMode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_FILTER_SCALE</span><span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterScale<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_FILTER_FIFO</span><span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterFIFOAssignment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterActivation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  filter_number_bit_pos <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterNumber<span class="token punctuation">;</span> <span class="token comment">//过滤器序号为x则把x位置1</span>

  <span class="token comment">/* Initialisation mode for the filter */</span>
  CAN1<span class="token operator">-&gt;</span>FMR <span class="token operator">|=</span> FMR_FINIT<span class="token punctuation">;</span> <span class="token comment">//使过滤器组工作在初始化模式</span>

  <span class="token comment">/* Filter Deactivation */</span>
  CAN1<span class="token operator">-&gt;</span>FA1R <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>filter_number_bit_pos<span class="token punctuation">;</span> <span class="token comment">//所选的过滤器被禁用</span>

  <span class="token comment">/* Filter Scale */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterScale <span class="token operator">==</span> CAN_FilterScale_16bit<span class="token punctuation">)</span> <span class="token comment">//16位模式</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 16-bit scale for the filter */</span>
    CAN1<span class="token operator">-&gt;</span>FS1R <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>filter_number_bit_pos<span class="token punctuation">;</span> <span class="token comment">//设置当前过滤器位宽为2个16位</span>

    <span class="token comment">/* First 16-bit identifier and First 16-bit mask */</span>
    <span class="token comment">/* Or First 16-bit identifier and Second 16-bit identifier */</span>
    CAN1<span class="token operator">-&gt;</span>sFilterRegister<span class="token punctuation">[</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterNumber<span class="token punctuation">]</span><span class="token punctuation">.</span>FR1 <span class="token operator">=</span> 
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x0000FFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterMaskIdLow<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        <span class="token punctuation">(</span><span class="token number">0x0000FFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterIdLow<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//若为列表模式，设置FR1存储两条过滤ID；若为掩码模式，设置FR1存储一条ID及其掩码</span>

    <span class="token comment">/* Second 16-bit identifier and Second 16-bit mask */</span>
    <span class="token comment">/* Or Third 16-bit identifier and Fourth 16-bit identifier */</span>
    CAN1<span class="token operator">-&gt;</span>sFilterRegister<span class="token punctuation">[</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterNumber<span class="token punctuation">]</span><span class="token punctuation">.</span>FR2 <span class="token operator">=</span> 
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x0000FFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterMaskIdHigh<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        <span class="token punctuation">(</span><span class="token number">0x0000FFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterIdHigh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//若为列表模式，设置FR2存储另两条过滤ID；若为掩码模式，设置FR2存储另一条ID及其掩码</span>
  <span class="token punctuation">}</span> 

  <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterScale <span class="token operator">==</span> CAN_FilterScale_32bit<span class="token punctuation">)</span> <span class="token comment">//32位模式</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 32-bit scale for the filter */</span>
    CAN1<span class="token operator">-&gt;</span>FS1R <span class="token operator">|=</span> filter_number_bit_pos<span class="token punctuation">;</span> <span class="token comment">//设置当前过滤器位宽为32位</span>
    <span class="token comment">/* 32-bit identifier or First 32-bit identifier */</span>
    CAN1<span class="token operator">-&gt;</span>sFilterRegister<span class="token punctuation">[</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterNumber<span class="token punctuation">]</span><span class="token punctuation">.</span>FR1 <span class="token operator">=</span> 
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x0000FFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterIdHigh<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        <span class="token punctuation">(</span><span class="token number">0x0000FFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterIdLow<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置FR1为ID</span>
    <span class="token comment">/* 32-bit mask or Second 32-bit identifier */</span>
    CAN1<span class="token operator">-&gt;</span>sFilterRegister<span class="token punctuation">[</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterNumber<span class="token punctuation">]</span><span class="token punctuation">.</span>FR2 <span class="token operator">=</span> 
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x0000FFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterMaskIdHigh<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        <span class="token punctuation">(</span><span class="token number">0x0000FFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterMaskIdLow<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//若为列表模式，设置FR2为另一个ID；若为掩码模式，设置FR2为FR1中的ID的掩码</span>
  <span class="token punctuation">}</span> 

  <span class="token comment">/* Filter Mode */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterMode <span class="token operator">==</span> CAN_FilterMode_IdMask<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*Id/Mask mode for the filter*/</span>
    CAN1<span class="token operator">-&gt;</span>FM1R <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>filter_number_bit_pos<span class="token punctuation">;</span> <span class="token comment">//设置当前过滤器组工作在掩码模式</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token comment">/* CAN_FilterInitStruct-&gt;CAN_FilterMode == CAN_FilterMode_IdList */</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*Identifier list mode for the filter*/</span>
    CAN1<span class="token operator">-&gt;</span>FM1R <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>filter_number_bit_pos<span class="token punctuation">;</span> <span class="token comment">//设置当前过滤器组工作在列表模式</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Filter FIFO assignment */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterFIFOAssignment <span class="token operator">==</span> CAN_Filter_FIFO0<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* FIFO 0 assignation for the filter */</span>
    CAN1<span class="token operator">-&gt;</span>FFA1R <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>filter_number_bit_pos<span class="token punctuation">;</span> <span class="token comment">//当前过滤器关联到FIFO0</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterFIFOAssignment <span class="token operator">==</span> CAN_Filter_FIFO1<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* FIFO 1 assignation for the filter */</span>
    CAN1<span class="token operator">-&gt;</span>FFA1R <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>filter_number_bit_pos<span class="token punctuation">;</span> <span class="token comment">//当前过滤器关联到FIFO1</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/* Filter activation */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>CAN_FilterInitStruct<span class="token operator">-&gt;</span>CAN_FilterActivation <span class="token operator">==</span> ENABLE<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    CAN1<span class="token operator">-&gt;</span>FA1R <span class="token operator">|=</span> filter_number_bit_pos<span class="token punctuation">;</span> <span class="token comment">//使过滤器被激活</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Leave the initialisation mode for the filter */</span>
  CAN1<span class="token operator">-&gt;</span>FMR <span class="token operator">&amp;=</span> <span class="token operator">~</span>FMR_FINIT<span class="token punctuation">;</span> <span class="token comment">//使过滤器组工作在正常模式</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_432"></a>分析</h4> 
<p>入参的结构体即CAN过滤器初始化结构体，其成员包括ID模式的高低位、掩码模式的高低位、过滤器关联的FIFO序号、过滤器序号、过滤器模式等参数，具体如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint16_t</span> CAN_FilterIdHigh<span class="token punctuation">;</span>         <span class="token comment">/*!&lt; Specifies the filter identification number (MSBs for a 32-bit
                                              configuration, first one for a 16-bit configuration).
                                              This parameter can be a value between 0x0000 and 0xFFFF */</span>

  <span class="token class-name">uint16_t</span> CAN_FilterIdLow<span class="token punctuation">;</span>          <span class="token comment">/*!&lt; Specifies the filter identification number (LSBs for a 32-bit
                                              configuration, second one for a 16-bit configuration).
                                              This parameter can be a value between 0x0000 and 0xFFFF */</span>

  <span class="token class-name">uint16_t</span> CAN_FilterMaskIdHigh<span class="token punctuation">;</span>     <span class="token comment">/*!&lt; Specifies the filter mask number or identification number,
                                              according to the mode (MSBs for a 32-bit configuration,
                                              first one for a 16-bit configuration).
                                              This parameter can be a value between 0x0000 and 0xFFFF */</span>

  <span class="token class-name">uint16_t</span> CAN_FilterMaskIdLow<span class="token punctuation">;</span>      <span class="token comment">/*!&lt; Specifies the filter mask number or identification number,
                                              according to the mode (LSBs for a 32-bit configuration,
                                              second one for a 16-bit configuration).
                                              This parameter can be a value between 0x0000 and 0xFFFF */</span>

  <span class="token class-name">uint16_t</span> CAN_FilterFIFOAssignment<span class="token punctuation">;</span> <span class="token comment">/*!&lt; Specifies the FIFO (0 or 1) which will be assigned to the filter.
                                              This parameter can be a value of @ref CAN_filter_FIFO */</span>
  
  <span class="token class-name">uint8_t</span> CAN_FilterNumber<span class="token punctuation">;</span>          <span class="token comment">/*!&lt; Specifies the filter which will be initialized. It ranges from 0 to 13. */</span>

  <span class="token class-name">uint8_t</span> CAN_FilterMode<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; Specifies the filter mode to be initialized.
                                              This parameter can be a value of @ref CAN_filter_mode */</span>

  <span class="token class-name">uint8_t</span> CAN_FilterScale<span class="token punctuation">;</span>           <span class="token comment">/*!&lt; Specifies the filter scale.
                                              This parameter can be a value of @ref CAN_filter_scale */</span>

  FunctionalState CAN_FilterActivation<span class="token punctuation">;</span> <span class="token comment">/*!&lt; Enable or disable the filter.
                                              This parameter can be set either to ENABLE or DISABLE. */</span>
<span class="token punctuation">}</span> CAN_FilterInitTypeDef<span class="token punctuation">;</span>
</code></pre> 
<p>代码中有先进行过滤器的禁用操作CAN1-&gt;FA1R &amp;= ~(uint32_t)filter_number_bit_pos，就是把CAN过滤器激活寄存器中，当前过滤器序号的对应位清零，实现禁用。参考手册中指明：只有对FACTx位清’0’，或对CAN_FMR寄存器的FINIT位设置’1’后，才能修改相应的过滤器寄存器x(CAN_FxR[0:1])。对过滤模式而言，无论是列表模式还是掩码模式，都有16位和32位两种位长度。如果为16位模式，则过滤器组的寄存器FR1的高位存CAN_FilterMaskIdLow、低位存CAN_FilterIdLow，FR2的高位存CAN_FilterMaskIdHigh、低位存CAN_FilterIdHigh。在列表模式下，CAN_FilterMaskIdLow和CAN_FilterIdLow分别为两个ID，CAN_FilterMaskIdHigh和CAN_FilterIdHigh分别为另外两个ID。在掩码模式下则不同，CAN_FilterIdLow和CAN_FilterMaskIdLow分别为一个ID及其掩码，CAN_FilterIdHigh和CAN_FilterMaskIdHigh分别为另一个ID及其掩码。如果为32位模式，则FR1高位存入CAN_FilterIdHigh、低位存入CAN_FilterIdLow，FR2高位存入CAN_FilterMaskIdHigh、低位存入CAN_FilterMaskIdLow。在列表模式下，FR1和FR2表示两个ID，而在掩码模式下它们分别表示ID及其掩码。</p> 
<h2><a id="5_CAN_ITConfig_472"></a>[5] CAN_ITConfig</h2> 
<h4><a id="_473"></a>描述</h4> 
<p>使能或者失能指定的CAN中断。</p> 
<h4><a id="_475"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">CAN_ITConfig</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> CAN_IT<span class="token punctuation">,</span> FunctionalState NewState<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_IT</span><span class="token punctuation">(</span>CAN_IT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_FUNCTIONAL_STATE</span><span class="token punctuation">(</span>NewState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>NewState <span class="token operator">!=</span> DISABLE<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Enable the selected CANx interrupt */</span>
    CANx<span class="token operator">-&gt;</span>IER <span class="token operator">|=</span> CAN_IT<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Disable the selected CANx interrupt */</span>
    CANx<span class="token operator">-&gt;</span>IER <span class="token operator">&amp;=</span> <span class="token operator">~</span>CAN_IT<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_497"></a>分析</h4> 
<p>对于给定的中断类型，函数通过对CAN中断使能寄存器CAN_IER的各中断类型相应位设置或清零，以实现中断使能或失能。CAN的中断类型如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_TME</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000001</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; Transmit mailbox empty Interrupt*/</span></span>
<span class="token comment">/* Receive Interrupts */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_FMP0</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000002</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; FIFO 0 message pending Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_FF0</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000004</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; FIFO 0 full Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_FOV0</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000008</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; FIFO 0 overrun Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_FMP1</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000010</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; FIFO 1 message pending Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_FF1</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000020</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; FIFO 1 full Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_FOV1</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000040</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; FIFO 1 overrun Interrupt*/</span></span>
<span class="token comment">/* Operating Mode Interrupts */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_WKU</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00010000</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; Wake-up Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_SLK</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00020000</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; Sleep acknowledge Interrupt*/</span></span>
<span class="token comment">/* Error Interrupts */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_EWG</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000100</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; Error warning Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_EPV</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000200</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; Error passive Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_BOF</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000400</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; Bus-off Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_LEC</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000800</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; Last error code Interrupt*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_IT_ERR</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00008000</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; Error Interrupt*/</span></span>
</code></pre> 
<h2><a id="6_CAN_Transmit_519"></a>[6] CAN_Transmit</h2> 
<h4><a id="_520"></a>描述</h4> 
<p>开始一个消息的传输。</p> 
<h4><a id="_522"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token class-name">uint8_t</span> <span class="token function">CAN_Transmit</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">,</span> CanTxMsg<span class="token operator">*</span> TxMessage<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint8_t</span> transmit_mailbox <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_IDTYPE</span><span class="token punctuation">(</span>TxMessage<span class="token operator">-&gt;</span>IDE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_RTR</span><span class="token punctuation">(</span>TxMessage<span class="token operator">-&gt;</span>RTR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_DLC</span><span class="token punctuation">(</span>TxMessage<span class="token operator">-&gt;</span>DLC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Select one empty transmit mailbox */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>TSR<span class="token operator">&amp;</span>CAN_TSR_TME0<span class="token punctuation">)</span> <span class="token operator">==</span> CAN_TSR_TME0<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    transmit_mailbox <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>TSR<span class="token operator">&amp;</span>CAN_TSR_TME1<span class="token punctuation">)</span> <span class="token operator">==</span> CAN_TSR_TME1<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    transmit_mailbox <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>TSR<span class="token operator">&amp;</span>CAN_TSR_TME2<span class="token punctuation">)</span> <span class="token operator">==</span> CAN_TSR_TME2<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    transmit_mailbox <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    transmit_mailbox <span class="token operator">=</span> CAN_TxStatus_NoMailBox<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>transmit_mailbox <span class="token operator">!=</span> CAN_TxStatus_NoMailBox<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Set up the Id */</span>
    CANx<span class="token operator">-&gt;</span>sTxMailBox<span class="token punctuation">[</span>transmit_mailbox<span class="token punctuation">]</span><span class="token punctuation">.</span>TIR <span class="token operator">&amp;=</span> TMIDxR_TXRQ<span class="token punctuation">;</span> <span class="token comment">//请求发送邮箱的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TxMessage<span class="token operator">-&gt;</span>IDE <span class="token operator">==</span> CAN_Id_Standard<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_STDID</span><span class="token punctuation">(</span>TxMessage<span class="token operator">-&gt;</span>StdId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      CANx<span class="token operator">-&gt;</span>sTxMailBox<span class="token punctuation">[</span>transmit_mailbox<span class="token punctuation">]</span><span class="token punctuation">.</span>TIR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TxMessage<span class="token operator">-&gt;</span>StdId <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">|</span> \
                                                  TxMessage<span class="token operator">-&gt;</span>RTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_EXTID</span><span class="token punctuation">(</span>TxMessage<span class="token operator">-&gt;</span>ExtId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      CANx<span class="token operator">-&gt;</span>sTxMailBox<span class="token punctuation">[</span>transmit_mailbox<span class="token punctuation">]</span><span class="token punctuation">.</span>TIR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TxMessage<span class="token operator">-&gt;</span>ExtId <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> \
                                                  TxMessage<span class="token operator">-&gt;</span>IDE <span class="token operator">|</span> \
                                                  TxMessage<span class="token operator">-&gt;</span>RTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* Set up the DLC */</span>
    TxMessage<span class="token operator">-&gt;</span>DLC <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0x0000000F</span><span class="token punctuation">;</span>
    CANx<span class="token operator">-&gt;</span>sTxMailBox<span class="token punctuation">[</span>transmit_mailbox<span class="token punctuation">]</span><span class="token punctuation">.</span>TDTR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFFFFFFF0</span><span class="token punctuation">;</span>
    CANx<span class="token operator">-&gt;</span>sTxMailBox<span class="token punctuation">[</span>transmit_mailbox<span class="token punctuation">]</span><span class="token punctuation">.</span>TDTR <span class="token operator">|=</span> TxMessage<span class="token operator">-&gt;</span>DLC<span class="token punctuation">;</span>

    <span class="token comment">/* Set up the data field */</span>
    CANx<span class="token operator">-&gt;</span>sTxMailBox<span class="token punctuation">[</span>transmit_mailbox<span class="token punctuation">]</span><span class="token punctuation">.</span>TDLR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> 
                                             <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                                             <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> 
                                             <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CANx<span class="token operator">-&gt;</span>sTxMailBox<span class="token punctuation">[</span>transmit_mailbox<span class="token punctuation">]</span><span class="token punctuation">.</span>TDHR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> 
                                             <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                                             <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                                             <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Request transmission */</span>
    CANx<span class="token operator">-&gt;</span>sTxMailBox<span class="token punctuation">[</span>transmit_mailbox<span class="token punctuation">]</span><span class="token punctuation">.</span>TIR <span class="token operator">|=</span> TMIDxR_TXRQ<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> transmit_mailbox<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_590"></a>分析</h4> 
<p>第二个入参的结构体为CAN发送消息结构体，如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint32_t</span> StdId<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Specifies the standard identifier.
                        This parameter can be a value between 0 to 0x7FF. */</span>

  <span class="token class-name">uint32_t</span> ExtId<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Specifies the extended identifier.
                        This parameter can be a value between 0 to 0x1FFFFFFF. */</span>

  <span class="token class-name">uint8_t</span> IDE<span class="token punctuation">;</span>     <span class="token comment">/*!&lt; Specifies the type of identifier for the message that 
                        will be transmitted. This parameter can be a value 
                        of @ref CAN_identifier_type */</span>

  <span class="token class-name">uint8_t</span> RTR<span class="token punctuation">;</span>     <span class="token comment">/*!&lt; Specifies the type of frame for the message that will 
                        be transmitted. This parameter can be a value of 
                        @ref CAN_remote_transmission_request */</span>

  <span class="token class-name">uint8_t</span> DLC<span class="token punctuation">;</span>     <span class="token comment">/*!&lt; Specifies the length of the frame that will be 
                        transmitted. This parameter can be a value between 
                        0 to 8 */</span>

  <span class="token class-name">uint8_t</span> Data<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/*!&lt; Contains the data to be transmitted. It ranges from 0 
                        to 0xFF. */</span>
<span class="token punctuation">}</span> CanTxMsg<span class="token punctuation">;</span>
</code></pre> 
<p>这几个成员分别是标准ID、扩展ID、ID类型标识、帧类型（数据帧或扩展帧）标识、数据长度和要发送的数据内容。函数内部，先要选择可用的发送邮箱，通过依次读CAN发送状态寄存器CAN_TSR的26、27和28位，若找到置1的位，说明该位对应的邮箱没有需要等待发送的报文，硬件对其置1了，这就是可选的发送邮箱。否则，未找到可用的发送邮箱，本次发送无法进行。选择了邮箱序号后，主要的工作就是设置CAN邮箱寄存器。根据标识符类型、帧类型等参数配置发送邮箱标识符寄存器CAN_TIR。根据要发送的数据长度DLC配置发送邮箱数据长度和时间戳寄存器CAN_TDTR。根据要发送的一帧数据内容，分低位字节和高位字节分别存入发送邮箱低字节数据寄存器CAN_TDLR和发送邮箱高字节数据寄存器CAN_TDHR。最后设置CAN_TIR的TXRQ位请求发送。</p> 
<h2><a id="7_CAN_TransmitStatus_619"></a>[7] CAN_TransmitStatus</h2> 
<h4><a id="_620"></a>描述</h4> 
<p>检查消息传输的状态。</p> 
<h4><a id="_622"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token class-name">uint8_t</span> <span class="token function">CAN_TransmitStatus</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> TransmitMailbox<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint32_t</span> state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_TRANSMITMAILBOX</span><span class="token punctuation">(</span>TransmitMailbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>TransmitMailbox<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TXMAILBOX_0<span class="token punctuation">)</span><span class="token operator">:</span> 
      state <span class="token operator">=</span>   CANx<span class="token operator">-&gt;</span>TSR <span class="token operator">&amp;</span>  <span class="token punctuation">(</span>CAN_TSR_RQCP0 <span class="token operator">|</span> CAN_TSR_TXOK0 <span class="token operator">|</span> CAN_TSR_TME0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//检查TSR寄存器的位RQCP、TXOK和TME</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TXMAILBOX_1<span class="token punctuation">)</span><span class="token operator">:</span> 
      state <span class="token operator">=</span>   CANx<span class="token operator">-&gt;</span>TSR <span class="token operator">&amp;</span>  <span class="token punctuation">(</span>CAN_TSR_RQCP1 <span class="token operator">|</span> CAN_TSR_TXOK1 <span class="token operator">|</span> CAN_TSR_TME1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TXMAILBOX_2<span class="token punctuation">)</span><span class="token operator">:</span> 
      state <span class="token operator">=</span>   CANx<span class="token operator">-&gt;</span>TSR <span class="token operator">&amp;</span>  <span class="token punctuation">(</span>CAN_TSR_RQCP2 <span class="token operator">|</span> CAN_TSR_TXOK2 <span class="token operator">|</span> CAN_TSR_TME2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      state <span class="token operator">=</span> CAN_TxStatus_Failed<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* transmit pending  */</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token operator">:</span> state <span class="token operator">=</span> CAN_TxStatus_Pending<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">/* transmit failed  */</span>
     <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TSR_RQCP0 <span class="token operator">|</span> CAN_TSR_TME0<span class="token punctuation">)</span><span class="token operator">:</span> state <span class="token operator">=</span> CAN_TxStatus_Failed<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TSR_RQCP1 <span class="token operator">|</span> CAN_TSR_TME1<span class="token punctuation">)</span><span class="token operator">:</span> state <span class="token operator">=</span> CAN_TxStatus_Failed<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TSR_RQCP2 <span class="token operator">|</span> CAN_TSR_TME2<span class="token punctuation">)</span><span class="token operator">:</span> state <span class="token operator">=</span> CAN_TxStatus_Failed<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">/* transmit succeeded  */</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TSR_RQCP0 <span class="token operator">|</span> CAN_TSR_TXOK0 <span class="token operator">|</span> CAN_TSR_TME0<span class="token punctuation">)</span><span class="token operator">:</span>state <span class="token operator">=</span> CAN_TxStatus_Ok<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TSR_RQCP1 <span class="token operator">|</span> CAN_TSR_TXOK1 <span class="token operator">|</span> CAN_TSR_TME1<span class="token punctuation">)</span><span class="token operator">:</span>state <span class="token operator">=</span> CAN_TxStatus_Ok<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TSR_RQCP2 <span class="token operator">|</span> CAN_TSR_TXOK2 <span class="token operator">|</span> CAN_TSR_TME2<span class="token punctuation">)</span><span class="token operator">:</span>state <span class="token operator">=</span> CAN_TxStatus_Ok<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> state <span class="token operator">=</span> CAN_TxStatus_Failed<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_673"></a>分析</h4> 
<p>对于当前正在使用的邮箱，检查其在CAN发送状态寄存器CAN_TSR所对应的RQCP、TXOK和TME这3个标志位，这些位被硬件置1时，RQCP表示上次传输请求完成（这里说的上次传输即指本次传输已完成），TXOK表示上次传输成功，TME意为当前发送邮箱为空，这3种状态同时存在则表明CAN外设的一次消息传输是没问题的。如果3个标志位均为0，表明本次传输仍在进行中，至于结果如何还未知，故函数返回一个pending状态。如果本次传输失败了，则一般TXOK位就不会被硬件置1。</p> 
<h2><a id="8_CAN_CancelTransmit_675"></a>[8] CAN_CancelTransmit</h2> 
<h4><a id="_676"></a>描述</h4> 
<p>取消一个传输请求。</p> 
<h4><a id="_678"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">CAN_CancelTransmit</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> Mailbox<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_TRANSMITMAILBOX</span><span class="token punctuation">(</span>Mailbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* abort transmission */</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>Mailbox<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TXMAILBOX_0<span class="token punctuation">)</span><span class="token operator">:</span> CANx<span class="token operator">-&gt;</span>TSR <span class="token operator">|=</span> CAN_TSR_ABRQ0<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TXMAILBOX_1<span class="token punctuation">)</span><span class="token operator">:</span> CANx<span class="token operator">-&gt;</span>TSR <span class="token operator">|=</span> CAN_TSR_ABRQ1<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>CAN_TXMAILBOX_2<span class="token punctuation">)</span><span class="token operator">:</span> CANx<span class="token operator">-&gt;</span>TSR <span class="token operator">|=</span> CAN_TSR_ABRQ2<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_700"></a>分析</h4> 
<p>对于当前正在使用的邮箱，设置其在CAN_TSR所对应的ABRQ位，即可中止该邮箱的发送请求。</p> 
<h2><a id="9_CAN_FIFORelease_702"></a>[9] CAN_FIFORelease</h2> 
<h4><a id="_703"></a>描述</h4> 
<p>释放一个 FIFO。</p> 
<h4><a id="_705"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">CAN_FIFORelease</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> FIFONumber<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_FIFO</span><span class="token punctuation">(</span>FIFONumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Release FIFO0 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>FIFONumber <span class="token operator">==</span> CAN_FIFO0<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    CANx<span class="token operator">-&gt;</span>RF0R <span class="token operator">|=</span> CAN_RF0R_RFOM0<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* Release FIFO1 */</span>
  <span class="token keyword">else</span> <span class="token comment">/* FIFONumber == CAN_FIFO1 */</span>
  <span class="token punctuation">{<!-- --></span>
    CANx<span class="token operator">-&gt;</span>RF1R <span class="token operator">|=</span> CAN_RF1R_RFOM1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_725"></a>分析</h4> 
<p>当接收邮箱中存在多条报文时，为了连续获取报文，设置CAN接收FIFO寄存器的位RFOM以释放邮箱，从而访问下一条接收报文。</p> 
<h2><a id="10_CAN_MessagePending_727"></a>[10] CAN_MessagePending</h2> 
<h4><a id="_728"></a>描述</h4> 
<p>返回挂号的信息数量。</p> 
<h4><a id="_730"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token class-name">uint8_t</span> <span class="token function">CAN_MessagePending</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> FIFONumber<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint8_t</span> message_pending<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_FIFO</span><span class="token punctuation">(</span>FIFONumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>FIFONumber <span class="token operator">==</span> CAN_FIFO0<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    message_pending <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>RF0R<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FIFONumber <span class="token operator">==</span> CAN_FIFO1<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    message_pending <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>RF1R<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    message_pending <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> message_pending<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_754"></a>分析</h4> 
<p>函数返回接收FIFO中当前存在的报文数量，通过读CAN接收FIFO寄存器的位FMP获得。每释放一次FIFO，该位表示的数值就减一，FIFO中的报文数减一。</p> 
<h2><a id="11_CAN_Receive_756"></a>[11] CAN_Receive</h2> 
<h4><a id="_757"></a>描述</h4> 
<p>接收一个消息。</p> 
<h4><a id="_759"></a>函数源代码</h4> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">CAN_Receive</span><span class="token punctuation">(</span>CAN_TypeDef<span class="token operator">*</span> CANx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> FIFONumber<span class="token punctuation">,</span> CanRxMsg<span class="token operator">*</span> RxMessage<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Check the parameters */</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_ALL_PERIPH</span><span class="token punctuation">(</span>CANx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_param</span><span class="token punctuation">(</span><span class="token function">IS_CAN_FIFO</span><span class="token punctuation">(</span>FIFONumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Get the Id */</span>
  RxMessage<span class="token operator">-&gt;</span>IDE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0x04</span> <span class="token operator">&amp;</span> CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RIR<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>RxMessage<span class="token operator">-&gt;</span>IDE <span class="token operator">==</span> CAN_Id_Standard<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    RxMessage<span class="token operator">-&gt;</span>StdId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x000007FF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RIR <span class="token operator">&gt;&gt;</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    RxMessage<span class="token operator">-&gt;</span>ExtId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x1FFFFFFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RIR <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  RxMessage<span class="token operator">-&gt;</span>RTR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0x02</span> <span class="token operator">&amp;</span> CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RIR<span class="token punctuation">;</span>
  <span class="token comment">/* Get the DLC */</span>
  RxMessage<span class="token operator">-&gt;</span>DLC <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0x0F</span> <span class="token operator">&amp;</span> CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDTR<span class="token punctuation">;</span>
  <span class="token comment">/* Get the FMI */</span>
  RxMessage<span class="token operator">-&gt;</span>FMI <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDTR <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Get the data field */</span>
  RxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDLR<span class="token punctuation">;</span>
  RxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDLR <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  RxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDLR <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  RxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDLR <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  RxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDHR<span class="token punctuation">;</span>
  RxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDHR <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  RxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDHR <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  RxMessage<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CANx<span class="token operator">-&gt;</span>sFIFOMailBox<span class="token punctuation">[</span>FIFONumber<span class="token punctuation">]</span><span class="token punctuation">.</span>RDHR <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Release the FIFO */</span>
  <span class="token comment">/* Release FIFO0 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>FIFONumber <span class="token operator">==</span> CAN_FIFO0<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    CANx<span class="token operator">-&gt;</span>RF0R <span class="token operator">|=</span> CAN_RF0R_RFOM0<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* Release FIFO1 */</span>
  <span class="token keyword">else</span> <span class="token comment">/* FIFONumber == CAN_FIFO1 */</span>
  <span class="token punctuation">{<!-- --></span>
    CANx<span class="token operator">-&gt;</span>RF1R <span class="token operator">|=</span> CAN_RF1R_RFOM1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_805"></a>分析</h4> 
<p>获取接收消息的标识符类型，通过读取接收FIFO邮箱标识符寄存器CAN_RIR的位IDE获得。如果是标准帧，则取CAN_RIR的STID共11位为标准ID；如果是扩展帧，则取CAN_RIR的EXID共29位为扩展ID。数据长度DLC由接收FIFO邮箱数据长度和时间戳寄存器CAN_RDTR的位DLC获得。数据内容从接收FIFO邮箱低字节数据寄存器CAN_RDLR和高字节数据寄存器CAN_RDHR获得。最后进行释放邮箱的操作，这一步很重要，否则邮箱中有多条消息时无法读到第二条、第三条消息。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8e8026a8a05035f102a40e391796d1f5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【困惑实验记录】对图像操作选用PIL还是cv2？答：最好还是PIL吧</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/85f8134bd14e23a7559c698d4ba622d5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MATLAB如何换行</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>