<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android CameraX适配Android13的踩坑之路 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android CameraX适配Android13的踩坑之路" />
<meta property="og:description" content="AndroidCameraX适配Android13的踩坑之路 前言： 最近把AGP插件升级到8.1.0，新建项目的时候目标版本和编译版本都是33，发现之前的demo使用Camerax拍照和录像都失败了，于是查看了一下官网和各种资料，找到了Android13的适配方案.
行为变更：以 Android 13 或更高版本为目标平台的应用 与早期版本一样，Android 13 包含一些行为变更，这些变更可能会影响您的应用。以下行为变更仅影响以 Android 13 或更高版本为目标平台的应用。如果您的应用以 Android 13 或更高版本为目标平台，您应该修改自己的应用以适当地支持这些行为（如果适用）。
此外，请务必查看对 Android 13 上运行的所有应用都有影响的行为变更列表。
细化的媒体权限 该对话框的两个按钮，从上至下分别为“Allow”和“Don’t allow”
图 1. 您在请求 READ_MEDIA_AUDIO 权限时向用户显示的系统权限对话框。
如果您的应用以 Android 13 或更高版本为目标平台，并且需要访问其他应用已经创建的媒体文件，您必须请求以下一项或多项细化的媒体权限，而不是READ_EXTERNAL_STORAGE 权限：
媒体类型请求权限图片和照片READ_MEDIA_IMAGES视频READ_MEDIA_VIDEO音频文件READ_MEDIA_AUDIO 如果用户之前向您的应用授予了 READ_EXTERNAL_STORAGE 权限，系统会自动向您的应用授予细化的媒体权限。否则，当应用请求上表中显示的任何权限时，系统会显示面向用户的对话框。在图 1 中，应用请求 READ_MEDIA_AUDIO 权限。
如果您同时请求 READ_MEDIA_IMAGES 权限和 READ_MEDIA_VIDEO 权限，系统只会显示一个系统权限对话框。
1.参考资料如下: https://developer.android.google.cn/about/versions/13/features?hl=zh-cn
https://blog.csdn.net/as425017946/article/details/127530660
https://blog.csdn.net/guolin_blog/article/details/127024559
2.依赖导入： 这里的依赖都是基于AGP8.1.0，Android Studio的插件版本 Gifaffe 2022.3.1
2.1 添加统一的CameraX依赖配置: 在项目的gradle目录下新建libs.version.toml文件
2.2 添加CameraX依赖： [versions] agp = &#34;8.1.0&#34; org-jetbrains-kotlin-android = &#34;1.8.0&#34; core-ktx = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/029ed52f4bc841f5d4528c58f95fbb9c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-13T19:19:00+08:00" />
<meta property="article:modified_time" content="2023-12-13T19:19:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android CameraX适配Android13的踩坑之路</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="AndroidCameraXAndroid13_2"></a>AndroidCameraX适配Android13的踩坑之路</h2> 
<p><img src="https://images2.imgbox.com/7b/89/vSKtkaMQ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_6"></a>前言：</h2> 
<p>最近把AGP插件升级到8.1.0，新建项目的时候目标版本和编译版本都是33，发现之前的demo使用Camerax拍照和录像都失败了，于是查看了一下官网和各种资料，找到了Android13的适配方案.</p> 
<h2><a id="_Android_13__10"></a>行为变更：以 Android 13 或更高版本为目标平台的应用</h2> 
<p>与早期版本一样，Android 13 包含一些行为变更，这些变更可能会影响您的应用。以下行为变更仅影响以 Android 13 或更高版本为目标平台的应用。如果您的应用以 Android 13 或更高版本为目标平台，您应该修改自己的应用以适当地支持这些行为（如果适用）。</p> 
<p>此外，请务必查看<a href="https://developer.android.google.cn/about/versions/13/behavior-changes-all?hl=zh-cn" rel="nofollow">对 Android 13 上运行的所有应用都有影响的行为变更</a>列表。</p> 
<h2><a id="_17"></a>细化的媒体权限</h2> 
<p><img src="https://images2.imgbox.com/b4/91/c5YyzoKe_o.png" alt="在这里插入图片描述"><br> 该对话框的两个按钮，从上至下分别为“Allow”和“Don’t allow”<br> <strong>图 1.</strong> 您在请求 <code>READ_MEDIA_AUDIO</code> 权限时向用户显示的系统权限对话框。</p> 
<p>如果您的应用以 Android 13 或更高版本为目标平台，并且需要<a href="https://developer.android.google.cn/training/data-storage/shared/media?hl=zh-cn#storage-permission" rel="nofollow">访问其他应用已经创建的媒体文件</a>，您必须请求以下一项或多项细化的媒体权限，而不是<a href="https://developer.android.google.cn/reference/android/Manifest.permission?hl=zh-cn#READ_EXTERNAL_STORAGE" rel="nofollow"><code>READ_EXTERNAL_STORAGE</code></a> 权限：</p> 
<table><thead><tr><th align="left">媒体类型</th><th align="left">请求权限</th></tr></thead><tbody><tr><td align="left">图片和照片</td><td align="left"><a href="https://developer.android.google.cn/reference/android/Manifest.permission?hl=zh-cn#READ_MEDIA_IMAGES" rel="nofollow"><code>READ_MEDIA_IMAGES</code></a></td></tr><tr><td align="left">视频</td><td align="left"><a href="https://developer.android.google.cn/reference/android/Manifest.permission?hl=zh-cn#READ_MEDIA_VIDEO" rel="nofollow"><code>READ_MEDIA_VIDEO</code></a></td></tr><tr><td align="left">音频文件</td><td align="left"><a href="https://developer.android.google.cn/reference/android/Manifest.permission?hl=zh-cn#READ_MEDIA_AUDIO" rel="nofollow"><code>READ_MEDIA_AUDIO</code></a></td></tr></tbody></table> 
<p>如果用户之前向您的应用授予了 <code>READ_EXTERNAL_STORAGE</code> 权限，系统会自动向您的应用授予细化的媒体权限。否则，当应用请求上表中显示的任何权限时，系统会显示面向用户的对话框。在图 1 中，应用请求 <code>READ_MEDIA_AUDIO</code> 权限。</p> 
<p>如果您同时请求 <code>READ_MEDIA_IMAGES</code> 权限和 <code>READ_MEDIA_VIDEO</code> 权限，系统只会显示一个系统权限对话框。</p> 
<h2><a id="1_33"></a>1.参考资料如下:</h2> 
<p><a href="https://developer.android.google.cn/about/versions/13/features?hl=zh-cn" rel="nofollow">https://developer.android.google.cn/about/versions/13/features?hl=zh-cn</a></p> 
<p><a href="https://blog.csdn.net/as425017946/article/details/127530660">https://blog.csdn.net/as425017946/article/details/127530660</a></p> 
<p><a href="https://blog.csdn.net/guolin_blog/article/details/127024559">https://blog.csdn.net/guolin_blog/article/details/127024559</a></p> 
<h2><a id="2_41"></a>2.依赖导入：</h2> 
<p>这里的依赖都是基于AGP8.1.0，Android Studio的插件版本 Gifaffe 2022.3.1</p> 
<h3><a id="21_CameraX_45"></a>2.1 添加统一的CameraX依赖配置:</h3> 
<p>在项目的gradle目录下新建libs.version.toml文件<br> <img src="https://images2.imgbox.com/09/59/avk5XaK9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22_CameraX_50"></a>2.2 添加CameraX依赖：</h3> 
<pre><code class="prism language-kotlin"><span class="token punctuation">[</span>versions<span class="token punctuation">]</span>
agp <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"8.1.0"</span></span>
org<span class="token operator">-</span>jetbrains<span class="token operator">-</span>kotlin<span class="token operator">-</span>android <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.8.0"</span></span>
core<span class="token operator">-</span>ktx <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.10.1"</span></span>
junit <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"4.13.2"</span></span>
androidx<span class="token operator">-</span>test<span class="token operator">-</span>ext<span class="token operator">-</span>junit <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.1.5"</span></span>
espresso<span class="token operator">-</span>core <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"3.5.1"</span></span>
appcompat <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.6.1"</span></span>
material <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.9.0"</span></span>
constraintlayout <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"2.1.4"</span></span>
glide <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"4.13.0"</span></span>
glide<span class="token operator">-</span>compiler <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"4.13.0"</span></span>
camerax <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.1.0-beta03"</span></span>
camerax<span class="token operator">-</span>core <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.1.0-beta03"</span></span>
camerax<span class="token operator">-</span>video <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.1.0-beta03"</span></span>
camerax<span class="token operator">-</span>view <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.1.0-beta03"</span></span>
camerax<span class="token operator">-</span>extensions <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.1.0-beta03"</span></span>
camerax<span class="token operator">-</span>lifecycle <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.1.0-beta03"</span></span>


<span class="token punctuation">[</span>libraries<span class="token punctuation">]</span>
core<span class="token operator">-</span>ktx <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.core"</span></span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"core-ktx"</span></span><span class="token punctuation">,</span> version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"core-ktx"</span></span> <span class="token punctuation">}</span>
junit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"junit"</span></span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"junit"</span></span><span class="token punctuation">,</span> version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"junit"</span></span> <span class="token punctuation">}</span>
androidx<span class="token operator">-</span>test<span class="token operator">-</span>ext<span class="token operator">-</span>junit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.test.ext"</span></span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"junit"</span></span><span class="token punctuation">,</span> version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx-test-ext-junit"</span></span> <span class="token punctuation">}</span>
espresso<span class="token operator">-</span>core <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.test.espresso"</span></span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"espresso-core"</span></span><span class="token punctuation">,</span> version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"espresso-core"</span></span> <span class="token punctuation">}</span>
appcompat <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.appcompat"</span></span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"appcompat"</span></span><span class="token punctuation">,</span> version <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.6.1"</span></span> <span class="token punctuation">}</span>
material <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"com.google.android.material"</span></span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"material"</span></span><span class="token punctuation">,</span> version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"material"</span></span> <span class="token punctuation">}</span>
constraintlayout <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.constraintlayout"</span></span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"constraintlayout"</span></span><span class="token punctuation">,</span> version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"constraintlayout"</span></span> <span class="token punctuation">}</span>
glide <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"com.github.bumptech.glide"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"glide"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"glide"</span></span><span class="token punctuation">}</span>
camerax <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.camera"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camera-camera2"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camerax"</span></span> <span class="token punctuation">}</span>
camerax<span class="token operator">-</span>core <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.camera"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camera-core"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camerax-core"</span></span><span class="token punctuation">}</span>
camerax<span class="token operator">-</span>video <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.camera"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camera-video"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camerax-video"</span></span><span class="token punctuation">}</span>
camerax<span class="token operator">-</span>view <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.camera"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camera-view"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camerax-view"</span></span><span class="token punctuation">}</span>
camerax<span class="token operator">-</span>extensions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.camera"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camera-extensions"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camerax-extensions"</span></span><span class="token punctuation">}</span>
camerax<span class="token operator">-</span>lifecycle <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"androidx.camera"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camera-lifecycle"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"camerax-lifecycle"</span></span><span class="token punctuation">}</span>
kotlin<span class="token operator">-</span>stdlib <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"org.jetbrains.kotlin"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"kotlin-stdlib-jdk7"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"kotlin-stdlib"</span></span><span class="token punctuation">}</span>
kotlin<span class="token operator">-</span>reflect <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"org.jetbrains.kotlin"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"kotlin-reflect"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"kotlin-reflect"</span></span><span class="token punctuation">}</span>
kotlinx<span class="token operator">-</span>coroutines<span class="token operator">-</span>core <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"org.jetbrains.kotlin"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"kotlinx-coroutines-core"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"kotlinx-coroutines-core"</span></span><span class="token punctuation">}</span>
kotlin<span class="token operator">-</span>kotlinx<span class="token operator">-</span>coroutines<span class="token operator">-</span>android <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"org.jetbrains.kotlin"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"kotlinx-coroutines-androidt"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"kotlinx-coroutines-android"</span></span><span class="token punctuation">}</span>
glide<span class="token operator">-</span>compiler <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"com.github.bumptech.glide"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"compiler"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"glide-compiler"</span></span><span class="token punctuation">}</span>
utilcodex <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>group <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"com.blankj"</span></span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"utilcodex"</span></span><span class="token punctuation">,</span>version<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"utilcodex"</span></span><span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/a4/db/5wUxguwY_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_appbuildgradle_100"></a>2.3 在app的build.gradle目录下引入依赖：</h3> 
<pre><code class="prism language-kotlin">dependencies <span class="token punctuation">{<!-- --></span>

    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>core<span class="token punctuation">.</span>ktx<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>appcompat<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>material<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>constraintlayout<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>glide<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>camerax<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>camerax<span class="token punctuation">.</span>core<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>camerax<span class="token punctuation">.</span>view<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>camerax<span class="token punctuation">.</span>extensions<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>camerax<span class="token punctuation">.</span>lifecycle<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>camerax<span class="token punctuation">.</span>video<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>kotlin<span class="token punctuation">.</span>stdlib<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>kotlin<span class="token punctuation">.</span>reflect<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>utilcodex<span class="token punctuation">)</span>
    <span class="token function">testImplementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>junit<span class="token punctuation">)</span>
    <span class="token function">androidTestImplementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>androidx<span class="token punctuation">.</span>test<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>junit<span class="token punctuation">)</span>
    <span class="token function">androidTestImplementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>espresso<span class="token punctuation">.</span>core<span class="token punctuation">)</span>
    <span class="token function">annotationProcessor</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>compiler<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6a/0c/JNiv1YDm_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_130"></a>3.主界面布局文件如下：</h2> 
<pre><code class="prism language-kotlin"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"1.0"</span></span> encoding<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"utf-8"</span></span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>androidx<span class="token punctuation">.</span>constraintlayout<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>ConstraintLayout xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"http://schemas.android.com/apk/res/android"</span></span>
    xmlns<span class="token operator">:</span>app<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"http://schemas.android.com/apk/res-auto"</span></span>
    xmlns<span class="token operator">:</span>tools<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"http://schemas.android.com/tools"</span></span>
    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"match_parent"</span></span>
    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"match_parent"</span></span>
    tools<span class="token operator">:</span>context<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">".MainActivity"</span></span><span class="token operator">&gt;</span>


    <span class="token operator">&lt;</span>androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>view<span class="token punctuation">.</span>PreviewView
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/mPreviewView"</span></span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"0dp"</span></span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"0dp"</span></span>
        app<span class="token operator">:</span>layout_constraintBottom_toBottomOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span>
        app<span class="token operator">:</span>layout_constraintLeft_toLeftOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span>
        app<span class="token operator">:</span>layout_constraintRight_toRightOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span>
        app<span class="token operator">:</span>layout_constraintTop_toTopOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>Button
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnCameraCapture"</span></span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"0dp"</span></span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"50dp"</span></span>
        android<span class="token operator">:</span>layout_marginBottom<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"50dp"</span></span>
        android<span class="token operator">:</span>background<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@color/colorPrimaryDark"</span></span>
        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"拍照"</span></span>
        android<span class="token operator">:</span>textColor<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@color/white"</span></span>
        android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"16sp"</span></span>
        app<span class="token operator">:</span>layout_constraintBottom_toBottomOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span>
        app<span class="token operator">:</span>layout_constraintLeft_toLeftOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span>
        app<span class="token operator">:</span>layout_constraintRight_toLeftOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnVideo"</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>Button
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnVideo"</span></span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"0dp"</span></span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"50dp"</span></span>
        android<span class="token operator">:</span>layout_marginStart<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"10dp"</span></span>
        android<span class="token operator">:</span>layout_marginBottom<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"50dp"</span></span>
        android<span class="token operator">:</span>background<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@color/colorPrimaryDark"</span></span>
        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"录像"</span></span>
        android<span class="token operator">:</span>textColor<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@color/white"</span></span>
        android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"16sp"</span></span>
        app<span class="token operator">:</span>layout_constraintBottom_toBottomOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span>
        app<span class="token operator">:</span>layout_constraintLeft_toRightOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnCameraCapture"</span></span>
        app<span class="token operator">:</span>layout_constraintRight_toLeftOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnSwitch"</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>Button
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnSwitch"</span></span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"0dp"</span></span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"50dp"</span></span>
        android<span class="token operator">:</span>layout_marginStart<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"10dp"</span></span>
        android<span class="token operator">:</span>layout_marginBottom<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"50dp"</span></span>
        android<span class="token operator">:</span>background<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@color/colorPrimaryDark"</span></span>
        android<span class="token operator">:</span>gravity<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"center"</span></span>
        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"切换镜头"</span></span>
        android<span class="token operator">:</span>textColor<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@color/white"</span></span>
        android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"16sp"</span></span>
        app<span class="token operator">:</span>layout_constraintBottom_toBottomOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span>
        app<span class="token operator">:</span>layout_constraintLeft_toRightOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnVideo"</span></span>
        app<span class="token operator">:</span>layout_constraintRight_toRightOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>Button
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnOpenCamera"</span></span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"200dp"</span></span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"50dp"</span></span>
        android<span class="token operator">:</span>background<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@color/colorPrimaryDark"</span></span>
        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"进入相机拍照界面"</span></span>
        android<span class="token operator">:</span>textColor<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@color/white"</span></span>
        android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"16sp"</span></span>
        tools<span class="token operator">:</span>ignore<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"MissingConstraints"</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>


<span class="token operator">&lt;</span><span class="token operator">/</span>androidx<span class="token punctuation">.</span>constraintlayout<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>ConstraintLayout<span class="token operator">&gt;</span>
</code></pre> 
<h2><a id="4_207"></a>4.选择相机界面布局如下：</h2> 
<pre><code class="prism language-kotlin"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"1.0"</span></span> encoding<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"utf-8"</span></span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>androidx<span class="token punctuation">.</span>constraintlayout<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>ConstraintLayout xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"http://schemas.android.com/apk/res/android"</span></span>
    xmlns<span class="token operator">:</span>tools<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"http://schemas.android.com/tools"</span></span>
    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"match_parent"</span></span>
    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"match_parent"</span></span>
    xmlns<span class="token operator">:</span>app<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"http://schemas.android.com/apk/res-auto"</span></span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Button
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnCamera"</span></span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"0dp"</span></span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"wrap_content"</span></span>
        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"打开相机"</span></span>
        tools<span class="token operator">:</span>ignore<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"MissingConstraints"</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>ImageView
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/iv_avatar"</span></span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"100dp"</span></span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"100dp"</span></span>
        android<span class="token operator">:</span>layout_marginStart<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"20dp"</span></span>
        android<span class="token operator">:</span>layout_marginTop<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"20dp"</span></span>
        android<span class="token operator">:</span>background<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@mipmap/ic_launcher"</span></span>
        app<span class="token operator">:</span>layout_constraintLeft_toRightOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"@+id/btnCamera"</span></span>
        app<span class="token operator">:</span>layout_constraintTop_toTopOf<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"parent"</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>androidx<span class="token punctuation">.</span>constraintlayout<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>ConstraintLayout<span class="token operator">&gt;</span>
</code></pre> 
<h2><a id="5Android13_235"></a>5.Android13权限适配:</h2> 
<p>Android13相较于之前的版本变化很大，细化了权限请求，具体的参考上面的官网资料，直接上代码：</p> 
<h3><a id="51_Android13_239"></a>5.1 Android13之前的适配：</h3> 
<p>可以看到，API 32也就是Android 12及以下系统，我们仍然声明的是READ_EXTERNAL_STORAGE权限。</p> 
<p><img src="https://images2.imgbox.com/02/18/hdaFN6JL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="52_Android13_246"></a>5.2 Android13及以上的适配：</h3> 
<p>从Android 13开始，我们就会使用READ_MEDIA_IMAGES、READ_MEDIA_VIDEO、READ_MEDIA_AUDIO来替代了。</p> 
<pre><code>&lt;!--存储图像或者视频权限--&gt;
&lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
    android:maxSdkVersion="32" /&gt;
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
    tools:ignore="ScopedStorage" android:maxSdkVersion="32"/&gt;
&lt;uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"
    android:maxSdkVersion="32"
    tools:ignore="ScopedStorage" /&gt;
&lt;!--录制音频权限--&gt;
&lt;uses-permission android:name="android.permission.RECORD_AUDIO"/&gt;
&lt;uses-permission android:name="android.permission.READ_MEDIA_IMAGES"/&gt;
&lt;uses-permission android:name="android.permission.READ_MEDIA_AUDIO"/&gt;
&lt;uses-permission android:name="android.permission.READ_MEDIA_VIDEO"/&gt;
</code></pre> 
<h2><a id="6_266"></a>6.项目中简单适配：</h2> 
<h3><a id="61_Android13_268"></a>6.1 Android13之前权限请求如下：</h3> 
<pre><code class="prism language-kotlin"><span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"RestrictedApi"</span></span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">allPermissionsGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ImageCapture</span>
        <span class="token function">startCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span> REQUIRED_PERMISSIONS<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">allPermissionsGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> REQUIRED_PERMISSIONS<span class="token punctuation">.</span><span class="token function">all</span> <span class="token punctuation">{<!-- --></span>
        ContextCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>baseContext<span class="token punctuation">,</span> it<span class="token punctuation">)</span> <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
        requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span> permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> grantResults<span class="token operator">:</span>
        IntArray
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">==</span> Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">allPermissionsGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">startCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"请您打开必要权限"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="62_Android13_302"></a>6.2 Android13及以上的版本权限请求适配如下：</h3> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ImageCapture</span>
        <span class="token function">startCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Android13检查权限进行了细化，每个需要单独申请，这里我有拍照和录像，所以加入相机和录像权限
 *
 **/</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
            Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> <span class="token number">33</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> permissions <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_IMAGES<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_AUDIO<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_VIDEO<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>RECORD_AUDIO<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> permissions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> Environment<span class="token punctuation">.</span><span class="token function">isExternalStorageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> REQUIRED_PERMISSIONS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>
                            <span class="token keyword">this</span><span class="token punctuation">,</span>
                            permission
                        <span class="token punctuation">)</span> <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
                    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
	
 <span class="token comment">/**
  * 用户拒绝后请求权限需要同时申请，刚开始我是单独申请的调试后发现一直报错，所以改为一起申请
  *
  **/</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
            Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> <span class="token number">33</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">,</span>
                 <span class="token function">arrayOf</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_IMAGES<span class="token punctuation">,</span>
                         Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_AUDIO<span class="token punctuation">,</span>
                         Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_VIDEO<span class="token punctuation">,</span>
                         Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">,</span>
                         Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>RECORD_AUDIO<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> 
                REQUIRED_PERMISSIONS<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

 <span class="token comment">/**
  *用户请求权限后的回调，这里我是测试demo,所以用户拒绝后我会重复请求，真实项目根自己的需求来动态申请
  *
  **/</span>
 <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
        requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span> permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> grantResults<span class="token operator">:</span>
        IntArray
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span>
                <span class="token keyword">when</span> <span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">var</span> allPermissionsGranted <span class="token operator">=</span> <span class="token boolean">true</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>result <span class="token keyword">in</span> grantResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                allPermissionsGranted <span class="token operator">=</span> <span class="token boolean">false</span>
                                <span class="token keyword">break</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
                            allPermissionsGranted <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// 权限已授予，执行文件读写操作</span>
                                <span class="token function">startCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// 权限被拒绝，处理权限请求失败的情况</span>
                                ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"请您打开必要权限"</span></span><span class="token punctuation">)</span>
                                <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="7_408"></a>7.拍照和录像代码：</h2> 
<h3><a id="71__410"></a>7.1 拍照:</h3> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
 * 开始拍照
 */</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> imageCapture <span class="token operator">=</span> imageCamera <span class="token operator">?:</span> <span class="token keyword">return</span>
    <span class="token keyword">val</span> photoFile <span class="token operator">=</span> <span class="token function">createFile</span><span class="token punctuation">(</span>outputDirectory<span class="token punctuation">,</span> DATE_FORMAT<span class="token punctuation">,</span> PHOTO_EXTENSION<span class="token punctuation">)</span>
    <span class="token keyword">val</span> metadata <span class="token operator">=</span> ImageCapture<span class="token punctuation">.</span><span class="token function">Metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Mirror image when using the front camera</span>
        isReversedHorizontal <span class="token operator">=</span> lensFacing <span class="token operator">==</span> CameraSelector<span class="token punctuation">.</span>LENS_FACING_FRONT
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> outputOptions <span class="token operator">=</span>
        ImageCapture<span class="token punctuation">.</span>OutputFileOptions<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>photoFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMetadata</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    imageCapture<span class="token punctuation">.</span><span class="token function">takePicture</span><span class="token punctuation">(</span>outputOptions<span class="token punctuation">,</span> ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">object</span> <span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span><span class="token function">OnImageSavedCallback</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>exc<span class="token operator">:</span> ImageCaptureException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Photo capture failed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">exc<span class="token punctuation">.</span>message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> exc<span class="token punctuation">)</span>
                ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 拍照失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">exc<span class="token punctuation">.</span>message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onImageSaved</span><span class="token punctuation">(</span>output<span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span>OutputFileResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> savedUri <span class="token operator">=</span> output<span class="token punctuation">.</span>savedUri <span class="token operator">?:</span> Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>photoFile<span class="token punctuation">)</span>
                ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 拍照成功 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">savedUri</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> savedUri<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> mimeType <span class="token operator">=</span> MimeTypeMap<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getMimeTypeFromExtension</span><span class="token punctuation">(</span>savedUri<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extension<span class="token punctuation">)</span>
                MediaScannerConnection<span class="token punctuation">.</span><span class="token function">scanFile</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">,</span>
                    <span class="token function">arrayOf</span><span class="token punctuation">(</span>savedUri<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">arrayOf</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> _<span class="token punctuation">,</span> uri <span class="token operator">-&gt;</span>
                    LogUtils<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>
                        TAG<span class="token punctuation">,</span>
                        <span class="token string-literal singleline"><span class="token string">"Image capture scanned into media store: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">uri<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="72__453"></a>7.2 录像：</h3> 
<p>之前的版本很老还在测试阶段，所以官方api发生了一些改变：</p> 
<p>旧的api示例如下：</p> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
 * 开始录像
 */</span>
<span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"RestrictedApi"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"ClickableViewAccessibility"</span></span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">takeVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    isRecordVideo <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">val</span> mFileDateFormat <span class="token operator">=</span> <span class="token function">SimpleDateFormat</span><span class="token punctuation">(</span>DATE_FORMAT<span class="token punctuation">,</span> Locale<span class="token punctuation">.</span>US<span class="token punctuation">)</span>
    <span class="token comment">//视频保存路径</span>
    <span class="token keyword">val</span> file <span class="token operator">=</span> <span class="token function">File</span><span class="token punctuation">(</span>FileManager<span class="token punctuation">.</span><span class="token function">getCameraVideoPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mFileDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">".mp4"</span></span><span class="token punctuation">)</span>
    <span class="token comment">//开始录像</span>
    videoCapture<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">startRecording</span><span class="token punctuation">(</span>
        file<span class="token punctuation">,</span>
        Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">object</span> <span class="token operator">:</span> OnVideoSavedCallback <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onVideoSaved</span><span class="token punctuation">(</span><span class="token annotation builtin">@NonNull</span> file<span class="token operator">:</span> File<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                isRecordVideo <span class="token operator">=</span> <span class="token boolean">false</span>
                LogUtils<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"===视频保存的地址为=== </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">file<span class="token punctuation">.</span>absolutePath</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token comment">//保存视频成功回调，会在停止录制时被调用</span>
                ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 录像成功 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">file</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>videoCaptureError<span class="token operator">:</span> Int<span class="token punctuation">,</span> message<span class="token operator">:</span> String<span class="token punctuation">,</span> cause<span class="token operator">:</span> Throwable<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//保存失败的回调，可能在开始或结束录制时被调用</span>
                isRecordVideo <span class="token operator">=</span> <span class="token boolean">false</span>
                LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"onError: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 录像失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>新的api示例如下：</p> 
<p>startRecording方法参数发生了一些变化：第一个参数是传入一个文件输出信息类，之前是直接传入文件，其实影响不大</p> 
<p>我们通过val outputOptions = OutputFileOptions.Builder(file)这个类构建一个对象，然后在开始录像时传入即可.</p> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
 * 开始录像
 */</span>
<span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"RestrictedApi"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"ClickableViewAccessibility"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"MissingPermission"</span></span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">takeVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//开始录像</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        isRecordVideo <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">val</span> mFileDateFormat <span class="token operator">=</span> <span class="token function">SimpleDateFormat</span><span class="token punctuation">(</span>DATE_FORMAT<span class="token punctuation">,</span> Locale<span class="token punctuation">.</span>US<span class="token punctuation">)</span>
        <span class="token comment">//视频保存路径</span>
        <span class="token keyword">val</span> file <span class="token operator">=</span>
            <span class="token function">File</span><span class="token punctuation">(</span>FileManager<span class="token punctuation">.</span><span class="token function">getCameraVideoPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mFileDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">".mp4"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> outputOptions <span class="token operator">=</span> OutputFileOptions<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        videoCapture<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">startRecording</span><span class="token punctuation">(</span>
            outputOptions<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">object</span> <span class="token operator">:</span> OnVideoSavedCallback <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onVideoSaved</span><span class="token punctuation">(</span>outputFileResults<span class="token operator">:</span> VideoCapture<span class="token punctuation">.</span>OutputFileResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    isRecordVideo <span class="token operator">=</span> <span class="token boolean">false</span>
                    LogUtils<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"===视频保存的地址为=== </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">file<span class="token punctuation">.</span>absolutePath</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    <span class="token comment">//保存视频成功回调，会在停止录制时被调用</span>
                    ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 录像成功 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">file</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>
                    videoCaptureError<span class="token operator">:</span> Int<span class="token punctuation">,</span>
                    message<span class="token operator">:</span> String<span class="token punctuation">,</span>
                    cause<span class="token operator">:</span> Throwable<span class="token operator">?</span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//保存失败的回调，可能在开始或结束录制时被调用</span>
                    isRecordVideo <span class="token operator">=</span> <span class="token boolean">false</span>
                    LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"onError: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 录像失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"===录像出错===</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">e<span class="token punctuation">.</span>message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="73__540"></a>7.3 停止录像：</h3> 
<p>这里通过isRecordVideo是否正在录像进行录像和停止录像的操作</p> 
<pre><code class="prism language-kotlin">btnVideo<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRecordVideo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">takeVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        isRecordVideo <span class="token operator">=</span> <span class="token boolean">true</span>
        btnVideo<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"停止录像"</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        isRecordVideo <span class="token operator">=</span> <span class="token boolean">false</span>
        videoCapture<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">stopRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//停止录制</span>
        <span class="token comment">//preview?.clear()//清除预览</span>
        btnVideo<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"开始录像"</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="8_559"></a>8.常量工具类：</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">object</span> Constants <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> REQUEST_CODE_PERMISSIONS <span class="token operator">=</span> <span class="token number">101</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> REQUEST_CODE_CAMERA <span class="token operator">=</span> <span class="token number">102</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> REQUEST_CODE_CROP <span class="token operator">=</span> <span class="token number">103</span>

    <span class="token keyword">const</span> <span class="token keyword">val</span> DATE_FORMAT <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"yyyy-MM-dd HH-mm-ss"</span></span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> PHOTO_EXTENSION <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">".jpg"</span></span>

    <span class="token keyword">val</span> REQUIRED_PERMISSIONS <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
        Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">,</span>
        Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>WRITE_EXTERNAL_STORAGE<span class="token punctuation">,</span>
        Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_EXTERNAL_STORAGE<span class="token punctuation">,</span>
        Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>RECORD_AUDIO
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="9ToastUtils_579"></a>9.ToastUtils:</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils

<span class="token keyword">import</span> android<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>SuppressLint
<span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Activity
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Looper
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Message
<span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log
<span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>Gravity
<span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Toast
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>StringRes
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>app<span class="token punctuation">.</span>CameraApp
<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field

<span class="token comment">/**
 *@author: njb
 *@date:   2023/8/15 17:13
 *@desc:
 */</span>
<span class="token keyword">object</span> ToastUtils <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> TAG <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"ToastUtil"</span></span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mToast<span class="token operator">:</span> Toast<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> sField_TN<span class="token operator">:</span> Field<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> sField_TN_Handler<span class="token operator">:</span> Field<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> sIsHookFieldInit <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> FIELD_NAME_TN <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"mTN"</span></span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> FIELD_NAME_HANDLER <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"mHandler"</span></span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">showToast</span><span class="token punctuation">(</span>
        context<span class="token operator">:</span> Context<span class="token punctuation">,</span> text<span class="token operator">:</span> CharSequence<span class="token punctuation">,</span>
        duration<span class="token operator">:</span> Int<span class="token punctuation">,</span> isShowCenterFlag<span class="token operator">:</span> Boolean
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> toastRunnable <span class="token operator">=</span> <span class="token function">ToastRunnable</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> text<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> isShowCenterFlag<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">is</span> Activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>isFinishing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                context<span class="token punctuation">.</span><span class="token function">runOnUiThread</span><span class="token punctuation">(</span>toastRunnable<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> handler <span class="token operator">=</span> <span class="token function">Handler</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>mainLooper<span class="token punctuation">)</span>
            handler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>toastRunnable<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">shortToast</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> text<span class="token operator">:</span> CharSequence<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">showToast</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> text<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">longToast</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> text<span class="token operator">:</span> CharSequence<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">showToast</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> text<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">shortToast</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">showToast</span><span class="token punctuation">(</span>CameraApp<span class="token punctuation">.</span>mInstance<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token annotation builtin">@StringRes</span> resId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">showToast</span><span class="token punctuation">(</span>
            CameraApp<span class="token punctuation">.</span>mInstance<span class="token punctuation">,</span> CameraApp<span class="token punctuation">.</span>mInstance<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span>resId<span class="token punctuation">)</span><span class="token punctuation">,</span>
            Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">centerShortToast</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">showToast</span><span class="token punctuation">(</span>CameraApp<span class="token punctuation">.</span>mInstance<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">centerShortToast</span><span class="token punctuation">(</span><span class="token annotation builtin">@StringRes</span> resId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">showToast</span><span class="token punctuation">(</span>
            CameraApp<span class="token punctuation">.</span>mInstance<span class="token punctuation">,</span> CameraApp<span class="token punctuation">.</span>mInstance<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span>resId<span class="token punctuation">)</span><span class="token punctuation">,</span>
            Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">,</span> <span class="token boolean">true</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">cancelToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> looper <span class="token operator">=</span> Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>looper<span class="token punctuation">.</span>thread <span class="token operator">===</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mToast<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">Handler</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{<!-- --></span> mToast<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"SoonBlockedPrivateApi"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">hookToast</span><span class="token punctuation">(</span>toast<span class="token operator">:</span> Toast<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sIsHookFieldInit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sField_TN <span class="token operator">=</span> Toast<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>FIELD_NAME_TN<span class="token punctuation">)</span>
                sField_TN<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">run</span> <span class="token punctuation">{<!-- --></span>
                    isAccessible <span class="token operator">=</span> <span class="token boolean">true</span>
                    sField_TN_Handler <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>FIELD_NAME_HANDLER<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                sField_TN_Handler<span class="token operator">?</span><span class="token punctuation">.</span>isAccessible <span class="token operator">=</span> <span class="token boolean">true</span>
                sIsHookFieldInit <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">val</span> tn <span class="token operator">=</span> sField_TN<span class="token operator">!!</span><span class="token punctuation">[</span>toast<span class="token punctuation">]</span>
            <span class="token keyword">val</span> originHandler <span class="token operator">=</span> sField_TN_Handler<span class="token operator">!!</span><span class="token punctuation">[</span>tn<span class="token punctuation">]</span> <span class="token keyword">as</span> Handler
            sField_TN_Handler<span class="token operator">!!</span><span class="token punctuation">[</span>tn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SafelyHandlerWrapper</span><span class="token punctuation">(</span>originHandler<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Hook toast exception=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">e</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token function">ToastRunnable</span><span class="token punctuation">(</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> text<span class="token operator">:</span> CharSequence<span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> duration<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> isShowCenter<span class="token operator">:</span> Boolean
    <span class="token punctuation">)</span> <span class="token operator">:</span> Runnable <span class="token punctuation">{<!-- --></span>
        <span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"ShowToast"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mToast <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mToast <span class="token operator">=</span> Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> text<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                mToast<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isShowCenter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mToast<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">setGravity</span><span class="token punctuation">(</span>Gravity<span class="token punctuation">.</span>CENTER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                mToast<span class="token operator">!!</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> duration
            <span class="token punctuation">}</span>
            <span class="token function">hookToast</span><span class="token punctuation">(</span>mToast<span class="token punctuation">)</span>
            mToast<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token function">SafelyHandlerWrapper</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> originHandler<span class="token operator">:</span> Handler<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Catch system toast exception:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">e</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            originHandler<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="10FileManager_722"></a>10.FileManager:</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">;</span>

<span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Activity<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>ContentResolver<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>ContentUris<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>ContentValues<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Intent<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>database<span class="token punctuation">.</span>Cursor<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Uri<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Environment<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>DocumentsContract<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>MediaStore<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>text<span class="token punctuation">.</span>TextUtils<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">;</span>

<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>NonNull<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>app<span class="token punctuation">.</span>CameraApp<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: njb
 * @date: 2023/8/15 17:13
 * @desc:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> FileManager <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 媒体模块根目录</span>
    <span class="token keyword">private</span> static <span class="token keyword">final</span> String SAVE_MEDIA_ROOT_DIR <span class="token operator">=</span> Environment<span class="token punctuation">.</span>DIRECTORY_DCIM<span class="token punctuation">;</span>
    <span class="token comment">// 媒体模块存储路径</span>
    <span class="token keyword">private</span> static <span class="token keyword">final</span> String SAVE_MEDIA_DIR <span class="token operator">=</span> SAVE_MEDIA_ROOT_DIR <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/CameraXApp"</span></span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> static <span class="token keyword">final</span> String AVATAR_DIR <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"/avatar"</span></span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> static <span class="token keyword">final</span> String SAVE_MEDIA_VIDEO_DIR <span class="token operator">=</span> SAVE_MEDIA_DIR <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/video"</span></span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> static <span class="token keyword">final</span> String SAVE_MEDIA_PHOTO_DIR <span class="token operator">=</span> SAVE_MEDIA_DIR <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/photo"</span></span><span class="token punctuation">;</span>
    <span class="token comment">// JPG后缀</span>
    <span class="token keyword">public</span> static <span class="token keyword">final</span> String JPG_SUFFIX <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">".jpg"</span></span><span class="token punctuation">;</span>
    <span class="token comment">// PNG后缀</span>
    <span class="token keyword">public</span> static <span class="token keyword">final</span> String PNG_SUFFIX <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">".png"</span></span><span class="token punctuation">;</span>
    <span class="token comment">// MP4后缀</span>
    <span class="token keyword">public</span> static <span class="token keyword">final</span> String MP4_SUFFIX <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">".mp4"</span></span><span class="token punctuation">;</span>
    <span class="token comment">// YUV后缀</span>
    <span class="token keyword">public</span> static <span class="token keyword">final</span> String YUV_SUFFIX <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">".yuv"</span></span><span class="token punctuation">;</span>
    <span class="token comment">// h264后缀</span>
    <span class="token keyword">public</span> static <span class="token keyword">final</span> String H264_SUFFIX <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">".h264"</span></span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 保存图片到系统相册
     *
     * @param context
     * @param file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">saveImage</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ContentResolver localContentResolver <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ContentValues localContentValues <span class="token operator">=</span> <span class="token function">getImageContentValues</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> file<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentResolver<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">,</span> localContentValues<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Intent localIntent <span class="token operator">=</span> new <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"android.intent.action.MEDIA_SCANNER_SCAN_FILE"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Uri localUri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        localIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>localUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span>localIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static ContentValues <span class="token function">getImageContentValues</span><span class="token punctuation">(</span>Context paramContext<span class="token punctuation">,</span> File paramFile<span class="token punctuation">,</span> long paramLong<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ContentValues localContentValues <span class="token operator">=</span> new <span class="token function">ContentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"title"</span></span><span class="token punctuation">,</span> paramFile<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"_display_name"</span></span><span class="token punctuation">,</span> paramFile<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"mime_type"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"image/jpeg"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"datetaken"</span></span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>paramLong<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"date_modified"</span></span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>paramLong<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"date_added"</span></span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>paramLong<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"orientation"</span></span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"_data"</span></span><span class="token punctuation">,</span> paramFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localContentValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"_size"</span></span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>paramFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> localContentValues<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取App存储根目录
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getAppRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String path <span class="token operator">=</span> <span class="token function">getStorageRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileUtil<span class="token punctuation">.</span><span class="token function">createOrExistsDir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取文件存储根目录
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getStorageRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        File filePath <span class="token operator">=</span> CameraApp<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span><span class="token function">getMInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExternalFilesDir</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String path<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filePath <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            path <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            path <span class="token operator">=</span> CameraApp<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span><span class="token function">getMInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 图片地址
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getCameraPhotoPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getFolderDirPath</span><span class="token punctuation">(</span>SAVE_MEDIA_PHOTO_DIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取拍照普通图片文件
     */</span>
    <span class="token keyword">public</span> static File <span class="token function">getSavedPictureFile</span><span class="token punctuation">(</span>long timeStamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String fileName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"image"</span></span><span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"_"</span></span><span class="token operator">+</span> <span class="token operator">+</span> timeStamp <span class="token operator">+</span> JPG_SUFFIX<span class="token punctuation">;</span>
        <span class="token keyword">return</span> new <span class="token function">File</span><span class="token punctuation">(</span><span class="token function">getCameraPhotoPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 头像地址
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getAvatarPath</span><span class="token punctuation">(</span>String fileName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String path<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>R<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            path <span class="token operator">=</span> <span class="token function">getFolderDirPath</span><span class="token punctuation">(</span>SAVE_MEDIA_DIR <span class="token operator">+</span> AVATAR_DIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            path <span class="token operator">=</span> <span class="token function">getSaveDir</span><span class="token punctuation">(</span>AVATAR_DIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> path <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 视频地址
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getCameraVideoPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getFolderDirPath</span><span class="token punctuation">(</span>SAVE_MEDIA_VIDEO_DIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static String <span class="token function">getFolderDirPath</span><span class="token punctuation">(</span>String dstDirPathToCreate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        File dstFileDir <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dstDirPathToCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dstFileDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dstFileDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Failed to create file"</span></span><span class="token punctuation">,</span> dstDirPathToCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> dstFileDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取具体模块存储目录
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getSaveDir</span><span class="token punctuation">(</span><span class="token annotation builtin">@NonNull</span> String directory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String path <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string-literal singleline"><span class="token string">"/"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            path <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>directory<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"/"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            path <span class="token operator">=</span> directory<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            path <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"/"</span></span> <span class="token operator">+</span> directory<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        path <span class="token operator">=</span> <span class="token function">getAppRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">;</span>
        FileUtil<span class="token punctuation">.</span><span class="token function">createOrExistsDir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 通过媒体文件Uri获取文件-Android 11兼容
     *
     * @param fileUri 文件Uri
     */</span>
    <span class="token keyword">public</span> static File <span class="token function">getMediaUri2File</span><span class="token punctuation">(</span>Uri fileUri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>DATA<span class="token punctuation">}</span><span class="token punctuation">;</span>
        Cursor cursor <span class="token operator">=</span> CameraApp<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span><span class="token function">getMInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>fileUri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                int columnIndex <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getColumnIndexOrThrow</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String path <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cursor<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> new <span class="token function">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据Uri获取图片绝对路径，解决Android4.4以上版本Uri转换
     *
     * @param context  上下文
     * @param imageUri 图片地址
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getImageAbsolutePath</span><span class="token punctuation">(</span>Activity context<span class="token punctuation">,</span> Uri imageUri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> imageUri <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DocumentsContract<span class="token punctuation">.</span><span class="token function">isDocumentUri</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExternalStorageDocument</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String docId <span class="token operator">=</span> DocumentsContract<span class="token punctuation">.</span><span class="token function">getDocumentId</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> docId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">":"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String type <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"primary"</span></span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/"</span></span> <span class="token operator">+</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDownloadsDocument</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String id <span class="token operator">=</span> DocumentsContract<span class="token punctuation">.</span><span class="token function">getDocumentId</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Uri contentUri <span class="token operator">=</span> ContentUris<span class="token punctuation">.</span><span class="token function">withAppendedId</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"content://downloads/public_downloads"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">getDataColumn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> contentUri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMediaDocument</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String docId <span class="token operator">=</span> DocumentsContract<span class="token punctuation">.</span><span class="token function">getDocumentId</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> docId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">":"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String type <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                Uri contentUri <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"image"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    contentUri <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"video"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    contentUri <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"audio"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    contentUri <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Audio<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                String selection <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>_ID <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"=?"</span></span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs <span class="token operator">=</span> new String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">getDataColumn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> contentUri<span class="token punctuation">,</span> selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token comment">// MediaStore (and general)</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"content"</span></span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Return the remote address</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isGooglePhotosUri</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> imageUri<span class="token punctuation">.</span><span class="token function">getLastPathSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">getDataColumn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> imageUri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// File</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"file"</span></span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> imageUri<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param uri The Uri to checkRemote.
     * @return Whether the Uri authority is ExternalStorageProvider.
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isExternalStorageDocument</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"com.android.externalstorage.documents"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param uri The Uri to checkRemote.
     * @return Whether the Uri authority is DownloadsProvider.
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isDownloadsDocument</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"com.android.providers.downloads.documents"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param uri The Uri to checkRemote.
     * @return Whether the Uri authority is MediaProvider.
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isMediaDocument</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"com.android.providers.media.documents"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param uri The Uri to checkRemote.
     * @return Whether the Uri authority is Google Photos.
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isGooglePhotosUri</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"com.google.android.apps.photos.content"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static String <span class="token function">getDataColumn</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Uri uri<span class="token punctuation">,</span> String selection<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String column <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>DATA<span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>column<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>Cursor cursor <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                int index <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getColumnIndexOrThrow</span><span class="token punctuation">(</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="11FileUtil_1006"></a>11.FileUtil</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Activity<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Application<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>ContentUris<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>ContentValues<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>database<span class="token punctuation">.</span>Cursor<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>Bitmap<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>BitmapFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>Matrix<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>media<span class="token punctuation">.</span>ExifInterface<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Uri<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Environment<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>DocumentsContract<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>MediaStore<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">;</span>

<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>content<span class="token punctuation">.</span>FileProvider<span class="token punctuation">;</span>


<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>app<span class="token punctuation">.</span>CameraApp<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>BufferedInputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>BufferedOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileFilter<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileInputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileNotFoundException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>OutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>HttpURLConnection<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>ByteBuffer<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>FileChannel<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>DigestInputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>MessageDigest<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>NoSuchAlgorithmException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Locale<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: njb
 * @date: 2023/8/15 17:15
 * @desc:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> FileUtil <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> static <span class="token keyword">final</span> String LINE_SEP <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"line.separator"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">private</span> <span class="token function">FileUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> new <span class="token function">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"u can't instantiate me..."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the file by path.
     *
     * @param filePath The path of file.
     * @return the file
     */</span>
    <span class="token keyword">public</span> static File <span class="token function">getFileByPath</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">isSpace</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> new <span class="token function">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return whether the file exists.
     *
     * @param filePath The path of file.
     * @return {@code true}: yes&lt;br&gt;{@code false}: no
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isFileExists</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">isFileExists</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return whether the file exists.
     *
     * @param file The file.
     * @return {@code true}: yes&lt;br&gt;{@code false}: no
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isFileExists</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> file <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Rename the file.
     *
     * @param filePath The path of file.
     * @param newName  The new name of file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">rename</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">,</span> <span class="token keyword">final</span> String newName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">,</span> newName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Rename the file.
     *
     * @param file    The file.
     * @param newName The new name of file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">rename</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">,</span> <span class="token keyword">final</span> String newName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// file is null then return false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// file doesn't exist then return false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// the new name is space then return false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSpace</span><span class="token punctuation">(</span>newName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// the new name equals old name then return true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        File newFile <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> newName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// the new name of file exists then return false</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>newFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">renameTo</span><span class="token punctuation">(</span>newFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return whether it is a directory.
     *
     * @param dirPath The path of directory.
     * @return {@code true}: yes&lt;br&gt;{@code false}: no
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">isDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return whether it is a directory.
     *
     * @param file The file.
     * @return {@code true}: yes&lt;br&gt;{@code false}: no
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> file <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return whether it is a file.
     *
     * @param filePath The path of file.
     * @return {@code true}: yes&lt;br&gt;{@code false}: no
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">isFile</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return whether it is a file.
     *
     * @param file The file.
     * @return {@code true}: yes&lt;br&gt;{@code false}: no
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> file <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a directory if it doesn't exist, otherwise do nothing.
     *
     * @param dirPath The path of directory.
     * @return {@code true}: exists or creates successfully&lt;br&gt;{@code false}: otherwise
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">createOrExistsDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">createOrExistsDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a directory if it doesn't exist, otherwise do nothing.
     *
     * @param file The file.
     * @return {@code true}: exists or creates successfully&lt;br&gt;{@code false}: otherwise
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">createOrExistsDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        boolean isDirectory <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> file<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a file if it doesn't exist, otherwise do nothing.
     *
     * @param filePath The path of file.
     * @return {@code true}: exists or creates successfully&lt;br&gt;{@code false}: otherwise
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">createOrExistsFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">createOrExistsFile</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a file if it doesn't exist, otherwise do nothing.
     *
     * @param file The file.
     * @return {@code true}: exists or creates successfully&lt;br&gt;{@code false}: otherwise
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">createOrExistsFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createOrExistsDir</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a file if it doesn't exist, otherwise delete old file before creating.
     *
     * @param filePath The path of file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">createFileByDeleteOldFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">createFileByDeleteOldFile</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a file if it doesn't exist, otherwise delete old file before creating.
     *
     * @param file The file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">createFileByDeleteOldFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// file exists and unsuccessfully delete then return false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createOrExistsDir</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the directory.
     *
     * @param srcDirPath  The path of source directory.
     * @param destDirPath The path of destination directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcDirPath<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> String destDirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcDirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getFileByPath</span><span class="token punctuation">(</span>destDirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the directory.
     *
     * @param srcDirPath  The path of source directory.
     * @param destDirPath The path of destination directory.
     * @param listener    The replace listener.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcDirPath<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> String destDirPath<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcDirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getFileByPath</span><span class="token punctuation">(</span>destDirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the directory.
     *
     * @param srcDir  The source directory.
     * @param destDir The destination directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcDir<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> File destDir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveDir</span><span class="token punctuation">(</span>srcDir<span class="token punctuation">,</span> destDir<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the directory.
     *
     * @param srcDir   The source directory.
     * @param destDir  The destination directory.
     * @param listener The replace listener.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcDir<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> File destDir<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveDir</span><span class="token punctuation">(</span>srcDir<span class="token punctuation">,</span> destDir<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the file.
     *
     * @param srcFilePath  The path of source file.
     * @param destFilePath The path of destination file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcFilePath<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> String destFilePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcFilePath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getFileByPath</span><span class="token punctuation">(</span>destFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the file.
     *
     * @param srcFilePath  The path of source file.
     * @param destFilePath The path of destination file.
     * @param listener     The replace listener.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcFilePath<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> String destFilePath<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcFilePath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getFileByPath</span><span class="token punctuation">(</span>destFilePath<span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the file.
     *
     * @param srcFile  The source file.
     * @param destFile The destination file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcFile<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> File destFile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveFile</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> destFile<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the file.
     *
     * @param srcFile  The source file.
     * @param destFile The destination file.
     * @param listener The replace listener.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcFile<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> File destFile<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveFile</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> destFile<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Move the directory.
     *
     * @param srcDirPath  The path of source directory.
     * @param destDirPath The path of destination directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">moveDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcDirPath<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> String destDirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">moveDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcDirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getFileByPath</span><span class="token punctuation">(</span>destDirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Move the directory.
     *
     * @param srcDirPath  The path of source directory.
     * @param destDirPath The path of destination directory.
     * @param listener    The replace listener.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">moveDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcDirPath<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> String destDirPath<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">moveDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcDirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getFileByPath</span><span class="token punctuation">(</span>destDirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Move the directory.
     *
     * @param srcDir  The source directory.
     * @param destDir The destination directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">moveDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcDir<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> File destDir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveDir</span><span class="token punctuation">(</span>srcDir<span class="token punctuation">,</span> destDir<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Move the directory.
     *
     * @param srcDir   The source directory.
     * @param destDir  The destination directory.
     * @param listener The replace listener.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">moveDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcDir<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> File destDir<span class="token punctuation">,</span>
                                  <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveDir</span><span class="token punctuation">(</span>srcDir<span class="token punctuation">,</span> destDir<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Move the file.
     *
     * @param srcFilePath  The path of source file.
     * @param destFilePath The path of destination file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">moveFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcFilePath<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> String destFilePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">moveFile</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcFilePath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getFileByPath</span><span class="token punctuation">(</span>destFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Move the file.
     *
     * @param srcFilePath  The path of source file.
     * @param destFilePath The path of destination file.
     * @param listener     The replace listener.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">moveFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcFilePath<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> String destFilePath<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">moveFile</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcFilePath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getFileByPath</span><span class="token punctuation">(</span>destFilePath<span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Move the file.
     *
     * @param srcFile  The source file.
     * @param destFile The destination file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">moveFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcFile<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> File destFile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveFile</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> destFile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Move the file.
     *
     * @param srcFile  The source file.
     * @param destFile The destination file.
     * @param listener The replace listener.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">moveFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcFile<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> File destFile<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveFile</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> destFile<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static boolean <span class="token function">copyOrMoveDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcDir<span class="token punctuation">,</span>
                                         <span class="token keyword">final</span> File destDir<span class="token punctuation">,</span>
                                         <span class="token keyword">final</span> boolean isMove<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveDir</span><span class="token punctuation">(</span>srcDir<span class="token punctuation">,</span> destDir<span class="token punctuation">,</span> new <span class="token function">OnReplaceListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation builtin">@Override</span>
            <span class="token keyword">public</span> boolean <span class="token function">onReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> isMove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static boolean <span class="token function">copyOrMoveDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcDir<span class="token punctuation">,</span>
                                         <span class="token keyword">final</span> File destDir<span class="token punctuation">,</span>
                                         <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">,</span>
                                         <span class="token keyword">final</span> boolean isMove<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>srcDir <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> destDir <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// destDir's path locate in srcDir's path then return false</span>
        String srcPath <span class="token operator">=</span> srcDir<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> File<span class="token punctuation">.</span>separator<span class="token punctuation">;</span>
        String destPath <span class="token operator">=</span> destDir<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> File<span class="token punctuation">.</span>separator<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destPath<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>srcDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>srcDir<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> listener<span class="token punctuation">.</span><span class="token function">onReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// require delete the old directory</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">deleteAllInDir</span><span class="token punctuation">(</span>destDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// unsuccessfully delete then return false</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createOrExistsDir</span><span class="token punctuation">(</span>destDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> srcDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            File oneDestFile <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>destPath <span class="token operator">+</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">copyOrMoveFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> oneDestFile<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> isMove<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">copyOrMoveDir</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> oneDestFile<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> isMove<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>isMove <span class="token operator">||</span> <span class="token function">deleteDir</span><span class="token punctuation">(</span>srcDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static boolean <span class="token function">copyOrMoveFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcFile<span class="token punctuation">,</span>
                                          <span class="token keyword">final</span> File destFile<span class="token punctuation">,</span>
                                          <span class="token keyword">final</span> boolean isMove<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyOrMoveFile</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> destFile<span class="token punctuation">,</span> new <span class="token function">OnReplaceListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation builtin">@Override</span>
            <span class="token keyword">public</span> boolean <span class="token function">onReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> isMove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static boolean <span class="token function">copyOrMoveFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File srcFile<span class="token punctuation">,</span>
                                          <span class="token keyword">final</span> File destFile<span class="token punctuation">,</span>
                                          <span class="token keyword">final</span> OnReplaceListener listener<span class="token punctuation">,</span>
                                          <span class="token keyword">final</span> boolean isMove<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>srcFile <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> destFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// srcFile equals destFile then return false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>srcFile<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>destFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// srcFile doesn't exist or isn't a file then return false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>srcFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>srcFile<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> listener<span class="token punctuation">.</span><span class="token function">onReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// require delete the old file</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>destFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// unsuccessfully delete then return false</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createOrExistsDir</span><span class="token punctuation">(</span>destFile<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">writeFileFromIS</span><span class="token punctuation">(</span>destFile<span class="token punctuation">,</span> new <span class="token function">FileInputStream</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>isMove <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">deleteFile</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>FileNotFoundException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the directory.
     *
     * @param filePath The path of file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the directory.
     *
     * @param file The file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">deleteDir</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">deleteFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the directory.
     *
     * @param dirPath The path of directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">deleteDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the directory.
     *
     * @param dir The directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// dir doesn't exist then return true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// dir isn't a directory then return false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> files<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">deleteDir</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> dir<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> static boolean <span class="token function">createDir</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        File file <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//  FL.d(TAG, "创建失败，请检查路径和是否配置文件权限！");</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the file.
     *
     * @param srcFilePath The path of source file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String srcFilePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">deleteFile</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>srcFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the file.
     *
     * @param file The file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> file <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the all in directory.
     *
     * @param dirPath The path of directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteAllInDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">deleteAllInDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the all in directory.
     *
     * @param dir The directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteAllInDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">deleteFilesInDirWithFilter</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> new <span class="token function">FileFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation builtin">@Override</span>
            <span class="token keyword">public</span> boolean <span class="token function">accept</span><span class="token punctuation">(</span>File pathname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete all files in directory.
     *
     * @param dirPath The path of directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteFilesInDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">deleteFilesInDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete all files in directory.
     *
     * @param dir The directory.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteFilesInDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">deleteFilesInDirWithFilter</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> new <span class="token function">FileFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation builtin">@Override</span>
            <span class="token keyword">public</span> boolean <span class="token function">accept</span><span class="token punctuation">(</span>File pathname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> pathname<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete all files that satisfy the filter in directory.
     *
     * @param dirPath The path of directory.
     * @param filter  The filter.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">,</span>
                                                     <span class="token keyword">final</span> FileFilter filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">deleteFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete all files that satisfy the filter in directory.
     *
     * @param dir    The directory.
     * @param filter The filter.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">deleteFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">,</span> <span class="token keyword">final</span> FileFilter filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// dir doesn't exist then return true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// dir isn't a directory then return false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> files<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">deleteDir</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the files in directory.
     * &lt;p&gt;Doesn't traverse subdirectories&lt;/p&gt;
     *
     * @param dirPath The path of directory.
     * @return the files in directory
     */</span>
    <span class="token keyword">public</span> static List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> <span class="token function">listFilesInDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">listFilesInDir</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the files in directory.
     * &lt;p&gt;Doesn't traverse subdirectories&lt;/p&gt;
     *
     * @param dir The directory.
     * @return the files in directory
     */</span>
    <span class="token keyword">public</span> static List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> <span class="token function">listFilesInDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">listFilesInDir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the files in directory.
     *
     * @param dirPath     The path of directory.
     * @param isRecursive True to traverse subdirectories, false otherwise.
     * @return the files in directory
     */</span>
    <span class="token keyword">public</span> static List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> <span class="token function">listFilesInDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">,</span> <span class="token keyword">final</span> boolean isRecursive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">listFilesInDir</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> isRecursive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the files in directory.
     *
     * @param dir         The directory.
     * @param isRecursive True to traverse subdirectories, false otherwise.
     * @return the files in directory
     */</span>
    <span class="token keyword">public</span> static List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> <span class="token function">listFilesInDir</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">,</span> <span class="token keyword">final</span> boolean isRecursive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> new <span class="token function">FileFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation builtin">@Override</span>
            <span class="token keyword">public</span> boolean <span class="token function">accept</span><span class="token punctuation">(</span>File pathname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> isRecursive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the files that satisfy the filter in directory.
     * &lt;p&gt;Doesn't traverse subdirectories&lt;/p&gt;
     *
     * @param dirPath The path of directory.
     * @param filter  The filter.
     * @return the files that satisfy the filter in directory
     */</span>
    <span class="token keyword">public</span> static List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> <span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">,</span>
                                                      <span class="token keyword">final</span> FileFilter filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the files that satisfy the filter in directory.
     * &lt;p&gt;Doesn't traverse subdirectories&lt;/p&gt;
     *
     * @param dir    The directory.
     * @param filter The filter.
     * @return the files that satisfy the filter in directory
     */</span>
    <span class="token keyword">public</span> static List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> <span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">,</span>
                                                      <span class="token keyword">final</span> FileFilter filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the files that satisfy the filter in directory.
     *
     * @param dirPath     The path of directory.
     * @param filter      The filter.
     * @param isRecursive True to traverse subdirectories, false otherwise.
     * @return the files that satisfy the filter in directory
     */</span>
    <span class="token keyword">public</span> static List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> <span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">,</span>
                                                      <span class="token keyword">final</span> FileFilter filter<span class="token punctuation">,</span>
                                                      <span class="token keyword">final</span> boolean isRecursive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> isRecursive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the files that satisfy the filter in directory.
     *
     * @param dir         The directory.
     * @param filter      The filter.
     * @param isRecursive True to traverse subdirectories, false otherwise.
     * @return the files that satisfy the filter in directory
     */</span>
    <span class="token keyword">public</span> static List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> <span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">,</span>
                                                      <span class="token keyword">final</span> FileFilter filter<span class="token punctuation">,</span>
                                                      <span class="token keyword">final</span> boolean isRecursive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span> list <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> files<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isRecursive <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//noinspection ConstantConditions</span>
                    list<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">listFilesInDirWithFilter</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the time that the file was last modified.
     *
     * @param filePath The path of file.
     * @return the time that the file was last modified
     */</span>

    <span class="token keyword">public</span> static long <span class="token function">getFileLastModified</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getFileLastModified</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the time that the file was last modified.
     *
     * @param file The file.
     * @return the time that the file was last modified
     */</span>
    <span class="token keyword">public</span> static long <span class="token function">getFileLastModified</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the charset of file simply.
     *
     * @param filePath The path of file.
     * @return the charset of file simply
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileCharsetSimple</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getFileCharsetSimple</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the charset of file simply.
     *
     * @param file The file.
     * @return the charset of file simply
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileCharsetSimple</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        int p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        InputStream <span class="token keyword">is</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">is</span> <span class="token operator">=</span> new <span class="token function">BufferedInputStream</span><span class="token punctuation">(</span>new <span class="token function">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">switch</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            case <span class="token number">0xefbb</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"UTF-8"</span></span><span class="token punctuation">;</span>
            case <span class="token number">0xfffe</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"Unicode"</span></span><span class="token punctuation">;</span>
            case <span class="token number">0xfeff</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"UTF-16BE"</span></span><span class="token punctuation">;</span>
            default<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"GBK"</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the number of lines of file.
     *
     * @param filePath The path of file.
     * @return the number of lines of file
     */</span>
    <span class="token keyword">public</span> static int <span class="token function">getFileLines</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getFileLines</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the number of lines of file.
     *
     * @param file The file.
     * @return the number of lines of file
     */</span>
    <span class="token keyword">public</span> static int <span class="token function">getFileLines</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        int count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        InputStream <span class="token keyword">is</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">is</span> <span class="token operator">=</span> new <span class="token function">BufferedInputStream</span><span class="token punctuation">(</span>new <span class="token function">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            byte<span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            int readChars<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LINE_SEP<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"\n"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readChars <span class="token operator">=</span> <span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> readChars<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token operator">++</span>count<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readChars <span class="token operator">=</span> <span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> readChars<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\r'</span><span class="token punctuation">)</span> <span class="token operator">++</span>count<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the size of directory.
     *
     * @param dirPath The path of directory.
     * @return the size of directory
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getDirSize</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getDirSize</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the size of directory.
     *
     * @param dir The directory.
     * @return the size of directory
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getDirSize</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        long len <span class="token operator">=</span> <span class="token function">getDirLength</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string-literal singleline"><span class="token string">""</span></span> <span class="token operator">:</span> <span class="token function">byte2FitMemorySize</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the length of file.
     *
     * @param filePath The path of file.
     * @return the length of file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        long len <span class="token operator">=</span> <span class="token function">getFileLength</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string-literal singleline"><span class="token string">""</span></span> <span class="token operator">:</span> <span class="token function">byte2FitMemorySize</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the length of file.
     *
     * @param file The file.
     * @return the length of file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        long len <span class="token operator">=</span> <span class="token function">getFileLength</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string-literal singleline"><span class="token string">""</span></span> <span class="token operator">:</span> <span class="token function">byte2FitMemorySize</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the length of directory.
     *
     * @param dirPath The path of directory.
     * @return the length of directory
     */</span>
    <span class="token keyword">public</span> static long <span class="token function">getDirLength</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dirPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getDirLength</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the length of directory.
     *
     * @param dir The directory.
     * @return the length of directory
     */</span>
    <span class="token keyword">public</span> static long <span class="token function">getDirLength</span><span class="token punctuation">(</span><span class="token keyword">final</span> File dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        long len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> files<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    len <span class="token operator">+=</span> <span class="token function">getDirLength</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    len <span class="token operator">+=</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> len<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the length of file.
     *
     * @param filePath The path of file.
     * @return the length of file
     */</span>
    <span class="token keyword">public</span> static long <span class="token function">getFileLength</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        boolean isURL <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"[a-zA-z]+://[^\\s]*"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isURL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                HttpURLConnection conn <span class="token operator">=</span> <span class="token punctuation">(</span>HttpURLConnection<span class="token punctuation">)</span> new <span class="token function">URL</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept-Encoding"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"identity"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                conn<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> conn<span class="token punctuation">.</span><span class="token function">getContentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">getFileLength</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the length of file.
     *
     * @param file The file.
     * @return the length of file
     */</span>
    <span class="token keyword">public</span> static long <span class="token function">getFileLength</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the MD5 of file.
     *
     * @param filePath The path of file.
     * @return the md5 of file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileMD5ToString</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        File file <span class="token operator">=</span> <span class="token function">isSpace</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> new <span class="token function">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getFileMD5ToString</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the MD5 of file.
     *
     * @param file The file.
     * @return the md5 of file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileMD5ToString</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">bytes2HexString</span><span class="token punctuation">(</span><span class="token function">getFileMD5</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the MD5 of file.
     *
     * @param filePath The path of file.
     * @return the md5 of file
     */</span>
    <span class="token keyword">public</span> static byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getFileMD5</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getFileMD5</span><span class="token punctuation">(</span><span class="token function">getFileByPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the MD5 of file.
     *
     * @param file The file.
     * @return the md5 of file
     */</span>
    <span class="token keyword">public</span> static byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getFileMD5</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        DigestInputStream dis <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            FileInputStream fis <span class="token operator">=</span> new <span class="token function">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            MessageDigest md <span class="token operator">=</span> MessageDigest<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"MD5"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dis <span class="token operator">=</span> new <span class="token function">DigestInputStream</span><span class="token punctuation">(</span>fis<span class="token punctuation">,</span> md<span class="token punctuation">)</span><span class="token punctuation">;</span>
            byte<span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>dis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            md <span class="token operator">=</span> dis<span class="token punctuation">.</span><span class="token function">getMessageDigest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> md<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>NoSuchAlgorithmException | IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    dis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the file's path of directory.
     *
     * @param file The file.
     * @return the file's path of directory
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getDirName</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getDirName</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the file's path of directory.
     *
     * @param filePath The path of file.
     * @return the file's path of directory
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getDirName</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSpace</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        int lastSep <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> lastSep <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string-literal singleline"><span class="token string">""</span></span> <span class="token operator">:</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lastSep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the name of file.
     *
     * @param file The file.
     * @return the name of file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getFileName</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the name of file.
     *
     * @param filePath The path of file.
     * @return the name of file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSpace</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        int lastSep <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> lastSep <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> filePath <span class="token operator">:</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lastSep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the name of file without extension.
     *
     * @param file The file.
     * @return the name of file without extension
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileNameNoExtension</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getFileNameNoExtension</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the name of file without extension.
     *
     * @param filePath The path of file.
     * @return the name of file without extension
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileNameNoExtension</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSpace</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        int lastPoi <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int lastSep <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastSep <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>lastPoi <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> filePath <span class="token operator">:</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lastPoi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastPoi <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> lastSep <span class="token operator">&gt;</span> lastPoi<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lastSep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lastSep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> lastPoi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the extension of file.
     *
     * @param file The file.
     * @return the extension of file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileExtension</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getFileExtension</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the extension of file.
     *
     * @param filePath The path of file.
     * @return the extension of file
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getFileExtension</span><span class="token punctuation">(</span><span class="token keyword">final</span> String filePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSpace</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        int lastPoi <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int lastSep <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastPoi <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> lastSep <span class="token operator">&gt;=</span> lastPoi<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lastPoi <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> OnReplaceListener <span class="token punctuation">{<!-- --></span>
        boolean <span class="token function">onReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static <span class="token keyword">final</span> char HEX_DIGITS<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
            <span class="token punctuation">{<!-- --></span><span class="token char">'0'</span><span class="token punctuation">,</span> <span class="token char">'1'</span><span class="token punctuation">,</span> <span class="token char">'2'</span><span class="token punctuation">,</span> <span class="token char">'3'</span><span class="token punctuation">,</span> <span class="token char">'4'</span><span class="token punctuation">,</span> <span class="token char">'5'</span><span class="token punctuation">,</span> <span class="token char">'6'</span><span class="token punctuation">,</span> <span class="token char">'7'</span><span class="token punctuation">,</span> <span class="token char">'8'</span><span class="token punctuation">,</span> <span class="token char">'9'</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token char">'B'</span><span class="token punctuation">,</span> <span class="token char">'C'</span><span class="token punctuation">,</span> <span class="token char">'D'</span><span class="token punctuation">,</span> <span class="token char">'E'</span><span class="token punctuation">,</span> <span class="token char">'F'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> static String <span class="token function">bytes2HexString</span><span class="token punctuation">(</span><span class="token keyword">final</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        int len <span class="token operator">=</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">;</span>
        char<span class="token punctuation">[</span><span class="token punctuation">]</span> ret <span class="token operator">=</span> new char<span class="token punctuation">[</span>len <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> HEX_DIGITS<span class="token punctuation">[</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">4</span> &amp; <span class="token number">0x0f</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            ret<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> HEX_DIGITS<span class="token punctuation">[</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> &amp; <span class="token number">0x0f</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> new <span class="token function">String</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static String <span class="token function">byte2FitMemorySize</span><span class="token punctuation">(</span><span class="token keyword">final</span> long byteNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byteNum <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"shouldn't be less than zero!"</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>byteNum <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"%.1fB"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>double<span class="token punctuation">)</span> byteNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>byteNum <span class="token operator">&lt;</span> <span class="token number">1048576</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"%.1fKB"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>double<span class="token punctuation">)</span> byteNum <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>byteNum <span class="token operator">&lt;</span> <span class="token number">1073741824</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"%.1fMB"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>double<span class="token punctuation">)</span> byteNum <span class="token operator">/</span> <span class="token number">1048576</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"%.1fGB"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>double<span class="token punctuation">)</span> byteNum <span class="token operator">/</span> <span class="token number">1073741824</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static boolean <span class="token function">isSpace</span><span class="token punctuation">(</span><span class="token keyword">final</span> String s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Character<span class="token punctuation">.</span><span class="token function">isWhitespace</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static boolean <span class="token function">writeFileFromIS</span><span class="token punctuation">(</span><span class="token keyword">final</span> File file<span class="token punctuation">,</span>
                                           <span class="token keyword">final</span> InputStream <span class="token keyword">is</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        OutputStream os <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            os <span class="token operator">=</span> new <span class="token function">BufferedOutputStream</span><span class="token punctuation">(</span>new <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            byte <span class="token keyword">data</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            int len<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>os <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    os<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 写入文件
     */</span>
    <span class="token keyword">public</span> static void <span class="token function">writeFrame</span><span class="token punctuation">(</span>String fileName<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            BufferedOutputStream bos <span class="token operator">=</span> new <span class="token function">BufferedOutputStream</span><span class="token punctuation">(</span>new <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Log.e(TAG, "" + data.length + " bytes have been written to " + filesDir + fileName + ".jpg");</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拷贝文件
     * 使用文件通道，提高文件复制效率
     *
     * @param fromFile 来源文件地址
     * @param toFile   复制后文件地址
     * @return 是否复制成功
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyFileWithChannel</span><span class="token punctuation">(</span>String fromFile<span class="token punctuation">,</span> String toFile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FileInputStream fsIn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        FileOutputStream fsOut <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        FileChannel fcIn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        FileChannel fcOut <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            fsIn <span class="token operator">=</span> new <span class="token function">FileInputStream</span><span class="token punctuation">(</span>fromFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fsOut <span class="token operator">=</span> new <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>toFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 得到对应文件通道</span>
            fcIn <span class="token operator">=</span> fsIn<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fcOut <span class="token operator">=</span> fsOut<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 连接两个通道，并且从in通道读取，然后写入out通道</span>
            fcIn<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fcIn<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fcOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fsIn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fsIn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fsOut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fsOut<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fcIn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fcIn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fcOut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fcOut<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static void <span class="token function">saveRgbaDataToFile</span><span class="token punctuation">(</span>File file<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> rgba<span class="token punctuation">,</span> int width<span class="token punctuation">,</span> int height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Bitmap bitmap <span class="token operator">=</span> Bitmap<span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> Bitmap<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ARGB_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>rgba<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bitmap<span class="token punctuation">.</span><span class="token function">copyPixelsFromBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            FileOutputStream fos <span class="token operator">=</span> new <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bitmap<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>Bitmap<span class="token punctuation">.</span>CompressFormat<span class="token punctuation">.</span>JPEG<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static void <span class="token function">saveRgbaDataToFile</span><span class="token punctuation">(</span>File file<span class="token punctuation">,</span> ByteBuffer rgba<span class="token punctuation">,</span> int width<span class="token punctuation">,</span> int height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Bitmap bitmap <span class="token operator">=</span> Bitmap<span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> Bitmap<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ARGB_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rgba<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bitmap<span class="token punctuation">.</span><span class="token function">copyPixelsFromBuffer</span><span class="token punctuation">(</span>rgba<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            FileOutputStream fos <span class="token operator">=</span> new <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bitmap<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>Bitmap<span class="token punctuation">.</span>CompressFormat<span class="token punctuation">.</span>JPEG<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>FileNotFoundException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Copy the file from assets.
     *
     * @param assetsFilePath The path of file in assets.
     * @param destFilePath   The path of destination file.
     * @return {@code true}: success&lt;br&gt;{@code false}: fail
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">final</span> String assetsFilePath<span class="token punctuation">,</span> <span class="token keyword">final</span> String destFilePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        boolean res <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> assets <span class="token operator">=</span> CameraApp<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span><span class="token function">getMInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>assetsFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>assets<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String asset <span class="token operator">:</span> assets<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    res &amp;<span class="token operator">=</span> <span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span>assetsFilePath <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/"</span></span> <span class="token operator">+</span> asset<span class="token punctuation">,</span> destFilePath <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/"</span></span> <span class="token operator">+</span> asset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                res <span class="token operator">=</span> <span class="token function">writeFileFromIS</span><span class="token punctuation">(</span>
                        new <span class="token function">File</span><span class="token punctuation">(</span>destFilePath<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        CameraApp<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span><span class="token function">getMInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>assetsFilePath<span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            res <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取jpg图片输出路径
     *
     * @return 输出路径
     */</span>
    <span class="token keyword">public</span> static Object <span class="token function">getHeadJpgFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String fileName <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> FileManager<span class="token punctuation">.</span>JPG_SUFFIX<span class="token punctuation">;</span>
        String headPath <span class="token operator">=</span> FileManager<span class="token punctuation">.</span><span class="token function">getAvatarPath</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        File imgFile<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>R<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            imgFile <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>headPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过 MediaStore API 插入file 为了拿到系统裁剪要保存到的uri（因为App没有权限不能访问公共存储空间，需要通过 MediaStore API来操作）</span>
            ContentValues values <span class="token operator">=</span> new <span class="token function">ContentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            values<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>DATA<span class="token punctuation">,</span> imgFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            values<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>DISPLAY_NAME<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            values<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>MIME_TYPE<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"image/jpeg"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> CameraApp<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span><span class="token function">getMInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            imgFile <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>headPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> imgFile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static void <span class="token function">saveBitmap</span><span class="token punctuation">(</span>Bitmap bitmap<span class="token punctuation">,</span> String path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        File filePic<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            filePic <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filePic<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                filePic<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                filePic<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            FileOutputStream fos <span class="token operator">=</span> new <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>filePic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bitmap<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>Bitmap<span class="token punctuation">.</span>CompressFormat<span class="token punctuation">.</span>JPEG<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"tag"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"saveBitmap: "</span></span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"tag"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"saveBitmap success: "</span></span> <span class="token operator">+</span> filePic<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从File获取Uri
     * 此方式获取视频Uri原生视频分享报导入失败，解决方式参考 getVideoUri()
     *
     * @param file 文件
     * @return uri
     */</span>
    <span class="token keyword">public</span> static Uri <span class="token function">getUriFromFile</span><span class="token punctuation">(</span>File file<span class="token punctuation">,</span> Application application<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Uri mUri<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"lzq"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"name:"</span></span> <span class="token operator">+</span> application<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mUri <span class="token operator">=</span> FileProvider<span class="token punctuation">.</span><span class="token function">getUriForFile</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span>
                    application<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">".fileprovider"</span></span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mUri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mUri<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 从文件路径获取uri
     *
     * @param path 文件路径
     * @return uri
     */</span>
    <span class="token keyword">public</span> static Uri <span class="token function">getUriFromPath</span><span class="token punctuation">(</span>String path<span class="token punctuation">,</span> Application application<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        File file <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">getUriFromFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> application<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"File is not exist"</span></span><span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 保存rgba数据为jpg文件
     *
     * @param bytes  rgba数据
     * @param width  宽度
     * @param height 高度
     * @param file   保存文件
     */</span>

    <span class="token keyword">public</span> static void <span class="token function">saveRgbaDataToFile</span><span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> int width<span class="token punctuation">,</span> int height<span class="token punctuation">,</span> File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Bitmap bitmap <span class="token operator">=</span> Bitmap<span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> Bitmap<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ARGB_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bitmap<span class="token punctuation">.</span><span class="token function">copyPixelsFromBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            FileOutputStream fos <span class="token operator">=</span> new <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bitmap<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>Bitmap<span class="token punctuation">.</span>CompressFormat<span class="token punctuation">.</span>JPEG<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>FileNotFoundException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static File <span class="token function">createFile</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        File file <span class="token operator">=</span> new <span class="token function">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// FL.d(TAG, "目标文件所在路径不存在，准备创建……");</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createDir</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// FL.d(TAG, "创建目录文件所在的目录失败！文件路径【" + path + "】");</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 创建目标文件</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//  FL.d(TAG, "创建文件成功:" + file.getAbsolutePath());</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> file<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> file<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 图片压缩并且存储
     *
     * @param targetFile   保存目标文件
     * @param originalPath 图片地址
     * @param scale        图片缩放值
     */</span>
    <span class="token keyword">public</span> static void <span class="token function">compressAndSaveImage</span><span class="token punctuation">(</span>File targetFile<span class="token punctuation">,</span> String originalPath<span class="token punctuation">,</span> int scale<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Bitmap bitmap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        BufferedInputStream bufferedInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        FileOutputStream fileOutputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1、得到图片的宽、高</span>
            BitmapFactory<span class="token punctuation">.</span>Options options <span class="token operator">=</span> new BitmapFactory<span class="token punctuation">.</span><span class="token function">Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span>inJustDecodeBounds <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            bufferedInputStream <span class="token operator">=</span> new <span class="token function">BufferedInputStream</span><span class="token punctuation">(</span>new <span class="token function">FileInputStream</span><span class="token punctuation">(</span>originalPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bitmap <span class="token operator">=</span> BitmapFactory<span class="token punctuation">.</span><span class="token function">decodeStream</span><span class="token punctuation">(</span>bufferedInputStream<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                bitmap<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            bufferedInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            int originalImageWidth <span class="token operator">=</span> options<span class="token punctuation">.</span>outWidth<span class="token punctuation">;</span>
            int originalImageHeight <span class="token operator">=</span> options<span class="token punctuation">.</span>outHeight<span class="token punctuation">;</span>

            <span class="token comment">// 2、获取图片方向</span>
            int orientation <span class="token operator">=</span> <span class="token function">getImageOrientation</span><span class="token punctuation">(</span>originalPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            int rotate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">switch</span> <span class="token punctuation">(</span>orientation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 判断是否需要旋转</span>
                case ExifInterface<span class="token punctuation">.</span>ORIENTATION_ROTATE_270<span class="token operator">:</span>
                    rotate <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                case ExifInterface<span class="token punctuation">.</span>ORIENTATION_ROTATE_180<span class="token operator">:</span>
                    rotate <span class="token operator">=</span> <span class="token number">180</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                case ExifInterface<span class="token punctuation">.</span>ORIENTATION_ROTATE_90<span class="token operator">:</span>
                    rotate <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 3、计算图片压缩inSampleSize</span>
            int maxValue <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>originalImageWidth<span class="token punctuation">,</span> originalImageHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxValue <span class="token operator">&gt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span>inSampleSize <span class="token operator">=</span> scale <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>maxValue <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span>inSampleSize <span class="token operator">=</span> scale <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>maxValue <span class="token operator">&gt;</span> <span class="token number">1500</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span>inSampleSize <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span> <span class="token punctuation">(</span>scale <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>maxValue <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span>inSampleSize <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span> <span class="token punctuation">(</span>scale <span class="token operator">*</span> <span class="token number">1.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span>inSampleSize <span class="token operator">=</span> scale<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            options<span class="token punctuation">.</span>inJustDecodeBounds <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token comment">// 4、图片方向纠正和压缩(生成缩略图)</span>
            bufferedInputStream <span class="token operator">=</span> new <span class="token function">BufferedInputStream</span><span class="token punctuation">(</span>new <span class="token function">FileInputStream</span><span class="token punctuation">(</span>originalPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bitmap <span class="token operator">=</span> BitmapFactory<span class="token punctuation">.</span><span class="token function">decodeStream</span><span class="token punctuation">(</span>bufferedInputStream<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bufferedInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            targetFile<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            fileOutputStream <span class="token operator">=</span> new <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>targetFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rotate <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Matrix matrix <span class="token operator">=</span> new <span class="token function">Matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                matrix<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span>rotate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Bitmap bitmapOld <span class="token operator">=</span> bitmap<span class="token punctuation">;</span>
                bitmap <span class="token operator">=</span> Bitmap<span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        bitmap<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                bitmapOld<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 5、保存图片</span>
            bitmap<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>Bitmap<span class="token punctuation">.</span>CompressFormat<span class="token punctuation">.</span>JPEG<span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferedInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    bufferedInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fileOutputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fileOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fileOutputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException io<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                io<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> bitmap<span class="token punctuation">.</span><span class="token function">isRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                bitmap<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取一张图片在手机上的方向值
     */</span>
    <span class="token keyword">public</span> static int <span class="token function">getImageOrientation</span><span class="token punctuation">(</span>String uri<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new <span class="token function">File</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> new <span class="token function">ExifInterface</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttributeInt</span><span class="token punctuation">(</span>ExifInterface<span class="token punctuation">.</span>TAG_ORIENTATION<span class="token punctuation">,</span> ExifInterface<span class="token punctuation">.</span>ORIENTATION_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据Uri获取图片绝对路径，解决Android4.4以上版本Uri转换
     *
     * @param context  上下文
     * @param imageUri 图片地址
     */</span>
    <span class="token keyword">public</span> static String <span class="token function">getImageAbsolutePath</span><span class="token punctuation">(</span>Activity context<span class="token punctuation">,</span> Uri imageUri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> imageUri <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DocumentsContract<span class="token punctuation">.</span><span class="token function">isDocumentUri</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExternalStorageDocument</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String docId <span class="token operator">=</span> DocumentsContract<span class="token punctuation">.</span><span class="token function">getDocumentId</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> docId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">":"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String type <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"primary"</span></span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/"</span></span> <span class="token operator">+</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDownloadsDocument</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String id <span class="token operator">=</span> DocumentsContract<span class="token punctuation">.</span><span class="token function">getDocumentId</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Uri contentUri <span class="token operator">=</span> ContentUris<span class="token punctuation">.</span><span class="token function">withAppendedId</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"content://downloads/public_downloads"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">getDataColumn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> contentUri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMediaDocument</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String docId <span class="token operator">=</span> DocumentsContract<span class="token punctuation">.</span><span class="token function">getDocumentId</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> docId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">":"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String type <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                Uri contentUri <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"image"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    contentUri <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"video"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    contentUri <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"audio"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    contentUri <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Audio<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                String selection <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>_ID <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"=?"</span></span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs <span class="token operator">=</span> new String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">getDataColumn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> contentUri<span class="token punctuation">,</span> selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token comment">// MediaStore (and general)</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"content"</span></span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Return the remote address</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isGooglePhotosUri</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> imageUri<span class="token punctuation">.</span><span class="token function">getLastPathSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">getDataColumn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> imageUri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// File</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"file"</span></span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> imageUri<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param uri The Uri to checkRemote.
     * @return Whether the Uri authority is ExternalStorageProvider.
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isExternalStorageDocument</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"com.android.externalstorage.documents"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param uri The Uri to checkRemote.
     * @return Whether the Uri authority is DownloadsProvider.
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isDownloadsDocument</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"com.android.providers.downloads.documents"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param uri The Uri to checkRemote.
     * @return Whether the Uri authority is MediaProvider.
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isMediaDocument</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"com.android.providers.media.documents"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param uri The Uri to checkRemote.
     * @return Whether the Uri authority is Google Photos.
     */</span>
    <span class="token keyword">public</span> static boolean <span class="token function">isGooglePhotosUri</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"com.google.android.apps.photos.content"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static String <span class="token function">getDataColumn</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Uri uri<span class="token punctuation">,</span> String selection<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String column <span class="token operator">=</span> MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>DATA<span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>column<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>Cursor cursor <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                int index <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getColumnIndexOrThrow</span><span class="token punctuation">(</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="12VideoFileUtils_2753"></a>12.VideoFileUtils</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils

<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Environment
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>R
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File
<span class="token keyword">import</span> java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>SimpleDateFormat
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Locale

<span class="token comment">/**
 *@author: njb
 *@date:   2023/8/15 17:13
 *@desc:
 */</span>
<span class="token keyword">object</span> VideoFileUtils <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 获取视频文件路径
     */</span>
    <span class="token keyword">fun</span> <span class="token function">getVideoName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> videoPath <span class="token operator">=</span> Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/CameraXApp"</span></span>
        <span class="token keyword">val</span> dir <span class="token operator">=</span> <span class="token function">File</span><span class="token punctuation">(</span>videoPath<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"文件不存在"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> videoPath
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取图片文件路径
     */</span>
    <span class="token keyword">fun</span> <span class="token function">getImageFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> imagePath <span class="token operator">=</span> Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"/images"</span></span>
        <span class="token keyword">val</span> dir <span class="token operator">=</span> <span class="token function">File</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"文件不存在"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> imagePath
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拍照文件保存路径
     * @param context
     * @return
     */</span>
    <span class="token keyword">fun</span> <span class="token function">getPhotoDir</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> FileManager<span class="token punctuation">.</span><span class="token function">getFolderDirPath</span><span class="token punctuation">(</span>
            <span class="token string-literal singleline"><span class="token string">"DCIM/Camera/CameraXApp/photo"</span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 视频文件保存路径
     * @param context
     * @return
     */</span>
    <span class="token keyword">fun</span> <span class="token function">getVideoDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> FileManager<span class="token punctuation">.</span><span class="token function">getFolderDirPath</span><span class="token punctuation">(</span>
            <span class="token string-literal singleline"><span class="token string">"DCIM/Camera/CameraXApp/video"</span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Use external media if it is available, our app's file directory otherwise */</span>
    <span class="token keyword">fun</span> <span class="token function">getOutputDirectory</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> File <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> appContext <span class="token operator">=</span> context<span class="token punctuation">.</span>applicationContext
        <span class="token keyword">val</span> mediaDir <span class="token operator">=</span> context<span class="token punctuation">.</span>externalMediaDirs<span class="token punctuation">.</span><span class="token function">firstOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">File</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> appContext<span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>app_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span> <span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaDir <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mediaDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            mediaDir <span class="token keyword">else</span> appContext<span class="token punctuation">.</span>filesDir
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">createFile</span><span class="token punctuation">(</span>baseFolder<span class="token operator">:</span> File<span class="token punctuation">,</span> format<span class="token operator">:</span> String<span class="token punctuation">,</span> extension<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token function">File</span><span class="token punctuation">(</span>
            baseFolder<span class="token punctuation">,</span> <span class="token function">SimpleDateFormat</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> Locale<span class="token punctuation">.</span>US<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> extension
        <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="13CameraApp_2835"></a>13.CameraApp:</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>app

<span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Application

<span class="token comment">/**
 *@author: njb
 *@date:   2023/8/15 17:07
 *@desc:
 */</span>
<span class="token keyword">class</span> CameraApp <span class="token operator">:</span> <span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mInstance <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mInstance<span class="token operator">:</span> CameraApp
            <span class="token keyword">private</span> <span class="token keyword">set</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="14_2861"></a>14.完整的示例代码如下：</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo

<span class="token keyword">import</span> android<span class="token punctuation">.</span>Manifest
<span class="token keyword">import</span> android<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>SuppressLint
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Intent
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span>PackageManager
<span class="token keyword">import</span> android<span class="token punctuation">.</span>media<span class="token punctuation">.</span>MediaScannerConnection
<span class="token keyword">import</span> android<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Uri
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Environment
<span class="token keyword">import</span> android<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span>MimeTypeMap
<span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Button
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>AspectRatio
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Camera
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>CameraSelector
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>ImageCapture
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>ImageCaptureException
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Preview
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>VideoCapture
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">.</span>OnVideoSavedCallback
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>core<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">.</span>OutputFileOptions
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>ProcessCameraProvider
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>view<span class="token punctuation">.</span>PreviewView
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityCompat
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>content<span class="token punctuation">.</span>ContextCompat
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>net<span class="token punctuation">.</span>toFile
<span class="token keyword">import</span> com<span class="token punctuation">.</span>blankj<span class="token punctuation">.</span>utilcode<span class="token punctuation">.</span>util<span class="token punctuation">.</span>LogUtils
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>CameraActivity
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>Constants
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span>DATE_FORMAT
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span>PHOTO_EXTENSION
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span>REQUIRED_PERMISSIONS
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>FileManager
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>ToastUtils
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>VideoFileUtils<span class="token punctuation">.</span>createFile
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>VideoFileUtils<span class="token punctuation">.</span>getOutputDirectory
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File
<span class="token keyword">import</span> java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>SimpleDateFormat
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ExecutorService
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>Executors

<span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> imageCamera<span class="token operator">:</span> ImageCapture<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> cameraExecutor<span class="token operator">:</span> ExecutorService
    <span class="token keyword">private</span> <span class="token keyword">var</span> videoCapture<span class="token operator">:</span> VideoCapture<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> cameraSelector <span class="token operator">=</span> CameraSelector<span class="token punctuation">.</span>DEFAULT_BACK_CAMERA<span class="token comment">//当前相机</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> preview<span class="token operator">:</span> Preview<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token comment">//预览对象</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> cameraProvider<span class="token operator">:</span> ProcessCameraProvider<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token comment">//相机信息</span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> camera<span class="token operator">:</span> Camera <span class="token comment">//相机对象</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> isRecordVideo<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> TAG <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"CameraXApp"</span></span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> outputDirectory<span class="token operator">:</span> File
    <span class="token keyword">private</span> <span class="token keyword">var</span> lensFacing<span class="token operator">:</span> Int <span class="token operator">=</span> CameraSelector<span class="token punctuation">.</span>LENS_FACING_BACK
    <span class="token keyword">private</span> <span class="token keyword">val</span> btnCameraCapture<span class="token operator">:</span> Button <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnCameraCapture<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> btnVideo<span class="token operator">:</span> Button <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnVideo<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> btnSwitch<span class="token operator">:</span> Button <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnSwitch<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> btnOpenCamera<span class="token operator">:</span> Button <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnOpenCamera<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> viewFinder<span class="token operator">:</span> PreviewView <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>mPreviewView<span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        <span class="token function">initPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        outputDirectory <span class="token operator">=</span> <span class="token function">getOutputDirectory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"RestrictedApi"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        btnCameraCapture<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        btnVideo<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRecordVideo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">takeVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                isRecordVideo <span class="token operator">=</span> <span class="token boolean">true</span>
                btnVideo<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"停止录像"</span></span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                isRecordVideo <span class="token operator">=</span> <span class="token boolean">false</span>
                videoCapture<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">stopRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//停止录制</span>
                <span class="token comment">//preview?.clear()//清除预览</span>
                btnVideo<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"开始录像"</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        btnSwitch<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            cameraSelector <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cameraSelector <span class="token operator">==</span> CameraSelector<span class="token punctuation">.</span>DEFAULT_BACK_CAMERA<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                CameraSelector<span class="token punctuation">.</span>DEFAULT_FRONT_CAMERA
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                CameraSelector<span class="token punctuation">.</span>DEFAULT_BACK_CAMERA
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRecordVideo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">startCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        btnOpenCamera<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CameraActivity<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
            <span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ImageCapture</span>
            <span class="token function">startCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
            Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> <span class="token number">33</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">,</span>
                    <span class="token function">arrayOf</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_IMAGES<span class="token punctuation">,</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_AUDIO<span class="token punctuation">,</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_VIDEO<span class="token punctuation">,</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">,</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>RECORD_AUDIO<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> REQUIRED_PERMISSIONS<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 开始拍照
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> imageCapture <span class="token operator">=</span> imageCamera <span class="token operator">?:</span> <span class="token keyword">return</span>
        <span class="token keyword">val</span> photoFile <span class="token operator">=</span> <span class="token function">createFile</span><span class="token punctuation">(</span>outputDirectory<span class="token punctuation">,</span> DATE_FORMAT<span class="token punctuation">,</span> PHOTO_EXTENSION<span class="token punctuation">)</span>
        <span class="token keyword">val</span> metadata <span class="token operator">=</span> ImageCapture<span class="token punctuation">.</span><span class="token function">Metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Mirror image when using the front camera</span>
            isReversedHorizontal <span class="token operator">=</span> lensFacing <span class="token operator">==</span> CameraSelector<span class="token punctuation">.</span>LENS_FACING_FRONT
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> outputOptions <span class="token operator">=</span>
            ImageCapture<span class="token punctuation">.</span>OutputFileOptions<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>photoFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMetadata</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        imageCapture<span class="token punctuation">.</span><span class="token function">takePicture</span><span class="token punctuation">(</span>outputOptions<span class="token punctuation">,</span> ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">object</span> <span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span><span class="token function">OnImageSavedCallback</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>exc<span class="token operator">:</span> ImageCaptureException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Photo capture failed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">exc<span class="token punctuation">.</span>message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> exc<span class="token punctuation">)</span>
                    ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 拍照失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">exc<span class="token punctuation">.</span>message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onImageSaved</span><span class="token punctuation">(</span>output<span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span>OutputFileResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">val</span> savedUri <span class="token operator">=</span> output<span class="token punctuation">.</span>savedUri <span class="token operator">?:</span> Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>photoFile<span class="token punctuation">)</span>
                    ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 拍照成功 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">savedUri</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> savedUri<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">val</span> mimeType <span class="token operator">=</span> MimeTypeMap<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getMimeTypeFromExtension</span><span class="token punctuation">(</span>savedUri<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extension<span class="token punctuation">)</span>
                    MediaScannerConnection<span class="token punctuation">.</span><span class="token function">scanFile</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">,</span>
                        <span class="token function">arrayOf</span><span class="token punctuation">(</span>savedUri<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">arrayOf</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span>
                    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> _<span class="token punctuation">,</span> uri <span class="token operator">-&gt;</span>
                        LogUtils<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>
                            TAG<span class="token punctuation">,</span>
                            <span class="token string-literal singleline"><span class="token string">"Image capture scanned into media store: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">uri<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 开始录像
     */</span>
    <span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"RestrictedApi"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"ClickableViewAccessibility"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"MissingPermission"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">takeVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//开始录像</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            isRecordVideo <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token keyword">val</span> mFileDateFormat <span class="token operator">=</span> <span class="token function">SimpleDateFormat</span><span class="token punctuation">(</span>DATE_FORMAT<span class="token punctuation">,</span> Locale<span class="token punctuation">.</span>US<span class="token punctuation">)</span>
            <span class="token comment">//视频保存路径</span>
            <span class="token keyword">val</span> file <span class="token operator">=</span>
                <span class="token function">File</span><span class="token punctuation">(</span>FileManager<span class="token punctuation">.</span><span class="token function">getCameraVideoPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mFileDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">".mp4"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> outputOptions <span class="token operator">=</span> OutputFileOptions<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            videoCapture<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">startRecording</span><span class="token punctuation">(</span>
                outputOptions<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">object</span> <span class="token operator">:</span> OnVideoSavedCallback <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onVideoSaved</span><span class="token punctuation">(</span>outputFileResults<span class="token operator">:</span> VideoCapture<span class="token punctuation">.</span>OutputFileResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        isRecordVideo <span class="token operator">=</span> <span class="token boolean">false</span>
                        LogUtils<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"===视频保存的地址为=== </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">file<span class="token punctuation">.</span>absolutePath</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                        <span class="token comment">//保存视频成功回调，会在停止录制时被调用</span>
                        ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 录像成功 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">file</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>
                        videoCaptureError<span class="token operator">:</span> Int<span class="token punctuation">,</span>
                        message<span class="token operator">:</span> String<span class="token punctuation">,</span>
                        cause<span class="token operator">:</span> Throwable<span class="token operator">?</span>
                    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//保存失败的回调，可能在开始或结束录制时被调用</span>
                        isRecordVideo <span class="token operator">=</span> <span class="token boolean">false</span>
                        LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"onError: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                        ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" 录像失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"===录像出错===</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">e<span class="token punctuation">.</span>message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 开始相机预览
     */</span>
    <span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"RestrictedApi"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">startCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cameraExecutor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> cameraProviderFuture <span class="token operator">=</span> ProcessCameraProvider<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        cameraProviderFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>Runnable <span class="token punctuation">{<!-- --></span>
            cameraProvider <span class="token operator">=</span> cameraProviderFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//获取相机信息</span>

            <span class="token comment">//预览配置</span>
            preview <span class="token operator">=</span> Preview<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
                    it<span class="token punctuation">.</span><span class="token function">setSurfaceProvider</span><span class="token punctuation">(</span>viewFinder<span class="token punctuation">.</span>surfaceProvider<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

            imageCamera <span class="token operator">=</span> ImageCapture<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCaptureMode</span><span class="token punctuation">(</span>ImageCapture<span class="token punctuation">.</span>CAPTURE_MODE_MINIMIZE_LATENCY<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            videoCapture <span class="token operator">=</span> VideoCapture<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//录像用例配置</span>
                <span class="token punctuation">.</span><span class="token function">setTargetAspectRatio</span><span class="token punctuation">(</span>AspectRatio<span class="token punctuation">.</span>RATIO_16_9<span class="token punctuation">)</span> <span class="token comment">//设置高宽比</span>
                <span class="token comment">//.setTargetRotation(viewFinder.display!!.rotation)//设置旋转角度</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                cameraProvider<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//先解绑所有用例</span>
                camera <span class="token operator">=</span> cameraProvider<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">,</span>
                    cameraSelector<span class="token punctuation">,</span>
                    preview<span class="token punctuation">,</span>
                    imageCamera<span class="token punctuation">,</span>
                    videoCapture
                <span class="token punctuation">)</span><span class="token operator">!!</span><span class="token comment">//绑定用例</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LogUtils<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Use case binding failed"</span></span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span> ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">initListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
        requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span> permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> grantResults<span class="token operator">:</span>
        IntArray
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span>
                <span class="token keyword">when</span> <span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">var</span> allPermissionsGranted <span class="token operator">=</span> <span class="token boolean">true</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>result <span class="token keyword">in</span> grantResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                allPermissionsGranted <span class="token operator">=</span> <span class="token boolean">false</span>
                                <span class="token keyword">break</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
                            allPermissionsGranted <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// 权限已授予，执行文件读写操作</span>
                                <span class="token function">startCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// 权限被拒绝，处理权限请求失败的情况</span>
                                ToastUtils<span class="token punctuation">.</span><span class="token function">shortToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"请您打开必要权限"</span></span><span class="token punctuation">)</span>
                                <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
            Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> <span class="token number">33</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> permissions <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_IMAGES<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_AUDIO<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_VIDEO<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>RECORD_AUDIO<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> permissions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> Environment<span class="token punctuation">.</span><span class="token function">isExternalStorageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> REQUIRED_PERMISSIONS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>
                            <span class="token keyword">this</span><span class="token punctuation">,</span>
                            permission
                        <span class="token punctuation">)</span> <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
                    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        cameraExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="15_3187"></a>15.实现的效果如下：</h2> 
<p><img src="https://images2.imgbox.com/b2/ce/vIBQbMkF_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a5/47/pFany83n_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f0/af/hT3bz6mW_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="16_3192"></a>16.日志打印：</h2> 
<p>模拟器日志如下：</p> 
<p><img src="https://images2.imgbox.com/9a/3e/5JSYggNb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a9/24/dBGON3BI_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/9b/c2/bQ1Rf9Ly_o.png" alt="在这里插入图片描述"><br> 真机日志打印:<br> <img src="https://images2.imgbox.com/e1/7c/qMpxsEou_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f0/6e/K5TjYtcT_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="17_3204"></a>17.选择相册的代码如下：</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>activity

<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>ContentValues
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Intent
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>Bitmap
<span class="token keyword">import</span> android<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Uri
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle
<span class="token keyword">import</span> android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>MediaStore
<span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log
<span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Button
<span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>ImageView
<span class="token keyword">import</span> com<span class="token punctuation">.</span>blankj<span class="token punctuation">.</span>utilcode<span class="token punctuation">.</span>util<span class="token punctuation">.</span>LogUtils
<span class="token keyword">import</span> com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>Glide
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>R
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span>REQUEST_CODE_CAMERA
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>Companion<span class="token punctuation">.</span>REQUEST_CODE_CROP
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>FileManager
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cameraxdemo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>FileUtil
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File

<span class="token comment">/**
 *@author: njb
 *@date:   2023/8/15 17:20
 *@desc:
 */</span>
<span class="token keyword">class</span> CameraActivity <span class="token operator">:</span><span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mUploadImageUri<span class="token operator">:</span> Uri<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mUploadImageFile<span class="token operator">:</span> File<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> photoUri<span class="token operator">:</span> Uri<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> btnCamera<span class="token operator">:</span>Button <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnCamera<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> ivAvatar<span class="token operator">:</span>ImageView <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>iv_avatar<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> TAG <span class="token operator">=</span> CameraActivity<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span>name
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_camera<span class="token punctuation">)</span>
        <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        btnCamera<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">startSystemCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 调起系统相机拍照
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">startSystemCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> takeIntent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>ACTION_IMAGE_CAPTURE<span class="token punctuation">)</span>
        <span class="token keyword">val</span> values <span class="token operator">=</span> <span class="token function">ContentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//根据uri查询图片地址</span>
        photoUri <span class="token operator">=</span> contentResolver<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">,</span> values<span class="token punctuation">)</span>
        LogUtils<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"photoUri:"</span></span> <span class="token operator">+</span> photoUri<span class="token operator">?</span><span class="token punctuation">.</span>authority <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">",photoUri:"</span></span> <span class="token operator">+</span> photoUri<span class="token operator">?</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span>
        <span class="token comment">//放入拍照后的地址</span>
        takeIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>EXTRA_OUTPUT<span class="token punctuation">,</span> photoUri<span class="token punctuation">)</span>
        <span class="token comment">//调起拍照</span>
        <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>
            takeIntent<span class="token punctuation">,</span>
            REQUEST_CODE_CAMERA
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 设置用户头像
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">setAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> file<span class="token operator">:</span> File<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mUploadImageUri <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            FileManager<span class="token punctuation">.</span><span class="token function">getMediaUri2File</span><span class="token punctuation">(</span>mUploadImageUri<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mUploadImageFile
        <span class="token punctuation">}</span>
        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>ivAvatar<span class="token punctuation">)</span>
        LogUtils<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"filepath"</span></span><span class="token operator">+</span> file<span class="token operator">!!</span><span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 系统裁剪方法
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">workCropFun</span><span class="token punctuation">(</span>imgPathUri<span class="token operator">:</span> Uri<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mUploadImageUri <span class="token operator">=</span> <span class="token keyword">null</span>
        mUploadImageFile <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>imgPathUri <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> imageObject<span class="token operator">:</span> Any <span class="token operator">=</span> FileUtil<span class="token punctuation">.</span><span class="token function">getHeadJpgFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>imageObject <span class="token keyword">is</span> Uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mUploadImageUri <span class="token operator">=</span> imageObject
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>imageObject <span class="token keyword">is</span> File<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mUploadImageFile <span class="token operator">=</span> imageObject
            <span class="token punctuation">}</span>
            <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.android.camera.action.CROP"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            intent<span class="token punctuation">.</span><span class="token function">run</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setDataAndType</span><span class="token punctuation">(</span>imgPathUri<span class="token punctuation">,</span> "image<span class="token comment">/*")// 图片资源
                putExtra("crop", "true") // 裁剪
                putExtra("aspectX", 1) // 宽度比
                putExtra("aspectY", 1) // 高度比
                putExtra("outputX", 150) // 裁剪框宽度
                putExtra("outputY", 150) // 裁剪框高度
                putExtra("scale", true) // 缩放
                putExtra("return-data", false) // true-返回缩略图-data，false-不返回-需要通过Uri
                putExtra("outputFormat", Bitmap.CompressFormat.JPEG.toString()) // 保存的图片格式
                putExtra("noFaceDetection", true) // 取消人脸识别
                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R) {
                    putExtra(MediaStore.EXTRA_OUTPUT, mUploadImageUri)
                } else {
                    val imgCropUri = Uri.fromFile(mUploadImageFile)
                    putExtra(MediaStore.EXTRA_OUTPUT, imgCropUri)
                }
            }
            startActivityForResult(
                intent, REQUEST_CODE_CROP
            )
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        if (resultCode == RESULT_OK) {
            if (requestCode == REQUEST_CODE_CAMERA) {//拍照回调
                workCropFun(photoUri)
            } else if (requestCode == REQUEST_CODE_CROP) {//裁剪回调
                setAvatar()
            }
        }
    }
}
</span></code></pre> 
<h2><a id="18_3340"></a>18.选择相册后的效果如下：</h2> 
<p><img src="https://images2.imgbox.com/3a/25/TTuwJzKW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4d/e6/H765OLm2_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="19_3344"></a>19.总结：</h2> 
<p>今天虽然遇到了不少问题，但是出现问题后调试的过程很安逸，基本找出原因和解决花费了将近3个小时才把完整的demo整理出来，花费这么久的时间有三点原因：</p> 
<p>1.Android13适配的规则没有搞清楚就直接升级更换了新版本，导致请求和拒绝后一直出错。</p> 
<p>2.CameraX新的api和录像权限没看完整导致这里来回折腾了很久，最后找到了官网api才解决。</p> 
<p>3.对于AGP8.1.0使用不熟悉，导致刚开始配置依赖也浪费了一点时间。</p> 
<p>“路漫漫其修远兮，吾将上下而求索”，后面会把整理出来的完整适配Android13的例子也放出来，还有关于AGP8.1.0配置依赖方式变更的也会整理，遇到问题进行求索的过程比结果更重要，只要有一颗战胜困难的心，相信问题最终都会解决，如果感兴趣的可以尝试一下，若有其他问题可以提出来一起讨论解决，共同学习，一起成长.</p> 
<h2><a id="20demo_3356"></a>20.demo源码地址如下：</h2> 
<p><a href="https://gitee.com/jackning_admin/camera-xdemo" rel="nofollow">https://gitee.com/jackning_admin/camera-xdemo</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cd99666cd06b6dfac541c6a3c7fbcbae/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">arm版linux安装mysql8</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6f61dfaa89a0fbb8d715d9e3f3c9af86/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">学习过程中的一些bug，最新的就加在最前面吧</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>