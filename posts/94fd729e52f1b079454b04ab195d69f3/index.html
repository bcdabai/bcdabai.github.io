<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux GPIO驱动部分函数 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux GPIO驱动部分函数" />
<meta property="og:description" content="一、设备树—API
①of_find_compatible_node 函数
②of_get_named_gpio 函数
③irq_of_parse_and_map 函数
二、GPIO—API
①gpio_request 函数
②gpio_free 函数
③gpio_direction_input 函数
④gpio_direction_output 函数
⑤gpio_is_valid 函数
⑥gpio_get_value 函数
⑦gpio_set_value 函数
三、中断—API
①request_irq 函数
②free_irq 函数
③enable_irq()与disable_irq()函数
四、Pinctrl—API ①devm_pinctrl_get 函数
②devm_pinctrl_put 函数
③pinctrl_lookup_state 函数
④pinctrl_select_state函数
inux驱动开发，首先从使用驱动的API开始，先会使用API，然后才能更深入的分析，本篇所列的都是驱动开发中非常常用的API，之所以从设备树API开始，是本人觉得驱动开发的源头在设备树，并且大部分驱动都跟设备树相关。
一、设备树—API ①of_find_compatible_node 函数 of_find_compatible_node 函数根据 device_type 和 compatible 这两个属性查找指定的节点， 函数原型如下： struct device_node *of_find_compatible_node(struct device_node,*from, const char *type,
const char *compatible) 函数参数和返回值含义如下： from：开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。 type：要查找的节点对应的 type 字符串，也就是 device_type 属性值，可以为 NULL，表示忽略掉 device_type 属性。 compatible：要查找的节点所对应的 compatible 属性列表。 返回值：找到的节点，如果为 NULL 表示查找失败 ②of_get_named_gpio 函数 此函数获取 GPIO 编号，因为 Linux 内核中关于 GPIO 的 API 函数都要使用 GPIO 编号，此函数会将设备树中类似&lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;的属性信息转换为对应的 GPIO 编号，此函数在驱动中使用很频繁！函数原型如下： int of_get_named_gpio(struct device_node *np, const char *propname, int index) 函数参数和返回值含义如下： np：设备节点。 propname：包含要获取 GPIO 信息的属性名。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/94fd729e52f1b079454b04ab195d69f3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-21T10:58:56+08:00" />
<meta property="article:modified_time" content="2022-10-21T10:58:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux GPIO驱动部分函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <div id="article_content" class="article_content clearfix"> 
 <div id="content_views" class="htmledit_views"> 
  <p id="%E4%B8%80%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E2%80%94API-toc"><a href="#%E4%B8%80%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E2%80%94API" rel="nofollow noopener noreferrer" title="一、设备树—API" target="_self">一、设备树—API</a></p> 
  <p id=""><a href="#t0" rel="nofollow noopener noreferrer" title="①of_find_compatible_node 函数" target="_self">①of_find_compatible_node 函数</a></p> 
  <p id=""><a href="#t1" rel="nofollow noopener noreferrer" title="②of_get_named_gpio 函数" target="_self">②of_get_named_gpio 函数</a></p> 
  <p id=""><a href="#t2" rel="nofollow noopener noreferrer" title="③irq_of_parse_and_map 函数" target="_self">③irq_of_parse_and_map 函数</a></p> 
  <p id=""><a href="#t3" rel="nofollow noopener noreferrer" title="二、GPIO—API" target="_self">二、GPIO—API</a></p> 
  <p id=""><a href="#t4" rel="nofollow noopener noreferrer" title="①gpio_request 函数" target="_self">①gpio_request 函数</a></p> 
  <p id=""><a href="#t5" rel="nofollow noopener noreferrer" title="②gpio_free 函数" target="_self">②gpio_free 函数</a></p> 
  <p id=""><a href="#t6" rel="nofollow noopener noreferrer" title="③gpio_direction_input 函数" target="_self">③gpio_direction_input 函数</a></p> 
  <p id=""><a href="#t7" rel="nofollow noopener noreferrer" title="④gpio_direction_output 函数" target="_self">④gpio_direction_output 函数</a></p> 
  <p id=""><a href="#t8" rel="nofollow noopener noreferrer" title="⑤gpio_is_valid 函数" target="_self">⑤gpio_is_valid 函数</a></p> 
  <p id=""><a href="#t9" rel="nofollow noopener noreferrer" title="⑥gpio_get_value 函数" target="_self">⑥gpio_get_value 函数</a></p> 
  <p id=""><a href="#t10" rel="nofollow noopener noreferrer" title="⑦gpio_set_value 函数" target="_self">⑦gpio_set_value 函数</a></p> 
  <p id=""><a href="#t11" rel="nofollow noopener noreferrer" title="三、中断—API" target="_self">三、中断—API</a></p> 
  <p id=""><a href="#t12" rel="nofollow noopener noreferrer" title="①request_irq 函数" target="_self">①request_irq 函数</a></p> 
  <p id=""><a href="#t13" rel="nofollow noopener noreferrer" title="②free_irq 函数" target="_self">②free_irq 函数</a></p> 
  <p id=""><a href="#t14" rel="nofollow noopener noreferrer" title="③enable_irq()与disable_irq()函数" target="_self">③enable_irq()与disable_irq()函数</a></p> 
  <p id=""><a href="#t15" rel="nofollow noopener noreferrer" title="四、Pinctrl—API " target="_self">四、Pinctrl—API </a></p> 
  <p id=""><a href="#t16" rel="nofollow noopener noreferrer" title="①devm_pinctrl_get 函数" target="_self">①devm_pinctrl_get 函数</a></p> 
  <p id=""><a href="#t17" rel="nofollow noopener noreferrer" title="②devm_pinctrl_put 函数" target="_self">②devm_pinctrl_put 函数</a></p> 
  <p id=""><a href="#t18" rel="nofollow noopener noreferrer" title="③pinctrl_lookup_state 函数" target="_self">③pinctrl_lookup_state 函数</a></p> 
  <p id=""><a href="#t19" rel="nofollow noopener noreferrer" title="④pinctrl_select_state函数" target="_self">④pinctrl_select_state函数</a></p> 
  <hr id="hr-toc"> 
  <p>inux驱动开发，首先从使用驱动的<a href="https://so.csdn.net/so/search?q=API&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" rel="noopener noreferrer">API</a>开始，先会使用API，然后才能更深入的分析，本篇所列的都是驱动开发中非常常用的API，之所以从设备树API开始，是本人觉得驱动开发的源头在设备树，并且大部分驱动都跟设备树相关。</p> 
  <h2 id="%E4%B8%80%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E2%80%94API">一、设备树—API</h2> 
  <h3 id="%E2%91%A0of_find_compatible_node%20%E5%87%BD%E6%95%B0"><strong><strong>①of_find_compatible_node </strong></strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>of_find_compatible_node 函数根据 device_type 和 compatible 这两个属性查找指定的节点， 函数原型如下： </p> 
   <p>struct device_node *of_find_compatible_node(struct device_node,*from, const char *type,</p> 
   <p> const char *compatible) </p> 
   <p>函数参数和返回值含义如下： </p> 
   <p><strong><strong>from</strong></strong>：开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。 </p> 
   <p><strong><strong>type</strong></strong>：要查找的节点对应的 type 字符串，也就是 device_type 属性值，可以为 NULL，表示忽略掉 device_type 属性。 </p> 
   <p><strong><strong>compatible</strong></strong><strong><strong>：</strong></strong>要查找的节点所对应的 compatible 属性列表。 </p> 
   <p><strong><strong>返回值：</strong></strong>找到的节点，如果为 NULL 表示查找失败 </p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A1of_get_named_gpio%20%E5%87%BD%E6%95%B0"><strong><strong>②of_get_named_gpio </strong></strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>此函数获取 GPIO 编号，因为 Linux 内核中关于 GPIO 的 API 函数都要使用 GPIO 编号，此函数会将设备树中类似&lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;的属性信息转换为对应的 GPIO 编号，此函数在驱动中使用很频繁！函数原型如下： </p> 
   <p>int of_get_named_gpio(struct device_node *np, const char *propname, int index) </p> 
   <p>函数参数和返回值含义如下： </p> 
   <p><strong><strong>np</strong></strong>：设备节点。 </p> 
   <p><strong><strong>propname</strong></strong>：包含要获取 GPIO 信息的属性名。</p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A2irq_of_parse_and_map%20%E5%87%BD%E6%95%B0"><strong><strong>③irq_of_parse_and_map </strong></strong><strong><strong>函数</strong></strong></h3> 
  <blockquote> 
   <p>编写驱动的时候需要用到中断号，我们用到中断号，中断信息已经写到了设备树里面，因 </p> 
   <p>此可以通过 irq_of_parse_and_map 函数从 interupts 属性中提取到对应的设备号，函数原型如下： unsigned int irq_of_parse_and_map(struct device_node *dev, int index) </p> 
   <p>函数参数和返回值含义如下： </p> 
   <p><strong><strong>dev</strong></strong><strong><strong>：</strong></strong>设备节点。 </p> 
   <p><strong><strong>index</strong></strong>：索引号，interrupts 属性可能包含多条中断信息，通过 index 指定要获取的信息。 </p> 
   <p>返回值：中断号。 </p> 
  </blockquote> 
  <p></p> 
  <p id="%E7%A4%BA%E4%BE%8B">示例</p> 
  <pre class="set-code-hide"><code class="hljs language-objectivec"></code>
   
   <ol class="hljs-ln"><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//设备树节点</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       &amp;misc {
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           compatible = 
       
       <span class="hljs-string">"misc,test"</span>;    
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           interrupt-parent = &lt;&amp;pio&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	interrupts = &lt;
       
       <span class="hljs-number">8</span> IRQ_TYPE_EDGE_FALLING&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	test-gpio = &lt;&amp;pio 
       
       <span class="hljs-number">30</span> 
       
       <span class="hljs-number">0</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       };
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//API使用示例</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取指定节点，获取不到时返回NULL</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-keyword">struct</span> device_node *nd = of_find_compatible_node(
       
       <span class="hljs-literal">NULL</span>, 
       
       <span class="hljs-literal">NULL</span>, 
       
       <span class="hljs-string">"misc,test"</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取GPIO编号，获取不到时返回负值</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-type">int</span> test_gpio = of_get_named_gpio(nd, 
       
       <span class="hljs-string">"test-gpio"</span>, 
       
       <span class="hljs-number">0</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取中断号，获取不到时返回负值</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-keyword">static</span> 
       
       <span class="hljs-type">unsigned</span> 
       
       <span class="hljs-type">int</span> tp_irq = irq_of_parse_and_map(nd, 
       
       <span class="hljs-number">0</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       ...
      
      </div>
     
     </div></li></ol>
   
   <div class="hide-preCode-box">
    
    <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/22/a1/zSxktHk3_o.png" alt="" title=""></span>
   
   </div>
   
   <div class="hljs-button {2}"></div></pre> 
  <p></p> 
  <h2 id="%E4%BA%8C%E3%80%81GPIO%E2%80%94API"><strong><strong>二、GPIO—API</strong></strong></h2> 
  <h3 id="%E2%91%A0gpio_request%20%E5%87%BD%E6%95%B0"><strong><strong>①gpio_request </strong></strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>gpio_request 函数用于申请一个 GPIO 管脚，在使用一个 GPIO 之前一定要使用 gpio_request 进行申请</p> 
   <p>函数原型如下： </p> 
   <p>int gpio_request(unsigned gpio, const char *label) </p> 
   <p>函数参数和返回值含义如下： </p> 
   <p><strong><strong>gpio</strong></strong>：要申请的 gpio 标号，使用 of_get_named_gpio 函数从设备树获取指定 GPIO 属性信息，此函数会返回这个 GPIO 的标号。 </p> 
   <p><strong><strong>label</strong></strong>：给 gpio 设置个名字。 </p> 
   <p><strong><strong>返回值：</strong></strong>0，申请成功；其他值，申请失败。</p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A1gpio_free%20%E5%87%BD%E6%95%B0"><strong><strong>②gpio_free </strong></strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>如果不使用某个 GPIO 了，那么就可以调用 gpio_free 函数进行释放。函数原型如下： </p> 
   <p>void gpio_free(unsigned gpio) </p> 
   <p>函数参数和返回值含义如下： </p> 
   <p><strong><strong>gpio</strong></strong>：要释放的 gpio 标号。 </p> 
   <p><strong><strong>返回值：</strong></strong>无。 </p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A2gpio_direction_input%20%E5%87%BD%E6%95%B0"><strong><strong>③gpio_direction_input </strong></strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>此函数用于设置某个 GPIO 为输入，函数原型如下所示： </p> 
   <p>int gpio_direction_input(unsigned gpio) </p> 
   <p>函数参数和返回值含义如下： </p> 
   <p><strong><strong>gpio</strong></strong>：要设置为输入的 GPIO 标号。 </p> 
   <p><strong><strong>返回值：</strong></strong>0，设置成功；负值，设置失败。</p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A3gpio_direction_output%20%E5%87%BD%E6%95%B0"><strong><strong>④gpio_direction_output </strong></strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>此函数用于设置某个 GPIO 为输出，并且设置默认输出值，函数原型如下： </p> 
   <p>int gpio_direction_output(unsigned gpio, int value) </p> 
   <p>函数参数和返回值含义如下： </p> 
   <p><strong><strong>gpio</strong></strong>：要设置为输出的 GPIO 标号。 </p> 
   <p><strong><strong>value</strong></strong><strong><strong>：</strong></strong>GPIO 默认输出值。 </p> 
   <p><strong><strong>返回值：</strong></strong>0，设置成功；负值，设置失败。</p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A4gpio_is_valid%C2%A0%E5%87%BD%E6%95%B0"><strong><strong>⑤gpio_is_valid</strong> </strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>检测gpio端口是否合法，函数原型如下：</p> 
   <p>int gpio_is_valid(int number); </p> 
   <p>函数参数和返回值含义如下：</p> 
   <p><strong><strong>n</strong></strong><strong><strong>umber</strong></strong><strong><strong>：</strong></strong>gpio端口号</p> 
   <p><strong><strong>返回值：</strong></strong>无效反为0</p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A4gpio_get_value%20%E5%87%BD%E6%95%B0"><strong><strong>⑥gpio_get_value 函数 </strong></strong></h3> 
  <blockquote> 
   <p>此函数用于获取某个 GPIO 的值(0 或 1)，此函数是个宏，定义所示： </p> 
   <p>#define gpio_get_value __gpio_get_value </p> 
   <p>int __gpio_get_value(unsigned gpio) </p> 
   <p>函数参数和返回值含义如下：</p> 
   <p><strong><strong>gpio</strong></strong>：要获取的 GPIO 标号。 </p> 
   <p><strong><strong>返回值：</strong></strong>非负值，得到的 GPIO 值；负值，获取失败。</p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A5gpio_set_value%20%E5%87%BD%E6%95%B0"><strong><strong>⑦gpio_set_value </strong></strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>此函数用于设置某个 GPIO 的值，此函数是个宏，定义如下 </p> 
   <p>#define gpio_set_value __gpio_set_value </p> 
   <p>void __gpio_set_value(unsigned gpio, int value) </p> 
   <p>函数参数和返回值含义如下： </p> 
   <p><strong><strong>gpio</strong></strong>：要设置的 GPIO 标号。 </p> 
   <p><strong><strong>value</strong></strong><strong><strong>：</strong></strong>要设置的值。 </p> 
   <p><strong><strong>返回值：</strong></strong>无 </p> 
  </blockquote> 
  <p></p> 
  <p>示例</p> 
  <pre class="set-code-hide"><code class="hljs language-objectivec"></code>
   
   <ol class="hljs-ln"><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//设备树节点</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       &amp;misc {
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           compatible = 
       
       <span class="hljs-string">"misc,test"</span>;    
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           interrupt-parent = &lt;&amp;pio&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	interrupts = &lt;
       
       <span class="hljs-number">8</span> IRQ_TYPE_EDGE_FALLING&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	test-gpio = &lt;&amp;pio 
       
       <span class="hljs-number">30</span> 
       
       <span class="hljs-number">0</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       };
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//API使用示例</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取指定节点，获取不到时返回NULL</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-keyword">struct</span> device_node *nd = of_find_compatible_node(
       
       <span class="hljs-literal">NULL</span>, 
       
       <span class="hljs-literal">NULL</span>, 
       
       <span class="hljs-string">"misc,test"</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取GPIO编号，获取不到时返回负值</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-type">int</span> test_gpio = of_get_named_gpio(nd, 
       
       <span class="hljs-string">"test-gpio"</span>, 
       
       <span class="hljs-number">0</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       /
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       /
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//设置gpio为输出，同时设置输出寄存器为0，即低电平</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-type">int</span> val = gpio_direction_output(test_gpio, 
       
       <span class="hljs-number">0</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取gpio状态，高低电平(0或1)</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-type">int</span> status = gpio_get_value(test_gpio);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//设置gpio输出寄存器为1，即高电平</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       gpio_set_value（test_gpio, 
       
       <span class="hljs-number">1</span>）;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//读写操作可能导致睡眠，在中断中就需要使用带cansleep的函数</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//gpio_get_value_cansleep(test_gpio);</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//gpio_set_value_cansleep(test_gpio, 1);</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//设置gpio为输入</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       gpio_direction_input(test_gpio);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       ...
      
      </div>
     
     </div></li></ol>
   
   <div class="hide-preCode-box">
    
    <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/d3/e6/MK74hcyb_o.png" alt="" title=""></span>
   
   </div>
   
   <div class="hljs-button {2}"></div></pre> 
  <p></p> 
  <h2 id="%E4%B8%89%E3%80%81%E4%B8%AD%E6%96%AD%E2%80%94API">三、中断—API</h2> 
  <p></p> 
  <h3 id="%E2%91%A0request_irq%20%E5%87%BD%E6%95%B0"><strong><strong>①request_irq </strong></strong><strong><strong>函数 </strong></strong></h3> 
  <blockquote> 
   <p>在 Linux 内核中要想使用某个中断是需要申请的，request_irq 函数用于申请中断，request_irq 函数可能会导致睡眠，因此不能在中断上下文或者其他禁止睡眠的代码段中使用 request_irq 函数。request_irq 函数会激活(使能)中断，所以不需要我们手动去使能中断</p> 
   <p>request_irq 函数原型如下： </p> 
   <p>int request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags, const char *name, </p> 
   <p>void *dev) 函数参数和返回值含义如下： </p> 
   <p><strong><strong>irq</strong></strong>：要申请中断的中断号。 </p> 
   <p><strong><strong>handler</strong></strong>：中断处理函数，当中断发生以后就会执行此中断处理函数。 </p> 
   <p><strong><strong>flags</strong></strong>：中断标志，可以在文件 include/linux/interrupt.h 里面查看所有的中断标志</p> 
   <p><strong><strong>name</strong></strong>：中断名字，设置以后可以在/proc/interrupts 文件中看到对应的中断名字。 </p> 
   <p><strong><strong>dev</strong></strong><strong><strong>：</strong></strong>如果将 flags 设置为 IRQF_SHARED 的话，dev 用来区分不同的中断，一般情况下将dev 设置为设备结构体，dev 会传递给中断处理函数 irq_handler_t 的第二个参数。 </p> 
   <p><strong><strong>返回值：</strong></strong>0 中断申请成功，其他负值 中断申请失败，如果返回-EBUSY 的话表示中断已经 </p> 
   <p>被申请了。 </p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A1free_irq%20%E5%87%BD%E6%95%B0"><strong><strong>②free_irq 函数</strong></strong></h3> 
  <blockquote> 
   <p>void free_irq(unsigned int irq, void *dev_id)</p> 
   <p>关于该函数参数的一些说明如下：</p> 
   <ul><li>irq参数是已经申请的硬件中断号；</li><li>dev_id参数和request_irq()函数的dev参数对应，一般为设备的设备结构体或者 NULL。</li></ul> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A2enable_irq()%E4%B8%8Edisable_irq()%E5%87%BD%E6%95%B0">③enable_irq()与disable_irq()函数</h3> 
  <blockquote> 
   <p>在Linux设备驱动中断编程中，如果想要使能或者屏蔽中断的话，可以使用enable_irq()和disable_irq()内核函数接口。</p> 
   <p>使能中断IRQ，可以使用enable_irq()函数接口，该函数的定义如下：</p> 
   <pre class="set-code-hide"><code class="language-cpp hljs"></code>
    
    <ol class="hljs-ln"><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">enable_irq</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> irq)</span></span>
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        {
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
            
        
        <span class="hljs-type">unsigned</span> 
        
        <span class="hljs-type">long</span> flags;
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">    
        
        <span class="hljs-keyword">struct</span> 
        
        <span class="hljs-title class_">irq_desc</span> *desc = 
        
        <span class="hljs-built_in">irq_get_desc_buslock</span>(irq, &amp;flags,
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
            IRQ_GET_DESC_CHECK_GLOBAL);
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line"> 
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
            
        
        <span class="hljs-keyword">if</span> (!desc)
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
                
        
        <span class="hljs-keyword">return</span>;
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line"> 
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
            
        
        <span class="hljs-keyword">if</span> (
        
        <span class="hljs-built_in">WARN</span>(!desc-&gt;irq_data.chip, \
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
                KERN_ERR
        
        <span class="hljs-string">"enable_irq before setup/request_irq: irq %u\n"</span>, irq))
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
                
        
        <span class="hljs-keyword">goto</span> out;
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line"> 
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
            __enable_irq(desc);
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        out:
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
            
        
        <span class="hljs-built_in">irq_put_desc_busunlock</span>(desc, flags);
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        }
       
       </div>
      
      </div></li></ol>
    
    <div class="hide-preCode-box">
     
     <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/24/94/A70jn7Kk_o.png" alt="" title=""></span>
    
    </div>
    
    <div class="hljs-button {2}"></div></pre> 
   <p>屏蔽中断IRQ，可以使用disable_irq()和disable_irq_nosync()函数，这两个函数的定义如下：</p> 
   <pre><code class="hljs language-perl"></code>
    
    <ol class="hljs-ln"><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        void disable_ir
        
        <span class="hljs-string">q(unsigned int irq)</span>
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        {
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
            
        
        <span class="hljs-keyword">if</span> (!__disable_irq_nosync(irq))
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
                synchronize_ir
        
        <span class="hljs-string">q(irq)</span>;
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        }
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line"> 
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        void disable_irq_nosync(unsigned 
        
        <span class="hljs-keyword">int</span> irq)
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        {
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
            __disable_irq_nosync(irq);
       
       </div>
      
      </div></li><li>
      
      <div class="hljs-ln-numbers">
       
       <div class="hljs-ln-line hljs-ln-n"></div>
      
      </div>
      
      <div class="hljs-ln-code">
       
       <div class="hljs-ln-line">
        
        }
       
       </div>
      
      </div></li></ol>
    
    <div class="hljs-button {2}"></div></pre> 
   <p>两个函数的形参都是irq，表示要屏蔽中断的硬件中断号，这两个函数的区别在于，disable_irq()函数会等待目前的中断处理完成，而disable_irq_nosync()函数则不会等待。</p> 
  </blockquote> 
  <p id="%E7%A4%BA%E4%BE%8B%EF%BC%9A">示例：</p> 
  <pre class="set-code-hide"><code class="hljs language-cpp"></code>
   
   <ol class="hljs-ln"><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//设备树节点</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       &amp;misc {
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           compatible = 
       
       <span class="hljs-string">"misc,test"</span>;    
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           interrupt-parent = &lt;&amp;pio&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	interrupts = &lt;
       
       <span class="hljs-number">8</span> IRQ_TYPE_EDGE_FALLING&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	test-gpio = &lt;&amp;pio 
       
       <span class="hljs-number">30</span> 
       
       <span class="hljs-number">0</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       };
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//API使用示例</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取指定节点，获取不到时返回NULL</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-keyword">struct</span> 
       
       <span class="hljs-title class_">device_node</span> *nd = 
       
       <span class="hljs-built_in">of_find_compatible_node</span>(
       
       <span class="hljs-literal">NULL</span>, 
       
       <span class="hljs-literal">NULL</span>, 
       
       <span class="hljs-string">"misc,test"</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取GPIO编号，获取不到时返回负值</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-type">int</span> test_gpio = 
       
       <span class="hljs-built_in">of_get_named_gpio</span>(nd, 
       
       <span class="hljs-string">"test-gpio"</span>, 
       
       <span class="hljs-number">0</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获取中断号，获取不到时返回负值</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-type">static</span> 
       
       <span class="hljs-type">unsigned</span> 
       
       <span class="hljs-type">int</span> tp_irq = 
       
       <span class="hljs-built_in">irq_of_parse_and_map</span>(nd, 
       
       <span class="hljs-number">0</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//申请一个 GPIO ，使用前需要向系统申请一下，别人就用不能用了</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-built_in">gpio_request</span>(test_gpio, 
       
       <span class="hljs-string">"test_gpio"</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//申请中断，同时注册test_interrupt_handler为回调函数</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-type">int</span> ret = 
       
       <span class="hljs-built_in">request_irq</span>(tp_irq, (
       
       <span class="hljs-type">irq_handler_t</span>) test_interrupt_handler, IRQF_TRIGGER_FALLING, 
       
       <span class="hljs-string">"test-eint"</span>, 
       
       <span class="hljs-literal">NULL</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       ...
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li></ol>
   
   <div class="hide-preCode-box">
    
    <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/61/20/PoO6gaKR_o.png" alt="" title=""></span>
   
   </div>
   
   <div class="hljs-button {2}"></div></pre> 
  <p></p> 
  <h2 id="%E5%9B%9B%E3%80%81Pinctrl%E2%80%94API%C2%A0"><strong><strong>四、Pinctrl—API </strong></strong></h2> 
  <h3 id="%E2%91%A0devm_pinctrl_get%C2%A0%E5%87%BD%E6%95%B0"><strong><strong>①devm_pinctrl_get 函数</strong></strong></h3> 
  <blockquote> 
   <p>struct pinctrl * devm_pinctrl_get(struct device *dev); </p> 
   <p>函数功能：根据设备获取pin操作句柄，所有的pin操作必须基于此pinctrl句柄。与pinctrl_get接口功能完全一样，只是devm_pinctrl_get会将申请的pinctrl句柄做记账，绑定到设备句柄信息中。设备驱动申请pin资源，推荐优先使用devm_pinctrl_get接口。 </p> 
   <p>返回值 pinctrl句柄 </p> 
   <p>参数 dev：使用pin的设备，pinctrl子系统会通过设备名与pin配置信息匹配。 </p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A1devm_pinctrl_put%C2%A0%E5%87%BD%E6%95%B0"><strong><strong>②devm_pinctrl_put 函数</strong></strong></h3> 
  <blockquote> 
   <p>函数原型 void devm_pinctrl_put(struct pinctrl *p); </p> 
   <p>函数功能 释放pinctrl句柄，必须与devm_pinctrl_get配对使用。 </p> 
   <p>返回值 无 </p> 
   <p>参数 p：pinctrl句柄 </p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A2pinctrl_lookup_state%C2%A0%E5%87%BD%E6%95%B0"><strong><strong>③pinctrl_lookup_state 函数</strong></strong></h3> 
  <blockquote> 
   <p>函数原型 struct pinctrl_state * pinctrl_lookup_state(struct pinctrl *p, const char *name); </p> 
   <p>函数功能 查找pin句柄指定状态下的状态句柄。 </p> 
   <p>返回值 状态句柄 </p> 
   <p>参数 p：pinctrl句柄 </p> 
   <p>name：状态名称，A33平台上只有default一种状态</p> 
  </blockquote> 
  <p></p> 
  <h3 id="%E2%91%A3pinctrl_select_state%E5%87%BD%E6%95%B0"><strong><strong>④pinctrl_select_state函数</strong></strong></h3> 
  <blockquote> 
   <p>函数原型 int pinctrl_select_state(struct pinctrl *p, struct pinctrl_state *s);</p> 
   <p>函数功能 设置pin句柄的状态到硬件</p> 
   <p>返回值 0表示成功，其它表示失败</p> 
   <p>参数 p：pinctrl句柄 </p> 
   <p>S：状态句柄</p> 
  </blockquote> 
  <p></p> 
  <p>示例</p> 
  <pre class="set-code-hide"><code class="language-cpp hljs"></code>
   
   <ol class="hljs-ln"><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//设备树节点</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-keyword">default</span>: tp_test_pins_1: eint@
       
       <span class="hljs-number">8</span> {
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           pins_cmd_dat {
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
               pins = &lt;MT8163_PIN_30_EINT8__FUNC_GPIO30&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">        
       
       <span class="hljs-comment">/*配置成输入下拉*/</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
               slew-rate = &lt;
       
       <span class="hljs-number">0</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
               bias-pull-down = &lt;
       
       <span class="hljs-number">00</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">        
       
       <span class="hljs-comment"><span class="hljs-comment">/*//配置成输入pull disable</span></span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        slew-rate = &lt;0&gt;;</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        bias-disable;</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment"></span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        //配置成输出high</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        slew-rate = &lt;1&gt;;</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        bias-disable;</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        output-high;</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment"></span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        //配置成输出low</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        slew-rate = &lt;1&gt;;</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        bias-disable;</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">        output-low;*/</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	};
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       };
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">	
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       tp_test_pins_1: eint@
       
       <span class="hljs-number">8</span> {
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	pins_cmd_dat {
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       		pins = &lt;MT8163_PIN_30_EINT8__FUNC_GPIO30&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       		slew-rate = &lt;
       
       <span class="hljs-number">1</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       		bias-disable;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
               output-high;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	};
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       };
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       &amp;misc {
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           compatible = 
       
       <span class="hljs-string">"misc,test"</span>;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           interrupt-parent = &lt;&amp;pio&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	interrupts = &lt;
       
       <span class="hljs-number">8</span> IRQ_TYPE_EDGE_FALLING&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           eint-debounce = &lt;
       
       <span class="hljs-number">256</span>&gt;;	
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           pinctrl-names = 
       
       <span class="hljs-string">"default"</span>,
       
       <span class="hljs-string">"tp_test_1"</span>;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           pinctrl
       
       <span class="hljs-number">-0</span> = &lt;&amp;
       
       <span class="hljs-keyword">default</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	pinctrl
       
       <span class="hljs-number">-1</span> = &lt;&amp;tp_test_pins_1&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	test1-gpio = &lt;&amp;pio 
       
       <span class="hljs-number">30</span> 
       
       <span class="hljs-number">0</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
           test2-gpio = &lt;&amp;pio 
       
       <span class="hljs-number">31</span> 
       
       <span class="hljs-number">0</span>&gt;;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       	status = 
       
       <span class="hljs-string">"okay"</span>;
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       };
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//获得设备对应的pin control state holder</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-type">static</span> 
       
       <span class="hljs-keyword">struct</span> 
       
       <span class="hljs-title class_">pinctrl</span> *pinctrl_test = 
       
       <span class="hljs-built_in">devm_pinctrl_get</span>(&amp;dev);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//查找pin control state</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-keyword">struct</span> 
       
       <span class="hljs-title class_">pinctrl_state</span> *tp_test_1 = 
       
       <span class="hljs-built_in">pinctrl_lookup_state</span>(pinctrl_test, 
       
       <span class="hljs-string">"default"</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-keyword">struct</span> 
       
       <span class="hljs-title class_">pinctrl_state</span> *tp_test_2 = 
       
       <span class="hljs-built_in">pinctrl_lookup_state</span>(pinctrl_test, 
       
       <span class="hljs-string">"tp_test_1"</span>);
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-comment">//设置gpio功能</span>
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-built_in">pinctrl_select_state</span>(pinctrl_test, tp_test_1 );
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line">
       
       <span class="hljs-built_in">pinctrl_select_state</span>(pinctrl_test, tp_test_2 );
      
      </div>
     
     </div></li><li>
     
     <div class="hljs-ln-numbers">
      
      <div class="hljs-ln-line hljs-ln-n"></div>
     
     </div>
     
     <div class="hljs-ln-code">
      
      <div class="hljs-ln-line"> 
      
      </div>
     
     </div></li></ol>
   
   <div class="hide-preCode-box">
    
    <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/da/c3/DJy483Qd_o.png" alt="" title=""></span>
   
   </div>
   
   <div class="hljs-button {2}"></div></pre> 
  <p></p> 
  <blockquote> 
   <p>注：Pinctrl模块兼容GPIO的功能，如果pin是作为GPIO input/output,仍然可以使用gpiolib中的标准接口，但是如果要使用GPIO的复用功能，则需要使用pinctrl接口。</p> 
   <p>在驱动代码中我们经常会见到一些以devm开头的函数，这一类的函数都是和设备资源管理（Managed Device Resource）相关的，驱动中提供这些函数主要是为了方便对于申请的资源进行释放，比如：irq、regulator、gpio等等。在驱动进行初始化的时候如果失败，那么通常会goto到某个地方释放资源，这样的标签多了之后会让代码看起来不简洁，devm就是为来处理这种情况。</p> 
  </blockquote> 
 </div> 
 <div> 
  <div></div> 
 </div> 
</div> 转载至博客 https://blog.csdn.net/maodewen11/article/details/120651677
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3d4d8edac412d6ded3c1cb112f5cdc34/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【算法】放货物</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/499040b46dd0df6fd8d8b624bcac2e35/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ucharts 图表接口数据处理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>