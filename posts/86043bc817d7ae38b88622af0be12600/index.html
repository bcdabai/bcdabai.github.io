<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>tensorflow core ---Image classification图片分类 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="tensorflow core ---Image classification图片分类" />
<meta property="og:description" content="learn -tutorial -tensorflow core —Image classification
文章目录 导入TensorFlow和其他库下载并浏览数据集使用keras.preprocessing加载可视化数据配置数据集以提高性能标准化数据注意:注意： 创建模型编译模型model summary训练模型可视化training结果过度拟合Data augmentation Dropout编译和训练模型可视化training结果预测新数据注意： 总结 本教程显示如何对花朵图像进行分类。它使用
keras.Sequential
模型创建图像分类器，并使用加载数据
preprocessing.image_dataset_from_directory
您将获得以下概念的实践经验：
有效地从磁盘加载数据集。
识别过度拟合并应用techiniques 减轻过拟合，包括 data augmentation and Dropout.。
本教程遵循基本的机器学习工作流程：
检查并了解数据
建立输入管道
建立模型
训练模型
测试模型
改进模型并重复该过程
导入TensorFlow和其他库 import matplotlib.pyplot as plt import numpy as np import os import PIL import tensorflow as tf from tensorflow import keras from tensorflow.keras import layers from tensorflow.keras.models import Sequential 下载并浏览数据集 本教程使用约3700张花朵照片的数据集。数据集包含5个子目录，每个类一个：
flower_photo/ daisy/ dandelion/ roses/ sunflowers/ tulips/ import pathlib dataset_url = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/86043bc817d7ae38b88622af0be12600/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-23T16:39:41+08:00" />
<meta property="article:modified_time" content="2021-05-23T16:39:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">tensorflow core ---Image classification图片分类</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>learn -tutorial -tensorflow core —Image classification</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#TensorFlow_24" rel="nofollow">导入TensorFlow和其他库</a></li><li><a href="#_37" rel="nofollow">下载并浏览数据集</a></li><li><a href="#keraspreprocessing_98" rel="nofollow">使用keras.preprocessing加载</a></li><li><a href="#_147" rel="nofollow">可视化数据</a></li><li><a href="#_199" rel="nofollow">配置数据集以提高性能</a></li><li><a href="#_214" rel="nofollow">标准化数据</a></li><li><ul><li><ul><li><a href="#_219" rel="nofollow">注意:</a></li><li><a href="#_236" rel="nofollow">注意：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_239" rel="nofollow">创建模型</a></li><li><a href="#_258" rel="nofollow">编译模型</a></li><li><a href="#model_summary_267" rel="nofollow">model summary</a></li><li><a href="#_303" rel="nofollow">训练模型</a></li><li><a href="#training_313" rel="nofollow">可视化training结果</a></li><li><a href="#_346" rel="nofollow">过度拟合</a></li><li><ul><li><a href="#Data_augmentation_354" rel="nofollow">Data augmentation</a></li></ul> 
  </li><li><a href="#Dropout_388" rel="nofollow">Dropout</a></li><li><a href="#_411" rel="nofollow">编译和训练模型</a></li><li><a href="#training_431" rel="nofollow">可视化training结果</a></li><li><a href="#_458" rel="nofollow">预测新数据</a></li><li><ul><li><ul><li><a href="#_461" rel="nofollow">注意：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_487" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<p>本教程显示如何对花朵图像进行分类。它使用<br> keras.Sequential<br> 模型创建图像分类器，并使用加载数据<br> preprocessing.image_dataset_from_directory</p> 
<p>您将获得以下概念的实践经验：</p> 
<p>有效地从磁盘加载数据集。<br> 识别过度拟合并应用techiniques 减轻过拟合，包括 data augmentation and Dropout.。</p> 
<p>本教程遵循基本的机器学习工作流程：</p> 
<p>检查并了解数据<br> 建立输入管道<br> 建立模型<br> 训练模型<br> 测试模型<br> 改进模型并重复该过程</p> 
<h2><a id="TensorFlow_24"></a>导入TensorFlow和其他库</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> os
<span class="token keyword">import</span> PIL
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token keyword">from</span> tensorflow <span class="token keyword">import</span> keras
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras <span class="token keyword">import</span> layers
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sequential
</code></pre> 
<h2><a id="_37"></a>下载并浏览数据集</h2> 
<p>本教程使用约3700张花朵照片的数据集。数据集包含5个子目录，每个类一个：</p> 
<pre><code class="prism language-python">flower_photo<span class="token operator">/</span>
  daisy<span class="token operator">/</span>
  dandelion<span class="token operator">/</span>
  roses<span class="token operator">/</span>
  sunflowers<span class="token operator">/</span>
  tulips<span class="token operator">/</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pathlib
dataset_url <span class="token operator">=</span> <span class="token string">"https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz"</span>
data_dir <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>get_file<span class="token punctuation">(</span><span class="token string">'flower_photos'</span><span class="token punctuation">,</span> origin<span class="token operator">=</span>dataset_url<span class="token punctuation">,</span> untar<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
data_dir <span class="token operator">=</span> pathlib<span class="token punctuation">.</span>Path<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>
<span class="token comment"># PosixPath('/root/.keras/datasets/flower_photos')</span>
</code></pre> 
<p>下载后，您现在应该具有可用的数据集副本。总图片有3,670张：</p> 
<pre><code class="prism language-python">image_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*/*.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>image_count<span class="token punctuation">)</span>
</code></pre> 
<p>下载后，您现在应该具有可用的数据集副本。总图片有3,670张：</p> 
<pre><code class="prism language-python">image_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*/*.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>image_count<span class="token punctuation">)</span>
</code></pre> 
<pre><code>3670
</code></pre> 
<p>这是一些玫瑰：</p> 
<pre><code class="prism language-python">roses <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'roses/*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>roses<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># open 只需要传入str类型的地址即可显示</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b2/57/D6U6Jqgc_o.png" alt="在这里插入图片描述"><br> roses是glob后得到的路径列表,posixpath是unix上所使用的斜杠路径表示格式<br> roses[1] :<br> PosixPath(’/root/.keras/datasets/flower_photos/roses/15674450867_0ced942941_n.jpg’)</p> 
<pre><code class="prism language-python">PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>roses<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/13/6b/4gBMhfkA_o.png" alt="在这里插入图片描述"><br> 还有一些郁金香：</p> 
<pre><code class="prism language-python">tulips <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'tulips/*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>tulips<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/73/c8/CyULCVum_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>tulips<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/93/98/B09gC6oL_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="keraspreprocessing_98"></a>使用keras.preprocessing加载</h2> 
<p>让我们使用有用的<a href="https://tensorflow.google.cn/api_docs/python/tf/keras/preprocessing/image_dataset_from_directory" rel="nofollow">image_dataset_from_directory</a>实用工具从磁盘上加载这些图像。tf.data.Dataset只需几行代码，您就可以将磁盘上的映像目录带到。如果愿意，您还可以通过访问加载图像教程从头开始编写自己的数据加载代码。</p> 
<p>创建一个数据集<br> 为加载程序定义一些参数</p> 
<pre><code class="prism language-python">batch_size <span class="token operator">=</span> <span class="token number">32</span>
img_height <span class="token operator">=</span> <span class="token number">180</span>
img_width <span class="token operator">=</span> <span class="token number">180</span>
</code></pre> 
<p>在开发模型时，最好使用验证拆分。让我们将80％的图像用于训练，将20％的图像用于验证。</p> 
<pre><code class="prism language-python">train_ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image_dataset_from_directory<span class="token punctuation">(</span>
  data_dir<span class="token punctuation">,</span>
  validation_split<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>
  subset<span class="token operator">=</span><span class="token string">"training"</span><span class="token punctuation">,</span>
  seed<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">,</span>
  image_size<span class="token operator">=</span><span class="token punctuation">(</span>img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">)</span><span class="token punctuation">,</span>
  batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>
</code></pre> 
<pre><code>Found 3670 files belonging to 5 classes.
Using 2936 files for training.
</code></pre> 
<pre><code class="prism language-python">val_ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image_dataset_from_directory<span class="token punctuation">(</span>
  data_dir<span class="token punctuation">,</span>
  validation_split<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>
  subset<span class="token operator">=</span><span class="token string">"validation"</span><span class="token punctuation">,</span>
  seed<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">,</span>
  image_size<span class="token operator">=</span><span class="token punctuation">(</span>img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">)</span><span class="token punctuation">,</span>
  batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>
</code></pre> 
<pre><code>Found 3670 files belonging to 5 classes.
Using 734 files for validation.
</code></pre> 
<p>您可以class_names在这些数据集的属性中找到类名称。这些以字母顺序对应于目录名称。</p> 
<pre><code class="prism language-python">class_names <span class="token operator">=</span> train_ds<span class="token punctuation">.</span>class_names
<span class="token keyword">print</span><span class="token punctuation">(</span>class_names<span class="token punctuation">)</span>
</code></pre> 
<pre><code>['daisy', 'dandelion', 'roses', 'sunflowers', 'tulips']
</code></pre> 
<h2><a id="_147"></a>可视化数据</h2> 
<p>这是训练数据集中的前9张图像。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> train_ds<span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">"uint8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>class_names<span class="token punctuation">[</span>labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
</code></pre> 
<p>由于前面读取的时候是batch_size是32<br> train_ds.take(1), images, labels 都是batch =32,有32个</p> 
<p>labels 是</p> 
<pre><code class="prism language-python">tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span>
</code></pre> 
<p>即label[i]是class_names<br> [‘daisy’, ‘dandelion’, ‘roses’, ‘sunflowers’, ‘tulips’]<br> 的标号index<br> 通过class_names[labels[i]]获得花名</p> 
<p><img src="https://images2.imgbox.com/a9/b0/eb3yM8HD_o.png" alt="在这里插入图片描述"><br> 您将通过传递这些数据集来训练使用这些数据集的模型model.fit。如果愿意，还可以手动遍历数据集并检索成批图像：</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> image_batch<span class="token punctuation">,</span> labels_batch <span class="token keyword">in</span> train_ds<span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>image_batch<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>labels_batch<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
  <span class="token keyword">break</span>
</code></pre> 
<blockquote> 
 <p>(32, 180, 180, 3)<br> (32,)</p> 
</blockquote> 
<p>image_batch是形状(32, 180, 180, 3)的张量。这是一批32个形状180x180x3的图像（最后一个尺寸是指颜色通道RGB）。label_batch是形状(32,)的张量，这些都是32个图像的 对应标签</p> 
<p>您可以调用.numpy()在image_batch和labels_batch张量将它们转换为一个numpy.ndarray</p> 
<h2><a id="_199"></a>配置数据集以提高性能</h2> 
<p>让我们确保使用缓冲预取，以便您可以从磁盘产生数据而不会阻塞I / O。这是加载数据时应使用的两种重要方法。</p> 
<p>Dataset.cache()在第一个时期将图像从磁盘加载后，将图像保留在内存中。这将确保在训练模型时数据集不会成为瓶颈。如果您的数据集太大而无法容纳到内存中，则也可以使用此方法来创建高性能的磁盘缓存。</p> 
<p>Dataset.prefetch() 训练时与数据预处理和模型执行重叠。</p> 
<p>有兴趣的读者可以在数据性能指南中了解有关这两种方法以及如何将数据缓存到磁盘的更多信息。</p> 
<pre><code class="prism language-python">AUTOTUNE <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>AUTOTUNE

train_ds <span class="token operator">=</span> train_ds<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prefetch<span class="token punctuation">(</span>buffer_size<span class="token operator">=</span>AUTOTUNE<span class="token punctuation">)</span>
val_ds <span class="token operator">=</span> val_ds<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prefetch<span class="token punctuation">(</span>buffer_size<span class="token operator">=</span>AUTOTUNE<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_214"></a>标准化数据</h2> 
<p>RGB通道值在[0, 255]范围内。这对于神经网络而言并不理想；通常，您应该设法减小输入值。在这里，您将[0, 1]使用“重新缩放”图层将值标准化为该范围内的值。</p> 
<pre><code class="prism language-python">normalization_layer <span class="token operator">=</span> layers<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>Rescaling<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_219"></a>注意:</h4> 
<p>本节中介绍的Keras预处理实用程序和图层目前处于实验阶段，可能会更改。</p> 
<p>有两种使用此层的方法。您可以通过调用map将其应用于数据集：</p> 
<pre><code class="prism language-python">normalized_ds <span class="token operator">=</span> train_ds<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token punctuation">(</span>normalization_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span>
image_batch<span class="token punctuation">,</span> labels_batch <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>normalized_ds<span class="token punctuation">)</span><span class="token punctuation">)</span>
first_image <span class="token operator">=</span> image_batch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment"># Notice the pixels values are now in `[0,1]`.</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>first_image<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>first_image<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0.0 1.0
</code></pre> 
<p>或者，您可以在模型定义中包括该层，这可以简化部署。让我们在这里使用第二种方法。</p> 
<h4><a id="_236"></a>注意：</h4> 
<p>您之前使用的image_size参数调整了图片的大小image_dataset_from_directory。如果您还希望在模型中包括调整大小逻辑，则可以使用“调整大小”层。Resizing layer.</p> 
<h2><a id="_239"></a>创建模型</h2> 
<p>该模型由三个卷积块组成，每个卷积块中都有一个最大池层。有一个完全连接的层，上面有128个单元，可以通过relu激活功能激活该层。该模型尚未针对高精度进行调整，本教程的目的是展示一种标准方法。</p> 
<pre><code class="prism language-python">num_classes <span class="token operator">=</span> <span class="token number">5</span>

model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">[</span>
  layers<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>Rescaling<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span>img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>num_classes<span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_258"></a>编译模型</h2> 
<p>对于本教程，选择optimizers.Adam优化器和losses.SparseCategoricalCrossentropy损失函数。要查看每个训练时期的训练和验证准确性，请传递metrics参数。</p> 
<pre><code class="prism language-python">model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span><span class="token string">'adam'</span><span class="token punctuation">,</span>
              loss<span class="token operator">=</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>SparseCategoricalCrossentropy<span class="token punctuation">(</span>from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="model_summary_267"></a>model summary</h2> 
<p>使用模型的summary方法查看网络的所有层：</p> 
<pre><code class="prism language-python">model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
rescaling_1 (Rescaling)      (None, 180, 180, 3)       0         
_________________________________________________________________
conv2d (Conv2D)              (None, 180, 180, 16)      448       
_________________________________________________________________
max_pooling2d (MaxPooling2D) (None, 90, 90, 16)        0         
_________________________________________________________________
conv2d_1 (Conv2D)            (None, 90, 90, 32)        4640      
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 45, 45, 32)        0         
_________________________________________________________________
conv2d_2 (Conv2D)            (None, 45, 45, 64)        18496     
_________________________________________________________________
max_pooling2d_2 (MaxPooling2 (None, 22, 22, 64)        0         
_________________________________________________________________
flatten (Flatten)            (None, 30976)             0         
_________________________________________________________________
dense (Dense)                (None, 128)               3965056   
_________________________________________________________________
dense_1 (Dense)              (None, 5)                 645       
=================================================================
Total params: 3,989,285
Trainable params: 3,989,285
Non-trainable params: 0
_________________________________________________________________
</code></pre> 
<h2><a id="_303"></a>训练模型</h2> 
<pre><code class="prism language-python">epochs<span class="token operator">=</span><span class="token number">10</span>
history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
  train_ds<span class="token punctuation">,</span>
  validation_data<span class="token operator">=</span>val_ds<span class="token punctuation">,</span>
  epochs<span class="token operator">=</span>epochs
<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="training_313"></a>可视化training结果</h2> 
<p>在训练和验证集上创建损失和准确性图。</p> 
<pre><code class="prism language-python">acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span>
val_acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_accuracy'</span><span class="token punctuation">]</span>

loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
val_loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span>

epochs_range <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> val_acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'lower right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Accuracy'</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> val_loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'upper right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d6/3a/k00ITFuy_o.png" alt="在这里插入图片描述"><br> 从图中可以看出，训练精度和验证精度相差很大，模型仅在验证集上获得了约60％的精度。</p> 
<p>让我们看一下出了什么问题，并尝试提高模型的整体性能。</p> 
<h2><a id="_346"></a>过度拟合</h2> 
<p>在上面的图中，训练精度随时间呈线性增长，而验证精度在训练过程中停滞在60％左右。同样，训练和验证准确性之间的准确性差异也很明显，这是过度拟合的标志。</p> 
<p>当训练示例数量很少时，该模型有时会从训练示例中的噪音或不必要的细节中学习，从而对模型在新示例上的性能产生负面影响。这种现象称为过拟合。这意味着该模型很难推广到新的数据集。</p> 
<p>在训练过程中，有多种方法可以解决过拟合的问题。在本教程中，您将使用数据扩充Data augmentation并将Dropout添加到模型中。</p> 
<h3><a id="Data_augmentation_354"></a>Data augmentation</h3> 
<p>训练量很少时，通常会发生过度拟合。<a href="https://tensorflow.google.cn/tutorials/images/data_augmentation" rel="nofollow">数据增强</a>采用通过使用随机变换对现有示例进行增强以生成看起来可信的图像来生成其他训练数据的方法。这有助于将模型暴露于数据的更多方面，并且可以更好地进行概括。</p> 
<p>您将使用中的图层来实现数据扩充tf.keras.layers.experimental.preprocessing。这些可以像其他图层一样包含在模型中，并在GPU上运行。</p> 
<pre><code class="prism language-python">data_augmentation <span class="token operator">=</span> keras<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    layers<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>RandomFlip<span class="token punctuation">(</span><span class="token string">"horizontal"</span><span class="token punctuation">,</span> 
                                                 input_shape<span class="token operator">=</span><span class="token punctuation">(</span>img_height<span class="token punctuation">,</span> 
                                                              img_width<span class="token punctuation">,</span>
                                                              <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    layers<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    layers<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>RandomZoom<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>让我们通过将数据增强多次应用于同一幅图像来形象化一些增强示例的外观：</p> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> images<span class="token punctuation">,</span> _ <span class="token keyword">in</span> train_ds<span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    augmented_images <span class="token operator">=</span> data_augmentation<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
    ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>augmented_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">"uint8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/20/bc/otZftrCh_o.png" alt="在这里插入图片描述"><br> 您将立即使用数据增强来训练模型。</p> 
<h2><a id="Dropout_388"></a>Dropout</h2> 
<p>减少过度拟合的另一种技术是将Dropout引入网络，这是一种正则化形式。</p> 
<p>在将Dropout应用于图层时，它会在训练过程中从该图层中随机退出（通过将激活设置为零）许多输出单元。dropout 采用分数形式作为其输入值，形式为0.1、0.2、0.4等。这意味着从所施加的层中随机退出输出单元的10％，20％或40％。</p> 
<p>让我们使用创建一个新的神经网络layers.Dropout，然后使用增强图像对其进行训练</p> 
<pre><code class="prism language-python">model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">[</span>
  data_augmentation<span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>Rescaling<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>MaxPooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>num_classes<span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_411"></a>编译和训练模型</h2> 
<pre><code class="prism language-python">model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span><span class="token string">'adam'</span><span class="token punctuation">,</span>
              loss<span class="token operator">=</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>SparseCategoricalCrossentropy<span class="token punctuation">(</span>from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">epochs <span class="token operator">=</span> <span class="token number">15</span>
history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
  train_ds<span class="token punctuation">,</span>
  validation_data<span class="token operator">=</span>val_ds<span class="token punctuation">,</span>
  epochs<span class="token operator">=</span>epochs
<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="training_431"></a>可视化training结果</h2> 
<p>在应用数据增强和Dropout之后，与以前相比，过度拟合的情况减少了，并且训练和验证的准确性更加紧密。</p> 
<pre><code class="prism language-python">acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span>
val_acc <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_accuracy'</span><span class="token punctuation">]</span>

loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
val_loss <span class="token operator">=</span> history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span>

epochs_range <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> val_acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'lower right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Accuracy'</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> val_loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'upper right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0a/aa/utKGO95F_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_458"></a>预测新数据</h2> 
<p>最后，让我们使用我们的模型对训练或验证集中未包含的图像进行分类。</p> 
<h4><a id="_461"></a>注意：</h4> 
<p>在推理时，数据增强和数据丢失层是不活动的。</p> 
<pre><code class="prism language-python">sunflower_url <span class="token operator">=</span> <span class="token string">"https://storage.googleapis.com/download.tensorflow.org/example_images/592px-Red_sunflower.jpg"</span>
sunflower_path <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>get_file<span class="token punctuation">(</span><span class="token string">'Red_sunflower'</span><span class="token punctuation">,</span> origin<span class="token operator">=</span>sunflower_url<span class="token punctuation">)</span>

img <span class="token operator">=</span> keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image<span class="token punctuation">.</span>load_img<span class="token punctuation">(</span>
    sunflower_path<span class="token punctuation">,</span> target_size<span class="token operator">=</span><span class="token punctuation">(</span>img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
img_array <span class="token operator">=</span> keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image<span class="token punctuation">.</span>img_to_array<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
img_array <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>img_array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># Create a batch</span>

predictions <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>img_array<span class="token punctuation">)</span>
score <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>predictions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>
    <span class="token string">"This image most likely belongs to {} with a {:.2f} percent confidence."</span>
    <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>class_names<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">*</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>这里 tf.nn.softmax(predictions[0]),因为网络最后一个dense层并没有给它激活函数softmax,只是在训练的时候指定了loss =tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True),</p> 
<p>预测可用不到<br> 所以最后必须使用</p> 
<h2><a id="_487"></a>总结</h2> 
<pre><code class="prism language-python">显示某一路径的图片
PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

文件夹类名的列表
 train_ds<span class="token punctuation">.</span>class_names

通过数据的url获得数据
 tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>get_file<span class="token punctuation">(</span><span class="token string">'名字'</span><span class="token punctuation">,</span>origin<span class="token operator">=</span>sunflower_url<span class="token punctuation">)</span>

keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image<span class="token punctuation">.</span>img_to_array<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

 keras<span class="token punctuation">.</span>preprocessing里面的几个函数
 
image<span class="token punctuation">.</span>load_img
image<span class="token punctuation">.</span>img_to_array
tf<span class="token punctuation">.</span>expand_dims
model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">)</span>

最后显示预测的得分
<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>class_names<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">*</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>


</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a31fba48ec2c83a3c635320c02334306/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">从零开始的临时会话WEB项目（基于SSM框架）（二）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ce32ae1f301cabb6aabf3e442bf0f93c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">pygame也能实现好看的雷达图，不信可以进来看看。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>