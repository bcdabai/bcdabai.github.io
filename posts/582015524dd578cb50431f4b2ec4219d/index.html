<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CentOS下GitLab的安装部署 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CentOS下GitLab的安装部署" />
<meta property="og:description" content="转载来源 ：https://mp.weixin.qq.com/s/kUwZja0xK1IfqGU6R2f1EA
一 GitLab Server的搭建 参考：https://about.gitlab.com/install/
1.准备工作 以centos7为例，准备一台至少内存为4G的机器。
系统版本：CentOS Linux release 7.3.1611 (Core)
软件版本：Gitlab-ce-11.10.1
硬件要求：最低2核4GB，建议4核8GB
2.安装依赖软件 [root@localhost ~]# sudo yum install -y git vim gcc glibc-static telnet [root@localhost ~]# sudo yum install -y curl policycoreutiels-python openssh-server [root@localhost ~]# sudo systemctl enable sshd [root@localhost ~]# sudo systemctl start sshd [root@localhost ~]# sudo yum install postfix -y [root@localhost ~]# sudo systemctl enable postfix [root@localhost ~]# sudo systemctl start postfix =&gt; 启动SSH远程服务 [root@localhost ~]# systemctl stop firewalld =&gt; 停止Firewalld防火墙服务 [root@localhost ~]# systemctl disable firewalld =&gt; 禁用Firwalld防火墙服务开机自启 [root@localhost ~]# sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/&#39; /etc/sysconfig/selinux =&gt; 关闭SeLinux（重启主机生效） [root@localhost ~]# setenforce 0 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/582015524dd578cb50431f4b2ec4219d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-17T15:14:55+08:00" />
<meta property="article:modified_time" content="2020-06-17T15:14:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CentOS下GitLab的安装部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>转载来源 ：https://mp.weixin.qq.com/s/kUwZja0xK1IfqGU6R2f1EA</p> 
<h3><a id="_GitLab_Server_2"></a>一 GitLab Server的搭建</h3> 
<p>参考：https://about.gitlab.com/install/</p> 
<h3><a id="1_6"></a>1.准备工作</h3> 
<p>以centos7为例，准备一台至少内存为4G的机器。<br> 系统版本：CentOS Linux release 7.3.1611 (Core)<br> 软件版本：Gitlab-ce-11.10.1<br> 硬件要求：最低2核4GB，建议4核8GB</p> 
<h3><a id="2_11"></a>2.安装依赖软件</h3> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># sudo yum install <span class="token operator">-</span>y git vim gcc glibc<span class="token operator">-</span><span class="token keyword">static</span> telnet
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># sudo yum install <span class="token operator">-</span>y curl policycoreutiels<span class="token operator">-</span>python openssh<span class="token operator">-</span>server
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># sudo systemctl enable sshd
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># sudo systemctl start sshd
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># sudo yum install postfix <span class="token operator">-</span>y 
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># sudo systemctl enable postfix
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># sudo systemctl start postfix                                                <span class="token operator">=</span><span class="token operator">&gt;</span> 启动SSH远程服务
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># systemctl stop firewalld                                              <span class="token operator">=</span><span class="token operator">&gt;</span> 停止Firewalld防火墙服务
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># systemctl disable firewalld                                           <span class="token operator">=</span><span class="token operator">&gt;</span> 禁用Firwalld防火墙服务开机自启
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># sed <span class="token operator">-</span>i <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>selinux <span class="token operator">=</span><span class="token operator">&gt;</span> 关闭SeLinux（重启主机生效）
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># setenforce <span class="token number">0</span>
</code></pre> 
<h3><a id="3gitlab_25"></a>3.设置gitlab安装源</h3> 
<p>国内的话就使用清华大学源，内容为：</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># vim <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>gitlab<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo
<span class="token punctuation">[</span>gitlab<span class="token operator">-</span>ce<span class="token punctuation">]</span>
name<span class="token operator">=</span>Gitlab CE Repository
baseurl<span class="token operator">=</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>gitlab<span class="token operator">-</span>ce<span class="token operator">/</span>yum<span class="token operator">/</span>el$releasever<span class="token operator">/</span>
gpgcheck<span class="token operator">=</span><span class="token number">0</span>
enabled<span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># yum makecache
</code></pre> 
<h3><a id="4Gitlab_36"></a>4、安装Gitlab</h3> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># yum install <span class="token operator">-</span>y gitlab<span class="token operator">-</span>ce
可以访问<span class="token string">"https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/"</span>查看Gitlab<span class="token operator">-</span>ce的版本。
安装历史版本请使用下面命令：
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># yum install <span class="token operator">-</span>y gitlab<span class="token operator">-</span>ce<span class="token operator">-</span><span class="token punctuation">{<!-- --></span>VERSION<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5Gitlab_43"></a>5、配置Gitlab</h3> 
<p>建议使用HTTPS。</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># vim <span class="token operator">/</span>etc<span class="token operator">/</span>gitlab<span class="token operator">/</span>gitlab<span class="token punctuation">.</span>rb
### 基础配置 ###
external_url <span class="token string">'http://gitlab.example.com/'</span>
#用户访问所使用的URL，域名或者IP地址
gitlab_rails<span class="token punctuation">[</span><span class="token string">'time_zone'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Asia/Shanghai'</span>
#时区

### SSH配置 ###
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_shell_ssh_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10222</span>
#使用SSH协议拉取代码所使用的连接端口。

### 邮箱配置 ###
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
#启用SMTP邮箱功能，绑定一个第三方邮箱，用于邮件发送
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.exmail.qq.com"</span>
#设置SMTP服务器地址
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">465</span>
#设置SMTP服务器端口
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"xxx@xxx.cn"</span>
#设置邮箱账号
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"xxx"</span>
#设置邮箱密码
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span>
#设置邮箱账号密码身份验证方式，<span class="token string">"login"</span>表示采用账号密码的方式登陆
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable_starttls_auto'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_tls'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
#设置开启SMTP邮件使用TLS传输加密协议传输邮件，以保证邮件安全传输
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'xxx@xxx.cn'</span>
#设置Gitlab来源邮箱地址，设置登陆所使用的邮箱地址

### WEB配置 ###
nginx<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
#启用Nginx服务
nginx<span class="token punctuation">[</span><span class="token string">'client_max_body_size'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'250m'</span>
#设置客户端最大文件上传大小
nginx<span class="token punctuation">[</span><span class="token string">'redirect_http_to_https'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
#设置开启自动将HTTP跳转到HTTPS
nginx<span class="token punctuation">[</span><span class="token string">'ssl_certificate'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/etc/gitlab/ssl/gitlab.xxx.cn.pem"</span>
#设置HTTPS所使用的证书
nginx<span class="token punctuation">[</span><span class="token string">'ssl_certificate_key'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/etc/gitlab/ssl/gitlab.xxx.cn.key"</span>
#设置HTTPS所使用的证书密码
nginx<span class="token punctuation">[</span><span class="token string">'ssl_protocols'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"TLSv1.1 TLSv1.2"</span>
#设置HTTPS所使用的TLS协议版本
nginx<span class="token punctuation">[</span><span class="token string">'ssl_session_cache'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"builtin:1000  shared:SSL:10m"</span>
#设置开启SSL会话缓存功能
nginx<span class="token punctuation">[</span><span class="token string">'ssl_session_timeout'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"5m"</span>
#设置SSL会话超时时间
nginx<span class="token punctuation">[</span><span class="token string">'listen_addresses'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'[::]'</span><span class="token punctuation">]</span>
#设置Nginx监听地址，<span class="token string">"*"</span>表示监听主机上所有网卡的地址
nginx<span class="token punctuation">[</span><span class="token string">'gzip_enabled'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
#设置开启Nginx的传输压缩功能，以节约传输带宽，提高传输效率
</code></pre> 
<h3><a id="6SSL_98"></a>6、上传SSL证书到指定目录</h3> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># ll <span class="token operator">/</span>etc<span class="token operator">/</span>gitlab<span class="token operator">/</span>ssl<span class="token operator">/</span>
total <span class="token number">28</span>
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">2</span> root root <span class="token number">4096</span> Apr <span class="token number">25</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">48</span> <span class="token punctuation">.</span><span class="token operator">/</span>
drwxrwxr<span class="token operator">-</span>x <span class="token number">4</span> root root <span class="token number">4096</span> Apr <span class="token number">25</span> <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">50</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> root root <span class="token number">1675</span> Apr <span class="token number">25</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">45</span> gitlab<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>cn<span class="token punctuation">.</span>key
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> root root <span class="token number">3671</span> Apr <span class="token number">25</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">45</span> gitlab<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>cn<span class="token punctuation">.</span>pem
</code></pre> 
<h3><a id="7_107"></a>7、刷新配置</h3> 
<pre><code class="prism language-c">当配置文件发生变化时，或者是第一次启动时，我们需要刷新配置。
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># systemctl restart gitlab<span class="token operator">-</span>runsvdir
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># gitlab<span class="token operator">-</span>ctl reconfigure
</code></pre> 
<h3><a id="8_113"></a>8、启动服务</h3> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># gitlab<span class="token operator">-</span>ctl restart
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># gitlab<span class="token operator">-</span>ctl status
run<span class="token punctuation">:</span> alertmanager<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13541</span><span class="token punctuation">)</span> <span class="token number">2171</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13221</span><span class="token punctuation">)</span> <span class="token number">2192</span>s
run<span class="token punctuation">:</span> gitaly<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13557</span><span class="token punctuation">)</span> <span class="token number">2170</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">12463</span><span class="token punctuation">)</span> <span class="token number">2266</span>s
run<span class="token punctuation">:</span> gitlab<span class="token operator">-</span>monitor<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13580</span><span class="token punctuation">)</span> <span class="token number">2169</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13103</span><span class="token punctuation">)</span> <span class="token number">2208</span>s
run<span class="token punctuation">:</span> gitlab<span class="token operator">-</span>workhorse<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13602</span><span class="token punctuation">)</span> <span class="token number">2169</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">12887</span><span class="token punctuation">)</span> <span class="token number">2226</span>s
run<span class="token punctuation">:</span> logrotate<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13617</span><span class="token punctuation">)</span> <span class="token number">2168</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">12959</span><span class="token punctuation">)</span> <span class="token number">2218</span>s
run<span class="token punctuation">:</span> nginx<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13628</span><span class="token punctuation">)</span> <span class="token number">2168</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">12927</span><span class="token punctuation">)</span> <span class="token number">2222</span>s
run<span class="token punctuation">:</span> node<span class="token operator">-</span>exporter<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13714</span><span class="token punctuation">)</span> <span class="token number">2168</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13002</span><span class="token punctuation">)</span> <span class="token number">2214</span>s
run<span class="token punctuation">:</span> postgres<span class="token operator">-</span>exporter<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13720</span><span class="token punctuation">)</span> <span class="token number">2167</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13270</span><span class="token punctuation">)</span> <span class="token number">2188</span>s
run<span class="token punctuation">:</span> postgresql<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13740</span><span class="token punctuation">)</span> <span class="token number">2167</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">12669</span><span class="token punctuation">)</span> <span class="token number">2258</span>s
run<span class="token punctuation">:</span> prometheus<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13748</span><span class="token punctuation">)</span> <span class="token number">2166</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13181</span><span class="token punctuation">)</span> <span class="token number">2198</span>s
run<span class="token punctuation">:</span> redis<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13761</span><span class="token punctuation">)</span> <span class="token number">2166</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">11907</span><span class="token punctuation">)</span> <span class="token number">2293</span>s
run<span class="token punctuation">:</span> redis<span class="token operator">-</span>exporter<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13800</span><span class="token punctuation">)</span> <span class="token number">2165</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13143</span><span class="token punctuation">)</span> <span class="token number">2202</span>s
run<span class="token punctuation">:</span> sidekiq<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13821</span><span class="token punctuation">)</span> <span class="token number">2163</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">12872</span><span class="token punctuation">)</span> <span class="token number">2227</span>s
run<span class="token punctuation">:</span> unicorn<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">13833</span><span class="token punctuation">)</span> <span class="token number">2162</span>s<span class="token punctuation">;</span> run<span class="token punctuation">:</span> log<span class="token punctuation">:</span> <span class="token punctuation">(</span>pid <span class="token number">12832</span><span class="token punctuation">)</span> <span class="token number">2233</span>s
</code></pre> 
<h3><a id="9_132"></a>9、测试邮件发送</h3> 
<p>我们在启动完成后测试一下邮件发送功能是否正常工作。</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># gitlab<span class="token operator">-</span>rails console
<span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">001</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span> Notify<span class="token punctuation">.</span><span class="token function">test_email</span><span class="token punctuation">(</span><span class="token string">'邮箱地址'</span><span class="token punctuation">,</span> <span class="token string">'标题'</span><span class="token punctuation">,</span> <span class="token string">'内容'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>deliver_now
<span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">002</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span> exit
</code></pre> 
<h3><a id="10_139"></a>10、第一次访问登陆</h3> 
<p>本地hosts中加入域名解析gitlab.example.com，然后浏览器中输入域名访问，第一次需要输入新的超级管理员（root）密码。<br> 修改成功后，我们使用超级管理员用户“root”账号登录Gitlab管理平台。<br> <img src="https://images2.imgbox.com/66/52/efWWPt9f_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11_143"></a>11、关闭用户注册功能</h3> 
<p>为了避免用户随便注册账号，我们将注册功能关闭。<br> <img src="https://images2.imgbox.com/e7/70/nKlEenZl_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11_146"></a>11、设置语言为"简体中文"</h3> 
<p><img src="https://images2.imgbox.com/bc/bd/B0MuXZpS_o.png" alt="在这里插入图片描述"><br> 保存后重启登陆即可。</p> 
<h3><a id="dockergitlab_149"></a>二、docker部署gitlab</h3> 
<p>1 环境描述<br> <img src="https://images2.imgbox.com/24/63/C1cFnmqd_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_linuxselinux_152"></a>2 确保安装顺利，linux先关闭selinux服务，否则容器内部可能权限不足</h3> 
<pre><code class="prism language-c">vi <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
SELINUX<span class="token operator">=</span>enforcing  #注释掉
SELINUXTYPE<span class="token operator">=</span>targeted #注释掉
SELINUX<span class="token operator">=</span>disabled #增加
<span class="token punctuation">:</span>wq<span class="token operator">!</span> #保存退出
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
setenforce <span class="token number">0</span> #使配置立即生效
</code></pre> 
<h3><a id="3_gitlab_163"></a>3 搜索和下载gitlab镜像</h3> 
<pre><code class="prism language-c">#搜索镜像
docker search gitlab
#下载镜像
sudo docker pull gitlab<span class="token operator">/</span>gitlab<span class="token operator">-</span>ce<span class="token punctuation">:</span>latest
</code></pre> 
<h3><a id="4_docker_170"></a>4 创建docker中的网络</h3> 
<pre><code class="prism language-c">docker network create gitlab_net
</code></pre> 
<h3><a id="5__174"></a>5 使用镜像创建容器，并且使重要数据外部挂载到宿主机</h3> 
<pre><code class="prism language-c">docker run <span class="token operator">--</span>name<span class="token operator">=</span><span class="token string">'gitlab'</span> <span class="token operator">-</span>d \
<span class="token operator">--</span>net<span class="token operator">=</span>gitlab_net \
<span class="token operator">--</span>publish <span class="token number">443</span><span class="token punctuation">:</span><span class="token number">443</span> <span class="token operator">--</span>publish <span class="token number">80</span><span class="token punctuation">:</span><span class="token number">80</span> \
<span class="token operator">--</span>restart always \
<span class="token operator">--</span>volume <span class="token operator">~</span><span class="token operator">/</span>docker<span class="token operator">/</span>gitlab<span class="token operator">/</span>config<span class="token punctuation">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>gitlab \
<span class="token operator">--</span>volume <span class="token operator">~</span><span class="token operator">/</span>docker<span class="token operator">/</span>gitlab<span class="token operator">/</span>logs<span class="token punctuation">:</span><span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>gitlab \
<span class="token operator">--</span>volume <span class="token operator">~</span><span class="token operator">/</span>docker<span class="token operator">/</span>gitlab<span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>var<span class="token operator">/</span>opt<span class="token operator">/</span>gitlab \
<span class="token operator">--</span>privileged<span class="token operator">=</span>true \
gitlab<span class="token operator">/</span>gitlab<span class="token operator">-</span>ce<span class="token punctuation">:</span>latest
</code></pre> 
<pre><code class="prism language-c">## 查看容器是否运行起来
docker ps <span class="token operator">|</span> grep gitlab
</code></pre> 
<blockquote> 
 <p>参数解析1.http端口使用 80<br> 2.网络使用 gitlab_net网络<br> 3.将容器内部 /etc/gitlab,/var/log/gitlab,/var/opt/gitlab - 挂载到宿主机的 /root/docker/gitlab/config,logs,data 下，防止容器被删除数据丢失<br> 4.privileged=true 使用特权，怕什么地方权限不足，安装不顺<br> 5./root/docker/gitlab下的config,logs,data没有的话，创建容器会一并创建</p> 
</blockquote> 
<h3><a id="6__196"></a>6 修改配置文件中的访问域名</h3> 
<pre><code class="prism language-c">vim <span class="token operator">~</span><span class="token operator">/</span>docker<span class="token operator">/</span>gitlab<span class="token operator">/</span>config<span class="token operator">/</span>gitlab<span class="token punctuation">.</span>rb
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
external_url <span class="token string">'http://gitlab.example.com/'</span>
#用户访问所使用的URL，域名或者IP地址
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h3><a id="7__204"></a>7 打开浏览器看成效</h3> 
<p>浏览器输入 http://gitlab.example.com/ 进行访问，第一次登陆需要修改密码 这样子就安装OK了，输入账号密码进行注册<br> <img src="https://images2.imgbox.com/65/b2/2Mopetx3_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="GitLab_smtp__207"></a>三、GitLab修改配置文件，添加 smtp 邮件功能</h3> 
<p>假如你想让互联网的邮箱服务提供商，帮你的 gitlab 发送邮件，就需要在配置文件中设置，并且需要在邮件服务提供商那里开通 SMTP和POP3 功能。</p> 
<p>关于 SMTP 和 POP3 的区别，访问 https://www.zhihu.com/question/24605584</p> 
<p>这里简单说一下， SMTP 用于发邮件, POP3 用于收邮件。</p> 
<p>这里我以 126 邮箱为例，演示一下<br> 1.首先我们在邮箱服务提供商那里开通 SMTP 。</p> 
<p>2、配置系统使用的发件邮箱地址等信息<br> 在配置文件： /etc/gitlab/gitlab.rb 中做如下修改<br> 这部分，不管是使用postmail或者SMTP都需要做如下的配置。</p> 
<pre><code class="prism language-c">    # 是否开启系统邮箱，默认开启
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_enabled'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
    
    # 用这个账号去发送邮件
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'my@126.com'</span>
    
    # 发送邮件中要显示的发件人名称
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_display_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Admin'</span>
    
    # 系统接收邮件的地址，一般系统发送的邮件都不要对其回复邮件
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_reply_to'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'noreply@example.com'</span>
    
    # 邮件的标题前缀，如下图
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_subject_suffix'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'[gitlab]'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4d/db/B5R4KYFv_o.png" alt="在这里插入图片描述"><br> 3.配置完系统的发件信息，接下来设置邮件服务提供商的账户登录验证信息。<br> 要想使用邮件服务商为 gitlab 系统发送邮件，是需要进行登录， 登录就需要先验证的。<br> 所以要填写相关用于登录验证的信息<br> 值的注意的是，上面 gitlab_email_from 的账户必须和这里的用户名(smtp_user_name)一致。</p> 
<pre><code class="prism language-c">    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
    # 这个配置的密码不是邮箱的登陆密码而是网易邮箱的客户端授权密码<span class="token punctuation">,</span> 
    # 在网易邮箱web页面的设置<span class="token operator">-</span>POP3<span class="token operator">/</span>SMTP<span class="token operator">/</span>IMAP<span class="token operator">-</span>客户端授权密码查看。
    # 见下图
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.126.com"</span>
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span>
    # 使用这个账号发送邮件
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"my@126.com"</span>
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"xxx"</span>
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_domain'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"126.com"</span>
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span>
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable_starttls_auto'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
    gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_openssl_verify_mode'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'peer'</span>
    # 发件人账号
    user<span class="token punctuation">[</span><span class="token string">'git_user_email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"username@domain.cn"</span>
    # 更多查看下方网址
    <span class="token macro property"># https://docs.gitlab.com/omnibus/settings/smtp.html</span>
    # 如果你不配置发件人<span class="token punctuation">,</span> 有些邮件服务器会发送失败<span class="token punctuation">,</span> 
    # 所以我们最好把账号和发件人都配置了<span class="token punctuation">,</span> 并且保持一致<span class="token punctuation">,</span> 这样保证兼容问题
</code></pre> 
<p><strong>4.SMTP 客户端授权码</strong><br> <img src="https://images2.imgbox.com/cf/58/31ahVk2l_o.png" alt="在这里插入图片描述"><br> <strong>qq邮箱的配置</strong></p> 
<pre><code class="prism language-c">gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'smtp.qq.com'</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"xxxxxx@qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"pgecjrbcqsxdbefa"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_domain'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable_starttls_auto'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_tls'</span><span class="token punctuation">]</span> <span class="token operator">=</span> false
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"xxxxxxx@qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_enabled'</span><span class="token punctuation">]</span> <span class="token operator">=</span> true
user<span class="token punctuation">[</span><span class="token string">'git_user_email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"xxxxxx@qq.com"</span>
</code></pre> 
<p>1、重器相关服务，使最新的配置文件生效</p> 
<pre><code class="prism language-c">    <span class="token punctuation">[</span>root@vm1 <span class="token operator">~</span><span class="token punctuation">]</span># gitlab<span class="token operator">-</span>ctl reconfigure    
    # 再重启一下
    <span class="token punctuation">[</span>root@vm1 <span class="token operator">~</span><span class="token punctuation">]</span># gitlab<span class="token operator">-</span>ctl restart
</code></pre> 
<p>使用gitlab-rails console命令进行发送邮件测试，如下所示：</p> 
<pre><code class="prism language-c"><span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">003</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span> Notify<span class="token punctuation">.</span><span class="token function">test_email</span><span class="token punctuation">(</span><span class="token string">'收件人邮箱'</span><span class="token punctuation">,</span> <span class="token string">'邮件标题'</span><span class="token punctuation">,</span> <span class="token string">'邮件正文'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>deliver_now
</code></pre> 
<p><strong>示例</strong></p> 
<pre><code class="prism language-c">    <span class="token punctuation">[</span>root@vm1 <span class="token operator">~</span><span class="token punctuation">]</span># gitlab<span class="token operator">-</span>rails console 
    Loading production environment <span class="token punctuation">(</span>Rails <span class="token number">4.2</span><span class="token number">.10</span><span class="token punctuation">)</span>
    <span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">001</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span>  Notify<span class="token punctuation">.</span><span class="token function">test_email</span><span class="token punctuation">(</span><span class="token string">'xxxxxxxx@qq.com'</span><span class="token punctuation">,</span> <span class="token string">'Message Subject'</span><span class="token punctuation">,</span> <span class="token string">'Message Body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>deliver_now
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">002</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span>quit
    <span class="token punctuation">[</span>root@vm1 <span class="token operator">~</span><span class="token punctuation">]</span># 
</code></pre> 
<h2><a id="_312"></a>常见问题</h2> 
<p>1、访问浏览器被拒绝，不要慌 使用 docker logs gitlab 查看日志，看报什么错，进行解决<br> 2、访问返回502，一般情况下是端口冲突<br> 修改gitlab.rb文件，设置端口,重启容器，稍等一会访问</p> 
<pre><code class="prism language-c">#编辑文件
vi <span class="token operator">/</span>root<span class="token operator">/</span>docker<span class="token operator">/</span>gitlab<span class="token operator">/</span>config<span class="token operator">/</span>gitlab<span class="token punctuation">.</span>rb
#找到 unicorn<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8080</span> 的地方，修改为不会被占用的端口
unicorn<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8888</span>
#保存
<span class="token punctuation">:</span>wq<span class="token operator">!</span>
#重启容器 
docker restart gitlab
</code></pre> 
<p>3、访问比较缓慢<br> 因为镜像就有一个多G，每次启动容器，重启，需要花一段时间等待。<br> 4、访问还是502<br> 看看CPU占用率，电脑容量，有些情况是因为CPU、内存耗尽导致</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/71bb369faa1a446517fef55885148be7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据结构的基本概念</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b9d8da71dd1b6a3447e638d5463144e2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IE浏览器POI导出Excel文件名乱码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>