<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>浪花 - 添加队伍业务开发 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="浪花 - 添加队伍业务开发" />
<meta property="og:description" content="一、接口设计 1. 请求参数：封装添加队伍参数 TeamAddRequest
package com.example.usercenter.model.request; import com.baomidou.mybatisplus.annotation.IdType; import com.baomidou.mybatisplus.annotation.TableField; import com.baomidou.mybatisplus.annotation.TableId; import com.baomidou.mybatisplus.annotation.TableLogic; import lombok.Data; import java.io.Serializable; import java.util.Date; /** * 用户登录请求参数 * @author Ghost * @version 1.0 */ @Data public class TeamAddRequest implements Serializable{ private static final long serialVersionUID = 6993746803531411917L; /** * id */ @TableId(type = IdType.AUTO) private Long id; /** * 队伍名称 */ private String name; /** * 描述 */ private String description; /** * 最大人数 */ private Integer maxNum; /** * 过期时间 */ private Date expireTime; /** * 用户id */ private Long userId; /** * 0 - 公开，1 - 私有，2 - 加密 */ private Integer status; /** * 密码 */ private String password; } 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/07af9356ff2c7c361dff65133a6ec8da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-23T14:37:33+08:00" />
<meta property="article:modified_time" content="2024-01-23T14:37:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">浪花 - 添加队伍业务开发</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、接口设计</h2> 
<p>1. 请求参数：封装添加队伍参数 TeamAddRequest</p> 
<pre><code class="language-java">package com.example.usercenter.model.request;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableLogic;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * 用户登录请求参数
 * @author Ghost
 * @version 1.0
 */
@Data
public class TeamAddRequest implements Serializable{

    private static final long serialVersionUID = 6993746803531411917L;

    /**
     * id
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * 队伍名称
     */
    private String name;

    /**
     * 描述
     */
    private String description;

    /**
     * 最大人数
     */
    private Integer maxNum;

    /**
     * 过期时间
     */
    private Date expireTime;

    /**
     * 用户id
     */
    private Long userId;

    /**
     * 0 - 公开，1 - 私有，2 - 加密
     */
    private Integer status;

    /**
     * 密码
     */
    private String password;
}
</code></pre> 
<p>2. 请求路径：/team/add</p> 
<p>3. 请求方式：POST</p> 
<p>4. 响应数据：添加成功的队伍 id</p> 
<h2 style="background-color:transparent;">二、业务逻辑</h2> 
<p>1. 请求参数是否为空？</p> 
<p>2. 是否登录，未登录不允许创建</p> 
<p>3. 校验信息</p> 
<ul><li>队伍人数 &gt; 1 且 &lt;= 20</li><li>队伍标题 &lt;= 20</li><li>描述 &lt;= 512</li><li>status 是否公开（int）不传默认为 0（公开）</li><li>如果 status 是加密状态，一定要有密码，且密码 &lt;= 32</li><li>超时时间 &gt; 当前时间</li><li>校验用户最多创建 5 个队伍</li></ul> 
<p>4. 插入队伍信息到队伍表</p> 
<p>5. 插入用户 =&gt; 队伍关系到关系表</p> 
<blockquote> 
 <p>注意❗</p> 
 <ul><li>操作两张表（队伍表和用户队伍关系表）时需要开启事务功能，使用 @Transactional 注解在方法上开启事务</li><li>如果添加队伍和添加用户队伍关系中间出现异常，添加队伍也失败，回滚到方法执行之前</li></ul> 
</blockquote> 
<ul><li>Controller</li></ul> 
<pre><code class="language-java">    @PostMapping("/add")
    public BaseResponse&lt;Long&gt; addTeam(@RequestBody TeamAddRequest teamAddRequest, HttpServletRequest request) {
        if (teamAddRequest == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        User loginUser = userService.getLoginUser(request);
        Team team = new Team();
        BeanUtils.copyProperties(teamAddRequest, team);
        long teamId = teamService.addTeam(team, loginUser);
        return ResultUtils.success(teamId);
    }</code></pre> 
<ul><li>Service</li></ul> 
<pre><code class="language-java">package com.example.usercenter.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.example.usercenter.common.ErrorCode;
import com.example.usercenter.constant.enums.TeamStatusEnum;
import com.example.usercenter.exception.BusinessException;
import com.example.usercenter.model.domain.Team;
import com.example.usercenter.model.domain.User;
import com.example.usercenter.model.domain.UserTeam;
import com.example.usercenter.service.TeamService;
import com.example.usercenter.mapper.TeamMapper;
import com.example.usercenter.service.UserTeamService;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;
import java.util.Date;
import java.util.Optional;

/**
* @author 20890
* @description 针对表【team(队伍)】的数据库操作Service实现
* @createDate 2024-01-22 18:27:55
*/
@Service
public class TeamServiceImpl extends ServiceImpl&lt;TeamMapper, Team&gt;
    implements TeamService{

    @Resource
    private UserTeamService userTeamService;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Long addTeam(Team team, User loginUser) {
        // 1. 请求参数是否为空？
        if (team == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        // 2. 是否登录，未登录不允许创建
        if (loginUser == null) {
            throw new BusinessException(ErrorCode.NOT_LOGIN);
        }

        final long userId = loginUser.getId();

        // 3. 校验信息
        //   1. 队伍人数 &gt; 1 且 &lt;= 20
        int maxNum = Optional.ofNullable(team.getMaxNum()).orElse(0);
        if (maxNum &lt; 1 || maxNum &gt; 20) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "队伍人数不符合要求");
        }
        //   2. 队伍标题 &lt;= 20
        String name = team.getName();
        if (StringUtils.isBlank(name) || name.length() &gt; 20) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "队伍标题不符合要求");
        }
        //   3. 描述 &lt;= 512
        String description = team.getDescription();
        if (StringUtils.isNotBlank(description) &amp;&amp; description.length() &gt; 512) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "队伍描述不符合要求");
        }
        //   4. status 是否公开（int）不传默认为 0（公开）
        int status = Optional.ofNullable(team.getStatus()).orElse(0);
        TeamStatusEnum teamStatus = TeamStatusEnum.getTeamEnumByValue(status);
        if (teamStatus == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "队伍状态不符合要求");
        }
        //   5. 如果 status 是加密状态，一定要有密码，且密码 &lt;= 32
        String password = team.getPassword();
        if (status == TeamStatusEnum.SECRET.getValue() &amp;&amp; (StringUtils.isBlank(password) || password.length() &gt; 32)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "队伍密码不符合要求");
        }
        //   6. 超时时间 &gt; 当前时间
        Date expireTime = team.getExpireTime();
        if (new Date().after(expireTime)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "超时时间已到，队伍失效");
        }
        //   7. 校验用户最多创建 5 个队伍
        // TODO 有 bug，用户可能同时创建很多个队伍
        QueryWrapper&lt;UserTeam&gt; queryWrapper = new QueryWrapper&lt;&gt;();
        queryWrapper.eq("user_id", userId);
        long hasTeamNum = userTeamService.count(queryWrapper);
        if (hasTeamNum &gt;= 5) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "每个用户最多创建 5 个队伍");
        }
        // 4. 插入队伍信息到队伍表
        team.setId(null);
        team.setUserId(userId);
        boolean result = this.save(team);
        Long teamId = team.getId();
        if (!result || teamId == null) {
            throw new BusinessException(ErrorCode.SYSTEM_ERROR,"创建队伍失败");
        }
        // 5. 插入用户  =&gt; 队伍关系到关系表
        UserTeam userTeam = new UserTeam();
        userTeam.setUserId(userId);
        userTeam.setTeamId(teamId);
        userTeam.setJoinTime(new Date());
        result = userTeamService.save(userTeam);
        if (!result) {
            throw new BusinessException(ErrorCode.SYSTEM_ERROR,"创建队伍失败");
        }
        return teamId;
    }
}




</code></pre> 
<h2>三、接口测试</h2> 
<p>1. 使用 Knife4j 接口文档进行测试</p> 
<p class="img-center"><img alt="" height="303" src="https://images2.imgbox.com/79/6a/obUrHjpt_o.png" width="662"></p> 
<p> 2. 查看数据库</p> 
<p class="img-center"><img alt="" height="312" src="https://images2.imgbox.com/3b/03/REBhZD2J_o.png" width="649"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/90189dd9d2474bd7328a971f3b3d8dbc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【JAVA】Java并发编程中的锁升级机制</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7bf1eff7dd1783c052d334b97da4364d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【日常聊聊】程序员裁员潮：技术变革下的职业危机</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>