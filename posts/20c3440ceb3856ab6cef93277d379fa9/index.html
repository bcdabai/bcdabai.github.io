<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>fuse整理 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="fuse整理" />
<meta property="og:description" content="FUSE 的工作原理如图所示。假设基于 FUSE 的用户态文件系统 hello 挂载在 /tmp/fuse 目录下。当应用层程序要访问 /tmp/fuse 下的文件时，通过 glibc 中的函数进行系统调用，处理这些系统调用的 VFS 中的函数会调用 FUSE 在内核中的文件系统；内核中的 FUSE 文件系统将用户的请求，发送给用户态文件系统 hello ；用户态文件系统收到请求后，进行处理，将结果返回给内核中的 FUSE 文件系统；最后，内核中的 FUSE 文件系统将数据返回给用户态程序。 其中，用户态文件系统通过fuse提供的函数库libfuse，向内核中的fuse文件系统注册自己的文件处理函数。
我们以一个简单的基于FUSE的用户态文件系统hello为例，来分析FUSE的内部实现。 用 户态文件系统hello的源码hello.c的部分如下所示：
static struct fuse_operations hello_oper = {
.getattr = hello_getattr,
.readdir = hello_readdir,
.open = hello_open,
.read = hello_read,
}
int main(int argc, char *argv[])
{
return fuse_main(argc, argv, &amp;hello_oper, NULL);
}
fuse_operations是libfuse提供给用户层文件系统的机 构，供用户定义自己的文件操作函数；fuse_main()是libfuse提供给用户文件系统最重要的接口，通过这个函数，用户层文件系统可以将自己定义的fuse_operation注册为文件系 统的处理函数，并挂载该文件系统。
1、内核FUSE文件系统和用户态文件系统的通信
在加载fuse模块的过程中，要在内核中注册fuse文件系统，并生成fuse设备/dev/fuse。
/dev/fuse是内核里的fuse文件系统和用户态文件系统的通信媒 介。用户态文件系统通过读取/dev/fuse的内容，获取内核中fuse文件系统发来的请求；而内核中的fuse文件系统，则把请求写入/dev/fuse，等待用户态文件系统处理。
在用户态文件系统和内核中的fuse模块通过/dev/fuse进行通信时，不可避免的会有内存拷贝。fuse中没有使用传统的copy_from_user/copy_to_user，而是用get_user_pages和memcpy来代替。
2、FUSE用户态文件系统的挂载过程
挂载用户态文件系统，只需运行其生成的程序。在hello中，运行编译hello.c生成的hello即可。fuse_main将完成一切的注册和挂载过程，其中主要分为两个步骤:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/20c3440ceb3856ab6cef93277d379fa9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-11-27T00:21:50+08:00" />
<meta property="article:modified_time" content="2012-11-27T00:21:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">fuse整理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"> FUSE</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">的工作原理如图所示。假设基于</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">FUSE</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">的用户态文件系统</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">hello</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">挂载在</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">/tmp/fuse</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">目录下。当应用层程序要访问</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">/tmp/fuse</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">下的文件时，通过</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">glibc</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">中的函数进行系统调用，处理这些系统调用的</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">VFS</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">中的函数会调用</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">FUSE</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">在内核中的文件系统；内核中的</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">FUSE</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">文件系统将用户的请求，发送给用户态文件系统</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">hello</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">；用户态文件系统收到请求后，进行处理，将结果返回给内核中的</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">FUSE</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">文件系统；最后，内核中的</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)">FUSE</span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">文件系统将数据返回给用户态程序。</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"></span> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <a target="_blank" rel="nofollow noopener noreferrer" href="http://blog.chinaunix.net/attachment/201105/10/24276740_13050115278xx2.jpg" style="color:rgb(86,124,122); text-decoration:initial"><img alt="FUSE整理 - bpingchang - bpingchang的博客" src="https://images2.imgbox.com/2b/06/f18EK1xb_o.jpg" border="0" style="border:0px; max-width:100%"></a></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">其中，用户态文件系统通过</span>fuse<span lang="ZH-CN" style="font-family:宋体">提供的函数库</span>libfuse<span lang="ZH-CN" style="font-family:宋体">，向内核中的</span>fuse<span lang="ZH-CN" style="font-family:宋体">文件系统注册自己的文件处理函数。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">我们以一个简单的基于</span><span style="font-family:宋体">FUSE<span lang="ZH-CN">的用户态文件系统</span>hello<span lang="ZH-CN">为例，来分析</span>FUSE<span lang="ZH-CN">的内部实现。</span> <span lang="ZH-CN">用 户态文件系统</span>hello<span lang="ZH-CN">的源码</span>hello.c<span lang="ZH-CN">的部分如下所示：</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana; background-color:rgb(217,217,217)">static struct fuse_operations hello_oper = {<!-- --></span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="IT" style="line-height:21px; font-size:9pt; font-family:Verdana">.getattr = hello_getattr,</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="IT" style="line-height:21px; font-size:9pt; font-family:Verdana">.readdir = hello_readdir,</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:23px; font-size:10pt; font-family:Verdana; background-color:rgb(199,199,199)">.open      = hello_open,</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:23px; font-size:10pt; font-family:Verdana; background-color:rgb(199,199,199)">.read       = hello_read,</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">}</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana; background-color:rgb(217,217,217)">int main(int argc, char *argv[])</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana; background-color:rgb(217,217,217)">{<!-- --></span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana; background-color:rgb(217,217,217)">     return  fuse_main(argc, argv, &amp;hello_oper, NULL);</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">}</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="font-family:宋体">fuse_operations<span lang="ZH-CN">是</span>libfuse<span lang="ZH-CN">提供给用户层文件系统的机 构，供用户定义自己的文件操作函数；</span>fuse_main()<span lang="ZH-CN">是</span>libfuse<span lang="ZH-CN">提供给用户文件系统最重要的接口，通过这个函数，用户层文件系统可以将自己定义的</span>fuse_operation<span lang="ZH-CN">注册为文件系 统的处理函数，并挂载该文件系统。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <strong><span style="line-height:34px; font-size:14.5pt; font-family:Verdana">1、</span><span lang="ZH-CN" style="line-height:34px; font-size:14.5pt; font-family:宋体">内核</span><span style="line-height:34px; font-size:14.5pt; font-family:Verdana">FUSE</span><span lang="ZH-CN" style="line-height:34px; font-size:14.5pt; font-family:宋体">文件系统和用户态文件系统的通信</span></strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">在加载</span><span style="font-family:宋体">fuse<span lang="ZH-CN">模块的过程中，要在内核中注册</span>fuse<span lang="ZH-CN">文件系统，并生成</span>fuse<span lang="ZH-CN">设备</span>/dev/fuse<span lang="ZH-CN">。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="font-family:宋体">/dev/fuse<span lang="ZH-CN">是内核里的</span>fuse<span lang="ZH-CN">文件系统和用户态文件系统的通信媒 介。用户态文件系统通过读取</span>/dev/fuse<span lang="ZH-CN">的内容，获取内核中</span>fuse<span lang="ZH-CN">文件系统发来的请求；而内核中的</span>fuse<span lang="ZH-CN">文件系统，则把请求写入</span>/dev/fuse<span lang="ZH-CN">，等待用户态文件系统处理。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">在用户态文件系统和内核中的</span><span style="font-family:宋体">fuse<span lang="ZH-CN">模块通过</span>/dev/fuse<span lang="ZH-CN">进行通信时，不可避免的会有内存拷贝。</span>fuse<span lang="ZH-CN">中没有使用传统的</span>copy_from_user/copy_to_user<span lang="ZH-CN">，而是用</span>get_user_pages<span lang="ZH-CN">和</span>memcpy<span lang="ZH-CN">来代替。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <strong><span style="line-height:34px; font-size:14.5pt; font-family:Verdana">2、FUSE</span><span lang="ZH-CN" style="line-height:34px; font-size:14.5pt; font-family:宋体">用户态文件系统的挂载过程</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">挂载用户态文件系统，只需运行其生成的程序。在</span><span style="font-family:宋体">hello<span lang="ZH-CN">中，运行编译</span>hello.c<span lang="ZH-CN">生成的</span>hello<span lang="ZH-CN">即可。</span>fuse_main<span lang="ZH-CN">将完成一切的注册和挂载过程，其中主要分为两个步骤</span>:</span></p> 
<span style="line-height:28px; color:rgb(76,76,76); background-color:rgb(204,206,208); font-size:12pt; font-family:宋体">2.1</span> 
<span style="line-height:21px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; background-color:rgb(204,206,208); font-size:7pt">        </span> 
<span lang="ZH-CN" style="line-height:28px; color:rgb(76,76,76); background-color:rgb(204,206,208); font-size:12pt; font-family:宋体">在内核中挂载新的用户态文件系统</span> 
<span style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体"></span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"></span> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">1.         </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">打开设备文件</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">"/dev/fuse"</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">，</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:Verdana"> </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">获得文件描述符</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fd</span><strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">2.         </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">挂载</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">FUSE</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">文件系统（内核里的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"> fuse</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">文件系统），将</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fd</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">作为参数传给内核里的挂载函数</span><strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">3.         </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">内核中的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">文件系统在初始化</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"> super_block</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">的过程中，将创建一个新的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse_conn</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">，它就是内核</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">和用户态文件系统通信的工具</span><strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">4.         </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">将该</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse_conn</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">设置为在用户</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:Verdana"> </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">态打开的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">/dev/fuse</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">的私有数据（</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">file-&gt;private</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">）；同时，该文件系统的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">super_block</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">s_fs_info</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">也指向该</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"> fuse_conn</span><strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<span style="line-height:28px; color:rgb(76,76,76); background-color:rgb(204,206,208); font-size:12pt; font-family:宋体">2.2 <span lang="ZH-CN">注册用户态文件系统的处理函数，并创建进程处理该文件系统的请求</span></span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"></span> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">1.         </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">创建一个新的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse_chan</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">，用</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:Verdana"> </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">来与内核中的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">通信。它的处理函数是</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"> fuse_chan_ops</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">：</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"> </span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">.receive = fuse_kern_chan_receive, </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">等待并从</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">4.2.1-1</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">步骤中打开的文件中读取请求</span><strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">.send = fuse_kern_chan_send,            </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">将用户态文件系统处理的结果发送给内</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:Verdana"> </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">核</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse</span><strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">.destroy = fuse_kern_chan_destroy, </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">释放</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse_chan</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> <strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"> </span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">2.         </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">创建一个</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse_session</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">，并</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:Verdana"> </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">注册用户态文件系统的处理函数，用来等待并处理该文件系统的请求</span><strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">3.         </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">等待用户态文件系统的请求，并处理它</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:Verdana"> </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">们</span><strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <strong><span style="line-height:21px; font-size:9pt; font-family:Verdana"> </span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <strong><span style="line-height:34px; font-size:14.5pt; font-family:Verdana">3、</span><span lang="ZH-CN" style="line-height:34px; font-size:14.5pt; font-family:宋体">多个基于</span><span style="line-height:34px; font-size:14.5pt; font-family:Verdana">FUSE</span><span lang="ZH-CN" style="line-height:34px; font-size:14.5pt; font-family:宋体">的用户态文件系统的共存</span></strong><span style="line-height:34px; font-size:14.5pt"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">在挂载的过程中，每个用户态文件系统 都会创建一个自己的</span><span style="font-family:宋体">fuse_conn<span lang="ZH-CN">，并将该</span>fuse_conn<span lang="ZH-CN">设为自己打开的</span>/dev/fuse<span lang="ZH-CN">的私有数据</span>(file_private)<span lang="ZH-CN">；同时，该文 件系统在内核里的</span>super_block,<span lang="ZH-CN">也将该</span>fuse_conn<span lang="ZH-CN">设置为</span>s_fs_info<span lang="ZH-CN">。在以后的过程中，用户态的文件系统处理线程都是从自己的</span> fuse_conn<span lang="ZH-CN">上读取请求；内核中的</span>fuse<span lang="ZH-CN">文件系统，也只把请求发给</span>s_fs_info<span lang="ZH-CN">指向的</span>fuse_conn<span lang="ZH-CN">。通过这种机制，</span>FUSE<span lang="ZH-CN">就能支持 多个用户态文件系统同时运行，且互不干扰。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="font-family:宋体">FUSE<span lang="ZH-CN">是一个用户空间中的文件系统框架。它包含</span>2<span lang="ZH-CN">个部分，</span>FUSE<span lang="ZH-CN">内核模块和用户空间接口模块。在用户空间的执行文件系统能够大幅提高生长率，简化了为操作系统提供新的文件系统的工作量，适合于各种虚拟文件系 统和网络文件系统。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="font-family:宋体">FUSE <span lang="ZH-CN">作为用户态文件系统与内核交互的桥梁，拥有着</span>2<span lang="ZH-CN">个模块。其一是与用户态文件系统直接交互模块，如上图中的</span>libfuse<span lang="ZH-CN">接口。其二是内核中挂载到</span>VFS<span lang="ZH-CN">上的</span>FUSE<span lang="ZH-CN">内核模块。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="font-family:宋体">FUSE<span lang="ZH-CN">信息处理流程：</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">当用户发起一个请求</span><span style="font-family:宋体">ls –l /tmp/fuse <span lang="ZH-CN">时，操作系统调用内核函数接口</span>glibc<span lang="ZH-CN">将该请求发送到内核态</span>VFS<span lang="ZH-CN">；</span>VFS<span lang="ZH-CN">根据请求判断出需要调用的文件系统（</span>FUSE<span lang="ZH-CN">已经挂到</span>VFS<span lang="ZH-CN">的文件系统列表上）并将此请求发送到</span>FUSE<span lang="ZH-CN">内核模块；由内核模块再将此请求发 送到特殊文件</span>/dev/fuse<span lang="ZH-CN">的请求队列中；而用户态的</span>libfuse<span lang="ZH-CN">则不停的循环请求</span>/dev/fuse<span lang="ZH-CN">文件中的请求队列，如获得请求则解析该请求，并发送给挂在其上的用户态文件系统，由它来执行请求。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">在用户态文件系统执行完该请求后，按照逆方向返回执行结果给用户。</span><span style="font-family:宋体"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <a name="_Toc265855168" rel="nofollow" style="color:rgb(86,124,122)"><strong><span style="line-height:34px; font-size:14.5pt">4</span></strong></a><strong><span style="line-height:34px; font-size:14.5pt; font-family:Verdana">、</span><span lang="ZH-CN" style="line-height:34px; font-size:14.5pt; font-family:宋体">用户态文件系统的挂载过程</span><span style="line-height:34px; font-size:14.5pt"></span></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify; text-indent:21pt"> <span style="font-family:宋体">1)<span lang="ZH-CN">用户态文件系统启动的第一部就是将自身注册到</span>VFS<span lang="ZH-CN">上去。首先调用</span>./lib/helper.c<span lang="ZH-CN">文件中函数</span>fuse_mount(const char *mountpoint, struct fuse_args *args), <span lang="ZH-CN">参数包括挂载点</span>mountpoint<span lang="ZH-CN">等，在挂载过程中只需要输入挂载点路径即可。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify; text-indent:21pt"> <span style="font-family:宋体">2)</span><span lang="ZH-CN" style="font-family:宋体">通过调用</span><span style="font-family:宋体">./lib/helper.c</span><span lang="ZH-CN" style="font-family:宋体">文件中函数</span><span style="font-family:宋体">fuse_mount_compat25(const char *mountpoint, struct fuse_args *args) </span><span lang="ZH-CN" style="font-family:宋体">再调用</span><span style="font-family:宋体">./lib/mount.c</span><span lang="ZH-CN" style="font-family:宋体">文件中的</span><span style="font-family:宋体">fuse_kern_mount(const char *mountpoint, struct fuse_args *args)</span><span lang="ZH-CN" style="font-family:宋体">，接着调用</span><span style="font-family:宋体">static int fuse_mount_sys(const char *mnt, struct mount_opts *mo, const char *mnt_opts)</span><span lang="ZH-CN" style="font-family:宋体">函数，其中通过语句</span><span style="font-family:宋体"> fd = open(devname, O_RDWR);</span><span lang="ZH-CN" style="font-family:宋体">来检测文件</span><span style="font-family:宋体">/dev/fuse</span><span lang="ZH-CN" style="font-family:宋体">是否能够正常打开。如果正常，则直接调用系统函数</span><span style="font-family:宋体">res = mount(source, mnt, type, mo-&gt;flags, mo-&gt;kernel_opts);</span><span lang="ZH-CN" style="font-family:宋体">将其挂载到</span><span style="font-family:宋体">VFS</span><span lang="ZH-CN" style="font-family:宋体">上。</span><span style="font-family:宋体"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="font-family:宋体">    3)<span lang="ZH-CN">创建并初始化一个跟</span>/dev/fuse<span lang="ZH-CN">交互的通道结构体</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">struct fuse_chan {<!-- --></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">struct fuse_chan_ops op; //<span lang="ZH-CN">其中操作包括</span>receive, send, distroy<span lang="ZH-CN">三中方法。</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">struct fuse_session *se;  //<span lang="ZH-CN">通道的会话</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">int fd;      //<span lang="ZH-CN">文件</span>/dev/fuse <span lang="ZH-CN">的</span>fd<span lang="ZH-CN">号</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">size_t bufsize;     //pagesize() + 0x1000</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">void *data;</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">int compat;</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">};</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">//<span lang="ZH-CN">通道操作的动作绑定结构体</span></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">struct fuse_chan_ops op = {<!-- --></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">           .receive = fuse_kern_chan_receive,</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">           .send = fuse_kern_chan_send,</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">           .destroy = fuse_kern_chan_destroy,</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="font-family:宋体">    };</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span lang="ZH-CN" style="font-family:宋体">最后将建立的通道</span><span style="font-family:宋体">fuse_chan<span lang="ZH-CN">返回给用户文件系统的</span>main()<span lang="ZH-CN">函数。</span></span></p> 
<span style="line-height:25px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"></span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"></span> 
<a name="_Toc265855169" rel="nofollow" style="color:rgb(86,124,122); line-height:25px; font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">5</a> 
<span style="line-height:25px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"><span lang="ZH-CN" style="font-family:宋体">、</span></span> 
<span style="line-height:25px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"><span style="line-height:37px; font-size:16pt; font-family:Verdana">FUSE</span></span> 
<span style="line-height:25px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"></span> 
<span style="line-height:25px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"><span lang="ZH-CN" style="line-height:37px; font-size:16pt; font-family:宋体">用户态模块的业务逻辑结构</span></span> 
<span style="line-height:25px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"><span style="line-height:37px; font-size:16pt; font-family:Verdana"></span></span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"></span> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify; text-indent:-21pt"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">1)</span><span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">在用户态文件系统的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">main()</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">函数中调用文件</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse_loop.c</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">中的函数</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">void fuse_session_add_chan(struct fuse_session *se, struct fuse_chan *ch)</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">，将通道地址赋值给该会话结构体</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">struct fuse_session se, </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">然后通过调用同一文件中的函数</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">int fuse_session_loop(struct fuse_session *se)</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">来做信息的接收与发送工作。</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">struct fuse_session {<!-- --></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">       struct fuse_session_ops op;  //</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">会话的操作</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">       void *data;</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">       volatile int exited;</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">       struct fuse_chan *ch;</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">};</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify; text-indent:-21pt"> <span style="line-height:21px; font-size:9pt; font-family:宋体">2)  <span lang="ZH-CN">在函数</span></span><span style="line-height:21px; font-size:9pt; font-family:Verdana">int fuse_chan_recv(struct fuse_chan **chp, char *buf, size_t size)</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">中调用结构体</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">struct fuse_chan </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">中绑定的操作函数</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">static int fuse_kern_chan_receive(struct fuse_chan **chp, char *buf, size_t size)</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">直接调用</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">read()</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">系统函数</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">res = read(fuse_chan_fd(ch), buf, size); </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">来从</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">/dev/fuse</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">中读取消息。</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">//</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">通道操作 的动作绑定结构体</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">struct fuse_chan_ops op = {<!-- --></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">              .receive = fuse_kern_chan_receive,</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">              .send = fuse_kern_chan_send,</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">              .destroy = fuse_kern_chan_destroy,</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">};</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">3)   </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">在函数</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">void fuse_session_process(struct fuse_session *se, const char *buf, size_t len, struct fuse_chan *ch)</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">中调用已绑定的</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">se-&gt;op.process()</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">函 数转向文件</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">./lib/fuse_lowlevel.c</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">中被绑定函数</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">static void fuse_ll_process(void *data, const char *buf, size_t len, struct fuse_chan *ch)</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">。</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">struct fuse_session_ops sop = {<!-- --></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">              .process = fuse_ll_process,</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">              .destroy = fuse_ll_destroy,</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-align:justify"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">};</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">在这个函数处理过程中，首先要申明一个请求结构体指针</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">struct fuse_req *req, </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">然 后通过在</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">read(fuse_chan_fd(ch), buf, size); </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">函数执行中读取的数据</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">buf</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">，且将其强制转化为</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">fuse_in_header</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">类型（</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">struct fuse_in_header *in = (struct fuse_in_header *) buf;</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">），并初始化请求结构体</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">req</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">。</span><span style="line-height:21px; font-size:9pt; font-family:宋体">\</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">struct fuse_req {<!-- --></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span style="line-height:21px; font-size:9pt; font-family:Verdana">}</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">通过解析出</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">in-&gt;opcode</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">的数据和用户态文 件系统定义的已绑定的接口函数相比较，得到相应的处理函数，最后执行这个函数完成请求。示例如下：如</span><span style="line-height:21px; font-size:9pt; font-family:Verdana">in-&gt;opcode </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">＝</span><span style="line-height:21px; font-size:9pt; font-family:Verdana; color:red">FUSE_MKDIR</span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">，</span><span style="line-height:21px; font-size:9pt; font-family:Verdana; color:red"> </span><span lang="ZH-CN" style="line-height:21px; font-size:9pt; font-family:宋体">则通过结构体</span><span style="line-height:21px; font-size:9pt; font-family:Verdana"></span></p> 
<a name="_Toc265855170" rel="nofollow" style="color:rgb(86,124,122); line-height:25px; font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">6</a> 
<span style="line-height:25px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"><span lang="ZH-CN" style="font-family:宋体">、</span>FUSE</span> 
<span style="line-height:25px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"></span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">内核模块的业务逻辑结构</span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"></span> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> FUSE <span lang="ZH-CN" style="font-family:宋体">作为用户态文件系统与内核交互的桥梁，拥有着</span>2<span lang="ZH-CN" style="font-family:宋体">个模块。其一是与用户态文件系统直接交互模块，如上图中的</span>libfuse<span lang="ZH-CN" style="font-family:宋体">接口。其二是内核中挂载到</span>VFS<span lang="ZH-CN" style="font-family:宋体">上的</span>FUSE<span lang="ZH-CN" style="font-family:宋体">内核模块。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> FUSE<span lang="ZH-CN" style="font-family:宋体">信息处理流程：</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">当用户发起一个请求</span>ls –l /tmp/fuse <span lang="ZH-CN" style="font-family:宋体">时，操作系统调用内核函数接口</span>glibc<span lang="ZH-CN" style="font-family:宋体">将该请求发送到内核态</span>VFS<span lang="ZH-CN" style="font-family:宋体">；</span>VFS<span lang="ZH-CN" style="font-family:宋体">根据请求判断出需要调用的文件系统（</span>FUSE<span lang="ZH-CN" style="font-family:宋体">已经挂到</span>VFS<span lang="ZH-CN" style="font-family:宋体">的文件系统列表上）并将此请求发送到</span>FUSE<span lang="ZH-CN" style="font-family:宋体">内核模块；由内核模块再将此请求发 送到特殊文件</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">的请求队列中；而用户态的</span>libfuse<span lang="ZH-CN" style="font-family:宋体">则不停的循环请求</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">文件中的请求队列，如获得请求则解析该请求，并发送给挂在其上的用户态文件系统，由它来执行请求。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">在用户态文件系统执行完该请求后，按照逆方向返回执行结果给用户。</span></p> 
<span style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:宋体">6.1</span> 
<span style="line-height:21px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; background-color:rgb(204,206,208); font-size:7pt">      </span> 
<span lang="ZH-CN" style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:黑体">用户态文件系统的挂载过程</span> 
<span style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:黑体"></span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"></span> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">用户态文件系统启动的第一部就是将自身注册 到</span>VFS<span lang="ZH-CN" style="font-family:宋体">上去。首 先调用</span>./lib/helper.c<span lang="ZH-CN" style="font-family:宋体">文件中函数</span>fuse_mount(const char *mountpoint, struct fuse_args *args), <span lang="ZH-CN" style="font-family:宋体">参数包括挂载点</span>mountpoint<span lang="ZH-CN" style="font-family:宋体">等，在挂载过程中只需 要输入挂载点路径即可。</span><span style="font-family:宋体"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 2)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">通过调用</span>./lib/helper.c<span lang="ZH-CN" style="font-family:宋体">文件中函数</span>fuse_mount_compat25(const char *mountpoint, struct fuse_args *args)<span lang="ZH-CN" style="font-family:宋体">再调用</span>./lib/mount.c<span lang="ZH-CN" style="font-family:宋体">文件中的</span>fuse_kern_mount(const char *mountpoint, struct fuse_args *args)<span lang="ZH-CN" style="font-family:宋体">，接着调用</span>static int fuse_mount_sys(const char *mnt, struct mount_opts *mo, const char *mnt_opts)<span lang="ZH-CN" style="font-family:宋体">函数，其中通过语句</span> fd = open(devname, O_RDWR);<span lang="ZH-CN" style="font-family:宋体">来检测文件</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">是否能够正常打开。如果正常，则直接调用系统函数</span>res = mount(source, mnt, type, mo-&gt;flags, mo-&gt;kernel_opts);<span lang="ZH-CN" style="font-family:宋体">将其挂载到</span>VFS<span lang="ZH-CN" style="font-family:宋体">上。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 3)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">创建并初始化一个跟</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">交互的通道结构体</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> struct fuse_chan {<!-- --></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> struct fuse_chan_ops op; //<span lang="ZH-CN" style="font-family:宋体">其中操作包括</span>receive, send, distroy<span lang="ZH-CN" style="font-family:宋体">三中方法。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> struct fuse_session *se;  //<span lang="ZH-CN" style="font-family:宋体">通道的会话</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> int fd;                //<span lang="ZH-CN" style="font-family:宋体">文件</span>/dev/fuse <span lang="ZH-CN" style="font-family:宋体">的</span>fd<span lang="ZH-CN" style="font-family:宋体">号</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> size_t bufsize;         //pagesize() + 0x1000</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> void *data;</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> int compat;</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> };</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> //<span lang="ZH-CN" style="font-family:宋体">通道操作的动作绑定结构体</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> struct fuse_chan_ops op = {<!-- --></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">            .receive = fuse_kern_chan_receive,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">            .send = fuse_kern_chan_send,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">            .destroy = fuse_kern_chan_destroy,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">     };</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span lang="ZH-CN" style="font-family:宋体">最后将建立的通道</span>fuse_chan<span lang="ZH-CN" style="font-family:宋体">返回给用户文件系统的</span>main()<span lang="ZH-CN" style="font-family:宋体">函数。</span></p> 
<span style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:黑体">6.2</span> 
<span style="line-height:20px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; background-color:rgb(204,206,208); font-size:7pt">      </span> 
<span style="line-height:25px; color:rgb(76,76,76); font-size:14px; background-color:rgb(204,206,208); font-family:黑体">FUSE<span lang="ZH-CN">用户态模块的业务逻辑结构</span></span> 
<span style="color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; line-height:25px; background-color:rgb(204,206,208)"></span> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">在用户态文件系统的</span>main()<span lang="ZH-CN" style="font-family:宋体">函数中调用文件</span>fuse_loop.c<span lang="ZH-CN" style="font-family:宋体">中的函数</span>void fuse_session_add_chan(struct fuse_session *se, struct fuse_chan *ch)<span lang="ZH-CN" style="font-family:宋体">，将通道地址赋值给该会话结构体</span>struct fuse_session se, <span lang="ZH-CN" style="font-family:宋体">然后通过调用同一文件中的函数</span>int fuse_session_loop(struct fuse_session *se)<span lang="ZH-CN" style="font-family:宋体">来做信息的接收与发送工作。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> struct fuse_session {<!-- --></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">        struct fuse_session_ops op;  //<span lang="ZH-CN" style="font-family:宋体">会话的操作</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">        void *data;</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">        volatile int exited;</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">        struct fuse_chan *ch;</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> };</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> <span lang="ZH-CN" style="font-family:宋体">接下来在</span>while()<span lang="ZH-CN" style="font-family:宋体">循环中函数</span>int fuse_chan_recv(struct fuse_chan **chp, char *buf, size_t size)<span lang="ZH-CN" style="font-family:宋体">用于消息的接收函数，如果接收到消息，则调用</span>fuse_session.c<span lang="ZH-CN" style="font-family:宋体">文件中</span>void fuse_session_process(struct fuse_session *se, const char *buf, size_t len,<span lang="ZH-CN" style="font-family:宋体">处理函数进行处理，其中调用会话控制结构体中的</span>process<span lang="ZH-CN" style="font-family:宋体">函数指针所指向的函数来做实 际的处理（这个函数是由用户态文件系统提供的文件操作函数接口）。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> struct fuse_session_ops {<!-- --></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> void (*process) (void *data, const char *buf, size_t len,  struct fuse_chan *ch);</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> void (*exit) (void *data, int val);</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> int (*exited) (void *data);</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:36pt"> void (*destroy) (void *data);</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> };</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">在函数</span>int fuse_chan_recv(struct fuse_chan **chp, char *buf, size_t size)<span lang="ZH-CN" style="font-family:宋体">中调用结构体</span>struct fuse_chan<span lang="ZH-CN" style="font-family:宋体">中绑定的 操作函数</span>static int fuse_kern_chan_receive(struct fuse_chan **chp, char *buf, size_t size)<span lang="ZH-CN" style="font-family:宋体">直接调用</span>read()<span lang="ZH-CN" style="font-family:宋体">系统函数</span>res = read(fuse_chan_fd(ch), buf, size); <span lang="ZH-CN" style="font-family:宋体">来从</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">中读取消息。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:73.5pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> //<span lang="ZH-CN" style="font-family:宋体">通道操作的动作绑定结构体</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> struct fuse_chan_ops op = {<!-- --></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">               .receive = fuse_kern_chan_receive,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">               .send = fuse_kern_chan_send,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">               .destroy = fuse_kern_chan_destroy,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> };</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">在函数</span>void fuse_session_process(struct fuse_session *se, const char *buf, size_t len, struct fuse_chan *ch)<span lang="ZH-CN" style="font-family:宋体">中 调用已绑定的</span>se-&gt;op.process()<span lang="ZH-CN" style="font-family:宋体">函数转向文件</span>./lib/fuse_lowlevel.c<span lang="ZH-CN" style="font-family:宋体">中被绑定函数</span>static void fuse_ll_process(void *data, const char *buf, size_t len, struct fuse_chan *ch)<span lang="ZH-CN" style="font-family:宋体">。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> struct fuse_session_ops sop = {<!-- --></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">               .process = fuse_ll_process,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">               .destroy = fuse_ll_destroy,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> };</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">在这个函数处理过程中，首先要申明一个请求结构体指针</span>struct fuse_req *req, <span lang="ZH-CN" style="font-family:宋体">然后通过在</span>read(fuse_chan_fd(ch), buf, size); <span lang="ZH-CN" style="font-family:宋体">函数执行中读取的数据</span>buf<span lang="ZH-CN" style="font-family:宋体">，且将其强制转化为</span>fuse_in_header<span lang="ZH-CN" style="font-family:宋体">类型（</span>struct fuse_in_header *in = (struct fuse_in_header *) buf;<span lang="ZH-CN" style="font-family:宋体">），并初 始化请求结构体</span>req<span lang="ZH-CN" style="font-family:宋体">。</span><span style="font-family:宋体">\</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> struct fuse_req {}</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">通过解析出</span>in-&gt;opcode<span lang="ZH-CN" style="font-family:宋体">的数据和用户态文件系统定义的已绑定的接口函数相比较，得到相应的处理函数，最后执行这个函数完成 请求。示例如下：如</span>in-&gt;opcode <span lang="ZH-CN" style="font-family:宋体">＝</span><span lang="ZH-CN"> </span><span style="color:red">FUSE_MKDIR</span><span lang="ZH-CN" style="font-family:宋体">，</span><span lang="ZH-CN" style="color:red"> </span><span lang="ZH-CN" style="font-family:宋体">则通过结构体</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)"> static struct {<!-- --></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">        void (*func)(fuse_req_t, fuse_ino_t, const void *);</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">        const char *name;</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> }<span lang="ZH-CN" style="font-family:宋体">中已经初始化绑定的</span>[<span style="color:red">FUSE_MKDIR</span>] = { do_mkdir, "MKDIR" },<span lang="ZH-CN" style="font-family:宋体">一行数据找到函数</span>static void do_mkdir(fuse_req_t req, fuse_ino_t nodeid, const void *inarg)<span lang="ZH-CN" style="font-family:宋体">最后来实现请求。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">当需要返回数据时，需要调用文件</span>./lib/fuse_lowlevel.c<span lang="ZH-CN" style="font-family:宋体">中 的函数</span>static int send_reply(fuse_req_t req, int error, const void *arg, size_t argsize)<span lang="ZH-CN" style="font-family:宋体">，之后经过一系列的解析和变换，最后调用 文件</span>./fuse_kern_chan.c<span lang="ZH-CN" style="font-family:宋体">中的</span>static int fuse_kern_chan_send(struct fuse_chan *ch, const struct iovec iov[], size_t count)<span lang="ZH-CN" style="font-family:宋体">函数，它再调用系 统函数</span>writev()<span lang="ZH-CN" style="font-family:宋体">（</span>ssize_t res = writev(fuse_chan_fd(ch), iov, count);<span lang="ZH-CN" style="font-family:宋体">）来将返回数据写入到</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">中去。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208)">  </p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <strong><em><span style="line-height:37px; font-size:16pt; font-family:Verdana">7</span><span lang="ZH-CN" style="line-height:37px; font-size:16pt; font-family:宋体">、</span><span style="line-height:37px; font-size:16pt; font-family:Verdana">FUSE</span><span lang="ZH-CN" style="line-height:37px; font-size:16pt; font-family:宋体">内核模块的业务逻辑结构</span><span style="line-height:37px; font-size:16pt; font-family:Verdana"></span></em></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">说明：（<span style="color:rgb(51,102,255)">因</span></span><span style="color:rgb(51,102,255)">VFS</span><span lang="ZH-CN" style="font-family:宋体; color:rgb(51,102,255)">与</span>FUSE<span lang="ZH-CN" style="font-family:宋体; color:rgb(51,102,255)">内核模块的交互部分是由</span>Linux<span lang="ZH-CN" style="font-family:宋体; color:rgb(51,102,255)">内核编译生成的，暂时无法打印调试，因此对这部分代码的分析还不够确切，在接下来的工作中将会编译</span><span style="color:rgb(51,102,255)">FUSE</span><span lang="ZH-CN" style="font-family:宋体; color:rgb(51,102,255)">内核部分代码，并再次详细分析其运行过程</span><span lang="ZH-CN" style="font-family:宋体">）。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 2)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">当用户发出请求，若请求为：</span>”rm /mnt/fuse/file” <span lang="ZH-CN" style="font-family:宋体">时， 操作系统直接调用</span>VFS<span lang="ZH-CN" style="font-family:宋体">函数</span>sys_unlink()<span lang="ZH-CN" style="font-family:宋体">。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">通过</span>VFS<span lang="ZH-CN" style="font-family:宋体">的转向，调用已注册的“</span>FUSE<span lang="ZH-CN" style="font-family:宋体">文件系统”（</span>FUSE<span lang="ZH-CN" style="font-family:宋体">内核模块）的函数</span>fuse_unlink()<span lang="ZH-CN" style="font-family:宋体">。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 2)<span style="line-height:21px; font-size:7pt">        </span>FUSE<span lang="ZH-CN" style="font-family:宋体">内核模块将接收到的请求保存到结构体</span>struct fuse_conn fc<span lang="ZH-CN" style="font-family:宋体">的</span>fc-&gt;unused_list<span lang="ZH-CN" style="font-family:宋体">中，通 过函数</span>request_send()<span lang="ZH-CN" style="font-family:宋体">函数将其写入</span>fc-&gt;pending<span lang="ZH-CN" style="font-family:宋体">，同时使用函数</span>fuse_dev_writev()<span lang="ZH-CN" style="font-family:宋体">将此请求写到特殊文件</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">中。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <a name="_Toc265855171" rel="nofollow" style="color:rgb(86,124,122)"><strong><em><span style="line-height:37px; font-size:16pt; font-family:Verdana">8</span></em></strong></a><strong><em><span lang="ZH-CN" style="line-height:37px; font-size:16pt; font-family:宋体">、内核中</span><span style="line-height:37px; font-size:16pt; font-family:Verdana">/dev/fuse</span><span lang="ZH-CN" style="line-height:37px; font-size:16pt; font-family:宋体">读写详细流程</span><span style="line-height:37px; font-size:16pt; font-family:Verdana"></span></em></strong></p> 
<p style="line-height:24px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> <span style="line-height:25px">1)<span style="line-height:20px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">前提介绍</span></span></p> 
<p style="line-height:24px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="line-height:25px; font-family:宋体">当</span><span style="line-height:25px; font-family:宋体">VFS<span lang="ZH-CN">要下发命令到</span>FUSE<span lang="ZH-CN">或者从</span>FUSE<span lang="ZH-CN">获取恢复时，首先找到与</span>FUSE<span lang="ZH-CN">绑定的接口函数结构体（在</span>dev.c<span lang="ZH-CN">中）。</span></span></p> 
<p style="line-height:24px; margin-top:0px; margin-bottom:10px; margin-left:84pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span style="line-height:25px; font-family:宋体">struct file_operations fuse_dev_operations = {}</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">读取</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">中的请求</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">在内核中要读取</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">中的请求数据时，最终要调用文件</span>dev.c<span lang="ZH-CN" style="font-family:宋体">中的函数</span>static ssize_t fuse_dev_readv(struct file *file, const struct iovec *iov, unsigned long nr_segs, loff_t *off)<span lang="ZH-CN" style="font-family:宋体">，</span><span lang="ZH-CN"> </span><span lang="ZH-CN" style="font-family:宋体">此函数首先通过传入的参数</span>file<span lang="ZH-CN" style="font-family:宋体">来初始化一个</span>struct fuse_conn *fc<span lang="ZH-CN" style="font-family:宋体">结构体。然后调用请求等待函数</span>static void request_wait(struct fuse_conn *fc)<span lang="ZH-CN" style="font-family:宋体">， 先申明并初始化一个进程等待列表</span>DECLARE_WAITQUEUE(wait, current); </p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">将</span>wait<span lang="ZH-CN" style="font-family:宋体">加入到</span>fc-&gt;waitq<span lang="ZH-CN" style="font-family:宋体">等待队列中，当有请求发到</span>fuse<span lang="ZH-CN" style="font-family:宋体">文件系统时（通过</span>request_send<span lang="ZH-CN" style="font-family:宋体">），这个等待队列上的进程会被唤醒，某一个进程会被赋予</span>CPU<span lang="ZH-CN" style="font-family:宋体">使用权：</span>add_wait_queue_exclusive(&amp;fc-&gt;waitq, &amp;wait)<span lang="ZH-CN" style="font-family:宋体">，</span><span lang="ZH-CN"></span><span lang="ZH-CN" style="font-family:宋体">接着不断的检查</span>fc<span lang="ZH-CN" style="font-family:宋体">的</span>pending<span lang="ZH-CN" style="font-family:宋体">队列及</span>interrupts<span lang="ZH-CN" style="font-family:宋体">队列，看是否有请求，没有请求会一直</span>while<span lang="ZH-CN" style="font-family:宋体">循环。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> while (fc-&gt;connected &amp;&amp; !request_pending(fc)) {}</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">如果有请求，则</span>break<span lang="ZH-CN" style="font-family:宋体">出来将当前进程状态设置为</span>TASK_RUNNING<span lang="ZH-CN" style="font-family:宋体">状态，</span>set_current_state(TASK_RUNNING);<span lang="ZH-CN" style="font-family:宋体">并将其从等待队列中移出，</span>remove_wait_queue(&amp;fc-&gt;waitq, &amp;wait) <span lang="ZH-CN" style="font-family:宋体">。</span> </p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">在</span>fc-&gt;pending<span lang="ZH-CN" style="font-family:宋体">列表为非空时，证明已经有数据到达，那么作一些相应的状态修改，初始化等工作后，判断这个请求是否 合法，如果是合法请求，这从</span>fc-&gt;pending<span lang="ZH-CN" style="font-family:宋体">列表中移除并拷贝其请求数据到用户空间的缓冲区。如果该请求是不需要回复的、意外终止、出现错误或者 正常结束的情况下调用函数</span>static void request_end(struct fuse_conn *fc, struct fuse_req *req)<span lang="ZH-CN" style="font-family:宋体">来作一些处理后结束本次请求读取过程。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">将请求发送到</span>/dev/fuse<span lang="ZH-CN" style="font-family:宋体">中</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">首先申明一个结构体</span>fc<span lang="ZH-CN" style="font-family:宋体">，</span> struct fuse_conn *fc = fuse_get_conn(file); <span lang="ZH-CN" style="font-family:宋体">然后检查当前的设备状态，如 果没问题则初始化一个拷贝状态。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> static void fuse_copy_init(struct fuse_copy_state *cs, struct fuse_conn *fc,</p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:63pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">然后在当前的处理列表中查找写缓冲区的请求。如果找到，然后从列表中删除它并复制缓冲区的其余部 分。完成该请求通过调用函数</span>static void request_end(struct fuse_conn *fc, struct fuse_req *req)<span lang="ZH-CN" style="font-family:宋体">。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <a name="_Toc265855172" rel="nofollow" style="color:rgb(86,124,122)"><strong><em><span style="line-height:37px; font-size:16pt; font-family:Verdana">9</span></em></strong></a><strong><em><span lang="ZH-CN" style="line-height:37px; font-size:16pt; font-family:宋体">、总结</span><span style="line-height:37px; font-size:16pt; font-family:Verdana"></span></em></strong></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:21pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> FUSE<span lang="ZH-CN" style="font-family:宋体">内核模块主要工作就是进行队列的管 理，对</span>fuse<span lang="ZH-CN" style="font-family:宋体">设 备的读（写）其实就是从相应的队列移除（添加）请求（或响应），</span>request_send<span lang="ZH-CN" style="font-family:宋体">将请求加入</span>pending<span lang="ZH-CN" style="font-family:宋体">队列，唤醒</span>fuse<span lang="ZH-CN" style="font-family:宋体">守护程序，并在</span>req<span lang="ZH-CN" style="font-family:宋体">的</span>waitq<span lang="ZH-CN" style="font-family:宋体">上等待请求结果，守护程序通过</span>fuse_dev_readv<span lang="ZH-CN" style="font-family:宋体">从</span>pending<span lang="ZH-CN" style="font-family:宋体">队列中移除请求并处理，处理完成后，守护程序唤醒</span>req<span lang="ZH-CN" style="font-family:宋体">的</span>waitq<span lang="ZH-CN" style="font-family:宋体">上的进程，该进程读取结果，并返回 给用户。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:21pt"> <span lang="ZH-CN" style="font-family:宋体">总的来说，一个请求从发起到完成会经过</span>4<span lang="ZH-CN" style="font-family:宋体">步：</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:42pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 1)<span style="line-height:21px; font-size:7pt">        </span>fuse<span lang="ZH-CN" style="font-family:宋体">守护程序在</span>fc<span lang="ZH-CN" style="font-family:宋体">的</span>waitq<span lang="ZH-CN" style="font-family:宋体">上等待请求；</span><span style="font-family:宋体"></span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:42pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 2)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">用户的请求唤醒</span>fc<span lang="ZH-CN" style="font-family:宋体">的</span>waitq<span lang="ZH-CN" style="font-family:宋体">，从该</span>waitq<span lang="ZH-CN" style="font-family:宋体">上移除一个请求进行处理，并在</span>req<span lang="ZH-CN" style="font-family:宋体">的</span>waitq<span lang="ZH-CN" style="font-family:宋体">上等待请求结果；</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:42pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 3)<span style="line-height:21px; font-size:7pt">        </span>fuse<span lang="ZH-CN" style="font-family:宋体">守护程序被唤醒，读取请求，处理请求，返回结果，唤醒对应</span>req<span lang="ZH-CN" style="font-family:宋体">上的</span>waitq<span lang="ZH-CN" style="font-family:宋体">队列。</span></p> 
<p style="line-height:25px; margin-top:0px; margin-bottom:10px; margin-left:42pt; padding-top:0px; padding-bottom:0px; color:rgb(76,76,76); font-family:Arial,Helvetica,simsun,u5b8bu4f53; font-size:14px; background-color:rgb(204,206,208); text-indent:-21pt"> 4)<span style="line-height:21px; font-size:7pt">        </span><span lang="ZH-CN" style="font-family:宋体">请求被唤醒，读取</span>fuse<span lang="ZH-CN" style="font-family:宋体">守护程序返回的结果，返回给用户。</span></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/117b7dd0ad0a89c7c1f9f28b2141813e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">WDK介绍与安装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5069e8c32e0bd7e660564e7ad2f36fa9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">form submit不进入action方法问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>