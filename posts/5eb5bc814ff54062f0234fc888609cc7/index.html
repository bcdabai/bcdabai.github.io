<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PIG框架学习2——资源服务器的配置详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PIG框架学习2——资源服务器的配置详解" />
<meta property="og:description" content="一、前言 1、pig资源服务器的配置 Spring Security oauth2相关的依赖是在pigx-common-security模块中引入的，其他模块需要进行token鉴权的，需要在微服务中引入pigx-common-security模块的依赖，从而间接引入相关的Spring security oauth2依赖。
其最简单的一个目的，是对资源进行保护，对访问资源时携带的token进行鉴权。
微服务，开启资源服务器配置步骤：
①引入相关的依赖
&lt;!--安全模块--&gt; &lt;dependency&gt; &lt;groupId&gt;com.pig4cloud&lt;/groupId&gt; &lt;artifactId&gt;pig-common-security&lt;/artifactId&gt; &lt;version&gt;laster.version&lt;/version&gt; &lt;/dependency&gt; ②main方法开启@EnablePigResourceServer
pig4cloud对Spring Security OAuth2的资源服务器配置进行了封装，只需要一个注解即可完成相关的操作。
二、EnablePigxResourceServer解析 1、EnablePigxResourceServer的源码 /* 用于指示编译器将被注解的元素的注释信息包含在生成的文档中 使用该自定义注解的地方会在生成的文档中显示该注解的信息和说明 */ @Documented /* 用于指示一个自定义注解是否具有继承性 当使用@Inherited注解某个自定义注解时，如果一个类或接口使用了该被注解的自定义注解，那么其子类或实现类也会自动被应用该注解 */ @Inherited /* 用于限定自定义注解可以应用的目标元素类型 TYPE 类或接口; FIELD 字段（成员变量）; METHOD 方法;PARAMETER 方法参数; CONSTRUCTOR 构造函数;LOCAL_VARIABLE 局部变量; ANNOTATION_TYPE 注解类型;PACKAGE 包; TYPE_PARAMETER 类型参数;TYPE_USE 类型使用; */ @Target({ ElementType.TYPE }) /* 指定自定义注解的保留策略 SOURCE: 自定义注解仅在源代码中保留，编译后不包含 CLASS: 自定义注解在编译后的字节码文件中保留，但不会被加载到虚拟机中 RUNTIME: 自定义注解在运行时保留 */ @Retention(RetentionPolicy.RUNTIME) /* @Import注解主要用于将其他配置类导入到当前的配置类中，以实现配置的组合和复用，而不是用于创建Bean对象 */ @Import({ PigxResourceServerAutoConfiguration.class, PigxResourceServerConfiguration." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5eb5bc814ff54062f0234fc888609cc7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-07T21:03:12+08:00" />
<meta property="article:modified_time" content="2024-01-07T21:03:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PIG框架学习2——资源服务器的配置详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_1"></a>一、前言</h4> 
<h5><a id="1pig_3"></a>1、pig资源服务器的配置</h5> 
<p><code>Spring Security oauth2</code>相关的依赖是在<code>pigx-common-security</code>模块中引入的，其他模块需要进行<code>token</code>鉴权的，需要在微服务中引入<code>pigx-common-security</code>模块的依赖，从而间接引入相关的<code>Spring security oauth2</code>依赖。</p> 
<p>其最简单的一个目的，是对资源进行保护，对访问资源时携带的<code>token</code>进行鉴权。</p> 
<p>微服务，开启资源服务器配置步骤：</p> 
<p>①引入相关的依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--安全模块--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.pig4cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>pig-common-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>laster.version<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>②<code>main</code>方法开启<code>@EnablePigResourceServer</code></p> 
<p><code>pig4cloud</code>对<code>Spring Security OAuth2</code>的资源服务器配置进行了封装，只需要一个注解即可完成相关的操作。</p> 
<h4><a id="EnablePigxResourceServer_28"></a>二、<code>EnablePigxResourceServer</code>解析</h4> 
<h5><a id="1EnablePigxResourceServer_30"></a>1、<code>EnablePigxResourceServer</code>的源码</h5> 
<pre><code class="prism language-java"><span class="token comment">/*
用于指示编译器将被注解的元素的注释信息包含在生成的文档中
使用该自定义注解的地方会在生成的文档中显示该注解的信息和说明
*/</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token comment">/*
用于指示一个自定义注解是否具有继承性
当使用@Inherited注解某个自定义注解时，如果一个类或接口使用了该被注解的自定义注解，那么其子类或实现类也会自动被应用该注解
*/</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token comment">/*
用于限定自定义注解可以应用的目标元素类型
TYPE 类或接口; FIELD 字段（成员变量）;
METHOD 方法;PARAMETER 方法参数;
CONSTRUCTOR 构造函数;LOCAL_VARIABLE 局部变量;
ANNOTATION_TYPE 注解类型;PACKAGE 包;
TYPE_PARAMETER 类型参数;TYPE_USE 类型使用;
*/</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/*
指定自定义注解的保留策略
SOURCE: 自定义注解仅在源代码中保留，编译后不包含
CLASS: 自定义注解在编译后的字节码文件中保留，但不会被加载到虚拟机中
RUNTIME: 自定义注解在运行时保留
*/</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token comment">/*
@Import注解主要用于将其他配置类导入到当前的配置类中，以实现配置的组合和复用，而不是用于创建Bean对象
*/</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token class-name">PigxResourceServerAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">PigxResourceServerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">PigxFeignClientConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnablePigxResourceServer</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2PigxResourceServerAutoConfigurationclass_71"></a>2、<code>PigxResourceServerAutoConfiguration.class</code>源码：</h5> 
<pre><code class="prism language-java"><span class="token comment">/*
用于自动生成一个包含所有非final和非null字段的构造函数
*/</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token comment">/*
只要在加载PigxResourceServerAutoConfiguration时
才会去加载对应的属性配置类：PermitAllUrlProperties
注意： 通过该注解引入的配置@Import({EnableConfigurationPropertiesRegistrar.class})，
会将被@ConfigurationProperties 注解标记的目标类PermitAllUrlProperties注册为一个bean对象
目的：减少spring管控在资源数量 详情见2.1
*/</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">PermitAllUrlProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigxResourceServerAutoConfiguration</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 鉴权具体的实现逻辑 详情见2.2
	 * @return （#pms.xxx）
	 */</span>
	<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"pms"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">PermissionService</span> <span class="token function">permissionService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PermissionService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 请求令牌的抽取逻辑 详情见2.3
	 * @param urlProperties 对外暴露的接口列表
	 * @return BearerTokenExtractor
	 */</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">PigxBearerTokenExtractor</span> <span class="token function">pigBearerTokenExtractor</span><span class="token punctuation">(</span><span class="token class-name">PermitAllUrlProperties</span> urlProperties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxBearerTokenExtractor</span><span class="token punctuation">(</span>urlProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 资源服务器异常处理 详情见2.4
	 * @param objectMapper jackson 输出对象
	 * @param securityMessageSource 自定义国际化处理器
	 * @return ResourceAuthExceptionEntryPoint
	 */</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">ResourceAuthExceptionEntryPoint</span> <span class="token function">resourceAuthExceptionEntryPoint</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">,</span>
			<span class="token class-name">MessageSource</span> securityMessageSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResourceAuthExceptionEntryPoint</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">,</span> securityMessageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 资源服务器toke内省处理器 详情见2.5
	 * @param authorizationService token 存储实现
	 * @return TokenIntrospector
	 */</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">OpaqueTokenIntrospector</span> <span class="token function">opaqueTokenIntrospector</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AuthorizationService</span> authorizationService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxCustomOpaqueTokenIntrospector</span><span class="token punctuation">(</span>authorizationService<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>2.1、属性配置类：<code>PermitAllUrlProperties</code></p> 
<p>①将默认的忽略地址加入ignoreUrls列表</p> 
<p>②将配置文件中配置的地址加入到ignoreUrls列表</p> 
<p>③通过请求映射器获得所有的请求控制器，将添加@inner注解的请求地址加入到ignoreUrls列表</p> 
<pre><code class="prism language-java"><span class="token comment">//自动添加日志记录器（Logger）的字段，实现了简化日志记录的功能</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token comment">/*
@ConfigurationProperties将配置文件中以指定前缀开头的属性值映射到一个Java类中，
以方便统一管理和使用
*/</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"security.oauth2.client"</span><span class="token punctuation">)</span>
<span class="token comment">/*
InitializingBean:
在Bean声明周期中的初始化操作，InitializingBean接口中有一个afterPropertiesSet（）方法，
其执行时机早于init-method配置的方法，其是在所有的bean实例化完成并完成依赖注入后执行的，
自动调用实现了InitializingBean接口的bean的afterPropertiesSet()方法，即在bean实例化后和依赖注入后执行的回调方法
注意：implements InitializingBean接口并不是在所有类中都能生效的，它只适用于Spring容器中的bean对象
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PermitAllUrlProperties</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Pattern</span> <span class="token constant">PATTERN</span> <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"\\{(.*?)\\}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">DEFAULT_IGNORE_URLS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"/actuator/**"</span><span class="token punctuation">,</span> <span class="token string">"/error"</span><span class="token punctuation">,</span> <span class="token string">"/v3/api-docs"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//在配置文件中指定的需要忽略的url</span>
	<span class="token annotation punctuation">@Getter</span>
	<span class="token annotation punctuation">@Setter</span>
	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ignoreUrls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//在Bean属性设置后执行该方法</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//忽略url的列表中先加入默认忽略的url</span>
		ignoreUrls<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_IGNORE_URLS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/*
        RequestMappingHandlerMapping 是 Spring MVC 中的一个重要组件，它负责将请求映射到具体的处理方法（handler method）
        在 Spring MVC 的处理流程中，RequestMappingHandlerMapping 会根据请求的 URL 和请求方式（GET、POST 等）来确定需要调用哪个处理方法，
        从而完成请求的处理过程
        */</span>
		<span class="token class-name">RequestMappingHandlerMapping</span> mapping <span class="token operator">=</span> <span class="token class-name">SpringContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"requestMappingHandlerMapping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//RequestMappingInfo：请求映射信息，包括请求路径、请求方式等</span>
        <span class="token comment">//HandlerMethod：获得所有处理方法的具体信息，包括所属的类、方法名、参数列表等存放到</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMappingInfo</span><span class="token punctuation">,</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> mapping<span class="token punctuation">.</span><span class="token function">getHandlerMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//处理@Inner注解的方法和类，将其添加到ignoreUrls列表中</span>
		map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>info <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取对应的映射处理方法</span>
			<span class="token class-name">HandlerMethod</span> handlerMethod <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 获取方法上边的注解 替代path variable 为 *</span>
            <span class="token comment">//通过AnnotationUtils获取当前映射处理方法上的Inner注解，赋值给method，如果没有inner注解，method的值为null</span>
			<span class="token class-name">Inner</span> method <span class="token operator">=</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Inner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//如果method不为空（当前方法添加Inner注解）将映射的url通过正则表达式解析后加入到ignoreurls列表中</span>
            <span class="token comment">//正则表达式主要是对路径上的参数进行处理，匹配{}中的内容，然后替换为*</span>
            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>inner <span class="token operator">-&gt;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getPathPatternsCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">getPatternValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>url <span class="token operator">-&gt;</span> ignoreUrls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ReUtil</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token constant">PATTERN</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 获取类上边的注解, 替代path variable 为 *</span>
            <span class="token comment">//同理方法</span>
			<span class="token class-name">Inner</span> controller <span class="token operator">=</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">.</span><span class="token function">getBeanType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Inner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>inner <span class="token operator">-&gt;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getPathPatternsCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">getPatternValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>url <span class="token operator">-&gt;</span> ignoreUrls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ReUtil</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token constant">PATTERN</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>Map&lt;RequestMappingInfo, HandlerMethod&gt;内容如下所示：</p> 
<p><img src="https://images2.imgbox.com/85/7d/gfa560LF_o.png" alt="在这里插入图片描述"></p> 
<p>2.2、接口权限判断工具：<code>PermissionService</code></p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 鉴权具体的实现逻辑
	 * @return （#pms.xxx）
	 */</span>
<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"pms"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">PermissionService</span> <span class="token function">permissionService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PermissionService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体解析</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PermissionService</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 判断接口是否有任意xxx，xxx权限
	 * @param permissions 权限
	 * @return {boolean}
	 */</span>
    <span class="token comment">//String... 可变参数，允许将任意数量的String参数打包成一个数组</span>
    <span class="token comment">//可以将一个 ArrayList 作为参数传递给可变参数 String... permissions</span>
    <span class="token comment">//eg：hasPermission（"param1", "param2"）、hasPermission（Arrays.asList("param1", "param2")）</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> permissions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//入参为空，返回false</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">//从用户的安全上下文信息获取权限信息</span>
		<span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//用户权限信息为null，返回false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        
        <span class="token comment">//获得权限信息赋值给authorities</span>
		<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//权限是否匹配</span>
		<span class="token keyword">return</span> authorities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">GrantedAuthority</span><span class="token operator">::</span><span class="token function">getAuthority</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token operator">::</span><span class="token function">hasText</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>x <span class="token operator">-&gt;</span> <span class="token class-name">PatternMatchUtils</span><span class="token punctuation">.</span><span class="token function">simpleMatch</span><span class="token punctuation">(</span>permissions<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>具体使用方式：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
* 更新角色菜单
*
* @param roleVo 角色对象
* @return success、false
*/</span>
<span class="token annotation punctuation">@SysLog</span><span class="token punctuation">(</span><span class="token string">"更新角色菜单"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/menu"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"@pms.hasPermission('sys_role_perm')"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">saveRoleMenus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RoleVO</span> roleVo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysRoleService<span class="token punctuation">.</span><span class="token function">updateRoleMenus</span><span class="token punctuation">(</span>roleVo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用的<code>Spring Security</code>的<code>@PreAuthorize</code>注解，用于指定方法执行前需要满足的权限要求，它通常用于控制访问某些受保护资源时的权限控制。</p> 
<p>在 <code>@PreAuthorize</code> 中，可以指定一个 SpEL 表达式作为权限要求，如<code>@PreAuthorize("@pms.hasPermission('sys_role_perm')")</code></p> 
<p>“<code>@pms</code>”是 SpEL 中使用的 Spring EL Bean 引用语法，表示引用名为 <code>pms</code> 的 Bean。<code>hasPermission</code> 是 <code>pms</code> Bean 中定义的一个方法，用于检查当前用户是否拥有指定的权限。</p> 
<p>因此，上述注解的作用是，当执行该方法时，应该检查当前用户是否具有 <code>sys_role_perm</code> 权限。如果当前用户不具备该权限，方法将被拒绝执行，抛出 AccessDeniedException 异常。</p> 
<p>注意：使用的<code>Spring Security</code>的<code>@PreAuthorize</code>注解，需要配置全局的方法级安全性设置，启用 Spring Security 的方法级安全性（Method Security）意味着你可以在方法级别上对访问权限进行控制。通过使用 <code>@PreAuthorize</code>、<code>@PostAuthorize</code>、<code>@Secured</code> 等注解，你可以在方法执行前或执行后对用户的权限进行验证。</p> 
<p>在yml中配置：</p> 
<pre><code class="prism language-xml">spring:
  security:
    enabled: true
    method:
      security:
        enabled: true
</code></pre> 
<p>在xml配置文件中配置：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/security<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>beans</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>global-method-security</span> <span class="token attr-name">pre-post-annotations</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>enabled<span class="token punctuation">"</span></span> <span class="token attr-name">secured-annotations</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>enabled<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 其他配置 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">beans:</span>beans</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<p>在pig中是直接通过注解<code>@EnableMethodSecurity</code>开启的</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableMethodSecurity</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigxResourceServerConfiguration</span> <span class="token punctuation">{<!-- --></span>
	……
<span class="token punctuation">}</span>
</code></pre> 
<p>2.3、请求令牌的抽取逻辑:<code>PigxBearerTokenExtractor</code></p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 请求令牌的抽取逻辑
	 * @param urlProperties 对外暴露的接口列表
	 * @return BearerTokenExtractor
	 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PigxBearerTokenExtractor</span> <span class="token function">pigBearerTokenExtractor</span><span class="token punctuation">(</span><span class="token class-name">PermitAllUrlProperties</span> urlProperties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxBearerTokenExtractor</span><span class="token punctuation">(</span>urlProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>即获取请求中的token的相关逻辑</p> 
<pre><code class="prism language-java"><span class="token comment">//BearerTokenResolver：是Spring Security中的一个接口，用于解析Bearer Token，并将其返回</span>
<span class="token comment">//该接口定义了一个方法 resolve(HttpServletRequest request)，用于从请求中提取出 Bearer Token，需要在实现类中重写</span>
<span class="token comment">//这里pigx自定义了一个类PigxBearerTokenExtractor作为BearerTokenResolver的实现类，用于解析Bearer Token</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigxBearerTokenExtractor</span> <span class="token keyword">implements</span> <span class="token class-name">BearerTokenResolver</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token comment">//定义处理Bearer Token 的正则表达式模式</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Pattern</span> authorizationPattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"^Bearer (?&lt;token&gt;[a-zA-Z0-9-:._~+/]+=*)$"</span><span class="token punctuation">,</span>
			<span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token constant">CASE_INSENSITIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//是否允许从表单编码的请求体参数中获取 Token。</span>
	<span class="token keyword">private</span> <span class="token keyword">boolean</span> allowFormEncodedBodyParameter <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">//是否允许从 URI 查询参数中获取 Token</span>
	<span class="token keyword">private</span> <span class="token keyword">boolean</span> allowUriQueryParameter <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">//存储 Bearer Token 的请求头名称，默认为 Authorization</span>
    <span class="token comment">//常量值public static final String AUTHORIZATION = "Authorization";</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> bearerTokenHeaderName <span class="token operator">=</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">AUTHORIZATION</span><span class="token punctuation">;</span>

    <span class="token comment">//用于检查当前请求路径是否应被忽略的路径匹配器</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PathMatcher</span> pathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//存储可忽略 URL 列表</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PermitAllUrlProperties</span> urlProperties<span class="token punctuation">;</span>

    <span class="token comment">//构造器传入属性配置类：PermitAllUrlProperties（存储对外暴露的接口列表）</span>
	<span class="token keyword">public</span> <span class="token class-name">PigxBearerTokenExtractor</span><span class="token punctuation">(</span><span class="token class-name">PermitAllUrlProperties</span> urlProperties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>urlProperties <span class="token operator">=</span> urlProperties<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//对token的抽取方法</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取当前请求的url</span>
		<span class="token class-name">String</span> requestUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
        <span class="token comment">//去除上下文，获得相对路径</span>
        <span class="token class-name">String</span> relativePath <span class="token operator">=</span> requestUri<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//当前请求路径是否忽略</span>
		<span class="token keyword">boolean</span> match <span class="token operator">=</span> urlProperties<span class="token punctuation">.</span><span class="token function">getIgnoreUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>url <span class="token operator">-&gt;</span> pathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//当前请求路径忽略，返回null</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
        <span class="token comment">//通过resolveFromAuthorizationHeader方法获取token 详情见2.3.1</span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> authorizationHeaderToken <span class="token operator">=</span> <span class="token function">resolveFromAuthorizationHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//通过isParameterTokenSupportedForRequest方法从请求参数中解析出 Bearer Token，并返回 Token 字符串详情见2.3.2</span>
        <span class="token comment">//通过isParameterTokenSupportedForRequest 判断当前请求是否支持从请求参数中获取 Token 详情见2.3.3</span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> parameterToken <span class="token operator">=</span> <span class="token function">isParameterTokenSupportedForRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
				<span class="token operator">?</span> <span class="token function">resolveFromRequestParameters</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//请求头中获取到token</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>authorizationHeaderToken <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//请求参数中也有token，则抛出重复token</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterToken <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">final</span> <span class="token class-name">BearerTokenError</span> error <span class="token operator">=</span> <span class="token class-name">BearerTokenErrors</span>
						<span class="token punctuation">.</span><span class="token function">invalidRequest</span><span class="token punctuation">(</span><span class="token string">"Found multiple bearer tokens in the request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2AuthenticationException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
            <span class="token comment">//返回请求头中的token</span>
			<span class="token keyword">return</span> authorizationHeaderToken<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        
        <span class="token comment">//检测是否支持参数中获取token（详情见2.3.4），并且判断参数中是否有token</span>
        <span class="token comment">//如果支持参数中获取token，并且参数中有token则返回参数中的token</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>parameterToken <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isParameterTokenEnabledForRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> parameterToken<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//详情2.3.1  从请求头中解析出 Bearer Token，并返回 Token 字符串</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">resolveFromAuthorizationHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//从请求头中获取请求头名称，默认为 Authorization的值</span>
        <span class="token class-name">String</span> authorization <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bearerTokenHeaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//不以不区分大小写的方式以 "bearer" 开头，则返回 null，表示未找到有效的 Bearer Token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">startsWithIgnoreCase</span><span class="token punctuation">(</span>authorization<span class="token punctuation">,</span> <span class="token string">"bearer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">//通过正则表达式对 authorization 进行匹配</span>
		<span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> authorizationPattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//果匹配失败，即 Bearer Token 格式不正确，则抛出 OAuth2AuthenticationException 异常，异常信息为 "Bearer token is malformed"</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">BearerTokenError</span> error <span class="token operator">=</span> <span class="token class-name">BearerTokenErrors</span><span class="token punctuation">.</span><span class="token function">invalidToken</span><span class="token punctuation">(</span><span class="token string">"Bearer token is malformed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2AuthenticationException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">//匹配成功，通过 matcher.group("token") 方法提取出 Token 字符串，并返回</span>
		<span class="token keyword">return</span> matcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    

    <span class="token comment">//详情2.3.2 从请求参数中解析出 Bearer Token，并返回 Token 字符串</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">resolveFromRequestParameters</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//通过 request.getParameterValues("access_token") 方法获取名为 "access_token" 的请求参数的值，存储在 values 数组中</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterValues</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//如果 values 为 null 或长度为 0，则返回 null，表示未找到有效的 Bearer Token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> values<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">//如果 values 的长度为 1，则直接返回第一个值(默认取第一个)，即 Token 字符串</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">//如果 values 的长度大于 1，表示请求中包含多个 Bearer Token，此时抛出 OAuth2AuthenticationException 异常，异常信息为 "Found multiple bearer tokens in the request"</span>
		<span class="token class-name">BearerTokenError</span> error <span class="token operator">=</span> <span class="token class-name">BearerTokenErrors</span><span class="token punctuation">.</span><span class="token function">invalidRequest</span><span class="token punctuation">(</span><span class="token string">"Found multiple bearer tokens in the request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2AuthenticationException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">//详情2.3.3 判断当前请求是否支持从请求参数中获取 Token</span>
	<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isParameterTokenSupportedForRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token operator">&amp;&amp;</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_FORM_URLENCODED_VALUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token operator">||</span> <span class="token string">"GET"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//详情2.3.4该方法的作用是判断是否允许在当前请求中通过请求参数获取 Token</span>
	<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isParameterTokenEnabledForRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*
        满足情况：
        1、allowFormEncodedBodyParameter 的值是否为 true，并且当前请求方法为 "POST"，且请求的 Content-Type 为 "application/x-www-form-urlencoded
        2、allowUriQueryParameter 的值是否为 true，并且当前请求方法为 "GET"
        */</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowFormEncodedBodyParameter <span class="token operator">&amp;&amp;</span> <span class="token string">"POST"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token operator">&amp;&amp;</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_FORM_URLENCODED_VALUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowUriQueryParameter <span class="token operator">&amp;&amp;</span> <span class="token string">"GET"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	

<span class="token punctuation">}</span>

</code></pre> 
<p>2.4、资源服务器异常处理<code>resourceAuthExceptionEntryPoint</code></p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 资源服务器异常处理
	 * @param objectMapper jackson 输出对象
	 * @param securityMessageSource 自定义国际化处理器
	 * @return ResourceAuthExceptionEntryPoint
	 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ResourceAuthExceptionEntryPoint</span> <span class="token function">resourceAuthExceptionEntryPoint</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">,</span>
                                                                       <span class="token class-name">MessageSource</span> securityMessageSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResourceAuthExceptionEntryPoint</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">,</span> securityMessageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体内容解析</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
 * @author lengleng
 * @date 2019/2/1
 *
 * 客户端异常处理 AuthenticationException 不同细化异常处理
 */</span>

<span class="token comment">//全参构造器，会生成一个带有所有 final 字段的构造函数</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceAuthExceptionEntryPoint</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//进行 JSON 序列化</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token comment">//国际化消息处理</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@SneakyThrows</span>	<span class="token comment">//@SneakyThrows 是 Lombok 提供的注解，用于在方法上抛出异常时，自动将该异常包装为 RuntimeException 抛出</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
			<span class="token class-name">AuthenticationException</span> authException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token comment">/// 设置响应的字符编码为UTF8，内容类型为 JSON </span>
		response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span><span class="token constant">UTF8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//创建一个封装错误信息的对象</span>
        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//设置code为失败</span>
        <span class="token comment">//常量：Integer FAIL = 1;</span>
        result<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置响应状态码为未授权401</span>
        <span class="token comment">//UNAUTHORIZED(401, HttpStatus.Series.CLIENT_ERROR, "Unauthorized"),</span>
		response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment"> 如果存在认证异常，设置错误消息为 "error"，数据为认证异常的消</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>authException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			result<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			result<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>authException<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 针对令牌过期返回特殊的 424</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>authException <span class="token keyword">instanceof</span> <span class="token class-name">InvalidBearerTokenException</span>
				<span class="token operator">||</span> authException <span class="token keyword">instanceof</span> <span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//设置响应状态码为 424（FAILED_DEPENDENCY）</span>
            <span class="token comment">//FAILED_DEPENDENCY(424, HttpStatus.Series.CLIENT_ERROR, "Failed Dependency")</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">FAILED_DEPENDENCY</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			
 <span class="token comment"> 设置特定的错误消息           result.setMsg(this.messageSource.getMessage("OAuth2ResourceOwnerBaseAuthenticationProvider.tokenExpired",</span>
					<span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">LocaleContextHolder</span><span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//如果用户令牌过期 修改code</span>
			result<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token constant">TOKEN_EXPIRED_FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        
        <span class="token comment">//获取响应的输出流，通过该输出流可以向客户端发送数据</span>
		<span class="token class-name">PrintWriter</span> printWriter <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//使用 Jackson 的 ObjectMapper 将 result 对象序列化为 JSON 格式的字符串</span>
        <span class="token comment">//将序列化后的 JSON 字符串添加到输出流中，以便将其发送给客户端</span>
		printWriter<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>2.5、资源服务器toke内省处理器<code>opaqueTokenIntrospector</code></p> 
<p>自定义认证器，用于通过传递的令牌进行身份验证</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 资源服务器toke内省处理器
	 * @param authorizationService token 存储实现
	 * @return TokenIntrospector
	 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">OpaqueTokenIntrospector</span> <span class="token function">opaqueTokenIntrospector</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AuthorizationService</span> authorizationService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxCustomOpaqueTokenIntrospector</span><span class="token punctuation">(</span>authorizationService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体解析</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author lengleng
 * @date 2022/5/28
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigxCustomOpaqueTokenIntrospector</span> <span class="token keyword">implements</span> <span class="token class-name">OpaqueTokenIntrospector</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OAuth2AuthorizationService</span> authorizationService<span class="token punctuation">;</span>

    <span class="token comment">//用于根据传递的令牌进行身份验证</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">OAuth2AuthenticatedPrincipal</span> <span class="token function">introspect</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//通过OAuth2AuthorizationService的实现类去获取对应的token 详情见2.5.1</span>
        <span class="token class-name">OAuth2Authorization</span> oldAuthorization <span class="token operator">=</span> authorizationService<span class="token punctuation">.</span><span class="token function">findByToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">OAuth2TokenType</span><span class="token punctuation">.</span><span class="token constant">ACCESS_TOKEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
        <span class="token comment">//如果找不到与令牌关联的授权信息，则抛出 InvalidBearerTokenException 异常，表示令牌无效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>oldAuthorization<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidBearerTokenException</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 客户端模式默认返回</span>
        <span class="token comment">//判断授权类型是否为客户端模式</span>
        <span class="token comment">//public static final AuthorizationGrantType CLIENT_CREDENTIALS = new AuthorizationGrantType("client_credentials");</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span><span class="token constant">CLIENT_CREDENTIALS</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldAuthorization<span class="token punctuation">.</span><span class="token function">getAuthorizationGrantType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//默认返回一个 PigxClientCredentialsOAuth2AuthenticatedPrincipal 对象。该对象包含了传递的授权信息的属性、空权限列表以及授权主体名称。</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxClientCredentialsOAuth2AuthenticatedPrincipal</span><span class="token punctuation">(</span>oldAuthorization<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token constant">NO_AUTHORITIES</span><span class="token punctuation">,</span> oldAuthorization<span class="token punctuation">.</span><span class="token function">getPrincipalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

        <span class="token comment">//如果授权类型不是客户端模式，则获取所有实现了 PigxUserDetailsService 接口的 Bean 对象，并过滤出支持当前授权信息的 PigxUserDetailsService 对象</span>
        <span class="token comment">//这里会获取到对应的PigxUserDetailsService的实现类</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PigxUserDetailsService</span><span class="token punctuation">&gt;</span></span> userDetailsServiceMap <span class="token operator">=</span> <span class="token class-name">SpringContextHolder</span>
				<span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">PigxUserDetailsService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//选择支持度最高的 PigxUserDetailsService 对象（根据 Ordered 接口的顺序进行比较）</span>
		<span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PigxUserDetailsService</span><span class="token punctuation">&gt;</span></span> optional <span class="token operator">=</span> userDetailsServiceMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>service <span class="token operator">-&gt;</span> service<span class="token punctuation">.</span><span class="token function">support</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>oldAuthorization<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegisteredClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						oldAuthorization<span class="token punctuation">.</span><span class="token function">getAuthorizationGrantType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token operator">::</span><span class="token function">getOrder</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取用户信息</span>
		<span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Object</span> principal <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>oldAuthorization<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Principal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">UsernamePasswordAuthenticationToken</span> usernamePasswordAuthenticationToken <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> principal<span class="token punctuation">;</span>
			<span class="token class-name">Object</span> tokenPrincipal <span class="token operator">=</span> usernamePasswordAuthenticationToken<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			userDetails <span class="token operator">=</span> optional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadUserByUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PigxUser</span><span class="token punctuation">)</span> tokenPrincipal<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> notFoundException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"用户不不存在 {}"</span><span class="token punctuation">,</span> notFoundException<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> notFoundException<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"资源服务器 introspect Token error {}"</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 注入客户端信息，方便上下文中获取</span>
		<span class="token class-name">PigxUser</span> pigxUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PigxUser</span><span class="token punctuation">)</span> userDetails<span class="token punctuation">;</span>
		<span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>pigxUser<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
				oldAuthorization<span class="token punctuation">.</span><span class="token function">getRegisteredClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> pigxUser<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>2.5.1 <code>authorizationService.findByToken(token, OAuth2TokenType.ACCESS_TOKEN);</code></p> 
<p>其实现类有三个，我们用的是Pix提供的实现类<code>PigxRedisOAuth2AuthorizationService</code></p> 
<p><img src="https://images2.imgbox.com/32/d7/FxkGmHCq_o.png" alt="在这里插入图片描述"></p> 
<p>其中的方法如下，即从redis中去获取对应的token信息</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">public</span> <span class="token class-name">OAuth2Authorization</span> <span class="token function">findByToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">OAuth2TokenType</span> tokenType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">"token cannot be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>tokenType<span class="token punctuation">,</span> <span class="token string">"tokenType cannot be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">buildKey</span><span class="token punctuation">(</span>tokenType<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3PigxResourceServerConfiguration__677"></a>3、<code>PigxResourceServerConfiguration</code> 资源服务器认证授权配置</h5> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableMethodSecurity</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigxResourceServerConfiguration</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ResourceAuthExceptionEntryPoint</span> resourceAuthExceptionEntryPoint<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PermitAllUrlProperties</span> permitAllUrl<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PigxBearerTokenExtractor</span> pigxBearerTokenExtractor<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OpaqueTokenIntrospector</span> customOpaqueTokenIntrospector<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
	<span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">[</span><span class="token punctuation">]</span> requestMatchers <span class="token operator">=</span> permitAllUrl<span class="token punctuation">.</span><span class="token function">getIgnoreUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">AntPathRequestMatcher</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		http<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span>authorizeRequests <span class="token operator">-&gt;</span> authorizeRequests<span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span>requestMatchers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span>
						oauth2 <span class="token operator">-&gt;</span> oauth2<span class="token punctuation">.</span><span class="token function">opaqueToken</span><span class="token punctuation">(</span>token <span class="token operator">-&gt;</span> token<span class="token punctuation">.</span><span class="token function">introspector</span><span class="token punctuation">(</span>customOpaqueTokenIntrospector<span class="token punctuation">)</span><span class="token punctuation">)</span>
								<span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span>resourceAuthExceptionEntryPoint<span class="token punctuation">)</span>
								<span class="token punctuation">.</span><span class="token function">bearerTokenResolver</span><span class="token punctuation">(</span>pigxBearerTokenExtractor<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>headers <span class="token operator">-&gt;</span> headers<span class="token punctuation">.</span><span class="token function">frameOptions</span><span class="token punctuation">(</span><span class="token class-name">HeadersConfigurer<span class="token punctuation">.</span>FrameOptionsConfig</span><span class="token operator">::</span><span class="token function">disable</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token class-name">AbstractHttpConfigurer</span><span class="token operator">::</span><span class="token function">disable</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>这段代码是一个 Java 类 <code>PigxResourceServerConfiguration</code>，它配置了 Spring Security 的资源服务器。</p> 
<p>首先，类中定义了一些依赖注入的属性：</p> 
<ul><li><code>resourceAuthExceptionEntryPoint</code>：用于处理资源服务器的异常入口点。</li><li><code>permitAllUrl</code>：用于配置允许所有请求的 URL 列表。</li><li><code>pigxBearerTokenExtractor</code>：用于从请求中提取 Bearer Token。</li><li><code>customOpaqueTokenIntrospector</code>：自定义的不透明令牌内省器。</li></ul> 
<p>接下来，使用 <code>@Bean</code> 注解标记了一个方法 <code>securityFilterChain</code>，该方法返回一个 <code>SecurityFilterChain</code> 对象。该方法的作用是配置 Spring Security 的安全过滤器链。</p> 
<p>在 <code>securityFilterChain</code> 方法中，首先根据 <code>permitAllUrl</code> 中的忽略 URL 列表创建了一个 <code>AntPathRequestMatcher</code> 数组 <code>requestMatchers</code>。这里使用了 Stream API 将忽略 URL 列表转换为 <code>AntPathRequestMatcher</code> 数组。</p> 
<p>然后，通过调用 <code>authorizeHttpRequests()</code> 方法配置了请求的授权规则。其中，使用 <code>requestMatchers(requestMatchers).permitAll().anyRequest().authenticated()</code> 来配置了忽略 URL 列表的请求允许访问，而其他请求需要进行身份验证。</p> 
<p>接着，使用 <code>oauth2ResourceServer()</code> 方法配置了 OAuth2 资源服务器。通过调用 <code>opaqueToken()</code> 方法设置了自定义的不透明令牌内省器，并使用 <code>bearerTokenResolver()</code> 方法设置了用于解析 Bearer Token 的 <code>pigxBearerTokenExtractor</code>。</p> 
<p>继续，使用 <code>headers()</code> 方法配置了 HTTP 头部，通过调用 <code>frameOptions()</code> 方法禁用了 X-Frame-Options。</p> 
<p>最后，使用 <code>csrf()</code> 方法禁用了 CSRF（跨站请求伪造）保护，并调用 <code>http.build()</code> 方法构建并返回了安全过滤器链。</p> 
<p>这段代码的作用是配置 Spring Security 的资源服务器，定义了请求的授权规则、OAuth2 资源服务器和一些其他配置。</p> 
<h5><a id="4PigxFeignClientConfigurationclass_742"></a>4、<code>PigxFeignClientConfiguration.class</code></h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigxFeignClientConfiguration</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 注入 oauth2 feign token 增强
	 * @param tokenResolver token获取处理器
	 * @return 拦截器
	 */</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">oauthRequestInterceptor</span><span class="token punctuation">(</span><span class="token class-name">BearerTokenResolver</span> tokenResolver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxOAuthRequestInterceptor</span><span class="token punctuation">(</span>tokenResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">clientToCRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxClientToCRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>4.1 、<code>oauthRequestInterceptor</code>方法</p> 
<p>该类的作用是在发送请求之前拦截并修改请求模板（<code>RequestTemplate</code>）</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 注入 oauth2 feign token 增强
	 * @param tokenResolver token获取处理器
	 * @return 拦截器
	 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">oauthRequestInterceptor</span><span class="token punctuation">(</span><span class="token class-name">BearerTokenResolver</span> tokenResolver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxOAuthRequestInterceptor</span><span class="token punctuation">(</span>tokenResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体详解：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * oauth2 feign token传递
 *
 * 重新 OAuth2FeignRequestInterceptor ，官方实现部分常见不适用
 *
 * @author lengleng
 * @date 2022/5/29
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigxOAuthRequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BearerTokenResolver</span> tokenResolver<span class="token punctuation">;</span>

	<span class="token comment">/**
	 * Create a template with the header of provided name and extracted extract &lt;/br&gt;
	 *
	 * 1. 如果使用 非web 请求，header 区别 &lt;/br&gt;
	 *
	 * 2. 根据authentication 还原请求token
	 * @param template
	 */</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fromHeader <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">FROM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 带from 请求直接跳过</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>fromHeader<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fromHeader<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">FROM_IN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 非web 请求直接跳过</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 避免请求参数的 query token 无法传递</span>
		<span class="token class-name">String</span> token <span class="token operator">=</span> tokenResolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">//添加token信息</span>
		template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">AUTHORIZATION</span><span class="token punctuation">,</span>
				<span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s %s"</span><span class="token punctuation">,</span> <span class="token class-name">OAuth2AccessToken<span class="token punctuation">.</span>TokenType</span><span class="token punctuation">.</span><span class="token constant">BEARER</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4.2、 <code>clientToCRequestInterceptor</code>方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">clientToCRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PigxClientToCRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体详解：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * TOC 客户标识传递
 *
 * @author lengleng
 * @date 2023/3/17
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigxClientToCRequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * Called for every request. Add data using methods on the supplied
	 * {@link RequestTemplate}.
	 * @param template
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> reqVersion <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
				<span class="token operator">?</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">HEADER_TOC</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>reqVersion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"feign  add header toc :{}"</span><span class="token punctuation">,</span> reqVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
			template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">HEADER_TOC</span><span class="token punctuation">,</span> reqVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_875"></a></h4>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/091c69e05a64d45abf42841ae62a4661/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">蓝桥杯付费视频更新进度通知</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/72817028de0c0f4d46231d6c818172f4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Docker Compose 基础知识(三)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>